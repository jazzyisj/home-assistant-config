###############################################################################
## Presence LED
###############################################################################
presence_led:
  alias: 'Presence LED'
  description: 'Set led notification.'
  mode: queued
  fields:
    reset:
      description: 'Reset LED'
      example: 'true'
  variables:
    reset: '{{ reset|default(false) }}'
    entities: "{{ state_attr('group.presence_led','entity_id') }}"
    quiet: "{{ is_state('binary_sensor.quiet_time','on') }}"
    alert_state: >
      {% if is_state('binary_sensor.jason_home','on') and (now()
          - states.binary_sensor.jason_home.last_changed < timedelta(minutes=10)) %} jason_home
      {% elif is_state('binary_sensor.sheri_home','on') and (now()
          - states.binary_sensor.sheri_home.last_changed < timedelta(minutes=10)) %} sheri_home
      {% elif is_state('input_boolean.guest_home','on') and (now()
          - states.input_boolean.guest_home.last_changed < timedelta(minutes=10)) %} guest_home
      {% elif is_state('input_boolean.jason_almost_home','on') %} jason_almost
      {% elif is_state('input_boolean.sheri_almost_home','on') %} sheri_almost
      {% elif states('proximity.jphone_home')|int(0) < 4
          and state_attr('proximity.jphone_home','dir_of_travel') == 'towards' %} jason_heading
      {% elif states('proximity.sphone_home')|int(0) < 4
          and state_attr('proximity.sphone_home','dir_of_travel') == 'towards' %} sheri_heading
      {% elif is_state('alert.jason_phone_offline','off') %} jason_connected
      {% elif is_state('alert.sheri_phone_offline','off') %} sheri_connected
      {% else %} off
      {% endif %}
    duration: >
      {% if alert_state == 'jason_home' %} 62 {# 2min #}
      {% elif alert_state == 'sheri_home' %} 62 {# 2min #}
      {% elif alert_state == 'guest_home' %} 62 {# 2min #}
      {% elif alert_state == 'jason_almost' %} 62 {# 2min #}
      {% elif alert_state == 'sheri_almost' %} 255 {# inf #}
      {% elif alert_state == 'jason_heading' %} 255 {# inf #}
      {% elif alert_state == 'sheri_heading' %} 255 {# inf #}
      {% elif alert_state == 'jason_connected' %} 255 {# inf #}
      {% elif alert_state == 'sheri_connected' %} 255 {# inf #}
      {% else %} 255
      {% endif %}
    color: >
      {% if alert_state == 'jason_home' %} 150
      {% elif alert_state == 'sheri_home' %} 210
      {% elif alert_state == 'guest_home' %} 20
      {% elif alert_state == 'jason_almost' %} 150
      {% elif alert_state == 'sheri_almost' %} 210
      {% elif alert_state == 'jason_heading' %} 150
      {% elif alert_state == 'sheri_heading' %} 210
      {% elif alert_state == 'jason_connected' %} 150
      {% elif alert_state == 'sheri_connected' %} 210
      {% else %} 170
      {% endif %}
    brightness: "{{ 2 if quiet else (7 if alert_state != 'off' else 3) }}"
    effect: >
      {% if alert_state == 'jason_home' %} solid
      {% elif alert_state == 'sheri_home' %} solid
      {% elif alert_state == 'guest_home' %} solid
      {% elif alert_state == 'jason_almost' %} chase
      {% elif alert_state == 'sheri_almost' %} chase
      {% elif alert_state == 'jason_heading' %} pulse
      {% elif alert_state == 'sheri_heading' %} pulse
      {% elif alert_state == 'jason_connected' %} fast blink
      {% elif alert_state == 'sheri_connected' %} fast blink
      {% else %} off
      {% endif %}
  sequence:
    - choose:
        - conditions: "{{ alert_state == 'off' and not reset }}"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.led_reset
              data:
                variables:
                  entities: '{{ entities }}'
      default:
        - service: script.turn_on
          target:
            entity_id: script.inovelli_led_control
          data:
            variables:
              entities: '{{ entities }}'
              duration: '{{ duration }}'
              color: '{{ color }}'
              brightness: '{{ brightness }}'
              effect: '{{ effect }}'
