###############################################################################
## Inovelli LED Control
###############################################################################
inovelli_led_control:
  alias: 'Inovelli LED Control'
  description: 'Sets the LED effects for the Inovelli Red series of switches, dimmers'
  mode: queued
  max: 100
  max_exceeded: error
  fields:
    duration:
      description: 'Duration (1-255) 255 is indefinite'
      example: '255'
    color:
      description: 'Color value (1-255) or color string value'
      example: '255'
    effect:
      description: 'Effect string value (off,solid,slow blink,fast blink,pulse,chase)'
      example: 'pulse'
    brightness:
      description: 'LED brightness value (1-10)'
      example: '3'
    entities:
      description: 'List of entities to send LED notification to.'
      example: "['light.dining_room_potlights','switch.kitchen_sink_light']"
  variables: #ZWAVE device available (state on/off)
    duration: '{{ duration|int(255) }}'
    color: '{{ color|int(170) }}'
    brightness: '{{ brightness|int(3) }}'
    effect: "{{ effect|default('off') }}"
    dimmer_entities: >
      {{ expand(entities)|selectattr('entity_id','in',state_attr('group.dimmer_led','entity_id'))
          |selectattr('state','in',['on','off'])|map(attribute='entity_id')|list }}
    switch_entities: >
      {{ expand(entities)|selectattr('entity_id','in',state_attr('group.switch_led','entity_id'))
          |selectattr('state','in',['on','off'])|map(attribute='entity_id')|list }}
  sequence:
    - condition: template
      alias: 'Entities not null' # prevent template reload error
      value_template: "{{ entities|lower not in ['','unknown','unavailable','none'] }}"

    # separate switches and lights - different paramaters
    - choose:
        - conditions: '{{ dimmer_entities|length > 0 }}'
          sequence:
            - service: zwave_js.bulk_set_partial_config_parameters
              target:
                entity_id: '{{ dimmer_entities }}'
              data:
                parameter: 16
                value:
                  'LED Effect Color': '{{ color|title }}'
                  'LED Effect Brightness': '{{ brightness|int(0) }}'
                  'LED Effect Duration': '{{ duration|int(0) }}'
                  'LED Effect Type': '{{ effect|title }}'

    - choose:
        - conditions: '{{ switch_entities|length > 0  }}'
          sequence:
            # no chase effect for switches, swap for fast blink
            - variables:
                effect: "{{ 'fast blink' if effect == 'chase' else effect }}"

            - service: zwave_js.bulk_set_partial_config_parameters
              target:
                entity_id: '{{ switch_entities }}'
              data:
                parameter: 8
                value:
                  'LED Effect Color': '{{ color|title }}'
                  'LED Effect Brightness': '{{ brightness|int(0) }}'
                  'LED Effect Duration': '{{ duration|int(0) }}'
                  'LED Effect Type': '{{ effect|title }}'
