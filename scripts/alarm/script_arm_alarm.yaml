#######################################################################################################################
## Arm Alarm
#######################################################################################################################
arm_alarm:
  alias: "Arm Alarm"
  description: "Arm house alarm."
  icon: mdi:alarm-bell
  fields:
    mode:
      description: "Alarm arm mode."
      example: "away"
    code:
      description: "Alarm arm code."
      example: "1111"
    override:
      description: "Bypass open sensors."
      example: "true"
  variables:
    hass_code: !secret ALARMO_HA
    code: "{{ code|default(hass_code) }}"
  sequence:
    - condition: template
      alias: "Alarm not already armed"
      value_template: "{{ not is_state('alarm_control_panel.master',mode) }}"

    - choose:
        - conditions:
            - condition: not
              alias: "Alarm is not disarmed"
              conditions:
                - condition: state
                  entity_id: alarm_control_panel.master
                  state: disarmed
          sequence:
            - service: script.disarm_alarm
              data:
                person: temp

    - choose:
        - conditions: "{{ override|default(false) }}"
          sequence:
            - service: alarmo.arm #ISSUE does not support target!
              data:
                entity_id: alarm_control_panel.master
                mode: "{{ mode }}"
                code: "{{ code }}"
                force: true
                skip_delay: true

      default:
        - service: alarmo.arm
          data:
            entity_id: alarm_control_panel.master
            mode: "{{ mode }}"
            code: "{{ code }}"


