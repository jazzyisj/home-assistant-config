###############################################################################
## Arm Alarm
###############################################################################
arm_alarm:
  alias: 'Arm Alarm'
  description: 'Arm house alarm.'
  icon: mdi:alarm-bell
  fields:
    zone:
      description: 'Alarm zone.'
      example: 'master'
    mode:
      description: 'Alarm arm mode.'
      example: 'away'
    code:
      description: 'Alarm arm code.'
      example: '1111'
    override:
      description: 'Bypass open sensors.'
      example: 'true'
  variables:
    zone: "{{ zone|default('master') }}"
    mode: "{{ mode|default('away') }}"
    hass_code: !secret ALARMO_HA
    code: '{{ code|default(hass_code) }}'
    override: '{{ override|default(false) }}'
    alarm_mode: 'armed_{{ mode }}'
  sequence:
    - condition: template
      alias: 'Alarm not already armed'
      value_template: "{{ not is_state('alarm_control_panel.' ~ zone,alarm_mode) }}"

    - choose:
        - conditions:
            - condition: template
              alias: 'Alarm zone is not disarmed'
              value_template: "{{ not is_state('alarm_control_panel.' ~ zone,'disarmed') }}"
          sequence:
            - service: script.disarm_alarm
              data:
                zone: '{{ zone }}'
                person: temp

    - choose:
        - conditions: '{{ override }}'
          sequence:
            - service: alarmo.arm #NOTE does not support target!
              data:
                entity_id: 'alarm_control_panel.{{ zone }}'
                mode: '{{ mode }}'
                code: '{{ code }}'
                force: true
                skip_delay: true

      default:
        - choose:
            - conditions: "{{ zone in ['garage','master'] }}"
              sequence:
                - wait_template: "{{ is_state('binary_sensor.garage_occupied','off') }}"
                  timeout: 120

                - service: alarmo.arm
                  data:
                    entity_id: "alarm_control_panel.{{ zone if wait.completed else 'master' }}"
                    mode: '{{ mode }}'
                    code: '{{ code }}'

                - choose:
                    - conditions: '{{ not wait.completed }}'
                      sequence:
                        - service: notify.jason
                          data:
                            title: 'Garage Not Armed'
                            message: 'The garage alarm could not be armed because the garage is still occupied.'
                            data:
                              tag: garage_alarm_occupied
                              group: Alarm
                              channel: Alert
                              importance: max
                              ttl: 0
                              priority: high
                              notification_icon: mdi:shield-alert
                              icon_url: !secret ALERT_ICON #IMAGE
                              ledColor: !secret SEVERE_COLOR
                              color: !secret SEVERE_COLOR
                              vibrationPattern: !secret ALERT_VIBRATION
                              clickAction: /lovelace-mobile/alarm
                              actions:
                                - title: 'Arm Garage'
                                  action: arm_garage_alarm

                                - title: 'Alarm'
                                  action: URI
                                  uri: app://com.thanksmister.iot.mqtt.alarmpanel

                                - title: 'Cameras'
                                  action: URI
                                  uri: app://com.flir.consumer.flir.lorexcloud
          default:
            - service: alarmo.arm
              data:
                entity_id: 'alarm_control_panel.{{ zone }}'
                mode: '{{ mode }}'
                code: '{{ code }}'
