###############################################################################
## Disarm Alarm
###############################################################################
disarm_alarm:
  alias: 'Disarm Alarm'
  description: 'Disarm the house alarm.'
  icon: mdi:alarm-bell
  mode: restart
  fields:
    person:
      description: 'Person disarming alarm.'
      example: 'jason'
    zone:
      description: 'Alarm zone to disarm.'
      example: 'garage'
  sequence:
    - variables:
        person: "{{ person|default('hassio') }}"
        zone: >
          {% set zone = zone|default('master') %}
          {% if zone == 'all' %}
            {% if not is_state('alarm_control_pane.master','disarmed') %} {% set zone = 'master' %}
            {% elif not is_state('alarm_control_pane.house','disarmed') %} {% set zone = 'house' %}
            {% elif not is_state('alarm_control_pane.garage','disarmed') %} {% set zone = 'garage' %}
            {% else %} {% set zone = 'none' %}
            {% endif %}
          {% endif %}
          {{ zone }}

    - condition: template
      alias: 'Alarm not already disarmed'
      value_template: "{{ zone != 'none' }}"

    - choose:
        - conditions: "{{ person == 'temp' }}"
          sequence:
            - condition: template
              alias: 'Alarm zone in armed_home,armed_night,armed_away,pending, or arming state'
              value_template: "{{ states('alarm_control_panel.' ~ zone) in ['armed_home','armed_night','armed_away','pending','arming'] }}"

            - service: input_boolean.turn_on # set override to bypass automation check
              entity_id: input_boolean.alarm_temp_override

            - service: alarm_control_panel.alarm_disarm
              target:
                entity_id: 'alarm_control_panel.{{ zone }}'
              data:
                code: !secret ALARMO_HA #ALARMO

            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_temp_override
      default:
        - choose:
            - conditions: "{{ person == 'hassio' }}"
              sequence:
                - service: alarm_control_panel.alarm_disarm
                  target:
                    entity_id: 'alarm_control_panel.{{ zone }}'
                  data:
                    code: !secret ALARMO_HA #ALARMO

            - conditions: "{{ person == 'jason' }}"
              sequence:
                - service: alarm_control_panel.alarm_disarm
                  target:
                    entity_id: 'alarm_control_panel.{{ zone }}'
                  data:
                    code: !secret ALARMO_JASON #ALARMO

            - conditions: "{{ person == 'sheri' }}"
              sequence:
                - service: alarm_control_panel.alarm_disarm
                  target:
                    entity_id: 'alarm_control_panel.{{ zone }}'
                  data:
                    code: !secret ALARMO_SHERI #ALARMO

            - conditions: "{{ person == 'dawn' }}"
              sequence:
                - service: alarm_control_panel.alarm_disarm
                  target:
                    entity_id: 'alarm_control_panel.{{ zone }}'
                  data:
                    code: !secret ALARMO_DAWN #ALARMO
