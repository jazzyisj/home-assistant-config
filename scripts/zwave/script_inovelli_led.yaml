##################################################################################################
## Inovelli LED Control
##################################################################################################
inovelli_led_control:
  alias: Inovelli LED Control
  description: Sets the LED effects for the Inovelli Red series of switches, dimmers.
  mode: queued
  max: 25
  max_exceeded: error
  fields:
    duration:
      description: Duration, from 1-255. Defaults to 255 which is indefinite.
      example: '255'
    color:
      description: '{"0": "Red", "21": "Orange", "42": "Yellow", "85": "Green", "127": "Cyan", "170": "Blue", "212": "Violet", "234": "Pink", "255": "White"}'
      example: Red
    effect:
      description: LED effect. Varies based on the device type. All support off (default),
        solid, fast blink, slow blink, and pulse. Dimmer and combo also support chase.
      example: pulse
    brightness:
      description: LED brightness, from 1-10 with 3 as the default. (optional)
      example: '3'
    entities:
      description: One or more entities to control.
      example: switch.dining_room,light.porch
  variables:  #ZWAVE device ready (state on/off)
    dimmer_entities: "{{ expand(entities)|selectattr('domain','eq','light')|selectattr('state','in',['on','off'])|map(attribute='entity_id')|list }}"
    switch_entities: "{{ expand(entities)|selectattr('domain','eq','switch')|map(attribute='entity_id')|list }}"
    duration: "{{ duration|int if duration is defined else 255 }}"
    color: "{{ color if color is defined else 'Blue' }}"
    brightness: "{{ brightness|int if brightness is defined else 3 }}"
    effect: "{{ effect if effect is defined else 'off' }}"
  sequence:
    - condition: template
      alias: Prevent errors when templates reload.
      value_template: "{{ entities|lower not in ['','unknown','unavailable','none'] }}"

    - service: zwave_js.bulk_set_partial_config_parameters
      target:
        entity_id: "{{ dimmer_entities }}"
      data:
        parameter: 16
        value:
          "LED Effect Color": "{{ color|title }}"
          "LED Effect Brightness": "{{ brightness|int }}"
          "LED Effect Duration": "{{ duration|int }}"
          "LED Effect Type": "{{ effect|title }}"

    - variables:
        effect: "{{ 'fast blink' if effect == 'chase' else effect }}" # no chase effect for switches

    - service: zwave_js.bulk_set_partial_config_parameters
      target:
        entity_id: "{{ switch_entities }}"
      data:
        parameter: 8
        value:
          "LED Effect Color": "{{ color|title }}"
          "LED Effect Brightness": "{{ brightness|int }}"
          "LED Effect Duration": "{{ duration|int }}"
          "LED Effect Type": "{{ effect|title }}"