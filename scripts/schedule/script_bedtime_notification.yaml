###############################################################################
## Bedtime Notification
###############################################################################
bedtime_notification:
  alias: 'Bedtime Notification'
  description: 'Send bedtime notification.'
  icon: mdi:bed
  variables:
    bedtime_delay: "{{ (states('input_number.bedtime_warning_delay')|int(-1) * 60)|int }}"
    night_delay: "{{ (states('input_number.night_mode_delay')|int(-1) * 60)|int }}"
  sequence:
    - condition: state
      entity_id:
        - binary_sensor.owner_home
        - input_boolean.schedule_alerts
      state: 'on'

    - service: "{{ states('sensor.notify_service_home') }}"
      data:
        title: "{{ 'Time For Bed!' if is_state('binary_sensor.bedtime_active','on') else 'Bedtime Delayed' }}"
        message: >
          {%- set time = states('sensor.time') -%}
          {%- set next_alarm = state_attr('sensor.next_alarm_clock','12hour') -%}
          {%- set waketime = state_attr('sensor.next_waketime','12hour') -%}
          {%- set delayed_bedtime =  state_attr('sensor.next_bedtime','delayed_bedtime')
                if is_state('input_boolean.bedtime_delayed','on')
                  else state_attr('sensor.next_bedtime','12hour') -%}
          {%- set src = state_attr('sensor.alarm_clock_next_alarm','source') -%}
          <br/>Wake Time: {{ waketime -}}
          {%- if waketime == next_alarm -%}
            <br/>Alarm Source: {{ state_attr('sensor.alarm_clock_next_alarm','source_name') -}}
            {%- if src in ['auto','manual','nap'] -%}
              <br/>Alarm Player:
              {%- if src == 'auto' %} {{ states('input_select.alarm_clock_media_player_auto') -}}
              {%- elif src == 'manual' %} {{ states('input_select.alarm_clock_media_player_manual') -}}
              {%- elif src == 'nap' %} {{ states('input_select.alarm_clock_media_player_nap') -}}
              {%- else %} {{ src|replace('_',' ')|title -}}
              {%- endif -%}
            {%- endif -%}
          {%- else -%}<br/>Alarm: No alarm clock set.
          {%- endif -%}
          <br/>Bedtime: {{ delayed_bedtime -}}
          <br/>Bedtime {{ 'Delayed:' if is_state('input_boolean.bedtime_delayed','on')
            else 'Delay:' }} {{ states('input_number.bedtime_delay')|int(-1) }} minutes
        data:
          tag: bedtime_alert
          group: General
          channel: General
          importance: max
          ttl: 0
          priority: high
          persistent: "{{ true if is_state('input_boolean.bedtime_active','on') else false }}"
          sticky: >
            {{ true if is_state('input_boolean.bedtime_active','on')
                  and is_state('binary_sensor.bedtime_active','on') else false }}
          timeout: > #VERIFY
            {% set bedtime = states('sensor.bedtime_today')|as_datetime %}
            {% set until_night = as_timestamp(bedtime + timedelta(seconds=bedtime_delay + night_delay),600) %}
            {% if is_state('binary_sensor.bedtime_active','off') %}
              {% if is_state('input_select.occupancy_mode','Night') %} 600
              {% else %} {{ until_night if until_night > 0 else 600 }}
              {% endif %}
            {% elif is_state('timer.bedtime_delay','on') %}
              {{ as_timestamp(state_attr('timer.bedtime_delay','finishes_at')) - now().timestamp() }}
            {% else %}
              {{ until_night if until_night > 0 else 600 }} {#NOTE bedtime_active delayed off #}
            {% endif %}
          chronometer: true
          when: >
            {% set bedtime = states('sensor.bedtime_today')|as_datetime %}
            {% set default = now() + timedelta(minutes=10) %}
            {% set night_mode = bedtime + timedelta(minutes=bedtime_delay + night_delay) %}
            {% if is_state('binary_sensor.bedtime_active','off') %}
              {% if is_state('input_select.occupancy_mode','Night') %}{{ default }}
              {% elif now() < bedtime %} {{ default }}
              {% else %} {{ night_mode if night_mode > now() else default }}
              {% endif %}
            {% elif is_state('timer.bedtime_delay','on') %}
              {{ state_attr('timer.bedtime_delay','finishes_at')|as_datetime }}
            {% else %}
              {{ night_mode if night_mode > now() else default }}
            {% endif %}
          notification_icon: '{{ states.script.bedtime_notification.attributes.icon }}'
          icon_url: !secret ALARM_CLOCK_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: /lovelace-mobile/presence
          actions:
            - title: 'Stay Up'
              action: bedtime_delayed

            - title: "{{ 'Go To Bed' if is_state('input_boolean.bedtime_delayed','off') else 'Delay Off' }}"
              action: bedtime_delay_off

            - title: 'Alarm Off'
              action: next_alarm_off
