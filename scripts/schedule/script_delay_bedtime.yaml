###############################################################################
## Delay Bedtime
###############################################################################
delay_bedtime:
  alias: "Delay Bedtime"
  description: "Bedtime announcements, turn on night mode."
  icon: mdi:bed-clock
  variables:
    bedtime_delay: "{{ states('input_number.bedtime_delay')|int }}"
  sequence:
    - service: timer.start
      target:
        entity_id: timer.bedtime_delay
      data:
        duration:
          minutes: "{{ bedtime_delay }}"

    # wait for timer active to allow delayed_bedtime to be calculated
    - wait_template: "{{ states('timer.bedtime_delay') == 'active' }}"
      timeout: 2
      continue_on_timeout: false

    - service: script.turn_on
      target:
        entity_id: script.tts_play
      data:
        variables:
          message: >
            Your bedtime has been delayed by {{ bedtime_delay }} minutes.
            I'll check on you again at {{ state_attr('sensor.delayed_bedtime','12hour') }}
            to see if you've come to your senses yet.
          quiet_play: true
      continue_on_error: true

    - service: script.bedtime_notification
