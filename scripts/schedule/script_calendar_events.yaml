###############################################################################
## List Todays Events
###############################################################################
list_todays_events:
  alias: "List Todays Events"
  description: "List today's calendar events"
  icon: mdi:calendar
  sequence:
    - service: calendar.list_events
      target:
        entity_id: calendar.jazzyisjgmailcom
      data:
        duration:
          days: 1
      response_variable: agenda

    - if: "{{ agenda.events|count > 0 }}"
      then:
        - service: script.tts_play
          data:
            message: |
              {% set battery = states('sensor.jphone_battery_level')|int(-1) %}
              {{ states('sensor.tod_greeting') }}!
              Here are your upcoming calendar events.
              {% for event in agenda.events %}
              {% if (event.start|as_datetime).day == now().day %}
                {{ event.start|as_timestamp|timestamp_custom('Today at %-I:%M %p') }}: {{ event.summary }}
              {% else %}
                {{ event.start|as_timestamp|timestamp_custom('%A at %-I:%M %p') }}: {{ event.summary }}
              {% endif %}
              {% if event.description is defined %}, {{ event.description }}{% endif %},
              {% endfor %}.
              {% if battery < 50 %}
                Just a heads up, your mobile phone battery level is only {{ battery }} percent.
              {% endif %}
            quiet_play: true
      else:
        - service: script.tts_play
          data:
            message: "{{ states('sensor.tod_greeting') }}! There are no events on your calendar today!"
            quiet_play: true
#{'events': [{'start': '2023-08-03', 'end': '2023-08-04', 'summary': 'Garbage'}, {'start': '2023-08-03T10:00:00-04:00', 'end': '2023-08-03T11:00:00-04:00', 'summary': 'HA TEST', 'description': 'Test from HA'}, {'start': '2023-08-04', 'end': '2023-08-05', 'summary': 'Recycle'}]}
