###############################################################################
## Arrive Home Lighting
###############################################################################
arrive_home_lighting:
  alias: "Arrive Home Lighting"
  description: "Turn arrive home lighting home."
  icon: mdi:home-lightbulb-outline
  sequence:
    - service: script.turn_light_on
      data:
        lights: light.side_entrance_light
        activate_timer: true # force timer to restart
        bypass_timer: true
        override: true
      continue_on_error: true

    - condition: state
      entity_id:
        - binary_sensor.daytime_illuminance_lights
        - binary_sensor.nighttime_illuminance_lights
      match: any
      state: "on"

    # not restoring if nobody else was home or night mode (lights were off)
    - if: "{{ not first_home or is_state('input_select.occupancy_mode',['Away','Guest']) }}"
      then:
        - service: scene.create
          data:
            scene_id: arrive_home_lights_restore # no side entrance, timer turns it off
            entities:
              light.kitchen_potlights:
                state: "{{ states('light.kitchen_potlights') }}"
                brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
              light.dining_room_potlights:
                state: "{{ states('light.dining_room_potlights') }}"
                brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"
              light.hallway_potlights:
                state: "{{ states('light.hallway_potlights') }}"
                brightness: "{{ state_attr('light.hallway_potlights','brightness')|int(0) }}"

    - service: timer.start
      entity_id: timer.arrive_home_lights

    - service: script.light_scene_on
      data:
        scene: arrive_home
      continue_on_error: true

    # if someone else arrives timer restarts to keep lights on longer
    - alias: "Wait for arrive home timer to finish"
      wait_for_trigger:
        - platform: state
          entity_id: timer.arrive_home_lights
          to: idle

    # don't restore in away/night mode
    # arrive lights were turned off by away mode or night no lights were likely on, don't get left in dark!
    - if:
        - condition: state
          entity_id: input_select.occupancy_mode
          match: any
          state:
            - Home
            - Guest
      then:
        - if: "{{ first_home }}"
          then:
            - if: # dark out leave arrive lights on
                - condition: state
                  entity_id: binary_sensor.nighttime_illuminance_lights
                  state: "off"
              then:
                - service: script.turn_light_off
          else: # return to light settings before arrive lights
            - service: script.light_scene_on
              data:
                scene: arrive_home_lights_restore
