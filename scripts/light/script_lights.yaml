#######################################################################################################################
## Lights Off
#######################################################################################################################
lights_off:
  alias: "Lights Off"
  description: "Turn all lights off."
  icon: mdi:lightbulb-off
  variables:
    lights: >
      {{ states.light|selectattr('state','eq','on')
        |rejectattr('attributes.light_group','eq',true)
        |rejectattr('attributes.rgb_control','eq',true)
        |rejectattr('attributes.rgb_light','eq','slave')
        |rejectattr('attributes.type','eq','volume')
        |map(attribute='entity_id')|list }}
  sequence:
    - service: browser_mod.toast
      data:
        message: "Turning off all lights."
        duration: 30000

    - service: automation.turn_off
      target:
        entity_id: &light_automations
          - automation.notify_led_notification_update  # prevent led updates from firing on all lights - too much zwave traffic
          - group.light_in_use_automations # don't trigger device in use timers
      data:
        stop_actions: false

    - service: light.turn_off
      target: # don't use all lights - triggers rgb master switches
        entity_id: "{{ lights }}"

    - wait_template: > # wait so slow devices don't trigger timers
        {{ states.light|selectattr('state','eq','on')
            |rejectattr('attributes.light_group','eq',true)
            |rejectattr('attributes.rgb_control','eq',true)
            |rejectattr('attributes.rgb_light','eq','slave')
            |rejectattr('attributes.type','eq','volume')
            |map(attribute='entity_id')|list|count == 0 }}
      timeout: 10

    - service: timer.cancel
      target:
        entity_id: "{{ states.timer|selectattr('attributes.type','eq','light')|map(attribute='entity_id')|list }}"

    - delay: #ZWAVE delay to allow devices to change state
        seconds: 10

    - service: automation.turn_on
      target:
        entity_id: *light_automations

    - service: script.led_reset # we prevented update above

#######################################################################################################################
## Lights On
#######################################################################################################################
lights_on:
  alias: "Lights On"
  description: "Turn all lights on."
  icon: mdi:lightbulb
  sequence:
    - service: browser_mod.toast
      data:
        message: Turning on all lights.
        duration: 30000

    - service: automation.turn_off
      target:
        entity_id: *light_automations

    - service: light.turn_on
      target:
        entity_id: > # state on/off to ensure brightness set, #ZWAVE device ready (state on/off)
          {{ states.light|selectattr('state','in',['on','off'])
              |rejectattr('attributes.light_group','eq',true)
              |rejectattr('attributes.rgb_control','eq',true)
              |rejectattr('attributes.rgb_light','eq','slave')
              |rejectattr('attributes.type','eq','volume')
              |map(attribute='entity_id')|list }}
      data:
        profile: max

    - wait_template: > # wait so slow devices don't trigger timers
        {{ states.light|selectattr('state','eq','off')
            |rejectattr('attributes.light_group','eq',true)
            |rejectattr('attributes.rgb_control','eq',true)
            |rejectattr('attributes.rgb_light','eq','slave')
            |rejectattr('attributes.type','eq','volume')
            |map(attribute='entity_id')|list|count == 0 }}
      timeout: 10

    - service: timer.cancel
      target:
        entity_id: "{{ states.timer|selectattr('attributes.type','eq','light')|map(attribute='entity_id')|list }}"

    - delay: #ZWAVE delay to allow devices to change state
        seconds: 10

    - service: automation.turn_on
      entity_id: *light_automations

    - service: script.led_reset # we prevented update above