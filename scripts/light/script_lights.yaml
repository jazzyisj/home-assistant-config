###############################################################################
## Lights Off
###############################################################################
lights_off:
  alias: 'Lights Off'
  description: 'Turn all lights off.'
  icon: mdi:lightbulb-off
  sequence:
    - service: light.turn_off
      target:
        entity_id: "{{ state_attr('binary_sensor.lights_on','entities') }}"

    # wait so slow devices don't trigger device in use timers
    - wait_template: "{{ is_state('binary_sensor.lights_on','off') }}"
      timeout: 10

    # cancel any running light device in use timers
    - service: timer.cancel
      target:
        entity_id: >
          {{ expand('group.light_timers')|selectattr('state','ne','idle')
              |map(attribute='entity_id')|list }}

###############################################################################
## Lights On
###############################################################################
lights_on:
  alias: 'Lights On'
  description: 'Turn all lights on.'
  icon: mdi:lightbulb
  sequence:
    - service: light.turn_on
      target:
        entity_id: >
          {{ expand('group.lights')|selectattr('state','in',['on','off'])
              |map(attribute='entity_id')|list }}
      data:
        profile: max

    # wait so slow devices don't trigger device in use timers
    - wait_template: "{{ expand('group.lights')|selectattr('state','eq','off')|list|count == 0 }}"
      timeout: 10

    # cancel any running light device in use timers
    - service: timer.cancel
      target:
        entity_id: >
          {{ expand('group.light_timers')|selectattr('state','ne','idle')
              |map(attribute='entity_id')|list }}
