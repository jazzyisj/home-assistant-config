###############################################################################
## Turn Light On
###############################################################################
turn_light_on:
  alias: "Turn Light On"
  description: "Turn light on."
  icon: mdi:lightbulb
  mode: parallel
  fields:
    lights:
      description: "List of light entity ids"
      example: "['light.dining_room_rgb_light','light.dining_potlights']"
    activate_timer:
      description: "Activate light in use timer"
      example: "true"
    timer:
      description: "Start light/manual control timer"
      example: "false"
    bypass_timer:
      description: "Activate light in use timer"
      example: "false"
    override:
      description: "Override adaptive lighting"
      example: "false"
    profile:
      description: "Light profile to use"
      example: "default"
    transition:
      description: "Transition time"
      example: "5"
  variables:
    entities: > # convert to list
      {% set all = expand('group.lights')
          |selectattr('state','in',['on','off'])
          |map(attribute='entity_id')|list %}
      {% set entities = expand(lights|default(all))|map(attribute='entity_id')|list %}
      {{ entities }}
    activate_timer: "{{ activate_timer|default(true) }}"
    timer: "{{ activate_timer|default(false) }}"
    bypass_timer: "{{ bypass_timer|default(false) }}"
    override: "{{ override|default(false) }}"
    profile: "{{ profile|default(iif(is_state('input_select.occupancy_mode','Night'),'default_dim','default')) }}"
    transition: "{{ transition|default(2) }}"
  sequence:
    - if: "{{ not activate_timer and not override }}"
      then:
        - service: automation.turn_off
          target:
            entity_id: automation.light_in_use_timer

    - repeat:
        for_each: "{{ entities }}"
        sequence:
          - variables:
              timer: "timer.{{ repeat.item.split('.')[1]|replace('_rgb','')|default('') }}"
              switch: >
                {{ (states.switch
                    |selectattr('entity_id','search','adaptive_lighting')
                    |selectattr('attributes.configuration','defined')
                    |selectattr('attributes.configuration.lights','defined')
                    |selectattr('attributes.configuration.lights','search',repeat.item)
                    |map(attribute='entity_id')|list)[0]|default(none) }}
              manual: >
                {{ repeat.item in state_attr(switch,'manual_control')
                    if switch != none and state_attr(switch,'manual_control') != none else false }}

          - if: "{{ override }}"
            then:
              - if: "{{ has_value(timer) }}"
                then:
                  - service: timer.start
                    target:
                      entity_id: "{{ timer }}"

              - service: light.turn_on
                target:
                  entity_id: "{{ repeat.item }}"
                data:
                  profile: default
            else:
              - condition: template
                alias: "No timer or timer bypassed, or timer not active and not manual mode"
                value_template: >
                  {{ (bypass_timer or not has_value(timer))
                      or (not manual and is_state(timer,'idle')) }}

              - if: "{{ switch != none and is_state(switch,'on') }}"
                then:
                  - if: "{{ is_state(repeat.item,'off') }}"
                    then:
                      - service: adaptive_lighting.apply
                        continue_on_error: true
                        data:
                          entity_id: "{{ switch }}"
                          lights: "{{ repeat.item }}"
                          transition: "{{ transition }}"
                          adapt_brightness: true
                          adapt_color: true
                          prefer_rgb_color: true
                          turn_on_lights: true
                else:
                  - service: light.turn_on
                    continue_on_error: true
                    target:
                      entity_id: "{{ repeat.item }}"
                    data:
                      profile: "{{ profile }}"
                      transition: "{{ transition }}"

    - if: "{{ not activate_timer and not override }}"
      then:
        - service: automation.turn_on
          target:
            entity_id: automation.light_in_use_timer
