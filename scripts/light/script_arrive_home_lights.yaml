###############################################################################
## Arrive Home Lights
###############################################################################
arrive_home_lights:
  alias: 'Arrive Home Lights'
  description: 'Arrive home lighting.'
  max_exceeded: silent
  fields:
    first_home:
      description: 'Person is first person home.'
      example: 'true'
  sequence:
    - choose: # turn side entrance light on or in use timer
        - conditions:
            - condition: state
              entity_id: light.side_entrance_light
              state: 'on'
          sequence:
            - service: timer.start
              entity_id: timer.side_entrance_light
      default:
        - service: light.turn_on
          target:
            entity_id: light.side_entrance_light

    - condition: state
      entity_id: binary_sensor.nighttime_illuminance_lights
      state: 'on'

    # not restoring if nobody else was home (lights were off)
    - choose:
        - conditions: '{{ not first_home }}'
          sequence:
            - service: scene.create
              data:
                scene_id: arrive_home_lights_restore
                entities:
                  light.kitchen_potlights:
                    state: "{{ states('light.kitchen_potlights') }}"
                    brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
                  light.dining_room_potlights:
                    state: "{{ states('light.dining_room_potlights') }}"
                    brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"
                  light.hallway_potlights:
                    state: "{{ states('light.hallway_potlights') }}"
                    brightness: "{{ state_attr('light.hallway_potlights','brightness')|int(0) }}"

    - service: timer.start
      entity_id: timer.arrive_home_lights

    - service: light.turn_on
      target:
        entity_id: light.upstairs_potlights

    # if someone else arrives timer restarts to keep lights on longer
    - alias: 'Wait for arrive home timer to finish'
      wait_for_trigger:
        - platform: state
          entity_id: timer.arrive_home_lights
          to: 'idle'

    # don't restore if nobody else was home (lights were off)
    - choose:
        - conditions: '{{ not first_home }}'
          sequence:
            - service: script.activate_light_scene
              data:
                scene: arrive_home_lights_restore
