###############################################################################
## Arrive Home Lights
###############################################################################
arrive_home_lights:
  alias: "Arrive Home Lights"
  description: "Arrive home lighting."
  max_exceeded: silent
  fields:
    first_home:
      description: "Person is first person home."
      example: "true"
  sequence:
    # turn side entrance light on or in use timer
    - if:
        - condition: state
          entity_id: light.side_entrance_light
          state: "on"
      then:
        - service: timer.start
          entity_id: timer.side_entrance_light
      else:
        - service: light.turn_on
          target:
            entity_id: light.side_entrance_light

    - condition: state
      entity_id: binary_sensor.nighttime_illuminance_lights
      state: "on"

    - condition: state
      alias: "Upstairs potlights are off"
      entity_id: light.upstairs_potlights
      state: "off"

    # not restoring if nobody else was home (lights were off)
    - if: "{{ not first_home }}"
      then:
        - service: scene.create
          data:
            scene_id: arrive_home_lights_restore
            entities:
              light.kitchen_potlights:
                state: "{{ states('light.kitchen_potlights') }}"
                brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
              light.dining_room_potlights:
                state: "{{ states('light.dining_room_potlights') }}"
                brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"
              light.hallway_potlights:
                state: "{{ states('light.hallway_potlights') }}"
                brightness: "{{ state_attr('light.hallway_potlights','brightness')|int(0) }}"

    - service: timer.start
      entity_id: timer.arrive_home_lights

    - service: light.turn_on
      target:
        entity_id: light.upstairs_potlights

    # if someone else arrives timer restarts to keep lights on longer
    - alias: "Wait for arrive home timer to finish"
      wait_for_trigger:
        - platform: state
          entity_id: timer.arrive_home_lights
          to: "idle"

    # don't restore if nobody else was home (lights were off)
    - if: "{{ not first_home }}"
      then:
        - service: script.activate_light_scene
          data:
            scene: arrive_home_lights_restore
