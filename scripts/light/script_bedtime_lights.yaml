#######################################################################################################################
## Bedtime Lights - separate script so it turns on light_scene_active sensor when on #NEW_LIGHT
#######################################################################################################################
bedtime_lights:
  alias: "Bedtime Lights"
  description: "Adjust lighting for bedtime."
  sequence:
    - service: automation.turn_off # turn off automation so we don't trigger device in use timers
      entity_id: group.light_in_use_automations

    - choose:
      - conditions:
          - condition: state
            entity_id: timer.living_room_pot_lights
            state:  idle

          - condition: template
            value_template: > # light is off if brightness not defined
              {% if state_attr('light.living_room_pot_lights','brightness')|lower not in ['unknown','unavailable','none'] %}
                {{ state_attr('light.living_room_pot_lights','brightness')|int < 15 }}
              {% else %} true
              {% endif %}
        sequence:
          - service: light.turn_on
            target:
              entity_id: light.living_room_pot_lights
            data:
              brightness: 15
              transition: 3

    - choose:
        - conditions:
            - condition: state
              entity_id: timer.kitchen_potlights
              state:  idle

            - condition: template
              value_template: > # light is off if brightness not defined
                {% if state_attr('light.kitchen_potlights','brightness')|lower not in ['unknown','unavailable','none'] %}
                  {{ state_attr('light.kitchen_potlights','brightness')|int < 10 }}
                {% else %} true
                {% endif %}
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kitchen_potlights
              data:
                brightness: 10
                transition: 3

    - choose:
        - conditions:
            - condition: state
              entity_id: timer.dining_room_potlights
              state:  idle

            - condition: template
              value_template: > # light is off if brightness not defined
                {% if state_attr('light.dining_room_potlights','brightness')|lower not in ['unknown','unavailable','none'] %}
                  {{ state_attr('light.dining_room_potlights','brightness')|int < 10 }}
                {% else %} true
                {% endif %}
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.dining_room_potlights
              data:
                brightness: 10
                transition: 3

    - choose:
        - conditions:
            - condition: state
              entity_id: timer.upstairs_hallway_potlights
              state:  idle

            - condition: template
              value_template: > # light is off if brightness not defined
                {% if state_attr('light.upstairs_hallway_potlights','brightness')|lower not in ['unknown','unavailable','none'] %}
                  {{ state_attr('light.upstairs_hallway_potlights','brightness')|int < 10 }}
                {% else %} true
                {% endif %}
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.upstairs_hallway_potlights
              data:
                brightness: 10
                transition: 3

    #DISABLED - choose:
    #     - conditions:
    #         - condition: template
    #           alias: Less than 5 minutes after bedtime (someone might already be in bed)
    #           value_template: >
    #             {{ is_state('sensor.bedtime_today','off') or states('sensor.time') < (as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.bedtime_today'))|int + 300)|timestamp_custom('%H:%M',true) }}

    #         - condition: state
    #           entity_id: timer.upstairs_bedroom_light
    #           state:  idle
    #       sequence:
    #         - service: light.turn_on
    #             target:
    #             entity_id: light.upstairs_bedroom_rgb_light
    #           data:
    #             brightness: 10

    # - choose:
    #     - conditions:
    #         - condition: state
    #           entity_id: timer.upstairs_bedroom_potlights
    #           state:  idle
    #       sequence:
    #         - service: light.turn_off
    #           entity_id: light.upstairs_bedroom_potlights

    - delay: # delay to allow devices to change state
        seconds: 10

    - service: automation.turn_on
      entity_id: group.light_in_use_automations
