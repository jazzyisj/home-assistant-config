#######################################################################################################################
## Set Climate Temperature
#######################################################################################################################
set_climate_temperature:
  alias: "Set Climate Temperature"
  description: "Set thermostat to preset mode/temperatures."
  icon: mdi:thermostat
  mode: restart
  variables:
    occupancy_mode: "{{ states('input_select.occupancy_mode') }}"
  sequence:
    - service: automation.turn_off # avoid recursive calls
      entity_id: &climate_automations
        - automation.climate_settings_adjusted
        - automation.climate_mode_changed

    - choose: # if climate is off set to previous hvac mode
        - conditions:
            - condition: state
              entity_id: climate.thermostat
              state: 'off'
          sequence:
            - service: climate.set_hvac_mode
              target:
                entity_id: climate.thermostat
              data:
                hvac_mode: "{{ states('input_select.set_hvac_mode') }}"

    # if override mode, cancel eco to preheat/cool house when not at home
    - service: climate.set_preset_mode
      target:
        entity_id: climate.thermostat
      data:
        preset_mode: >
          {{ 'eco' if occupancy_mode in ['Away','Vacation']
              and is_state('input_boolean.hvac_presence_override','off') else 'none' }}

    - delay: 5 # delay to allow climate mode changes to register (Nest slow))

    - service: automation.turn_on
      entity_id: *climate_automations

    - wait_template: > #  wait for eco mode to register in away mode (Nest slow)
        {% if occupancy_mode in ['Away','Vacation'] and is_state('input_boolean.hvac_presence_override','off') %}
          {{ is_state_attr('climate.thermostat','preset_mode','eco') }}
        {% else %}
          {{ is_state_attr('climate.thermostat','preset_mode','none') }}
        {% endif %}
      timeout: 5

    - condition: template  # error if temp is set in off/eco mode
      alias: "HVAC mode is not off or eco mode"
      value_template: >
        {{ not is_state_attr('climate.thermostat','hvac_mode','off')
            and is_state_attr('climate.thermostat','preset_mode','none') }}

    - service: climate.set_temperature
      target:
        entity_id: climate.thermostat
      data:
        temperature: > # temperature defaults to heat temps
          {% if states('climate.thermostat') == 'heat' %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_heat_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_heat_temperature')|int }}
            {% else %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% endif %}
          {% elif states('climate.thermostat') == 'cool' %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_cool_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_cool_temperature')|int }}
            {% else %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% endif %}
          {% else %}
            {{ states('input_number.home_heat_temperature')|int }}
          {% endif %}
        target_temp_high: >  # set temps for auto mode - temps can't be within 3 degress of eachother!
          {% if (states('input_number.home_cool_temperature')|int) > (states('input_number.home_heat_temperature')|int) %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_cool_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_cool_temperature')|int }}
            {% else %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% endif %}
          {% else %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_heat_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_heat_temperature')|int }}
            {% else %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% endif %}
          {% endif %}
        target_temp_low: >
          {% if (states('input_number.home_cool_temperature')|int) <= (states('input_number.home_heat_temperature')|int) %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_cool_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_cool_temperature')|int }}
            {% else %}
              {{ states('input_number.home_cool_temperature')|int }}
            {% endif %}
          {% else %}
            {% if occupancy_mode == 'Home' or is_state('input_boolean.hvac_presence_override','on') %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% elif occupancy_mode == 'Night' %}
              {{ states('input_number.night_heat_temperature')|int }}
            {% elif occupancy_mode == 'Guest' %}
              {{ states('input_number.guest_heat_temperature')|int }}
            {% else %}
              {{ states('input_number.home_heat_temperature')|int }}
            {% endif %}
          {% endif %}
