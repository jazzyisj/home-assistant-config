#######################################################################################################################
## Active Radio Player Off
## active_media_player_radio populated during radio_on, stores active playing radio media player
## req to turn off current media player before starting new media player because 'sensor.radio_media_player will have already changed to new value if has been changed
# #######################################################################################################################
active_radio_player_off:
  alias: "Active Radio Player Off"
  description: "Turn the current radio media player off."
  icon: mdi:alarm-note-off
  mode: single
  variables:
    old: "{{ states('input_text.active_media_player_radio') }}"
    new: "{{ states('sensor.radio_media_player') }}"
    groups: "{{ states.media_player|selectattr('attributes.speaker_group','eq',true)|map(attribute='entity_id')|list }}"
  sequence:
    # make sure active_media_player_radio is a valid media player (not cleared)
    - condition: template
      value_template: "{{ old in state_attr('group.media_players','entity_id') }}"

    #NOTE broswer players/chromecast don't turn off so stop play first
    - choose:
        - conditions:
            - condition: template
              value_template: "{{ is_state(old, 'playing') }}"

          sequence:
            - service: media_player.media_stop
              data:
                entity_id: "{{ old }}"

    # turn off active radio media players that are not part of the new radio media player group
    - choose:
        - conditions:
            - condition: template
              value_template: >
                {% if old in groups %}
                  {% if new in groups %}
                      {{ expand('group.' ~ old.split('.')[1])|map(attribute='entity_id')
                          |reject('in',expand('group.' ~ new.split('.')[1])|map(attribute='entity_id')|list)|list|count > 0 }}
                  {% else %} true
                  {% endif %}
                {% else %}
                  {% if new in groups %}{{ expand('group.' ~ new.split('.')[1])|selectattr('entity_id','eq',old)|map(attribute='entity_id')|list|count == 0 }}
                  {% else %}{{ old != new }}
                  {% endif %}
                {% endif %}

          sequence:
            - service: media_player.turn_off
              data:
                entity_id: >
                  {% if old in groups %}
                    {% if new in groups %}
                        {{ expand('group.' ~ old.split('.')[1])|map(attribute='entity_id')
                            |reject('in',expand('group.' ~ new.split('.')[1])|map(attribute='entity_id')|list)|list|join(',') }}
                    {% else %}{{ expand('group.' ~ old.split('.')[1])|rejectattr('entity_id','eq',new)|map(attribute='entity_id')|list|join(',') }}
                    {% endif %}
                  {% else %}
                    {% if new in groups %}{{ expand('group.' ~ old.split('.')[1])|rejectattr('entity_id','eq',new)|map(attribute='entity_id')|list|join(',') }}
                     {% else %}{{ old }}
                    {% endif %}
                  {% endif %}

    - service: input_text.set_value
      data:
        entity_id: input_text.active_media_player_radio
        value: cleared
