#######################################################################################################################
## Radio Stop
#######################################################################################################################
radio_stop:
  alias: Radio Stop
  description: Turn off radio media players, reset booleans.
  mode: single
  variables:
    player: "{{ states('sensor.radio_media_player') }}"
  sequence:
    # make sure radio_play is turned off
    - service: script.turn_off
      entity_id: script.radio_play

    # prevent recursive call
    - service: automation.turn_off
      data:
        entity_id: automation.radio_turned_off
        stop_actions: false

    # turn boolean off to keep in sync if called from script
    - service: input_boolean.turn_off
      entity_id:
        - input_boolean.radio_on
        - input_boolean.radio_pause

    - service: automation.turn_on
      entity_id: automation.radio_turned_off

    - service: input_text.set_value
      data:
        entity_id: input_text.active_media_player_radio
        value: cleared

    # radio player already stopped
    - condition: template
      value_template: "{{ player != '' }}"

    #NOTE broswer players/chromecast don't turn off so stop play first
    - choose:
      - conditions: "{{ is_state(player,'playing') }}"

        sequence:
          - service: media_player.media_stop
            data:
              entity_id: "{{ player }}"

    # turn off radio media player (media players in lovelace don't close in idle state)
    - service: media_player.turn_off
      data:
        entity_id: "{{ player }}"

    - service: script.set_media_player_volumes
      data:
        media_player: "{{ player }}"
        source: radio_off

