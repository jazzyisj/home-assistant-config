#######################################################################################################################
## Disarm Alarm Auto
#######################################################################################################################
disarm_alarm_auto:
  alias: Disarm Alarm Auto
  description: Disarm the house alarm.
  icon: mdi:alarm-bell
  mode: restart
  fields:
    mobile:
      description: Script by this mobile device.
      example: jphone
    override:
      description: Allow disarm override.
      example: true
  variables:
    #ISSUE phone locked sensor taking too long to update
    #UNLOCKED {{ is_state('binary_sensor.jphone_device_locked','off') }}
    unlocked: >
      {% if mobile == 'jphone' %}{{ is_state('binary_sensor.jason_home','on') or is_state('input_boolean.jason_almost_home','on') }}
      {% elif mobile == 'sphone' %}{{ is_state('binary_sensor.sheri_home','on') or is_state('input_boolean.sheri_almost_home','on') }}
      {% endif %}
  sequence:
    - wait_template: "{{ override or unlocked }}"
      timeout:
        seconds: 90
      continue_on_timeout: true # so notification can be sent

    - choose:
        - conditions:
            - condition: template
              value_template: "{{ not override and not unlocked }}"

          sequence:
            - service: browser_mod.toast
              data:
                duration: 30000
                message: Alarm could not be disarmed.

            - service: "{{ 'notify.mobile_app_jphone' if mobile == 'jphone' else 'notify.mobile' }}" #NOTIFY mobile_app_sphone
              data:
                title: House Alarm Warning
                message: >
                  Someone has attempted to disarm the house alarm with a locked device.
                data:
                  subject: The alarm could not be disarmed.
                  tag: alarm_device_locked
                  group: Alarm
                  channel: General
                  importance: max
                  timeout: 3600
                  clickAction: /lovelace/alarm
                  color: !secret WARNING_COLOR
                  icon_url: !secret ALERT_ICON
                  actions:
                    - title: Cameras
                      action: URI
                      uri: app://com.flir.consumer.flir.lorexcloud

      default:
        - service: browser_mod.toast
          data:
            duration: 30000
            message: Alarm is disarming.

        - service: alarm_control_panel.alarm_disarm
          data:
            entity_id: alarm_control_panel.house
            code: !secret ALARM_HASSIO

        # wait to see if alarm get disarmed
        - wait_template: "{{ is_state('alarm_control_panel.house','disarmed') }}"
          timeout:
            seconds: 90
          continue_on_timeout: true

        # error notification if alarm doesn't disarm
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: alarm_control_panel.house
                      state: disarmed

              sequence:
                - service: notify.mobile_app_jphone
                  data:
                    title: House Alarm Error
                    message: |
                      Override: {{ override }}
                      <br/>Unlocked: {{ unlocked }}
                      <br/>Mobile: {{ mobile }}
                      <br/>Jason Home: {{ states('binary_sensor.jason_home') }}
                      <br/>Jason Almost Home: {{ states('input_boolean.jason_almost_home') }}
                      <br/>Sheri Home: {{ states('binary_sensor.sheri_home') }}
                      <br/>Sheri Almost Home: {{ states('input_boolean.sheri_almost_home') }}
                    data:
                      subject: Alarm disarming error.
                      tag: alarm_disarm_failed
                      group: Alarm
                      channel: General
                      importance: max
                      timeout: 3600
                      clickAction: /lovelace/alarm
                      color: !secret CRITICAL_COLOR
                      icon_url: !secret ALERT_ICON

          default:
            - choose:
                - conditions: "{{ mobile in ['jphone','sphone'] }}"
                  sequence:
                    - service: "{{ 'notify.mobile_app_jphone' if mobile == 'jphone' else 'notify.mobile' }}" #NOTIFY "notify.mobile_app_{{ mobile }}"
                      data:
                        title: Alarm Disarmed
                        message: House alarm has been disarmed.
                        data:
                          tag: alarm_disarmed
                          group: Alarm
                          channel: General
                          importance: max
                          timeout: 300
                          color: !secret NOTIFY_COLOR
                          icon_url: !secret HASSIO_ICON