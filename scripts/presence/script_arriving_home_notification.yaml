###############################################################################
## Arriving Home Notification
###############################################################################
arriving_home_notification:
  alias: "Arriving Home Notification"
  description: "Send notification to person who is arriving home."
  icon: mdi:home-account
  mode: parallel
  fields:
    person:
      description: "Person who is arriving home."
      example: "jason"
  sequence:
    - service: notify.mobile_app_jphone
      data:
        message: command_launch_app
        data:
          package_name: com.thanksmister.iot.mqtt.alarmpanel

    - service: "notify.{{ person }}"
      data:
        message: "{{ person|title }} Arriving Home."
        data:
          tag: "{{ person }}_almost_home"
          group: Alarm
          channel: General
          importance: max
          ttl: 0
          priority: high
          persistent: true
          sticky: >
            {{ true if is_state('binary_sensor.' ~ person ~ '_home','off')
                or states.binary_sensor[person ~ '_home'].last_changed
                  > now() - timedelta(minutes=5) else false }}
          timeout: 600
          chronometer: true
          when: "{{ (now().timestamp() + 600)|int }}"
          notification_icon: "{{ states.script.arriving_home_notification.attributes.icon }}"
          icon_url: !secret ARRIVE_HOME_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: /ui/alarm
          actions:
            - title: "Alarm"
              action: URI
              uri: !secret ALARM_URI

            - title: "Disarm"
              action: "disarm_alarm_{{ person }}"

            - title: "Garage"
              action: "open_garage_{{ person }}"

    - delay: 120

    - wait_template: >
        {{ is_state('alarm_control_panel.master','disarmed')
            and is_state('binary_sensor.' ~ person ~ '_home','on') }}
      timeout: 480 # remainder of timeout for notification

    - service: "notify.{{ person }}"
      data:
        message: clear_notification
        data:
          tag: "{{ person }}_almost_home"
