###############################################################################
## Arriving Home Notification
###############################################################################
arriving_home_notification:
  alias: 'Arriving Home Notification'
  description: 'Send notification to person who is arriving home.'
  icon: mdi:home-account
  mode: parallel
  fields:
    person:
      description: 'Person who is arriving home.'
      example: 'jason'
  sequence:
    - condition: state
      entity_id: input_boolean.presence_alerts
      state: 'on'

    - service: 'notify.{{ person }}'
      data:
        message: '{{ person|title }} Arriving Home.'
        data:
          tag: '{{ person }}_almost_home'
          group: Alarm
          channel: General
          importance: max
          ttl: 0
          priority: high
          persistent: true
          sticky: >
            {{ true if is_state('binary_sensor.' ~ person ~ '_home','off')
                or states.binary_sensor[person ~ '_home'].lastchanged
                  > now() - timedelta(minutes=5) else false }}
          timeout: 600
          chronometer: true
          when: '{{ (now().timestamp() + 600)|int }}'
          notification_icon: '{{ states.script.arriving_home_notification.attributes.icon }}'
          icon_url: !secret PERSON_HOME_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: /lovelace-mobile/alarm
          actions:
            - title: 'Alarm'
              action: URI
              uri: app://com.thanksmister.iot.mqtt.alarmpanel

            - title: 'Disarm'
              action: 'disarm_alarm_{{ person }}'
            #TODO just garage if alarm disarmed
            - title: 'Garage'
              action: 'open_garage_{{ person }}'

    - wait_template: >
        {{ is_state('alarm_control_panel.master','disarmed')
              and is_state('binary_sensor.' ~ person ~ '_home','on') }}
      timeout: 600 # this is max time that disarm alarm actions from notification will work

    - service: input_boolean.turn_off
      target:
        entity_id: 'input_boolean.{{ person }}_almost_home'

    - service: 'notify.{{ person }}'
      data:
        message: clear_notification
        data:
          tag: '{{ person }}_almost_home'
