###############################################################################
## Arriving Home Notification
###############################################################################
arriving_home_notification:
  alias: 'Arriving Home Notification'
  description: 'Send notification to person who is arriving home.'
  icon: mdi:home
  fields:
    person:
      description: 'Person who is arriving home.'
      example: 'jason'
  mode: parallel
  max: 2
  sequence:
    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: '{{ person }}_heading_home'

    - service: 'notify.{{ person }}'
      data:
        title: '{{ person|title }} Arriving Home.'
        message: 'Disarm the house alarm.'
        data:
          tag: '{{ person }}_almost_home'
          group: Alarm
          channel: General
          importance: max
          ttl: 0
          priority: high
          timeout: 600
          persistent: true
          clickAction: /lovelace/alarm
          color: !secret NOTIFY_COLOR
          icon_url: !secret HASSIO_ICON
          chronometer: true
          when: '{{ (now().timestamp() + 600) }}'
          actions:
            - action: 'disarm_alarm_{{ person }}'
              title: 'Disarm'
            - action: 'open_garage_{{ person }}'
              title: 'Garage'

    - wait_template: >
        {{ is_state('alarm_control_panel.master','disarmed')
              and is_state('binary_sensor.' ~ person ~ '_home','on') }}
      timeout: 600 # this is max time that disarm alarm actions from notification will work

    - service: input_boolean.turn_off
      target:
        entity_id: 'input_boolean.{{ person }}_almost_home'

    - service: 'notify.{{ person }}'
      data:
        message: clear_notification
        data:
          tag: '{{ person }}_almost_home'
