###############################################################################
## Garage Door Open
###############################################################################
garage_door_open:
  alias: 'Garage Door Open'
  description: 'Open the garage door.'
  icon: mdi:garage
  mode: restart
  fields:
    person:
      description: 'Script called by this person.'
      example: 'jason'
  sequence:
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.myq_connected
              state: 'off'
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.garage_door_open_alert

            - service: script.tts_play
              data:
                message: 'The garage door is not connected and cannot be opened.'
                min_volume: 50
                quiet_play: true
                ignore_away: true
                save_message: true

            - choose:
                - conditions: "{{ person in ['jason','sheri'] }}"
                  sequence:
                    - service: 'notify.{{ person }}'
                      data:
                        title: 'Garage Door Alert'
                        message: 'The garage door is not connected and cannot be opened.'
                        data:
                          tag: garage_door_alert
                          group: Alert
                          channel: Alert
                          importance: max
                          ttl: 0
                          priority: high
                          timeout: 600
                          notification_icon: mdi:garage-alert
                          icon_url: !secret HASSIO_ICON
                          ledColor: !secret WARNING_COLOR
                          color: !secret WARNING_COLOR
                          vibrationPattern: !secret ALERT_VIBRATION
                          clickAction: /lovelace-mobile/garage
                          actions:
                            - title: 'MyQ'
                              action: URI
                              uri: app://com.chamberlain.android.liftmaster.myq

        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alarm_control_panel.master
                  state: disarmed
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.garage_door_open_alert

            - service: script.tts_play
              data:
                message: 'Disarm the alarm to open the garage door.'
                min_volume: 50
                quiet_play: true
                ignore_away: true
                save_message: true

            - wait_template: "{{ is_state('alarm_control_panel.master','disarmed') }}"
              timeout:
                seconds: 60

            - choose:
                - conditions: '{{ wait.completed }}'
                  sequence:
                    - service: cover.open_cover
                      entity_id: cover.garage_door
              default:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.garage_door_open_alert

                - service: script.tts_play
                  data:
                    message: 'The house alarm did not disarm.  The garage door cannot be opened.'
                    min_volume: 50
                    quiet_play: true
                    ignore_away: true
                    save_message: true

                - choose:
                    - conditions: "{{ person in ['jason','sheri'] }}"
                      sequence:
                        - service: 'notify.{{ person }}'
                          data:
                            title: 'Garage Door Alert'
                            message: 'The house alarm did not disarm.  The garage door cannot be opened.'
                            data:
                              tag: garage_door_alert
                              group: Alert
                              channel: Alert
                              importance: max
                              ttl: 0
                              priority: high
                              timeout: 600
                              notification_icon: mdi:garage-alert
                              icon_url: !secret GARAGE_OPEN_ICON
                              ledColor: !secret WARNING_COLOR
                              color: !secret WARNING_COLOR
                              vibrationPattern: !secret ALERT_VIBRATION
                              clickAction: /lovelace-mobile/garage
                              actions:
                                - title: 'Alarm'
                                  action: URI
                                  uri: app://com.thanksmister.iot.mqtt.alarmpanel

                                - title: 'MyQ'
                                  action: URI
                                  uri: app://com.chamberlain.android.liftmaster.myq

                                - title: 'Garage'
                                  action: 'open_garage_{{ person }}'

      default:
        - service: cover.open_cover
          entity_id: cover.garage_door

###############################################################################
# Garage Door Toggle
###############################################################################
garage_door_toggle:
  alias: 'Garage Door Toggle'
  description: 'Toggle garage door.'
  icon: mdi:garage
  mode: queued # wait for script.garage_door_open to finish
  max: 5
  sequence:
    - choose:
        - conditions:
            - condition: state
              entity_id: cover.garage_door
              state:
                - closed
                - closing
                - unknown # to trigger tts warning
                - unavailable # to trigger tts warning
          sequence:
            - service: script.garage_door_open
              data:
                person: switch
      default: # opening, open
        - service: cover.close_cover
          target:
            entity_id: cover.garage_door
