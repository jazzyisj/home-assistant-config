###############################################################################
## Weather Report
# use|replace("<"," less than ")|replace(">","greater than") filter to prevent malformed tts message
###############################################################################
weather_report: #DARKSKY
  alias: 'Weather Report'
  description: 'Play daily weather report.'
  icon: mdi:weather-lightning-rainy
  max_exceeded: silent
  sequence:
    - service: script.tts_play
      data:
        media_player: media_player.kiosk_media_player
        min_volume: 50
        quiet_play: true
        tts_service: tts.cloud_say
        gender: male
        language: en-GB
        message: >
          {% set temp = states('sensor.outdoor_temperature')|int(0) %}
          {% set app_temp = states('sensor.outdoor_apparent_temperature')|int(0) %}
          {% set high_temp = states('sensor.outdoor_high_temperature')|int(0) %}
          {% set app_high_temp = states('sensor.dark_sky_daytime_high_apparent_temperature_0d')|int(0) %}
          {% set low_temp = states('sensor.outdoor_low_temperature')|int(0) %}
          {% set app_low_temp = states('sensor.dark_sky_daytime_low_apparent_temperature_0d')|int(0) %}
          {% set normal_high_diff = states('sensor.outdoor_high_temperature_differential')|int('unknown') %}
          {% set normal_low_diff = states('sensor.outdoor_low_temperature_differential')|int('unknown') %}
          {% set show_normal_high = is_number(normal_high_diff) and -2 < normal_high_diff > 2 %}
          {% set show_normal_low = is_number(normal_low_diff) and  -2 < normal_low_diff > 2 %}
          {% set humidity = states('sensor.outdoor_humidity')|int(0) %}
          {% set humidty_today = states('sensor.outdoor_humidity_today')|int(0)  %}
          {% set pop = states('sensor.precipitation_probability_today')|int(0) %}
          {% set precip_type = states('sensor.precipitation_type') %}
          {% set precip_today = state_attr('weather.home_daily','forecast')[0]['precipitation']|int(0) %}
          {% set wind_max = states('sensor.wind_gust_today')|int(0) %}
          {% set wind_gust = states('sensor.wind_gust')|int(0) %}
          {% set current = states('sensor.dark_sky_summary')|replace('<',' less than ')|replace('>','greater than')|lower %}
          {% set minute_summary = states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than')|lower %}
          {% set hourly_summary = states('sensor.dark_sky_hourly_summary')[:-1]|replace('<',' less than ')|replace('>','greater than')|lower %}
          {% set daily_summary = states('sensor.dark_sky_daily_summary')|replace('<',' less than ')|replace('>','greater than')|lower %}
          {% set both_alerts = is_state('binary_sensor.envcan_weather_alert','on') and is_state('binary_sensor.noaa_weather_alert','on') %}
          {{ states('sensor.tod_greeting') }}!
          {%- if is_state('binary_sensor.envcan_weather_alert','on') %}
            {% set until = state_attr('binary_sensor.envcan_weather_alert','expires_text') %}
            Environment Canada has issued a {{ state_attr('binary_sensor.envcan_weather_alert','title') }}
            {{ ' until ' ~ until if until|lower not in ['unknown','unavailable','none'] }}.
          {%- endif %}
            {%- if is_state('binary_sensor.noaa_weather_alert','on') %}
            {% set until = state_attr('binary_sensor.noaa_weather_alert','ends_text') %}
            The National Weather Service has {{ 'also ' if both_alerts }}issued a {{ state_attr('binary_sensor.noaa_weather_alert','severity') }}
            {{- ' ' ~ state_attr('binary_sensor.noaa_weather_alert','title') }}
            {{- ' until ' ~ until if until|lower not in ['unknown','unavailable','none'] }}.
          {%- endif %}
          It is currently {{ temp }} {{ 'degree' if temp|int(0) == 1 else 'degrees' }}
          {%- if (temp - app_temp )|abs > 2 %}, but it feels more like {{ app_temp }}. It is
          {%- else %} and
          {%- endif %} {{ current }}, and will be {{ minute_summary }}
          {% if wind_gust > 15 -%}
            {%- if wind_gust > 50 -%} It's extremely windy out there
            {%- elif wind_gust > 40 -%} It's very windy at the moment
            {%- elif wind_gust > 35 -%} It's rather windy right now
            {%- elif wind_gust > 25 -%} It's starting to get a little windy
            {%- else -%} It's a little breezy out there
            {%- endif -%}
            , with gusts approaching {{ states('sensor.wind_condition_verbose') }}.
          {%- endif %}
          {%- if high_temp > states('input_number.outdoor_high_temperature_threshold')|int(0) %}
            It will be bloody hot
            {%- if humidty_today > 70 %} and humid today, with a humdity level around {{ humidty_today }} percent and
            {%- else %} today, with
            {%- endif %} a humidex topping {{ app_high_temp }} ball sweatin degrees.
            {% if show_normal_high %} That's {{ normal_high_diff }} {{ 'degree' if normal_high_diff|int(0) in [-1,1] else 'degrees' }} {{ 'lower' if normal_high_diff < 0 else 'higher' }} than normal!{% endif %}
            {%- if wind_max > 15 %} It will get {{ 'rather' if wind_max <  25 else 'very' }} windy with wind speeds approaching {{ wind_max }} kilometers per hour.{% endif %}
          {%- elif low_temp < states('input_number.outdoor_low_temperature_threshold')|int(0) %}
            Today will be friggin cold
            {%- if humidty_today > 70 %}{{ ' and' if wind_max <= 15 else ','}} damp {% endif %}
            {%- if wind_max > 15 %} and {{ 'rather' if wind_max <  25 else 'very' }} windy, with wind speeds topping {{ wind_max }} kilometers per hour and
            {%- else %}, with
            {%- endif %} a high of {{ high_temp }}, and a low of {{ low_temp }} {{ 'degree' if low_temp|int(0) in [-1,1] else 'degrees' }}.
            {% if show_normal_high %}Today's high temperature is about {{ normal_high_diff }} {{ 'degree' if normal_high_diff|int(0) in [-1,1] else 'degrees' }} {{ 'lower' if normal_high_diff < 0 else 'higher' }} than normal{% endif %}
            {%- if show_normal_high and show_normal_low %} and the {% elif show_normal_low %}Today's {% endif %}
            {%- if show_normal_low %}low will be {{ normal_low_diff }} {{ 'degree' if normal_low_diff|int(0) in [-1,1] else 'degrees' }} {{ 'lower' if normal_low_diff < 0 else 'higher' }}{% endif %}
            {%- if show_normal_high or show_normal_low %} than normal!{% endif %}
          {%- else %}
            Today's high temperature will be
            {%- if show_normal_high %} {{ normal_high_diff }} {{ 'degree' if normal_high_diff|int(0) in [-1,1] else 'degrees' }} {{ 'lower' if normal_high_diff < 0 else 'higher' }} than normal, with a high of {{ 'only ' if normal_high_diff <  0 }}{% endif %}
            {{- high_temp }} {{ 'degree' if high_temp|int(0) in [-1,1] else 'degrees' }}.
            The overnight low will be {{ low_temp }} {{ 'degree' if low_temp|int(0) in [-1,1] else 'degrees' }}
            {%- if show_normal_low %}, which will be {{ normal_low_diff }} {{ 'degree' if normal_low_diff|int(0) in [-1,1] else 'degrees' }} {{ 'lower' if normal_low_diff < 0 else 'higher' }} than normal{% endif %}.
          {%- endif %}
          {%- if wind_max > 15 %} It will get {{ 'rather' if wind_max <  25 else 'very' }} windy today, with wind speeds approaching {{ wind_max }} kilometers per hour.{% endif %}
          The current humidity level is {{ humidity }} percent and there
          {%- if pop  < 10 %} will be no {{ precip_type }} today
          {%- else %} is a {{ pop }} percent chance of {{ precip_type }} today
            {%- if precip_today|int > 0 %}, with expected {{ precip_type }}fall of about {{ precip_today }} mm.{%else %}.{% endif %}
            The current forecast is {{ hourly_summary }} with {{ daily_summary }}
          {%- endif %}
          {%- if states('sensor.current_uv_level')|lower in ['high','very high'] %}
            The current UV risk is {{ states('sensor.current_uv_level') -}}{%- endif %}
            {%- if states('sensor.uv_risk_today')|lower in ['high','very high'] -%}
            {{ ' and todays ' if states('sensor.current_uv_level')|lower in ['high','very high'] else ' Todays ' -}}
            forecasted UV risk is {{ states('sensor.uv_risk_today') -}}, so try to keep all you're pastey red-headed step children indoors
          {%- endif %}.
          {%- if not states('sensor.aqi_risk_level')|lower in ['good','unknown'] %}
            The current air quality index is {{ states('sensor.aqi_risk_level') }}.
          {%- endif -%}
          {%- if states('sensor.asthma_risk_today')|lower in ['medium-high','high'] %}
            Today's asthma risk is {{ states('sensor.asthma_risk_today') }}, so spark up another fag and char your lungs up some, you stupid wanckah!
          {%- endif %}
          {%- if states('sensor.allergy_risk_today')|lower in ['medium-high','high'] %}
            Get your snot rags ready because today's allergy risk is {{ states('sensor.allergy_risk_today') }}.
          {%- endif %}
          {%- if states('sensor.flu_risk_today')|lower in ['medium-high','high'] %}
            I suggest you mask up, hide in your basement, and avoid all contact with any other human beings, because today's cold and flu risk is {{ states('sensor.flu_risk_today') }}.
          {%- endif %}
          The sun will set this evening at {{ state_attr('sun.sun','next_setting')|as_timestamp|timestamp_custom('%-I:%M %p',true,none) -}}
          , and with any luck will rise tomorrow morning at {{state_attr('sun.sun','next_rising')|as_timestamp|timestamp_custom('%-I:%M %p',true,none) }}.
          Have a {{ ['peachy','great','fabulous']|random }} {{ 'day' if '05:00' < states('sensor.time') <= '12:00'
              else 'afternoon' if '12:00' < states('sensor.time') < '17:00' else 'night' }}!  Cheerio!
