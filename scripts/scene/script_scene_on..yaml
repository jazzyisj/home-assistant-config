###############################################################################
## Scene On
###############################################################################
scene_on:
  alias: "Scene On"
  description: "Turn on scene."
  icon: mdi:home-lightbulb-outline
  mode: restart
  fields:
    scene:
      description: "Scene name."
      example: "evening"
  variables:
    scenes: "{{ ['movie','chill','company'] }}"
  sequence:
    - if:
        - condition: state
          entity_id: input_select.occupancy_mode
          state:
            - Night
            - Away
            - Vacation
      then:
        - service: input_boolean.turn_off
          target:
            entity_id: "input_boolean.{{ scene }}_scene"

        - service: browser_mod.notification
          data:
            duration: 30000
            message: "Scenes cannot be turned on in Night or Away mode."
      else:
        - service: script.turn_off
          target:
            entity_id:
              - script.waketime
              - script.morning_lights
              - script.bedtime

        - repeat: # turn off other scenes
            count: "{{ scenes|count }}"
            sequence:
              - variables:
                  this_scene: "{{ scenes[repeat.index-1] }}"

              - if: "{{ scene != this_scene }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "input_boolean.{{ this_scene }}_scene"

        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.bedtime_delayed

        - service: script.activate_light_scene
          data:
            scene: "{{ scene }}"

        - if: "{{ is_state('input_boolean.media_preset_enabled_' ~ scene,'on') }}"
          then:
            - service: script.media_players_off
              data:
                ignore_players:
                  - media_player.office_tv
                  - media_player.bedroom_tv
                  - media_player.bedroom_hub

            - service: script.media_play
              data:
                preset: "{{ scene }}"

        - if: "{{ states('timer.' ~ scene ~ '_scene') in ['idle','active'] }}"
          then:
            - service: timer.start
              target:
                entity_id: timer.company_scene
              data:
                duration:
                  minutes: "{{ states('input_number.' ~ scene ~ '_scene_duration')|int(0) }}"
