###############################################################################
## Scene Off
###############################################################################
scene_off:
  alias: "Scene Off"
  description: "Turn off scene."
  icon: mdi:home-lightbulb-off-outline
  mode: restart
  fields:
    scene:
      description: "Scene name."
      example: "chill"
  sequence:
    - service: input_boolean.turn_off
      target:
        entity_id: "input_boolean.{{ scene }}_scene"

    - service: timer.cancel
      target:
        entity_id: "timer.{{ scene }}_scene"

    - condition: state
      entity_id: input_select.occupancy_mode
      match: any
      state:
        - Home
        - Guest

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.bedtime_delayed

    - if: "{{ is_state('input_boolean.media_preset_enabled_' ~ scene,'on') }}"
      then:
        - service: script.media_play
          data:
            preset: "{{ scene }}"

        - service: script.media_players_off
          data:
            entity_id: > #MASS turns of both reg and mass players
              {{ states.media_player
                |selectattr('name','eq',states('select.media_preset_speaker_' ~ scene))
                |map(attribute='entity_id')|list }}
