music:
  alias: music
  mode: single
  sequence:
    - variables:
        mass_players: >
          {% set kill_players = namespace(entity_id=[]) %}
          {% set mass_players = states.media_player
            |selectattr('attributes.group_members','defined')
            |selectattr('state','in',['playing','paused']) %}

          {% if mass_players|list|count > 0 %}
            {% for player in mass_players %}
              {% if player.entity_id|replace('mass_','') in state_attr('sensor.tts_media_player','entity_id') %}
                {% set kill_players.entity_id = kill_players.entity_id + [player.entity_id] %}
              {% endif %}
              {% for group_player in player.attributes.group_members %}
                {% if group_player.entity_id in state_attr('sensor.tts_media_player','entity_id') %}
                  {% set kill_players.entity_id = kill_players.entity_id + [player.entity_id] %}
                {% endif %}
              {% endfor %}
            {% endfor %}
          {% endif %}
          {{ kill_players.entity_id|unique|list }}

    - repeat:
        for_each: "{{ mass_players }}"
        sequence:
          - service: mass.queue_command
            target:
              entity_id: "{{ mass_players[repeat.index0] }}"
            data:
              command: snapshot_create

          - service: mass.queue_command
            target:
              entity_id: "{{ mass_players[repeat.index0] }}"
            data:
              command: play

    # - service: mass.queue_command
    #   data:
    #     command: play_media
    #     uri: spotify:playlist:37i9dQZF1DXb57FjYWz00c
    #     enqueue_mode: replace
    #   target:
    #     entity_id: media_player.mass_dining_room_hub

    # - delay: 15

    # - service: mass.queue_command
    #   target:
    #     entity_id: media_player.mass_dining_room_hub
    #   data:
    #     command: snapshot_create

    # - service: media_player.play_media
    #   target:
    #     entity_id: media_player.dining_room_hub
    #   data:
    #     media_content_id: "{{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/gentle.mp3' }}"
    #     media_content_type: music

    # - delay: 5

    # - service: mass.queue_command
    #   target:
    #     entity_id: media_player.mass_dining_room_hub
    #   data:
    #     command: snapshot_restore

    # - delay: 5

    # - service: mass.queue_command
    #   target:
    #     entity_id: media_player.dining_room_hub
    #   data:
    #     command: play
