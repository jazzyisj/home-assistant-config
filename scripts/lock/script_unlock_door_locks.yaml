###############################################################################
## UnLock Door Locks
###############################################################################
unlock_door_locks:
  alias: "Unlock Door Locks"
  description: "Unlock door locks."
  icon: mdi:lock-open
  mode: queued
  fields:
    entity_id:
      description: "Door locks to unlock."
      example: "lock.side_door_lock"
    code:
      description: "Door unlock code."
      example: "1111"
  variables:
    entity_id: "{{ entity_id|default(expand('group.door_locks')|map(attribute='entity_id')|list) }}"
    code: "{{ code|default(none) }}"
  sequence:
    - if:
        - condition: state
          entity_id: alarm_control_panel.house
          state:
            - disarmed
            - armed_home
      then:
        - repeat:
            while: >
              {{ expand(entity_id)|selectattr('state','eq','locked')
                  |map(attribute='entity_id')|list|count > 0 and repeat.index < 4 }}
            sequence:
              - if: "{{ code != none }}"
                then:
                  - service: lock.unlock
                    target:
                      entity_id: >
                        {{ expand(entity_id)|selectattr('state','eq','locked')
                            |map(attribute='entity_id')|list }}
                    data:
                      code: "{{ code }}"
                else:
                  - service: lock.unlock
                    target:
                      entity_id: >
                        {{ expand(entity_id)|selectattr('state','eq','locked')
                            |map(attribute='entity_id')|list }}

              - wait_template: >
                  {{ expand(entity_id)|selectattr('state','eq','locked')
                      |map(attribute='entity_id')|list|count == 0 }}
                timeout: 30

        - if: >
            {{ expand(entity_id)|selectattr('state','in',['unlocked','unknown','unavailable'])
                |map(attribute='entity_id')|list|count != 0 }}
          then:
            - service: input_boolean.turn_on
              target: # turn on malfunction boolean for any locks that didn't unlock
                entity_id: >
                  {{ expand(entity_id)|selectattr('state','in',['locked','unknown','unavailable'])
                      |map(attribute='entity_id')|list|replace('lock.','input_boolean.')
                      |replace('_door_lock','_door_lock_malfunction') }}
      else:
        - service: script.tts_play
          data:
            message: "Doors cannot be unlocked while the house alarm is armed!  Disarm the alarm and try again."
            quiet_play: true
            ignore_away: true
