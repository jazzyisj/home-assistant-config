###############################################################################
## Garage Climate On
###############################################################################
garage_climate_on:
  alias: '[Garage Climate] On'
  description: 'Turn on garage heat.'
  icon: mdi:thermostat-box
  mode: restart
  sequence:
    # only run on if freeze protection or heat is on
    - or:
        - condition: state
          entity_id: input_boolean.garage_freeze_protection
          state: 'on'

        - condition: state
          entity_id: input_boolean.garage_heat
          state: 'on'

    # turn off garage thermostat automation to avoid recursive calls
    - service: automation.turn_off
      target:
        entity_id: automation.garage_climate_thermostat_adjusted

    # turn garage heat on
    - service: climate.set_operation_mode
      target:
        entity_id: climate.garage_thermostat
      data:
        operation_mode: 'heat'

    # set either freeze or heat temperature
    # set to heat temp if heat on else set to freeze protection temp
    - service: climate.set_temperature
      target:
        entity_id: climate.garage_thermostat
      data:
        temperature: >
          {% if is_state('input_boolean.garage_heat','on') %}
            {{ states('input_number.garage_heat_temperature')|int(0) }}
          {% else %}
            {{ states('input_number.garage_freeze_temperature')|int(0) }}
          {% endif %}

    # wait for heat to turn on before turning climate state automation back on
    - wait_template: "{{ is_state('climate.garage_thermostat','heat') }}"
      timeout:
        minutes: 1

    # turn garage thermostat automation back on
    - service: automation.turn_on
      target:
        entity_id: automation.garage_climate_thermostat_adjusted

###############################################################################
## Garage Climate Off
###############################################################################
garage_climate_off:
  alias: '[Garage Climate] Off'
  description: 'Turn off garage heat.'
  icon: mdi:thermostat-box
  mode: restart
  sequence:
    # set temperature to freeze protection temp if on or leave it at current setting
    - service: climate.set_temperature
      target:
        entity_id: climate.garage_thermostat
      data:
        temperature: >
          {% if is_state('input_boolean.garage_freeze_protection','on') %}
            {{ states('input_number.garage_freeze_temperature')|int }}
          {% else %}
            {{ state_attr('climate.garage_thermostat','temperature')|float(none) }}
          {% endif %}

    - wait_template:
        > # wait for thermostat temp = freeze temp if freeze protection on
        {% if is_state('input_boolean.garage_freeze_protection','on') %}
          {{ '%0.1f'|format(states('input_number.garage_freeze_temperature')|float)|float
              == '%0.1f'|format(state_attr('climate.garage_thermostat','temperature')|float(none))|float(none) }}
        {% else %}
          true
        {% endif %}
      timeout:
        minutes: 2

    - or:
        - condition: state
          entity_id: input_boolean.garage_freeze_protection
          state: 'off'

        - condition: state
          entity_id: binary_sensor.garage_door_open
          state: 'on'

    # turn off garage thermostat automation to avoid recursive calls
    - service: automation.turn_off
      target:
        entity_id: automation.garage_climate_thermostat_adjusted

    - service: climate.set_operation_mode
      target:
        entity_id: climate.garage_thermostat
      data:
        operation_mode: 'off'

    # wait for heat to turn off before turning climate state automation back on
    - wait_template: "{{ is_state('climate.garage_thermostat','off') }}"
      timeout:
        minutes: 1

    # turn garage thermostat automation back on
    - service: automation.turn_on
      target:
        entity_id: automation.garage_climate_thermostat_adjusted
