#######################################################################################################################
## Spotify Play
#######################################################################################################################
spotify_play:
  alias: Spotify Play
  description: Play spotify playlist.
  icon: mdi:spotify
  mode: single
  fields:
    preset:
      description: Called by preset
      example: sleep
    playlist:
      description: Spotify Playlist
      example: Shower Songs
    media_player:
      description: Playback media player name.
      example: Dining Room Speaker
    volume:
      description: Playback volume in percent.
      example: 50
    random:
      description: Random playback.
      example: true
    shuffle:
      description: Shuffle playback.
      example: true
    repeat:
      description: Repeat playback.
      example: true
  variables:
    playlist: >
      {% if preset == 'wake' %}{{ states('input_select.media_preset_spotify_wake') }}
      {% elif preset == 'morning' %}{{ states('input_select.media_preset_spotify_morning') }}
      {% elif preset == 'sleep' %}{{ states('input_select.media_preset_spotify_sleep') }}
      {% elif preset == 'jason' %}{{ states('input_select.media_preset_spotify_jason') }}
      {% elif preset == 'sheri' %}{{ states('input_select.media_preset_spotify_sheri') }}
      {% elif preset == 'shower' %}{{ states('input_select.media_preset_spotify_shower') }}
      {% elif preset == 'company' %}{{ states('input_select.media_preset_spotify_company') }}
      {% else %}{{ playlist }}
      {% endif %}
    media_player: >
      {% if preset == 'wake' %}{{ states('input_select.media_preset_speaker_wake') }}
      {% elif preset == 'morning' %}{{ states('input_select.media_preset_speaker_morning') }}
      {% elif preset == 'sleep' %}{{ states('input_select.media_preset_speaker_sleep') }}
      {% elif preset == 'jason' %}{{ states('input_select.media_preset_speaker_jason') }}
      {% elif preset == 'sheri' %}{{ states('input_select.media_preset_speaker_sheri') }}
      {% elif preset == 'shower' %}{{ states('input_select.media_preset_speaker_shower') }}
      {% elif preset == 'company' %}{{ states('input_select.media_preset_speaker_company') }}
      {% else %}{{ media_player }}
      {% endif %}
    volume: >
      {% set qvol = states('input_number.media_volume_quiet')|int %}
      {% if preset == 'wake' %}{% set vol = states('input_number.media_preset_volume_wake')|int %}
      {% elif preset == 'morning' %}{% set vol = states('input_number.media_preset_volume_morning')|int %}
      {% elif preset == 'sleep' %}{% set vol = states('input_number.media_preset_volume_sleep')|int %}
      {% elif preset == 'jason' %}{% set vol = states('input_number.media_preset_volume_jason')|int %}
      {% elif preset == 'sheri' %}{% set vol = states('input_number.media_preset_volume_sheri')|int %}
      {% elif preset == 'shower' %}{% set vol = states('input_number.media_preset_volume_shower')|int %}
      {% elif preset == 'company' %}{% set vol = states('input_number.media_preset_volume_company')|int %}
      {% else %}{% set vol = volume if volume != empty else states('input_number.spotify_volume')|int %}
      {% endif %}
      {{ qvol if (is_state('binary_sensor.quiet_hours','on') and vol > qvol) and is_state('input_boolean.volume_override','off') else vol }}
  sequence:
    - service: spotcast.start
      data:
        device_name: >
          {% if media_player == empty and states('sensor.spotify_media_player') == '' %}{{ states('input_select.spotify_media_player') }}
          {% elif not media_player == empty %}{{ media_player }}
          {% elif not states('sensor.spotify_media_player') == '' %}{{ states('sensor.spotify_spotcast_device') }}
          {% endif %}
        uri: >
          {% set pl = playlist if playlist != empty else states('input_select.spotify_plalist') %}
          {% if pl == 'Shower Songs' %} spotify:playlist:37i9dQZF1DWSqmBTGDYngZ
          {% elif pl == 'All Out 60s' %} spotify:playlist:37i9dQZF1DXaKIA8E7WcJj
          {% elif pl == 'All Out 80s' %} spotify:playlist:37i9dQZF1DX4UtSsGT1Sbe
          {% endif %}
        random_song: "{{ random if random != empty else is_state('input_boolean.spotify_random','on') }}"
        repeat: "{{ repeat if repeat != empty else is_state('input_boolean.spotify_repeat','on') }}"
        shuffle: "{{ shuffle if shuffle != empty else is_state('input_boolean.spotify_shuffle','on') }}"
        force_playback: true
        start_volume: "{{ volume|float }}"