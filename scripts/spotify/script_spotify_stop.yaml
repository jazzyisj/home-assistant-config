######################################################################################################################
# Spotify Stop
######################################################################################################################
spotify_stop:
  alias: Spotify Stop
  description: Turn off spotify media players, reset volumes.
  mode: single
  #max_exceeded: silent
  variables:
    player: "{{ states('input_text.active_media_player_spotify') }}"
  sequence:
    # make sure spotify play script is stopped
    - service: script.turn_off
      entity_id: script.spotify_play

    # turn boolean off to keep in sync if called from script
    - service: input_boolean.turn_off
      entity_id: input_boolean.spotify_on

    - service: input_text.set_value
      data:
        entity_id: input_text.active_media_player_spotify
        value: cleared

    # spotify player already stopped
    - condition: template
      value_template: "{{ player != '' }}"

    #NOTE spotify/broswer/chromecast don't turn off so stop play first
    - choose:
      - conditions: "{{ is_state(player,'playing') }}"
        sequence:
          - service: media_player.media_stop
            data:
              entity_id: "{{ player }}"

    # turn off spotify media players
    - service: media_player.turn_off
      data:
        entity_id: "{{ player }}"

    - service: script.turn_on
      data:
        entity_id: script.set_media_player_volumes
        variables:
          media_player: "{{ player }}"
          source: spotify_off