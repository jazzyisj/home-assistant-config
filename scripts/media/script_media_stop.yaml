###############################################################################
## Media Stop
###############################################################################
media_stop:
  alias: 'Media Stop'
  description: 'Turn off media players, reset volumes.'
  mode: parallel
  fields:
    media_type:
      description: 'Media type to stop.'
      example: 'radio'
  variables:
    media_types: "{{ state_attr('sensor.media_types','media_types')|default([]) }}"
    media_type: "{{ media_type|default('all') }}"
    media_player: "{{ states('sensor.' ~ media_type ~ '_media_player') }}"
    media_players: >
      {% if media_type in media_types %}
        {% set media_player = states('sensor.' ~ media_type ~ '_media_player') %}
        {% set active_players = namespace(entity_id=[]) %}
        {% for type in media_types if type != media_type %}
          {% if is_state('binary_sensor.' ~ type,'on') %}
            {% set active_players.entity_id = active_players.entity_id
                + state_attr('sensor.' ~ type ~ '_media_player','entity_id') %}
          {% endif %}
        {% endfor %}
        {% if media_player|lower not in ['','unknown','unavailable'] %}
          {% if active_players.entity_id == [media_player] %} []
          {% else %}
            {{ expand(state_attr('sensor.' ~ media_player.split('.')[1],'entity_id'))
                |rejectattr('entity_id','in',state_attr('sensor.alarm_clock_media_player','entity_id')|default([]))
                |rejectattr('entity_id','in',active_players.entity_id)|map(attribute='entity_id')|list
              if is_state_attr(media_player,'type','group') else [media_player] }}
          {% endif %}
        {% endif %}
      {% else %}
        {{ media_players|default(state_attr('group.media_play_media_players','entity_id')) }}
      {% endif %}
  sequence:
    - if: >
        {{ (media_type == 'all'
            or states('input_select.media_preset_type_sleep')|slugify)
            and not is_state('timer.media_preset_sleep','idle') }}
      then:
        - service: timer.cancel
          target:
            entity_id: timer.media_preset_sleep

    - service: input_boolean.turn_off
      target:
        entity_id: >
          {% set items = namespace(value=[]) %}
          {% if media_type == 'all' %}
            {% for item in media_types %}
              {% set items.value = items.value + ['input_boolean.' ~ media_types[loop.index0],
                  'input_boolean.resume_' ~ media_types[loop.index0]] %}
            {% endfor %}
          {% else %}
            {% set items.value = ['input_boolean.' ~ media_type,'input_boolean.resume_' ~ media_type] %}
          {% endif %}
          {{ items.value }}

    - service: input_text.set_value # clear active media player value
      target:
        entity_id: >
          {% set items = namespace(value=[]) %}
          {% if media_type == 'all' %}
            {% for item in media_types %}
              {% set items.value = items.value + ['input_text.active_' ~ media_types[loop.index0] ~ '_media_player'] %}
            {% endfor %}
          {% else %} {% set items.value = 'input_text.active_' ~ media_type ~ '_media_player' %}
          {% endif %}
          {{ items.value }}
      data:
        value: 'off'

    - if:
        - condition: template
          alias: 'Target media players are an active tts clock media player'
          value_template: >
            {% if is_state('binary_sensor.tts','on') %}
              {% set tts_player = states('sensor.tts_media_player') %}
              {% set tts_players = state_attr('sensor.tts_media_player','entity_id') %}
              {% set found = namespace(value=0) %}
              {% if is_state_attr(media_player,'type','group') %}
                {% for pitem in media_players %}
                  {% if is_state_attr(tts_player,'type','group') %}
                    {% for item in tts_players %}{% if item == pitem %}{% set found.value = 1 %}{% endif %}{% endfor %}
                  {% elif pitem == tts_player %}
                    {% set found.value = 1 %}
                  {% endif %}
                {% endfor %}
              {% else %}
                {% if is_state_attr(tts_player,'type','group') %}
                  {% for item in tts_players %}{% if item == pitem %}{% set found.value = 1 %}{% endif %}{% endfor %}
                {% elif item == media_player %}
                  {% set found.value = 1 %}
                {% endif %}
              {% endif %}
              {{ found.value == 0 }}
            {% else %} false
            {% endif %}
      then:
        # wait for tts to finish so we don't turn off tts players
        - wait_template: "{{ is_state('binary_sensor.tts','off') }}"
          timeout: 120

    - variables:
        on_players: >
          {{ expand(media_players)|selectattr('state','in',['idle','home','on','playing','paused'])
              |map(attribute='entity_id')|list }}

    - if: '{{ on_players|count > 0 }}'
      then:
        - service: automation.turn_off
          target:
            entity_id: automation.media_turned_off
          data:
            stop_actions: false

        - service: script.media_players_off
          data:
            entity_id: '{{ on_players }}'

        - service: automation.turn_on
          target:
            entity_id: automation.media_turned_off

    # keep script on until all players off/idle (browser, vlc stay idle)
    - wait_template: "{{ expand(media_players)|selectattr('state','in',['idle','playing','paused'])|list|count == 0 }}"
      timeout: 5

    - if: '{{ media_players|count > 0 }}'
      then:
        - service: script.media_players_set_volumes
          data:
            entity_id: '{{ media_players }}'
            source: "{{ 'reset' if media_type == 'all' else media_type }}"
