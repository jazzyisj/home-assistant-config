###############################################################################
## Media Preset Play
###############################################################################
media_preset_play:
  alias: "Media Preset Play"
  description: "Turn on media preset."
  mode: queued
  fields:
    preset:
      description: "Media preset to turn on."
      example: "sleep"
  variables:
    media_player: >
      {{ expand('group.media_players')
          |selectattr('name','eq',states('select.media_preset_speaker_' ~ preset))
          |map(attribute='entity_id')|join('') }}
  sequence:
    - if:
        - condition: state
          entity_id: switch.system_mute
          state: "on"
      then:
        - service: browser_mod.notification
          data:
            message: "Media preset cannot not be played. System is muted."
      else:
        # cancel sleep timer if active and not sleep preset
        - if: "{{ preset != 'sleep' and not is_state('timer.media_preset_sleep','idle') }}"
          then:
            - service: timer.cancel
              target:
                entity_id: timer.media_preset_sleep

        #TODO set media player volume here

        # - service: input_number.set_value
        #   target:
        #     entity_id: 'input_number.{{ media_type }}_volume'
        #   data:
        #     value: "{{ states('input_number.media_preset_volume_' ~ preset)|float }}"

        # - service: mass.queue_command
        #   target:
        #     entity_id: "{{ media_player }}"
        #   data:
        #     command: play_media
        #     uri: spotify:playlist:37i9dQZF1DXb57FjYWz00c #MASS #TODO
        #     enqueue_mode: replace
        #     repeat_mode: all

        - wait_template: "{{ is_state(media_player,'playing') }}"
          timeout: 30 # wait for media to start play
          continue_on_timeout: false # don't start timers if media doesn't play

        # if sleep preset and sleep timer is idle start timer
        - if: "{{ preset == 'sleep' and is_state('timer.media_preset_sleep','idle') }}"
          then:
            - service: timer.start
              target:
                entity_id: timer.media_preset_sleep
              data:
                duration:
                  minutes: "{{ states('input_number.media_preset_sleep_time')|int(0) }}"
