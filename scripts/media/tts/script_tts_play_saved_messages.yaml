###############################################################################
# Play Saved Messages
###############################################################################
tts_play_saved_messages:
  alias: "TTS Play Saved Messages"
  description: "Play stored TTS messages."
  max_exceeded: silent
  fields:
    skip_none:
      description: "Skip no saved messages announcement."
      example: "true"
  variables:
    skip_none: "{{ skip_none|default(true) }}"
    msgs: "{{ states('variable.tts_saved_messages')|int(-1) }}"
  sequence:
    - condition: template
      alias: "Message count > 0 if skip_none"
      value_template: "{{ msgs > 0 if skip_none else true }}"

    - service: script.tts_play
      continue_on_error: true
      data:
        message: >
          There {{ 'are no messages' if msgs == 0 else 'is 1 message'
            if msgs == 1 else 'are ' ~ msgs ~ ' messages' }} waiting for you.
        quiet_play: "{{ true if msgs > 0 else false }}"
        night_play: "{{ true if msgs > 0 else false }}"
        ignore_away: true

    - if: "{{ msgs > 0 }}"
      then:
        - repeat:
            count: "{{ msgs }}"
            sequence:
              - service: script.tts_play
                continue_on_error: true
                data:
                  message: >
                    {% set msg = state_attr('variable.tts_saved_messages','msg' ~ repeat.index) %}
                    {{ iif(msg != none,msg,'Error') }}
                    {% set date = state_attr('variable.tts_saved_messages','msg_ts' ~ repeat.index) %}
                    {% if date != none %}
                      {% set date = date|as_datetime %}
                      {% if now().day == date.day %} Today at {{ date.strftime('%-I:%M %p') }}
                      {% elif now().day - date.day == 1 %} Yesterday at {{ date.strftime('%-I:%M %p') }}
                      {% elif now().day - date.day > 6 %} {{ date.strftime('%A, %B %-d at %-I:%M %p') }}
                      {% else %} {{ date.strftime('%A at %-I:%M %p') }}
                      {% endif %}
                    {% endif %}
                  quiet_play: true
                  night_play: true
                  ignore_away: true

    # erase saved messages
    - service: variable.set_variable
      data:
        variable: tts_saved_messages
        value: "0"
        replace_attributes: true
