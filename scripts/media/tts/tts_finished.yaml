###############################################################################
## TTS Finished
###############################################################################
tts_finished:
  alias: "TTS Finished"
  description: "Finish TTS message queue."
  variables:
    tts_players: "{{ states('input_text.tts_active_players').split(', ') | list }}"
  sequence:
    # only turn off if tts not muted, no resume
    - if:
        - condition: state
          entity_id: input_boolean.tts_muted
          state: "off"
      then:
        - service: script.media_player_set_volumes
          data: #MASS restore snapshot does not restore volume????
            source: tts_off
          continue_on_error: true

        - service: script.turn_media_player_off # turn off prevent play wrong player
          data:
            entity_id: "{{ tts_players }}"
            reset_volume: false
          continue_on_error: true

    # reset tts booleans
    - service: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.tts
          - input_boolean.tts_muted

    # clear active tts
    - service: input_text.set_value
      target:
        entity_id:
          - input_text.tts_active_media_player
          - input_text.tts_active_players
      data:
        value: ""
