#######################################################################################################################
## Spotify Play
#######################################################################################################################
spotify_play:
  alias: "Spotify Play"
  description: "Play Spotify media."
  icon: mdi:spotify
  max_exceeded: error
  fields:
    device:
      description: "Spotify cast device to play on."
      example: "Dining Room Display"
    playlist:
      description: "Spotify playlist to play."
      example: "Mega Hit Mix"
    repeat:
      description: "Repeat playlist."
      example: "false"
    random:
      description: "Start playlist on random song."
      example: "false"
    shuffle:
      description: "Shuffle playlist"
      example: "false"
    resume:
      description: "Resume media play option."
      example: "playlist"
  variables:
    account: "{{ states('input_select.spotify_account')|lower }}"
    spaccount: >
      {% set acct =  states('input_select.spotify_account')|lower %}
      {% if acct == 'jason' %} jazzyisj
      {% elif acct == 'sheri' %} sherigagnon
      {% else %} {{ acct }}
      {% endif %}
    device: >
      {% if device not in ['',empty] %}{{ device }}
      {% elif account == 'hassio' %}{{ states('input_select.spotify_media_player') }}
      {% else %}{{ states('input_select.spotify_' ~ account ~ '_media_player') }}
      {% endif %}
    playlist: >
      {% if playlist not in ['',empty] %}{% set plist = playlist %}
      {% else %}
        {% if account == 'hassio' %}{% set plist = states('input_select.spotify_playlist') %}
        {% else %}{% set plist = states('input_select.spotify_' ~ account ~ '_playlist') %}
        {% endif %}
      {% endif %}
      {{ plist }}

#ISSUE spotify playing not a saved playlist, resumes on default playlist after tts
#QUESTION is there a way grab playlist id with a name?
    uri: >
      {% set plist = 'sensor.playlists_sensor' if account == 'hassio'
          else 'sensor.playlists_sensor_' ~ account %}
      {% for item in state_attr((plist),'playlists') -%}
        {% if item.name == playlist %}
          {{ item.uri }}
        {% endif %}
      {% endfor %}
    repeat: "{{ repeat|default(is_state('input_boolean.spotify_repeat','on')) }}"
    random: "{{ random|default(is_state('input_boolean.spotify_random','on')) }}"
    shuffle: "{{ shuffle|default(is_state('input_boolean.spotify_shuffle','on')) }}"
    resume: "{{ resume|default(false) }}"
  sequence:
    - choose:
        - conditions: "{{ resume == 'playlist' }}" # playlist change
          sequence:
            - service: spotcast.start
              data:
                account: "{{ spaccount }}"
                device_name: "{{ device }}"
                uri: "{{ uri }}"
                random_song: "{{ random }}"
                repeat: "{{ repeat }}"
                shuffle: "{{ shuffle }}"
                ignore_fully_played: true
                force_playback: true

        - conditions: "{{ resume != false }}" # any other resume
          sequence:
            - service: spotcast.start
              data:
                account: "{{ spaccount }}"
                device_name: "{{ device }}"
                random_song: "{{ random }}"
                repeat: "{{ repeat }}"
                shuffle: "{{ shuffle }}"
                ignore_fully_played: true
                force_playback: true
      default:
        - service: spotcast.start
          data:
            account: "{{ spaccount }}"
            device_name: "{{ device }}"
            uri: "{{ uri }}"
            random_song: "{{ random }}"
            repeat: "{{ repeat }}"
            shuffle: "{{ shuffle }}"
            ignore_fully_played: true
            force_playback: true
