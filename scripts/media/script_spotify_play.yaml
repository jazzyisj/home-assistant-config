###############################################################################
## Spotify Play
###############################################################################
spotify_play:
  alias: 'Spotify Play'
  description: 'Play Spotify media.'
  icon: mdi:spotify
  max_exceeded: error
  fields:
    account:
      description: 'Account to play Spotify with.'
      example: 'hassio'
    device:
      description: 'Spotify cast device to play on.'
      example: 'Dining Room Hub'
    playlist:
      description: 'Spotify playlist to play.'
      example: 'Mega Hit Mix'
    repeat:
      description: 'Repeat playlist.'
      example: 'false'
    random:
      description: 'Start playlist on random song.'
      example: 'false'
    shuffle:
      description: 'Shuffle playlist'
      example: 'false'
    resume:
      description: 'Resume media play option.'
      example: 'playlist'
  variables:
    account: "{{ account|default('hassio') }}"
    repeat: "{{ repeat|default(is_state('input_boolean.spotify_repeat','on')) }}"
    random: "{{ random|default(is_state('input_boolean.spotify_random','on')) }}"
    shuffle: "{{ shuffle|default(is_state('input_boolean.spotify_shuffle','on')) }}"
    resume: '{{ resume|default(false) }}'
    spaccount: > #{{ account|default('hassio') }}
      {% if account == 'jason' %} jazzyisj
      {% elif account == 'sheri' %} sherigagnon
      {% else %} hassio
      {% endif %}
    device: "{{ device|default(states('input_select.spotify_' ~ account ~ '_media_player')) }}"
    plist: >
      {% if account == 'hassio' %}{% set plist = states('input_select.spotify_hassio_playlist') %}
      {% else %}{% set plist = states('input_select.spotify_' ~ account ~ '_playlist') %}
      {% endif %}
      {{ playlist|default(plist) }}
    uri: >
      {% set plist_sensor = 'sensor.playlists_sensor' if account == 'hassio'
          else 'sensor.playlists_sensor_' ~ account %}
      {% for item in state_attr((plist_sensor),'playlists') -%}
        {% if item.name == plist %}
          {{ item.uri }}
        {% endif %}
      {% endfor %}
  sequence:
    - choose:
        # playlist change, alarm clock may have changed playlist
        - conditions: "{{ resume in ['playlist','alarm_clock'] }}"
          sequence:
            - service: spotcast.start
              data:
                account: '{{ spaccount }}'
                device_name: '{{ device }}'
                uri: '{{ uri }}'
                random_song: '{{ random }}'
                shuffle: '{{ shuffle }}'
                ignore_fully_played: true
                force_playback: true

        - conditions: '{{ resume != false }}' # any other resume
          sequence:
            - service: spotcast.start
              data:
                account: '{{ spaccount }}'
                device_name: '{{ device }}'
                shuffle: '{{ shuffle }}'
                ignore_fully_played: true
                force_playback: true
      default:
        - service: spotcast.start
          data:
            account: '{{ spaccount }}'
            device_name: '{{ device }}'
            uri: '{{ uri }}'
            random_song: '{{ random }}'
            # repeat: '{{ repeat }}' #ISSUE - 'Invalid state' #WARNING (SyncWorker_29) [spotipy.client] Invalid state
            shuffle: '{{ shuffle }}'
            ignore_fully_played: true
            force_playback: true
