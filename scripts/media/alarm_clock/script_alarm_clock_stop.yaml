#######################################################################################################################
## Alarm Clock Stop
#######################################################################################################################
alarm_clock_stop:
  alias: Alarm Clock Stop
  description: Turn off and reset alarm clock.
  icon: mdi:alarm-note-off
  max_exceeded: silent
  fields:
    reset_volume:
      description: Reset media player volumes. (false for mute all - turns mute off)
      example: 'false'
  variables:
    reset_volume: "{{ reset_volume|default(true) }}"
  sequence:
    - service: script.turn_off # must turn off - might be running in sound loop
      entity_id: script.alarm_clock_sound_play

    - service: timer.cancel
      entity_id:
        - timer.alarm_clock_snooze
        - timer.alarm_clock_nap

    - service: script.alarm_clock_active_media_player_off

    - choose:
        - conditions: "{{ reset_volume }}"
          sequence:
            - service: script.set_media_player_volumes
              data:
                source: alarm_clock_off

    # turn off at end so binary_sensor.alarm_clock doesn't turn off and resume media before we're done
    - service: switch.turn_off
      entity_id:
        - switch.alarm_clock_auto
        - switch.alarm_clock_manual
        - switch.alarm_clock_nap
        - switch.alarm_clock_snooze

    - service: automation.turn_off
      entity_id: automation.alarm_clock_off

    - service: input_boolean.turn_off
      entity_id:
        - input_boolean.alarm_clock_nap
        - input_boolean.resume_alarm_clock
        - input_boolean.alarm_clock_test_play

    - service: input_text.set_value
      target:
        entity_id: input_text.active_alarm_clock_media_player
      data:
        value: ''

    - service: automation.turn_on
      entity_id:
        - automation.alarm_clock_off
        - automation.alarm_clock_media_player_turned_off # req if alarm failed
        - automation.alarm_clock_media_player_paused # req if alarm failed
