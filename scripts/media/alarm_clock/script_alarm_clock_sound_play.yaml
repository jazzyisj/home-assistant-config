###############################################################################
## Alarm Clock Sound Play
###############################################################################
alarm_clock_sound_play:
  alias: 'Alarm Clock Sound Play'
  description: 'Play alarm clock sound.'
  mode: restart
  fields:
    media_player:
      description: 'Alarm clock media player.'
      example: 'media_player.dining_room_hub'
    playlist:
      description: 'Alarm clock sound.'
      example: 'Gentle'
  variables:
    #NOTE if alarm triggers on startup before playlist sensor are populated media_type in alarm_clock_play defaults to sound
    # becuase the playlist select has not been populated and playlist will be null - default to digital here
    media_url: >
      {% if playlist == 'Rooster' %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/rooster.mp3' }}
      {% elif playlist == 'Loud' %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/loud.mp3' }}
      {% elif playlist == 'Pager' %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/pager.mp3' }}
      {% elif playlist == 'Digital' %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/digital.mp3' }}
      {% elif playlist == 'Gentle' %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/gentle.mp3' }}
      {% else %} {{ states('input_text.base_url') ~ '/local/alarm_clock_sounds/digital.mp3' }}
      {% endif %}
  sequence:
    #QUESTION this doesn't work
    # - service: media_player.repeat_set
    #   target:
    #     entity_id: '{{ media_player }}'
    #   data:
    #     repeat: all

    - repeat:
        sequence:
          - service: media_player.play_media
            target:
              entity_id: '{{ media_player }}'
            data:
              media_content_id: '{{ media_url }}'
              media_content_type: music
              extra:
                title: '{{ playlist }}'
                thumb: "{{ states('input_text.base_url') ~ '/local/images/media/alarm_clock.png' }}"
                #ISSUE thumb images not working on Nest Hub displays

          - wait_template: "{{ is_state(media_player,'playing') }}"
            timeout:
              seconds: 60

          - choose: # alarm clock sound did not play
              - conditions: "{{ not is_state(media_player,'playing') }}"
                sequence:
                  - service: input_boolean.turn_on
                    entity_id: input_boolean.alarm_clock_failed
            default:
              - choose:
                  - conditions: '{{ repeat.first }}'
                    sequence:
                      - service: input_text.set_value
                        target:
                          entity_id: input_text.active_alarm_clock_media_player
                        data:
                          value: '{{ media_player }}'

              #NOTE if media_duration doesn't register use default 30 seconds
              - wait_template: >
                  {{ is_state('binary_sensor.alarm_clock','off')
                      or is_state('switch.alarm_clock_snooze','on')
                      or is_state('input_boolean.resume_alarm_clock','on') }}
                timeout:
                  > # media_player must start playing first to get media_duration for delay
                  {% set sec = state_attr(media_player,'media_duration')|int(0) %}
                  {{ 30 if sec == 0 else sec }}
        until:
          - or:
              - condition: state
                entity_id: binary_sensor.alarm_clock
                state: 'off'

              - condition: state
                entity_id: switch.alarm_clock_snooze
                state: 'on'

              - condition: state
                entity_id: input_boolean.resume_alarm_clock
                state: 'on'
