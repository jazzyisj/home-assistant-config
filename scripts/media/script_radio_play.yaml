#######################################################################################################################
## Radio Play
#######################################################################################################################
radio_play:
  alias: 'Radio Play'
  description: 'Play streaming radio.'
  icon: mdi:radio
  max_exceeded: error
  fields:
    playlist:
      description: 'Radio station playlist to play.'
      example: 'Flex 98.5 - Hip Hop'
    media_player:
      description: 'Media player to play radio on.'
      example: 'media_player.dining_room_display'
    title:
      description: 'Title of radio station.'
      example: 'Flex 98.5 - Hip Hop'
    thumb:
      description: 'Thumbnail URL of radio station.'
      example: 'https://media.live365.com/download/a255d860-3c9d-4aad-8a6c-867e082b1861.jpeg'
  variables:
    playlist: "{{ playlist|default(states('input_select.radio_playlist')) }}"
    media_player: "{{ media_player|default(states('sensor.radio_media_player')) }}"
    content_id: >
      {% for item in state_attr('sensor.streaming_radio_stations','stations') -%}
        {% if playlist == item.name %}{{ item.url }}{% endif %}
      {% endfor %}
    title: "{{ title if title not in ['',empty] else playlist }}"
    thumb: > #TODO image not working on nest hubs
      {% if thumb not in ['',empty] %}{{ thumb }}
      {% else %}
        {% set img = namespace(url='') %}
        {% for item in state_attr('sensor.streaming_radio_stations','stations') -%}
          {% if is_state('input_select.radio_playlist',item.name) %}
            {% set img.url = item.image_url %}
          {% else %}
          {% endif %}
        {% endfor %}
        {{ img.url if img.url != '' else states('input_text.base_url') ~ '/local/images/media/radio.png' }}
      {% endif %}
  sequence:
    - service: media_player.play_media
      target:
        entity_id: '{{ media_player }}'
      data:
        media_content_id: '{{ content_id }}'
        media_content_type: music
        extra:
          title: '{{ title }}'
          thumb: '{{ thumb }}'

    #RADIO until streaming radio media player
    - wait_template: "{{ is_state(media_player,'playing') }}"
      timeout: 15
      continue_on_timeout: false

    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.radio
