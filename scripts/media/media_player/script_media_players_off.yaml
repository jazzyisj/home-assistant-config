###############################################################################
## Media Players Off
###############################################################################
media_players_off:
  alias: 'Media Players Off'
  description: 'Turn off media, stop/turn off media players.'
  mode: parallel
  fields:
    media_players:
      description: 'Media players to turn off'
      example: 'media_player.dining_room_hub'
  variables:
    media_players: >
      {% set media_players = media_players|default(state_attr('group.media_players','entity_id')) %}
      {% if not (media_players is iterable and (media_players is not string and media_players is not mapping)) %}
        {% set media_players = [media_players] %}
      {% endif %}
      {{ media_players }}
  sequence:
    - choose:
        - conditions: '{{ media_players|count > 0 }}'
          sequence:
            - variables:
                players_off: >
                  {{ expand(media_players)|selectattr('state','in',['on','home','idle','playing','paused','idle'])
                      |map(attribute='entity_id')|list }}

            - choose:
                - conditions: '{{ players_off|count > 0 }}'
                  sequence:
                    - service: media_player.turn_off
                      target:
                        entity_id: '{{ players_off }}'

            - wait_template: >
                {{ expand(players_off)|selectattr('state','in',['on','home','idle','playing','paused'])
                    |map(attribute='entity_id')|list|count == 0 }}
              timeout: # let players to turn off
                seconds: 2

            - variables:
                players_stop: >
                  {{ expand(players_off)|selectattr('state','in',['playing','paused'])
                      |map(attribute='entity_id')|list }}

            - choose: # stop players (req for vlc, browser players)
                - conditions: '{{ players_stop|count > 0 }}'
                  sequence:
                    - service: media_player.media_stop
                      target:
                        entity_id: '{{ players_stop }}'

    # keep script on until all off
    # don't include idle,standby state - spotify, vlc, browser players always idle, roku - standby
    - wait_template: >
        {{ expand(media_players)|selectattr('state','in',['on','home','playing','paused'])
            |map(attribute='entity_id')|list|count == 0 }}
      timeout: 5
