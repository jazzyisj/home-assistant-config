###############################################################################
## Media Players Off
###############################################################################
media_players_off:
  alias: 'Media Players Off'
  description: 'Turn off media, stop/turn off media players.'
  mode: parallel
  fields:
    media_players:
      description: 'Media players to turn off'
      example: 'media_player.dining_room_hub'

  sequence:
    - variables: #VAR variables in sequence to override field
        media_players: >
          {% set media_players = media_players|default(state_attr('group.single_media_players','entity_id')) %}
          {% set media_players = expand(media_players)|map(attribute='entity_id')|list %}
          {{ media_players }}

    - choose:
        - conditions: '{{ media_players|count > 0 }}'
          sequence:
            - variables:
                players_off: >
                  {{ expand(media_players)|selectattr('state','in',['on','home','idle','playing','paused','idle'])
                      |map(attribute='entity_id')|list }}

            - choose:
                - conditions: '{{ players_off|count > 0 }}'
                  sequence:
                    - service: media_player.turn_off
                      target:
                        entity_id: '{{ players_off }}'

            - wait_template: >
                {{ expand(players_off)|selectattr('state','in',['on','home','idle','playing','paused'])
                    |map(attribute='entity_id')|list|count == 0 }}
              timeout: # let players to turn off
                seconds: 2

            - variables:
                players_stop: >
                  {{ expand(players_off)|selectattr('state','in',['playing','paused'])
                      |map(attribute='entity_id')|list }}

            - choose: # stop players (req for vlc, browser players)
                - conditions: '{{ players_stop|count > 0 }}'
                  sequence:
                    - service: media_player.media_stop
                      target:
                        entity_id: '{{ players_stop }}'

    # keep script on until all off
    # don't include idle,standby state - spotify, vlc, browser players always idle, roku - standby
    - wait_template: >
        {{ expand(media_players)|selectattr('state','in',['on','home','playing','paused'])
            |map(attribute='entity_id')|list|count == 0 }}
      timeout: 5
#TODO
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Choose at step 2: choice 1: Choose at step 2: choice 1: Error executing script. Error for call_service at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Choose at step 2: choice 1: Error executing script. Error for choose at pos 2: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Error executing script. Error for choose at pos 2: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] [TTS] Queue Finished: Choose at step 1: choice 1: Error executing script. Error for call_service at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] [TTS] Queue Finished: Error executing script. Error for choose at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 15:59:58 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] Error while executing automation automation.tts_queue_finished: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Choose at step 2: choice 1: Choose at step 2: choice 1: Error executing script. Error for call_service at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Choose at step 2: choice 1: Error executing script. Error for choose at pos 2: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.script.media_players_off] Media Players Off: Error executing script. Error for choose at pos 2: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] [TTS] Queue Finished: Choose at step 1: choice 1: Error executing script. Error for call_service at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] [TTS] Queue Finished: Error executing script. Error for choose at pos 1: Entity media_player.kiosk_media_player does not support this service.
# 2022-04-01 16:04:11 ERROR (MainThread) [homeassistant.components.automation.tts_queue_finished] Error while executing automation automation.tts_queue_finished: Entity media_player.kiosk_media_player does not support this service.
