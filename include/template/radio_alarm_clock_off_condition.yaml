#######################################################################################################################
## Radio - Alarm Clock Off Condition
# true if trigger is alarm_clock_active and alarm clock media player (or group member) is radio media player (or group member)
#######################################################################################################################
condition: template
value_template: >
  {% if trigger.entity_id != 'binary_sensor.alarm_clock_active' %} true
  {% else %}
    {% set radio = states('sensor.radio_media_player') %}
    {% set alarm = states('sensor.alarm_clock_media_player') %}
    {% set radio_group = states.media_player|selectattr('attributes.' ~ radio.split('.')[1],'eq',true)|map(attribute='entity_id')|list %}
    {% set alarm_group = states.media_player|selectattr('attributes.' ~ alarm.split('.')[1],'eq',true)|map(attribute='entity_id')|list %}
    {% set groups = states.media_player|selectattr('attributes.speaker_group','eq',true)|map(attribute='entity_id')|list %}
    {% set found = namespace(value=0) %}
    {% if alarm in groups %}
      {% for alarm_player in alarm_group %}
        {% if radio in groups %}
          {% for radio_player in radio_group %}
            {% if alarm_player == radio_player %}{% set found.value = 1 %}{% endif %}
          {% endfor %}
        {% elif alarm_player == radio %}
          {% set found.value = 1 %}
        {% endif %}
      {% endfor %}
    {% else %}
      {% if radio in groups %}
        {% for radio_player in radio_group %}
          {% if alarm == radio_player %}{% set found.value = 1 %}{% endif %}
        {% endfor %}
      {% elif alarm == radio %}
        {% set found.value = 1 %}
      {% endif %}
    {% endif %}
    {{ found.value|int == 1 }}
  {% endif %}



