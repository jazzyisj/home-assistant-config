###############################################################################
## Templates - Mobile Jason
## Jason Headphones MAC - 00:18:6B:97:9B:B9
## UConnect MAC - 48:A9:D2:E5:12:66
###############################################################################
- binary_sensor:
    - name: 'Jason Phone Connected'
      unique_id: jason_phone_connected
      icon: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.jason_phone_connected','on') else 'mdi:cellphone-off' }}"
      device_class: connectivity
      state: #TODO
        > # bluetooth/wifi connected or last GPS update less than 30 minutes ago
        {% set time = now().timestamp() %}
        {% set last_updated = states.sensor.jphone_last_update_trigger.last_updated.timestamp() %}
        {% set last_gps = states.device_tracker.jphone.last_updated.timestamp() %}
        {% set last_seen = state_attr('device_tracker.jason_tracker','last_seen').timestamp() %}
        {% set update_min = (time - last_updated)/60 %}
        {% set gps_min = (time - last_gps)/60 %}
        {% set seen_min = (time - last_seen)/60 %}
        {% set min_since_update = [update_min,gps_min,seen_min]|min|int(0) %}
        {{ is_state('device_tracker.jphone_bt','home')
            or is_state('device_tracker.jason_phone_wifi','home')
            or is_state('device_tracker.jason_phone_router_wifi','home')
            or min_since_update < 30 }}
      attributes:
        last_seen: >
          {{ state_attr('device_tracker.jason_tracker','last_seen')
              |as_timestamp('unknown')|timestamp_custom('%-I:%M %p',true,'unknown') }}
        last_updated: >
          {{ states.sensor.jphone_last_update_trigger.last_updated
              |as_timestamp('unknown')|timestamp_custom('%-I:%M %p',true,'unknown') }}
        minutes_since_update: >
          {% set last_updated = states.sensor.jphone_last_update_trigger.last_updated.timestamp() %}
          {% set last_seen = states.device_tracker.jphone.last_updated.timestamp() %}
          {% set last_updated = [last_updated,last_seen]|min %}
          {{ ((now().timestamp() - last_updated)/60)|int(0) }}
      availability: >
        {{ states('device_tracker.jason_tracker')|lower not in ['unknown','unavailable','none']
            and not state_attr('device_tracker.jason_tracker','source_type')|lower == 'none'
            and not states('sensor.jphone_last_update_trigger')|lower in ['unknown','unavailable','none'] }}

    - unique_id: jason_phone_connected_alert
      state: "{{ is_state('binary_sensor.jason_phone_connected','off') and is_state('input_boolean.mobile_alerts','on') }}"

    - unique_id: jphone_ringer_alert
      delay_on:
        minutes: 15
      state: >
        {{ (is_state('sensor.jphone_do_not_disturb_sensor','priority_only')
              or is_state('sensor.jphone_ringer_mode','off')
              or (states('sensor.jphone_volume_level_ringer')|int(0) < 1 and not is_state('sensor.jphone_phone_state','offhook')))
            and not is_state('binary_sensor.quiet_hours','on')
            and not is_state('input_select.occupancy_mode','Night')
            and is_state('input_boolean.mobile_alerts','on') }}
      availability: "{{ is_number(states('sensor.jphone_volume_level_ringer')) }}"

    - unique_id: jphone_bluetooth_alert
      state: >
        {{ is_state('binary_sensor.jphone_bluetooth_state','off')
            and is_state('device_tracker.jphone_bt','not_home')
            and is_state('input_boolean.mobile_alerts','on') }}
      delay_on:
        minutes: 5

    - name: 'Jason WIFI Connected'
      unique_id: jphone_wifi
      icon: mdi:cellphone-wireless
      state: "{{ states('sensor.jphone_wifi_connection') in ['JNET2','JNET-ROUTER'] }}"
      availability: "{{ states('sensor.jphone_wifi_connection')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: jphone_wifi_alert
      state: >
        {{ is_state('binary_sensor.jphone_wifi_state','off')
            and is_state('device_tracker.jphone_wifi','not_home')
            and is_state('input_boolean.mobile_alerts','on') }}
      delay_on:
        minutes: 5

    - name: 'Jason Phone High Accuracy Alert'
      #BUG sensor not turning on when command sent from HA  https://github.com/jazzyisj/home-assistant-config/issues/34
      unique_id: jphone_high_accuracy_alert
      icon: mdi:crosshairs-gps
      state: >
        {{ is_state('binary_sensor.jphone_high_accuracy_mode','on')
            and not is_state('binary_sensor.commute_active','on')
            and not is_state('binary_sensor.jphone_is_charging','on')
            and not '48:A9:D2:E5:12:66' in state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices') }}
      delay_on:
        minutes: 5
      availability: "{{ states('binary_sensor.jphone_high_accuracy_mode')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: jphone_headphones_alert
      state: >
        {% if states('sensor.jphone_bluetooth_connection')|lower not in ['unknown','unavailable','none']
            and state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices')|lower not in ['unknown','unavailable','none']  %}
          {% set connected = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
          {{ is_state('input_boolean.mobile_alerts','on')
              and is_state_attr('binary_sensor.jason_home','just_arrived','true')
              and (is_state('device_tracker.jason_headphones_bt','home') or connected )
              and not is_state('alert.phone_mobile_headphone_jason','off') }}
        {% else %} false
        {% endif %}
      delay_on:
        minutes: 5

    - unique_id: jphone_battery_alert
      state: >
        {% set level = 50 if is_state('binary_sensor.prework_active','on') else 20 %}
        {{ states('sensor.jphone_battery_level')|int(0) < level and is_state('binary_sensor.jphone_is_charging','off')
            and is_state('input_boolean.mobile_alerts','on') }}
      delay_on:
        minutes: 15

    - name: 'Jason Mobile App Update'
      unique_id: jphone_app_update
      icon: "{{ 'mdi:check-circle' if is_state('binary_sensor.jphone_app_update','off') else 'mdi:alert-circle' }}"
      state: "{{ states('sensor.ha_companion_latest_version') != states('sensor.jphone_current_version') }}"
      attributes:
        current: "{{ states('sensor.jphone_current_version') }}"
        latest: "{{ states('sensor.ha_companion_latest_version') }}"
      availability: >
        {{ states('sensor.jphone_current_version')|lower not in ['unknown','unavailable','none']
            and states('sensor.ha_companion_latest_version')|lower not in ['unknown','unavailable','none'] }}

- sensor:
    - name: 'Jason Phone Alarm Clock'
      unique_id: jphone_alarm_clock
      icon: mdi:alarm
      state: >
        {% if states('sensor.jphone_next_alarm')|lower in ['','unknown','unavailable','none']
            or is_state('input_boolean.jphone_alarm_clock_enabled','off') %} off
        {% else %}
          {{ as_datetime(states('sensor.jphone_next_alarm')|as_timestamp('unknown')
            |timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')).isoformat() }}
        {% endif %}
      attributes:
        12hour: >
          {% if states('sensor.jphone_next_alarm')|lower in ['','unknown','unavailable','none']
            or is_state('input_boolean.jphone_alarm_clock_enabled','off') %} off
          {% else %}{{ states('sensor.jphone_next_alarm')|as_timestamp('unknown')
            |timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown') }}
          {% endif %}
      availability: "{{ states('sensor.jphone_next_alarm') not in ['unknown','none'] }}"
