###############################################################################
## Templates - Mobile Sheri
## Sheri Headphones btooth MAC - 5C:56:A4:32:E7:0E, B8:AD:3E:A5:5B:00 (old)
###############################################################################
- select:
    - name: 'Sheri Phone DND'
      unique_id: sheri_phone_dnd
      icon: "{{ iif(is_state('select.sheri_phone_dnd','off'),'mdi:minus-circle-off-outline','mdi:minus-circle-outline') }}"
      state: "{{ states('sensor.sphone_do_not_disturb_sensor') }}"
      select_option:
        - service: notify.mobile_app_sphone
          data:
            message: command_dnd
            title: '{{ option }}'
      options: "{{ ['off','priority_only','alarms_only','total_silence'] }}"
      availability: "{{ states('sensor.sphone_do_not_disturb_sensor')|lower not in ['unknown','unavailable','none'] }}"

    - name: 'Sheri Phone Ringer Mode'
      unique_id: sheri_phone_ringer_mode
      icon: >
        {% set state = states('sensor.sphone_ringer_mode') %}
        {% if state == 'normal' %} mdi:volume-high
        {% elif state == 'vibrate' %} mdi:volume-vibrate
        {% else %} mdi:volume-off
        {% endif %}
      state: "{{ states('sensor.sphone_ringer_mode') }}"
      select_option:
        - service: notify.mobile_app_sphone
          data:
            message: command_ringer_mode
            title: '{{ option }}'
      options: "{{ ['normal','vibrate','silent'] }}"
      availability: "{{ states('sensor.sphone_ringer_mode')|lower not in ['unknown','unavailable','none'] }}"

- button:
    - name: 'Sheri Phone Update Location'
      unique_id: sheri_phone_update_location
      icon: mdi:map-marker-down
      press:
        - service: notify.mobile_app_sphone
          data:
            message: request_location_update

    - name: 'Sheri Phone Open Mobile App'
      unique_id: sheri_phone_open_mobile_app
      icon: mdi:home-assistant
      press:
        - service: notify.mobile_app_sphone
          data:
            message: command_webview

- number:
    - name: 'Sheri Phone Alarm Volume'
      unique_id: sheri_phone_alarm_volume
      icon: mdi:volume-medium
      state: "{{ states('sensor.sphone_volume_level_alarm')|int(0) }}"
      step: 1
      min: 0
      max: 7
      set_value:
        - service: notify.mobile_app_sphone
          data:
            message: command_volume_level
            title: '{{ value|int }}'
            data:
              channel: alarm_stream
      availability: "{{ states('sensor.sphone_volume_level_alarm')|lower not in ['unknown','unavailable','none'] }}"

    - name: 'Sheri Phone Ringer Volume'
      unique_id: sheri_phone_ringer_volume
      icon: mdi:volume-medium
      state: "{{ states('sensor.sphone_volume_level_ringer')|int(0) }}"
      step: 1
      min: 0
      max: 7
      set_value:
        - service: notify.mobile_app_sphone
          data:
            message: command_volume_level
            title: '{{ value|int }}'
            data:
              channel: ring_stream
      availability: "{{ states('sensor.sphone_volume_level_ringer')|lower not in ['unknown','unavailable','none'] }}"

    #IDEA - name: 'Sheri Phone Notification Volume'
    #   unique_id: sheri_phone_notification_volume
    #   icon: mdi:volume-medium
    #   state: "{{ states('sensor.sphone_volume_level_ringer')|int(0) }}"
    #   step: 1
    #   min: 0
    #   max: 7
    #   set_value:
    #     - service: notify.mobile_app_sphone
    #       data:
    #         message: command_volume_level
    #         title: '{{ value }}'
    #         data:
    #           channel: notification_stream

    - name: 'Sheri Phone Media Volume'
      unique_id: sheri_phone_media_volume
      icon: mdi:volume-medium
      state: "{{ states('sensor.sphone_volume_level_music')|int(0) }}"
      step: 1
      min: 0
      max: 25
      set_value:
        - service: notify.mobile_app_sphone
          data:
            message: command_volume_level
            title: '{{ value|int }}'
            data:
              channel: music_stream
      availability: "{{ states('sensor.sphone_volume_level_music')|lower not in ['unknown','unavailable','none'] }}"

    #IDEA - name: 'Sheri Phone Call Volume'
    #   unique_id: sheri_phone_call_volume
    #   icon: mdi:volume-medium
    #   state: "{{ states('sensor.sphone_volume_level_call')|int(0) }}"
    #   step: 1
    #   min: 0
    #   max: 7
    #   set_value:
    #     - service: notify.mobile_app_sphone
    #       data:
    #         message: command_volume_level
    #         title: '{{ value|int }}'
    #         data:
    #           channel: call_stream
    #   availability: "{{ states('sensor.sphone_volume_level_call')|lower not in ['unknown','unavailable','none'] }}"

- binary_sensor:
    #NOTE will always be true after a restart for timedelta when last updated is set to restart time
    - name: 'Sheri Phone Connected'
      unique_id: sheri_phone_connected
      icon: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.sheri_phone_connected','on') else 'mdi:cellphone-off' }}"
      device_class: connectivity
      state: >
        {% set minutes = state_attr('sensor.sheri_phone_last_update','minutes_since_update')|int(-1) %}
        {% if is_state('device_tracker.sphone_bt','home')
            or is_state('binary_sensor.sheri_phone_wifi_connected','on') %} true
        {% elif minutes > -1 %}{{ minutes <= 30 }}
        {% endif %}
      availability: >
        {{ states('sensor.sheri_phone_last_update')|lower not in ['unknown','unavailable','none']
            and states('binary_sensor.sheri_phone_wifi_connected') in ['off','on'] }}

    - name: 'Sheri Phone Connected Alert'
      unique_id: sheri_phone_connected_alert
      device_class: problem
      delay_on: 60 # delay to prevent firing on template reload, temporary disconnections
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {{ is_state('binary_sensor.sheri_phone_connected','off') }}
        {% endif %}
      availability: "{{ states('binary_sensor.sheri_phone_connected') in ['off','on'] }}"

    - name: 'Sheri Phone Ringer Alert'
      unique_id: sheri_phone_ringer_alert
      device_class: problem
      delay_on: 900
      state: > # set ringer vol default to max to prevent false alerts
        {% if is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on') %}
          {{ (is_state('sensor.sphone_do_not_disturb_sensor','priority_only')
                or is_state('sensor.sphone_ringer_mode','off')
                or (states('sensor.sphone_volume_level_ringer')|int(7) < 1
                  and not is_state('sensor.sphone_phone_state','offhook')))
              and not is_state('binary_sensor.quiet_time','on')
              and not is_state('input_select.occupancy_mode','Night') }}
        {% endif %}

    - name: 'Sheri Phone Bluetooth Connected Alert'
      unique_id: sheri_phone_bluetooth_connected_alert
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state('binary_sensor.sheri_home','on')
            and is_state('binary_sensor.sheri_phone_bluetooth_off_alert','off')
            and is_state('device_tracker.sphone_bt','not_home') }}

    - name: 'Sheri Phone Bluetooth Off Alert'
      unique_id: sheri_phone_bluetooth_off_alert
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state('binary_sensor.sphone_bluetooth_state','off') }}

    # presence detection - check SSID if phone connected (faster) else check device tracker
    - name: 'Sheri Phone WIFI Connected'
      unique_id: sheri_phone_wifi_connected
      icon: mdi:cellphone-wireless
      device_class: presence
      state: >
        {{ (is_state('binary_sensor.sheri_phone_connected','on')
              and states('sensor.sphone_wifi_connection') in ['JNET2','JNET-ROUTER'])
            or (is_state('device_tracker.sheri_phone_wifi','home')
              or is_state('device_tracker.sphone_router_wifi','home')) }}

    # phone wifi - person home but not connected to WIFI
    - name: 'Sheri Phone WIFI Connected Alert'
      unique_id: sheri_phone_wifi_connected_alert
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state('binary_sensor.sheri_home','on')
            and is_state('binary_sensor.sheri_phone_wifi_off_alert','off')
            and is_state('binary_sensor.sheri_phone_wifi_connected','off') }}

    - name: 'Sheri Phone WIFI Off Alert'
      unique_id: sheri_phone_wifi_off_alert
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state('binary_sensor.sphone_wifi_state','off') }}

    - name: 'Sheri Phone Jeep Connected'
      unique_id: sheri_phone_jeep_connected
      device_class: connectivity
      state: >
        {% set devices = state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices')
            if is_state('binary_sensor.sheri_phone_connected','on') else none %}
        {{ '48:A9:D2:E5:12:66' in devices if devices != none else false }}

    #BUGFIX mobile app headphone sensor doesen't detect bluetooth devices
    - name: 'Sheri Phone Headphones Connected'
      unique_id: sheri_phone_headphones_connected
      device_class: connectivity
      state: >
        {% set devices = state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices')
            if is_state('binary_sensor.sheri_phone_connected','on') else none %}
        {{ 'B8:AD:3E:A5:5B:00' in devices if devices != none else false }}

    - name: 'Sheri Phone Headphones 2 Connected'
      unique_id: sheri_phone_headphones_2_connected
      device_class: connectivity
      state: >
        {% set devices = state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices')
            if is_state('binary_sensor.sheri_phone_connected','on') else none %}
        {{ '5C:56:A4:32:E7:0E' in devices if devices != none else false }}

    - name: 'Sheri Phone Bluetooth Device Alert'
      unique_id: sheri_phone_bluetooth_device_alert
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state_attr('binary_sensor.sheri_home','just_arrived','true')
            and (is_state('binary_sensor.sheri_phone_headphones_connected','on')
              or is_state('binary_sensor.sheri_phone_headphones_2_connected','on')
              or is_state('binary_sensor.sheri_phone_jeep_connected','on')) }}

    - name: 'Sheri Phone High Accuracy Alert'
      unique_id: sheri_phone_high_accuracy_alert
      icon: mdi:crosshairs-gps
      device_class: problem
      delay_on: 900
      state: >
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and is_state('binary_sensor.sphone_high_accuracy_mode','on')
            and not is_state('binary_sensor.commute_active','on')
            and not is_state('binary_sensor.sphone_is_charging','on')
            and not is_state('binary_sensor.sheri_phone_jeep_connected','on') }}

    - name: 'Sheri Phone Battery Alert'
      unique_id: sheri_phone_battery_alert
      device_class: problem
      delay_on: 900
      state: >
        {% set level = 50 if is_state('binary_sensor.work_commute_active','on') else 20 %}
        {{ is_state('input_boolean.mobile_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.sheri_phone_connected','on')
            and (states('sensor.sphone_battery_level')|int(-1) < level
              and is_state('binary_sensor.sphone_is_charging','off')) }}

    - name: 'Sheri Phone App Update Alert' #TEMP until update entity
      unique_id: sheri_phone_app_update_alert
      device_class: update
      state: >
        {{ states('sensor.home_assistant_android_latest_release')
            != states('sensor.sphone_current_version')[:-5] }}

- sensor:
    - name: 'Sheri Phone Last Update'
      unique_id: sheri_phone_last_update
      device_class: timestamp
      state: >
        {% set last_seen = state_attr('sensor.sheri_phone_last_update','last_seen')|int(-1) %}
        {% set last_updated = state_attr('sensor.sheri_phone_last_update','last_updated')|int(-1) %}
        {% set last_gps = state_attr('sensor.sheri_phone_last_update','last_gps')|int(-1) %}
        {% set update_times = [last_seen,last_updated,last_gps] %}
        {% set valid_times = namespace(value=[]) %}
        {% for item in update_times if item > -1 %}
            {% set valid_times.value = valid_times.value + [item] %}
        {% endfor %}
        {% if valid_times.value|count > 0 %}
            {% set last_update = valid_times.value|max %}
        {% endif %}
        {{ last_update|as_datetime if last_update is defined else none }}
      attributes:
        display_time: >
          {% if states('sensor.sheri_phone_last_update')|lower not in ['unknown','unavailable','none'] %}
            {% set time = states('sensor.sheri_phone_last_update')|as_datetime|as_local %}
            {{ time.strftime('Today at %-I:%M %p') if now().day == time.day else time.strftime('%A, %-I:%M %p') }}
          {% endif %}
        last_seen: "{{ state_attr('device_tracker.sheri_tracker','last_seen')|as_timestamp(none) }}"
        last_updated: '{{ states.sensor.sphone_last_update_trigger.last_updated|as_timestamp(none) }}'
        last_gps: '{{ states.device_tracker.sphone.last_updated|as_timestamp(none) }}'
        minutes_since_update: >
          {% set last_update = states('sensor.sheri_phone_last_update') %}
          {% if last_update|lower not in ['unknown','unavailable','none'] %}
            {{ ((now().timestamp() - last_update|as_timestamp)/60)|int }}
          {% endif %}

    - name: 'Sheri Phone Next Alarm'
      unique_id: sheri_phone_next_alarm
      icon: "{{ 'mdi:alarm-off' if states('sensor.sheri_phone_next_alarm') == none else 'mdi:alarm-check' }}"
      device_class: timestamp
      state: >
        {{ states('sensor.sphone_next_alarm')|as_datetime if is_state('input_boolean.sheri_phone_alarm_clock_enabled','on')
            and states('sensor.sphone_next_alarm') != 'unavailable' else none }}
      attributes:
        12hour: "{{ states('sensor.sheri_phone_next_alarm')|as_timestamp(none)|timestamp_custom('%a %-I:%M %p',true,none) }}"
