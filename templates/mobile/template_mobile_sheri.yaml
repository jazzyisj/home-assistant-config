###############################################################################
## Templates - Mobile Sheri
## Sheri Headphones btooth MAC - 5C:56:A4:32:E7:0E
## UConnect MAC - 48:A9:D2:E5:12:66
###############################################################################
- binary_sensor:
    - name: 'Sheri Phone Connected'
      unique_id: sheri_phone_connected
      icon: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.sheri_phone_connected','on') else 'mdi:cellphone-off' }}"
      device_class: connectivity
      state: >
        {% set minutes = state_attr('sensor.sheri_phone_last_update','minutes_since_update')|int(-1) %}
        {% if is_state('device_tracker.sphone_bt','home')
            or is_state('binary_sensor.sheri_phone_wifi_connected','on') %} true
        {% elif minutes > -1 %}{{ minutes <= 30 }}
        {% endif %}

    - name: 'Sheri Phone: Connected Alert'
      unique_id: sheri_phone_connected_alert
      device_class: problem
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {{ is_state('binary_sensor.sheri_phone_connected','off') }}
        {% endif %}

    - name: 'Sheri Phone: Ringer Alert'
      unique_id: sphone_ringer_alert
      device_class: problem
      delay_on:
        minutes: 15
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {{ (is_state('sensor.sphone_do_not_disturb_sensor','priority_only')
                or is_state('sensor.sphone_ringer_mode','off')
                or (states('sensor.sphone_volume_level_ringer')|int < 1 and not is_state('sensor.sphone_phone_state','offhook')))
              and not is_state('binary_sensor.quiet_time','on')
              and not is_state('input_select.occupancy_mode','Night') }}
        {% endif %}

    - name: 'Sheri Phone: Bluetooth Alert'
      unique_id: sphone_bluetooth_alert
      device_class: problem
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {{ is_state('binary_sensor.sphone_bluetooth_state','off')
              and is_state('device_tracker.sphone_bt','not_home') }}
        {% endif %}
      delay_on:
        minutes: 5

    # presence detection - if phone connected check SSID else check device tracker
    - name: 'Sheri Phone: WIFI Connected'
      unique_id: sheri_phone_wifi_connected
      icon: mdi:cellphone-wireless
      device_class: presence
      state: >
        {% if is_state('binary_sensor.sheri_phone_connected','on') %}
          {{ states('sensor.sphone_wifi_connection') in ['JNET2','JNET-ROUTER'] }}
        {% else %}
           {{ is_state('device_tracker.sheri_phone_wifi','home')
                and is_state('device_tracker.sheri_phone_router_wifi','home') }}
        {% endif %}

    # phone wifi - person home but not connected to WIFI
    # if phone connected check SSID else check device tracker
    - name: 'Sheri Phone: WIFI Disconnected'
      unique_id: sheri_phone_wifi_disconnected
      device_class: problem
      state: >
        {% if is_state('person.sheri','home') %}
          {% if is_state('binary_sensor.sheri_phone_connected','on') %}
              {{ states('sensor.sphone_wifi_connection') not in ['JNET2','JNET-ROUTER'] }}
          {% else  %}
            {{ not is_state('device_tracker.sheri_phone_wifi','home') }}
          {% endif %}
        {% endif %}

    - name: 'Sheri Phone: WIFI Alert'
      unique_id: sheri_phone_wifi_alert
      device_class: problem
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {% if is_state('binary_sensor.sheri_phone_connected','on') %}
            {{ (is_state('binary_sensor.sphone_wifi_state','off')
                 or is_state('binary_sensor.sheri_phone_wifi_disconnected','on')) }}
          {% else %}
            {{ is_state('binary_sensor.sheri_phone_wifi_disconnected','on') }}
          {% endif %}
        {% endif %}
      delay_on: # allow temporary disconnections, phone to connect when arriving
        minutes: 5

    - name: 'Sheri Phone: High Accuracy Alert'
      unique_id: sphone_high_accuracy_alert
      icon: mdi:crosshairs-gps
      device_class: problem
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {{ is_state('binary_sensor.sphone_high_accuracy_mode','on')
              and not is_state('binary_sensor.commute_active','on')
              and not is_state('binary_sensor.sphone_is_charging','on')
              and not '48:A9:D2:E5:12:66' in state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices') }}
        {% endif %}
      delay_on:
        minutes: 5

    - name: 'Sheri Phone: Headphones Alert'
      unique_id: sphone_headphones_alert
      device_class: problem
      state:
        > #ISSUE mobile app headphone sensor doesen't detect bluetooth devices
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {% set connected = '5C:56:A4:32:E7:0E' in state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices') %}
          {{ is_state_attr('binary_sensor.sheri_home','just_arrived','true')
              and (is_state('device_tracker.sheri_headphones_bt','home') or connected )
              and not is_state('alert.phone_mobile_headphone_sheri','off') }}
        {% endif %}
      delay_on:
        minutes: 5

    - name: 'Sheri Phone: Battery Alert'
      unique_id: sphone_battery_alert
      device_class: problem
      state: >
        {% if is_state('input_boolean.mobile_alerts','on') and is_state('input_boolean.startup_pending','off') %}
          {% set level = 50 if is_state('binary_sensor.work_commute_active','on') else 20 %}
          {{ states('sensor.sphone_battery_level')|int(-1) < level and is_state('binary_sensor.sphone_is_charging','off') }}
        {% endif %}
      delay_on:
        minutes: 15

    - name: 'Sheri Phone: App Update'
      unique_id: sphone_app_update
      device_class: update
      state: "{{ states('sensor.ha_companion_latest_version') != states('sensor.sphone_current_version') }}"
      attributes:
        current: "{{ states('sensor.sphone_current_version') }}"
        latest: "{{ states('sensor.ha_companion_latest_version') }}"

- sensor:
    - name: 'Sheri Phone: Last Update'
      unique_id: sheri_phone_last_update
      device_class: timestamp
      state: >
        {% set last_seen = state_attr('sensor.sheri_phone_last_update','last_seen')|int(-1) %}
        {% set last_updated = state_attr('sensor.sheri_phone_last_update','last_updated')|int(-1) %}
        {% set last_gps = state_attr('sensor.sheri_phone_last_update','last_gps')|int(-1) %}
        {% if last_seen > -1 and last_updated > -1 and last_gps > -1 %}
          {{ [last_seen,last_updated,last_gps]|max|timestamp_local }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        display_time: >
          {% if states('sensor.sheri_phone_last_update')|lower not in ['unknown','unavailable','none'] %}
            {% set time = states('sensor.sheri_phone_last_update')|as_datetime %}
            {{ time.strftime('Today at %-I:%M %p') if now().day == time.day else time.strftime('%A, %-I:%M %p') }}
          {% else %} unknown
          {% endif %}
        last_seen: "{{ state_attr('device_tracker.sheri_tracker','last_seen')|as_timestamp('unknown') }}"
        last_updated: "{{ states.sensor.sphone_last_update_trigger.last_updated|as_timestamp('unknown') }}"
        last_gps: "{{ states.device_tracker.sphone.last_updated|as_timestamp('unknown') }}"
        minutes_since_update: >
          {% set last_seen = state_attr('sensor.sheri_phone_last_update','last_seen')|int(-1) %}
          {% set last_updated = state_attr('sensor.sheri_phone_last_update','last_updated')|int(-1) %}
          {% set last_gps = state_attr('sensor.sheri_phone_last_update','last_gps')|int(-1) %}
          {% if last_seen > -1 and last_updated > -1 and last_gps > -1 %}
            {% set last_update = [last_seen,last_updated,last_gps]|max %}
            {{ ((now().timestamp() - last_update)/60)|int }}
          {% else %} unknown
          {% endif %}

    - name: 'Sheri Phone: Next Alarm'
      unique_id: sheri_phone_next_alarm
      icon: "{{ 'mdi:alarm-off' if states('sensor.sheri_phone_next_alarm') == none else 'mdi:alarm-check' }}"
      device_class: timestamp
      state: >
        {{ states('sensor.sphone_next_alarm')|as_datetime if is_state('input_boolean.sheri_phone_alarm_clock_enabled','on')
              and states('sensor.sphone_next_alarm') != 'unavailable' else none }}
      attributes:
        12hour: "{{ states('sensor.sheri_phone_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"
