###################################################################################################
## Templates - Spa
## https://github.com/jazzyisj/home-assistant-config/issues/29
###################################################################################################
- button:
    - name: "Spa Water Change Reset"
      unique_id: spa_water_change_reset
      icon: mdi:hot-tub
      press:
        - action: browser_mod.notification
          data:
            message: "Resetting Spa Water Change date."
            duration: 10000

- trigger:
    - trigger: homeassistant
      event: start

    - trigger: event
      event_type: event_template_reloaded

    - trigger: time_pattern
      minutes: "/5"
  binary_sensor:
    - name: "Balboa Integration Connected"
      unique_id: balboa_integration_connected
      picture: !secret BALBOA_ICON
      device_class: connectivity
      state: >
        {{ integration_entities('balboa') | select('has_value') | list | count > 0
            and is_state('device_tracker.balboa_spa', 'home') }}

- binary_sensor:
    - name: "Balboa Connected Alert"
      unique_id: balboa_connected_alert
      device_class: problem
      delay_on: 1800
      state: >
        {{ is_state('binary_sensor.balboa_integration_connected', 'off')
            and is_state('input_boolean.spa_alerts', 'on') }}

    - name: "Spa Offline Alert"
      unique_id: spa_offline_alert
      device_class: problem
      delay_on: 300
      state: >
        {{ (is_state('binary_sensor.balboa_integration_connected', 'off')
                or states('sensor.spa_power') | float(-1) < 1)
              and is_state('input_boolean.spa_alerts', 'on') }}

    - name: "Spa Energy Monitor Connected"
      unique_id: spa_energy_monitor_connected
      device_class: connectivity
      state: >
        {{ is_state('device_tracker.spa_energy_monitor', 'home')
            and has_value('sensor.spa_energy_monitor_channel_1_energy') }}

    - name: "Spa Low Temperature Alert"
      unique_id: spa_low_temperature_alert
      device_class: cold
      delay_on: 900
      state: >
        {{ states('sensor.spa_temperature') | int < states('input_number.spa_low_temperature_threshold') | int
            and is_state('input_boolean.spa_alerts', 'on') }}
      availability: "{{ is_number(states('sensor.spa_temperature')) }}"

    - name: "Spa Water Change Alert"
      unique_id: spa_water_change_alert
      icon: mdi:hot-tub
      state: >
        {{ now() - states('button.spa_water_change_reset') | as_datetime > timedelta(days=90)
            and is_state('input_boolean.spa_alerts', 'on') }}
      availability: "{{ has_value('button.spa_water_change_reset') }}"

    # req for spa heating history stats
    - name: "Spa Heating"
      unique_id: spa_heating
      device_class: heat
      state: "{{ is_state_attr('climate.spa', 'hvac_action', 'heating') }}"

- trigger:
    - trigger: state
      entity_id: climate.spa
      attribute: current_temperature
      to:
  condition:
    - condition: template
      value_template: "{{ is_number(state_attr('climate.spa', 'current_temperature')) }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.spa_temperature
      data:
        value: "{{ state_attr('climate.spa', 'current_temperature') }}"
  sensor:
    - name: "Spa Temperature"
      unique_id: spa_temperature
      icon: mdi:thermometer
      device_class: temperature
      state_class: measurement
      unit_of_measurement: "°C"
      state: "{{ states('input_number.spa_temperature') | float }}"

- sensor:
    - name: "Spa Target Temperature"
      unique_id: spa_target_temperature
      icon: mdi:thermometer
      device_class: temperature
      unit_of_measurement: "°C"
      state: "{{ state_attr('climate.spa', 'temperature') | float }}"
      availability: "{{ is_number(state_attr('climate.spa', 'temperature')) }}"

    - name: "Spa Power"
      unique_id: spa_power
      icon: mdi:lightning-bolt
      device_class: power
      state_class: measurement
      unit_of_measurement: W
      state: >
        {{ states('sensor.spa_energy_monitor_channel_1_power') | float(0)
            + states('sensor.spa_energy_monitor_channel_2_power') | float(0) }}
      availability: >
        {{ is_number(states('sensor.spa_energy_monitor_channel_1_power'))
            or is_number(states('sensor.spa_energy_monitor_channel_2_power')) }}
