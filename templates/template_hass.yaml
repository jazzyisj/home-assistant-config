###############################################################################
## Templates - Hass
###############################################################################
- binary_sensor:
    - name: 'Automation Disabled'
      unique_id: automation_disabled
      icon: mdi:sync-alert
      state: "{{ is_state('group.automation_controls','off') and is_state('input_boolean.dev_mode','off') }}"

    - name: 'Alert Disabled'
      unique_id: alert_disabled
      icon: mdi:alert
      state: "{{ states.alert|selectattr('state','eq','off')|list|count > 0 }}"

    - name: 'Integrations Connected'
      unique_id: integrations_connected
      icon: "{{ 'mdi:api' if is_state('binary_sensor.integrations_connected','on') else 'mdi:api-off' }}"
      device_class: connectivity
      state: "{{ is_state('group.integrations_connected_sensors','on') }}"

    - name: 'Integrations Connected Alert'
      unique_id: integrations_connected_alert
      # allow for temporary disconnections before alerting
      delay_on: "{{ 0 if is_state('binary_sensor.integrations_connected_alert','unknown') else 900 }}"
      state: >
        {{ is_state('binary_sensor.integrations_connected','off')
              and is_state('input_boolean.hass_alerts','on')
              and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ states('binary_sensor.integrations_connected') in ['off','on'] }}"

    - name: 'Kiosk Connected'
      unique_id: kiosk_connected
      icon: "{{ 'mdi:tablet-dashboard' if is_state('binary_sensor.integrations_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ states('light.fire_tablet_screen') in ['on','off']
            and is_number(states('sensor.browser_kiosk_internal')) }}

    # overload uptime sensor - if uptime robot component not connected binary_sensor.hassio is unavailable
    - name: 'Uptime Robot'
      unique_id: uptime_robot
      icon: "{{ 'mdi:sort-clock-descending' if is_state('binary_sensor.uptime_robot','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ is_state('binary_sensor.hassio','on') }}"

    - name: 'Uptime Robot Connected Alert'
      unique_id: uptime_robot_connected_alert
      icon: mdi:sort-clock-descending
      # allow for temporary disconnections before alerting
      delay_on: "{{ 0 if is_state('binary_sensor.uptime_robot_connected_alert','unknown') else 900 }}"
      state: >
        {{ is_state('binary_sensor.uptime_robot','off')
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Remote UI Alert'
      unique_id: remote_ui_alert
      # allow for temporary disconnections before alerting, prevent trigger on shutdown
      delay_on: "{{ 0 if is_state('binary_sensor.remote_ui_alert','unknown') else 300 }}"
      state: >
        {{ states('binary_sensor.remote_ui') in ['off','unavailable','unknown','none']
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Device Offline Alert'
      unique_id: device_offline_alert
      delay_on: 60 # allow for temporary disconnections before alerting
      state: >
        {{ states('sensor.offline_devices')|int(0) > 0
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Unavailable Sensor Alert'
      unique_id: unavailable_sensor_alert
      delay_on: 60 # allow for temporary disconnections before alerting
      state: >
        {{ states('sensor.unavailable_sensors')|int(0) > 0
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Unknown Browser Alert'
      unique_id: unknown_browser_alert
      state: >
        {{ states('sensor.unknown_browsers')|int(0) > 0
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Low Battery Alert'
      unique_id: low_battery_alert
      icon: "{{ 'mdi:battery-alert' if is_state('binary_sensor.low_battery_alert','on') else 'mdi:battery-90' }}"
      device_class: battery
      state: >
        {% if state_attr('binary_sensor.low_battery_alert','entity_id')|lower not in ['unknown','unavailable','none'] %}
          {{ state_attr('binary_sensor.low_battery_alert','entity_id')|count > 0
              and is_state('input_boolean.system_alerts','on')
              and is_state('input_boolean.startup_pending','off') }}
        {% else %} false
        {% endif %}
      attributes:
        entity_id: >
          {% set low_batteries = namespace(value=[]) %}
          {% set low_batts = states|selectattr('attributes.device_class','eq','battery')
              |rejectattr('attributes.mobile','eq',true)
              |map(attribute='entity_id')|list %}
          {% for item in low_batts %}
            {% if states(item) == 'on' or (states(item)|int(-1) != -1 and states(item)|int(0)
                < states('input_number.battery_alert_threshold')|int) %}
              {% set low_batteries.value = low_batteries.value + [item] %}
            {% endif %}
          {% endfor %}
          {{ low_batteries.value }}
- sensor:
    # placeholder entity for button entities
    - name: 'Dummy'
      unique_id: dummy
      state: ' '

    - name: 'Hass Status'
      unique_id: hass_status
      icon: mdi:home-assistant
      state: >
        {% if is_state('sensor.zwave_status','critical')
            or is_state('sensor.hass_files_status','critical')
            or is_state('alert.unknown_browser','on') %} critical

        {% elif is_state('sensor.zwave_status','severe')
            or is_state('sensor.hass_files_status','severe')
            or is_state('binary_sensor.integrations_connected','off')
            or is_state('binary_sensor.remote_ui','off') %} severe

        {% elif is_state('sensor.zwave_status','warning')
            or is_state('sensor.hass_files_status','warning')
            or is_state('alert.device_offline','on')
            or is_state('alert.low_battery','on')
            or not is_state('sensor.backup_state','backed_up') %} warning

        {% elif is_state('sensor.zwave_status','minor')
            or is_state('sensor.hass_files_status','minor')
            or is_state('alert.unavailable_sensor','on')
            or is_state('binary_sensor.hass_update','on') %} minor
        {% else %} ok
        {% endif %}

    - name: 'Hass DB Size Status'
      unique_id: hass_db_size_status
      icon: mdi:database
      state: >
        {% set db = states('sensor.hassio_db')|int(-1) %}
        {% if db > 10000 %} critical
        {% elif db > 7500 %} severe
        {% elif db > 5000 %} warning
        {% elif db > 2500 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Backup Size Status'
      unique_id: backup_size_status
      icon: mdi:backup-restore # gigabytes
      state: >
        {% set size = state_attr('sensor.backup_state','size_in_home_assistant')[:-2]|float(-1)
            if state_attr('sensor.backup_state','size_in_home_assistant') != none else 0 %}
        {% if size > 25 %} critical
        {% elif size > 20 %} severe
        {% elif size > 15 %} warning
        {% elif size > 10 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Hass Log Size Status'
      unique_id: hass_log_size_status
      icon: mdi:backup-restore
      state: >
        {% set size = states('sensor.home_assistant_log')|int(-1) %}
        {% if size > 100 %} critical
        {% elif size > 75 %} severe
        {% elif size > 25 %} warning
        {% elif size > 10 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Alarm Snapshots Size Status'
      unique_id: alarm_snapshots_size_status
      icon: mdi:backup-restore
      state: >
        {% set size = states('sensor.alarm_snapshots')|int(-1) %}
        {% if size > 150 %} critical
        {% elif size > 100 %} severe
        {% elif size > 75 %} warning
        {% elif size > 50 %} minor
        {% else %} ok
        {% endif %}

    - name: 'TTS Size Status'
      unique_id: tts_size_status
      icon: mdi:account-voice
      state: >
        {% set size = states('sensor.tts')|int(-1) %}
        {% if size > 150 %} critical
        {% elif size > 100 %} severe
        {% elif size > 75 %} warning
        {% elif size > 50 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Hass Files Status'
      unique_id: hass_files_status
      icon: mdi:harddisk
      state: >
        {% if is_state('sensor.hass_db_size_status','critical')
          or is_state('sensor.backup_size_status','critical')
          or is_state('sensor.hass_log_size_status','critical')
          or is_state('sensor.alarm_snapshots_size_status','critical')
          or is_state('sensor.tts_size_status','critical') %} critical

        {% elif is_state('sensor.hass_db_size_status','severe')
          or is_state('sensor.backup_size_status','severe')
          or is_state('sensor.hass_log_size_status','severe')
          or is_state('sensor.alarm_snapshots_size_status','severe')
          or is_state('sensor.tts_size_status','severe') %} severe

        {% elif is_state('sensor.hass_db_size_status','warning')
          or is_state('sensor.backup_size_status','warning')
          or is_state('sensor.hass_log_size_status','warning')
          or is_state('sensor.alarm_snapshots_size_status','crwarningitical')
          or is_state('sensor.tts_size_status','warning') %} warning

        {% elif is_state('sensor.hass_db_size_status','minor')
          or is_state('sensor.backup_size_status','minor')
          or is_state('sensor.hass_log_size_status','minor')
          or is_state('sensor.alarm_snapshots_size_status','minor')
          or is_state('sensor.tts_size_status','minor')  %} minor
        {% else %} ok
        {% endif %}

    - name: 'Connected Browsers'
      unique_id: connected_browsers
      unit_of_measurement: browsers
      icon: mdi:monitor-cellphone
      state: >
        {% if state_attr('sensor.connected_browsers','entity_id')|lower not in ['unknown','unavailable','none'] %}
          {{ states.sensor|selectattr('attributes.type','eq','browser_mod')|list|count }}
        {% endif %}
      attributes:
        entity_id: "{{ states.sensor|selectattr('attributes.type','eq','browser_mod')|map(attribute='entity_id')|list }}"

    - name: 'Unknown Browsers'
      unique_id: unknown_browsers
      unit_of_measurement: browsers
      state: >
        {% if state_attr('sensor.unknown_browsers','entity_id')|lower not in ['unknown','unavailable','none'] %}
          {{ state_attr('sensor.unknown_browsers','entity_id')|count }}
        {% endif %}
      attributes:
        entity_id: >
          {{ states.sensor|selectattr('attributes.type','eq','browser_mod')
            |selectattr('attributes.authorized','ne',true)|map(attribute='entity_id')|list }}

    # display hass uptime in friendly format
    - name: 'Home Assistant Uptime'
      unique_id: home_assistant_uptime
      icon: mdi:clock-start
      state: >
        {% set up_time = now().timestamp() - states('sensor.uptime')|as_timestamp %}
        {% set minutes = (up_time // 60)|int(0) %}
        {% set hours = (minutes // 60) %}
        {% set days = (hours // 24) %}
        {% set weeks = (days // 7) %}
        {% set minutes = (minutes % 60) %}
        {% set hours =  (hours % 24) %}
        {% set days = (days % 7) %}
        {% macro phrase(value, name) %}
          {%- set value = value %}
          {%- set end = 's' if value > 1 else '' %}
          {{- '{} {}{}'.format(value, name, end) if value|int(0) > 0 else '' }}
        {%- endmacro %}
        {% set text = [ phrase(weeks, 'week'), phrase(days, 'day'), phrase(hours, 'hr'), phrase(minutes, 'min') ]|select('!=','')|list|join(', ') %}
        {% set last_comma = text.rfind(',') %}
        {% if last_comma != -1 %}
          {% set text = text[:last_comma] + ' and' + text[last_comma + 1:] %}
        {% endif %}
        {{ text }}

    # display hass restart date/time in friendly format
    - name: 'Last Restart Date Time'
      unique_id: last_restart_date_time
      icon: mdi:clock-start
      state: >
        {% set uptime = states('sensor.uptime')|as_datetime|as_local %}
        {% set date = uptime.strftime('%d') %}
        {% set date = '{:01}'.format(date|int(0)) %}
        {% if date in ('1','21','31') %}{% set date = date ~ 'st' %}
        {% elif now().day in ('2','22') %}{% set date = date ~ 'nd' %}
        {% elif now().day in ('3','23') %}{% set date = date ~ 'rd' %}
        {% else %}{% set date = date ~ 'th' %}
        {% endif %}
        {{ uptime.strftime('%a') }} {{ date }} {{ uptime.strftime('%b %Y') }} {{ uptime.strftime('at %-I:%M %p') }}

    - name: 'Offline Devices'
      unique_id: offline_devices
      icon: "{{ 'mdi:alert-circle' if states('sensor.offline_devices')|int(0) > 0 else 'mdi:check-circle' }}"
      unit_of_measurement: devices
      state: >
        {% if state_attr('sensor.offline_devices','entity_id') != none %}
          {{ state_attr('sensor.offline_devices','entity_id')|count }}
        {% endif %}
      attributes:
        entity_id: >
          {% if state_attr('group.ignored_unavailable_entities','entity_id') != none %}
            {% set ignore_ts = (now().timestamp() - 60)|as_datetime %}
            {{ states|rejectattr('domain','in',['group','binary_sensor','sensor','geo_location'])
              |rejectattr('entity_id','in',state_attr('group.ignored_unavailable_entities','entity_id'))
              |rejectattr('entity_id','search','browser_')
              |rejectattr('entity_id','search','_do_not_disturb')
              |rejectattr('last_changed','ge',ignore_ts)
              |selectattr('state','in',['unavailable','unknown'])
              |map(attribute='entity_id')|list }}
          {% endif %}

    - name: 'Unavailable Sensors'
      unique_id: unavailable_sensors
      icon: "{{ 'mdi:alert-circle' if states('sensor.unavailable_sensors')|int(0) > 0 else 'mdi:check-circle' }}"
      unit_of_measurement: sensors
      state: >
        {% if state_attr('sensor.unavailable_sensors','entity_id') != none %}
          {{ state_attr('sensor.unavailable_sensors','entity_id')|count }}
        {% endif %}
      attributes:
        entity_id: >
          {% if state_attr('group.ignored_unavailable_entities','entity_id') != none %}
            {% set ignore_ts = (now().timestamp() - 60)|as_datetime %}
            {{ states|selectattr('domain','in',['sensor','binary_sensor'])
              |rejectattr('entity_id','in',state_attr('group.ignored_unavailable_entities','entity_id'))
              |rejectattr('entity_id','search','_alarm_volume')
              |rejectattr('entity_id','search','_next_alarm')
              |rejectattr('entity_id','search','_memory_percent')
              |rejectattr('entity_id','search','_cpu_percent')
              |rejectattr('entity_id','search','_timers')
              |rejectattr('entity_id','search','_alarms')
              |rejectattr('entity_id','search','browser_')
              |rejectattr('entity_id','search','_stars')
              |rejectattr('entity_id','search','_watchers')
              |rejectattr('entity_id','search','_forks')
              |rejectattr('entity_id','search','_issues')
              |rejectattr('entity_id','search','pull_requests')
              |rejectattr('entity_id','search','_latest_issue')
              |rejectattr('entity_id','search','_latest_pull_request')
              |rejectattr('entity_id','search','_latest_release')
              |rejectattr('entity_id','search','_latest_commit')
              |rejectattr('entity_id','search','_latest_tag')
              |rejectattr('entity_id','search','_latest_discussion')
              |rejectattr('last_changed','ge',ignore_ts)
              |selectattr('state','in',['unavailable','unknown'])
              |map(attribute='entity_id')|list }}
          {% endif %}

    - name: 'HASS Addon Memory Percent'
      unique_id: hass_addon_memory_percent
      icon: mdi:memory
      unit_of_measurement: '%'
      state: >
        {% set total = namespace(value=0) %}
        {% set addons = expand('group.add_on_memory_sensors') %}
        {% for sensor in addons if is_number(states(sensor.entity_id))%}
          {% set total.value = total.value + states(sensor.entity_id)|float %}
        {% endfor %}
        {{ total.value|float(0) }}

    - name: 'HASS Addon CPU Percent'
      unique_id: hass_addon_cpu_percent
      icon: mdi:memory
      unit_of_measurement: '%'
      state: >
        {% set total = namespace(value=0) %}
        {% set addons = expand('group.add_on_cpu_sensors') %}
        {% for sensor in addons if is_number(states(sensor.entity_id))%}
          {% set total.value = total.value + states(sensor.entity_id)|float %}
        {% endfor %}
        {{ total.value|float(0) }}
