###############################################################################
## Templates - Presence
###############################################################################
- binary_sensor:
    - name: 'Someone Home'
      unique_id: someone_home
      icon: mdi:account-supervisor-circle
      device_class: occupancy
      state: >
        {{ is_state('binary_sensor.jason_home','on')
            or is_state('binary_sensor.sheri_home','on')
            or is_state('input_boolean.guest_home','on') }}
      availability: >
        {{ states('binary_sensor.jason_home') in ['off','on']
            or states('binary_sensor.sheri_home') in ['off','on'] }}

    - name: 'Owner Home'
      unique_id: owner_home
      icon: mdi:account-supervisor-circle
      device_class: occupancy
      state: "{{ is_state('binary_sensor.jason_home','on') or is_state('binary_sensor.sheri_home','on') }}"
      availability: >
        {{ states('binary_sensor.jason_home') in ['off','on']
            or states('binary_sensor.sheri_home') in ['off','on'] }}

    # if override on use boolean value, else phone is connected use person location, else use boolean value
    - name: 'Jason Home'
      unique_id: jason_home
      icon: "{{ 'mdi:account-circle' if is_state('binary_sensor.jason_home','on') else 'mdi:account-circle-outline' }}"
      device_class: presence
      delay_off: 2 # delay to prevent home/away trigger when override boolean not on (switches back)
      delay_on: 2
      state: >
        {{ is_state('input_boolean.jason_home','on')
            if is_state('input_boolean.home_override_jason','on') or is_state('binary_sensor.jason_phone_connected','off')
              else is_state('person.jason','home') }}
      attributes:
        just_arrived: > #NOTE always true after restart
          {{ is_state('binary_sensor.sheri_home','on')
              and now() - states.binary_sensor.sheri_home.last_changed < timedelta(minutes=10)
              and is_state('input_boolean.startup_pending','off') }}

    - name: 'Sheri Home'
      unique_id: sheri_home
      icon: "{{ 'mdi:account-circle' if is_state('binary_sensor.sheri_home','on') else 'mdi:account-circle-outline' }}"
      device_class: presence
      delay_off: 2 # delay to prevent home/away trigger when override boolean not on (switches back)
      delay_on: 2
      state: >
        {{ is_state('input_boolean.sheri_home','on')
            if is_state('input_boolean.home_override_sheri','on') or is_state('binary_sensor.sheri_phone_connected','off')
              else is_state('person.sheri','home') }}
      attributes:
        just_arrived: >
          {{ is_state('binary_sensor.sheri_home','on')
              and now() - states.binary_sensor.sheri_home.last_changed < timedelta(minutes=10)
              and is_state('input_boolean.startup_pending','off') }}

    - name: 'Occupancy Mode Alert'
      unique_id: occupancy_mode_alert
      delay_on: 900
      state: >
        {{ ((states('input_select.occupancy_mode') in ['Away','Vacation'] and is_state('binary_sensor.someone_home','on'))
            or (states('input_select.occupancy_mode') in ['Home','Guest','Night'] and is_state('binary_sensor.someone_home','off'))
            or (is_state('input_select.occupancy_mode','Guest') and is_state('binary_sensor.owner_home','on'))
            or (is_state('alarm_control_panel.master','armed_away') and states('input_select.occupancy_mode') not in ['Away','Vacation'])
            or (is_state('alarm_control_panel.master','armed_night') and not is_state('input_select.occupancy_mode','Night'))
            or (states('alarm_control_panel.master') in ['armed_home','disarmed'] and states('input_select.occupancy_mode') not in ['Home','Guest']))
          and is_state('input_boolean.presence_alerts','on')
          and is_state('input_boolean.startup_pending','off') }}
      availability: >
        {{ states('binary_sensor.someone_home') in ['off','on']
            or states('binary_sensor.owner_home') in ['off','on'] }}

    - name: 'Presence Override Jason Alert'
      unique_id: presence_override_jason_alert
      delay_on: 900 # allow override to turn back off before alert
      state: >
        {{ is_state('input_boolean.home_override_jason','on')
            and is_state('input_boolean.presence_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Presence Override Sheri Alert'
      unique_id: presence_override_sheri_alert
      delay_on: 900
      state: >
        {{ is_state('input_boolean.home_override_sheri','on')
            and is_state('input_boolean.presence_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Presence LED Alert'
      unique_id: presence_led_alert
      state: >
        {{ is_state('input_boolean.jason_almost_home','on') or is_state('input_boolean.sheri_almost_home','on')
          or (is_state('binary_sensor.jason_home','on') and (now() - states.binary_sensor.jason_home.last_changed < timedelta(minutes=10)))
          or (is_state('binary_sensor.sheri_home','on') and (now() - states.binary_sensor.sheri_home.last_changed < timedelta(minutes=10)))
          or (is_state('input_boolean.guest_home','on') and (now() - states.input_boolean.guest_home.last_changed < timedelta(minutes=10)))
          or (states('proximity.jphone_home')|int(0) < 4 and state_attr('proximity.jphone_home','dir_of_travel') == 'towards')
          or (states('proximity.sphone_home')|int(0) < 4 and state_attr('proximity.sphone_home','dir_of_travel') == 'towards')
          or (is_state('alert.jason_phone_offline','on') or is_state('alert.sheri_phone_offline','on')) }}

- sensor:
    - name: 'Notify Service Home'
      unique_id: notify_service_home
      state: >
        {% if is_state('binary_sensor.jason_home','on')
            and is_state('binary_sensor.sheri_home','on') %} mobile
        {% elif is_state('binary_sensor.jason_home','on') %} jason
        {% elif is_state('binary_sensor.sheri_home','on') %} sheri
        {% else %} mobile
        {% endif %}
