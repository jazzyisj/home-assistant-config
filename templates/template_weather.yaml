- binary_sensor:
    - unique_id: pollen_connected
      name: Pollen Connected
      icon: "{{ 'mdi:flower' if is_state('binary_sensor.pollen_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ not states('sensor.allergy_index_today')|lower in ['unknown','unavailable','none']
            and not states('sensor.asthma_index_today')|lower in ['unknown','unavailable','none'] }}

    - unique_id: pollen_connected_alert
      name: Pollen Connected Alert
      icon: mdi:flower
      state: >
        {{ is_state('binary_sensor.pollen_connected','off')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: openuv_connected
      name: OpenUV Connected
      icon: "{{ 'mdi:weather-sunny-alert' if is_state('binary_sensor.openuv_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ not states('sensor.current_uv_index')|lower in ['unknown','unavailable','none'] }}"

    - unique_id: openuv_connected_alert
      name: OpenUV Connected Alert
      icon: mdi:weather-sunny-alert
      state: >
        {{ is_state('binary_sensor.openuv_connected','off')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: waqi_connected
      name: WAQI Connected
      icon: "{{ 'mdi:smog' if is_state('binary_sensor.waqi_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ not states('sensor.waqi_windsor')|lower in ['unknown','unavailable','none'] }}"

    - unique_id: waqi_connected_alert
      name: WAQI Connected Alert
      icon: mdi:smog
      state: >
        {{ is_state('binary_sensor.waqi_connected','off')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: flu_connected
      name: Flu Connected
      icon: "{{ 'mdi:biohazard' if is_state('binary_sensor.flu_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ not states('sensor.cdc_level')|lower in ['unknown','unavailable','none'] }}"

    - unique_id: flu_connected_alert
      name: Flu Connected Alert
      icon: mdi:biohazard
      state: >
        {{ is_state('binary_sensor.flu_connected','off')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: weather_alert_active
      state: >
        {{ is_state('binary_sensor.noaa_weather_alert','on')
            or is_state('binary_sensor.envcan_weather_alert','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: air_quality_alert
      state: >
        {{ states('sensor.uv_index')|int > 100
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: uv_risk_alert
      state: "{{ states('sensor.sensor.max_uv_index')|int > 6 and is_state('input_boolean.weather_alerts','on') }}"

    - unique_id: weather_led_alert
      state: >
        {{ is_state('binary_sensor.envcan_weather_alert','on')
            or is_state('binary_sensor.noaa_weather_alert','on')
            or is_state('binary_sensor.outdoor_low_temperature_alert','on')
            or is_state('binary_sensor.outdoor_high_temperature_alert','on')
            or is_state('binary_sensor.storm_approaching_alert','on') }}

    - unique_id: outdoor_high_temperature_alert
      delay_on: 30 # avoid alert on temporary spike
      state: >
        {{ states('sensor.outdoor_apparent_temperature')|int > states('input_number.outdoor_high_temperature_threshold')|int
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: > # just to be consistent
        {{ states('sensor.outdoor_apparent_temperature')|lower not in ['unknown','unavailable','none'] }}

    - unique_id: outdoor_low_temperature_alert
      delay_on: 30 # avoid alert on temporary spike, template reload
      state: >
        {{ states('sensor.outdoor_apparent_temperature')|int < states('input_number.outdoor_low_temperature_threshold')|int
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: > # req unknown|int = 0
        {{ states('sensor.outdoor_apparent_temperature')|lower not in ['unknown','unavailable','none'] }}

    - unique_id: outdoor_temperature_alert # for weather card
      name: Outdoor Temperature Alert
      icon: >
        {% if is_state('binary_sensor.outdoor_high_temperature_alert','on') %} mdi:thermometer-alert
        {% elif is_state('binary_sensor.outdoor_low_temperature_alert','on') %} mdi:thermometer-alert
        {% else %} mdi:thermometer
        {% endif %}
      state: >
        {{ is_state('binary_sensor.outdoor_high_temperature_alert','on')
            or is_state('binary_sensor.outdoor_low_temperature_alert','on') }}
      attributes:
        type: >
          {% if is_state('binary_sensor.outdoor_high_temperature_alert','on') %} Heat
          {% elif is_state('binary_sensor.outdoor_low_temperature_alert','on') %} Cold
          {% else %} Off
          {% endif %}

    - unique_id: asthma_risk_alert
      state: >
        {{ is_state('sensor.asthma_risk_today','High')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: allergy_risk_alert
      state: >
        {{ is_state('sensor.allergy_risk_today','High')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: flu_risk_alert
      state: > # No Data, Minimal, Low, Moderate, High, None
        {{ (states('sensor.cold_flu_index_today')|float > 4.9
            or states('sensor.cold_flu_forecasted_average')|float > 4.9)
              and is_state('input_boolean.weather_alerts','on')
              and is_state('input_boolean.startup_pending','off') }}

    - unique_id: storm_approaching_alert #DARKSKY
      icon: mdi:weather-lightning-rainy
      state: >
        {{ (states('sensor.climacell_precipitation_probability_0h')|int >= 40
              or states('sensor.climacell_precipitation_probability_1h')|int >= 40)
            and states('sensor.dark_sky_nearest_storm_distance')|int < 5
            and not states('sensor.dark_sky_nearest_storm_distance')|lower in ['unknown','unavailable','none']
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: tornado_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: >
        {{ 'tornado' in states('sensor.envcan_warnings')|lower
            or (is_state_attr('binary_sensor.noaa_weather_alert','condition','tornado')
              and state_attr('binary_sensor.noaa_weather_alert','severity') in ['severe','extreme']) }}
- sensor:
    - unique_id: temperature_trend # for weather card
      name: Temperature Trend
      icon: >
        {% if is_state('binary_sensor.temperature_rising','on') %} mdi:arrow-up-circle
        {% elif is_state('binary_sensor.temperature_falling','on') %} mdi:arrow-down-circle
        {% else %} mdi:minus-circle
        {% endif %}
      state: >
        {% if is_state('binary_sensor.temperature_rising','on') %} Rising
        {% elif is_state('binary_sensor.temperature_falling','on') %} Falling
        {% else %} Steady
        {% endif %}

    - unique_id: pressure_trend # for weather card
      name: Pressure Trend
      icon: >
        {% if is_state('binary_sensor.pressure_rising','on') %} mdi:arrow-up-circle
        {% elif is_state('binary_sensor.pressure_falling','on') %} mdi:arrow-down-circle
        {% else %} mdi:minus-circle
        {% endif %}
      state: >
        {% if is_state('binary_sensor.pressure_rising','on') %} Rising
        {% elif is_state('binary_sensor.pressure_falling','on') %} Falling
        {% else %} Steady
        {% endif %}

    - name: Moon Phases
      unique_id: moon_phases
      picture: >
        {% if is_state('sensor.moon','new_moon') %} /local/images/moon_phases/new_moon.jpg
        {% elif is_state('sensor.moon','waxing_crescent') %} /local/images/moon_phases/waxing_crescent.jpg
        {% elif is_state('sensor.moon','first_quarter') %} /local/images/moon_phases/first_quarter.jpg
        {% elif is_state('sensor.moon','waxing_gibbous') %} /local/images/moon_phases/waxing_gibbous.jpg
        {% elif is_state('sensor.moon','full_moon') %} /local/images/moon_phases/full_moon.jpg
        {% elif is_state('sensor.moon','waning_gibbous') %} /local/images/moon_phases/waning_gibbous.jpg
        {% elif is_state('sensor.moon','last_quarter') %} /local/images/moon_phases/last_quarter.jpg
        {% elif is_state('sensor.moon','waning_crescent') %} /local/images/moon_phases/waning_crescent.jpg
        {% endif %}
      state: "{{ states('sensor.moon')|replace('_',' ')|title }}"

    - name: Allergy Risk Today # https://www.home-assistant.io/integrations/iqvia/
      unique_id: allergy_risk_today
      icon: mdi:flower
      state: >
        {% set level = states('sensor.allergy_index_today')|float %}
        {% if level < 2.5 %} Low
        {% elif level < 4.9 %} Low-Medium
        {% elif level < 7.3 %} Medium
        {% elif level < 9.7 %} Medium-High
        {% else %} High
        {% endif %}
      availability: >
        {{ is_state('binary_sensor.pollen_connected','on')
          and not states('sensor.allergy_index_today')|lower in ['unknown','unavailable','none'] }}

    - unique_id: allergy_risk_tomorrow
      name: Allergy Risk Tomorrow
      icon: mdi:flower
      state: >
        {% set level = states('sensor.allergy_index_tomorrow')|float %}
        {% if level < 2.5 %} Low
        {% elif level < 4.9 %} Low-Medium
        {% elif level < 7.3 %} Medium
        {% elif level < 9.7 %} Medium-High
        {% else %} High
        {% endif %}
      availability: >
        {{ is_state('binary_sensor.pollen_connected','on')
          and not states('sensor.allergy_index_tomorrow')|lower in ['unknown','unavailable','none'] }}

    - unique_id: asthma_risk_today
      name: Asthma Risk Today
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_today')|float %}
        {% if level < 2.5 %} Low
        {% elif level < 4.9 %} Low-Medium
        {% elif level < 7.3 %} Medium
        {% elif level < 9.7 %} Medium-High
        {% else %} High
        {% endif %}
      availability: >
        {{ is_state('binary_sensor.pollen_connected','on')
          and not states('sensor.asthma_index_today')|lower in ['unknown','unavailable','none'] }}

    - unique_id: asthma_risk_tomorrow
      name: Asthma Risk Tomorrow
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_tomorrow')|float %}
        {% if level < 2.5 %} Low
        {% elif level < 4.9 %} Low-Medium
        {% elif level < 7.3 %} Medium
        {% elif level < 9.7 %} Medium-High
        {% else %} High
        {% endif %}
      availability: >
        {{ is_state('binary_sensor.pollen_connected','on')
          and not states('sensor.asthma_index_tomorrow')|lower in ['unknown','unavailable','none'] }}

    - unique_id: uv_risk_today # https://www.openuv.io/uvindex
      name: UV Risk Today
      icon: mdi:weather-sunny
      state: >
        {% set level = states('sensor.max_uv_index')|int %}
        {% if level < 3 %} Low
        {% elif level < 7 %} Moderate
        {% elif level < 9 %} High
        {% else %} Very High
        {% endif %}
      availability: >
        {{ is_state('binary_sensor.openuv_connected','on')
            and not states('sensor.max_uv_index')|lower in ['unknown','unavailable','none'] }}

    - unique_id: aqi_risk_level
      name: AQI Risk Level
      icon: mdi:smog
      state: >
        {% set level = states('sensor.air_quality_index')|int %}
        {% if level < 51 %} Good
        {% elif level < 101 %} Moderate
        {% elif level < 101 %} Unhealthy Sensitive Groups
        {% elif level < 201 %} Unhealthy
        {% elif level < 301 %} Very Unhealthy
        {% else %} Hazardous
        {% endif %}
      availability: "{{ not states('sensor.air_quality_index')|lower in ['unknown','unavailable','none'] }}"

    - unique_id: flu_risk_level
      name: Flu Risk Level
      icon: mdi:virus
      state: >
        {% set level = states('sensor.cold_flu_index_today')|int %}
        {% if level < 2.5 %} Low
        {% elif level < 4.9 %} Low-Medium
        {% elif level < 7.3 %} Medium
        {% elif level < 9.7 %} Medium-High
        {% else %} High
        {% endif %}

    # overload weather integration sensors #IDEA second integration as backup?
    - unique_id: current_condition
      name: Current Condition
      icon: mdi:weather-partly-rainy
      state: "{{ states('sensor.climacell_current_condition') }}"

    - unique_id: outdoor_temperature
      name: Outdoor Temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: "{{ states('sensor.envcan_temperature')|int }}"
      availability: "{{ states('sensor.envcan_temperature')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: outdoor_apparent_temperature
      name: Outdoor Apparent Temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: "{{ states('sensor.climacell_feels_like')|int }}"  # unknown|int = 0
      availability: "{{ states('sensor.climacell_feels_like')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: dew_point
      name: Dew Point
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: "{{ states('sensor.climacell_dew_point')|int }}"
      availability: "{{ states('sensor.climacell_dew_point')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: outdoor_humidity
      name: Outdoor Humidity
      device_class: humidity
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states('sensor.envcan_humidity') }}"

    - unique_id: precipitation_probability
      name: Precipitation Probability
      icon: mdi:weather-rainy
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states.weather.home.attributes.forecast[0].precipitation_probability }}"
      availability: >
        {% if states.weather.home.attributes.forecast is defined %}
          {{ states.weather.home.attributes.forecast[0].precipitation_probability is defined }}
        {% endif %}

    #TODO error on startup
    #ERROR (MainThread) [homeassistant.components.template.template_entity] TemplateError('UndefinedError: 'mappingproxy object' has no attribute 'forecast'') while processing template 'Template("{{ states.weather.home.attributes.forecast[0].precipitation_probability }}")' for attribute '_attr_native_value' in entity 'sensor.precipitation_probability'

    - unique_id: precipitation_intensity
      name: Precipitation Intensity
      icon: mdi:weather-pouring
      state_class: measurement
      unit_of_measurement: mm/hr
      state: "{{ states('sensor.climacell_precipitation_intensity') }}"

    - unique_id: barometric_pressure
      name: Barometric Pressure
      device_class: pressure
      state_class: measurement
      unit_of_measurement: hPa
      state: "{{ states('sensor.climacell_pressure_surface_level') }}"

    - unique_id: wind_speed
      name: Wind Speed
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: "{{ states('sensor.envcan_wind_speed')|int }}"
      availability: "{{ states('sensor.envcan_wind_speed')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: wind_gust
      name: Wind Gust
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: >
        {% set speed = states('sensor.envcan_wind_speed')|int %}
        {% set gust = states('sensor.envcan_wind_gust')|int %}
        {{ gust if gust > 0 else speed }}
      availability: "{{ states('sensor.envcan_wind_speed')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: wind_bearing
      name: Wind Bearing
      icon: mdi:compass
      state_class: measurement
      unit_of_measurement: °
      state: "{{ states('sensor.climacell_wind_bearing') }}"

    - unique_id: cloud_cover
      name: Cloud Cover
      icon: mdi:cloud
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states('sensor.climacell_cloud_cover') }}"

    - unique_id: visibility
      name: Visibility
      icon: mdi:eye
      state_class: measurement
      unit_of_measurement: km
      state: "{{ states('sensor.envcan_visibility') }}"

    - unique_id: air_quality_index
      name: Air Quality Index
      device_class: aqi
      state_class: measurement
      unit_of_measurement: AQI
      state: "{{ states('sensor.waqi_windsor') }}"
      #OPTION  sensor.envcan_air_quality_health_index

    - unique_id: uv_index
      name: UV Index
      icon: mdi:brightness-6
      state_class: measurement
      state: "{{ states('sensor.current_uv_index') }}" # open uv
      #OPTION sensor.climacell_global_horizontal_irradiance ?
      #OPTION sensor.envcan_uv_index

    - unique_id: ozone
      name: Ozone
      device_class: ozone
      state_class: measurement
      unit_of_measurement: ppb # µg/m³
      state:  "{{ states('sensor.climacell_ozone') }}"
      #OPTION sensor.current_ozone_level  openuv unit: du <- pay attention
      #OPTION sensor.waqi_windsor attribute: ozone unit: AQI <- pay attention

    - unique_id: carbon_monoxide
      name: Carbon Monoxide
      device_class: carbon_monoxide
      state_class: measurement
      unit_of_measurement: ppm # Gas CNG/LPG
      state: "{{ states('sensor.climacell_carbon_monoxide') }}"
      #OPTION sensor.waqi_windsor attribute: co

    - unique_id: nitrogen_dioxide
      name: Nitrogen Dioxide
      device_class: nitrogen_dioxide
      state_class: measurement
      unit_of_measurement: ppb # µg/m³
      state: "{{ states('sensor.climacell_nitrogen_dioxide') }}"
      #OPTION sensor.waqi_windsor attribute: nitrogen_dioxide  unit: AQI <- pay attention

    - unique_id: sulphur_dioxide
      name: Sulphur Dioxide
      device_class: sulphur_dioxide
      state_class: measurement
      unit_of_measurement: ppb # µg/m³
      state: "{{ states('sensor.climacell_sulfur_dioxide') }}"
      #OPTION sensor.waqi_windsor attribute: sulfur_dioxide   unit: AQI <- pay attention

    - unique_id: particulate_matter_10
      name: Particulate Matter 10
      device_class: pm10
      state_class: measurement
      unit_of_measurement: μg/m³
      state: "{{ states('sensor.climacell_particulate_matter_10_mm') }}"
      #OPTION sensor.waqi_windsor attribute: pm_10  unit: AQI <- pay attention

    - unique_id: particulate_matter_2_5
      name: Particulate Matter 2.5
      device_class: pm25
      state_class: measurement
      unit_of_measurement: μg/m³
      state: "{{ states('sensor.climacell_particulate_matter_2_5_mm') }}"
      #OPTION sensor.waqi_windsor attribute: pm_2_5  unit: AQI <- pay attention

