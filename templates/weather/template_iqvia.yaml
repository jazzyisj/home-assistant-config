###############################################################################
## Templates - IQVIAs
###############################################################################
- binary_sensor:
    - name: "Pollen Connected"
      unique_id: pollen_connected
      icon: "{{ 'mdi:flower' if is_state('binary_sensor.pollen_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ is_number(states('sensor.allergy_index_today'))
            or is_number(states('sensor.asthma_index_today'))
            or is_number(states('sensor.cold_flu_index_today')) }}

    - name: "Pollen Connected Alert"
      unique_id: pollen_connected_alert
      icon: mdi:flower
      state: >
        {{ is_state('binary_sensor.pollen_connected','off')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - unique_id: asthma_risk_alert
      state: >
        {{ is_state('sensor.asthma_risk_today','High')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ states('sensor.asthma_risk_today')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: allergy_risk_alert
      state: >
        {{ is_state('sensor.allergy_risk_today','High')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ states('sensor.allergy_risk_today')|lower not in ['unknown','unavailable','none'] }}"

    - unique_id: flu_risk_alert #TODO other sensors, if/else in state
      state: > # No Data, Minimal, Low, Moderate, High, None
        {% if is_number(states('sensor.cold_flu_index_today'))
              and is_state('input_boolean.weather_alerts','on')
              and is_state('input_boolean.startup_pending','off') %}
          {{ (states('sensor.cold_flu_index_today')|float(default='ERROR') > 4.9
              or states('sensor.cold_flu_forecasted_average')|float(default='ERROR') > 4.9) }}
        {% else %} false
        {% endif %}
      availability: "{{ is_number(states('sensor.cold_flu_index_today')) }}"

- sensor:
    - name: "Allergy Risk Today" # https://www.home-assistant.io/integrations/iqvia/
      unique_id: allergy_risk_today
      icon: mdi:flower
      state: >
        {% set level = states('sensor.allergy_index_today')|float(default='unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.allergy_index_today')) }}"

    - name: "Allergy Risk Tomorrow"
      unique_id: allergy_risk_tomorrow
      icon: mdi:flower
      state: >
        {% set level = states('sensor.allergy_index_tomorrow')|float(default='unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.allergy_index_tomorrow')) }}"

    - name: "Asthma Risk Today"
      unique_id: asthma_risk_today
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_today')|float(default='unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.asthma_index_today')) }}"

    - name: "Asthma Risk Tomorrow"
      unique_id: asthma_risk_tomorrow
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_tomorrow')|float(default='unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.asthma_index_tomorrow')) }}"

    - name: "Flu Risk Level"
      unique_id: flu_risk_level
      icon: mdi:virus
      state: >
        {% set level = states('sensor.cold_flu_index_today')|float(default='unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.cold_flu_index_today')) }}"
