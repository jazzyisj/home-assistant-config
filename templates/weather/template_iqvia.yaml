###############################################################################
## Templates - IQVIA
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.allergy_risk_today
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: sensor.allergy_risk_today
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "IQVIA Connected"
      unique_id: iqvia_connected
      icon: mdi:flower-pollen
      device_class: connectivity
      state: >
        {{ expand(integration_entities('iqvia'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id:
        - binary_sensor.iqvia_connected
        - input_boolean.weather_alerts
      to:
        - "on"
        - "off"
  binary_sensor:
    - name: "IQVIA Connected Alert"
      unique_id: iqvia_connected_alert
      icon: mdi:flower-pollen
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.iqvia_connected','off')
            and is_state('input_boolean.weather_alerts','on') }}

- binary_sensor:
    - name: "Asthma Risk Alert"
      unique_id: asthma_risk_alert
      state: >
        {{ states('sensor.asthma_risk_today') in ['High','Medium-High','Medium']
            and is_state('input_boolean.weather_alerts','on') }}
      availability: "{{ states('sensor.asthma_risk_today') not in ['unknown','unavailable'] }}"

    - name: "Allergy Risk Alert"
      unique_id: allergy_risk_alert
      state: >
        {{ states('sensor.allergy_risk_today') in ['High','Medium-High','Medium']
            and is_state('input_boolean.weather_alerts','on') }}
      availability: "{{ states('sensor.allergy_risk_today') not in ['unknown','unavailable'] }}"

    - name: "Flu Risk Alert"
      unique_id: flu_risk_alert
      state: >
        {{ states('sensor.flu_risk_today') in ['High','Medium-High','Medium']
            and is_state('input_boolean.weather_alerts','on') }}
      availability: "{{ states('sensor.flu_risk_today') not in ['unknown','unavailable'] }}"

- sensor:
    - name: "Allergy Risk Today" # https://www.home-assistant.io/integrations/iqvia/
      unique_id: allergy_risk_today
      icon: mdi:flower-pollen
      state: >
        {% set level = states('sensor.allergy_index_today')|float('unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.allergy_index_today')) }}"

    - name: "Allergy Risk Tomorrow"
      unique_id: allergy_risk_tomorrow
      icon: mdi:flower-pollen
      state: >
        {% set level = states('sensor.allergy_index_tomorrow')|float('unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.allergy_index_tomorrow')) }}"

    - name: "Asthma Risk Today"
      unique_id: asthma_risk_today
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_today')|float('unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.asthma_index_today')) }}"

    - name: "Asthma Risk Tomorrow"
      unique_id: asthma_risk_tomorrow
      icon: mdi:lungs
      state: >
        {% set level = states('sensor.asthma_index_tomorrow')|float('unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.asthma_index_tomorrow')) }}"

    - name: "Flu Risk Today"
      unique_id: flu_risk_today
      icon: mdi:virus
      state: >
        {% set level = states('sensor.cold_flu_index_today')|float('unknown') %}
        {% if is_number(level) %}
          {% if level < 2.5 %} Low
          {% elif level < 4.9 %} Low-Medium
          {% elif level < 7.3 %} Medium
          {% elif level < 9.7 %} Medium-High
          {% else %} High
          {% endif %}
        {% endif %}
      availability: "{{ is_number(states('sensor.cold_flu_index_today')) }}"
