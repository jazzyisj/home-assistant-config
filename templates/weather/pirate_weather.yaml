###############################################################################
## Templates -  Pirate Weather
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: time_pattern
      hours: /1
  action:
    - service: weather.get_forecasts
      data:
        type: hourly
      target:
        entity_id: weather.pirateweather
      response_variable: forecast #TODO
  sensor:
    - name: Pirateweather Hourly Forecast
      unique_id: pirateweather_hourly_forecast
      state: "{{ now().isoformat() }}"
      attributes:
        forecast: "{{ forecast }}"

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.time
  binary_sensor:
    - name: "PirateWeather Connected"
      unique_id: pirateweather_connected
      picture: !secret PIRATE_ICON
      device_class: connectivity
      state: "{{ integration_entities('pirateweather') | select('has_value') | list | count > 0 }}"

- binary_sensor:
    - name: "PirateWeather Connected Alert"
      unique_id: pirateweather_connected_alert
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.pirateweather_connected', 'off')
            and is_state('input_boolean.weather_alerts', 'on') }}
