###############################################################################
## Templates - NOAA
###############################################################################
- binary_sensor:
    - name: 'NOAA Connected'
      unique_id: noaa_connected
      icon: "{{ 'mdi:weather-hurricane' if is_state('binary_sensor.noaa_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ not states('sensor.noaa_alerts_miz076')|lower in ['unknown','unavailable','none'] }}"

    - name: 'NOAA Connected Alert'
      unique_id: noaa_connected_alert
      icon: mdi:weather-hurricane
      state: >
        {{ not is_state('binary_sensor.noaa_connected','on')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'NWS Connected'
      unique_id: nws_connected
      icon: mdi:weather-partly-snowy-rainy
      device_class: connectivity
      state: "{{ not states('weather.kdtw_daynight')|lower in ['unknown','unavailable','none'] }}"

    - name: 'NWS Connected Alert'
      unique_id: nws_connected_alert
      icon: mdi:weather-partly-snowy-rainy
      state: >
        {{ not is_state('binary_sensor.nws_connected','on')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'NOAA Weather Alert'
      unique_id: noaa_weather_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: "{{ states('sensor.noaa_alerts_miz076')|int(0) > 0 }}"
      attributes:
        type: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].messageType }}
          {% endif %}
        title: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].event|title }}
          {% endif %}
        severity: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].severity|lower }}
          {% endif %}
        condition: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].event }}
          {% endif %}
        description: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {% set headline = state_attr('sensor.noaa_alerts_miz076','alerts')[0].parameters.NWSheadline %}
            {% set inst = state_attr('sensor.noaa_alerts_miz076','alerts')[0].instruction %}
            {{ headline[0] ~ '.' if headline != None }}
            {{ inst ~ '.' if inst != None }}
          {% endif %}
        starts: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].onset|as_datetime }}
          {% endif %}
        expires: >
          {% if state_attr('sensor.noaa_alerts_miz076','alerts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].expires|as_datetime }}
          {% endif %}
        starts_text: > #VERIFY
          {% if state_attr('binary_sensor.noaa_weather_alert','starts')|lower not in ['','[]','unknown','unavailable','none'] %}
            {% set starts = state_attr('binary_sensor.noaa_weather_alert','starts')|as_datetime %}
            {% set today = starts.day == now().day %}
            {% set tomorrow = starts.day == now().day + 1 %}
            {% set starts = 'today' if today else ('tomorrow' if tomorrow else
                starts|as_timestamp('unknown')|timestamp_custom('%A',true,'unknown')) %}
            {{ starts ~ ' at ' ~ starts|as_timestamp('unknown')|timestamp_custom('%-I:%M %p',true,'unknown') }}
          {% endif %}
        expires_text: >
          {% if state_attr('binary_sensor.noaa_weather_alert','expires')|lower not in ['','[]','unknown','unavailable','none'] %}
            {% set expires = state_attr('binary_sensor.noaa_weather_alert','expires')|as_datetime %}
            {% set today = expires.day == now().day %}
            {% set tomorrow = expires.day  == now().day %}
            {% set until = 'today' if today else ('tomorrow' if tomorrow
                else expires|as_timestamp('unknown')|timestamp_custom('%A',true,'unknown')) %}
            {{ until ~ ' at ' ~ expires|as_timestamp('unknown')|timestamp_custom('%-I:%M %p',true,'unknown') }}
          {% endif %}
        active: >
          {% if state_attr('binary_sensor.noaa_weather_alert','starts')|lower not in ['','unknown','unavailable','none'] %}
            {{ now().timestamp() > state_attr('binary_sensor.noaa_weather_alert','starts')|as_timestamp('unknown') }}
          {% endif %}
        availability: "{{ is_state('binary_sensor.noaa_connected','on') }}"
