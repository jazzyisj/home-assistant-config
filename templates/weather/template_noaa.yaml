###############################################################################
## Templates - NOAA
###############################################################################
- binary_sensor:
    - name: "NOAA Connected"
      unique_id: noaa_connected
      icon: mdi:weather-hurricane
      device_class: connectivity
      state: "{{ not states('sensor.noaa_alerts_miz076') in ['unknown','unavailable'] }}"

    - name: "NOAA Connected Alert"
      unique_id: noaa_connected_alert
      icon: mdi:weather-hurricane
      state: >
        {{ not is_state('binary_sensor.noaa_connected','on')
            and is_state('input_boolean.weather_alerts','on') }}

    - name: "NOAA Weather Alert"
      unique_id: noaa_weather_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: >
        {{ states('sensor.noaa_alerts_miz076')|int(0) > 0
            and is_state('input_boolean.weather_alerts','on') }}
      attributes:
        type: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].messageType }}
          {% else %} {{ none }}
          {% endif %}
        title: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].event|title }}
          {% else %} {{ none }}
          {% endif %}
        severity: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].severity|lower }}
          {% else %} {{ none }}
          {% endif %}
        condition: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].event }}
          {% else %} {{ none }}
          {% endif %}
        description: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {% set headline = state_attr('sensor.noaa_alerts_miz076','alerts')[0].parameters.NWSheadline %}
            {% set inst = state_attr('sensor.noaa_alerts_miz076','alerts')[0].instruction %}
            {{ headline[0] ~ '.' if headline != none }}
            {{ inst ~ '.' if inst != none }}
          {% else %} {{ none }}
          {% endif %}
        starts: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {% if state_attr('sensor.noaa_alerts_miz076','alerts')[0].onset != none %}
              {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].onset|as_datetime|as_local }}
            {% else %} {{ none }}
            {% endif %}
          {% else %} {{ none }}
          {% endif %}
        ends: >
          {% if is_state(this.entity_id,'on')
              and state_attr('sensor.noaa_alerts_miz076','alerts') != none
              and state_attr('sensor.noaa_alerts_miz076','alerts')[0] is defined %}
            {% if state_attr('sensor.noaa_alerts_miz076','alerts')[0].expires != none %}
              {{ state_attr('sensor.noaa_alerts_miz076','alerts')[0].expires|as_datetime|as_local }}
            {% else %} {{ none }}
            {% endif %}
          {% else %} {{ none }}
          {% endif %}
        starts_text: >
          {% if is_state(this.entity_id,'on')
              and state_attr(this.entity_id,'starts') != none %}
            {% set starts = state_attr(this.entity_id,'starts')|as_datetime|as_local %}
            {% set today = starts.day == now().day %}
            {% set tomorrow = starts.day == (starts + timedelta(days=1)).day %}
            {% set begins = 'today' if today else 'tomorrow' if tomorrow else starts.strftime('%A') %}
            {{ begins ~ ' at ' ~ starts.strftime('%-I:%M %p') }}
          {% else %} {{ none }}
          {% endif %}
        ends_text: >
          {% if is_state(this.entity_id,'on')
              and state_attr('binary_sensor.noaa_weather_alert','ends') != none %}
            {% set ends = state_attr('binary_sensor.noaa_weather_alert','ends')|as_datetime|as_local %}
            {% set today = ends.day == now().day %}
            {% set tomorrow = ends.day == (ends + timedelta(days=1)).day %}
            {% set until = 'today' if today else 'tomorrow' if tomorrow else ends.strftime('%A') %}
            {{ until ~ ' at ' ~ ends.strftime('%-I:%M %p') }}
          {% else %} {{ none }}
          {% endif %}
        active: >
          {% if is_state('binary_sensor.noaa_weather_alert','on')
              and state_attr('binary_sensor.noaa_weather_alert','starts') != none %}
            {{ now() > state_attr('binary_sensor.noaa_weather_alert','starts')|as_datetime }}
          {% endif %}
