###############################################################################
## Templates - EnvCan
## severity values: warning, watch, advisory, statement
###############################################################################
- binary_sensor:
    - name: "EnvCan Connected"
      unique_id: envcan_connected
      icon: mdi:weather-partly-snowy-rainy
      device_class: connectivity
      state: "{{ states('weather.windsor') not in ['unknown','unavailable'] }}"

    - name: "EnvCan Connected Alert"
      unique_id: envcan_connected_alert
      icon: mdi:weather-partly-snowy-rainy
      state: >
        {{ not is_state('binary_sensor.envcan_connected','on')
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and is_state('binary_sensor.wan_connected','on') }}

    - name: "EnvCan Weather Alert"
      unique_id: envcan_weather_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: >
        {{ (states('sensor.windsor_statements')|int(-1) > 0
              or states('sensor.windsor_advisories')|int(-1) > 0
              or states('sensor.windsor_watches')|int(-1) > 0
              or states('sensor.windsor_warnings')|int(-1) > 0)
            and is_state('input_boolean.weather_alerts','on') }}
      attributes:
        severity: >
          {% if states('sensor.windsor_warnings')|int(-1) > 0 %} warning
          {% elif states('sensor.windsor_watches')|int(-1) > 0 %} watch
          {% elif states('sensor.windsor_advisories')|int(-1) > 0 %} advisory
          {% elif states('sensor.windsor_statements')|int(-1) > 0 %} statement
          {% else %} {{ none }}
          {% endif %}
        title: >
          {% set severity = state_attr('binary_sensor.envcan_weather_alert','severity') %}
          {% if severity == 'warning' %} {{ state_attr('sensor.windsor_warnings','alert_1')|title }}
          {% elif severity == 'watch' %} {{ state_attr('sensor.windsor_watches','alert_1')|title }}
          {% elif severity == 'advisory' %} {{ state_attr('sensor.windsor_advisories','alert_1')|title }}
          {% elif severity == 'statement' %} {{ state_attr('sensor.windsor_statements','alert_1')|title }}
          {% else %} {{ none }}
          {% endif %}
        description: > #DARKSKY
          {% set desc = state_attr('sensor.dark_sky_alerts','description_1') %}
          {% if desc != none %} {{ desc.split('###')[0] }}
          {% else %} {{ none }}
          {% endif %}
        alert_time: >
          {% set severity = state_attr('binary_sensor.envcan_weather_alert','severity') %}
          {% if severity == 'warning' %} {{ state_attr('sensor.windsor_warnings','alert_time_1')|title }}
          {% elif severity == 'watch' %} {{ state_attr('sensor.windsor_watches','alert_time_1')|title }}
          {% elif severity == 'advisory' %} {{ state_attr('sensor.windsor_advisories','alert_time_1')|title }}
          {% elif severity == 'statement' %} {{ state_attr('sensor.windsor_statements','alert_time_1')|title }}
          {% else %} {{ none }}
          {% endif %}
        expires: > #DARKSKY
          {% set expires = state_attr('sensor.dark_sky_alerts','expires_1') %}
          {% if expires == none %}
            {% set expires = state_attr('sensor.dark_sky_alerts','expires') %}
          {% endif %}
          {% if expires != none %}
            {% set expires = expires|as_datetime|as_local %}
          {% else %} {{ none }}
          {% endif %}
        expires_text: >
          {% set expires = state_attr('binary_sensor.envcan_weather_alert','expires') %}
          {% if expires != none %}
            {% set expires = expires|as_datetime|as_local %}
            {% set today = expires.day == now().day %}
            {% set tomorrow = expires.day == (expires + timedelta(days=1)).day %}
            {% set until = 'today' if today else 'tomorrow' if tomorrow else expires.strftime('%A') %}
            {{ until ~ ' at ' ~ expires.strftime('%-I:%M %p') }}
          {% endif %}
      availability: "{{ is_state('binary_sensor.envcan_connected','on') }}"

- sensor:
    - name: "Windsor Apparent Temperature"
      unique_id: windsor_apparent_temperature
      icon: mdi:thermometer
      device_class: temperature
      state_class: measurement
      unit_of_measurement: "Â°C"
      state: >
        {% if is_number(states('sensor.windsor_humidex')) %} {{ states('sensor.windsor_humidex')|int }}
        {% elif is_number(states('sensor.windsor_wind_chill')) %} {{ states('sensor.windsor_wind_chill')|int }}
        {% elif is_number(states('sensor.windsor_temperature')) %} {{ states('sensor.windsor_temperature')|int }}
        {% else %} {{ none }}
        {% endif %}
      availability: >
        {{ is_number(states('sensor.windsor_humidex'))
            or is_number(states('sensor.windsor_wind_chill'))
            or is_number(states('sensor.windsor_temperature')) }}

    - name: "Windsor Wind Gust Display"
      unique_id: windsor_wind_gust_display
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: >
        {% if is_number(states('sensor.windsor_wind_gust')) %} {{ states('sensor.windsor_wind_gust')|int }}
        {% elif is_number(states('sensor.windsor_wind_speed')) %} {{ states('sensor.windsor_wind_speed')|int }}
        {% else %} {{ none }}
        {% endif %}
      availability: >
        {{ is_number(states('sensor.windsor_wind_gust'))
            or is_number(states('sensor.windsor_wind_speed')) }}
