###############################################################################
## Templates - Air Quality
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: time_pattern
      minutes: "/1"
  binary_sensor:
    - name: "WAQI Connected"
      unique_id: waqi_connected
      picture: !secret WAQI_ICON
      device_class: connectivity
      state: "{{ integration_entities('waqi') | select('has_value') | list | count > 0 }}"

- binary_sensor:
    - name: "WAQI Connected Alert"
      unique_id: waqi_connected_alert
      device_class: problem
      delay_on: 300
      state: >
        {{ is_state('binary_sensor.waqi_connected', 'off')
            and is_state('input_boolean.weather_alerts', 'on') }}

    - name: "Air Quality Alert"
      unique_id: air_quality_alert
      icon: mdi:smog
      state: >
        {{ is_state('sensor.aqi_risk_level', ['Very Unhealthy', 'Unhealthy', 'Unhealthy Sensitive Groups'])
            and is_state('input_boolean.weather_alerts', 'on') }}
      availability: "{{ has_value('sensor.aqi_risk_level') }}"
