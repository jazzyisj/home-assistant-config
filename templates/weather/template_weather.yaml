###############################################################################
## Templates - Weather
###############################################################################
- binary_sensor:
    - name: 'Weather Alert Active'
      unique_id: weather_alert_active
      state: >
        {{ is_state('binary_sensor.noaa_weather_alert','on')
            or is_state('binary_sensor.envcan_weather_alert','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Weather LED Active'
      unique_id: weather_led_alert
      state: >
        {{ is_state('binary_sensor.envcan_weather_alert','on')
            or is_state('binary_sensor.noaa_weather_alert','on')
            or is_state('binary_sensor.outdoor_low_temperature_alert','on')
            or is_state('binary_sensor.outdoor_high_temperature_alert','on')
            or is_state('binary_sensor.storm_approaching_alert','on') }}

    - name: 'Outdoor High Temperature Alert'
      unique_id: outdoor_high_temperature_alert
      state: >
        {{ states('sensor.outdoor_apparent_temperature')|int
              > states('input_number.outdoor_high_temperature_threshold')|int
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ is_number(states('sensor.outdoor_apparent_temperature')) }}"

    - name: 'Outdoor Low Temperature Alert'
      unique_id: outdoor_low_temperature_alert
      state: >
        {{ states('sensor.outdoor_apparent_temperature')|int
              < states('input_number.outdoor_low_temperature_threshold')|int
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ is_number(states('sensor.outdoor_apparent_temperature')) }}"

    - name: 'Outdoor Temperature Alert'
      unique_id: outdoor_temperature_alert # for weather card
      icon: >
        {% if is_state('binary_sensor.outdoor_high_temperature_alert','on') %} mdi:thermometer-alert
        {% elif is_state('binary_sensor.outdoor_low_temperature_alert','on') %} mdi:thermometer-alert
        {% else %} mdi:thermometer
        {% endif %}
      state: >
        {{ is_state('binary_sensor.outdoor_high_temperature_alert','on')
            or is_state('binary_sensor.outdoor_low_temperature_alert','on') }}
      attributes:
        type: >
          {% if is_state('binary_sensor.outdoor_high_temperature_alert','on') %} Heat
          {% elif is_state('binary_sensor.outdoor_low_temperature_alert','on') %} Cold
          {% else %} Off
          {% endif %}
      availability: >
        {{ states('binary_sensor.outdoor_high_temperature_alert') not in ['unknown','unavailable']
            and states('binary_sensor.outdoor_low_temperature_alert') not in ['unknown','unavailable'] }}

    - name: 'Strong Wind Alert'
      unique_id: strong_wind_alert
      icon: mdi:weather-windy
      state: >
        {{ (states('sensor.wind_speed')|int >= 40 or states('sensor.wind_gust')|int >= 50)
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ is_number(states('sensor.wind_speed')) and is_number(states('sensor.wind_gust')) }}"

    - name: 'Storm Aproaching Alert'
      unique_id: storm_approaching_alert #DARKSKY
      icon: mdi:weather-lightning-rainy
      state: >
        {{ states('sensor.precipitation_probability')|int >= 30
            and states('sensor.nearest_storm_distance')|int < 5
            and is_state('input_boolean.weather_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: >
        {{ is_number(states('sensor.precipitation_probability'))
            and is_number(states('sensor.nearest_storm_distance')) }}

    - name: 'Tornado Alert'
      unique_id: tornado_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: > #VERIFY
        {{ ('tornado' in state_attr('binary_sensor.envcan_weather_alert','alert_1')|lower
              and is_state_attr('binary_sensor.envcan_weather_alert','severity','warning'))
            or (is_state_attr('binary_sensor.noaa_weather_alert','condition','tornado')
              and state_attr('binary_sensor.noaa_weather_alert','severity') in ['severe','extreme']) }}
      availability: >
        {{ states('binary_sensor.envcan_weather_alert') not in ['unknown','unavailable']
            or states('binary_sensor.noaa_weather_alert') not in ['unknown','unavailable'] }}

    - name: 'Rain Today'
      unique_id: rain_today # next 12 hours
      icon: mdi:weather-pouring
      state: >
        {% set found = namespace(value=0) %}
        {% if is_state('sensor.precipitation_type','rain') %}
          {% set threshold = 25 %}
          {% set forecast = state_attr('weather.home_hourly','forecast') %}
          {% for item in forecast %}
            {% if loop.index0 < 12 and item.precipitation_probability|int(-1) >= threshold %}
              {% set found.value = 1 %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {{ found.value == 1 }}
      availability: >
        {{ (state_attr('weather.home_hourly','forecast')|lower not in ['','[]','none']
            and state_attr('weather.home_hourly','forecast')[0] is defined) }}

    ###############################################################################
    ## GDACS alerts are sorted by alert_level then effective date
    ###############################################################################
    - name: 'GDACS Alert Active'
      unique_id: gdacs_alert_active
      icon: mdi:pulse
      state: "{{ states('sensor.gdacs_alerts')|int(-1) > 0 }}"
      attributes:
        last_alert: > # sensor can be > 0 but no geo_location entities
          {% if states.geo_location|selectattr('attributes.source','eq','gdacs')|list|count|int(-1) > 0 %}
            {{ states.geo_location|selectattr('attributes.source','eq','gdacs')
                |sort(reverse=true,attribute='attributes.from_date')
                |map(attribute='attributes.friendly_name')|first }}
          {% endif %}
        last_alert_desc: >
          {% if states.geo_location|selectattr('attributes.source','eq','gdacs')|list|count|int(-1) > 0 %}
            {{ states.geo_location|selectattr('attributes.source','eq','gdacs')
                |sort(reverse=true,attribute='attributes.from_date')
                |map(attribute='attributes.description')|first }}
          {% endif %}
        last_alert_date: >
          {% if states.geo_location|selectattr('attributes.source','eq','gdacs')|list|count|int(-1) > 0 %}
            {% set last_date = states.geo_location|selectattr('attributes.source','eq','gdacs')
                |sort(reverse=true,attribute='attributes.from_date')
                |map(attribute='attributes.from_date')|first %}
            {{ last_date|as_timestamp(none)|timestamp_custom('%Y-%m-%d',true,none) }}
          {% endif %}
        last_alert_severity: >
          {% if states.geo_location|selectattr('attributes.source','eq','gdacs')|list|count|int(-1) > 0 %}
            {{ states.geo_location|selectattr('attributes.source','eq','gdacs')
                |sort(reverse=true, attribute='attributes.from_date')
                |map(attribute='attributes.alert_level')|first }}
          {% endif %}
      availability: "{{ states('sensor.gdacs_alerts') not in ['unknown','unavailable'] }}"

- sensor:
    - name: 'Temperature Trend'
      unique_id: temperature_trend # for weather card
      icon: >
        {% if is_state('binary_sensor.temperature_rising','on') %} mdi:arrow-up-circle
        {% elif is_state('binary_sensor.temperature_falling','on') %} mdi:arrow-down-circle
        {% else %} mdi:minus-circle
        {% endif %}
      state: >
        {% if is_state('binary_sensor.temperature_rising','on') %} Rising
        {% elif is_state('binary_sensor.temperature_falling','on') %} Falling
        {% else %} Steady
        {% endif %}
      availability: >
        {{ states('binary_sensor.temperature_rising') not in ['unknown','unavailable']
            and states('binary_sensor.temperature_falling') not in ['unknown','unavailable'] }}

    - name: 'Pressure Trend'
      unique_id: pressure_trend # for weather card
      icon: >
        {% if is_state('binary_sensor.pressure_rising','on') %} mdi:arrow-up-circle
        {% elif is_state('binary_sensor.pressure_falling','on') %} mdi:arrow-down-circle
        {% else %} mdi:minus-circle
        {% endif %}
      state: >
        {% if is_state('binary_sensor.pressure_rising','on') %} Rising
        {% elif is_state('binary_sensor.pressure_falling','on') %} Falling
        {% else %} Steady
        {% endif %}
      availability: >
        {{ states('binary_sensor.pressure_rising') not in ['unknown','unavailable']
            and states('binary_sensor.pressure_falling') not in ['unknown','unavailable'] }}

    - name: 'Moon Phases'
      unique_id: moon_phases
      picture: >
        {% if is_state('sensor.moon','new_moon') %} /local/images/moon_phases/new_moon.jpg
        {% elif is_state('sensor.moon','waxing_crescent') %} /local/images/moon_phases/waxing_crescent.jpg
        {% elif is_state('sensor.moon','first_quarter') %} /local/images/moon_phases/first_quarter.jpg
        {% elif is_state('sensor.moon','waxing_gibbous') %} /local/images/moon_phases/waxing_gibbous.jpg
        {% elif is_state('sensor.moon','full_moon') %} /local/images/moon_phases/full_moon.jpg
        {% elif is_state('sensor.moon','waning_gibbous') %} /local/images/moon_phases/waning_gibbous.jpg
        {% elif is_state('sensor.moon','last_quarter') %} /local/images/moon_phases/last_quarter.jpg
        {% elif is_state('sensor.moon','waning_crescent') %} /local/images/moon_phases/waning_crescent.jpg
        {% endif %}
      state: "{{ states('sensor.moon')|replace('_',' ')|title }}"

    #NOTE
    # lightning
    # hail
    # snowy-rainy
    # windy-variant
    # exceptional

    #IDEA add icons for extra values - req custom weather card
    # weatherflow, envcan, nws, #DARKSKY
    - name: 'Current Condition'
      unique_id: current_condition
      icon: mdi:weather-partly-rainy
      state: >
        {% if states('weather.weatherflow_day_based_forecast') not in ['unknown','unavailable'] %}
          {% set condition = states('weather.weatherflow_day_based_forecast') %}
        {% elif states('weather.windsor') not in ['unknown','unavailable'] %}
          {% set condition = states('weather.windsor') %}
        {% elif states('weather.kdtw_hourly') not in ['unknown','unavailable'] %}
          {% set condition = states('weather.kdtw_hourly') %}
        {% elif states('sensor.dark_sky_icon') not in ['unknown','unavailable'] %}
          {% set condition = states('sensor.dark_sky_icon') %}
        {% endif %}

        {% if condition|lower == 'clear' and is_state('sensor.day_night','Day') %} sunny
        {% elif condition|lower == 'clear' and is_state('sensor.day_night','Night') %} clear-night
        {% elif condition|lower in ['mainly clear','mainly sunny','clear-day'] %} sunny
        {% elif condition|lower == 'mist' %} fog
        {% elif condition|lower in ['haze','partly cloudy','partly-cloudy-day','partly-cloudy-night'] %} partlycloudy
        {% elif condition|lower == 'mostly cloudy' %} cloudy
        {% elif condition|lower in ['light rain','rain'] %} rainy
        {% elif condition|lower in ['light snow','snow'] %} snowy
        {% elif condition|lower == 'thunderstorm' %} lightning-rainy
        {% elif condition|lower == 'heavy rain' %} pouring
        {% elif condition|lower == 'precipitation' %} rainy
        {% elif condition|lower == 'wind' %} windy
        {% else %} {{ condition|lower }}
        {% endif %}
      attributes:
        provider: >
          {% if states('weather.weatherflow_day_based_forecast') not in ['unknown','unavailable'] %} Weatherflow
          {% elif states('weather.windsor') not in ['unknown','unavailable'] %} Environment Canada
          {% elif states('weather.kdtw_hourly') not in ['unknown','unavailable'] %} National Weather Service
          {% elif states('sensor.dark_sky_icon') not in ['unknown','unavailable'] %} Dark Sky
          {% endif %}
      availability: >
        {{ states('weather.weatherflow_day_based_forecast') not in ['unknown','unavailable']
            or states('weather.windsor') not in ['unknown','unavailable']
            or states('weather.kdtw_hourly') not in ['unknown','unavailable']
            or states('sensor.dark_sky_icon') not in ['unknown','unavailable'] }}

    # weatherflow, envcan, nws
    - name: 'Outdoor Temperature'
      unique_id: outdoor_temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_temperature')) %}
          {{ states('sensor.tempest_st_00057689_temperature')|float }}
        {% elif is_number(states('sensor.windsor_temperature')) %}
          {{ states('sensor.windsor_temperature')|float }}
        {% elif is_number(states('sensor.kdtw_temperature')) %}
          {{ states('sensor.kdtw_temperature')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_temperature')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_temperature')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_temperature')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_temperature'))
          or is_number(states('sensor.windsor_temperature'))
          or is_number(states('sensor.kdtw_temperature')) }}

    # weatherflow, envcan, nws
    - name: 'Outdoor Apparent Temperature'
      unique_id: outdoor_apparent_temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_feels_like_temperature')) %}
          {{ states('sensor.tempest_st_00057689_feels_like_temperature')|float }}
        {% elif is_number(states('sensor.windsor_apparent_temperature')) %}
          {{ states('sensor.windsor_apparent_temperature')|float }}
        {% elif is_number(states('sensor.kdtw_apparent_temperature')) %}
          {{ states('sensor.kdtw_apparent_temperature')|float }}
        {% else %}
          {{ states('sensor.outdoor_temperature')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_feels_like_temperature')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_apparent_temperature')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_apparent_temperature')) %} National Weather Service
          {% else %} Outdoor Temp
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_feels_like_temperature'))
            or is_number(states('sensor.windsor_apparent_temperature'))
            or is_number(states('sensor.kdtw_apparent_temperature'))
            or is_number(states('sensor.outdoor_temperature')) }}

    # envcan
    - name: 'Outdoor High Temperature'
      unique_id: outdoor_high_temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {% if state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].temperature) %}
          {{ state_attr('weather.home_daily','forecast')[0].temperature|float }}
        {% elif is_number(states('sensor.windsor_high_temperature')) %}
          {{ states('sensor.windsor_high_temperature')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if state_attr('weather.home_daily','forecast')[0] is defined
              and is_number(state_attr('weather.home_daily','forecast')[0].temperature) %} Daily Forecast
          {% elif is_number(states('sensor.windsor_high_temperature')) %} Environment Canada
          {% endif %}
      availability: >
        {{ (state_attr('weather.home_daily','forecast')[0] is defined
              and is_number(state_attr('weather.home_daily','forecast')[0].temperature))
            or is_number(states('sensor.windsor_high_temperature')) }}

    # daily, envcan
    - name: 'Outdoor Low Temperature'
      unique_id: outdoor_low_temperature
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {% if state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].temperature) %}
          {{ state_attr('weather.home_daily','forecast')[0].templow|float }}
        {% elif is_number(states('sensor.windsor_low_temperature')) %}
          {{ states('sensor.windsor_low_temperature')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if state_attr('weather.home_daily','forecast')[0] is defined
              and is_number(state_attr('weather.home_daily','forecast')[0].templow) %} Daily Forecast
          {% elif is_number(states('sensor.windsor_low_temperature')) %} Environment Canada
          {% endif %}
      availability: >
        {{ (state_attr('weather.home_daily','forecast')[0] is defined
              and is_number(state_attr('weather.home_daily','forecast')[0].templow))
            or is_number(states('sensor.windsor_low_temperature')) }}

    # envcan
    - name: 'Outdoor High Temperature Differential'
      unique_id: outdoor_high_temperature_differential
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {{ states('sensor.outdoor_high_temperature')|int
            - states('sensor.windsor_normal_high_temperature')|int }}
      availability: >
        {{ is_number(states('sensor.windsor_normal_high_temperature'))
            and is_number(states('sensor.outdoor_high_temperature')) }}

    # envcan
    - name: 'Outdoor Low Temperature Differential'
      unique_id: outdoor_low_temperature_differential
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {{ states('sensor.outdoor_low_temperature')|int
            - states('sensor.windsor_normal_low_temperature')|int }}
      availability: >
        {{ is_number(states('sensor.windsor_normal_low_temperature'))
            and is_number(states('sensor.outdoor_low_temperature')) }}

    # weatherflow, envcan, nws
    - name: 'Dew Point'
      unique_id: dew_point
      device_class: temperature
      state_class: measurement
      unit_of_measurement: °C
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_dew_point')) %}
          {{ states('sensor.tempest_st_00057689_dew_point')|float }}
        {% elif is_number(states('sensor.windsor_dewpoint')) %}
          {{ states('sensor.windsor_humidex')|float }}
        {% elif is_number(states('sensor.kdtw_dew_point')) %}
          {{ states('sensor.kdtw_dew_point')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_dew_point')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_dewpoint')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_dew_point')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_dew_point'))
            or is_number(states('sensor.windsor_dewpoint'))
            or is_number(states('sensor.kdtw_dew_point')) }}

    # weatherflow, envcan, nws, #DARKSKY
    - name: 'Outdoor Humidity'
      unique_id: outdoor_humidity
      device_class: humidity
      state_class: measurement
      unit_of_measurement: '%'
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_humidity')) %}
          {{ states('sensor.tempest_st_00057689_humidity')|int }}
        {% elif is_number(states('sensor.windsor_humidity')) %}
          {{ states('sensor.windsor_humidity')|int }}
        {% elif is_number(states('sensor.kdtw_relative_humidity')) %}
          {{ states('sensor.kdtw_relative_humidity')|int }}
        {% elif is_number(states('sensor.dark_sky_humidity')) %}
          {{ states('sensor.dark_sky_humidity') }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_humidity')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_humidity')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_relative_humidity')) %} National Weather Service
          {% elif is_number(states('sensor.dark_sky_humidity')) %} Dark Sky
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_humidity'))
            or is_number(states('sensor.windsor_humidity'))
            or is_number(states('sensor.kdtw_relative_humidity'))
            or is_number(states('sensor.dark_sky_humidity')) }}

    #DARKSKY
    - name: 'Outdoor Humidity Today'
      unique_id: outdoor_humidity_today
      device_class: humidity
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states('sensor.dark_sky_humidity_0d')|int }}"
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_humidity_0d')) }}"

    #WF sensor.tempest_st_00057689_precipitation_probability
    - name: 'Precipitation Probability'
      unique_id: precipitation_probability
      icon: mdi:weather-rainy
      state_class: measurement
      unit_of_measurement: '%'
      state: >
        {% if state_attr('weather.home_hourly','forecast')[0] is defined
            and is_number(state_attr('weather.home_hourly','forecast')[0].precipitation_probability) %}
          {{ state_attr('weather.home_hourly','forecast')[0].precipitation_probability|int }}
        {% endif %}
      attributes:
        provider: Hourly Forecast
      availability: >
        {{ state_attr('weather.home_hourly','forecast')[0] is defined
            and is_number(state_attr('weather.home_hourly','forecast')[0].precipitation_probability) }}

    - name: 'Precipitation Probability Today'
      unique_id: precipitation_probability_today
      icon: mdi:weather-rainy
      state_class: measurement
      unit_of_measurement: '%'
      state: >
        {% if state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].precipitation_probability) %}
          {{ state_attr('weather.home_daily','forecast')[0].precipitation_probability|int }}
        {% endif %}
      attributes:
        provider: Daily Forecast
      availability: >
        {{ state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].precipitation_probability) }}

    # weatherflow, #DARKSKY
    - name: 'Precipitation Intensity'
      unique_id: precipitation_intensity
      icon: mdi:weather-pouring
      state_class: measurement
      unit_of_measurement: mm/hr
      #WF sensor.tempest_st_00057689_rain_intensity
      # sensor.weatherflow_precipitation_intensity
      # sensor.weatherflow_precipitation_rate
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_rain_rate')) %}
          {{ states('sensor.tempest_st_00057689_rain_rate')|float }}
        {% elif is_number(states('sensor.dark_sky_precip_intensity')) %}
          {{ states('sensor.dark_sky_precip_intensity')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_rain_rate')) %} Weatherflow
          {% elif is_number(states('sensor.dark_sky_precip_intensity')) %} Dark Sky
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_rain_rate'))
            or is_number(states('sensor.dark_sky_precip_intensity')) }}

    # weatherflow
    - name: 'Precipitation Today'
      unique_id: precipitation_today
      icon: mdi:weather-pouring
      state_class: measurement
      unit_of_measurement: mm
      #WF sensor.weatherflow_precipitation_today
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_rain_today')) %}
          {{ states('sensor.tempest_st_00057689_rain_today')|float }}
        {% endif %}
      attributes:
        provider: Weatherflow
      availability: "{{ is_number(states('sensor.tempest_st_00057689_rain_today')) }}"

    # weatherflow, envcan
    - name: 'Precipitation Yesterday'
      unique_id: precipitation_yesterday
      icon: mdi:weather-pouring
      state_class: measurement
      unit_of_measurement: mm
      #WF sensor.weatherflow_precipitation_yesterday
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_rain_yesterday')) %}
          {{ states('sensor.tempest_st_00057689_rain_yesterday')|float }}
        {% elif is_number(states('sensor.windsor_precipitation_yesterday')) %}
          {{ states('sensor.windsor_precipitation_yesterday')|float }}
        {% else %} 0
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_rain_yesterday')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_precipitation_yesterday')) %} Environment Canada
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_rain_yesterday'))
            or is_number(states('sensor.windsor_precipitation_yesterday')) }}

    - name: 'Precipitation Type'
      unique_id: precipitation_type
      icon: mdi:weather-rainy
      state: > #VERIFY
        {{ 'rain' if is_state('binary_sensor.weatherflow_is_freezing','off')
              or states('sensor.weatherflow_freezing_line')|int(-1) > 0
              or states('sensor.tempest_st_00057689_freezing_level_altitude')|int(-1) > 0
            else 'snow' }}
      availability: >
        {{ states('binary_sensor.weatherflow_is_freezing') not in ['unknown','unavailable']
            or is_number(states('sensor.weatherflow_freezing_line'))
            or is_number(states('sensor.tempest_st_00057689_freezing_level_altitude')) }}

    #DARKSKY
    - name: 'Nearest Storm Bearing'
      unique_id: nearest_storm_bearing
      state: "{{ states('sensor.dark_sky_nearest_storm_bearing')|float(none) }}"
      state_class: measurement
      unit_of_measurement: '°'
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_nearest_storm_bearing')) }}"

    #DARKSKY
    - name: 'Nearest Storm Distance'
      unique_id: nearest_storm_distance
      state_class: measurement
      unit_of_measurement: km
      state: "{{ states('sensor.dark_sky_nearest_storm_distance')|int(none) }}"
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_nearest_storm_distance')) }}"

    #DARKSKY
    - name: 'Storm Full Direction'
      unique_id: storm_full_direction
      state: >
        {% set directions = ['North','North-Northeast','Northeast','East-Northeast','East','East-Southeast',
            'Southeast','South-Southeast','South','South-Southwest','Southwest','West-Southwest','West',
            'West-Northwest','Northwest','North-Northwest','North'] %}
        {{ directions[((states('sensor.nearest_storm_bearing')|float(-1)/360)|float*16)|round] }}
      attributes:
        provider: "{{ state_attr('sensor.nearest_storm_bearing','provider') }}"
      availability: "{{ is_number(states('sensor.nearest_storm_bearing')) }}"

    # weatherflow, envcan, nws
    - name: 'Barometric Pressure'
      unique_id: barometric_pressure
      device_class: pressure
      state_class: measurement
      unit_of_measurement: hPa # unit conversion - nws: pa-> hpa, envcan kPa -> hPa
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_sea_level_pressure')) %}
          {{ states('sensor.tempest_st_00057689_sea_level_pressure')|float }}
        {% elif is_number(states('sensor.windsor_pressure')) %}
          {{ states('sensor.windsor_pressure')|float * 10 }}
        {% elif is_number(states('sensor.kdtw_barometric_pressure')) %}
          {{ states('sensor.kdtw_barometric_pressure')|float/100 }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_sea_level_pressure')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_pressure')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_sea_level_pressure')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_sea_level_pressure'))
            or is_number(states('sensor.windsor_pressure'))
            or is_number(states('sensor.kdtw_sea_level_pressure')) }}

    # weatherflow, envcan, nws
    - name: 'Wind Speed'
      unique_id: wind_speed
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_wind_speed')) %}
          {{ states('sensor.tempest_st_00057689_wind_speed')|float }}
        {% elif is_number(states('sensor.windsor_wind_speed')) %}
          {{ states('sensor.windsor_wind_speed')|float }}
        {% elif is_number(states('sensor.kdtw_wind_speed')) %}
          {{ states('sensor.kdtw_wind_speed')|float }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_wind_speed')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_wind_speed')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_wind_speed')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_wind_speed'))
            or is_number(states('sensor.windsor_wind_speed'))
            or is_number(states('sensor.kdtw_wind_speed')) }}

    - name: 'Wind Speed Today'
      unique_id: wind_speed_today
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: >
        {% if state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].wind_speed) %}
          {{ state_attr('weather.home_daily','forecast')[0].wind_speed|int }}
        {% endif %}
      attributes:
        provider: Daily Forecast
      availability: >
        {{ state_attr('weather.home_daily','forecast')[0] is defined
            and is_number(state_attr('weather.home_daily','forecast')[0].wind_speed) }}

    # weatherflow, envcan, nws, #DARKSKY
    # defaults to wind speed
    - name: 'Wind Gust'
      unique_id: wind_gust
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_wind_gust')) %}
          {{ states('sensor.tempest_st_00057689_wind_gust')|float }}
        {% elif is_number(states('sensor.windsor_wind_gust')) %}
          {{ states('sensor.windsor_wind_gust')|float }}
        {% elif is_number(states('sensor.kdtw_wind_gust')) %}
          {{ states('sensor.kdtw_wind_gust')|float }}
        {% elif is_number(states('sensor.dark_sky_wind_gust')) %}
          {{ states('sensor.dark_sky_wind_gust')|float }}
        {% else %} {{ states('sensor.wind_speed')|int(none) }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_wind_gust')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_wind_gust')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_wind_gust')) %} National Weather Service
          {% elif is_number(states('sensor.dark_sky_wind_gust')) %} Dark Sky
          {% else %} Wind Speed
          {% endif %}
      availability: >
        {{ is_number(states('sensor.windsor_wind_gust'))
            or is_number(states('sensor.windsor_wind_speed'))
            or is_number(states('sensor.kdtw_wind_gust'))
            or is_number(states('sensor.dark_sky_wind_gust'))
            or is_number(states('sensor.wind_speed')) }}

    #DARKSKY
    - name: 'Wind Gust Today'
      unique_id: wind_gust_today
      icon: mdi:weather-windy
      state_class: measurement
      unit_of_measurement: km/h
      state: "{{ states('sensor.dark_sky_wind_gust_0d')|int(none) }}"
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_wind_gust_0d')) }}"

    # weatherflow, envcan, nws
    - name: 'Wind Bearing'
      unique_id: wind_bearing
      picture: >
        {% set directions = [0,11,22,33,45,56,67,78,90,101,112,123,135,146,157,168,180,191,
          202,213,225,236,247,258,270,281,292,303,315,326,337,348,0] %}
        /local/images/compass/{{ directions[((states('sensor.wind_bearing')|float(-1)/360)|float*32)|round] }}.png
      state_class: measurement
      unit_of_measurement: °
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_wind_bearing')) %}
          {{ states('sensor.tempest_st_00057689_wind_bearing')|float }}
        {% elif is_number(states('sensor.windsor_wind_bearing')) %}
          {{ states('sensor.windsor_wind_bearing')|float }}
        {% elif is_number(states('sensor.kdtw_wind_direction')) %}
          {{ states('sensor.kdtw_wind_direction')|float }}
        {% endif %}
      attributes:
        cardinal: >
          {% set directions = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW','N'] %}
          {{ directions[((states('sensor.wind_bearing')|float(-1)/360)|float*16)|round] }}
        full_cardinal: >
          {% set directions = ['North','North-Northeast','Northeast','East-Northeast','East','East-Southeast',
              'Southeast','South-Southeast','South','South-Southwest','Southwest','West-Southwest','West',
              'West-Northwest','Northwest','North-Northwest','North'] %}
          {{ directions[((states('sensor.wind_bearing')|float(-1)/360)|float*16)|round] }}
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_wind_bearing')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_wind_bearing')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_wind_direction')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_wind_bearing'))
            or is_number(states('sensor.windsor_wind_bearing'))
            or is_number(states('sensor.kdtw_wind_direction')) }}

    - name: 'Wind Condition Verbose'
      unique_id: wind_condition_verbose
      state: >
        {% set directions = ['North','North-Northeast','Northeast','East-Northeast','East','East-Southeast',
            'Southeast','South-Southeast','South','South-Southwest','Southwest','West-Southwest','West',
            'West-Northwest','Northwest','North-Northwest','North'] %}
        {{ states('sensor.wind_gust')|int }} kilometers per hour from the
        {{ state_attr('sensor.wind_bearing','full_cardinal') }}
      attributes:
        provider: "{{ state_attr('sensor.wind_bearing','provider') }}"
      availability: >
        {{ is_number(states('sensor.wind_gust'))
            and is_number(states('sensor.wind_bearing')) }}

    #DARKSKY
    - name: 'Cloud Cover'
      unique_id: cloud_cover
      icon: mdi:cloud
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states('sensor.dark_sky_cloud_coverage')|int(none) }}"
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_cloud_coverage')) }}"

    #DARKSKY
    - name: 'Cloud Cover Today'
      unique_id: cloud_cover_today
      icon: mdi:cloud
      state_class: measurement
      unit_of_measurement: '%'
      state: "{{ states('sensor.dark_sky_cloud_coverage_0d')|int(none) }}"
      attributes:
        provider: Dark Sky
      availability: "{{ is_number(states('sensor.dark_sky_cloud_coverage_0d')) }}"

    # weatherflow, envcan, nws
    - name: 'Visibility'
      unique_id: visibility
      icon: mdi:eye
      state_class: measurement
      unit_of_measurement: km
      state: >
        {% if is_number(states('sensor.tempest_st_00057689_visibility')) %}
          {{ states('sensor.tempest_st_00057689_visibility')|float }}
        {% elif is_number(states('sensor.windsor_visibility')) %}
          {{ states('sensor.windsor_visibility')|float }}
        {% elif is_number(states('sensor.kdtw_visibility')) %}
          {{ states('sensor.kdtw_visibility')|float/1000 }}
        {% endif %}
      attributes:
        provider: >
          {% if is_number(states('sensor.tempest_st_00057689_visibility')) %} Weatherflow
          {% elif is_number(states('sensor.windsor_visibility')) %} Environment Canada
          {% elif is_number(states('sensor.kdtw_visibility')) %} National Weather Service
          {% endif %}
      availability: >
        {{ is_number(states('sensor.tempest_st_00057689_visibility'))
            or is_number(states('sensor.windsor_visibility'))
            or is_number(states('sensor.kdtw_visibility')) }}
