###############################################################################
## Templates - Network
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: device_tracker.dining_room_hub_bt
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: device_tracker.dining_room_hub_bt
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Bluetooth Alert" #ISSUE this doesn't really detect if bluetooth actually running
      unique_id: bluetooth_alert
      icon: mdi:bluetooth-off
      device_class: problem
      delay_on: 300 # allow devices to connect, prevent alert at startup
      state: >
        {{ states.device_tracker|selectattr('attributes.device_type','defined')
              |selectattr('attributes.device_type','eq','bluetooth')
              |selectattr('state','eq','home')|list|count == 0 }}

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.rt_ax58u_connected_devices
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: sensor.rt_ax58u_connected_devices
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Asus Router Connected"
      unique_id: asus_router_connected
      icon: mdi:router-wireless
      device_class: connectivity
      state: >
        {{ expand(integration_entities('asusrouter'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.speedtest_download
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: sensor.speedtest_download
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Speedtest Connected"
      unique_id: speedtest_connected
      icon: mdi:speedometer
      device_class: connectivity
      state: >
        {{ expand(integration_entities('speedtestdotnet'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- binary_sensor:
    - name: "Asus Router Connected Alert"
      unique_id: asus_router_connected_alert
      icon: mdi:smog
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.asus_router_connected','off')
            and is_state('input_boolean.network_alerts','on') }}

    - name: "WIFI AP Upstairs Connected Alert"
      unique_id: wifi_ap_upstairs_connected_alert
      icon: mdi:wifi
      device_class: problem
      delay_on: 60
      state: >
        {{ not is_state('device_tracker.wifi_ap_upstairs','home')
            and is_state('input_boolean.network_alerts','on') }}

    - name: "WIFI AP Garage Connected Alert"
      unique_id: wifi_ap_garage_connected_alert
      icon: mdi:wifi
      device_class: problem
      delay_on: 60
      state: >
        {{ not is_state('device_tracker.wifi_ap_garage','home')
            and is_state('input_boolean.network_alerts','on') }}

    - name: "Speedtest Connected Alert"
      unique_id: speedtest_connected_alert
      icon: mdi:speedometer
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.speedtest_connected','off')
            and is_state('input_boolean.network_alerts','on') }}

    - name: "WAN Connected Alert"
      unique_id: wan_connected_alert
      icon: mdi:wan
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.wan_connected','off')
            and is_state('input_boolean.network_alerts','on') }}

    - name: "Unknown Device Alert"
      unique_id: unknown_device_alert
      device_class: problem
      delay_on: 60 # triggers at startup if asus integration slow to connect
      state: >
        {{ states('sensor.unknown_devices')|int(0) > 0
            and is_state('input_boolean.network_alerts','on') }}
- sensor:
    - name: "Network Status"
      unique_id: network_status
      icon: mdi:home-assistant
      state: >
        {% if is_state('binary_sensor.wan_connected','off') %} critical
        {% elif  is_state('sensor.pi_hole_status','Disconnected') %} severe
        {% elif is_state('sensor.pi_hole_status','Disabled')
            or states('sensor.speedtest_download')|int(-1) < 100
            or states ('sensor.speedtest_upload')|int(-1) < 100
            or states('sensor.speedtest_ping')|int(-1) > 50
            or is_state('alert.unknown_devices','on') %} warning
        {% elif states('sensor.speedtest_download')|int(-1) < 150
            or states ('sensor.speedtest_upload')|int(-1) < 150
            or states('sensor.speedtest_ping')|int(-1) > 25 %} minor
        {% else %} ok
        {% endif %}

    - name: "Unknown Devices"
      unique_id: unknown_devices
      icon: mdi:devices
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id,'entity_id') %}
        {{ c|count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker
              |rejectattr('attributes.device_type','in',['wired','wireless','bluetooth','location'])
              |map(attribute='entity_id')|list }}

    - name: "Wireless Network Devices"
      unique_id: wireless_network_devices
      icon: mdi:access-point-network
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id,'entity_id') %}
        {{ c|count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker
              |selectattr('attributes.device_type','eq','wireless')
              |map(attribute='entity_id')|list }}

    - name: "Wired Network Devices"
      unique_id: wired_network_devices
      icon: mdi:router-network
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id,'entity_id') %}
        {{ c|count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker
              |selectattr('attributes.device_type','eq','wired')
              |map(attribute='entity_id')|list }}

    - name: "Bluetooth Devices"
      unique_id: bluetooth_devices
      icon: mdi:bluetooth-settings
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id,'entity_id') %}
        {{ c|count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker|selectattr('attributes.device_type','eq','bluetooth')
              |map(attribute='entity_id')|list }}

    - name: "HASS Data Recieved"
      unique_id: hass_gb_received
      icon: mdi:wifi
      state_class: total_increasing
      unit_of_measurement: GB # MiB to GB
      state: "{{ '%0.2f'|format(states('sensor.network_in_eth0')|float(-1)/953.6743164062) }}"
      availability: "{{ is_number(states('sensor.network_in_eth0')) }}"

    - name: "HASS Data Sent"
      unique_id: hass_gb_sent
      icon: mdi:wifi
      state_class: total_increasing
      unit_of_measurement: GB # MiB to GB
      state: "{{ '%0.2f'|format(states('sensor.network_out_eth0')|float(-1)/953.6743164062) }}"
      availability: "{{ is_number(states('sensor.network_out_eth0')) }}"

    - name: "HASS Received Speed"
      unique_id: hass_mbps_received
      icon: mdi:wifi
      state_class: measurement
      unit_of_measurement: Mbit/s # MB/s to Mbit/s
      state: "{{ '%0.2f'|format(states('sensor.network_throughput_in_eth0')|float(-1)*8) }}"
      availability: "{{ is_number(states('sensor.network_throughput_in_eth0')) }}"

    - name: "HASS Sent Speed"
      unique_id: hass_mbps_sent
      icon: mdi:wifi
      state_class: measurement
      unit_of_measurement: Mbit/s # MB/s to Mbit/s
      state: "{{ '%0.2f'|format(states('sensor.network_throughput_out_eth0')|float(-1)*8) }}"
      availability: "{{ is_number(states('sensor.network_throughput_out_eth0')) }}"
