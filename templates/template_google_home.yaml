###############################################################################
## Templates - Google Home
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.dining_room_hub_device
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: sensor.dining_room_hub_device
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Google Home Connected"
      unique_id: google_home_connected
      icon: mdi:speaker-play
      device_class: connectivity
      state: >
        {{ expand(integration_entities('google_home'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- binary_sensor:
    - name: "Google Home Connected Alert"
      unique_id: google_home_connected_alert
      icon: mdi:speaker-play
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.google_home_connected','off')
            and is_state('input_boolean.media_alerts','on')
            and is_state('binary_sensor.wan_connected','on') }}

- sensor:
    - name: "Bathroom Speaker Timer"
      unique_id: bathroom_speaker_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.bathroom_speaker_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.bathroom_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.bathroom_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    - name: "Bedroom Hub Timer"
      unique_id: bedroom_hub_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.bedroom_hub_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.bedroom_hub_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.bedroom_hub_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    - name: "Dining Room Hub Timer"
      unique_id: dining_room_hub_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.dining_room_hub_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.dining_room_hub_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.dining_room_hub_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    - name: "Garage Speaker Timer"
      unique_id: garage_speaker_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.garage_speaker_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.garage_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.garage_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    - name: "Laundry Room Speaker Timer"
      unique_id: laundry_room_speaker_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.laundry_room_speaker_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.laundry_room_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.laundry_room_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    - name: "Living Room Speaker Timer"
      unique_id: living_room_speaker_timer
      icon: mdi:timer
      state: >
        {% set entity = 'sensor.living_room_speaker_timers' %}
        {% if state_attr(entity,'timers') != none and state_attr(entity,'timers')[0] is defined %}
          {% set status = state_attr(entity,'timers')[0].status %}
          {% if status == 'set' %} active
          {% elif status == 'paused' %} paused
          {% elif status == 'waiting' %} waiting
          {% else %} idle
          {% endif %}
        {% endif %}
      attributes:
        duration: >
          {% set entity = 'sensor.living_room_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].duration if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        end_time: >
          {% set entity = 'sensor.living_room_speaker_timers' %}
          {{ state_attr(entity,'timers')[0].local_time_iso if state_attr(entity,'timers') != none
              and state_attr(entity,'timers')[0] is defined else none }}
        integration: google_home

    ###############################################################################
    ## Google Home - Next Alarm Sensors
    ###############################################################################
    - name: "Dining Room Hub Next Alarm"
      unique_id: dining_room_hub_next_alarm
      icon: "{{ iif(states('sensor.dining_room_hub_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.dining_room_hub_alarms','alarms')[0].fire_time|timestamp_local|as_datetime
            if is_state('input_boolean.dining_room_hub_alarm_clock_enabled','on')
              and state_attr('sensor.dining_room_hub_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.dining_room_hub_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Bedroom Hub Next Alarm"
      unique_id: bedroom_hub_next_alarm
      icon: "{{ iif(states('sensor.bedroom_hub_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.bedroom_hub_alarms','alarms')[0].fire_time|timestamp_local|as_datetime
            if is_state('input_boolean.bedroom_hub_alarm_clock_enabled','on')
              and state_attr('sensor.bedroom_hub_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.bedroom_hub_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Living Room Speaker Next Alarm"
      unique_id: living_room_speaker_next_alarm
      icon: "{{ iif(states('sensor.living_room_speaker_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.living_room_speaker_alarms','alarms')[0].fire_time|timestamp_local|as_datetime
            if is_state('input_boolean.living_room_speaker_alarm_clock_enabled','on')
              and state_attr('sensor.living_room_speaker_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.living_room_speaker_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Bathroom Speaker Next Alarm"
      unique_id: bathroom_speaker_next_alarm
      icon: "{{ iif(states('sensor.bathroom_speaker_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.bathroom_speaker_alarms','alarms')[0].fire_time|timestamp_local|as_datetime
            if is_state('input_boolean.bathroom_speaker_alarm_clock_enabled','on')
              and state_attr('sensor.bathroom_speaker_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.bathroom_speaker_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Garage Speaker Next Alarm"
      unique_id: garage_speaker_next_alarm
      icon: "{{ iif(states('sensor.garage_speaker_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.garage_speaker_alarms','alarms')[0].fire_time|timestamp_local|as_datetime
            if is_state('input_boolean.garage_speaker_alarm_clock_enabled','on')
              and state_attr('sensor.garage_speaker_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.garage_speaker_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Laundry Room Speaker Next Alarm"
      unique_id: laundry_room_speaker_next_alarm
      icon: "{{ iif(states('sensor.laundry_room_speaker_next_alarm') in ['unknown','unavailable'],'mdi:alarm-off','mdi:alarm-check') }}"
      device_class: timestamp
      state: >
        {{ state_attr('sensor.laundry_room_speaker_alarms','alarms')[0].fire_time|as_local
            if is_state('input_boolean.laundry_room_speaker_alarm_clock_enabled','on')
              and state_attr('sensor.laundry_room_speaker_alarms','alarms') not in ['[]',none] else none }}
      attributes:
        12hour: "{{ states('sensor.laundry_room_speaker_next_alarm')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"
