###############################################################################
## Templates - Alarm Clock
###############################################################################
- binary_sensor:
    - name: 'Alarm Clock'
      unique_id: alarm_clock
      icon: mdi:alarm-note
      delay_off: 2 # allow media player volumes to change, prevent automation.media_player_volume_changed trigger
      state: >
        {{ (is_state('switch.alarm_clock_auto','on')
            or is_state('switch.alarm_clock_manual','on')
            or is_state('switch.alarm_clock_nap','on'))
            and is_state('input_boolean.alarm_clock_failed','off') }}
      attributes:
        alarm_type: >
          {% if is_state('switch.alarm_clock_auto','on') %} auto
          {% elif is_state('switch.alarm_clock_manual','on') %} manual
          {% elif is_state('switch.alarm_clock_nap','on') %} nap
          {% endif %}

    - name: 'Alarm Clock Presence Alert'
      unique_id: alarm_clock_presence_alert
      icon: mdi:clock-alert
      delay_on: 30 # allow temporary switch on/off
      state: >
        {{ is_state('input_boolean.alarm_clock_alerts','on')
            and is_state('binary_sensor.alarm_clock','on')
            and (is_state('binary_sensor.someone_home','off')
              or is_state('input_select.occupancy_mode','Away')) }}

    - unique_id: alarm_clock_led_alert
      state: >
        {{ is_state('binary_sensor.alarm_clock','on')
            or is_state('input_boolean.alarm_clock_failed','on') }}

- sensor:
    - name: 'Alarm Clock Media Player'
      unique_id: alarm_clock_media_player
      icon: mdi:animation-play
      state: >
        {% if is_state('binary_sensor.alarm_clock','on') %}
          {% if is_state('switch.alarm_clock_auto','on') %}{% set player = states('input_select.alarm_clock_media_player_auto') %}
          {% elif is_state('switch.alarm_clock_manual','on') %}{% set player = states('input_select.alarm_clock_media_player_manual') %}
          {% elif is_state('switch.alarm_clock_nap','on') %}{% set player = states('input_select.alarm_clock_media_player_nap') %}
          {% endif %}
          {{ expand(state_attr('sensor.media_players','players'))
              |selectattr('name','eq',player)
              |map(attribute='entity_id')|join('') }}
        {% endif %}
      attributes:
        player_state: "{{ states(states('sensor.alarm_clock_media_player')) }}"
        players: >
          {% set player = states('sensor.alarm_clock_media_player') %}
          {% if player|lower not in ['','off','unknown','unavailable','none'] %}
            {{ expand(state_attr('sensor.media_players','single'))
                |selectattr('attributes.' ~ player.split('.')[1],'eq',true)|map(attribute='entity_id')|list
                  if is_state_attr(player,'type','group') else [player] }}
          {% else %} []
          {% endif %}

    - name: 'Alarm Clock Auto'
      unique_id: alarm_clock_auto
      device_class: timestamp
      icon: >
        {% if is_state_attr('sensor.alarm_clock_auto','status','failed') %} mdi:alarm-note-off
        {% elif is_state_attr('sensor.alarm_clock_auto','status','snoozed') %} mdi:alarm-snooze
        {% elif is_state_attr('sensor.alarm_clock_auto','status','pending')  %} mdi:alarm-check
        {% elif state_attr('sensor.alarm_clock_auto','status') in ['playing','testing'] %} mdi:alarm-note
        {% elif is_state('sensor.alarm_clock_auto','off')  %} mdi:alarm-off
        {% else %} mdi:alarm
        {% endif %}
      state: >
        {% set days = today_at(states('input_datetime.days_waketime')) %}
        {% set afts = today_at(states('input_datetime.afternoons_waketime')) %}
        {% set wkds = today_at(states('input_datetime.weekend_waketime')) %}
        {% set guest = today_at(states('input_datetime.guest_waketime')) %}

        {% if is_state('input_select.occupancy_mode','Guest') %}
          {% set next_alarm = guest if is_state('input_boolean.alarm_clock_guest','on') else 'off' %}
        {% else %}
          {% set alarm_today = afts if is_state('sensor.today_shift','Afternoons') else days
              if is_state('binary_sensor.work_today','on') else wkds %}

          {% set alarm_tom = afts if is_state('sensor.tomorrow_shift','Afternoons') else days
              if is_state('binary_sensor.work_tomorrow','on') else wkds  %}
          {% set alarm_tom = as_datetime((alarm_tom.timestamp() + 86400)|timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')) %}

          {# set next alarm to tomorrows alarm time if now is past alarm time  #}
          {% set next_alarm = alarm_tom if now() > alarm_today else alarm_today %}

          {% if is_state('input_select.occupancy_mode','Guest') %}
            {% set next_alarm = guest if is_state('input_boolean.alarm_clock_guest','on') else 'off' %}
          {% else %}
            {# set next alarm to off if not boolean enabled #}
            {% if (now() <= alarm_today and is_state('binary_sensor.work_today','on')
                    and is_state('input_boolean.alarm_clock_auto_workdays','off'))
                or (now() <= alarm_today and is_state('binary_sensor.work_tomorrow','off')
                  and is_state('input_boolean.alarm_clock_auto_weekends','off'))
                or (now() > alarm_today and is_state('binary_sensor.work_tomorrow','on')
                  and is_state('input_boolean.alarm_clock_auto_workdays','off'))
                or (now() > alarm_today and is_state('binary_sensor.work_tomorrow','off')
                  and is_state('input_boolean.alarm_clock_auto_weekends','off')) %}
              {% set next_alarm = 'off' %}
            {% endif %}
          {% endif %}
        {% endif %}
        {{ next_alarm if next_alarm|lower in ['','off','unknown','unavailable','none'] else next_alarm.isoformat() }}
      attributes:
        status: >
          {% if is_state('sensor.alarm_clock_auto','off') %} off
          {% else %}
            {% if is_state('switch.alarm_clock_auto','on') %}
              {% if is_state('input_boolean.alarm_clock_failed','on') %} failed
              {% elif is_state('switch.alarm_clock_snooze','on') %} snoozed
              {% elif is_state('input_boolean.alarm_clock_test_play','on') %} testing
              {% elif is_state_attr('sensor.alarm_clock_media_player','player_state','playing') %} playing
              {% else %} delayed
              {% endif %}
            {% else %} pending
            {% endif %}
          {% endif %}
        24hour: >
          {% if states('sensor.alarm_clock_auto')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_auto')).strftime('%H:%M') }}
          {% endif %}
        12hour: >
          {% if states('sensor.alarm_clock_auto')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_auto')).strftime('%-I:%M %p') }}
          {% endif %}

    - name: 'Alarm Clock Manual'
      unique_id: alarm_clock_manual
      device_class: timestamp
      icon: >
        {% if is_state_attr('sensor.alarm_clock_manual','status','failed') %} mdi:alarm-note-off
        {% elif is_state_attr('sensor.alarm_clock_manual','status','snoozed') %} mdi:alarm-snooze
        {% elif is_state_attr('sensor.alarm_clock_manual','status','pending') %} mdi:alarm-check
        {% elif state_attr('sensor.alarm_clock_manual','status') in ['playing','testing'] %} mdi:alarm-note
        {% elif is_state('sensor.alarm_clock_manual','off')  %} mdi:alarm-off
        {% else %} mdi:alarm
        {% endif %}
      state: > #TODO
        {% if is_state('input_boolean.alarm_clock_manual','on') %}
          {% set alarm_time = today_at(states('input_datetime.alarm_clock_manual_time')) %}
          {% if alarm_time < now () %}
            {% set alarm_time = as_datetime((alarm_time|as_timestamp + 86400)|timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')) %}
          {% endif %}
          {{ alarm_time.isoformat() }}
        {% else %} off
        {% endif %}
      attributes:
        status: >
          {% if is_state('sensor.alarm_clock_manual','off') %} off
          {% else %}
            {% if is_state('switch.alarm_clock_manual','on') %}
              {% if is_state('input_boolean.alarm_clock_failed','on') %} failed
              {% elif is_state('switch.alarm_clock_snooze','on') %} snoozed
              {% elif is_state('input_boolean.alarm_clock_test_play','on') %} testing
              {% elif is_state_attr('sensor.alarm_clock_media_player','player_state','playing') %} playing
              {% else %} delayed
              {% endif %}
            {% else %} pending
            {% endif %}
          {% endif %}
        24hour: >
          {% if states('sensor.alarm_clock_manual')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_manual')).strftime('%H:%M') }}
          {% endif %}
        12hour: >
          {% if states('sensor.alarm_clock_manual')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_manual')).strftime('%-I:%M %p') }}
          {% endif %}

    - name: 'Alarm Clock Nap'
      unique_id: alarm_clock_nap
      device_class: timestamp
      icon: >
        {% if is_state_attr('sensor.alarm_clock_nap','status','failed') %} mdi:alarm-note-off
        {% elif is_state_attr('sensor.alarm_clock_nap','status','snoozed')  %} mdi:alarm-snooze
        {% elif is_state_attr('sensor.alarm_clock_nap','status','pending')  %} mdi:alarm-check
        {% elif state_attr('sensor.alarm_clock_nap','status') in ['playing','testing'] %} mdi:alarm-note
        {% elif is_state('sensor.alarm_clock_nap','off')  %} mdi:alarm-off
        {% else %} mdi:alarm
        {% endif %}
      state: > #TODO
        {% if is_state('input_boolean.alarm_clock_nap','on')
            and state_attr('timer.alarm_clock_nap','finishes_at')| lower not in ['','unknown','unavailable','none'] %}
          {{ as_datetime(state_attr('timer.alarm_clock_nap','finishes_at')
              |as_timestamp('unknown')|timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')).isoformat() }}
        {% else %} off
        {% endif %}
      attributes:
        status: >
          {% if is_state('sensor.alarm_clock_nap','off') %} off
          {% else %}
            {% if is_state('switch.alarm_clock_nap','on') %}
              {% if is_state('input_boolean.alarm_clock_failed','on') %} failed
              {% elif is_state('switch.alarm_clock_snooze','on') %} snoozed
              {% elif is_state('input_boolean.alarm_clock_test_play','on') %} testing
              {% elif is_state_attr('sensor.alarm_clock_media_player','player_state','playing') %} playing
                {% else %} delayed
                {% endif %}
              {% else %} pending
              {% endif %}
          {% endif %}
        24hour: >
          {% if states('sensor.alarm_clock_nap')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_nap')).strftime('%H:%M') }}
          {% endif %}
        12hour: >
          {% if states('sensor.alarm_clock_nap')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_nap')).strftime('%-I:%M %p') }}
          {% endif %}

    - name: 'Alarm Clock Other'
      unique_id: alarm_clock_other
      device_class: timestamp
      icon: "{{ 'mdi:alarm-off' if is_state('sensor.alarm_clock_other','off') else 'mdi:alarm' }}"
      state: > #TODO
        {% set set_alarms = namespace(value=[]) %}
        {% set alarms = ['sensor.jphone_alarm_clock','sensor.sphone_alarm_clock','sensor.dining_room_display_next_alarm',
            'sensor.bedroom_display_next_alarm','sensor.bathroom_speaker_next_alarm','sensor.garage_speaker_next_alarm',
            'sensor.living_room_speaker_next_alarm','sensor.laundry_room_speaker_next_alarm'] %}
        {% for item in alarms %}
          {% set time = 'off' if states(item)|lower in ['','off','unknown','unavailable','none']
              else as_datetime(states(item)|as_timestamp
                |timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')).isoformat() %}

          {% if time != 'off' %}
            {% set set_alarms.value = set_alarms.value + [time] %}
          {% endif %}
        {% endfor %}

        {% if set_alarms.value|count > 0 %} {{ set_alarms.value|min }}
        {% else %} off
        {% endif %}
      attributes:
        source: >
          {% set next = states('sensor.alarm_clock_other') %}
          {% if next|lower not in ['','off','unknown','unavailable','none'] %}
            {% if next == (as_datetime(states('sensor.jphone_alarm_clock')).isoformat()
                if states('sensor.jphone_alarm_clock')|lower not in ['','off','unknown','unavailable','none']) %} jphone
            {% elif next == (as_datetime(states('sensor.sphone_alarm_clock')).isoformat()
                if states('sensor.sphone_alarm_clock')|lower not in ['','off','unknown','unavailable','none']) %} sphone
            {% elif next == (as_datetime(states('sensor.dining_room_display_next_alarm')).isoformat()
                if states('sensor.dining_room_display_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} dining_room_display
            {% elif next == (as_datetime(states('sensor.bedroom_display_next_alarm')).isoformat()
                if states('sensor.bedroom_display_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} bedroom_display
            {% elif next == (as_datetime(states('sensor.bathroom_speaker_next_alarm')).isoformat()
                if states('sensor.bathroom_speaker_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} bathroom_speaker
            {% elif next == (as_datetime(states('sensor.living_room_speaker_next_alarm')).isoformat()
                if states('sensor.living_room_speaker_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} living_room_speaker
            {% elif next == (as_datetime(states('sensor.laundry_room_speaker_next_alarm')).isoformat()
                if states('sensor.laundry_room_speaker_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} laundry_room_speaker
            {% elif next == (as_datetime(states('sensor.garage_speaker_next_alarm')).isoformat()
                if states('sensor.garage_speaker_next_alarm')|lower not in ['','off','unknown','unavailable','none']) %} garage_speaker
            {% endif %}
          {% endif %}
        source_name: >
          {% if is_state_attr('sensor.alarm_clock_other','source','jphone') %} Jason Phone
          {% elif is_state_attr('sensor.alarm_clock_other','source','sphone') %} Sheri Phone
          {% elif is_state_attr('sensor.alarm_clock_other','source','dining_room_display') %} Dining Room
          {% elif is_state_attr('sensor.alarm_clock_other','source','bedroom_display') %} Bedroom
          {% elif is_state_attr('sensor.alarm_clock_other','source','bathroom_speaker') %} Bathroom
          {% elif is_state_attr('sensor.alarm_clock_other','source','living_room_speaker') %} Living Room
          {% elif is_state_attr('sensor.alarm_clock_other','source','laundry_room_speaker') %} Laundry Room
          {% elif is_state_attr('sensor.alarm_clock_other','source','garage_speaker') %} Garage
          {% endif %}
        24hour: >
          {% if states('sensor.alarm_clock_other')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_other')).strftime('%H:%M') }}
          {% endif %}
        12hour: >
          {% if states('sensor.alarm_clock_other')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_other')).strftime('%-I:%M %p') }}
          {% endif %}

    - name: 'Alarm Clock Next Alarm'
      unique_id: alarm_clock_next_alarm
      device_class: timestamp
      icon: >
        {% if is_state_attr('sensor.alarm_clock_next_alarm','status','failed') %} mdi:alarm-note-off
        {% elif state_attr('sensor.alarm_clock_next_alarm','status') in ['playing','testing'] %} mdi:alarm-note
        {% elif is_state_attr('sensor.alarm_clock_next_alarm','status','snoozed')  %} mdi:alarm-snooze
        {% elif is_state('sensor.alarm_clock_next_alarm','off')  %} mdi:alarm-off
        {% else %} mdi:alarm
        {% endif %}
      state: >
        {# earliest of auto, manual, phone, google home devices in next 24 hours #}
        {% set set_alarms = state_attr('sensor.alarm_clock_next_alarm','set_alarms') %}
        {% if set_alarms|lower not in ['','unknown','unavailable','none'] %}
          {{ set_alarms|min if set_alarms|count > 0 else 'off' }}
        {% else %} off
        {% endif %}
      attributes:
        set_alarms: > #TODO
          {% set set_alarms = namespace(value=[]) %}
          {% set alarms = ['sensor.alarm_clock_auto','sensor.alarm_clock_manual','sensor.alarm_clock_nap','sensor.alarm_clock_other'] %}
          {% for item in alarms if states(item)|lower not in ['','off','unknown','unavailable','none'] %}
            {% set set_alarms.value = set_alarms.value + [as_datetime(states(item)|as_timestamp
                |timestamp_custom('%Y-%m-%d %H:%M:%S%z',true,'unknown')).isoformat()] %}
          {% endfor %}
          {{ set_alarms.value }}
        status: >
          {% if is_state('sensor.alarm_clock_next_alarm','off') %} off
          {% else %}
            {% if is_state('input_boolean.alarm_clock_failed','on') %} failed
            {% elif is_state('binary_sensor.alarm_clock','on') %}
              {% if is_state('input_boolean.alarm_clock_test_play','on') %} testing
              {% elif is_state('switch.alarm_clock_snooze','on') %} snoozed
              {% elif is_state_attr('sensor.alarm_clock_media_player','player_state','playing') %} playing
              {% else %} delayed
              {% endif %}
            {% else %} {{ state_attr('sensor.alarm_clock_next_alarm','12hour') }}
            {% endif %}
          {% endif %}
        source: >
          {% set next = states('sensor.alarm_clock_next_alarm') %}
          {% if next|lower not in ['','off','unknown','unavailable','none'] %}
            {% if next == states('sensor.alarm_clock_auto') %} auto
            {% elif next == states('sensor.alarm_clock_manual') %} manual
            {% elif next == states('sensor.alarm_clock_nap') %} nap
            {% elif next == states('sensor.alarm_clock_other') %}
              {{ state_attr('sensor.alarm_clock_other','source') }}
            {% endif %}
          {% endif %}
        source_name: >
          {% if is_state_attr('sensor.alarm_clock_next_alarm','source','auto') %} Auto
          {% elif is_state_attr('sensor.alarm_clock_next_alarm','source','manual') %} Manual
          {% elif is_state_attr('sensor.alarm_clock_next_alarm','source','nap') %} Nap
          {% elif states('sensor.alarm_clock_next_alarm') == states('sensor.alarm_clock_other') %}
              {{ state_attr('sensor.alarm_clock_other','source_name') }}
          {% endif %}
        12hour: >
          {% if states('sensor.alarm_clock_next_alarm')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_next_alarm')).strftime('%-I:%M %p') }}
          {% endif %}
        24hour: >
          {% if states('sensor.alarm_clock_next_alarm')|lower not in ['','off','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.alarm_clock_next_alarm')).strftime('%H:%M') }}
          {% endif %}
