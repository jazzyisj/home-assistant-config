###############################################################################
## Templates - Media Players
###############################################################################
- button:
    - name: "Reset Volumes"
      unique_id: reset_volumes
      icon: mdi:volume-high
      press:
        - service: automation.trigger
          target:
            entity_id: automation.media_player_volume_reset

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: group.cast_audio_media_players
      attribute: entity_id
      to: ~
  sensor:
    - name: "Cast Audio Media Players"
      unique_id: cast_audio_media_players
      state: >
        {% set players = state_attr(this.entity_id,'entity_id') %}
        {{ 0 if players == none else players|count }}
      attributes:
        entity_id: "{{ state_attr('group.cast_audio_media_players','entity_id') }}"

- binary_sensor:
    - name: "Unavailable Media Player"
      unique_id: unavailable_media_player
      icon: mdi:speaker
      device_class: problem
      state: >
        {% set entities = state_attr(this.entity_id,'entity_id') %}
        {{ false if entities == none else entities|count > 0 }}
      attributes:
        entity_id: >
          {{ states.media_player
              |rejectattr('entity_id','search','jphone_app_internal')
              |rejectattr('entity_id','search','jphone_app_external')
              |rejectattr('entity_id','search','sphone_app_internal')
              |rejectattr('entity_id','search','sphone_app_external')
              |selectattr('state','in',['unknown','unavailable'])
              |map(attribute='entity_id')|list }}

    - name: "MASS Media"
      unique_id: mass_media
      icon: mdi:music-circle
      state: >
        {% set entities = state_attr(this.entity_id,'entity_id') %}
        {{ false if entities == none else entities|count > 0 }}
      attributes:
        entity_id: >
          {{ states.media_player
              |selectattr('attributes.app_id','defined')
              |selectattr('attributes.app_id','eq','mass')
              |map(attribute='entity_id')|list }}

- sensor:
    - name: "All Speakers"
      unique_id: all_speakers
      state: >
        {% set media_player = 'media_player.all_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.all_speakers','defined')
              |selectattr('attributes.all_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.all_speakers') not in ['unknown','unavailable'] }}"

    - name: "Broadcast Speakers"
      unique_id: broadcast_speakers
      state: >
        {% set media_player = 'media_player.broadcast_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.broadcast_speakers','defined')
              |selectattr('attributes.broadcast_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.broadcast_speakers') not in ['unknown','unavailable'] }}"

    - name: "Inside Speakers"
      unique_id: inside_speakers
      state: >
        {% set media_player = 'media_player.inside_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.inside_speakers','defined')
              |selectattr('attributes.inside_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.inside_speakers') not in ['unknown','unavailable'] }}"

    - name: "Music Speakers"
      unique_id: music_speakers
      state: >
        {% set media_player = 'media_player.music_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.music_speakers','defined')
              |selectattr('attributes.music_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.music_speakers') not in ['unknown','unavailable'] }}"

    - name: "Night Speakers"
      unique_id: night_speakers
      state: >
        {% set media_player = 'media_player.night_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.night_speakers','defined')
              |selectattr('attributes.night_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.night_speakers') not in ['unknown','unavailable'] }}"

    - name: "Quiet Speakers"
      unique_id: quiet_speakers
      state: >
        {% set media_player = 'media_player.quiet_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on')
                and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: >
          {{ expand('group.single_media_players')
              |selectattr('attributes.quiet_speakers','defined')
              |selectattr('attributes.quiet_speakers','eq',true)
              |map(attribute='entity_id')|list }}
      availability: "{{ states('media_player.quiet_speakers') not in ['unknown','unavailable'] }}"

    - name: "Bathroom Speaker"
      unique_id: bathroom_speaker
      state: >
        {% set media_player = 'media_player.bathroom_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.bathroom_speaker') not in ['unknown','unavailable'] }}"

    - name: "Bedroom Hub"
      unique_id: bedroom_hub
      state: >
        {% set media_player = 'media_player.bedroom_hub' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.bedroom_hub') not in ['unknown','unavailable'] }}"

    - name: "Dining Room Hub"
      unique_id: dining_room_hub
      state: >
        {% set media_player = 'media_player.dining_room_hub' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.dining_room_hub') not in ['unknown','unavailable'] }}"

    - name: "Garage Speaker"
      unique_id: garage_speaker
      state: >
        {% set media_player = 'media_player.garage_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.garage_speaker') not in ['unknown','unavailable'] }}"

    - name: "Laundry Room Speaker"
      unique_id: laundry_room_speaker
      state: >
        {% set media_player = 'media_player.laundry_room_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.laundry_room_speaker') not in ['unknown','unavailable'] }}"

    - name: "Living Room Speaker"
      unique_id: living_room_speaker
      state: >
        {% set media_player = 'media_player.living_room_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.dining_room_hub') not in ['unknown','unavailable'] }}"

    - name: "Living Room TV"
      unique_id: living_room_tv
      state: >
        {% set media_player = 'media_player.living_room_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.living_room_tv') not in ['unknown','unavailable'] }}"

    - name: "Bedroom TV"
      unique_id: bedroom_tv
      state: >
        {% set media_player = 'media_player.bedroom_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.bedroom_tv') not in ['unknown','unavailable'] }}"

    - name: "Office TV"
      unique_id: office_tv
      state: >
        {% set media_player = 'media_player.office_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.office_tv') not in ['unknown','unavailable'] }}"

    - name: "Living Room Chromecast"
      unique_id: living_room_chromecast
      state: >
        {% set media_player = 'media_player.living_room_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.living_room_chromecast') not in ['unknown','unavailable'] }}"

    - name: "Office Chromecast"
      unique_id: office_chromecast
      state: >
        {% set media_player = 'media_player.office_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.office_chromecast') not in ['unknown','unavailable'] }}"

    - name: "Deck Chromecast"
      unique_id: deck_chromecast
      state: >
        {% set media_player = 'media_player.deck_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.deck_chromecast') not in ['unknown','unavailable'] }}"

    - name: "Hass Media Player"
      unique_id: hass_media_player
      state: >
        {% set media_player = 'media_player.hass_media_player' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.hass_media_player') not in ['unknown','unavailable'] }}"

    - name: "Jason Laptop Media Player (Internal)"
      unique_id: jason_laptop_media_player_internal
      state: >
        {% set media_player = 'media_player.jlaptop_chrome_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.jlaptop_chrome_internal') not in ['unknown','unavailable'] }}"

    - name: "Jason Laptop Media Player (External)"
      unique_id: jason_laptop_media_player_external
      state: >
        {% set media_player = 'media_player.jlaptop_chrome_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.jlaptop_chrome_external') not in ['unknown','unavailable'] }}"

    # rename for clarity
    - name: "Kiosk Interanl Player"
      unique_id: kiosk_internal_player
      state: >
        {% set media_player = 'media_player.kiosk_internal_player' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.kiosk_internal_player') not in ['unknown','unavailable'] }}"

    - name: "Jason Phone Media Player (Internal)"
      unique_id: jason_phone_media_player_internal
      state: >
        {% set media_player = 'media_player.jphone_app_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.jphone_app_internal') not in ['unknown','unavailable'] }}"

    - name: "Jason Phone Media Player (External)"
      unique_id: jason_phone_media_player_external
      state: >
        {% set media_player = 'media_player.jphone_app_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.jphone_app_external') not in ['unknown','unavailable'] }}"

    - name: "Sheri Phone Media Player (Internal)"
      unique_id: sheri_phone_media_player_internal
      state: >
        {% set media_player = 'media_player.sphone_app_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.sphone_app_internal') not in ['unknown','unavailable'] }}"

    - name: "Sheri Phone Media Player (External)"
      unique_id: sheri_phone_media_player_external
      state: >
        {% set media_player = 'media_player.browser_sphone_app_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = ['tts','alarm_clock'] %}
        {% set group_players = state_attr('group.group_media_players','entity_id') %}
        {% if states(media_player) in ['playing','paused'] %}
          {% for type in media_types %}
            {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
            {% set type_player = states(type_sensor) %}
            {% set type_players = state_attr(type_sensor,'entity_id') %}
            {% if is_state('binary_sensor.' ~ type,'on') or is_state('input_boolean.' ~ type,'on') %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif type_players != none %}
                {% for item in type_players %}
                  {% if item in group_players %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if sensor.state == 'off' and group_players != none %}
            {% for player in group_players %}
              {% if media_player|replace('mass_','') in state_attr('sensor.' ~ player.split('.')[1],'entity_id')
                  and states(player) in ['playing','paused'] %}
                {% set sensor.state = 'group' %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      availability: "{{ states('media_player.browser_sphone_app_external') not in ['unknown','unavailable'] }}"
