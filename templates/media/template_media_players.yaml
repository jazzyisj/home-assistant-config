###############################################################################
## Templates - Media Players
###############################################################################
- binary_sensor:
    - name: 'Volume Override'
      unique_id: volume_override
      icon: mdi:volume-vibrate
      state: >
        {{ is_state('input_boolean.volume_override','on')
            or is_state('binary_sensor.scene_active','on') }}

    - name: 'Media LED Alert'
      unique_id: media_led_alert
      state: >
        {{ is_state('switch.system_mute','on')
            or states('variable.tts_saved_messages')|int(0) > 0
            or is_state('binary_sensor.scene_active','on') }}

- sensor:
    - name: 'Media Light Color'
      unique_id: media_light_color
      state: >
        {% if is_state('input_boolean.media_color_light_sync','on') %}
            {% if is_state('light.dining_room_rgb_light','on') %}
              rgb{{ state_attr('light.dining_room_rgb_light','rgb_color') }}
            {% else %} var(--state-icon-color)
            {% endif %}
        {% else %} var(--state-icon-color)
        {% endif %}

    - name: 'All Speakers'
      unique_id: all_speakers # used by conditional media player display cards
      state: >
        {% set media = 'media_player.all_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.all_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Broadcast Speakers'
      unique_id: broadcast_speakers
      state: >
        {% set media = 'media_player.broadcast_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.broadcast_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Music Speakers'
      unique_id: music_speakers
      state: >
        {% set media = 'media_player.music_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.music_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Quiet Speakers'
      unique_id: quiet_speakers
      state: >
        {% set media = 'media_player.quiet_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.quiet_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Night Speakers'
      unique_id: night_speakers
      state: >
        {% set media = 'media_player.night_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.night_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Inside Speakers'
      unique_id: inside_speakers
      state: >
        {% set media = 'media_player.inside_speakers' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media) in ['playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}
      attributes:
        entity_id: "{{ expand(state_attr('group.single_media_players','entity_id'))|selectattr('attributes.inside_speakers','eq',true)|map(attribute='entity_id')|list }}"

    - name: 'Living Room Speaker'
      unique_id: living_room_speaker
      state: >
        {% set media_player = 'media_player.living_room_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Dining Room Hub'
      unique_id: dining_room_hub
      state: >
        {% set media_player = 'media_player.dining_room_hub' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Bedroom Hub'
      unique_id: bedroom_hub
      state: >
        {% set media_player = 'media_player.bedroom_hub' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Bathroom Speaker'
      unique_id: bathroom_speaker
      state: >
        {% set media_player = 'media_player.bathroom_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Laundry Room Speaker'
      unique_id: laundry_room_speaker
      state: >
        {% set media_player = 'media_player.laundry_room_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Garage Speaker'
      unique_id: garage_speaker
      state: >
        {% set media_player = 'media_player.garage_speaker' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Living Room TV'
      unique_id: living_room_tv
      state: >
        {% set media_player = 'media_player.living_room_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Bedroom TV'
      unique_id: bedroom_tv
      state: >
        {% set media_player = 'media_player.bedroom_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Office TV'
      unique_id: office_tv
      state: > # 'home' state!
        {% set media_player = 'media_player.office_tv' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Living Room Chromecast'
      unique_id: living_room_chromecast
      state: >
        {% set media_player = 'media_player.living_room_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Office Chromecast'
      unique_id: office_chromecast
      state: >
        {% set media_player = 'media_player.office_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Deck Chromecast'
      unique_id: deck_chromecast
      state: >
        {% set media_player = 'media_player.deck_chromecast' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') %}
              {% set type_sensor = 'sensor.' ~ type ~ '_media_player' %}
              {% set type_player = states(type_sensor) %}
              {% if media_player == type_player %}
                {% set sensor.state = type %}
              {% elif state_attr(type_player,'type') != none
                  and is_state_attr(type_player,'type','group') %}
                {% for item in state_attr(type_sensor,'entity_id') %}
                  {% if item == media_player %}
                    {% set sensor.state = type ~'_group' %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' else sensor.state %}
        {% endif %}
        {{ sensor.state }}

    - name: 'VLC Hass'
      unique_id: vlc_hass
      state: >
        {% set media_player = 'media_player.vlc_hass' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Jason Laptop: Media Player (Internal)'
      unique_id: jason_laptop_media_player_internal
      state: >
        {% set media_player = 'media_player.browser_jlaptop_chrome_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Jason Laptop: Media Player (External)'
      unique_id: jason_laptop_media_player_external
      state: >
        {% set media_player = 'media_player.browser_jlaptop_chrome_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Kiosk: Media Player'
      unique_id: kiosk_media_player
      state: >
        {% set media_player = 'media_player.browser_kiosk_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Jason Phone: Media Player (Internal)'
      unique_id: jason_phone_media_player_internal
      state: >
        {% set media_player = 'media_player.browser_jphone_app_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Jason Phone: Media Player (External)'
      unique_id: jason_phone_media_player_external
      state: >
        {% set media_player = 'media_player.browser_jphone_app_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Sheri Phone: Media Player (Internal)'
      unique_id: sheri_phone_media_player_internal
      state: >
        {% set media_player = 'media_player.browser_sphone_app_internal' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}

    - name: 'Sheri Phone: Media Player (External)'
      unique_id: sheri_phone_media_player_external
      state: >
        {% set media_player = 'media_player.browser_sphone_app_external' %}
        {% set sensor = namespace(state='off') %}
        {% set media_types = state_attr('sensor.media_types','media_types') %}
        {% set extra_types = ['tts','alarm_clock'] %}
        {% set media_types = media_types + extra_types if media_types != none else extra_types %}
        {% if states(media_player) in ['on','playing','paused'] %}
          {% for type in media_types %}
            {% if is_state('binary_sensor.' ~ type,'on') and media_player == states('sensor.' ~ type ~ '_media_player') %}
              {% set sensor.state = type %}
            {% endif %}
          {% endfor %}
          {% set sensor.state = 'on' if sensor.state == 'off' %}
        {% endif %}
        {{ sensor.state }}
