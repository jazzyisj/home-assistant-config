###############################################################################
## Templates - Kiosk
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: binary_sensor.fire_tablet_kiosk_mode
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: binary_sensor.fire_tablet_kiosk_mode
      to:
        - unknown
        - unavailable
  binary_sensor:
    # no alert (covered by kiosk offline)
    - name: "Fully Kiosk Connected"
      unique_id: fully_kiosk_connected
      icon: mdi:monitor-dashboard
      device_class: connectivity
      state: >
        {{ expand(integration_entities('fully_kiosk'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- binary_sensor:
    - name: "Kiosk Online"
      unique_id: kiosk_online
      icon: mdi:tablet-dashboard
      device_class: connectivity
      state: >
        {{ is_state('device_tracker.kiosk_tablet','home')
            and is_state('binary_sensor.fully_kiosk_connected','on')
            and not states('sensor.kiosk_internal_browser_user') in ['unknown','unavailable'] }}

    - name: "Kiosk Offline Alert"
      unique_id: kiosk_offline_alert
      icon: mdi:tablet-dashboard
      device_class: problem
      delay_on: 120 # prevent trigger on restart, temporary disconnection
      state: >
        {{ is_state('binary_sensor.kiosk_online','off')
            and is_state('input_boolean.hass_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
