###############################################################################
## Template - System
###############################################################################
- binary_sensor:
    - name: 'CPU Temperature Alert'
      unique_id: cpu_temperature_alert
      device_class: heat
      delay_on: "{{ 0 if is_state('binary_sensor.cpu_temperature_alert','unknown') else 600 }}"
      state: >
        {{ is_state('binary_sensor.cpu_temp_status','severe')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Processor Use Alert'
      unique_id: processor_use_alert
      device_class: problem
      delay_on: "{{ 0 if is_state('binary_sensor.processor_use_alert','unknown') else 600 }}"
      state: >
        {{ is_state('binary_sensor.processor_use_status','severe')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Memory Use Alert'
      unique_id: memory_use_alert
      device_class: problem
      delay_on: "{{ 0 if is_state('binary_sensor.memory_use_alert','unknown') else 600 }}"
      state: >
        {{ is_state('binary_sensor.memory_use_status','severe')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Swap Use Alert'
      unique_id: swap_use_alert
      device_class: problem
      delay_on: "{{ 0 if is_state('binary_sensor.swap_use_alert','unknown') else 600 }}"
      state: >
        {{ is_state('binary_sensor.swap_use_status','severe')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Disk Use Alert'
      unique_id: disk_use_alert
      device_class: problem
      state: >
        {{ is_state('binary_sensor.disk_status','severe')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

- sensor:
    - name: 'Backup Size'
      unique_id: backup_size
      state: >
        {% if state_attr('sensor.backup_state','size_in_home_assistant') != none %}
          {{ state_attr('sensor.backup_state','size_in_home_assistant')[:-2]|int(-1) }}
        {% endif %}

    - name: 'Memory Use Status'
      unique_id: memory_use_status
      icon: mdi:memory
      state: >
        {% set mem = states('sensor.memory_use_percent')|int(-1) %}
        {% if mem > 75 %} critical
        {% elif mem > 65 %} severe
        {% elif mem > 55 %} warning
        {% elif mem > 45 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Swap Use Status'
      unique_id: swap_use_status
      icon: mdi:memory
      state: >
        {% set swap = states('sensor.swap_use_percent')|int(-1) %}
        {% if swap > 90 %} critical
        {% elif swap > 80 %} severe
        {% elif swap > 70 %} warning
        {% elif swap > 60 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Processor Use Status'
      unique_id: processor_use_status
      icon: mdi:developer-board
      state: >
        {% set procuse = states('sensor.processor_use_percent')|int(-1) %}
        {% if procuse > 75 %} critical
        {% elif procuse > 65 %} severe
        {% elif procuse > 55 %} warning
        {% elif procuse > 45 %} minor
        {% else %} ok
        {% endif %}

    - name: 'CPU Temp Status'
      unique_id: cpu_temp_status
      icon: mdi:thermometer
      state: >
        {% set temp = states('sensor.cpu_temperature')|int(-1) %}
        {% if temp > 60 %} critical
        {% elif temp > 50 %} severe
        {% elif temp > 40 %} warning
        {% elif temp > 30 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Disk Use Status'
      unique_id: disk_use_status
      icon: mdi:database
      state: >
        {% set size = states('sensor.disk_use_percent_home')|int(-1) %}
        {% if size > 80 %} critical
        {% elif size > 70 %} severe
        {% elif size > 60 %} warning
        {% elif size > 50 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Hass DB Size Status'
      unique_id: hass_db_size_status
      icon: mdi:database
      state: >
        {% set db = states('sensor.hassio_db')|int(-1) %}
        {% if db > 10000 %} critical
        {% elif db > 7500 %} severe
        {% elif db > 5000 %} warning
        {% elif db > 2500 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Backup Size Status'
      unique_id: backup_size_status
      icon: mdi:backup-restore # gigabytes
      state: >
        {% set size = states('sensor.backup_size')|int(-1) %}
        {% if size > 25 %} critical
        {% elif size > 20 %} severe
        {% elif size > 15 %} warning
        {% elif size > 10 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Hass Log Size Status'
      unique_id: hass_log_size_status
      icon: mdi:backup-restore
      state: >
        {% set size = states('sensor.home_assistant_log')|int(-1) %}
        {% if size > 100 %} critical
        {% elif size > 75 %} severe
        {% elif size > 25 %} warning
        {% elif size > 10 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Alarm Snapshots Size Status'
      unique_id: alarm_snapshots_size_status
      icon: mdi:backup-restore
      state: >
        {% set size = states('sensor.alarm_snapshots')|int(-1) %}
        {% if size > 150 %} critical
        {% elif size > 100 %} severe
        {% elif size > 75 %} warning
        {% elif size > 50 %} minor
        {% else %} ok
        {% endif %}

    - name: 'TTS Size Status'
      unique_id: tts_size_status
      icon: mdi:account-voice
      state: >
        {% set size = states('sensor.tts')|int(-1) %}
        {% if size > 150 %} critical
        {% elif size > 100 %} severe
        {% elif size > 75 %} warning
        {% elif size > 50 %} minor
        {% else %} ok
        {% endif %}

    - name: 'Disk Status'
      unique_id: disk_status
      icon: mdi:harddisk
      state: >
        {% if is_state('sensor.disk_use_status','critical')
            or is_state('sensor.hass_db_size_status','critical')
            or is_state('sensor.backup_size_status','critical')
            or is_state('sensor.hass_log_size_status','critical')
            or is_state('sensor.alarm_snapshots_size_status','critical')
            or is_state('sensor.tts_size_status','critical') %} critical

        {% elif is_state('sensor.disk_use_status','severe')
            or is_state('sensor.hass_db_size_status','severe')
            or is_state('sensor.backup_size_status','severe')
            or is_state('sensor.hass_log_size_status','severe')
            or is_state('sensor.alarm_snapshots_size_status','severe')
            or is_state('sensor.tts_size_status','severe') %} severe

        {% elif is_state('sensor.disk_use_status','warning')
            or is_state('sensor.hass_db_size_status','warning')
            or is_state('sensor.backup_size_status','warning')
            or is_state('sensor.hass_log_size_status','warning')
            or is_state('sensor.alarm_snapshots_size_status','crwarningitical')
            or is_state('sensor.tts_size_status','warning') %} warning

        {% elif is_state('sensor.disk_use_status','minor')
            or is_state('sensor.hass_db_size_status','minor')
            or is_state('sensor.backup_size_status','minor')
            or is_state('sensor.hass_log_size_status','minor')
            or is_state('sensor.alarm_snapshots_size_status','minor')
            or is_state('sensor.tts_size_status','minor')  %} minor
        {% else %} ok
        {% endif %}

    - name: 'Server Status'
      unique_id: server_status
      icon: mdi:server
      state: >
        {% if is_state('sensor.disk_status','critical')
            or is_state('sensor.cpu_temp_status','critical')
            or is_state('sensor.processor_use_status','critical')
            or is_state('sensor.swap_use_status','critical')
            or is_state('sensor.memory_use_status','critical') %} critical
        {% elif is_state('sensor.disk_status','severe')
            or is_state('sensor.cpu_temp_status','severe')
            or is_state('sensor.processor_use_status','severe')
            or is_state('sensor.swap_use_status','severe')
            or is_state('sensor.memory_use_status','severe') %} severe
        {% elif is_state('sensor.disk_status','warning')
            or is_state('sensor.cpu_temp_status','warning')
            or is_state('sensor.processor_use_status','warning')
            or is_state('sensor.swap_use_status','warning')
            or is_state('sensor.memory_use_status','warning') %} warning
        {% elif is_state('sensor.disk_status','minor')
            or is_state('sensor.cpu_temp_status','minor')
            or is_state('sensor.processor_use_status','minor')
            or is_state('sensor.swap_use_status','minor')
            or is_state('sensor.memory_use_status','minor') %} minor
        {% else %} ok
        {% endif %}

    - name: 'Server Uptime'
      unique_id: server_uptime
      icon: mdi:clock-start
      state: >
        {% if states('sensor.last_boot')|lower not in ['unknown','unavailable','none'] %}
          {% set uptime = now().timestamp() - states('sensor.last_boot')|as_timestamp %}
          {% set minutes = (uptime // 60)|int(0) %}
          {% set hours = (minutes // 60) %}
          {% set days = (hours // 24) %}
          {% set weeks = (days // 7) %}
          {% set minutes = (minutes % 60) %}
          {% set hours =  (hours % 24) %}
          {% set days = (days % 7) %}
          {% macro phrase(value, name) %}
            {%- set value = value %}
            {%- set end = 's' if value > 1 else '' %}
            {{- '{} {}{}'.format(value, name, end) if value|int(0) > 0 else '' }}
          {%- endmacro %}
          {% set text = [ phrase(weeks, 'week'), phrase(days, 'day'), phrase(hours, 'hr'), phrase(minutes, 'min') ]|select('!=','')|list|join(', ') %}
          {% set last_comma = text.rfind(',') %}
          {% if last_comma != -1 %}
            {% set text = text[:last_comma] + ' and' + text[last_comma + 1:] %}
          {% endif %}
          {{ text }}
        {% endif %}

    - name: 'Last Boot Date Time'
      unique_id: last_boot_date_time
      icon: mdi:clock-start
      state: >
        {% if states('sensor.last_boot')|lower not in ['unknown','unavailable','none'] %}
          {% set last_boot = states('sensor.last_boot')|as_datetime|as_local %}
          {% set date = last_boot.strftime('%d') %}
          {% set date = '{:01}'.format(date|int(0)) %}
          {% if date in ('1','21','31') %}{% set date = date ~ 'st' %}
          {% elif now().day in ('2','22') %}{% set date = date ~ 'nd' %}
          {% elif now().day in ('3','23') %}{% set date = date ~ 'rd' %}
          {% else %}{% set date = date ~ 'th' %}
          {% endif %}
          {{ last_boot.strftime('%a') }} {{ date }} {{ last_boot.strftime('%b %Y') }} {{ last_boot.strftime('at %-I:%M %p') }}
        {% endif %}
