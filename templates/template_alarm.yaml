###############################################################################
## Templates - Alarm
###############################################################################
- binary_sensor:
    - name: 'Alarm Connected'
      unique_id: alarm_connected
      icon: "{{ 'mdi:shield-home' if is_state('binary_sensor.alarm_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ not states('alarm_control_panel.master')|lower in ['unknown','unavailable','none']
            and not states('alarm_control_panel.house')|lower in ['unknown','unavailable','none']
            and not states('alarm_control_panel.garage')|lower in ['unknown','unavailable','none'] }}

    - name: 'Alarm Connected Alert'
      unique_id: alarm_connected_alert
      icon: mdi:shield-alert
      state: >
        {{ is_state('binary_sensor.alarm_connected','off')
            and is_state('input_boolean.alarm_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Alarm Disabled Alert'
      unique_id: alarm_disabled_alert
      device_class: connectivity
      delay_on: 10 # allow to turn back off if armed
      state: >
        {{ (is_state('input_boolean.alarm_automation','off')
              or is_state('input_boolean.alarm_auto_arming','off'))
            and is_state('input_boolean.alarm_alerts','on') }}

    - name: 'Alarm Auto Arming Alert'
      unique_id: alarm_auto_arming_alert # reverse boolean for lovelace glance menus
      icon: mdi:account-arrow-right
      state: "{{ is_state('input_boolean.alarm_auto_arming','off') and is_state('input_boolean.alarm_alerts','on') }}"

    - name: 'Alarm Zone Sync Alert'
      unique_id: alarm_zone_sync_alert
      icon: mdi:shield-alert
      delay_on: "{{ 0 if is_state('binary_sensor.alarm_zone_sync_alert','unknown') else 3600 }}"
      state: >
        {{ (states('alarm_control_panel.house') != states('alarm_control_panel.master')
            or states('alarm_control_panel.garage') != states('alarm_control_panel.master'))
            and is_state('input_boolean.alarm_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Alarm Pending Alert'
      unique_id: alarm_pending_alert
      delay_on: 2 # allow input_text.current_alarm to populate
      state: >
        {{ is_state('alarm_control_panel.master','pending')
            and is_state('input_boolean.alarm_alerts','on') }}

    - name: 'Alarm Disarmed Alert'
      unique_id: alarm_disarmed_alert
      delay_on: "{{ 0 if is_state('binary_sensor.alarm_disarmed_alert','unknown') else 300 }}"
      state: >
        {{ is_state('alarm_control_panel.master','disarmed')
            and is_state('binary_sensor.someone_home','off')
            and is_state('input_boolean.alarm_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}
      availability: "{{ states('binary_sensor.someone_home') in ['off','on'] }}"

    - name: 'Alarm Open Sensor Alert'
      unique_id: alarm_open_sensor_alert
      icon: mdi:shield-alert
      state: >
        {{ is_state('alarm_control_panel.master','disarmed')
            and state_attr('alarm_control_panel.master','open_sensors')|lower != 'none'
            and is_state('binary_sensor.alarm_bypassed_sensor_alert','off')
            and is_state('input_boolean.alarm_alerts','on') }}

    - name: 'Alarm Bypassed Sensor Alert'
      unique_id: alarm_bypassed_sensor_alert
      icon: mdi:shield-alert
      state: >
        {{ not is_state('alarm_control_panel.master','disarmed')
            and state_attr('alarm_control_panel.master','bypassed_sensors')|lower != 'none'
            and is_state('input_boolean.alarm_alerts','on') }}

    # alarm is disconnected, arming, pending or triggered
    # alarm state changed within last minute, forces priority over presence led etc. for 1 minute
    - name: 'Alarm LED Alert'
      unique_id: alarm_led_alert
      state: >
        {{ is_state('input_boolean.alarm_triggered','on')
            or states('alarm_control_panel.master') in ['arming','pending','triggered']
            or now() - states.alarm_control_panel.master.last_changed < timedelta(minutes=1)
            or is_state('alert.alarm_connected','on')
            or is_state('alert.alarm_zone_sync','on')
            or is_state('binary_sensor.alarm_open_sensor_alert','on')
            or is_state('binary_sensor.alarm_bypassed_sensor_alert','on')
            or is_state('alert.door_lock_jammed','on')
            or is_state('alert.door_lock_failed','on') }}

    - name: 'Garage Occupied'
      unique_id: garage_occupied
      state: >
        {{ is_state('binary_sensor.garage_side_door','on')
            or is_state('binary_sensor.garage_door_open','on')
            or is_state('binary_sensor.garage_sensor_motion','on') }}

    - name: 'Danger Alarm'
      unique_id: danger_alarm
      state: >
        {{ (is_state('binary_sensor.smoke_alarm','on')
              or is_state('binary_sensor.co_alarm','on')
              or is_state('binary_sensor.heat_alarm','on'))
            and is_state('alarm_control_panel.master','triggered') }}

- sensor:
    - name: 'Master Alarm Status'
      unique_id: master_alarm_status
      icon: >
        {% if is_state('binary_sensor.alarm_connected','off') %} mdi:shield-remove
        {% elif is_state('input_boolean.alarm_automation','off') %} mdi:shield-off
        {% elif is_state('alarm_control_panel.master','disarmed') %} mdi:shield-check
        {% elif is_state('alarm_control_panel.master','armed_home') %} mdi:shield-home
        {% elif is_state('alarm_control_panel.master','armed_night') %} mdi:shield-moon
        {% elif is_state('alarm_control_panel.master','armed_away') %} mdi:shield-lock
        {% elif is_state('alarm_control_panel.master','arming') %} mdi:shield-half-full
        {% elif is_state('alarm_control_panel.master','pending') %} mdi:shield-alert-outline
        {% elif is_state('alarm_control_panel.master','triggered') %} mdi:shield-alert
        {% else %} mdi:alert
        {% endif %}
      state: >
        {% if is_state('binary_sensor.alarm_connected','off') %} Disconnected
        {% elif is_state('input_boolean.alarm_automation','off') %} Disabled
        {% else %}{{ states('alarm_control_panel.master')|replace('_',' ')|title }}
        {% endif %}

    - name: 'House Alarm Status'
      unique_id: house_alarm_status
      icon: >
        {% if is_state('binary_sensor.alarm_connected','off') %} mdi:shield-remove
        {% elif is_state('input_boolean.alarm_automation','off') %} mdi:shield-off
        {% elif is_state('alarm_control_panel.house','disarmed') %} mdi:shield-check
        {% elif is_state('alarm_control_panel.house','armed_home') %} mdi:shield-home
        {% elif is_state('alarm_control_panel.house','armed_night') %} mdi:shield-moon
        {% elif is_state('alarm_control_panel.house','armed_away') %} mdi:shield-lock
        {% elif is_state('alarm_control_panel.house','arming') %} mdi:shield-half-full
        {% elif is_state('alarm_control_panel.house','pending') %} mdi:shield-alert-outline
        {% elif is_state('alarm_control_panel.house','triggered') %} mdi:shield-alert
        {% else %} mdi:alert
        {% endif %}
      state: >
        {% if is_state('binary_sensor.alarm_connected','off') %} Disconnected
        {% elif is_state('input_boolean.alarm_automation','off') %} Disabled
        {% else %}{{ states('alarm_control_panel.house')|replace('_',' ')|title }}
        {% endif %}

    - name: 'Garage Alarm Status'
      unique_id: garage_alarm_status
      icon: >
        {% if is_state('binary_sensor.alarm_connected','off') %} mdi:shield-remove
        {% elif is_state('input_boolean.alarm_automation','off') %} mdi:shield-off
        {% elif is_state('alarm_control_panel.garage','disarmed') %} mdi:shield-check
        {% elif is_state('alarm_control_panel.garage','armed_home') %} mdi:shield-home
        {% elif is_state('alarm_control_panel.garage','armed_night') %} mdi:shield-moon
        {% elif is_state('alarm_control_panel.garage','armed_away') %} mdi:shield-lock
        {% elif is_state('alarm_control_panel.garage','arming') %} mdi:shield-half-full
        {% elif is_state('alarm_control_panel.garage','pending') %} mdi:shield-alert-outline
        {% elif is_state('alarm_control_panel.garage','triggered') %} mdi:shield-alert
        {% elif is_state('binary_sensor.alarm_connected','off') %} mdi:shield-remove
        {% else %} mdi:alert
        {% endif %}
      state: >
        {% if is_state('binary_sensor.alarm_connected','off') %} Disconnected
        {% elif is_state('input_boolean.alarm_automation','off') %} Disabled
        {% else %}{{ states('alarm_control_panel.garage')|replace('_',' ')|title }}
        {% endif %}
