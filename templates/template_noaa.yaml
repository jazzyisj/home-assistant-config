- binary_sensor:
    - name: "NOAA Connected"
      unique_id: noaa_connected
      icon: "{{ 'mdi:weather-hurricane' if is_state('binary_sensor.noaa_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: "{{ not states('sensor.noaa_alerts_miz076')|lower in ['unknown','unavailable','none'] }}"

    - name: "NOAA Connected Alert"
      unique_id: noaa_connected_alert
      icon: mdi:alert-circle
      state: >
        {{ not is_state('binary_sensor.noaa_connected','on')
            and is_state('input_boolean.system_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: "NOAA Weather Alert"
      unique_id: noaa_weather_alert
      icon: mdi:weather-hurricane
      device_class: safety
      state: "{{ states('sensor.noaa_alerts_miz076')|int > 0 }}"
      attributes:
        type: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ states.sensor.noaa_alerts_miz076.attributes.alerts[0].messageType }}
          {% endif %}
        title: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ states.sensor.noaa_alerts_miz076.attributes.alerts[0].event|title }}
          {% endif %}
        severity: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ states.sensor.noaa_alerts_miz076.attributes.alerts[0].severity }}
          {% endif %}
        condition: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ states.sensor.noaa_alerts_miz076.attributes.alerts[0].event }}
          {% endif %}
        description: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {% set headline = states.sensor.noaa_alerts_miz076.attributes.alerts[0].parameters.NWSheadline %}
            {% set inst = states.sensor.noaa_alerts_miz076.attributes.alerts[0].instruction %}
            {{ headline[0] ~ '.' if headline != None }}
            {{ inst ~ '.' if inst != None }}
          {% endif %}
        starts: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].onset)|timestamp_custom('%A %B %d at %_I:%M %p',true) }}
          {% endif %}
        expires: >
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].ends)|timestamp_custom('%A %B %d at %_I:%M %p',true) }}
          {% endif %}
        active: > #VERIFY
          {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
            {{ as_timestamp(now()) > as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].onset)
                and as_timestamp(now()) < as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].ends) }}
          {% endif %}
        availability: "{{ is_state('binary_sensor.noaa_connected','on') }}"