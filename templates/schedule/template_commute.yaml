###############################################################################
## Templates - Commute
###############################################################################
- binary_sensor:
    - name: 'Google Traffic Connected'
      unique_id: google_traffic_connected
      icon: "{{ 'mdi:car-connected' if is_state('binary_sensor.google_traffic_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ is_number(states('sensor.jason_time_to_home'))
            or is_number(states('sensor.sheri_time_to_home'))
            or is_number(states('sensor.jason_time_to_work'))
            or is_number(states('sensor.sheri_time_to_work')) }}

    - name: 'Google Traffic Connected Alert'
      unique_id: google_traffic_connected_alert
      state: >
        {{ is_state('binary_sensor.google_traffic_connected','off')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    # default to days if today shift none, unknown
    # off 15 min after leave home time (end_time)
    - unique_id: leave_home_jason_alert
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('binary_sensor.jason_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and states('sensor.leave_home_time_jason')|lower not in ['','unknown','unavailable','none'] %}
          {% set leave_time = states('sensor.leave_home_time_jason')|as_datetime %}
          {{ leave_time + timedelta(minutes=15) > now() >= leave_time }}
        {% endif %}

    # off if jason_home, prevent duplicate alert
    - unique_id: leave_home_sheri_alert
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('binary_sensor.jason_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and states('sensor.leave_home_time_sheri')|lower not in ['','unknown','unavailable','none'] %}
          {% set leave_time = states('sensor.leave_home_time_sheri')|as_datetime %}
          {{ leave_time + timedelta(minutes=15) > now() >= leave_time }}
        {% endif %}

    - unique_id: work_commute_jason_alert
      state: >
        {% if (is_state('binary_sensor.leave_home_jason_alert','on')
              or is_state('binary_sensor.work_commute_active','on'))
            and not is_state('person.jason','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.jason_time_to_work')|int(-1) >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: work_commute_sheri_alert
      state: >
        {% if (is_state('binary_sensor.leave_home_sheri_alert','on')
              or is_state('binary_sensor.work_commute_active','on'))
            and not is_state('person.sheri','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.sheri_time_to_work')|int(-1) >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: home_commute_jason_alert
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and not is_state('person.jason','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.jason_time_to_home')|int(-1) >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: home_commute_sheri_alert
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and not is_state('person.sheri','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.sheri_time_to_home')|int(-1) >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: 'Commute Active'
      unique_id: commute_active
      icon: mdi:car
      state: "{{ is_state('binary_sensor.work_commute_active','on') or is_state('binary_sensor.home_commute_active','on') }}"

    - name: 'Work Commute Active'
      unique_id: work_commute_active
      icon: mdi:car
      state: >
        {{ is_state('binary_sensor.days_work_commute','on') or is_state('binary_sensor.afternoons_work_commute','on')
            and not(is_state('person.jason','work') and is_state('person.sheri','work')) }}

    - name: 'Home Commute Active'
      unique_id: home_commute_active
      icon: mdi:car
      state: >
        {{ is_state('binary_sensor.days_home_commute','on') or is_state('binary_sensor.afternoons_home_commute','on')
          and not(is_state('binary_sensor.jason_home','off') and is_state('binary_sensor.sheri_home','on')) }}

    - name: 'Days Work Commute'
      unique_id: days_work_commute
      icon: mdi:car
      #MIDNIGHT if leave time < day_reset < now it is after reset but before midnight - leave time is tomorrow
      #MIDNIGHT if no work tomorrow, sensor turns off at midnight - work_today is off
      state: >
        {% if is_state('input_boolean.commute_times_enabled','on')
            and is_state('binary_sensor.work_today','on')
            and is_state('sensor.today_shift','Afternoons') %}
          {% set leave_time = today_at(states('input_datetime.days_leave_home_time')) %}
          {% set leave = leave_time + timedelta(days=1) if leave_time
              < today_at(states('input_datetime.day_reset')) < now() else leave_time %}
          {% set predep = states('input_number.commute_predeparture')|int %}
          {{ leave - timedelta(minutes=predep) < now() and now() - leave < timedelta(minutes=30) }}
        {% endif %}

    - name: 'Afternoons Work Commute'
      unique_id: afternoons_work_commute
      icon: mdi:car
      state: >
        {% if is_state('input_boolean.commute_times_enabled','on')
            and is_state('binary_sensor.work_today','on')
            and is_state('sensor.today_shift','Afternoons') %}
          {% set leave_time = today_at(states('input_datetime.afternoons_leave_home_time')) %}
          {% set leave = leave_time + timedelta(days=1) if leave_time
              < today_at(states('input_datetime.day_reset')) < now() else leave_time %}
          {% set predep = states('input_number.commute_predeparture')|int %}
          {{ leave - timedelta(minutes=predep) < now() and now() - leave < timedelta(minutes=30) }}
        {% endif %}

    # if leave work time before day_reset
    - name: 'Days Home Commute'
      unique_id: days_home_commute
      icon: mdi:car
      state: >
        {% if is_state('input_boolean.commute_times_enabled','on')
            and is_state('binary_sensor.work_today','on')
            and is_state('sensor.today_shift','Afternoons') %}
          {% set leave_time = today_at(states('input_datetime.days_leave_work_time')) %}
          {% set leave = leave_time + timedelta(days=1) if leave_time
              < today_at(states('input_datetime.day_reset')) < now() else leave_time %}
          {% set predep = states('input_number.commute_predeparture')|int %}
          {{ leave - timedelta(minutes=predep) < now() and now() - leave < timedelta(minutes=30) }}
        {% endif %}

    - name: 'Afternoons Home Commute'
      unique_id: afternoons_home_commute
      icon: mdi:car
      state: >
        {% if is_state('input_boolean.commute_times_enabled','on')
            and is_state('binary_sensor.work_today','on')
            and is_state('sensor.today_shift','Afternoons') %}
          {% set leave_time = today_at(states('input_datetime.afternoons_leave_work_time')) %}
          {% set leave = leave_time + timedelta(days=1) if leave_time
              < today_at(states('input_datetime.day_reset')) < now() else leave_time %}
          {% set predep = states('input_number.commute_predeparture')|int %}
          {{ leave - timedelta(minutes=predep) < now() and now() - leave < timedelta(minutes=30) }}
        {% endif %}

    - name: 'Prework Active'
      unique_id: prework_active
      icon: mdi:account-hard-hat
      state: "{{ state_attr('binary_sensor.prework_active','leave_min')|int(-1) > 0 }}"
      attributes:
        leave_min: >
          {% if is_state('binary_sensor.work_today','on') %}
            {% if is_state('binary_sensor.jason_home','on')
                and states('sensor.leave_home_time_jason')|lower not in ['','unknown','unavailable','none'] %}
              {% set leave_time = states('sensor.leave_home_time_jason')|as_datetime %}
            {% elif is_state('binary_sensor.sheri_home','on')
                and states('sensor.leave_home_time_sheri')|lower not in ['','unknown','unavailable','none'] %}
              {% set leave_time = states('sensor.leave_home_time_sheri')|as_datetime %}
            {% endif %}

            {% if leave_time is defined %}
              {% set leave = leave_time + timedelta(days=1) if leave_time
                  < today_at(states('input_datetime.day_reset')) < now() else leave_time %}
              {% set min = (leave.timestamp() - now().timestamp())/60 %}
              {{ min|int if 30 >= min > 0 }}
            {% endif %}
          {% endif %}

- sensor:
    - unique_id: leave_home_time_jason
      device_class: timestamp
      state: > # adds time to work exceeding threshold
        {% if is_state('binary_sensor.work_today','on') %}
          {% set leave_time = today_at(states('input_datetime.afternoons_leave_home_time'))
              if is_state('sensor.today_shift','Afternoons') else today_at(states('input_datetime.days_leave_home_time')) %}
          {% set add_min = (states('sensor.jason_time_to_work')|int(-1) - states('input_number.commute_warning_threshold')|int)|abs
              if is_state('binary_sensor.work_commute_jason_alert','on') else 0 %}
          {{ (leave_time - timedelta(minutes=add_min)).isoformat() }}
        {% endif %}
      attributes:
        12hour: >
          {% if states('sensor.leave_home_time_jason')|lower not in ['off','','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.leave_home_time_jason'))|as_timestamp|timestamp_custom('%-I:%M %p',true) }}
          {% endif %}
        car_check: >
          {% if states('sensor.leave_home_time_jason')|lower not in ['off','','unknown','unavailable','none'] %}
            {{ now().replace(second=0,microsecond=0) == states('sensor.leave_home_time_jason')|as_datetime - timedelta(seconds=900) }}
          {% endif %}
      availability: "{{ is_number(states('sensor.jason_time_to_work')) }}"

    - unique_id: leave_home_time_sheri
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% set leave_time = today_at(states('input_datetime.afternoons_leave_home_time'))
              if is_state('sensor.today_shift','Afternoons') else today_at(states('input_datetime.days_leave_home_time')) %}
          {% set add_min = (states('sensor.sheri_time_to_work')|int(-1) - states('input_number.commute_warning_threshold')|int)|abs
              if is_state('binary_sensor.work_commute_sheri_alert','on') else 0 %}
          {{ (leave_time - timedelta(minutes=add_min)).isoformat() }}
        {% endif %}
      attributes:
        12hour: >
          {% if states('sensor.leave_home_time_sheri')|lower not in ['off','','unknown','unavailable','none'] %}
            {{ as_datetime(states('sensor.leave_home_time_sheri'))|as_timestamp|timestamp_custom('%-I:%M %p',true) }}
          {% endif %}
        car_check: > # false if jason home, prevent duplicate alert
          {% if is_state('binary_sensor.jason_home','off') and states('sensor.leave_home_time_sheri')|lower not in ['off','','unknown','unavailable','none'] %}
            {{ now().replace(second=0,microsecond=0) == states('sensor.leave_home_time_sheri')|as_datetime - timedelta(seconds=900) }}
          {% endif %}
      availability: "{{ is_number(states('sensor.sheri_time_to_work')) }}"
