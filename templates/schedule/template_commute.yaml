###############################################################################
## Templates - Commute
###############################################################################
- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: sensor.jason_time_to_home
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: sensor.jason_time_to_home
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Google Traffic Connected"
      unique_id: google_traffic_connected
      icon: mdi:car-connected
      device_class: connectivity
      state: >
        {{ expand(integration_entities('google_travel_time'))
            |rejectattr('state','in',['unknown','unavailable'])
            |map(attribute='entity_id')|list|count > 0 }}

- binary_sensor:
    - name: "Google Traffic Connected Alert"
      unique_id: google_traffic_connected_alert
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.google_traffic_connected','off')
            and is_state('input_boolean.commute_alerts','on') }}

    # default to days if today shift none, unknown
    # turns off 15 min after leave home time (end_time)
    - name: "Late For Work Jason Alert"
      unique_id: late_for_work_jason_alert
      device_class: problem
      state: >
        {% set leave = states('sensor.leave_home_time_jason') %}
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('calendar.work_vacation_jason','off')
            and is_state('binary_sensor.jason_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_jason','off')
            and leave not in ['unknown','unavailable'] %}
          {% set leave = leave|as_datetime %}
          {{ leave <= now() < leave + timedelta(minutes=15) }}
        {% endif %}

    - name: "Late For Work Sheri Alert"
      unique_id: late_for_work_sheri_alert
      device_class: problem
      state: >
        {% set leave = states('sensor.leave_home_time_sheri') %}
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('calendar.work_vacation_sheri','off')
            and is_state('binary_sensor.sheri_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_sheri','off')
            and leave not in ['unknown','unavailable'] %}
          {% set leave = leave|as_datetime %}
          {{ leave <= now() < leave + timedelta(minutes=15) }}
        {% endif %}

    - name: "Work Commute Jason Alert"
      unique_id: work_commute_jason_alert
      device_class: problem
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('calendar.work_vacation_jason','off')
            and not is_state('person.jason','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_jason','off') %}
          {{ states('sensor.jason_time_to_work')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: "Work Commute Sheri Alert"
      unique_id: work_commute_sheri_alert
      device_class: problem
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('calendar.work_vacation_sheri','off')
            and not is_state('person.sheri','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_sheri','off') %}
          {{ states('sensor.sheri_time_to_work')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: "Home Commute Jason Alert"
      unique_id: home_commute_jason_alert
      device_class: problem
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and is_state('calendar.work_vacation_jason','off')
            and not is_state('person.jason','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_jason','off') %}
          {{ states('sensor.jason_time_to_home')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: "Home Commute Sheri Alert"
      unique_id: home_commute_sheri_alert
      device_class: problem
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and is_state('calendar.work_vacation_sheri','off')
            and not is_state('person.sheri','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.work_today_off_sheri','off') %}
          {{ states('sensor.sheri_time_to_home')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: "Commute Active"
      unique_id: commute_active
      icon: mdi:car
      state: >
        {{ is_state('binary_sensor.work_commute_active','on')
            or is_state('binary_sensor.home_commute_active','on') }}

    - name: "Work Commute Active"
      unique_id: work_commute_active
      icon: mdi:car
      state: >
        {% set leave = states('sensor.leave_home_time') %}
        {% set arrive = states('sensor.arrive_work_time') %}
        {% if is_state('input_boolean.commute_times_enabled','on')
            and leave not in ['unknown','unavailable']
            and arrive not in ['unknown','unavailable'] %}
          {{ leave|as_datetime - timedelta(minutes=states('input_number.commute_predeparture')|int)
              <= now() < arrive|as_datetime }}
        {% else %} false
        {% endif %}

    - name: "Home Commute Active"
      unique_id: home_commute_active
      icon: mdi:car
      state: >
        {% set leave = states('sensor.leave_work_time') %}
        {% set arrive = states('sensor.arrive_home_time') %}
        {% if is_state('input_boolean.commute_times_enabled','on')
              and leave not in ['unknown','unavailable']
              and arrive not in ['unknown','unavailable'] %}
            {{ leave|as_datetime - timedelta(minutes=states('input_number.commute_predeparture')|int)
                <= now() < arrive|as_datetime }}
        {% else %} false
        {% endif %}

- sensor:
    - name: "Leave Home Time Jason"
      unique_id: leave_home_time_jason
      device_class: timestamp
      state: >
        {% set time = states('sensor.jason_time_to_work') %}
        {% set arrive = states('sensor.arrive_work_time') %}
        {% if is_state('binary_sensor.work_today','on')
            and is_state('input_boolean.work_today_off_jason','off')
            and time not in ['unknown','unavailable']
            and arrive not in ['unknown','unavailable'] %}
          {% set commute = [time|int(states('input_number.commute_time')|int),states('input_number.commute_time')|int]|max %}
          {{ arrive|as_datetime - timedelta(minutes=commute) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: "{{ states('sensor.leave_home_time_jason')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Leave Home Time Sheri"
      unique_id: leave_home_time_sheri
      device_class: timestamp
      state: >
        {% set time = states('sensor.sheri_time_to_work') %}
        {% set arrive = states('sensor.arrive_work_time') %}
        {% if is_state('binary_sensor.work_today','on')
            and is_state('input_boolean.work_today_off_sheri','off')
            and time not in ['unknown','unavailable']
            and arrive not in ['unknown','unavailable'] %}
          {% set commute = [time|int(states('input_number.commute_time')|int),states('input_number.commute_time')|int]|max %}
          {{ arrive|as_datetime - timedelta(minutes=commute) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: "{{ states('sensor.leave_home_time_sheri')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: "Leave Home Time"
      unique_id: leave_home_time
      device_class: timestamp
      state: >
        {% set jason = states('sensor.leave_home_time_jason') %}
        {% set sheri = states('sensor.leave_home_time_sheri') %}
        {% if is_state('binary_sensor.work_today','on') and jason not in ['unknown','unavailable'] %} {{ jason|as_datetime }}
        {% elif is_state('binary_sensor.work_today','on') and sheri not in ['unknown','unavailable'] %} {{ sheri|as_datetime }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: "{{ states('sensor.leave_home_time')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"
        leave_min: >
          {% set leave = states('sensor.leave_home_time') %}
          {% if leave not in ['unknown','unavailable'] %}
            {{ ((leave|as_timestamp - now().timestamp()) / 60)|int }}
          {% endif %}

    - name: "Car Start Time"
      unique_id: car_start_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.owner_home','on') %}
          {% set leave = states('sensor.leave_home_time') %}
          {% if leave not in ['unknown','unavailable'] %}
            {{ (leave|as_datetime).replace(second=0,microsecond=0) - timedelta(minutes=15) }}
          {% else %} {{ none }}
          {% endif %}
        {% else %} {{ none }}
        {% endif %}

    - name: "Arrive Work Time"
      unique_id: arrive_work_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% set day_reset = today_at(states('input_datetime.day_reset')) %}
          {% set arrive_work = today_at(states('input_datetime.afternoons_arrive_work_time'))
              if is_state('sensor.work_shift_today','Afternoons') else today_at(states('input_datetime.days_arrive_work_time')) %}
          {% set arrive_work = arrive_work|as_timestamp|timestamp_utc|as_datetime %} {# keep format consistent #}
          {{ arrive_work + timedelta(days=1) if arrive_work < day_reset < now() else arrive_work }}
        {% else %} {{ none }}
        {% endif %}

    #MIDNIGHT if leave time is before day_reset and now is after reset, leave time is +1 day for today's leave time
    - name: "Leave Work Time"
      unique_id: leave_work_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% set day_reset = today_at(states('input_datetime.day_reset')) %}
          {% set leave = today_at(states('input_datetime.afternoons_leave_work_time'))
              if is_state('sensor.work_shift_today','Afternoons') else today_at(states('input_datetime.days_leave_work_time')) %}
          {{ leave + timedelta(days=1) if leave < day_reset < now() else leave }}
        {% else %} {{ none }}
        {% endif %}

    - name: "Arrive Home Time"
      unique_id: arrive_home_time
      device_class: timestamp
      state: >
        {% set leave = states('sensor.leave_work_time') %}
        {% if is_state('binary_sensor.work_today','on') and leave not in ['unknown','unavailable'] %}
          {{ leave|as_datetime + timedelta(minutes=states('input_number.commute_time')|int) }}
        {% else %} {{ none }}
        {% endif %}
