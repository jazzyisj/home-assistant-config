###############################################################################
## Templates - Commute
###############################################################################
- binary_sensor:
    - name: 'Google Traffic Connected'
      unique_id: google_traffic_connected
      icon: "{{ 'mdi:car-connected' if is_state('binary_sensor.google_traffic_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ is_number(states('sensor.jason_time_to_home'))
            or is_number(states('sensor.sheri_time_to_home'))
            or is_number(states('sensor.jason_time_to_work'))
            or is_number(states('sensor.sheri_time_to_work')) }}

    - name: 'Google Traffic Connected Alert'
      unique_id: google_traffic_connected_alert
      state: >
        {{ is_state('binary_sensor.google_traffic_connected','off')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    # default to days if today shift none, unknown
    # off 15 min after leave home time (end_time)
    - unique_id: leave_home_jason_alert
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('binary_sensor.jason_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and states('sensor.leave_home_time_jason')|lower not in ['','unknown','unavailable','none'] %}
          {% set leave_time = states('sensor.leave_home_time_jason')|as_datetime %}
          {{ leave_time + timedelta(minutes=15) > now() >= leave_time }}
        {% endif %}

    # off if jason_home, prevent duplicate alert
    - unique_id: leave_home_sheri_alert
      state: >
        {% if is_state('binary_sensor.work_commute_active','on')
            and is_state('binary_sensor.jason_home','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off')
            and states('sensor.leave_home_time_sheri')|lower not in ['','unknown','unavailable','none'] %}
          {% set leave_time = states('sensor.leave_home_time_sheri')|as_datetime %}
          {{ leave_time + timedelta(minutes=15) > now() >= leave_time }}
        {% endif %}

    - unique_id: work_commute_jason_alert
      state: >
        {% if (is_state('binary_sensor.leave_home_jason_alert','on')
              or is_state('binary_sensor.work_commute_active','on'))
            and not is_state('person.jason','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.jason_time_to_work')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: work_commute_sheri_alert
      state: >
        {% if (is_state('binary_sensor.leave_home_sheri_alert','on')
              or is_state('binary_sensor.work_commute_active','on'))
            and not is_state('person.sheri','Work')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.sheri_time_to_work')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: home_commute_jason_alert
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and not is_state('person.jason','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.jason_time_to_home')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - unique_id: home_commute_sheri_alert
      state: >
        {% if is_state('binary_sensor.home_commute_active','on')
            and not is_state('person.sheri','home')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('input_boolean.startup_pending','off') %}
          {{ states('sensor.sheri_time_to_home')|int(-1)
              >= states('input_number.commute_warning_threshold')|int }}
        {% endif %}

    - name: 'Commute Active'
      unique_id: commute_active
      icon: mdi:car
      state: >
        {{ is_state('binary_sensor.work_commute_active','on')
            or is_state('binary_sensor.home_commute_active','on') }}

    - name: 'Work Commute Active'
      unique_id: work_commute_active
      icon: mdi:car
      state: >
        {% if states('sensor.leave_home_time')|lower not in ['unknown','unavailable','none']
            and states('sensor.arrive_work_time')|lower not in ['unknown','unavailable','none'] %}
          {% set leave_home = states('sensor.leave_home_time')|as_datetime
                - timedelta(minutes=states('input_number.commute_predeparture')|int) %}
          {% set arrive_work =  states('sensor.arrive_work_time')|as_datetime %}
          {{ leave_home <= now() < arrive_work }}
        {% endif %}

    - name: 'Home Commute Active'
      unique_id: home_commute_active
      icon: mdi:car
      state: >
        {% if states('sensor.arrive_home_time')|lower not in ['unknown','unavailable','none']
            and states('sensor.leave_work_time')|lower not in ['unknown','unavailable','none'] %}
          {% set leave_work = states('sensor.leave_work_time')|as_datetime
              - timedelta(minutes=states('input_number.commute_predeparture')|int) %}
          {% set arrive_home = states('sensor.arrive_home_time')|as_datetime %}
          {% if leave_work != none and arrive_home != none %}
            {{ leave_work <= now() < arrive_home }}
          {% endif %}
        {% endif %}

- sensor:
    - name: 'Leave Home Time Jason'
      unique_id: leave_home_time_jason
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on')
            and states('sensor.jason_time_to_work')|lower not in ['unknown','unavailable','none']
            and states('sensor.arrive_work_time')|lower not in ['unknown','unavailable','none'] %}
          {% set commute = states('sensor.jason_time_to_work')|int(states('input_number.commute_time')|int) %}
          {% set arrive_work = states('sensor.arrive_work_time')|as_datetime %}
          {{ arrive_work - timedelta(minutes=commute) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: "{{ states('sensor.leave_home_time_jason')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    - name: 'Leave Home Time Sheri'
      unique_id: leave_home_time_sheri
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on')
            and states('sensor.sheri_time_to_work')|lower not in ['unknown','unavailable','none']
            and states('sensor.arrive_work_time')|lower not in ['unknown','unavailable','none'] %}
          {% set commute = states('sensor.sheri_time_to_work')|int(states('input_number.commute_time')|int) %}
          {% set arrive_work = states('sensor.arrive_work_time')|as_datetime %}
          {{ arrive_work - timedelta(minutes=commute) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: "{{ states('sensor.leave_home_time_sheri')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"

    #MIDNIGHT if arrive time is before day_reset and now is after reset, arrive time is +1 day for today's leave time
    - name: 'Leave Home Time'
      unique_id: leave_home_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% if is_state('binary_sensor.jason_home','on')
              and states('sensor.leave_home_time_jason')|lower not in ['unknown','unavailable','none'] %}
            {{ states('sensor.leave_home_time_jason')|as_datetime }}
          {% elif is_state('binary_sensor.sheri_home','on')
              and states('sensor.leave_home_time_sheri')|lower not in ['unknown','unavailable','none'] %}
            {{ states('sensor.leave_home_time_sheri')|as_datetime }}
          {% else %} {{ none }}
          {% endif %}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        12hour: >
          {% if states('sensor.leave_home_time')|lower not in ['unknown','unavailable','none'] %}
            {{ states('sensor.leave_home_time')|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}
          {% endif %}
        leave_min: >
          {% if states('sensor.leave_home_time')|lower not in ['unknown','unavailable','none'] %}
            {% set leave_time = states('sensor.leave_home_time')|as_datetime %}
            {% set minutes = ((leave_time.timestamp() - now().timestamp()) / 60)|int %}
            {{ minutes if states('input_number.commute_predeparture')|int >= minutes > 0 else none }}
          {% endif %}

    - name: 'Car Start Time'
      unique_id: car_start_time
      device_class: timestamp
      state: >
        {% if states('sensor.leave_home_time')|lower not in ['unknown','unavailable','none'] %}
          {% set leave = (states('sensor.leave_home_time')|as_datetime).replace(second=0,microsecond=0)
            - timedelta(minutes=15) %}
          {{ now().replace(second=0,microsecond=0) }}
        {% else %} {{ none }}
        {% endif %}

    - name: 'Arrive Work Time'
      unique_id: arrive_work_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% set day_reset = today_at(states('input_datetime.day_reset')) %}
          {% set arrive_work = today_at(states('input_datetime.afternoons_arrive_work_time'))
              if is_state('sensor.today_shift','Afternoons') else today_at(states('input_datetime.days_arrive_work_time')) %}
          {% set arrive_work = arrive_work|as_timestamp|timestamp_utc|as_datetime %} {# keep format consistent #}
          {{ arrive_work + timedelta(days=1) if arrive_work < day_reset < now() else arrive_work }}
        {% else %} {{ none }}
        {% endif %}

    #MIDNIGHT if leave time is before day_reset and now is after reset, leave time is +1 day for today's leave time
    - name: 'Leave Work Time'
      unique_id: leave_work_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on') %}
          {% set day_reset = today_at(states('input_datetime.day_reset')) %}
          {% set leave_time = today_at(states('input_datetime.afternoons_leave_work_time'))
              if is_state('sensor.today_shift','Afternoons') else today_at(states('input_datetime.days_leave_work_time')) %}
          {{ leave_time + timedelta(days=1) if leave_time < day_reset < now() else leave_time }}
        {% else %} {{ none }}
        {% endif %}

    - name: 'Arrive Home Time'
      unique_id: arrive_home_time
      device_class: timestamp
      state: >
        {% if is_state('binary_sensor.work_today','on')
            and states('sensor.leave_work_time')|lower not in ['unknown','unavailable','none']%}
          {% set day_reset = today_at(states('input_datetime.day_reset')) %}
          {% set leave_time = states('sensor.leave_work_time')|as_datetime %}
          {{ leave_time + timedelta(minutes=states('input_number.commute_time')|int) }}
        {% else %} {{ none }}
        {% endif %}
