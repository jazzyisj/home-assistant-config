###############################################################################
## Templates - Work Schedule
###############################################################################
- binary_sensor:
    - name: 'Work Schedule'
      unique_id: work_schedule
      icon: mdi:factory
      state: "{{ is_state('input_boolean.work_schedule','on') and is_state('binary_sensor.work_vacation','on') }}" #TEST

    - name: 'Work Today'
      unique_id: work_today
      icon: '{{ states.sensor.today_shift.attributes.icon }}'
      state: >
        {% if is_state('binary_sensor.work_schedule','off') %} false
        {% elif is_state('calendar.work_holiday','on') %} {{ is_state('input_boolean.holiday_workday','on') }}
        {% elif now().weekday() == 5 %} {{ is_state('input_boolean.saturday_workday','on') }}
        {% elif now().weekday() == 6 %} {{ is_state('input_boolean.sunday_workday','on') }}
        {% else %} {{ is_state('binary_sensor.workday','on') }}
        {% endif %}

    - name: 'Work Tomorrow'
      unique_id: work_tomorrow
      icon: '{{ states.sensor.tomorrow_shift.attributes.icon }}'
      state: >
        {% if is_state('binary_sensor.work_schedule','off') %} false
        {% elif is_state('binary_sensor.work_holiday_tomorrow','on') %} {{ is_state('input_boolean.holiday_workday','on') }}
        {% elif now().weekday() == 4 %} {{ is_state('input_boolean.saturday_workday','on') }}
        {% elif now().weekday() == 5 %} {{ is_state('input_boolean.sunday_workday','on') }}
        {% else %} {{ is_state('binary_sensor.workday_tomorrow','on') }}
        {% endif %}

    # work holiday start within 24 hours and end not in past
    - name: 'Work Holiday Tomorrow'
      unique_id: work_holiday_tomorrow
      state: >
        {% set start = state_attr('calendar.work_holiday','start_time')|as_timestamp('unknown') %}
        {% set end = state_attr('calendar.work_holiday','end_time')|as_timestamp('unknown') %}
        {% set time = now().timestamp() %}
          {{ false if (start == 'unknown' or end == 'unknown')
                else (start - time <= 86400 and end - time > 0) }}
      availability: "{{ states('calendar.work_holiday')|lower not in ['unknown','unavailable','none'] }}"

    # work layoff start within 24 hours and end more than 24 hours away
    # same for jason vacation, sheri vacation - both must be true
    - name: 'Work Vacation'
      unique_id: work_vacation
      icon: mdi:beach
      state: >
        {% set time = now().timestamp() %}
        {% set layoff_start =  state_attr('calendar.work_layoff','start_time')|as_timestamp('unknown') %}
        {% set layoff_end =  state_attr('calendar.work_layoff','end_time')|as_timestamp('unknown') %}
        {% set vac_jason_start =  state_attr('calendar.work_vacation_jason','start_time')|as_timestamp('unknown') %}
        {% set vac_jason_end =  state_attr('calendar.work_vacation_jason','end_time')|as_timestamp('unknown') %}
        {% set vac_sheri_start =  state_attr('calendar.work_vacation_sheri','start_time')|as_timestamp('unknown') %}
        {% set vac_sheri_end =  state_attr('calendar.work_vacation_sheri','end_time')|as_timestamp('unknown') %}

        {{ (false if layoff_start == 'unknown' or layoff_end == 'unknown'
              else layoff_start - time < 86400 and layoff_end - time > 86400 )
            or ((false if vac_jason_start == 'unknown' or vac_jason_end == 'unknown'
                  else vac_jason_start - time < 86400 and vac_jason_end - time > 86400)
              and (false if vac_sheri_start == 'unknown' or vac_sheri_end == 'unknown'
                  else vac_sheri_start - time < 86400 and vac_sheri_end - time > 86400)) }}
      availability: "{{ is_state('binary_sensor.google_calendar_connected','on') }}"

    - unique_id: shift_selection_alert
      delay_on:
        minutes: 5 # so user can select new shift before notification is sent
      state: >
        {{ is_state('input_boolean.work_shift_override','on')
              or (is_state('input_boolean.work_shift_override','off')
                and is_state('sensor.today_shift','Off'))
            if is_state('input_boolean.schedule_alerts','on')
              and is_state('binary_sensor.work_schedule','on')
              and is_state('input_boolean.startup_pending','off') else false }}
      availability: "{{ is_state('binary_sensor.google_calendar_connected','on') }}"

- sensor:
    - name: 'Today Shift'
      unique_id: today_shift
      icon: >
        {% if is_state('input_boolean.work_schedule','off') %} mdi:alpha-x-circle
        {% else %}
          {% if is_state('sensor.today_shift','Days') %} mdi:alpha-d-circle
          {% elif is_state('sensor.today_shift','Afternoons') %} mdi:alpha-a-circle
          {% else %} mdi:calendar-alert
          {% endif %}
        {% endif %}
      state: "{{ states('input_select.work_shift_selection') }}"

    # checks for next days/afternoons calandar event to be less than 24 hours away
    # if today shift is unknown, none then tomorrow shift is unknown
    - unique_id: tomorrow_shift
      icon: >
        {% if is_state('input_boolean.work_schedule','off') %} mdi:alpha-x-circle
        {% else %}
          {% if is_state('sensor.tomorrow_shift','Days') %} mdi:alpha-d-circle
          {% elif is_state('sensor.tomorrow_shift','Afternoons') %} mdi:alpha-a-circle
          {% else %} mdi:calendar-alert
          {% endif %}
        {% endif %}
      state: >
        {% if state_attr('calendar.days','start_time')|lower not in ['','unknown','unavailable','none']
            and state_attr('calendar.afternoons','start_time')|lower not in ['','unknown','unavailable','none'] %}
          {% set days_start = state_attr('calendar.days','start_time')|as_timestamp - now().timestamp() %}
          {% set afts_start = state_attr('calendar.afternoons','start_time')|as_timestamp - now().timestamp() %}
          {% set days_end = state_attr('calendar.days','end_time')|as_timestamp - now().timestamp() %}
          {% set afts_end = state_attr('calendar.afternoons','end_time')|as_timestamp - now().timestamp() %}

          {% if is_state('input_boolean.work_shift_override','on') %}{{ states('input_select.work_shift_selection') }}
          {% elif is_state('sensor.today_shift','Off') %} Off
          {% elif days_start < 86400 and days_end > 86400  %} Days
          {% elif afts_start < 86400 and afts_end > 86400 %} Afternoons
          {% else %}{{ states('sensor.today_shift') }}
          {% endif %}
        {% else %} unknown
        {% endif %}

    - name: 'Next Work Holiday'
      unique_id: next_work_holiday
      icon: mdi:calendar-heart
      state: >
        {% set start = state_attr('calendar.work_holiday','start_time')|as_timestamp %}
        {% if state_attr('calendar.work_holiday','start_time')|lower == 'none' %} Off
        {% elif is_state('calendar.work_holiday','on') %} Today
        {% elif 0 > start - now().timestamp() <= 86400 %} Tomorrow
        {% else%} {{ start|timestamp_custom('%a, %b %d',true,'unknown') }}
        {% endif %}
      availability: > # none/null value - calendar is empty
        {{ states('calendar.work_holiday')|lower not in ['unknown','unavailable'] }}
