###############################################################################
## Templates - Calendar
###############################################################################
- button:
    - name: "Update Calendar"
      unique_id: udpate_calendar
      icon: mdi:calendar
      press:
        - service: homeassistant.update_entity
          data:
            entity_id:
              - calendar.days1
              - calendar.days2
              - calendar.afternoons1
              - calendar.afternoons2
              - calendar.work_holiday
              - calendar.garbage
              - calendar.recycle
              - calendar.yardwaste
              - calendar.work_layoff
              - calendar.work_vacation_jason
              - calendar.work_vacation_sheri

        - service: browser_mod.notification
          data:
            message: "Updating calendars."
            duration: 30000

- trigger:
    - platform: homeassistant
      event: start

    - platform: event
      event_type: event_template_reloaded

    - platform: state
      entity_id: calendar.work_calendar
      from:
        - unknown
        - unavailable

    - platform: state
      entity_id: calendar.work_calendar
      to:
        - unknown
        - unavailable
  binary_sensor:
    - name: "Google Calendar Connected"
      unique_id: google_calendar_connected
      icon: mdi:calendar
      device_class: connectivity
      state: >
        {{ expand(integration_entities('google'))
            |rejectattr('state','in',['unknown','unavailable'])|list|count > 0 }}

- binary_sensor:
    - name: "Google Calendar Connected Alert"
      unique_id: google_calendar_connected_alert
      icon: mdi:calendar
      device_class: problem
      delay_on: 60
      state: >
        {{ is_state('binary_sensor.google_calendar_connected','off')
            and is_state('input_boolean.schedule_alerts','on') }}

    - name: "Calendar Empty Alert"
      unique_id: calendar_empty_alert
      state: >
        {% set entities = state_attr(this.entity_id,'entity_id') %}
        {{ false if entities == none or is_state('input_boolean.schedule_alerts','off') else entities|count > 0 }}
      attributes: # vacation/layoff calendars not included - usually empty
        entity_id: >
          {{ states.calendar|selectattr('attributes.start_time','eq',null)
              |rejectattr('entity_id','in',['calendar.work_vacation_jason','calendar.work_vacation_sheri','calendar.work_layoff'])
              |map(attribute='name')|list }}
      availability: "{{ is_state('binary_sensor.google_calendar_connected','on') }}"

- sensor:
    - name: "Next Waste Day"
      unique_id: next_waste_day
      device_class: timestamp
      icon: >
        {% set next = states('sensor.next_waste_day') %}
        {% if next == states('sensor.next_garbage_day')
            and states.sensor.next_garbage_day.attributes is defined %}
          {{ states.sensor.next_garbage_day.attributes.icon }}
        {% elif next == states('sensor.next_recycle_day')
            and states.sensor.next_recycle_day.attributes is defined %}
          {{ states.sensor.next_recycle_day.attributes.icon }}
        {% elif next == states('sensor.next_yardwaste_day')
            and states.sensor.next_yardwaste_day.attributes is defined %}
          {{ states.sensor.next_yardwaste_day.attributes.icon }}
        {% else %} mdi:trash-can
        {% endif %}
      state: >
        {% set garbage = none if states('sensor.next_garbage_day') in ['unknown','unavailable']
            else states('sensor.next_garbage_day')|as_datetime|as_local %}
        {% set recycle = none if states('sensor.next_recycle_day') in ['unknown','unavailable']
            else states('sensor.next_recycle_day')|as_datetime|as_local %}
        {% set yardwaste = none if states('sensor.next_yardwaste_day') in ['unknown','unavailable']
            else states('sensor.next_yardwaste_day')|as_datetime|as_local %}
        {% set types = [garbage, recycle, yardwaste] %}
        {% set active = namespace(types=[]) %}
        {% for item in types if item != none %}
          {% set active.types = active.types + [item] %}
        {% endfor %}
        {{ none if active.types == [] else active.types|min }}
      attributes:
        display: >
          {% set next = none if states('sensor.next_waste_day') in ['unknown','unavailable']
              else states('sensor.next_waste_day')|as_datetime %}
          {% if next != none %}
            {% if next.day == now().day %} Today
            {% elif next - now() <= timedelta(hours=24) %} Tomorrow
            {% elif next-now() > timedelta(days=365) %} None
            {% else %} {{ next.strftime('%a, %b %d') }}
            {% endif %}
          {% else %} unknown
          {% endif %}
        waste_type: >
          {% set next = states('sensor.next_waste_day') %}
          {% if next == states('sensor.next_garbage_day') %} garbage
          {% elif next == states('sensor.next_recycle_day') %} recycle
          {% elif next == states('sensor.next_yardwaste_day') %} yardwaste
          {% endif %}

    #MIDNIGHT add day_reset to prevent alerts night before, as_local to add tz
    - name: "Next Garbage Day"
      unique_id: next_garbage_day
      icon: mdi:trash-can
      device_class: timestamp
      state: >
        {% if state_attr('calendar.garbage','start_time') != none %}
          {{ state_attr('calendar.garbage','start_time')|as_datetime|as_local
              + as_timedelta(states('input_datetime.day_reset')) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        display: >
          {% if states(this.entity_id) not in ['unknown','unavailable'] %}
            {% set start = states(this.entity_id)|as_datetime %}
            {% if now() > start %} Today
            {% elif start - now() < timedelta(days=1) %} Tomorrow
            {% else %} {{ start.strftime('%a, %b %d') }}
            {% endif %}
          {% endif %}

    # add day_reset to prevent alerts night before, as_local to add tz
    - name: "Next Recycle Day"
      unique_id: next_recycle_day
      icon: mdi:recycle
      device_class: timestamp
      state: >
        {% if state_attr('calendar.recycle','start_time') != none %}
          {{ state_attr('calendar.recycle','start_time')|as_datetime|as_local
              + as_timedelta(states('input_datetime.day_reset')) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        display: >
          {% if states(this.entity_id) not in ['unknown','unavailable'] %}
            {% set start = states(this.entity_id)|as_datetime %}
            {% if now() > start %} Today
            {% elif start - now() < timedelta(days=1) %} Tomorrow
            {% else %} {{ start.strftime('%a, %b %d') }}
            {% endif %}
          {% endif %}

    # add day_reset to prevent alerts night before, as_local to add tz
    - name: "Next Yardwaste Day"
      unique_id: next_yardwaste_day
      icon: mdi:pine-tree
      device_class: timestamp
      state: >
        {% if state_attr('calendar.yardwaste','start_time') != none %}
          {{ state_attr('calendar.yardwaste','start_time')|as_datetime|as_local
              + as_timedelta(states('input_datetime.day_reset')) }}
        {% else %} {{ none }}
        {% endif %}
      attributes:
        display: >
          {% if states(this.entity_id) not in ['unknown','unavailable'] %}
            {% set start = states(this.entity_id)|as_datetime %}
            {% if now() > start %} Today
            {% elif start - now() < timedelta(days=1) %} Tomorrow
            {% else %} {{ start.strftime('%a, %b %d') }}
            {% endif %}
          {% endif %}
        warning: >
          {% if states(this.entity_id) not in ['unknown','unavailable'] %}
            {% set start = states(this.entity_id)|as_datetime %}
            {{ start - now() < timedelta(days=3) and start - now() > timedelta(days=1) }}
          {% endif %}
