###############################################################################
## Templates - Calendar
###############################################################################
- binary_sensor:
    - name: 'Google Calendar Connected'
      unique_id: google_calendar_connected #ISSUE stays connected when wan down?
      icon: "{{ 'mdi:calendar' if is_state('binary_sensor.google_calendar_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      state: >
        {{ not states('calendar.days')|lower in ['unknown','unavailable','none']
            and not states('calendar.afternoons')|lower in ['unknown','unavailable','none']
            and not states('calendar.work_holiday')|lower in ['unknown','unavailable','none']
            and not states('calendar.garbage')|lower in ['unknown','unavailable','none']
            and not states('calendar.recycle')|lower in ['unknown','unavailable','none']
            and not states('calendar.yardwaste')|lower in ['unknown','unavailable','none'] }}

    - name: 'Google Calendar Connected Alert'
      unique_id: google_calendar_connected_alert
      icon: mdi:calendar
      state: >
        {{ is_state('binary_sensor.google_calendar_connected','off')
            and is_state('input_boolean.schedule_alerts','on')
            and is_state('input_boolean.startup_pending','off') }}

    - name: 'Google Calendar Empty Alert'
      unique_id: google_calendar_empty_alert
      state: >
        {{ (state_attr('calendar.garbage','start_time')|lower in ['unknown','unavailable','none']
              or state_attr('calendar.recycle','start_time')|lower in ['unknown','unavailable','none']
              or state_attr('calendar.yardwaste','start_time')|lower in ['unknown','unavailable','none']
              or state_attr('calendar.days','start_time')|lower in ['unknown','unavailable','none']
              or state_attr('calendar.afternoons','start_time')|lower in ['unknown','unavailable','none']
              or state_attr('calendar.work_holiday','start_time')|lower in ['unknown','unavailable','none'])
                and is_state('input_boolean.schedule_alerts','on') }}
      availability: "{{ is_state('binary_sensor.google_calendar_connected','on') }}"

- sensor:
    - name: 'Next Garbage Day'
      unique_id: next_garbage_day
      icon: mdi:trash-can
      state: >
        {% set start = as_datetime(state_attr('calendar.garbage','start_time')).timestamp() %}
        {% set now = now().timestamp() %}
        {% if state_attr('calendar.garbage','start_time')|lower == 'none' %} Off
        {% elif is_state('calendar.garbage','on') %} Today
        {% elif start - now < 86400 and start - now > 0 %} Tomorrow
        {% else %} {{ start|timestamp_custom('%a, %b %d',true,'unknown') }}
        {% endif %}
      availability: > # none/null value - calendar is just empty
        {{ states('calendar.garbage')|lower not in ['unknown','unavailable']
            and is_state('binary_sensor.google_calendar_connected','on') }}

    - name: 'Next Recycle Day'
      unique_id: next_recycle_day
      icon: mdi:recycle
      state: >
        {% set start = as_datetime(state_attr('calendar.recycle','start_time')).timestamp() %}
        {% set now = now().timestamp() %}
        {% if state_attr('calendar.recycle','start_time')|lower == 'none' %} Off
        {% elif is_state('calendar.recycle','on') %} Today
        {% elif start - now < 86400 and start - now > 0 %} Tomorrow
        {% else %} {{ start|timestamp_custom('%a, %b %d',true,'unknown') }}
        {% endif %}
      availability: > # none/null value - calendar is empty
        {{ states('calendar.recycle')|lower not in ['unknown','unavailable']
            and is_state('binary_sensor.google_calendar_connected','on') }}

    - name: 'Next Yardwaste Day'
      unique_id: next_yardwaste_day
      icon: mdi:pine-tree
      state: >
        {% set start = as_datetime(state_attr('calendar.yardwaste','start_time')).timestamp() %}
        {% set now = now().timestamp() %}
        {% if state_attr('calendar.yardwaste','start_time')|lower == 'none' %} Off
        {% elif is_state('calendar.yardwaste','on') %} Today
        {% elif start - now < 86400 and start - now > 0 %} Tomorrow
        {% else %} {{ start|timestamp_custom('%a, %b %d',true,'unknown') }}
        {% endif %}
      availability: > # none/null value - calendar is empty
        {{ states('calendar.yardwaste')|lower not in ['unknown','unavailable']
            and is_state('binary_sensor.google_calendar_connected','on') }}
