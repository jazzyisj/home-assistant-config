###############################################################################
## Templates - Bluetooth
###############################################################################
- binary_sensor:
    - name: "Bluetooth Offline Alert"
      unique_id: bluetooth_offline_alert
      icon: mdi:bluetooth
      device_class: problem
      delay_on: 60
      state:
        "off" #> #TEMP until fixed
        # {{ expand(state_attr('sensor.bluetooth_devices', 'entity_id'))
        #        | selectattr('state', 'eq', 'home') | list | count == 0
        #     and expand(state_attr('sensor.bluetooth_le_devices', 'entity_id'))
        #            | selectattr('state', 'eq', 'home') | list | count == 0 }}

- sensor:
    - name: "Bluetooth Devices"
      unique_id: bluetooth_devices
      icon: mdi:bluetooth-settings
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id, 'entity_id') %}
        {{ c | count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker | selectattr('attributes.device_type', 'eq', 'bluetooth')
              | map(attribute='entity_id') | list }}

    - name: "Bluetooth LE Devices"
      unique_id: bluetooth_le_devices
      icon: mdi:bluetooth-settings
      unit_of_measurement: devices
      state: >
        {% set c = state_attr(this.entity_id, 'entity_id') %}
        {{ c | count if c != none else none }}
      attributes:
        entity_id: >
          {{ states.device_tracker | selectattr('attributes.device_type', 'eq', 'bluetooth_le')
              | map(attribute='entity_id') | list }}
