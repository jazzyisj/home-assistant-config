###############################################################################
# Presence Sheri
###############################################################################
type: entities
state_color: true
entities:
  - type: custom:fold-entity-row
    head:
      entity: person.sheri
      secondary_info: last-updated
      double_tap_action:
        action: fire-dom-event
        browser_mod:
          command: popup
          deviceID: this
          hide_header: true
          title: 'Sheri Location'
          card: !include /config/lovelace/card/presence/sheri_location.yaml
    entities:
      - type: custom:fold-entity-row
        head:
          entity: binary_sensor.sheri_home
          name: 'Sheri Home'
          secondary_info: last-updated
          state_color: true
          card_mod:
            style: |
              :host {
                --paper-item-icon-color:
                  {%- if is_state('input_boolean.home_override_sheri','on') %} var(--entity-warning-color)
                  {%- elif is_state('binary_sensor.sheri_home','on') %} var(--state-icon-active-color)
                  {%- else %} var(--state-icon-color)
                  {%- endif -%}
                ;
              }
        open_template: "{{ is_state('input_boolean.home_override_sheri','on') }}"
        group_config:
          secondary_info: last-updated
        entities:
          - type: custom:multiple-entity-row
            entity: input_boolean.sheri_home
            name: 'Toggle Home'
            state_header: Home
            state_color: true
            toggle: true
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {%- if is_state('input_boolean.home_override_sheri','on') %} var(--entity-warning-color)
                    {%- else%} var(--state-icon-color)
                    {%- endif -%}
                    ;
                  --paper-item-icon-active-color:
                    {%- if is_state('input_boolean.home_override_sheri','on') %} var(--entity-warning-color)
                    {%- else%} var(--state-icon-active-color)
                    {%- endif -%}
                  ;
                }
            entities:
              - entity: input_boolean.home_override_sheri
                name: 'Override'
                state_color: true
                toggle: true
                card_mod:
                  style: |
                    :host {
                      --paper-item-icon-color: var(--state-icon-color);
                      --paper-item-icon-active-color: var(--entity-warning-color);
                    }

              - entity: input_boolean.sheri_almost_home
                name: 'Almost Home'
                state_color: true
                toggle: true

      - type: custom:fold-entity-row
        head:
          type: custom:template-entity-row
          entity: device_tracker.sheri_tracker
          state: "{{ states('device_tracker.sheri_tracker')|title }}"
          secondary: >
            {% if state_attr('device_tracker.sheri_tracker','last_seen')|lower != 'none' %}
              {% set time = state_attr('device_tracker.sheri_tracker','last_seen')|as_local %}
              Last Update: {{ time.strftime('Today at %-I:%M %p') if now().day == time.day else time.strftime('%A, %-I:%M %p') }}
            {% endif %}
          card_mod:
            style: |
              :host {
                --paper-item-icon-color:
                  {%- if states('device_tracker.sheri_tracker') =='home' %} var(--state-icon-active-color)
                  {%- else%} var(--state-icon-color)
                  {%- endif -%}
                ;
              }
        group_config:
          secondary_info: last-changed
        entities:
          - entity: device_tracker.sphone
            name: 'Phone Tracker'
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if states('device_tracker.sphone') =='home' %} var(--state-icon-active-color)
                    {% else%} var(--state-icon-color)
                    {% endif %}
                  ;
                }

          - entity: device_tracker.sphone_bt
            name: 'Phone Bluetooth'
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if states('device_tracker.sphone_bt') =='home' %} var(--state-icon-active-color)
                    {% else%} var(--state-icon-color)
                    {% endif %}
                  ;
                }

          - type: custom:fold-entity-row
            head:
              entity: binary_sensor.sheri_phone_wifi_connected
            group_config:
              secondary_info: last-changed
            entities:
              - entity: device_tracker.sphone_wifi
                name: 'Phone WIFI - AP'
                card_mod:
                  style: |
                    :host {
                      --paper-item-icon-color:
                        {% if states('device_tracker.sphone_wifi') =='home' %} var(--state-icon-active-color)
                        {% else%} var(--state-icon-color)
                        {% endif %}
                      ;
                    }

              - entity: device_tracker.sphone_router_wifi
                name: 'Phone WIFI - Router'
                card_mod:
                  style: |
                    :host {
                      --paper-item-icon-color:
                        {% if states('device_tracker.sphone_router_wifi') =='home' %} var(--state-icon-active-color)
                        {% else%} var(--state-icon-color)
                        {% endif %}
                      ;
                    }

          - entity: device_tracker.sphone
            name: 'Phone Tracker'
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if states('device_tracker.sphone') =='home' %} var(--state-icon-active-color)
                    {% else%} var(--state-icon-color)
                    {% endif %}
                  ;
                }

          - entity: binary_sensor.sphone_high_accuracy_mode

  - !include /config/lovelace/bar/sheri_time_bar_hui.yaml

  - type: conditional
    conditions:
      - entity: binary_sensor.sheri_home
        state: 'off'
    row:
      entity: proximity.sphone_home
      name: 'Distance From Home'
      secondary_info: last-updated
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if is_state('proximity.sphone_home','not_set') %} var(--entity-warning-color)
              {% else %} var(--state-icon-active-color)
              {% endif %}
            ;
          }

  - type: conditional
    conditions:
      - entity: binary_sensor.sheri_home
        state: 'off'
    row:
      type: custom:template-entity-row
      name: 'Current Address'
      icon: mdi:map-marker-radius
      secondary: "{{ states('sensor.sphone_geocoded_location') }}"
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if states('sensor.sphone_geocoded_location')|lower in ['unknown','unavailable','none'] %} var(--entity-warning-color)
              {% else %} var(--state-icon-active-color)
              {% endif %}
            ;
          }

  - type: custom:fold-entity-row
    head:
      type: custom:template-entity-row
      entity: binary_sensor.sheri_phone_connected
      state: "{{ states('binary_sensor.sheri_phone_connected')|title }}"
      secondary: >
        {% set time = state_attr('sensor.sheri_phone_last_update','display_time') %}
        {% set minutes = state_attr('sensor.sheri_phone_last_update','minutes_since_update')|int(-1) %}
        Last Update: {{ time }} ({{ minutes }} {{ 'minute' if minutes == 1 else 'minutes' }})
      tap_action:
        action: none
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {%- if is_state('binary_sensor.sheri_phone_connected','on') %} var(--state-icon-active-color)
              {%- else %} var(--entity-warning-color)
              {%- endif -%}
            ;
          }
    state_color: true
    group_config:
      secondary_info: last-updated
    entities:
      - type: custom:fold-entity-row
        head:
          entity: binary_sensor.sphone_wifi_state
          name: 'WIFI Connection'
          state_color: true
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_wifi_connection
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if not is_state('sensor.sphone_wifi_connection','<not connected>') %} var(--state-icon-active-color)
                    {% else %} var(--state-icon-color)
                    {% endif %}
                  ;
                }

          - entity: sensor.sphone_wifi_ip_address
            name: 'WIFI IP Address'

      - type: custom:fold-entity-row
        head:
          entity: binary_sensor.sphone_mobile_data
          name: 'Mobile Data'
          secondary_info: last-updated
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_public_ip_address
            name: 'Public IP'

      - type: custom:fold-entity-row
        head:
          entity: binary_sensor.sphone_bluetooth_state
          name: 'Bluetooth'
          state_color: true
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_bluetooth_connection
            name: 'Connected Devices(s)'

      - type: custom:fold-entity-row
        head:
          entity: sensor.sphone_phone_state
          name: 'Phone State'
          secondary_info: last-updated
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_ringer_mode
          - entity: sensor.sphone_volume_level_ringer
          - entity: sensor.sphone_volume_level_call
          - entity: binary_sensor.sphone_speakerphone
          - entity: binary_sensor.sphone_mic_muted

      - type: custom:fold-entity-row
        head:
          entity: sensor.sphone_audio_mode
          name: 'Audio'
          secondary_info: last-updated
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_do_not_disturb_sensor
            name: 'Do Not Disturb'
          - entity: binary_sensor.sphone_music_active
          - entity: sensor.sphone_volume_level_music
          - entity: binary_sensor.sphone_headphones
          - entity: sensor.sphone_media_session

      - type: custom:fold-entity-row
        head:
          entity: binary_sensor.sphone_app_update
          name: 'Phone App Update'
          secondary_info: last-updated
          tap_action:
            action: none
          card_mod:
            style: |
              :host {
                --paper-item-icon-color:
                  {%- if is_state('binary_sensor.sphone_app_update','off') %} var(--state-icon-active-color)
                  {%- else %} var(--entity-warning-color)
                  {%- endif -%}
                ;
              }
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_current_version
            name: 'Current Version'
          - entity: sensor.ha_companion_latest_version
            name: 'Latest Version'

      - type: custom:template-entity-row
        entity: binary_sensor.sphone_device_locked
        state: "{{ states('binary_sensor.sphone_device_locked')|title }}"
        name: 'Device Locked'
        secondary: >
          {% if states.binary_sensor.sphone_device_locked.last_changed is defined %}
            {{ states.binary_sensor.sphone_device_locked.last_changed|relative_time }} ago
          {% endif %}

      - type: custom:fold-entity-row
        head:
          type: custom:template-entity-row
          name: 'Other Sensors'
          icon: mdi:cellphone
        group_config:
          secondary_info: last-updated
        entities:
          - entity: sensor.sphone_last_reboot
            name: 'Last Reboot'

          - entity: sensor.sphone_last_update_trigger
            name: 'Last Update Trigger'

  - type: custom:fold-entity-row
    state_color: true
    head:
      type: custom:battery-state-entity
      entity: sensor.sphone_battery_level
      name: 'Battery Level'
      secondary_info: charging # only appears when charging is detected
      charging_state:
        entity_id: binary_sensor.sphone_is_charging
        state: 'on'
        secondary_info_text: 'Charging'
      tap_action:
        action: more-info
    group_config:
      secondary_info: last-updated
    entities:
      - entity: binary_sensor.sphone_is_charging

      - entity: sensor.sphone_battery_temperature
        name: 'Battery Temperature'

      - entity: sensor.sphone_battery_state
        name: 'Battery State'

      - entity: sensor.sphone_charger_type
        name: 'Charger Type'

      - entity: sensor.sphone_battery_health
        name: 'Battery Health'

      - entity: binary_sensor.sphone_power_save
        name: 'Power Saving'

  - type: custom:fold-entity-row
    head:
      type: custom:template-entity-row
      entity: sensor.sheri_phone_next_alarm
      state: "{{ state_attr('sensor.sheri_phone_next_alarm','12hour') }}"
      name: 'Next Alarm'
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {%- if not is_state('sensor.sheri_phone_next_alarm','off') %} var(--state-icon-active-color)
              {%- else %} var(--state-icon-color)
              {%- endif -%}
            ;
          }
    group_config:
      secondary_info: last-updated
    entities:
      - entity: input_boolean.sheri_phone_alarm_clock_enabled
      - entity: input_boolean.sheri_phone_alarm_clock_notifications
      - entity: input_number.mobile_waketime_volume_sheri
      - entity: sensor.sphone_volume_level_alarm

  - entity: input_boolean.media_preset_enabled_sheri
  - entity: input_boolean.sheri_phone_tts_enabled
