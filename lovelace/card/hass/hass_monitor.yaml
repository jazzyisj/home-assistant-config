###############################################################################
## Hass Monitor
###############################################################################
type: entities
title: 'Home Assistant'
icon: mdi:home-assistant
state_color: true
show_header_toggle: false
entities:
  - type: custom:template-entity-row
    name: "Home Assistant Uptime: {{ states('sensor.home_assistant_uptime') }}"
    secondary: "Last Restart: {{ states('sensor.last_restart_date_time') }}"
    icon: mdi:clock-start

  - type: custom:fold-entity-row
    padding: 5
    head:
      entity: sensor.hassio
      name: 'Uptime Robot Status'
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if is_state('binary_sensor.uptime_robot_connected','off') %} var(--entity-severe-color)
              {% elif states('sensor.hassio','up')|lower in ['unknown','unavailable'] %} var(--entity-disabled-color)
              {% elif is_state('sensor.hassio','up') %} var(--entity-ok-color)
              {% else %} var(--entity-warning-color)
              {% endif %}
            ;
          }
    entities:
      - entity: switch.hassio_active

  - entity: binary_sensor.remote_ui
    double_tap_action:
      action: fire-dom-event
      browser_mod:
        command: popup
        deviceID: this
        large: true
        hide_header: true
        title: 'Pi-Hole Admin'
        card:
          type: iframe
          aspect_ratio: 100%
          url: 'https://status.home-assistant.io/#'
    card_mod:
      style: |
        :host {
          --paper-item-icon-color:
              {% if states('binary_sensor.remote_ui')|lower in ['unknown','unavailable'] %} var(--entity-severe-color);
              {% else %} var(--entity-disabled-color);
              {% endif %}
          --paper-item-icon-active-color: var(--entity-ok-color);
        }

  - type: custom:auto-entities
    show_empty: true
    unique: true
    filter:
      include:
        - entity_id: 'sensor.browser_*'
          # attributes: #BMOD attributes missing
          #   type: 'browser_mod'
          options:
            secondary_info: last-changed
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if is_state_attr(config.entity,'authorized',true) %}
                      {{ 'var(--state-icon-active-color)' if states(config.entity)|int(0) > 0 else 'var(--state-icon-color)' }}
                    {% else %} var(--entity-warning-color)
                    {% endif %}
                  ;
                }
      exclude:
        - state: unavailable
    sort:
      method: name # don't sort by attribute: last_seen - constantly updating
    card:
      type: custom:fold-entity-row
      padding: 10
      head:
        entity: sensor.connected_browsers
        tap_action:
          action: call-service
          service: browser_mod.debug
        style: |
          :host {
            --paper-item-icon-color:
              {% set state = states('binary_sensor.unknown_browser_alert') %}
              {% if state == 'on' %} var(--entity-severe-color)
              {% elif state == 'off' %} var(--entity-ok-color)
              {% else %} var(--entity-disabled-color)
              {% endif %}
            ;
          }
    entities:
      - type: custom:template-entity-row
        entity: sensor.last_successful_authentication
        state: "{{ state_attr('sensor.last_successful_authentication','Hostname') }}"
        secondary: "User: {{ state_attr('sensor.last_successful_authentication','Username') }}"

  - entity: sensor.connected_clients
    icon: mdi:console-network
    card_mod:
      style: |
        :host {
          --paper-item-icon-color:
            {% set state = states('sensor.connected_clients') %}
            {% if state|int(-1) > 0 %} var(--entity-ok-color)
            {% elif state|int(-1) == 0 %} var(--entity-warning-color)
            {% else %} var(--entity-disabled-color)
            {% endif %}
          ;
        }

  - entity: sensor.updates_available
    tap_action:
      action: fire-dom-event
      browser_mod:
        command: popup
        deviceID: this
        hide_header: false
        title: 'System Updates'
        card: !include /config/lovelace/card/hass/hass_updates.yaml
    double_tap_action:
      action: more-info
    hold_action:
      action: navigate
      navigation_path: /hassio/dashboard
    card_mod:
      style: |
        :host {
          --paper-item-icon-color:
            {% set state = states('sensor.updates_available') %}
            {% if state|int(-1) > 0 %}
              {% if states('sensor.breaking_change_warnings')|int(-1) > 0 %} var(--entity-critical-color)
              {% else %} var(--entity-warning-color)
              {% endif %}
            {% elif state|int(-1) == 0 %} var(--entity-ok-color)
            {% else %} var(--entity-disabled-color)
            {% endif %}
          ;
        }

  - type: custom:template-entity-row
    entity: sensor.backup_state
    name: 'System Backups'
    icon: mdi:folder-sync
    state: >
      {{ 'Problem' if is_state('binary_sensor.backups_stale','on')
        else states('sensor.backup_state')|replace('_',' ')|title }}
    secondary: >
      Backups: {{ state_attr('sensor.backup_state','backups_in_home_assistant') }}
      -  Latest: {{ state_attr('sensor.backup_state','last_backup')|as_timestamp(none)|timestamp_custom('%b %-d,%Y %H:%M %p',true,none) }}
    tap_action:
      action: more-info
    double_tap_action:
      action: navigate
      navigation_path: /hassio/backups
    hold_action:
      action: navigate
      navigation_path: /hassio/ingress/cebe7a76_hassio_google_drive_backup
    card_mod:
      style: |
        :host {
          --paper-item-icon-color:
            {% set state = states('sensor.backup_state') %}
            {% if is_state('binary_sensor.backups_stale','on') %} var(--entity-critical-color)
            {% elif state|lower in ['unknown','unavailable'] %} var(--entity-disabled-color)
            {% elif is_state('sensor.backup_state','backed_up') %} var(--entity-ok-color)
            {% else %} var(--entity-warning-color)
            {% endif %}
          ;
        }

  - !include /config/lovelace/card/include/disk_use_entity.yaml

  - entity: sensor.home_assistant_alerts
    card_mod:
      style: |
        :host {
          --paper-item-icon-color:
            {% if 'persistent_notification.hass_alert' in states.persistent_notification|map(attribute='entity_id')|list %} var(--entity-warning-color)
            {% elif states('sensor.home_assistant_alerts')|lower in ['unknown','unavailable'] %} var(--entity-disabled-color)
            {% else %} var(--entity-ok-color)
            {% endif %}
          ;
        }
    tap_action:
      action: fire-dom-event
      browser_mod:
        command: popup
        deviceID: this
        hide_header: true
        title: 'Home Assistant Alerts'
        card: !include /config/lovelace/card/hass/hass_alerts_markdown.yaml

  - entity: input_select.log_level

  - entity: input_boolean.dev_mode
    card_mod:
      style: |
        :host {
          --paper-item-icon-color: var(--state-icon-color);
          --paper-item-icon-active-color: var(--entity-warning-color);
        }

  - entity: input_boolean.startup_pending
    card_mod:
      style: | #STYLE
        :host {
          --paper-item-icon-color: var(--state-icon-color);
          --paper-item-icon-active-color: var(--entity-severe-color);
          --paper-toggle-button-checked-button-color: var(--entity-severe-color);
        }

  - type: custom:auto-entities
    filter:
      template: "{{ states.alert|selectattr('attributes.category','eq','hass')|map(attribute='entity_id')|list }}"
    sort:
      method: name
      ignore_case: true
    card:
      type: custom:fold-entity-row
      head:
        entity: input_boolean.hass_alerts
        state_color: true
        card_mod:
          style: |
            :host {
              --paper-item-icon-color:
                  {% if is_state('input_boolean.hass_alerts','off') %} var(--entity-warning-color)
                  {% else %} var(--state-icon-color)
                  {% endif %}
              ;
              --paper-item-icon-active-color:
                {% if states.alert|selectattr('attributes.category','eq','hass')
                    |selectattr('state','ne','idle')|list|count > 0 %} var(--entity-severe-color)
                {% else %} var(--state-icon-active-color).
                {% endif %}
              ;
            }
        padding: 5

  - type: custom:auto-entities
    filter:
      include:
        - entity_id: 'automation.hass_*'
    sort:
      method: name
      ignore_case: true
    card:
      type: custom:fold-entity-row
      padding: 5
      head:
        type: custom:template-entity-row
        entity: sensor.dummy
        name: 'HASS Automations'
        icon: mdi:sync-alert
        tap_action: none

  - type: custom:github-entity-row
    repo: jazzyisj/home-assistant-config
    hold_action:
      action: url
      url_path: !secret GITHUB_HASS_CONFIG
    card_mod:
      style: |
        :host {
          --paper-item-icon-color: var(--state-icon-color);
        }

  - type: buttons
    entities:
      - entity: homeassistant.restart
        icon: mdi:home-assistant
        name: 'Restart'
        tap_action:
          action: call-service
          confirmation:
            text: 'Are you sure you want to restart Home Assistant?'
          service: homeassistant.restart

      - entity: browser_mod.lovelace_reload
        icon: mdi:file-refresh
        name: 'Reload'
        tap_action:
          action: call-service
          confirmation:
            text: 'Are you sure you want to reload this lovelace dashboard?'
          service: browser_mod.lovelace_reload

      - entity: browser_mod.window_reload
        icon: mdi:file-refresh
        name: 'Refresh'
        tap_action:
          action: call-service
          confirmation:
            text: 'Are you sure you want to refresh your browser?'
          service: browser_mod.window_reload
    card_mod:
      style:
        hui-buttons-base $: |
          .ha-scrollbar {
            justify-content: center;
          }
card_mod:
  class: basic
