###############################################################################
## Weather Card
###############################################################################
type: custom:stack-in-card #TODO weather alert backgrounds getting wiped out by stack-in-card
cards:
  - type: weather-forecast
    entity: weather.windsor_current
    card_mod:
      class: sub_card
      style: |
        ha-card .temp-attribute .temp {
          color:
            {% if is_state('binary_sensor.outdoor_high_temperature_alert','on') %} var(--entity-high-temp-color)
            {% elif is_state('binary_sensor.outdoor_low_temperature_alert','on') %} var(--entity-low-temp-color)
            {% else %} var(--primary-text-color)
            {% endif %}
          ;
        }

  - type: vertical-stack
    cards:
      - type: custom:state-switch
        entity: binary_sensor.envcan_weather_alert
        states:
          'on': !include /config/lovelace/button/weather/envcan_alert_button.yaml

      - type: custom:state-switch
        entity: binary_sensor.noaa_weather_alert
        states:
          'on': !include /config/lovelace/button/weather/noaa_alert_button.yaml

      - type: custom:state-switch
        entity: template
        template: >
          {{ 'display' if is_state('binary_sensor.gdacs_alert_active','on')
              and is_state('input_boolean.display_gdacs','on') else 'no' }}
        states:
          'display': !include /config/lovelace/button/weather/gdacs_alert_button.yaml

  - type: conditional
    conditions:
      - entity: sensor.windsor_forecast
        state_not: unavailable
      - entity: sensor.windsor_forecast
        state_not: unknown
    card:
      type: custom:multiline-entity-card
      name: 'Forecast'
      entity: sensor.windsor_forecast
      show_icon: false
      show_name: false
      card_mod:
        class: sub_card
        style: | #STYLE font size
          span.value{
            font-size: 14px;
            font-weight: normal;
          }

  - type: conditional
    conditions:
      - entity: sensor.windsor_forecast
        state_not: unavailable
      - entity: sensor.windsor_forecast
        state_not: unknown
    card:
      # https://github.com/Yevgenium/weather-chart-card
      type: custom:weather-chart-card
      entity: weather.windsor
      show_main: false
      show_attributes: false

  - !include /config/lovelace/card/weather/weather_card_sensors.yaml

  - type: horizontal-stack
    cards:
      - !include /config/lovelace/button/weather/wind_conditions_button.yaml

      - type: entities
        entities:
          - type: custom:template-entity-row
            entity: sensor.temperature_trend #IDEA move to temp in weather card
            name: 'Temperature'
            state: ''
            tap_action:
              action: fire-dom-event
              browser_mod:
                command: popup
                deviceID: this
                large: true
                hide_header: true
                title: Temperature
                card: !include /config/lovelace/card/weather/windy_temperature_widget.yaml
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if is_state('binary_sensor.temperature_rising','on') %} var(--entity-heating-color)
                    {% elif is_state('binary_sensor.temperature_falling','on') %} var(--entity-cooling-color)
                    {% else %} var(--entity-ok-color)
                    {% endif %}
                  ;
                }

          - type: custom:template-entity-row
            entity: sensor.barometric_pressure
            name: 'Pressure'
            state: "{{ states('sensor.barometric_pressure') ~ ' hPa' }}"
            icon: >
              {% if states.sensor.pressure_trend.attributes is defined
                  and states.sensor.pressure_trend.attributes.icon is defined %}
                {{ states.sensor.pressure_trend.attributes.icon }}
              {% endif %}
            tap_action:
              action: fire-dom-event
              browser_mod:
                command: popup
                deviceID: this
                large: true
                hide_header: true
                title: Temperature
                card: !include /config/lovelace/card/weather/windy_temperature_widget.yaml
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% if is_state('binary_sensor.temperature_rising','on') %} var(--entity-heating-color)
                    {% elif is_state('binary_sensor.temperature_falling','on') %} var(--entity-cooling-color)
                    {% else %} var(--entity-ok-color)
                    {% endif %}
                  ;
                }

          - entity: sensor.cloud_cover
            name: 'Cloud Cover'
            tap_action:
              action: fire-dom-event
              browser_mod:
                command: popup
                deviceID: this
                large: true
                hide_header: true
                title: Temperature
                card: !include /config/lovelace/card/weather/windy_temperature_widget.yaml
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% set cover = states('sensor.cloud_cover')|int(-1) %}
                    {% if cover == 0 %} rgb(77, 177, 255)
                    {% elif cover <= 30 %} rgb(75, 106, 130)
                    {% elif cover <= 50 %} rgb(116, 116, 116)
                    {% elif cover <= 95 %} rgb(171, 180, 179)
                    {% elif cover <= 98 %} rgb(198, 201, 201)
                    {% else %} rgb(213, 213, 205)
                    {% endif %}
                  ;
                }

          - entity: sensor.precipitation_probability
            name: 'Precipitation'
            tap_action:
              action: fire-dom-event
              browser_mod:
                command: popup
                deviceID: this
                large: true
                hide_header: true
                title: Temperature
                card: !include /config/lovelace/card/weather/windy_temperature_widget.yaml
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color:
                    {% set prob = states('sensor.precipitation_probability')|int(-1) %}
                    {% if prob == 0 %} rgb(77, 177, 255)
                    {% elif prob <= 30 %} rgb(75, 106, 130)
                    {% elif prob <= 50 %} rgb(116, 116, 116)
                    {% elif prob <= 95 %} rgb(171, 180, 179)
                    {% elif prob <= 98 %} rgb(198, 201, 201)
                    {% else %} rgb(213, 213, 205)
                    {% endif %}
                  ;
                }

  - type: entities
    entities:
      - type: buttons
        entities:
          - entity: script.weather_report
            name: Weather Report
            icon: mdi:weather-partly-snowy-rainy
            tap_action:
              action: call-service
              service: script.weather_report
        card_mod:
          style:
            hui-buttons-base $: |
              .ha-scrollbar {
                justify-content: center;
              }
card_mod:
  class: basic
