type: vertical-stack #BUGFIX
cards:
  - type: custom:stack-in-card #STACK #BUG entities card won't display if not nested in a vertical stack
    cards:
      - !include /config/lovelace/include/card/alarm_clock/alarm_clock_popup_menu.yaml

      - type: entities
        show_header_toggle: false
        entities:
          - type: custom:fold-entity-row
            head:
              type: custom:template-entity-row
              entity: sensor.alarm_clock_nap # don't use entity include - recursive popup
              name: Next Nap Alarm
              state: "{{ state_attr('sensor.alarm_clock_nap','12hour') }}"
              tap_action:
                action: none
              card_mod:
                style: |
                  :host {
                    --paper-item-icon-color:
                      {% if is_state('sensor.alarm_clock_nap','Off') %} var(--state-icon-color)
                      {% else %} var(--state-icon-active-color)
                      {% endif %}
                      ;
                  }
            entities:
              - entity: input_number.alarm_clock_nap_time
                name: Duration

              - entity: timer.alarm_clock_nap
                name: Remaining
                card_mod:
                  style: |
                    :host {
                      --paper-item-icon-color:
                        {% if is_state('timer.alarm_clock_nap','idle') %} var(--state-icon-color)
                        {% else %} var(--state-icon-active-color)
                        {% endif %}
                        ;
                    }

          - type: custom:fold-entity-row
            head:
              type: custom:template-entity-row
              entity: sensor.alarm_clock_nap
              name: "{{ states('input_select.alarm_clock_radio_nap_alarm') }}"
              secondary: "{{ states('input_select.alarm_clock_media_player_nap') }}"
              state: "{{ states('input_number.alarm_clock_volume_nap') }}%"
              tap_action:
                action: none
            padding: 0
            entities:
              - entity: input_select.alarm_clock_sound_nap

              - type: conditional
                conditions:
                  - entity: input_select.alarm_clock_sound_nap
                    state: Radio
                row:
                  entity: input_select.alarm_clock_radio_nap_alarm

              - type: conditional
                conditions:
                  - entity: input_select.alarm_clock_sound_nap
                    state: Spotify
                row:
                  entity: input_select.alarm_clock_spotify_nap_alarm

              - entity: input_select.alarm_clock_media_player_nap
              - entity: input_number.alarm_clock_volume_nap

          - !include /config/lovelace/include/entity/alarm_clock/alarm_clock_snooze.yaml
          - !include /config/lovelace/include/entity/alarm_clock/alarm_clock_common_settings.yaml

          - type: divider

          - type: custom:paper-buttons-row
            buttons:
              - entity: input_boolean.alarm_clock_nap
                name: "{{ 'Alarm Set' if is_state('input_boolean.alarm_clock_nap','on') else 'Set Alarm' }}"
                state_icons:
                  'on': mdi:alarm-check
                  'off': mdi:alarm-off
                state_styles:
                  'on':
                    button:
                      color: var(--state-icon-active-color)
                  'off':
                    button:
                      color: var(--state-icon-color)
                style:
                  button:
                    background-color: var(--table-row-alternative-background-color)
                    border-radius: 40px
                    padding: 10px
                    font-size: 1.2rem
                tap_action:
                  action: toggle
                double_tap_action:
                  action: toggle
                hold_action:
                  action: toggle

              - entity: input_boolean.alarm_clock_active_nap
                name: "{{ 'Stop Alarm' if is_state('input_boolean.alarm_clock_active_nap','on') else 'Test Alarm' }}"
                state_icons:
                  'on': mdi:alarm-note
                  'off': mdi:alarm-note-off
                state_styles:
                  'on':
                    button:
                      color: var(--state-icon-active-color)
                  'off':
                    button:
                      color: var(--state-icon-color)
                style:
                  button:
                    background-color: var(--table-row-alternative-background-color)
                    border-radius: 40px
                    padding: 10px
                    font-size: 1.2rem
                tap_action:
                  action: call-service
                  service: script.alarm_clock_toggle
                  service_data:
                    alarm_type: nap
                    first_run: true
                    test_play: true
                double_tap_action:
                  action: call-service
                  service: script.alarm_clock_stop
                  service_data:
                    variables:
                      reset_volume: true
                hold_action:
                  action: call-service
                  service: script.alarm_clock_play
                  service_data:
                    alarm_type: nap
                    first_run: true
                    test_play: true
        card_mod:
          class: sub_card
    card_mod:
      class: alarm_clock_lanucher