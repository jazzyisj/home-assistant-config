###############################################################################
## Light - Manual Control On
###############################################################################
- id: light_manual_control_on
  alias: "[Light] Manual Control On"
  description: "Turn adaptive light manual control on."
  mode: parallel
  max: 50
  variables:
    light: "light.{{trigger.event.data['entity_id'].split('.')[1]|default('') }}"
    switch: >
      {{ (states.switch
          |selectattr('entity_id','search','adaptive_lighting')
          |selectattr('attributes.configuration','defined')
          |selectattr('attributes.configuration.lights','defined')
          |selectattr('attributes.configuration.lights','search',light)
          |map(attribute='entity_id')|list)[0]|default('') }}
  trigger:
    - platform: event
      event_type: timer.started
  condition:
    - condition: template
      alias: "Valid adaptive lighting switch and light entity"
      value_template: "{{ light != '' and switch != '' }}"

    - condition: template
      value_template: >
        {{ trigger.event.data['entity_id'] in
            states.timer
              |selectattr('attributes.type','defined')
              |selectattr('attributes.type','eq','light')
              |map(attribute='entity_id')|list }}

    - condition: state
      entity_id: input_boolean.alarm_triggered
      state: "off"
  action:
    - service: adaptive_lighting.set_manual_control
      data:
        entity_id: "{{ switch }}"
        lights: "{{ light }}"
        manual_control: true

###############################################################################
## Light - Manual Control Off
###############################################################################
- id: light_manual_control_off
  alias: "[Light] Manual Control Off"
  description: "Turn adaptive light manual control off."
  mode: parallel
  max: 50
  variables:
    light: "light.{{trigger.event.data['entity_id'].split('.')[1]|default('') }}"
    switch: >
      {{ (states.switch
          |selectattr('entity_id','search','adaptive_lighting')
          |selectattr('attributes.configuration','defined')
          |selectattr('attributes.configuration.lights','defined')
          |selectattr('attributes.configuration.lights','search',light)
          |map(attribute='entity_id')|list)[0]|default('') }}
  trigger:
    - platform: event
      event_type: timer.finished

    - platform: event
      event_type: timer.cancelled
  condition:
    - condition: template
      alias: "Valid adaptive lighting switch and light entity"
      value_template: "{{ light != '' and switch != '' }}"

    - condition: template
      value_template: >
        {{ trigger.event.data['entity_id'] in
            states.timer
              |selectattr('attributes.type','defined')
              |selectattr('attributes.type','eq','light')
              |map(attribute='entity_id')|list }}

    - condition: state
      entity_id: input_boolean.alarm_triggered
      state: "off"
  action:
    - service: adaptive_lighting.set_manual_control
      data:
        entity_id: "{{ switch }}"
        lights: "{{ light }}"
        manual_control: false
