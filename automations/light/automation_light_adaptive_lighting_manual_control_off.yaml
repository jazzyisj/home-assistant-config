###############################################################################
## Light - Adaptive Lighting Manual Control Off
###############################################################################
- id: light_adaptive_lighting_manual_control_off
  alias: "[Light] Adaptive Lighting Manual Control Off"
  description: "Ensure adaptive light manual control is off when house mode changes."
  max_exceeded: silent
  mode: restart
  variables:
    switches: >
      {{ (states.switch
          |selectattr('entity_id','search','adaptive_lighting')
          |selectattr('attributes.configuration','defined')
          |selectattr('attributes.configuration.lights','defined')
          |map(attribute='entity_id')|list)|default([]) }}
  trigger:
    - platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Guest
        - Away
        - Vacation
  condition:
    - condition: state
      entity_id: switch.adaptive_lighting
      state: "on"

    - condition: state
      entity_id:
        - input_boolean.occupancy_override
        - binary_sensor.scene_active
        - input_boolean.alarm_triggered
      state: "off"
  action:
    - repeat:
        count: "{{ switches|count }}"
        sequence:
          - variables:
              switch: "{{ switches[repeat.index-1] }}"

          - service: adaptive_lighting.set_manual_control
            data:
              entity_id: "{{ switches[repeat.index-1] }}"
              lights: >
                {{ states.switch|selectattr('entity_id','eq',switch)
                    |map(attribute='attributes.configuration.lights')|join }}
              manual_control: false
