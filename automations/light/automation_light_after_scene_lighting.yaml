###############################################################################
## Light - After Scene Lighting
###############################################################################
- id: light_after_scene_lighting
  alias: "[Light] After Scene Lighting"
  description: "Turn lights on or off when scene turns off."
  max_exceeded: silent
  trigger:
    - platform: state
      id: scene
      entity_id:
        - binary_sensor.waketime_active
        - binary_sensor.scene_active
      to: "off"
      not_from:
        - unknown
        - unavailable
      for: 5 # allow manual control to turn off
  condition:
    - condition: state
      entity_id:
        - input_boolean.alarm_triggered
        - binary_sensor.scene_active
        - binary_sensor.waketime_active
      state: "off"
  action:
    - if: "{{ is_state('binary_sensor.nighttime_illuminance_lights','off') }}"
      then:
        - service: light.turn_off
          target:
            entity_id: &lights >
              {{ states.light
                  |selectattr('attributes.scene_reset','defined')
                  |selectattr('attributes.scene_reset','eq',true)
                  |map(attribute='entity_id')|list }}
      else:
        - service: script.turn_light_on
          data:
            lights: *lights
            activate_timer: false
