#######################################################################################################################
## Radio - Auto Resume
#######################################################################################################################
- id: radio_auto_resume
  alias: "[Radio] Auto Resume"
  description: "Restart radio after announcement, alarm clock, or settings chnage."
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id:
        - input_select.radio_media_player
        - input_select.radio_station

    # resume after an announcement
    - platform: state
      entity_id: binary_sensor.tts_playing
      to: 'off'

    # resume after an alarm clock
    - platform: state
      entity_id: binary_sensor.alarm_clock_active
      to: 'off'

  condition:
    - condition: state
      entity_id: binary_sensor.radio_on
      state: 'on'

    - condition: state
      entity_id:
        - script.radio_play
        - script.radio_stop
      state: 'off'

    - condition: not
      conditions:
        - condition: state
          entity_id: alarm_control_panel.house
          state:
            - triggered # media players playing alert
            - warning # media players are auto paused

    - !include /config/include/template/radio_tts_off_condition.yaml
    - !include /config/include/template/radio_alarm_clock_off_condition.yaml

  action:
    # if tts announcement played on a member of active speaker group that speaker will now be disconnected
    # restart radio play instead of just resuming so all media players reconnect
    # radio pause boolean will turn off in radio_play if it was on
    - service: script.turn_on
      data:
        entity_id: script.radio_play
        variables:
          resume: true
          preset: >
            {% if is_state('input_boolean.media_preset_morning','on') %} wake
            {% elif is_state('input_boolean.media_preset_sleep','on') %} sleep
            {% else %} None
            {% endif %}