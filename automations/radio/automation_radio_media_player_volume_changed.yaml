#######################################################################################################################
## Radio - Media Player Volume Changed
## - media player is decimal, input_number is percent
#######################################################################################################################
- id: radio_media_player_volume_changed
  alias: "[Radio] Media Player Volume Changed"
  description: "Change radio volume control when radio media player volume changes."
  initial_state: true
  mode: queued
  max: 10
  trigger:
    - platform: state
      entity_id: !include /config/include/entities/media_player_entities.yaml
      attribute: volume_level

  condition:
    - !include /config/include/template/radio_media_player_condition.yaml

    # if radio player is speaker group only if run if trigger is group player
    - condition: template
      value_template: >
        {% set r = states('sensor.radio_media_player') %}
        {{ (true if r == trigger.entity_id else false) if r in state_attr('group.google_speaker_groups','entity_id') else true }}

    # only run if trigger to_state is not off or volume will be set to 0
    - condition: template
      value_template: "{{ not states(trigger.entity_id) in ['off','idle','unknown','unavailable','none'] }}"

    # only run if the new media player volume is not equal to the radio set volume
    - condition: template
      value_template: "{{ '%0.2f'|format(state_attr(trigger.entity_id,'volume_level')|float) != '%0.2f'|format(states('input_number.radio_volume')|float/100) }}"

    - !include /config/include/template/radio_not_tts_media_player_condition.yaml
    - !include /config/include/template/radio_not_alarm_clock_media_player_condition.yaml

  action:
    # media player volume float*100 format float to zero decimal for percent value
    - service: input_number.set_value
      data:
        entity_id: input_number.radio_volume
        value: "{{ '%0.0f'|format(state_attr(trigger.entity_id,'volume_level')|float*100 ) }}"



