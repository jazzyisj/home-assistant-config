#######################################################################################################################
## Presence - Guest Home Alert
#######################################################################################################################
- id: presence_guest_home_alert
  alias: "[Presence] Guest Home Alert"
  description: "Sent notification when guest still home and Jason/Sheri are gone."
  initial_state: true
  mode: restart
  max: 5
  trigger:
    # delay to prevent unwanted triggers from automation.presence_jason_home_away etc.
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: 'off'

  condition:
    - condition: state
      entity_id: binary_sensor.owner_home
      state: 'off'

    - condition: state
      entity_id: input_boolean.guest_home
      state: 'on'

  action:
    - service: !include /config/include/template/notify_jason_template.yaml
      data:
        title: "Guest at Home"
        message: "There is still a guest at home and Jason and Sheri have left!"
        data:
          actions:
            - title: Close
              action: close_guest_alert
            - title: Guest Off
              action: guest_off
          tag: guest_alert
          timestamp: "{{ as_timestamp(now()) }}" #push
          priority: high
          renotify: false #push
          ttl: 43200
          requireInteraction: false #push
          silent: true #push
          sticky: false #app
          url: /lovelace/presence #push
          clickAction: /lovelace/presence #app
          color: !secret NOTIFY_COLOR #app
          icon: !secret GUEST_ICON #push
          image: !secret GUEST_IMAGE
          badge: !secret GUEST_BADGE #push

#######################################################################################################################
## Presence - Presence Override Alert
#######################################################################################################################
- id: presence_guest_mode_off
  alias: "[Presence] Guest Mode Off"
  description: "Turn guest mode boolean off when notification action button clicked."
  initial_state: true
  mode: single
  trigger:
    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action: guest_off

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off

  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.guest_home

#######################################################################################################################
## Presence - Close Guest Alert Notifications
#######################################################################################################################
- id: presence_close_guest_alert_notifications
  alias: "[Presence] Close Guest Alert Notifications"
  description: "Dismiss notifications on all devices."
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: html5_notification.closed
      event_data:
        tag: guest_alert

    #BUG html5 closed event doesn't work if notification is in tray
    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action:  close_guest_alert
        
    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action: guest_off

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: close_guest_alert
        
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: guest_alert