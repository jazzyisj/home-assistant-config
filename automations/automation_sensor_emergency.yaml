#######################################################################################################################
## Sensor - CO Detected
#IDEA if alarm and nobody home send additional alerts, sms to neighbours, family
#IDEA extended alert - phone dialer to call phones or 911?
#######################################################################################################################
- id: sensor_emergency
  alias: "[Sensor] Emergency"
  description: "Turn on all lights create notification when alarm turns on."
  initial_state: true
  mode: queued
  max: 5
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.co_detected_alert
        - binary_sensor.smoke_detected_alert
      to: 'on'

  action:
    # turn off automation so we don't trigger device in use timers
    - service: automation.turn_off
      entity_id: group.light_in_use_automations

    - service: light.turn_on
      entity_id: all

    - service: persistent_notification.create
      data:
        title: >
          {% if trigger.entity_id == 'binary_sensor.co_detected_alert' %} Carbon Monoxide Alert!
          {% elif trigger.entity_id == 'binary_sensor.smoke_detected_alert' %} Smoke Alert!
          {% endif %}
        message: >
          {% if trigger.entity_id == 'binary_sensor.co_detected_alert' %} There was an active carbon monoxide alert at {{ now().strftime('%H:%M  %Y-%m-%d') }}.
          {% elif trigger.entity_id == 'binary_sensor.smoke_detected_alert' %} There was an active smoke alert at {{ now().strftime('%H:%M  %Y-%m-%d') }}.
          {% endif %}
        notification_id: >
          {% if trigger.entity_id == 'binary_sensor.co_detected_alert' %} co_alert
          {% elif trigger.entity_id == 'binary_sensor.smoke_detected_alert' %} smoke_alert
          {% endif %}

    # delay to allow all lights to change state
    - delay:
        seconds: 10

    - service: automation.turn_on
      entity_id: group.light_in_use_automations