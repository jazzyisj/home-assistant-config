###############################################################################
## Hass - Kiosk Restart
###############################################################################
- id: hass_kiosk_restart
  alias: "[Hass] Kiosk Restart"
  description: "Restart kiosk at startup if not connected."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.kiosk_connected
      to: "off"
      from: "on"

    - platform: homeassistant
      event: start
  action:
    # reloads fully kiosk, populates states for buttons, sensors etc
    - service: browser_mod.window_reload
      continue_on_error: true

    - delay: 15 # wait for states to populate

    - service: button.press
      continue_on_error: true
      target:
        entity_id: button.fire_tablet_load_start_url

    - wait_template: "{{ is_state('binary_sensor.kiosk_connected','on') }}"
      timeout: 60

    - if:
        - condition: state
          entity_id: binary_sensor.kiosk_screen
          state: unknown
      then:
        # trigger MQTT event to populate binary_sensor.kiosk_screen
        - service: light.toggle
          continue_on_error: true
          target:
            entity_id: light.fire_tablet_screen

        - delay: 1

        - service: light.toggle
          continue_on_error: true
          target:
            entity_id: light.fire_tablet_screen

    - wait_template: "{{ is_state('binary_sensor.kiosk_connected','on') }}"
      timeout: 30

    - condition: state
      entity_id: binary_sensor.kiosk_connected
      state: "off"

    - service: notify.jason
      data:
        title: "Kiosk Alert"
        message: "Kiosk tablet did not start."
        data:
          tag: kiosk_restart
          group: System
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          visibility: public
          when: "{{ now() }}"
          notification_icon: mdi:tablet-dashboard
          icon_url: !secret KIOSK_ICON
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-kiosk/home
          actions:
            - title: "Kiosk Admin"
              action: URI
              uri: !secret KIOSK_ADMIN

            - title: "Restart Kiosk"
              action: restart_kiosk

###############################################################################
## Hass - Kiosk Browser Restart
###############################################################################
- id: hass_kiosk_brower_restart
  alias: "[Hass] Kiosk Browser Restart"
  description: "Restart kiosk at startup, unavailable."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: restart_kiosk
  action:
    - service: button.press
      target:
        entity_id: button.fire_tablet_restart_browser

###############################################################################
## Hass - Kiosk Restart Notifications
###############################################################################
- id: hass_clear_kiosk_restart_notifications
  alias: "[Hass] Clear Kiosk Restart Notifications"
  description: "Clear notifications."
  trigger:
    - platform: state
      entity_id: binary_sensor.kiosk_connected
      to: "on"
      from: "off"
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: kiosk_restart
