###############################################################################
## Hass - Kiosk Restart
###############################################################################
- id: hass_kiosk_restart
  alias: "[Hass] Kiosk Restart"
  description: "Restart kiosk at startup if not connected."
  mode: restart
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: binary_sensor.kiosk_connected
      to: "off"
      from: "on"
      for: 60
  action:
    - if: "{{ trigger.id == 'startup' }}"
      then:
        - delay:
            minutes: 5

    - service: homeassistant.update_entity
      continue_on_error: true
      target:
        entity_id: binary_sensor.fire_tablet_device_admin

    - delay: 10 # allow fully kiosk to update

    - service: button.press
      continue_on_error: true
      target:
        entity_id: button.fire_tablet_restart_browser

    - wait_template: "{{ is_state('binary_sensor.kiosk_connected','on') }}"
      timeout: 60

    # toggle screen switch to populate MQTT screen on sensor
    - service: switch.turn_off
      continue_on_error: true
      target:
        entity_id: switch.fire_tablet_screen

    - service: switch.turn_on
      continue_on_error: true
      target:
        entity_id: switch.fire_tablet_screen

    - condition: state
      entity_id: binary_sensor.kiosk_connected
      state: "off"

    - service: notify.jason
      data:
        title: "Kiosk Alert"
        message: "Kiosk tablet is disconnected."
        data:
          tag: kiosk_restart
          group: System
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          visibility: public
          when: "{{ now() }}"
          notification_icon: mdi:tablet-dashboard
          icon_url: !secret KIOSK_ICON
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-kiosk/home
          actions:
            - title: "Kiosk Admin"
              action: URI
              uri: !secret KIOSK_ADMIN

            - title: "Restart Kiosk"
              action: restart_kiosk

###############################################################################
## Hass - Kiosk Browser Restart
###############################################################################
- id: hass_kiosk_brower_restart
  alias: "[Hass] Kiosk Browser Restart"
  description: "Restart kiosk at startup, unavailable."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: restart_kiosk
  action:
    - service: button.press
      target:
        entity_id: button.fire_tablet_restart_browser

###############################################################################
## Hass - Kiosk Restart Notifications
###############################################################################
- id: hass_clear_kiosk_restart_notifications
  alias: "[Hass] Clear Kiosk Restart Notifications"
  description: "Clear notifications."
  trigger:
    - platform: state
      entity_id: binary_sensor.kiosk_connected
      to: "on"
      from: "off"
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: kiosk_restart
