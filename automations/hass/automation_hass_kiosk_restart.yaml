###############################################################################
## Hass - Kiosk Restart
#TODO aiohttp.client_exceptions.ClientConnectorError: Cannot connect to host 192.168.1.70:2323 ssl:default [Connect call failed ('192.168.1.70', 2323)]
###############################################################################
- id: hass_kiosk_restart
  alias: '[Hass] Kiosk Restart'
  description: 'Restart kiosk at startup, if unavailable.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.kiosk_connected
      to: 'off'
      from: 'on'

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
      for: 60
  condition:
    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
      for: 60
  action:
    #2022.4 template select templates not refreshing in UI chrome, mobile app - kiosk ok
    # reloads fully kiosk, populates states for buttons, sensors etc
    - service: browser_mod.window_reload

    - service: button.press
      target:
        entity_id: button.fire_tablet_load_start_url

    - wait_template: "{{ is_state('binary_sensor.kiosk_connected','on') }}"
      timeout: 60

    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.kiosk_screen
              state: unknown
          sequence:
            # trigger MQTT event to populate binary_sensor.kiosk_screen
            - service: light.toggle
              target:
                entity_id: light.fire_tablet_screen

            - delay: 1

            - service: light.toggle
              target:
                entity_id: light.fire_tablet_screen

    - condition: state
      entity_id: binary_sensor.kiosk_connected
      state: 'off'

    - service: notify.jason
      data:
        title: 'Kiosk Alert'
        message: 'Kiosk tablet did not start.'
        data:
          tag: kiosk_startup
          group: System
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          when: '{{ now() }}'
          notification_icon: mdi:tablet-dashboard
          icon_url: !secret KIOSK_ICON
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-kiosk/home
          actions:
            - title: 'Kiosk Admin'
              action: URI
              uri: !secret KIOSK_ADMIN

            - title: 'Restart Kiosk'
              action: restart_kiosk

###############################################################################
## Hass - Kiosk Browser Restart
###############################################################################
- id: hass_kiosk_brower_restart
  alias: '[Hass] Kiosk Browser Restart'
  description: 'Restart kiosk at startup, unavailable.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: restart_kiosk
  action:
    - service: button.press
      target:
        entity_id: button.fire_tablet_restart_browser
