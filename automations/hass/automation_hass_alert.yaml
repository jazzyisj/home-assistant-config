###############################################################################
## Hass - New Hass Alert
###############################################################################
- id: hass_new_hass_alert
  alias: '[Hass] New Hass Alert'
  description: 'Send notifications after 8:30am when alert is updated today.'
  trigger:
    - platform: template
      value_template: >
        {% if state_attr('sensor.home_assistant_alerts','entries')[0] %}
          {% set alert = state_attr('sensor.home_assistant_alerts','entries')[0]['updated'] %}
          {{ alert == states('sensor.date') }}
        {% endif %}
  action:
    - service: persistent_notification.create
      data:
        title: 'New HASS Alert'
        message: "[{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}]({{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }})"
        notification_id: hass_alert

    - service: notify.jason
      data:
        title: 'New Hass Alert!'
        message: >
          <a href="{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}">{{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }}</a>
          {{ state_attr('sensor.home_assistant_alerts','entries')[0].content[0].value }}
        data:
          subject: "{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}"
          tag: hass_alert
          group: System
          channel: General
          importance: max
          ttl: 0
          priority: high
          notification_icon: mdi:home-assistant
          icon_url: !secret ALERT_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: "{{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }}"
          actions:
            - title: 'Clear Alert'
              action: clear_hass_alert

###############################################################################
## Hass - Clear Hass Alert Notification
###############################################################################
- id: hass_clear_hass_alert_notification #VERIFY
  alias: '[Hass] Clear Hass Alert Notification'
  description: 'Clear notification.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: clear_hass_alert

    #NOTE from_state of a dismissed persistent notifcations is null, must use state_changed event
    - platform: event
      event_type: state_changed
      event_data:
        entity_id: persistent_notification.hass_alert
  condition:
    #BUGFIX conditions required as workaround for unknown persistent notification state
    - or:
        - "{% if trigger.event is defined %}{{ trigger.event.data['tag'] == 'hass_alert' }}{% endif %}"
        - "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'clear_hass_alert' }}{% endif %}"
        - "{% if trigger.event is defined %}{{ trigger.event.event_type == 'state_changed' and not is_state('persistent_notification.hass_alert','notifying') }}{% endif %}"
  action:
    - service: persistent_notification.dismiss
      data:
        notification_id: hass_alert

    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: hass_alert
