#######################################################################################################################
## Hass - New Hass Alert
#######################################################################################################################
- id: hass_new_hass_alert
  alias: "[Hass] New Hass Alert"
  description: "Send notifications after 8:30am when alert is updated today."
  trigger:
    - platform: template
      value_template: >
        {% if state_attr('sensor.home_assistant_alerts','entries') is defined %}
          {% set alert = state_attr('sensor.home_assistant_alerts','entries')[0]['updated'] %}
          {{ alert == states('sensor.date') }}
        {% endif %}
  action:
    - service: persistent_notification.create
      data:
        title: "New HASS Alert"
        message: "[{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}]({{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }})"
        notification_id: hass_alert

    - service: notify.jason
      data:
        title: "New Hass Alert!"
        message: >
          <a href="{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}">{{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }}</a>
          {{ state_attr('sensor.home_assistant_alerts','entries')[0].content[0].value }}
        data:
          subject: "{{ state_attr('sensor.home_assistant_alerts','entries')[0]['title'] }}"
          tag: hass_alert
          group: System
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          ledColor: !secret NOTIFY_COLOR
          clickAction: "{{ state_attr('sensor.home_assistant_alerts','entries')[0]['link'] }}"
          color: !secret NOTIFY_COLOR
          icon_url: !secret ALERT_ICON
          actions:
            - action: clear_hass_alert
              title: "Clear Alert"

#######################################################################################################################
## Hass - Clear Hass Alert
#######################################################################################################################
- id: hass_clear_hass_alert
  alias: "[Hass] Clear Hass Alert"
  description: "Clear new HASS alert."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: clear_hass_alert
  action:
    - service: persistent_notification.dismiss
      data:
        notification_id: hass_alert