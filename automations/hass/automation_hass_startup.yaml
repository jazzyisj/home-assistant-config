###############################################################################
## Hass - Startup
###############################################################################
- id: hass_startup
  alias: '[Hass] Startup'
  description: 'Turn on delayed automations, send restart notification.'
  trigger:
    - platform: homeassistant
      event: start
  action:
    - service: system_log.write
      data:
        level: critical
        logger: automation.hass_startup
        message: '**** HOME ASSISTANT START ****'

    - service: persistent_notification.create
      data:
        title: 'Automation Startup'
        message: 'Waiting for startup to complete.'
        notification_id: startup_delay

    # wait for entities to initialize before continuing
    # use integration group state - binary sensor will always be on at startup
    # use offline devices sensor - binary sensor will always be on at startup
    # use offline zwave devices sensor - binary sensor will always be on at startup
    - wait_template: >
        {{ is_state('input_boolean.startup_pending','off')
            or (is_state('binary_sensor.wan_connected','on')
              and is_state('group.integration_connected_sensors','on')
              and is_state('sensor.offline_zwave_devices','0')) }}
      timeout:
        minutes: 5

    - service: input_boolean.turn_off
      entity_id: input_boolean.startup_pending

    - service: persistent_notification.dismiss
      data:
        notification_id: startup_delay

    - service: persistent_notification.create
      data:
        title: &start_title 'HASS Restarted'
        message: &start_message "Startup completed at {{ now().strftime('%-I:%M %p') }}."
        notification_id: hass_restart

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.hass_alerts
              state: 'on'
          sequence:
            - service: notify.jason
              data:
                title: *start_title
                message: *start_message
                data:
                  tag: hass_restart
                  group: System
                  channel: General
                  importance: max
                  ttl: 0
                  priority: high
                  notification_icon: '{{ states.input_boolean.startup_pending.attributes.icon }}'
                  icon_url: !secret HASSIO_ICON
                  ledColor: !secret NOTIFY_COLOR
                  color: !secret NOTIFY_COLOR
                  vibrationPattern: !secret GENERAL_VIBRATION
                  clickAction: /lovelace-mobile/home

            - choose:
                - conditions:
                    - condition: state
                      entity_id:
                        - binary_sensor.wan_connected # push causes error if no wan
                        - binary_sensor.jason_home
                      state: 'on'

                    - condition: state
                      entity_id: device_tracker.jason_laptop_wifi
                      state: home
                  sequence:
                    - service: notify.push
                      data:
                        title: *start_title
                        message: *start_message
                        target: jlaptop
                        data:
                          tag: hass_restart
                          timestamp: '{{ now().timestamp() }}'
                          priority: high
                          ttl: 0
                          renotify: true
                          silent: true
                          requireInteraction: false
                          url: /lovelace/home
                          image: !secret HASSIO_IMAGE
                          icon: !secret HASSIO_ICON
                          badge: !secret HASSIO_BADGE
                          actions:
                            - title: 'Close'
                              action: close_hass_restart

    - service: system_log.write
      data:
        level: critical
        logger: automation.hass_startup
        message: '**** HOME ASSISTANT STARTUP COMPLETE ****'

###############################################################################
## Hass - Clear Restart Notification
###############################################################################
- id: hass_clear_restart_notification
  alias: '[Hass] Clear Restart Notification'
  description: 'Clear notification.'
  max_exceeded: silent
  trigger:
    #NOTE from_state of a dismissed persistent notifcations is null, must use state_changed event
    - platform: event
      event_type: state_changed
      event_data:
        entity_id: persistent_notification.hass_restart

    #BUG html5 closed event doesn't work if notification is in tray
    - platform: event
      event_type: html5_notification.closed
      event_data:
        tag: hass_restart

    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action: close_hass_restart

    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: hass_restart
  condition:
    #BUGFIX conditions required as workaround for unknown persistent notification state
    - or:
        - "{% if trigger.event is defined %}{{ trigger.event.data['tag'] == 'hass_restart' }}{% endif %}"
        - "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'close_hass_restart' }}{% endif %}"
        - "{% if trigger.event is defined %}{{ trigger.event.event_type == 'state_changed' and not is_state('persistent_notification.hass_restart','notifying') }}{% endif %}"
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: hass_restart

    - service: html5.dismiss
      data:
        data:
          tag: hass_restart

    - service: persistent_notification.dismiss
      data:
        notification_id: hass_restart

    - delay:
        seconds: 30 # prevent recursive triggers
