###############################################################################
## Hass - Reload Shelly #ISSUE Shelly devices go offline
###############################################################################
- id: hass_reload_shelly
  alias: "[Hass] Reload Shelly"
  description: "Reload Shelly integration when device unavailable."
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - switch.hot_tub_energy_monitor
        - switch.house_energy_monitor
        - switch.indoor_sump
        - switch.outdoor_sump
        - switch.garage_furnace
      to:
        - unknown
        - unavailable
      for: 30
  action:
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ trigger.entity_id }}"

    - delay: 15 # allow integration to reload

    - service: persistent_notification.create
      data:
        title: "Device Offline!"
        message: >
          The  {{ state_attr(trigger.entity_id,'friendly_name') }} device went offline.
          <br>The device was {{ iif(states(trigger.entity_id) in ['unknown','unavailable'],'not able to reload','sucessfully reloaded' )}}.
        notification_id: "{{ trigger.entity_id.split('.')[1] }}_offline"
