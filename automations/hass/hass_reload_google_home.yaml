###############################################################################
## Hass - Reload Failed Device Integration
###############################################################################
- id: hass_reload_google_home
  alias: "[Hass] Reload Google Home"
  description: "Reload google home integration when device unavailable."
  max_exceeded: silent
  trace:
    stored_traces: 20
  trigger:
    - platform: homeassistant #ISSUE Google Home integration doesn't always load at startup
      id: startup
      event: start

    - platform: state
      id: sensor
      entity_id:
        - sensor.bathroom_speaker_device
        - sensor.bedroom_hub_device
        - sensor.deck_chromecast_device
        - sensor.dining_room_hub_device
        - sensor.office_speaker_device
        - sensor.laundry_room_speaker_device
        - sensor.living_room_chromecast_device
        - sensor.living_room_speaker_device
        - sensor.office_chromecast_device
      to:
        - unknown
        - unavailable

    - platform: state #ISSUE Google Home integration doesn't reload when switch goes offline
      id: switch
      entity_id:
        - switch.bathroom_speaker_do_not_disturb
        - switch.bedroom_hub_do_not_disturb
        - switch.dining_room_hub_do_not_disturb
        - switch.office_speaker_do_not_disturb
        - switch.laundry_room_speaker_do_not_disturb
        - switch.living_room_speaker_do_not_disturb
      to:
        - unknown
        - unavailable

    - platform: state #ISSUE Google Home integration doesn't reload when media player comes online
      id: media_player
      entity_id:
        - media_player.bathroom_speaker
        - media_player.bedroom_hub
        - media_player.deck_chromecast
        - media_player.dining_room_hub
        - media_player.office_speaker
        - media_player.laundry_room_speaker
        - media_player.living_room_chromecast
        - media_player.living_room_speaker
        - media_player.office_chromecast
      from:
        - unknown
        - unavailable
  condition: >
    {{ true if this.attributes.last_triggered == none
        else now() - this.attributes.last_triggered > timedelta(minutes=1) }}
  action:
    - if:
        - condition: trigger
          id: startup
      then:
        - wait_for_trigger:
            - platform: state
              entity_id: input_boolean.startup_pending
              to: "off"
          timeout:
            minutes: 5
          continue_on_timeout: true

        - condition: state
          entity_id:
            - sensor.bathroom_speaker_device
            - sensor.bedroom_hub_device
            - sensor.deck_chromecast_device
            - sensor.dining_room_hub_device
            - sensor.office_speaker_device
            - sensor.laundry_room_speaker_device
            - sensor.living_room_chromecast_device
            - sensor.living_room_speaker_device
            - sensor.office_chromecast_device
            - switch.bathroom_speaker_do_not_disturb
            - switch.bedroom_hub_do_not_disturb
            - switch.dining_room_hub_do_not_disturb
            - switch.office_speaker_do_not_disturb
            - switch.laundry_room_speaker_do_not_disturb
            - switch.living_room_speaker_do_not_disturb
          match: any
          state:
            - unknown
            - unavailable

        - service: homeassistant.reload_config_entry
          target:
            entity_id: sensor.bathroom_speaker_device
      else:
        - service: homeassistant.reload_config_entry
          target:
            entity_id: sensor.bathroom_speaker_device

        - delay: 10 # allow integration to reload

        - service: persistent_notification.create
          data:
            title: "Google Home"
            message: |
              The Google Home integration was reloaded!
              Trigger - {{ trigger.entity_id if trigger.entity_id is defined else trigger.id }}
          enabled: false #ISSUE media players constantly go offline
