###############################################################################
## Hass - Update Available
###############################################################################
- id: hass_update_available
  alias: '[Hass] Update Available'
  description: 'HASS update notification.'
  mode: restart
  trigger:
    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      for: 5 # allow alerts to turn on

    - platform: state
      entity_id: alert.update_available
      to: 'on'

    - platform: state
      entity_id: sensor.updates_available
      attribute: entity_id
      to: ~
  condition:
    - condition: template
      value_template: >
        {{ trigger.from_state.state|lower not in ['unknown','unavailable','none']
            and trigger.to_state.state|lower not in ['unknown','unavailable','none']
            and states('group.other_update_entities')|lower not in ['unknown','unavailable','none'] }}
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: alert.update_available
              state: 'on'
          sequence:
            - service: notify.jason
              data:
                title: 'HASS Update'
                message: >
                  {% set updates = state_attr('sensor.updates_available','entity_id') %}

                  {% for item in updates %}
                    <p><b>{{ state_attr(item,'title') }}</b>
                    <br/>Installed: {{ state_attr(item,'installed_version') }}
                    <br/>Available: {{ state_attr(item,'latest_version') }}</p>
                  {% endfor %}
                  {% set updates = expand('group.other_update_entities') %}
                  {% for item in updates if item.state == 'on' %}
                    <p><b>{{ state_attr(item.entity_id,'friendly_name') }}</b></p>
                  {% endfor %}
                data:
                  subject: 'HASS updates are available.'
                  tag: update_available
                  group: System
                  channel: General
                  importance: max
                  ttl: 0
                  priority: high
                  notification_icon: mdi:home-assistant
                  icon_url: !secret HASSIO_ICON
                  ledColor: !secret MINOR_COLOR
                  color: !secret MINOR_COLOR
                  vibrationPattern: !secret GENERAL_VIBRATION
                  clickAction: /config/dashboard
                  actions:
                    - title: 'Pause Alert'
                      action: pause_update_available
      default:
        - service: notify.jason
          data:
            message: clear_notification
            data:
              tag: update_available

###############################################################################
## Hass - Update Config Check
###############################################################################
- id: hass_update_config_check
  alias: '[Hass] Update Config Check'
  description: 'Starts the check config addon when an update becomes available.'
  trigger:
    - platform: state
      entity_id: update.home_assistant_core_update
      to: 'on'
  action:
    - service: hassio.addon_start
      data:
        addon: core_check_config

###############################################################################
## Hass - Pause Update Available Alert
###############################################################################
- id: hass_pause_update_available_alert
  alias: '[Hass] Pause Update Available Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_update_available
  action:
    - service: alert.turn_off
      target:
        entity_id: alert.update_available

###############################################################################
## Hass - Clear Update Available Notifications
###############################################################################
- id: hass_clear_update_available_notifications
  alias: '[Hass] Clear Update Available Notifications'
  description: 'Clear notifications.'
  trigger:
    - platform: state
      entity_id: alert.update_available
      to: 'off'
  condition:
    - condition: template
      value_template: >
        {{ now() - states.automation.hass_pause_update_available_alert.attributes.last_triggered
            > timedelta(seconds=30) }}
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: update_available
