###############################################################################
## Hass - Shutdown
###############################################################################
- id: hass_shutdown
  alias: '[Hass] Shutdown'
  description: 'Actions to perform on Hass shutdown.'
  trigger:
    - platform: homeassistant
      event: shutdown
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.media_on
              state: 'on'
          sequence:
            - variables:
                media_types: "{{ state_attr('binary_sensor.media_on','media_types') }}"

            - repeat:
                count: '{{ media_types|count }}'
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: 'input_boolean.resume_{{ media_types[repeat.index-1] }}'

    - service: automation.turn_off
      target:
        entity_id: automation.media_failed

    - service: system_log.write
      data:
        message: '**** HOME ASSISTANT STOP ****'
        level: critical
