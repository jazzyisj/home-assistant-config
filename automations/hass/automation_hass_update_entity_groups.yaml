###############################################################################
## Hass Update Entity Groups
###############################################################################
- id: hass_update_entity_groups
  alias: '[Hass] Update Entity Groups'
  description: 'Update entity groups.'
  mode: restart
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'

    # catch any entities slow to load
    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
      for: 900

    - platform: time_pattern
      hours: '*'
  action:
    ###############################################################################
    ## Lights
    ###############################################################################
    - service: group.set
      data:
        object_id: lights
        entities: >
          {{ states.light
            |selectattr('attributes.type','in',['dimmer','switch','bulb'])
            |rejectattr('attributes.rgb_light','eq','control')
            |rejectattr('attributes.rgb_light','eq','slave')
            |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: light_timers
        entities: >
          {{ states.timer|selectattr('attributes.type','eq','light')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Fans
    ###############################################################################
    - service: group.set
      data:
        object_id: fans
        entities: >
          {{ states.fan|selectattr('attributes.type','in',['ceiling_fan','vent_fan'])
            |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: fan_timers
        entities: >
          {{ states.timer|selectattr('attributes.type','eq','fan')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Locks, Windows, Doors, Motion
    ###############################################################################
    - service: group.set
      data:
        object_id: locks
        entities: "{{ states.lock|map(attribute='entity_id')|list }}"

    - service: group.set
      data:
        object_id: doors
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','door')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: windows
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','window')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: motion_sensors
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','motion')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Media Players
    ###############################################################################
    - service: group.set
      data:
        object_id: media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','in',['single','group'])
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: group_media_players
        entities: >
          {{ expand('group.media_players')|selectattr('attributes.type','eq','group')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: single_media_players
        entities: >
          {{ expand('group.media_players')|selectattr('attributes.type','eq','single')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: master_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','eq','master')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: play_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_media','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: play_tts_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_tts','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: play_alarm_clock_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_alarm_clock','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: tv_players
        entities: >
          {{ states.media_player|selectattr('attributes.device_class','eq','tv')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Notification Entities
    ###############################################################################
    - service: group.set
      data:
        object_id: led_notify
        entities: >
          {{ states|selectattr('domain','in',['light','switch'])
              |selectattr('attributes.led_notify','eq',true)|map(attribute='entity_id')|list }}

    - wait_template: "{{ state_attr('group.led_notify','entity_id') != none }}"
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: group.set
      data:
        object_id: dimmer_led
        entities: >
          {{ expand('group.led_notify')|selectattr('domain','eq','light')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: switch_led
        entities: >
          {{ expand('group.led_notify')|selectattr('domain','eq','switch')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_alarm
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_alarm','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_presence
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_presence','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_scene
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_scene','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_reminder
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_reminder','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_garage
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_garage','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_alarm_clock
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_alarm_clock','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_hass
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_hass','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_shower
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_shower','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_media
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_media','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_weather
        entities: >
          {{ expand('group.led_notify')|selectattr('attributes.led_weather','eq',true)
              |map(attribute='entity_id')|list }}
