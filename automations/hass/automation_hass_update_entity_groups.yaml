###############################################################################
## Hass Update Entity Groups
###############################################################################
- id: hass_update_entity_groups
  alias: "[Hass] Update Entity Groups"
  description: "Update entity groups."
  mode: restart
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: input_boolean.startup_pending
      to: "off"
      from: "on"

    # catch any entities slow to load
    - platform: state
      entity_id: input_boolean.startup_pending
      to: "off"
      from: "on"
      for: 900

    - platform: time_pattern
      hours: "*" # every hour on the hour
  action:
    ###############################################################################
    ## Lights
    ###############################################################################
    - service: group.set
      data:
        object_id: lights
        entities: >
          {{ states.light
            |selectattr('attributes.type','in',['dimmer','switch','bulb'])
            |rejectattr('attributes.rgb_light','in',['control','slave'])
            |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: light_timers
        entities: >
          {{ states.timer|selectattr('attributes.type','eq','light')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Fans
    ###############################################################################
    - service: group.set
      data:
        object_id: fans
        entities: >
          {{ states.fan|selectattr('attributes.type','in',['ceiling_fan','vent_fan'])
            |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: fan_timers
        entities: >
          {{ states.timer|selectattr('attributes.type','eq','fan')
              |map(attribute='entity_id')|list }}

    ###############################################################################
    ## Windows, Doors, Motion
    ###############################################################################
    - service: group.set
      data:
        object_id: doors
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','door')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: windows
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','window')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: motion_sensors
        entities: >
          {{ states.binary_sensor|selectattr('attributes.device_class','eq','motion')
              |map(attribute='entity_id')|list }}
