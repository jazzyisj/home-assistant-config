###############################################################################
## Hass - Reload Device #ISSUE devices go offline, don't reload
###############################################################################
- id: hass_reload_device
  alias: "[Hass] Reload Device"
  description: "Reload device integration when device unavailable."
  mode: parallel
  trace:
    stored_traces: 20
  trigger:
    - platform: state
      entity_id:
        - switch.refrigerator_ice_plus
        - sensor.rt_ax58u_boot_time
        - sensor.fire_tablet_current_page
        # - binary_sensor.bathroom_flood #TEST
        # - sensor.bedroom_temperature
        # - switch.garage_furnace
        # - light.garage_lights
        # - switch.hot_tub_energy_monitor
        # - switch.house_energy_monitor
        # - switch.indoor_sump
        # - binary_sensor.indoor_sump_flood
        # - binary_sensor.kitchen_flood
        # - sensor.living_room_temperature
        # - switch.outdoor_sump
        - binary_sensor.side_entrance_motion
        - light.workbench_light
        - calendar.jazzyisj #TEST
      to:
        - unknown
        - unavailable
      for: 300 # allow integration to try and self reload
  action:
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ trigger.entity_id }}"

    # allow integration to reload
    - wait_template: "{{ has_value(trigger.entity_id) }}"
      timeout: 120

    - service: persistent_notification.create
      data:
        title: "Device Offline!"
        message: >
          The  {{ state_attr(trigger.entity_id,'friendly_name') }} device went offline.
          <br>The device was {{ iif(has_value(trigger.entity_id),'sucessfully reloaded','not able to reload') }}.
        notification_id: "{{ trigger.entity_id.split('.')[1] }}_offline"
