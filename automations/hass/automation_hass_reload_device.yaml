###############################################################################
## Hass - Reload Device #ISSUE devices go offline, don't reload
###############################################################################
- id: hass_reload_device
  alias: "[Hass] Reload Device"
  description: "Reload device integration when device unavailable."
  mode: parallel
  trace:
    stored_traces: 20
  trigger:
    - platform: state
      id: device
      entity_id:
        - sensor.rt_ax58u_boot_time #TEST reloads if not available after startup?
        # - sensor.fire_tablet_current_page
        # - calendar.jazzyisj
      to:
        - unknown
        - unavailable
      for: 300 # allow integration to try and self reload
  action:
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ trigger.entity_id }}"

    # allow integration to reload
    - wait_template: "{{ has_value(trigger.entity_id) }}"
      timeout: 120

    - service: persistent_notification.create
      data:
        title: "Device Offline!"
        message: >
          The  {{ state_attr(trigger.entity_id,'friendly_name') }} device went offline.
          <br>The device was {{ iif(has_value(trigger.entity_id),'sucessfully reloaded','not able to reload') }}.
        notification_id: "{{ trigger.entity_id.split('.')[1] }}_offline"
