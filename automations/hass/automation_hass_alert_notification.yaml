###############################################################################
## Hass - Alert Notification
###############################################################################
- id: hass_alert_notification
  alias: "[Hass] Alert Notification"
  description: "Send notification for hass alert."
  mode: queued
  max: 20
  variables:
    tag: "{{ trigger.entity_id.split('.')[1] }}"
  trigger:
    - platform: state
      entity_id:
        - sensor.unavailable_entities
        - sensor.offline_integrations
        - sensor.unavailable_media_players
        - sensor.available_updates
        - sensor.unknown_browsers
        - sensor.unknown_devices
      attribute: entity_id
      to: ~
      for: 30 # throttle alerts
  condition:
    - condition: state
      entity_id: input_boolean.hass_alerts
      state: "on"
  action:
    - if: >
        {{ states(trigger.entity_id)|int(-1) > 0 }}
      then:
        - wait_template: "{{ is_state('alert.' ~ tag,'on') or states(trigger.entity_id)|int(-1) < 1 }}"
          timeout: 3600
          continue_on_timeout: false

        - condition: template
          value_template: "{{ is_state('alert.' ~ tag,'on') }}"

        - service: notify.jason
          data:
            title: "{{ state_attr(trigger.entity_id,'friendly_name') }}"
            message: >
              - {{ expand(state_attr(trigger.entity_id,'entity_id'))
                    |map(attribute='name')|join('<br>- ') }}
            data:
              tag: "{{ tag }}"
              group: System
              channel: Alert
              importance: max
              ttl: 0
              priority: high
              visibility: public
              notification_url: mdi:alert-circle
              icon_url: !secret HASSIO_ICON
              ledColor: !secret WARNING_COLOR
              color: !secret WARNING_COLOR
              vibrationPattern: !secret ALERT_VIBRATION
              clickAction: /lovelace/system
              actions:
                - title: "Pause Alert"
                  action: "pause_alert_{{ tag }}"
      else:
        - condition: template
          value_template: "{{ states(trigger.from_state.state)|int(-1) > 0 }}"

        - service: notify.jason
          data:
            message: clear_notification
            data:
              tag: "{{ tag }}"
