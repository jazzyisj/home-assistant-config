###############################################################################
## Hass - Alert Notification
###############################################################################
- id: hass_alert_notification
  alias: "[Hass] Alert Notification"
  description: "Send notification for hass alert."
  mode: queued
  max: 25 #VERIFY
  variables:
    tag: "{{ trigger.entity_id.split('.')[1] }}"
  trigger:
    - platform: state
      entity_id:
        - sensor.unavailable_entities
        - sensor.offline_integrations
        - binary_sensor.unavailable_media_player
        - sensor.available_updates
        - sensor.unknown_browsers
        - sensor.unknown_devices
      attribute: entity_id
      to: ~
  action:
    - if: >
        {{ states(trigger.entity_id)|int(-1) > 0 }}
      then:
        - condition: template
          value_template: "{{ not is_state('alert.' ~ tag,'off') }}"

        - service: notify.jason
          data:
            title: "{{ state_attr(trigger.entity_id,'friendly_name') }}"
            message: >
              - {{ expand(state_attr(trigger.entity_id,'entity_id'))
                    |map(attribute='name')|join('<br>- ') }}
            data:
              tag: "{{ tag }}"
              group: System
              channel: Alert
              importance: max
              ttl: 0
              priority: high
              visibility: public
              notification_url: mdi:alert-circle
              icon_url: !secret HASSIO_ICON
              ledColor: !secret WARNING_COLOR
              color: !secret WARNING_COLOR
              vibrationPattern: !secret ALERT_VIBRATION
              clickAction: /lovelace/system
              actions:
                - title: "Pause Alert"
                  action: "pause_alert_{{ tag }}"
      else:
        - service: notify.jason
          data:
            message: clear_notification
            data:
              tag: "{{ tag }}"
