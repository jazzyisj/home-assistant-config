###############################################################################
## Hass - Reload Failed Device Integration
#ISSUE - errors on google home integration reload https://github.com/leikoilja/ha-google-home/issues/618

#QUESTION what if config entry doesn't have reload?
# - service: homeassistant.reload_config_entry
#   data:
#     entry_id: b93eebb7412c5208c93fbb7ea8208027 # when no entities/all devices eg webrtc
###############################################################################
- id: hass_reload_failed_device_integration
  alias: "[Hass] Reload Failed Device Integration"
  description: "Reload failed device integration."
  mode: parallel
  trigger:
    #ISSUE Google Home integration doesn't always load at startup
    - platform: homeassistant
      id: startup
      event: start

    #ISSUE devices go offline
    - platform: state
      entity_id:
        - switch.hot_tub_energy_monitor
        - switch.indoor_sump
        - switch.outdoor_sump
        - switch.garage_furnace
        - switch.hot_tub_energy_monitor

        - sensor.bathroom_speaker_device
        - sensor.bedroom_hub_device
        - sensor.deck_chromecast_device
        - sensor.dining_room_hub_device
        - sensor.garage_speaker_device
        - sensor.laundry_room_speaker_device
        - sensor.living_room_chromecast_device
        - sensor.living_room_speaker_device
        - sensor.office_chromecast_device
      to:
        - unknown
        - unavailable
      for: 5
  action:
    if: "{{ trigger.id == 'startup' }}"
    then:
      - delay:
          minutes: 5

      - condition: state
        entity_id: sensor.dining_room_hub_device
        match: any
        state:
          - unknown
          - unavailable

      - service: homeassistant.reload_config_entry
        target:
          entity_id: sensor.dining_room_hub_device
    else:
      - service: homeassistant.reload_config_entry
        target:
          entity_id: "{{ trigger.entity_id }}"

      - delay: 120 # allow integration to reload, bumped time up google home devices take a while

      - service: persistent_notification.create
        data:
          title: "Device Offline!"
          message: >
            The  {{ state_attr(trigger.entity_id,'friendly_name') }} device went offline.
            <br>The device was {{ iif(states(trigger.entity_id) in ['unknown','unavailable'],'not able to reload','sucessfully reloaded' )}}.
          notification_id: "{{ trigger.entity_id.split('.')[1] }}_offline"
