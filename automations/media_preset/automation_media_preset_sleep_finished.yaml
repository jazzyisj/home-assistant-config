#######################################################################################################################
## Media Preset - Sleep Finished
#######################################################################################################################
- id: media_preset_sleep_finished
  alias: "[Media Preset] Sleep Timer Finished"
  description: Turn off booleans.
  initial_state: true
  mode: single
  #max_exceeded: silent # retriggered if timer cancelled
  trigger:
    - platform: state
      entity_id: input_boolean.media_preset_sleep
      to: 'off'

    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.media_preset_sleep

    - platform: event
      event_type: timer.cancelled
      event_data:
        entity_id: timer.media_preset_sleep

  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.media_preset_sleep

    - service: timer.cancel
      entity_id: timer.media_preset_sleep

    - choose:
        - conditions:
            # stop here if timer didn't finish
            - condition: template
              value_template: >
                {% if trigger.event is defined %}{{ trigger.event.event_type == 'timer.finished' }}
                {% else %} false
                {% endif %}

          sequence:
            - service: "{{ 'script.radio_stop' if states('input_select.media_preset_type_sleep','Radio') else 'script.spotify_stop' }}"
