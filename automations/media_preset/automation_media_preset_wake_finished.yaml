#######################################################################################################################
## Media Preset - Wake Finished
#######################################################################################################################
- id: media_preset_wake_finished
  alias: "[Media Preset] Wake Finished"
  description: Stop timers, turn off booleans, start morning radio.
  initial_state: true
  mode: single
  max_exceeded: silent # retriggered if timer cancelled
  trigger:
    - platform: state
      entity_id: input_boolean.media_preset_wake
      to: 'off'

    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.media_preset_wake

    - platform: event
      event_type: timer.cancelled
      event_data:
        entity_id: timer.media_preset_wake

    - platform: template
      value_template: >
        {{ is_state('input_boolean.media_preset_wake','on') and states(states('input_select.media_preset_speaker_wake')) in ['idle','off','unknown','unavailable','none'] }}
      for:
        seconds: 30

  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.media_preset_wake

    - service: timer.cancel
      entity_id: timer.media_preset_wake

    # stop here if timer didn't finish
    - condition: template
      value_template: >
        {% if trigger.event is defined %}{{ trigger.event.event_type == 'timer.finished' }}
        {% else %} false
        {% endif %}

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.media_preset_enabled_morning
              state: 'on'

          sequence:
            - service: script.media_preset_play
              data:
                preset: morning