#######################################################################################################################
## Alarm - Automation Check
## - prevents alarm settings changes from UI while alarm is armed
#######################################################################################################################
- id: alarm_automation_check
  alias: "[Alarm] Automation Check"
  description: Turn entity back on if alarm not disarmed.
  initial_state: true
  mode: queued
  max: 20
  trigger:
    - platform: state
      entity_id:
        - automation.alarm_armed_away
        - automation.alarm_armed_home
        - automation.alarm_armed_night
        - automation.alarm_check_automation_check
        - automation.alarm_close_triggered_notifications
        - automation.alarm_close_warning_notifications
        - automation.alarm_disarm_mobile
        - automation.alarm_disarmed
        - automation.alarm_garage_motion
        - automation.alarm_occupancy_mode_control
        - automation.alarm_offline_alert
        - automation.alarm_offline_alert_cancelled
        - automation.alarm_offline_alert_closed
        - automation.alarm_offline_alert_pause
        - automation.alarm_panic_alarm
        - automation.alarm_pending
        - automation.alarm_triggered
        - automation.alarm_triggered_reset_timer_finished
        - automation.alarm_warning
        - automation.alarm_warning_lights_restore
        - input_boolean.alarm_auto_arming
        - input_boolean.alarm_automation
      to: 'off'

  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: alarm_control_panel.house
          state: disarmed

    # allows temp disarm, check to override
    - condition: state
      entity_id: input_boolean.alarm_temp_override
      state: 'off'

  action:
    - service: homeassistant.turn_on
      data:
        entity_id: "{{ trigger.entity_id }}"

    - service: browser_mod.toast
      data:
        message: Settings cannot be changed while alarm is armed.
        duration: 30000

#######################################################################################################################
## Alarm - Check Automation Check
## - prevents alarm settings changes from UI while alarm is armed
## - this is separate from automation check becuase turning automation.alarm_automation_check kills script
#######################################################################################################################
- id: alarm_check_automation_check
  alias: "[Alarm] Check Automation Check"
  description: Turn entity back off if alarm not disarmed.
  initial_state: true
  mode: queued
  max: 10
  trigger:
    - platform: state
      entity_id: automation.alarm_automation_check
      to: 'off'

  condition:
    - condition: not
      conditions:
        - condition: state
          entity_id: alarm_control_panel.house
          state: disarmed

  action:
    - service: automation.turn_on
      entity_id: automation.alarm_automation_check

    - service: browser_mod.toast
      data:
        message: Settings cannot be changed while alarm is armed.
        duration: 30000