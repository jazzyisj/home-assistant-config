#######################################################################################################################
## Presence - Occupancy Mode Night
#######################################################################################################################
- id: presence_occupancy_mode_night
  alias: "[Presence] Occupancy Mode Night"
  description: "Night state."
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: Night
      for:
        seconds: 5 # allow scene reset to turn lights off

  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.presence_automation
              state: 'on'

            - condition: state
              entity_id: binary_sensor.someone_home
              state: 'off'

          sequence:
            - service: automation.turn_off
              data:
                entity_id: group.occupancy_bypass_automations
                stop_actions: false

            # back to previous mode
            - service: input_select.select_option
              data:
                entity_id: input_select.occupancy_mode
                option: "{{ trigger.from_state.state }}"

            - service: automation.turn_on
              entity_id: group.occupancy_bypass_automations

      default:
        # timers cancelled here so lights can turn off
        - service: timer.cancel
          entity_id: group.light_in_use_timers

        # make sure bedtime_delayed is off
        - service: input_boolean.turn_off
          entity_id: input_boolean.bedtime_delayed
