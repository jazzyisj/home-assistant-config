###############################################################################
## Network - Reload Asus Router #TEMP until fixed
## #ISSUE goes offline/sometimes doesn't load on startup
###############################################################################
- id: network_reload_asus_router
  alias: "[Network] Reload Asus Router"
  description: "Reload Asus Router integration when unavailable."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.startup_pending
      to: "off"

    - platform: state
      id: device
      entity_id: sensor.rt_ax58u_boot_time
      to:
        - unknown
        - unavailable
      for: 300 # allow integration to try and self reload
  condition:
    - condition: state
      entity_id: sensor.rt_ax58u_boot_time
      match: any
      state:
        - unknown
        - unavailable
  action:
    - service: homeassistant.reload_config_entry
      target:
        device_id: af070d578862a4f726973ce1bbdd6671

    # allow integration to reload
    - wait_template: "{{ has_value(trigger.entity_id) }}"
      timeout: 60

    - service: persistent_notification.create
      data:
        title: "Router Offline!"
        message: |
          The router went offline and was
          {{- iif(has_value(trigger.entity_id), ' sucessfully reloaded', ' not able to reload') }}.
        notification_id: router_offline"
