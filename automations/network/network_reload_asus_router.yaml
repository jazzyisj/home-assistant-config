###############################################################################
## Network - Reload Asus Router #TEMP until fixed
## #ISSUE goes offline/sometimes doesn't load on startup
###############################################################################
- id: network_reload_asus_router
  alias: "[Network] Reload Asus Router"
  description: "Reload Asus Router integration when unavailable."
  max_exceeded: silent
  trigger:
    - platform: state
      id: startup
      entity_id: input_boolean.startup_pending
      to: "off"

    - platform: state
      id: device
      entity_id:
        - sensor.rt_ax58u_boot_time
        - sensor.rt_ax58u_wan_download #TEST
      to:
        - unknown
        - unavailable
      for: 300 # allow integration to try and self reload
  condition:
    - condition: state
      entity_id:
        - sensor.rt_ax58u_boot_time
        - sensor.rt_ax58u_wan_download
      match: any
      state:
        - unknown
        - unavailable
  action:
    - service: homeassistant.reload_config_entry
      target:
        device_id: af070d578862a4f726973ce1bbdd6671

    - delay: 15 # allow integration to reload

    - if: "{{ trigger.id == 'startup' }}"
      then:
        - service: persistent_notification.create
          data:
            title: "Router Offline!"
            message: |

            notification_id: router_offline
      else:
        - service: persistent_notification.create
          data:
            title: "Router Offline!"
            message: |
              {%- if trigger.id == 'startup' %}
                The Asus Router integration was reloaded at startup
                {{- iif(has_value('rt_ax58u_wan_download'),
                    ' and was sucessfully reloaded', ' but was not able to reload') }}.
              {%- else %}
              The Asus Router integration went offline and was
              {{- iif(has_value(trigger.entity_id), ' sucessfully reloaded', ' not able to reload') }}.
              {%- endif -%}
            notification_id: router_offline"
