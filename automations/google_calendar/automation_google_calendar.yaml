###############################################################################
## Schedule - Calendar Alert
###############################################################################
- id: schedule_calendar_alert
  alias: '[Schedule] Calendar Alert'
  description: 'Notification on calendar alert.'
  trigger:
    - platform: state
      entity_id: binary_sensor.calendar_alert
      to: 'on'
      from: 'off'
  action:
    - service: persistent_notification.create
      data:
        title: 'Calendar Error'
        message: |
          {%- if state_attr('binary_sensor.calendar_alert','calendars') != none %}
            {%- set calendars = state_attr('binary_sensor.calendar_alert','calendars') %}
            {%- for item in calendars %}
              {%- if not loop.first %}<br>{% endif %}
              The {{ item }} calendar is empty or not connected.
            {%- endfor %}
          {%- endif -%}
        notification_id: calendar_alert

###############################################################################
## Schedule - Pause Calendar Alert
###############################################################################
- id: schedule_pause_calendar_alert
  alias: '[Schedule] Pause Calendar Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_calendar_alert
  action:
    - service: alert.turn_off
      entity_id: alert.calendar_alert

    - service: persistent_notification.dismiss
      data:
        notification_id: calendar_alert

###############################################################################
## Schedule - Clear Calendar Notifications
###############################################################################
- id: schedule_clear_calendar_notifications
  alias: '[Schedule] Clear Calendar Notifications'
  description: 'Clear notifications.'
  trigger:
    - platform: state
      entity_id: alert.calendar_alert
      to: 'off'
  condition: '{{ now() - states.automation.schedule_pause_calendar_alert.attributes.last_triggered > timedelta(seconds=30) }}'
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: calendar_alert
