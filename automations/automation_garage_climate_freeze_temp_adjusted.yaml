#######################################################################################################################
## Garage Climate - Freeze Temp Adjusted (Hassio)
#######################################################################################################################
- id: garage_climate_freeze_temp_adjusted
  alias: "[Garage Climate] Freeze Temp Adjusted"
  description: "Freeze temperature adjusted, update thermostat and play announcement."
  initial_state: true
  mode: restart
  trigger:
    - entity_id: input_number.garage_freeze_temperature
      platform: state

  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.garage_freeze_protection
          state: 'on'

        # only run if heat is off (heat temp takes precedence)
        - condition: state
          entity_id: input_boolean.garage_heat
          state: 'off'

  action:
    # wait for zwave to be ready, cancel if not
    #BUGFIX - zwave dropping out
    - wait_template: "{{ is_state('zwave.garage_thermostat','ready') }}"
      timeout:
        minutes: 5
      continue_on_timeout: false

    - service: climate.set_temperature
      data:
        entity_id: climate.garage_thermostat
        temperature: "{{ states('input_number.garage_freeze_temperature')|int }}"

    # wait for thermostat temp = set temp
    - wait_template: "{{ states('input_number.garage_freeze_temperature')|float == state_attr('climate.garage_thermostat','temperature')|float }}"
      timeout:
        minutes: 2
      continue_on_timeout: true

    - service: script.tts_announcement
      data:
        play_message: >-
            The garage thermostat has been set to {{ '%0.0f'|format(state_attr('climate.garage_thermostat','temperature')|float) }} degrees.
            The garage temperature is {{ '%0.0f'|format(state_attr('climate.garage_thermostat','current_temperature')|float) }} degrees.
