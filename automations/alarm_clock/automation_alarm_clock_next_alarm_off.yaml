#######################################################################################################################
## Alarm Clock - Next Alarm Off
#######################################################################################################################
- id: alarm_clock_next_alarm_off
  alias: "[Alarm Clock] Next Alarm Off"
  description: Turn off next alarm clock.
  initial_state: true
  mode: queued
  variables:
    source: "{{ state_attr('sensor.alarm_clock_next_alarm','alarm_source') }}"
    time: "{{states('sensor.time') }}"
    wake: "{{ states('sensor.waketime_tomorrow') if time > states('sensor.waketime_today') else states('sensor.waketime_today') }}"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: next_alarm_off
  action:
    - choose:
        - conditions: "{{ source == 'auto' }}"
          sequence:
            - service: input_boolean.turn_off
              data:
                entity_id: >
                  {{ 'input_boolean.alarm_clock_auto_workdays'
                        if time < wake and is_state('binary_sensor.work_today','on')
                          else 'input_boolean.alarm_clock_auto_weekends' }}

            - service: input_boolean.turn_on
              data:
                entity_id: >
                  {{ 'input_boolean.alarm_clock_reset_auto_weekdays'
                        if time < wake and is_state('binary_sensor.work_today','on')
                          else 'input_boolean.alarm_clock_reset_auto_weekends' }}

        - conditions: "{{ source == 'manual' }}"
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_manual

            - service: input_boolean.turn_on
              entity_id: input_boolean.alarm_clock_reset_manual

        - conditions: "{{ source == 'nap' }}"
          sequence: # no reset for nap alarms
            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_nap

    - condition: state
      entity_id: binary_sensor.bedtime_active
      state: 'on'

    - service: script.bedtime_notification

#######################################################################################################################
## Alarm Clock - Next Alarm Off Reset  - do not reset nap alarm
#######################################################################################################################
- id: alarm_clock_next_alarm_off_reset
  alias: "[Alarm Clock] Next Alarm Off Reset"
  description: Turn alarm clock enabled on if reset is on.
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: template
      value_template: "{{ is_state('sensor.time',states('sensor.waketime_today')) }}"

    - platform: state
      entity_id:
        - input_boolean.alarm_clock_reset_auto_weekdays
        - input_boolean.alarm_clock_reset_auto_weekends
        - input_boolean.alarm_clock_reset_manual
      to: 'off'
  action:
    - choose: # if trigger is waketime, delay so we don't trigger alarm clock
        - conditions: "{{ is_state('sensor.time',states('sensor.waketime_today')) }}"
          sequence:
            - delay: 65

    - choose:
        - conditions:
            - condition: or
              conditions:
                - "{{ trigger.entity_id == 'input_boolean.alarm_clock_reset_auto_weekdays' }}"
                - condition: state
                  entity_id: input_boolean.alarm_clock_reset_auto_weekdays
                  state: 'on'
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.alarm_clock_auto_workdays

            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_reset_auto_weekdays
    - choose:
        - conditions:
            - condition: or
              conditions:
                - "{{ trigger.entity_id == 'input_boolean.alarm_clock_reset_auto_weekends' }}"
                - condition: state
                  entity_id: input_boolean.alarm_clock_reset_auto_weekends
                  state: 'on'
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.alarm_clock_auto_weekends

            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_reset_auto_weekends

    - choose:
        - conditions:
            - condition: or
              conditions:
                - "{{ trigger.entity_id == 'input_boolean.alarm_clock_reset_manual' }}"
                - condition: state
                  entity_id: input_boolean.alarm_clock_reset_manual
                  state: 'on'
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.alarm_clock_manual

            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_reset_manual
