#######################################################################################################################
## Alarm Clock - Manual Active On
#######################################################################################################################
- id: alarm_clock_manual_active_on
  alias: "[Alarm Clock] Manual Active On"
  description: "Play alarm clock when manual active boolean turns on."
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_clock_active_manual
      to: 'on'

    - platform: template
      value_template: >
        {{ is_state('input_boolean.alarm_clock_manual','on')
            and (states('sensor.time') == states('input_datetime.alarm_clock_manual_time')[0:5]) }}

  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_boolean.alarm_clock_active_auto
                  state: 'on'

                - condition: state
                  entity_id: input_boolean.alarm_clock_active_nap
                  state: 'on'

                - condition: state
                  entity_id: input_boolean.alarm_clock_manual
                  state: 'off'

          sequence:
            # turn off automation so we don't turn off active alarm, trigger radio resume
            - service: automation.turn_off
              entity_id: automation.alarm_clock_off

            #NOTE this will trigger automation.radio_auto_resume if radio is on (binary_sensor.alarm_clock_active turns on/off)
            - service: input_boolean.turn_off
              entity_id: input_boolean.alarm_clock_active_manual

            - service: automation.turn_on
              entity_id: automation.alarm_clock_off

            - service: browser_mod.toast
              data:
                message: "Manual alarm clock could not run. The manual alarm clock is not enabled or there is another active alarm clock."
                duration: 30000

      default:
        # turn off automation to avoid recursive trigger
        - service: automation.turn_off
          data:
            entity_id: automation.alarm_clock_manual_active_on
            stop_actions: false

        # required if time trigger
        - service: input_boolean.turn_on
          entity_id: input_boolean.alarm_clock_active_manual

        - service: automation.turn_on
          entity_id: automation.alarm_clock_manual_active_on

        - service: script.turn_on
          data:
            entity_id: script.alarm_clock_play
            variables:
              alarm_type: 'manual'
              first_run: true