#######################################################################################################################
## Presence - LED notification
#######################################################################################################################
- id: presence_led_notification
  alias: "[Presence] LED notification"
  description: "Detect who arrived home and display LED notification."
  initial_state: true
  mode: restart
  trigger:
    # delay to prevent unwanted triggers and run after arrive home lights so led notification aren't reset
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
        - input_boolean.guest_home
      to: 'on'
      for:
        seconds: 30

    - platform: numeric_state
      entity_id:
        - proximity.jhome
        - proximity.shome
      below: 5  #km
      for:
        minutes: 5 # prevent unintentional triggers

  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

    # jason_home / sheri_home always off as startup
    - condition: state
      entity_id: variable.startup_complete
      state: 'true'

    # if proximity trigger only run when person heading towards home
    - condition: template
      value_template: >
        {{ state_attr(trigger.entity_id,'dir_of_travel') == 'towards' if trigger.entity_id in ['proximity.jhome','proximity.shome'] else true }}

  action:
    - repeat:
        while:
          - condition: template
            value_template: >
              {% set c = state_attr('group.zwave_led_lights_2','entity_id')|count %}
              {{ repeat.index <= c }}

        sequence:
          - condition: template
            value_template: >
              {% set l = state_attr('group.zwave_led_lights_2','entity_id') %}
              {{ is_state('zwave.' ~ l[repeat.index-1].split('.')[1],'ready') }}
                
          - service: zwave.set_config_parameter
            data:
              node_id: >
                {% set l = state_attr('group.zwave_led_lights_2','entity_id') %}
                {{ state_attr(l[repeat.index-1],'node_id')|int }}
              parameter: >
                {% set sw = state_attr('group.zwave_switch_lights','entity_id') %}
                {% set l = state_attr('group.zwave_led_lights_2','entity_id') %}
                {{ 8 if l[repeat.index-1] in sw else 16 -}} {# switch 8, dimmer 16 #}
              size: 4
              value: !include /config/include/template/led_presence_template.yaml