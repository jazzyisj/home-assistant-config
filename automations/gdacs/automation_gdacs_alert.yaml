#######################################################################################################################
## Weather - GDACS Zone Alert
#######################################################################################################################
- id: weather_gdacs_zone_alert
  alias: "[Weather] GDACS Zone Alert"
  description: Active alert notification when entering gdacs alert zone.
  initial_state: true
  mode: parallel
  trigger:
    platform: geo_location
    source: gdacs
    zone: zone.gdacs_alert
    event: enter

  condition:
    condition: numeric_state
    entity_id: sensor.gdacs_alerts
    above: '0'

  action:
    - service: notify.mobile_app_jphone #ISSUE how dow we determine who set off alert to send to right phone?
      data:
        title: Active GDACS Alerts
        message: >
            {% set gdacs_alerts = states.geo_location|selectattr('attributes.source','eq','gdacs')|map(attribute='attributes.description')|join('<br>') %}
            {{ gdacs_alerts }}
        data:
          subject: There are active GDACS alerts in this zone.
          tag: gdacs_zone_alert
          group: General
          channel: Alert
          importance: max
          clickAction: /lovelace/weather
          color: !secret CRITICAL_COLOR
          icon_url: !secret ALERT_ICON

#######################################################################################################################
## Weather - Close GDACS Zone Alert Notifications
#######################################################################################################################
- id: weather_close_gdacs_zone_alert_notifications
  alias: "[Weather] Close GDACS Zone Alert Notifications"
  description: Dismiss notifications on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: gdacs_zone_alert

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: gdacs_zone_alert

    - delay:
        seconds: 180 # prevent recursive triggers