#######################################################################################################################
## Presence - Someone Almost Home
#######################################################################################################################
- id: presence_someone_almost_home
  alias: "[Presence] Someone Almost Home"
  description: "Notify, switch to override mode when someone is almost home."
  initial_state: true
  mode: parallel
  max: 5
  trigger:
    - platform: numeric_state
      entity_id:
        - proximity.jhome
        - proximity.shome
      below: 4  #km

  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

    - condition: state
      entity_id: variable.startup_complete
      state: 'true'

    - condition: template
      value_template: "{{ state_attr(trigger.entity_id,'dir_of_travel') == 'towards' }}"

  action:
    # occupancy mode to override so HVAC turns off eco mode
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.climate_automation
              state: 'on'

            - condition: state
              entity_id: binary_sensor.someone_home
              state: 'off'

          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.occupancy_mode
                option: Override

    - condition: state
      entity_id: binary_sensor.alerts_enabled
      state: 'on'

    - service: !include /config/include/template/notify_jason_template.yaml
      data:
        title: >
          {% if trigger.entity_id == 'proximity.jhome' %} Jason Almost Home
          {% elif trigger.entity_id == 'proximity.shome' %} Sheri Almost Home
          {% endif %}
        message: >
          {% if trigger.entity_id == 'proximity.jhome' %} Get a beer ready for him!
          {% elif trigger.entity_id == 'proximity.shome' %} Hide the hookers and cocaaine!
          {% endif %}
        data:
          actions:
            title: Close
            action: close_someone_almost_home
          tag: someone_almost_home
          timestamp: "{{ as_timestamp(now()) }}" #push
          priority: normal
          renotify: true #push
          ttl: 3600
          silent: false #push
          requireInteraction: false #push
          sticky: false #app
          url: /lovelace/presence #push
          clickAction: /lovelace/presence #app
          color: !secret NOTIFY_COLOR #app

#######################################################################################################################
## Presence - Close Someone Almost Home Notifications
#######################################################################################################################
- id: presence_close_someone_almost_home_notifications
  alias: "[Presence] Close Someone Almost Home Notifications"
  description: "Dismiss notification on all devices when closed on one."
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: html5_notification.closed
      event_data:
        tag: someone_almost_home

    #BUG html5 closed event doesn't work if notification is in tray
    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action: close_someone_almost_home

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: close_someone_almost_home

  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: someone_almost_home