###############################################################################
## Alarm - Danger Warning
###############################################################################
- id: alarm_danger_warning
  alias: '[Alarm] Danger Warning'
  description: 'Cast danger warning to all displays.'
  trigger:
    - platform: state
      entity_id: binary_sensor.danger_alarm
      to: 'on'
      from: 'off'
  action:
    - service: browser_mod.navigate
      data:
        navigation_path: /lovelace-cast/danger
        deviceID: browser_kiosk_internal

    - service: cast.show_lovelace_view
      data:
        dashboard_path: lovelace-cast
        entity_id: media_player.dining_room_hub
        view_path: danger

    - service: cast.show_lovelace_view
      data:
        dashboard_path: lovelace-cast
        entity_id: media_player.bedroom_hub
        view_path: danger

    - service: cast.show_lovelace_view
      data:
        dashboard_path: lovelace-cast
        entity_id: media_player.living_room_chromecast
        view_path: danger

    #BUG lovelace cast not working on office chromecast
    # - service: cast.show_lovelace_view
    #   data:
    #     dashboard_path: lovelace-cast
    #     entity_id: media_player.office_chromecast
    #     view_path: danger

    #ERROR (SyncWorker_11) [homeassistant.util.logging] Exception in _handle_signal_show_view when dispatching 'cast_show_view': (<pychromecast.controllers.homeassistant.HomeAssistantController object at 0xffff43704d90>, 'media_player.office_chromecast', 'front_door', 'lovelace-cast')
    # Traceback (most recent call last):
    #   File "/usr/src/homeassistant/homeassistant/components/cast/media_player.py", line 875, in _handle_signal_show_view
    #     self._hass_cast_controller.show_lovelace_view(view_path, url_path)
    #   File "/usr/local/lib/python3.9/site-packages/pychromecast/controllers/homeassistant.py", line 118, in show_lovelace_view
    #     self._send_connected_message(
    #   File "/usr/local/lib/python3.9/site-packages/pychromecast/controllers/homeassistant.py", line 129, in _send_connected_message
    #     self._connect_hass(
    #   File "/usr/local/lib/python3.9/site-packages/pychromecast/controllers/homeassistant.py", line 102, in _connect_hass
    #     raise PyChromecastError()
    # pychromecast.error.PyChromecastError

    - wait_template: "{{ is_state('binary_sensor.danger_alarm','off') }}"
      timeout: 3600
      continue_on_timeout: false

    - if:
        - condition: state
          entity_id: alarm_control_panel.master
          state: triggered
      then:
        - service: script.disarm_alarm
          data:
            person: hassio
            zone: master

    - service: media_player.turn_off
      target:
        entity_id:
          - media_player.living_room_tv
          - media_player.living_room_chromecast
          - media_player.office_tv
          - media_player.office_chromecast
          - media_player.dining_room_hub
          - media_player.bedroom_hub

    - service: browser_mod.navigate
      data:
        navigation_path: /lovelace-kiosk/home
        deviceID: browser_kiosk_internal
