######################################################################################################################
# Alarm - Current Alarm
######################################################################################################################
- id: alarm_current_alarm
  alias: "[Alarm] Current Alarm"
  description: Set active alarm message for tts, display in UI
  max_exceeded: silent # called by triggered after pending
  variables:
    trigger_entity: "{{ expand(state_attr('alarm_control_panel.master','open_sensors'))|map(attribute='name')|join('') }}"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to:
        - pending
        - triggered
  action:
    - choose:
        - conditions: "{{ is_state('input_boolean.alarm_pending','off') if is_state('alarm_control_panel.master','triggered') else true }}"
          sequence: # only set when triggered if not pending first
            - service: input_text.set_value
              target:
                entity_id: input_text.current_alarm
              data:
                value: >
                  {% if is_state('binary_sensor.tornado_alert','on') %} Tornado Alert
                  {% else %} {{ trigger_entity|title }}
                  {% endif %}

    - delay: 5 # allow booleans to set

    - wait_template: "{{ is_state('input_boolean.alarm_pending','off') and is_state('input_boolean.alarm_triggered','off') }}"

    - service: input_text.set_value
      target:
        entity_id: input_text.current_alarm
      data:
        value: cleared