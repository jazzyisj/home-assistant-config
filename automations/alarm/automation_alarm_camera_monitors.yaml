######################################################################################################################
# Alarm - Camera Monitors
######################################################################################################################
- id: alarm_camera_monitors
  alias: "[Alarm] Camera Monitors"
  description: "Turn camera monitors on."
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to: triggered
  condition:
    - condition: state
      entity_id:
        - input_boolean.alarm_automation
        - input_boolean.media_player_automation
        - binary_sensor.someone_home
      state: 'on'
  action:
    - service: media_player.turn_on
      entity_id:
        - media_player.living_room_tv
        - media_player.bedroom_tv

    - service: remote.turn_on
      entity_id: remote.office_tv

    - wait_template: >
        {{ is_state('media_player.living_room_tv','on')
            and is_state('media_player.bedroom_tv','on')
            and is_state('media_player.office_tv','on') }}
      timeout: 15

    - wait_template: > # wait for source to be available
        {{ 'HDMI 1' in state_attr('media_player.living_room_tv','source_list')
            and 'HDMI 1' in state_attr('media_player.bedroom_tv','source_list')
            and 'Camera' in state_attr('media_player.office_tv','source_list') }}
      timeout: 15

    - service: media_player.select_source
      target:
        entity_id:
          - media_player.living_room_tv
          - media_player.bedroom_tv
      data:
        source: HDMI 1 # security cameras

    - service: media_player.select_source
      target:
        entity_id: media_player.office_tv
      data:
        source: Camera # security cameras

    - wait_template: "{{ is_state('input_boolean.alarm_triggered','off') }}"

    - choose: # tv is still on security cam is still camera source, turn it off
        - conditions: "{{ is_state_attr('media_player.living_room_tv','source','HDMI 1') }}"
          sequence:
            - service: media_player.turn_off
              entity_id: media_player.living_room_tv

    - choose:
        - conditions: "{{ is_state_attr('media_player.bedroom_tv','source','HDMI 1') }}"
          sequence:
            - service: media_player.turn_off
              entity_id: media_player.bedroom_tv

    - choose:
        - conditions: "{{ is_state_attr('media_player.office_tv','source','Camera') }}"
          sequence:
            - service: media_player.turn_off
              entity_id: media_player.office_tv