###############################################################################
# Alarm - Camera Monitors
###############################################################################
- id: alarm_camera_monitors
  alias: "[Alarm] Camera Monitors"
  description: "Turn camera monitors on."
  variables:
    danger: "{{ is_state('binary_sensor.danger_alarm','on') }}"
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_triggered
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.alarm_enabled
      state: "on"
  action:
    - service: media_player.turn_on
      entity_id: media_player.living_room_tv

    - if: "{{ not danger }}"
      then:
        #ISSUE no chromecast
        - service: media_player.turn_on
          target:
            entity_id: media_player.bedroom_tv

        #ISSUE roku sometimes unavailable
        #ISSUE v1 chromecast - casting doesn't work
        - if: "{{ has_value('media_player.office_tv') }}"
          then:
            - service: media_player.turn_on
              target:
                entity_id: media_player.office_tv
              continue_on_error: true

    # wait for source lists to be available
    - if: "{{ danger }}"
      then:
        - service: browser_mod.navigate
          data:
            path: /lovelace/danger
            browser_id: kiosk_internal

        - service: cast.show_lovelace_view
          data:
            dashboard_path: lovelace-cast
            entity_id: media_player.dining_room_hub
            view_path: danger

        - service: cast.show_lovelace_view
          data:
            dashboard_path: lovelace-cast
            entity_id: media_player.bedroom_hub
            view_path: danger

        - wait_template: "{{ 'HDMI 2' in state_attr('media_player.living_room_tv','source_list')}}"
          timeout: 90

        - if: "{{ wait.completed }}"
          then:
            - service: media_player.select_source
              target:
                entity_id: media_player.living_room_tv
              data:
                source: HDMI 2 # chromecast

            - service: cast.show_lovelace_view
              data:
                dashboard_path: lovelace-cast
                entity_id: media_player.living_room_chromecast
                view_path: danger

      # tv's won't turn off after alarm if source didn't change here
      else:
        - parallel:
            - sequence:
                - wait_template: >
                    {{ is_state('media_player.living_room_tv','on')
                        and 'HDMI 1' in state_attr('media_player.living_room_tv','source_list') }}
                  timeout: 90

                - if: "{{ wait.completed }}"
                  then:
                    - delay: 5

                    - service: media_player.select_source
                      target:
                        entity_id: media_player.living_room_tv
                      data:
                        source: HDMI 1 # security cameras

            - sequence:
                - wait_template: >
                    {{ is_state('media_player.bedroom_tv','on')
                        and 'HDMI 1' in state_attr('media_player.bedroom_tv','source_list') }}
                  timeout: 90

                - if: "{{ wait.completed }}"
                  then:
                    - delay: 5

                    - service: media_player.select_source
                      target:
                        entity_id: media_player.bedroom_tv
                      data:
                        source: HDMI 1 # security cameras

            - sequence:
                - wait_template: "{{ 'Camera' in state_attr('media_player.office_tv','source_list')}}"
                  timeout: 90

                - if: "{{ wait.completed }}"
                  then:
                    - delay: 1

                    - service: media_player.select_source
                      target:
                        entity_id: media_player.office_tv
                      data:
                        source: Camera # security cameras

    - wait_template: >
        {{ is_state('input_boolean.alarm_triggered','off')
            and is_state('binary_sensor.danger_alarm','off') }}

    # if tv source still camera/chromecast, turn it off
    - if: "{{ state_attr('media_player.living_room_tv','source') ['HDMI 1','HDMI 2'] }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.living_room_tv
          data:
            source: Live TV

        - service: media_player.turn_off
          entity_id: media_player.living_room_tv

    - if: "{{ state_attr('media_player.bedroom_tv','source') ['HDMI 1','HDMI 2'] }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.bedroom_tv
          data:
            source: Live TV

        - service: media_player.turn_off
          target:
            entity_id: media_player.bedroom_tv

    - if: "{{ state_attr('media_player.office_tv','source') in ['Camera','Chromecast'] }}"
      then:
        - service: media_player.turn_off
          entity_id: media_player.office_tv

    - if: "{{ danger }}"
      then:
        - service: button.press
          target:
            entity_id: button.fire_tablet_load_start_url

        - service: media_player.turn_off
          target:
            entity_id:
              - media_player.living_room_chromecast
              - media_player.dining_room_hub # stops casting
              - media_player.bedroom_hub # stops casting
