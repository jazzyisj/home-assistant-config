###############################################################################
# Alarm - Camera Monitors
###############################################################################
- id: alarm_camera_monitors
  alias: '[Alarm] Camera Monitors'
  description: 'Turn camera monitors on.'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_triggered
      to: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: 'on'

    # no cams for environmental alarms
    - condition: state
      entity_id:
        - binary_sensor.smoke_alarm
        - binary_sensor.co_alarm
        - binary_sensor.heat_alarm
      state: 'off'
  action:
    - service: media_player.turn_on
      entity_id:
        - media_player.living_room_tv
        - media_player.bedroom_tv

    # if office tv unavailable - Error while executing automation automation.alarm_camera_monitors: Unable to find service remote.turn_on
    - if: "{{ states('media_player.office_tv') not in ['unknown','unavailable'] }}"
      then:
        - service: remote.turn_on
          entity_id: remote.office_tv

    - wait_template: > # wait for source to be available
        {{ 'HDMI 1' in state_attr('media_player.living_room_tv','source_list')
            and 'HDMI 1' in state_attr('media_player.bedroom_tv','source_list')
            and 'Camera' in state_attr('media_player.office_tv','source_list') }}
      timeout: 60

    #BUG still sometimes not connected, wait for connection #IDEA wired connection for TV's
    - delay: 15

    #BUG #TV webos tv's won't turn off after alarm if turned on and source not changed to cams
    - if: "{{ 'HDMI 1' in state_attr('media_player.living_room_tv','source_list') }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.living_room_tv
          data:
            source: HDMI 1 # security cameras

    - if: "{{ 'HDMI 1' in state_attr('media_player.bedroom_tv','source_list') }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.bedroom_tv
          data:
            source: HDMI 1 # security cameras

    - if: "{{ 'Camera' in state_attr('media_player.office_tv','source_list') }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.office_tv
          data:
            source: Camera # security cameras

    - wait_template: "{{ is_state('input_boolean.alarm_triggered','off') }}"

    # source changes not detected on webos
    - service: homeassistant.update_entity
      target:
        entity_id:
          - media_player.living_room_tv
          - media_player.bedroom_tv

    - delay: 10 # wait for update

    # if tv is still on security cam is still camera source, turn it off
    - if: "{{ is_state_attr('media_player.living_room_tv','source','HDMI 1') }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.living_room_tv
          data:
            source: Live TV

        - service: media_player.turn_off
          entity_id: media_player.living_room_tv

    - if: "{{ is_state_attr('media_player.bedroom_tv','source','HDMI 1') }}"
      then:
        - service: media_player.select_source
          target:
            entity_id: media_player.bedroom_tv
          data:
            source: Live TV

        - service: media_player.turn_off
          target:
            entity_id: media_player.bedroom_tv

    - if: "{{ is_state_attr('media_player.office_tv','source','Camera') }}"
      then:
        - service: media_player.turn_off
          entity_id: media_player.office_tv
