###############################################################################
# Alarm - Popups
###############################################################################
- id: alarm_popups
  alias: "[Alarm] Popups"
  description: "Alarm browser popups."
  variables:
    trigger_entity: >
      {{ expand(state_attr('alarm_control_panel.master', 'open_sensors'))
          | map(attribute='entity_id') | join('') }}
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_triggered
      to:
        - "on"
        - "off"
  condition:
    - condition: state
      entity_id:
        - input_boolean.alarm_enabled
        - binary_sensor.someone_home
      state: "on"

    - condition: state
      entity_id: binary_sensor.danger_alarm
      state: "off"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.alarm_triggered
              state: "off"
          sequence:
            - service: browser_mod.close_popup # close alarm panel and/or alarm triggered popups

        - conditions: "{{ trigger_entity in state_attr('group.south_side_house_sensors', 'entity_id') }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Side Door Camera"
                content: !include /config/ui/card/camera/security/side_door.yaml
                size: fullscreen

        - conditions: "{{ trigger_entity in state_attr('group.front_house_sensors', 'entity_id') }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Front Door Camera"
                content: !include /config/ui/card/camera/security/front_door.yaml
                size: fullscreen

        - conditions: "{{ trigger_entity in state_attr('group.front_north_side_house_sensors', 'entity_id') }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Side Gate Front Camera"
                content: !include /config/ui/card/camera/security/side_gate_front.yaml
                size: fullscreen

        - conditions: >
            {{ trigger_entity in state_attr('group.back_north_side_house_sensors', 'entity_id') }}
          sequence:
            - service: browser_mod.popup
              data:
                title: "Side Gate Back Camera"
                content: !include /config/ui/card/camera/security/side_gate_back.yaml
                size: fullscreen

        - conditions: "{{ trigger_entity in state_attr('group.back_house_sensors', 'entity_id') }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Back Door Camera"
                content: !include /config/ui/card/camera/security/back_door.yaml
                size: fullscreen

        - conditions: "{{ trigger_entity in state_attr('group.garage_sensors', 'entity_id') }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Back Door Camera"
                content: !include /config/ui/card/camera/security/side_door.yaml
                size: fullscreen
