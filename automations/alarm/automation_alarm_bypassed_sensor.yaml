#######################################################################################################################
## Alarm - Bypassed Sensor
#######################################################################################################################
- id: alarm_bypassed_sensor
  alias: "[Alarm] Bypassed Sensor"
  description: "Announcement, notification on alarm bypassed sensor."
  trigger:
    - platform: state
      entity_id: binary_sensor.alarm_bypassed_sensor_alert
      to: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.alarm_alerts
      state: 'on'
  action:
    - service: notify.mobile
      data:
        title: Alarm Error - Bypassed Sensors
        message: >
          Alarm armed with bypassed sensors.
          {%- set sensors = expand(state_attr('alarm_control_panel.master','bypassed_sensors'))|map(attribute='name')|list -%}
          {%- for item in sensors %}
              <br/>{{ item|replace('Virtual','') }}
          {%- endfor -%}
        data:
          tag: bypassed_sensor
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          persistant: true
          sticky: true
          clickAction: /lovelace/alarm
          color: !secret CRITICAL_COLOR
          icon_url: !secret ALARM_ERROR_ICON
          actions:
            - action: URI
              title: 'Alarm'
              uri: app://com.thanksmister.iot.mqtt.alarmpanel

    - wait_template: "{{ is_state('binary_sensor.alarm_bypassed_sensor_alert','off') }}"

    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: bypassed_sensor
