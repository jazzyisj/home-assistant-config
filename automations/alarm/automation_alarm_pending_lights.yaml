###############################################################################
# Alarm - Pending Lights
###############################################################################
- id: alarm_pending_lights
  alias: '[Alarm] Pending Lights'
  description: 'House alarm pending lighting.'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to: pending
  condition:
    - condition: state
      entity_id: binary_sensor.nighttime_illuminance_lights
      state: 'on'
  action:
    - service: scene.create
      data:
        scene_id: alarm_pending_lights_restore
        entities:
          light.side_entrance_light:
            state: "{{ states('light.side_entrance_light') }}"
            brightness: "{{ state_attr('light.side_entrance_light','brightness')|int(0) }}"
          light.kitchen_potlights:
            state: "{{ states('light.kitchen_potlights') }}"
            brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
          light.dining_room_potlights:
            state: "{{ states('light.dining_room_potlights') }}"
            brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"
          light.hallway_potlights:
            state: "{{ states('light.hallway_potlights') }}"

    - delay: 1 # wait for scene to save

    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.nighttime_illuminance_lights
              state: 'on'
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.side_entrance_light

            - service: light.turn_on
              target:
                entity_id: light.upstairs_potlights

            - wait_template: >
                {{ is_state('input_boolean.alarm_pending','off')
                    and is_state('input_boolean.alarm_triggered','off') }}
              timeout: 1800 # max time alarm is triggered
              continue_on_timeout: false

            - condition: "{{ states('input_select.occupancy_mode') in ['Home','Guest'] }}"

            - service: script.turn_on
              target:
                entity_id: script.activate_light_scene
              data:
                variables:
                  scene: alarm_pending_lights_restore
