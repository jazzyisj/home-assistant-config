###############################################################################
## Alarm - Arm Garage Alarm
###############################################################################
- id: alarm_arm_garage_alarm
  alias: '[Alarm] Arm Garage Alarm'
  description: 'Arm alarm garage zone.'
  max_exceeded: silent
  variables:
    mode: >
      {% if is_state('alarm_control_panel.master','disarmed') %} disarmed
      {% else %} {{ states('alarm_control_panel.master')|replace('armed_','') }}
      {% endif %}
  trigger:
    - platform: state
      id: disarmed
      entity_id: alert.garage_disarmed
      to: 'on'
      for:
        hours: 1

    - platform: state
      id: occupancy
      entity_id: binary_sensor.garage_occupied
      to: 'off'
      from: 'on'
      for:
        hours: 2

    - platform: state
      id: keypad
      entity_id: sensor.garage_door_lock_status
      to: #LOCK_USER
        - Locked (Keypad)
        - Locked (Jason)
        - Locked (Sheri)
        - Locked (Dawn)

    - platform: state
      id: manual
      entity_id: sensor.garage_door_lock_status
      to: Locked (Manual)
      for:
        minutes: 5 # allow occupant to leave garage, door close

    - platform: event
      id: mobile
      event_type: mobile_app_notification_action
      event_data:
        action: arm_garage_alarm
  condition:
    - condition: template
      alias: 'Alarm automation is enabled if not mobile action trigger'
      value_template: >
        {{ is_state('input_boolean.alarm_automation','on')
            if trigger.id != 'mobile' else true }}

    - condition: template
      alias: 'Lock automation is enabled if lock trigger'
      value_template: >
        {{ is_state('input_boolean.lock_automation','on')
            if trigger.id in ['keypad','manual'] else true }}

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
            if trigger.id == 'occupancy' else true }}

    - condition: state
      alias: 'Master alarm is armed.'
      entity_id: alarm_control_panel.master
      state:
        - armed_home
        - armed_night
        - armed_away
  action:
    - service: script.arm_alarm
      data:
        zone: garage
        mode: '{{ mode }}'
