###############################################################################
# Alarm - Triggered Lights
###############################################################################
- id: alarm_triggered_lights
  alias: '[Alarm] Triggered Lights'
  description: 'House alarm triggered lighting.'
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to: triggered
  condition:
    - condition: state
      entity_id: input_boolean.light_automation
      state: 'on'
  action:
    - service: scene.create
      data:
        scene_id: alarm_triggered_lights_restore
        entities: !include /config/include/all_lights_scene_entities.yaml

    - delay: 1 # wait for scene to save

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.adaptive_lighting_enabled
              state: 'on'
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.adaptive_lighting

    - service: script.turn_on
      entity_id: script.lights_on

    - wait_for_trigger:
        - platform: state
          entity_id: input_boolean.alarm_triggered
          to: 'off'

    - service: script.turn_on
      target:
        entity_id: script.activate_light_scene
      data:
        variables:
          scene: alarm_triggered_lights_restore

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.adaptive_lighting_enabled
              state: 'on'
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.adaptive_lighting

    - condition: state
      entity_id: input_select.occupancy_mode
      state: Night

    - condition: state
      entity_id: binary_sensor.nighttime_illuminance_lights
      state: 'on'

    - service: script.turn_on
      target:
        entity_id: script.activate_light_scene
      data:
        variables:
          scene: night_lights
