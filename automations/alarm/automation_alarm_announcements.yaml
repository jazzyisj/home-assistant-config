###############################################################################
# Alarm - Announcements
###############################################################################
- id: alarm_announcements
  alias: '[Alarm] Announcements'
  description: 'House alarm TTS announcements.'
  mode: queued
  variables:
    mode: "{{ state_attr('alarm_control_panel.master','arm_mode')|replace('armed_','') }}"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to:
        - armed_home
        - armed_night
        - armed_away
        - arming
        - pending
        - triggered

    - platform: state
      entity_id: alarm_control_panel.master
      to: disarmed
      from:
        - armed_home
        - armed_away
        - armed_night
        - triggered
  condition:
    - condition: state
      entity_id: input_boolean.alarm_announcements
      state: 'on'

    # don't duplicate occupancy mode announcement
    - "{{ is_state('input_boolean.occupancy_announcements','off') if trigger.to_state.state
      in ['disarmed','armed_home','armed_night','armed_away'] else true }}"

    # no announcement when temp disarm
    - "{{ is_state('input_boolean.alarm_temp_override','off') if trigger.to_state.state == 'disarmed' else true }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: arming
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.tts_play
              data:
                variables:
                  message: 'The alarm is now being armed in {{ mode }} mode.'
                  ignore_away: true

        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: pending
          sequence:
            - wait_template: "{{ not is_state('input_text.current_alarm','cleared') }}"
              timeout: 30 # wait for current alarm to popuplate
              continue_on_timeout: true # announcement won't have a trigger, but play something!

            - repeat:
                while: "{{ is_state('alarm_control_panel.master','pending') }}"
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: script.tts_play
                    data:
                      variables:
                        message: >
                          Warning! The alarm has been triggered by the {{ states('input_text.current_alarm') }}.
                          Disarm the system or the alarm will sound.
                        night_play: true
                        ignore_away: true
                        min_volume: "{{ 40 if is_state_attr(states('sensor.tts_media_player'),'type','group') else 50 }}"

                  - wait_template: "{{ not is_state('alarm_control_panel.master','pending') }}"
                    timeout: 30 # delay between announcements
                    continue_on_timeout: false # don't play if not pending

        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: triggered

            - condition: state
              entity_id: binary_sensor.tornado_alert # tts handled by weather alert
              state: 'off'
          sequence:
            - wait_template: "{{ not is_state('input_text.current_alarm','cleared') }}"
              timeout: 30 # wait for current alarm to popuplate

            - service: script.turn_on # first tts here before light scene
              target:
                entity_id: script.tts_play
              data:
                variables:
                  alert: true
                  message: "Attention!  Alarm! {{ states('input_text.current_alarm') }}"

            - delay: 30 # wait for disarmed before repeating announcememt

            - choose: # check if disarmed
                - conditions:
                    - condition: state
                      entity_id: alarm_control_panel.master
                      state: triggered
                  sequence:
                    - repeat:
                        sequence:
                          - service: script.turn_on
                            target:
                              entity_id: script.tts_play
                            data:
                              variables:
                                alert: true
                                message: |
                                  Attention! Alarm! {{ states('input_text.current_alarm') }}
                                  Your intrusion has been detected and confirmed.
                                  The owners have been notified and the police have now been called.

                          - wait_template: "{{ not is_state('alarm_control_panel.master','triggered') }}"
                            timeout: 60 # delay between announcements

                        until: "{{ not is_state('alarm_control_panel.master','triggered') }}"

        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state:
                - disarmed
                - armed_home
                - armed_night
                - armed_away

            - condition: state
              entity_id: input_boolean.alarm_temp_override
              state: 'off'

            # disable on auto disarm when open sensor
            - "{{ not is_state('alarm_control_panel.master','disarmed') if is_state('binary_sensor.alarm_open_sensor_alert','on') else true }}"
          sequence:
            - service: script.turn_on
              target:
                entity_id: script.tts_play
              data:
                variables:
                  message: >
                    {% if is_state('alarm_control_panel.master','disarmed') %} The house alarm has been disarmed.
                    {% else %} The house alarm is now armed in {{ mode }} mode.
                    {% endif %}
                  ignore_away: true
