###############################################################################
## Alarm - Code Error
###############################################################################
- id: alarm_code_error
  alias: '[Alarm] Code Error'
  description: 'Increment code error, send notification if threshold reached.'
  mode: queued
  trigger:
    - platform: event
      event_type: system_log_event
      event_data:
        level: warn
  condition:
    - condition: template
      value_template: "{{ 'custom_components.alarmo.alarm_control_panel' in trigger.event.data.name }}"

    - condition: template
      value_template: "{{ 'Wrong code provided' in trigger.event.data.message[0] }}"
  action:
    - service: counter.increment
      entity_id: counter.alarm_code_error_count

    - condition: numeric_state
      entity_id: counter.alarm_code_error_count
      above: 5

    - service: notify.jason
      data:
        title: 'Alarm Code Error'
        message: 'Alarm code errors exceeded'
        data:
          tag: alarm_code_error
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          notification_icon: mdi:shield-alert
          icon_url: !secret ALERT_ICON
          ledColor: !secret SEVERE_COLOR
          color: !secret SEVERE_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-mobile/alarm
          actions:
            - title: 'Reset'
              action: alarm_code_error_reset

            - title: 'Alarm'
              action: URI
              uri: app://com.thanksmister.iot.mqtt.alarmpanel

            - title: 'Cameras'
              action: URI
              uri: app://com.flir.consumer.flir.lorexcloud

###############################################################################
## Alarm - Code Error Reset
###############################################################################
- id: alarm_code_error_reset
  alias: '[Alarm] Code Error Reset'
  description: 'Reset alarm code error counter.'
  max_exceeded: silent
  trigger:
    - platform: time # resets at 4 am every day
      at: input_datetime.day_reset

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: alarm_code_error_reset
  action:
    - service: counter.reset
      entity_id: counter.alarm_code_error_count

    - service: browser_mod.toast
      data:
        message: 'Alarm error code counter has been reset.'
        duration: 30000
