###############################################################################
# Alarm - Popups
###############################################################################
- id: alarm_popups
  alias: "[Alarm] Popups"
  description: "Alarm browser popups."
  variables:
    trigger_entity: "{{ expand(state_attr('alarm_control_panel.master','open_sensors'))|map(attribute='entity_id')|join('') }}"
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to: triggered
  condition:
    - condition: state
      entity_id: binary_sensor.danger_alarm
      state: "off"

    - condition: state
      entity_id:
        - input_boolean.alarm_enabled
        - binary_sensor.someone_home
      state: "on"
  action:
    - choose:
        - conditions: "{{ trigger_entity in ['binary_sensor.kitchen_window','binary_sensor.family_room_window'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Front Drive Camera"
                content: !include /config/ui/card/camera/front_drive_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: >
            {{ trigger_entity in ['binary_sensor.garage_door_open','binary_sensor.side_door_lock_intrusion',
                'binary_sensor.side_door_lock_keypad_disabled','binary_sensor.side_door_open_alert'] }}
          sequence:
            - service: browser_mod.popup
              data:
                title: "Front Drive Camera"
                content: !include /config/ui/card/camera/front_drive_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: >
            {{ trigger_entity in ['binary_sensor.front_door_lock_intrusion','binary_sensor.front_door_lock_keypad_disabled',
                'binary_sensor.living_room_window_1','binary_sensor.living_room_window_2',
                'binary_sensor.living_room_window_3','binary_sensor.living_room_window_4','binary_sensor.front_door_open_alert'] }}
          sequence:
            - service: browser_mod.popup
              data:
                title: "Front Door Camera"
                content: !include /config/ui/card/camera/front_door_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: "{{ trigger_entity in ['binary_sensor.bedroom_front_window','binary_sensor.office_window'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Front Yard Camera"
                content: !include /config/ui/card/camera/front_yard_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: "{{ trigger_entity in ['binary_sensor.bedroom_side_window','binary_sensor.master_bedroom_window'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Side Gate Front Camera"
                content: !include /config/ui/card/camera/side_gate_front_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: "{{ trigger_entity in ['binary_sensor.laundry_room_window','binary_sensor.master_bathroom_window'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Side Gate Back Camera"
                content: !include /config/ui/card/camera/side_gate_back_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: >
            {{ trigger_entity in ['binary_sensor.back_door_lock_intrusion','binary_sensor.back_door_lock_keypad_disabled',
                'binary_sensor.back_door_open_alert'] }}
          sequence:
            - service: browser_mod.popup
              data:
                title: "Back Door Camera"
                content: !include /config/ui/card/camera/back_door_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: >
            {{ trigger_entity in ['binary_sensor.garage_door_lock_intrusion',
                'binary_sensor.garage_door_lock_keypad_disabled','binary_sensor.kitchen_sink_window'] }}
          sequence:
            - service: browser_mod.popup
              data:
                title: "Back House Camera"
                content: !include /config/ui/card/camera/back_house_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: "{{ trigger_entity in ['binary_sensor.patio_door'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Patio Door Camera"
                content: !include /config/ui/card/camera/patio_door_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

        - conditions: "{{ trigger_entity in ['binary_sensor.garage_sensor_motion','binary_sensor.garage_side_door_open_alert'] }}"
          sequence:
            - service: browser_mod.popup
              data:
                title: "Garage Inside Camera"
                content: !include /config/ui/card/camera/garage_inside_camera.yaml
                size: fullscreen
                browser_id: !include /config/include/browsers.yaml

    - wait_template: "{{ not is_state('alarm_control_panel.master','triggered') }}"

    - service: browser_mod.close_popup # close alarm panel and/or alarm triggered popups
      data:
        deviceID: !include /config/include/browsers.yaml
