###############################################################################
## Alarm - Doorbell
###############################################################################
- id: alarm_doorbell
  alias: "[Alarm] Doorbell"
  description: "Cast front porch camera, announcement."
  mode: queued
  trigger:
    - platform: state
      entity_id: input_button.doorbell #TEMP until doorbell wifi working
  condition: >
    {{ true if this.attributes.last_triggered == none
        else now() - this.attributes.last_triggered > timedelta(seconds=30) }}
  action:
    - service: script.turn_on
      target:
        entity_id: script.tts_play
      data:
        variables:
          message: "Some ugly fucker is ringing the doorbell!"
          media_player: media_player.kiosk
          quiet_play: true
      continue_on_error: true

    - service: script.turn_on
      target:
        entity_id: script.cast_camera
      data:
        variables:
          camera: front_door
      continue_on_error: true

    - variables:
        url: "{% from 'file.jinja' import snapshot_filename %}{{ snapshot_filename('alarm_snapshots', 'front_door') }}"

    - service: camera.snapshot
      target:
        entity_id: camera.front_door_frigate
      data:
        filename: "/config/www{{ url }}"

    - service: notify.jason
      data:
        message: Front Doorbell
        data:
          tag: doorbell_alert
          group: Alarm
          channel: Alert
          visibility: private
          notification_icon: mdi:doorbell
          icon_url: !secret DOORBELL_ICON
          image: "/local{{ url }}"
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ui-mobile/front-door-camera
          actions:
            - title: "Alarm"
              action: URI
              uri: !secret ALARM_URI

            - title: "Cameras"
              action: URI
              uri: !secret LOREX_URI

            - title: "Unlock"
              action: doorbell_unlock_door
