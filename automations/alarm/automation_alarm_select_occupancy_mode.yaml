###############################################################################
# Alarm - Select Occupancy Mode
###############################################################################
- id: alarm_select_occupancy_mode
  alias: "[Alarm] Select Occupancy Mode"
  description: "Select occupancy mode."
  mode: queued
  variables:
    arm_mode: "{{ states('alarm_control_panel.house') }}"
    occupancy_mode: "{{ states('input_select.occupancy_mode') }}"
    new_occupancy_mode: >
      {% from 'format.jinja' import occupancy_mode %}
      {{ occupancy_mode() }}
  trigger:
    - platform: state
      entity_id: alarm_control_panel.house
      to:
        - armed_home
        - armed_night
        - armed_away
        - armed_vacation

    - platform: state
      entity_id: alarm_control_panel.house
      to: disarmed
      from:
        - armed_home
        - armed_night
        - armed_away
        - armed_vacation
        - triggered
  condition:
    - condition: state
      entity_id:
        - input_boolean.alarm_enabled
        - input_boolean.alarm_auto_arming
      state: "on"

    - condition: template
      alias: "New occupancy mode not equal to current occupancy mode"
      value_template: "{{ occupancy_mode != new_occupancy_mode }}"
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.occupancy_mode
      data:
        option: "{{ new_occupancy_mode }}"
