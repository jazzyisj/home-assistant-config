###############################################################################
# Alarm - Lighting
###############################################################################
- id: alarm_lighting
  alias: '[Alarm] Lighting'
  description: 'House alarm lighting.'
  mode: queued # arming waiting -> triggered
  trigger:
    - platform: state
      entity_id: alarm_control_panel.master
      to:
        - arming
        - pending
        - triggered
  condition:
    - condition: state
      entity_id: input_boolean.light_automation
      state: 'on'
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: arming
          sequence:
            - service: scene.create
              data:
                scene_id: alarm_arming_lights_restore
                entities:
                  light.side_entrance_light:
                    state: "{{ states('light.side_entrance_light') }}"
                    brightness: "{{ state_attr('light.side_entrance_light','brightness')|int(0) }}"
                  light.kitchen_potlights:
                    state: "{{ states('light.kitchen_potlights') }}"
                    brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
                  light.dining_room_potlights:
                    state: "{{ states('light.dining_room_potlights') }}"
                    brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"

            - choose:
                - conditions: "{{ is_state('binary_sensor.nighttime_illuminance_lights','on') and is_state('binary_sensor.someone_home','on') }}"
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.side_entrance_light
                      data:
                        brightness: 255

                    - service: light.turn_on
                      target:
                        entity_id: light.kitchen_potlights
                      data:
                        brightness: >
                          {% set current = state_attr('light.kitchen_potlights','brightness')|int(0) %}
                          {{ 100 if current < 100 else current }}

                    - service: light.turn_on
                      target:
                        entity_id: light.dining_room_potlights
                      data:
                        brightness: >
                          {% set current = state_attr('light.dining_room_potlights','brightness')|int(0) %}
                          {{ 100 if current < 100 else current }}

                    - wait_template: >
                        {{ not is_state('alarm_control_panel.master','arming')
                            or is_state('alarm_control_panel.master','triggered') }}
                      timeout: "{{ state_attr('alarm_control_panel.master','delay')|int(0) }}"

                    - choose:
                        - conditions: "{{ not is_state('alarm_control_panel.master','triggered') }}"
                          sequence:
                            - delay: 30 # wait for occupancy mode to change before restoring lights

                            - condition: template
                              alias: 'House is still in Home,Guest'
                              value_template: "{{ states('input_select.occupancy_mode') in ['Home','Guest'] }}"

                            - service: script.turn_on
                              target:
                                entity_id: script.activate_scene
                              data:
                                variables:
                                  scene: alarm_arming_lights_restore

        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: pending
          sequence:
            - service: scene.create
              data:
                scene_id: alarm_pending_lights_restore
                entities:
                  light.side_entrance_light:
                    state: "{{ states('light.side_entrance_light') }}"
                    brightness: "{{ state_attr('light.side_entrance_light','brightness')|int(0) }}"
                  light.kitchen_potlights:
                    state: "{{ states('light.kitchen_potlights') }}"
                    brightness: "{{ state_attr('light.kitchen_potlights','brightness')|int(0) }}"
                  light.dining_room_potlights:
                    state: "{{ states('light.dining_room_potlights') }}"
                    brightness: "{{ state_attr('light.dining_room_potlights','brightness')|int(0) }}"
                  light.hallway_potlights:
                    state: "{{ states('light.hallway_potlights') }}"
                    brightness: "{{ state_attr('light.hallway_potlights','brightness')|int(0) }}"

            - delay: 5 # wait for scene to save

            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.nighttime_illuminance_lights
                      state: 'on'
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.side_entrance_light
                      data:
                        brightness: 255

                    - service: light.turn_on
                      target:
                        entity_id: light.kitchen_potlights
                      data:
                        brightness: >
                          {% set current = state_attr('light.kitchen_potlights','brightness')|int(0) %}
                          {{ 100 if current < 100 else current }}

                    - service: light.turn_on
                      target:
                        entity_id: light.dining_room_potlights
                      data:
                        brightness: >
                          {% set current = state_attr('light.dining_room_potlights','brightness')|int(0) %}
                          {{ 100 if current < 100 else current }}

                    - service: light.turn_on
                      target:
                        entity_id: light.hallway_potlights
                      data:
                        brightness: >
                          {% set current = state_attr('light.hallway_potlights','brightness')|int(0) %}
                          {{ 90 if current < 90 else current }}

        - conditions:
            - condition: state
              entity_id: alarm_control_panel.master
              state: triggered
          sequence:
            - service: scene.create
              data:
                scene_id: alarm_triggered_lights_restore
                entities: !include /config/include/all_lights_scene_entities.yaml

            - delay: 5 # wait for scene to save, allow tts etc to trigger before turning lights on

            - service: script.turn_on
              entity_id: script.lights_on

###############################################################################
## Alarm - Restore Lights
###############################################################################
- id: alarm_restore_lights
  alias: '[Alarm] Restore Lights'
  description: 'Restore pre alarm light conditions.'
  mode: queued
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_pending
      to: 'off'
      for: 15 # allow triggered light scene to restore first

    - platform: state
      entity_id: input_boolean.alarm_triggered
      to: 'off'
  condition:
    - condition: state
      entity_id: input_boolean.light_automation
      state: 'on'

    - condition: state
      entity_id: input_boolean.alarm_triggered
      state: 'off'
  action:
    - service: script.turn_on
      target:
        entity_id: script.activate_scene
      data:
        variables:
          scene: >
            {{ 'alarm_pending_lights_restore' if trigger.entity_id == 'input_boolean.alarm_pending'
                  else 'alarm_triggered_lights_restore' }}

    - condition: template
      alias: 'Alarm pending is off if alarm triggered is automation trigger'
      value_template: >
        {{ is_state('input_boolean.alarm_pending','off')
            if trigger.entity_id == 'input_boolean.alarm_triggered' else true }}

    - condition: template
      alias: 'Someone is home and night time auto light is on'
      value_template: "{{ is_state('binary_sensor.someone_home','on') and is_state('binary_sensor.nighttime_illuminance_lights','on') }}"

    - service: script.turn_on
      target:
        entity_id: script.activate_scene
      data:
        variables:
          scene: night_lights
