#######################################################################################################################
## Alarm - Auto Arm
#######################################################################################################################
- id: alarm_auto_arm #OCC
  alias: '[Alarm] Auto Arm'
  description: 'Auto arm alarm by occupancy mode.'
  mode: restart
  trigger:
    - platform: state
      id: disarmed
      entity_id: alarm_control_panel.master
      to: disarmed
      for: # wait to see if someone comes home (almost home, plug in dead phone)
        minutes: 5

    - platform: state
      id: away
      entity_id: input_select.occupancy_mode
      to:
        - Away
        - Vacation

    - platform: state
      id: night
      entity_id: input_select.occupancy_mode
      to: Night

    - platform: state
      id: lock_keypad
      entity_id: # do not auto arm with garage side door
        - sensor.back_door_lock_status
        - sensor.front_door_lock_status
        - sensor.side_door_lock_status
      to: #LOCK_USER
        - Locked (Keypad)
        - Locked (Jason)
        - Locked (Sheri)
        - Locked (Dawn)

    - platform: state
      id: manual
      entity_id:
        - sensor.back_door_lock_status
        - sensor.front_door_lock_status
        - sensor.side_door_lock_status
      to: Locked (Manual)

  condition:
    - condition: state
      entity_id:
        - input_boolean.alarm_automation
        - input_boolean.alarm_auto_arming
      state: 'on'

    - condition: state
      entity_id: input_boolean.alarm_temp_override
      state: 'off'

    - "{{ trigger.from_state.state not in ['unknown','unavailable','none'] if trigger.id == 'lock_keypad' else true }}"
    - "{{ is_state('input_boolean.lock_automation','on') if trigger.id in ['unlock_keypad','lock_keypad'] else true }}"
    - "{{ is_state('input_boolean.presence_automation','on') if trigger.id in ['away','night'] else true }}"
  action:
    - choose:
        - conditions: "{{ trigger.id == 'disarmed' }}"
          sequence:
            - choose:
                - conditions: # rearm alarm if still disarmed and nobody home
                    - condition: state
                      entity_id: binary_sensor.someone_home
                      state: 'off'
                  sequence:
                    - wait_template: "{{ is_state('binary_sensor.someone_home','on') }}"
                      timeout: # wait to see if presence override to turns on
                        minutes: 5

                    - condition: state
                      entity_id: alarm_control_panel.master
                      state: disarmed

                    - service: script.arm_alarm
                      data:
                        mode: away

                - conditions: # rearm alarm if in night mode
                    - condition: state
                      entity_id: input_select.occupancy_mode
                      state: Night
                  sequence:
                    - wait_template: "{{ not is_state('input_select.occupancy_mode','Night') }}"
                      timeout: # wait to see if Night mode is turned off
                        minutes: 5

                    - condition: state
                      entity_id: alarm_control_panel.master
                      state: disarmed

                    - service: script.arm_alarm
                      data:
                        mode: night
        - conditions:
            - "{{ trigger.id == 'manual' }}"

            - condition: state
              entity_id: alarm_control_panel.master
              state: disarmed
          sequence:
            - service: script.arm_alarm
              data:
                mode: "{{ 'night' if is_state('input_select.occupancy_mode','Night') else 'home' }}"

        - conditions:
            - "{{ trigger.id in ['lock_keypad','away'] }}"

            - condition: not
              alias: Alarm not already armed_away
              conditions:
                - condition: state
                  entity_id: alarm_control_panel.master
                  state:
                    - armed_away
                    - arming
          sequence:
            - choose: #LOCK_USER #NOTE if nobody else home, guest should use lock code to lock door or alarm won't alarm away
                - conditions: "{{ trigger.id == 'away' or trigger.to_state.state == 'Locked (Keypad)' }}"
                  sequence:
                    # arm alarm home right away to lock all doors
                    - service: script.arm_alarm
                      data:
                        mode: home

                    - delay: # wait to see if everyone leaves
                        minutes: 5

                    - condition: state
                      entity_id: binary_sensor.someone_home
                      state: 'off'

                    - service: script.arm_alarm
                      data:
                        mode: away

                - conditions: "{{ trigger.to_state.state == 'Locked (Jason)' }}"
                  sequence:
                    # arm alarm home right away to lock all doors
                    - service: script.arm_alarm
                      data:
                        mode: home
                        code: !secret ALARMO_JASON

                    - delay: # wait to see if everyone leaves
                        minutes: 5

                    - condition: state
                      entity_id: binary_sensor.someone_home
                      state: 'off'

                    - service: script.arm_alarm
                      data:
                        mode: away
                        code: !secret ALARMO_JASON

                - conditions: "{{ trigger.to_state.state == 'Locked (Sheri)' }}"
                  sequence:
                    # arm alarm home right away, lock all doors
                    - service: script.arm_alarm
                      data:
                        mode: home
                        code: !secret ALARMO_SHERI

                    - delay: # wait to see if everyone leaves
                        minutes: 5

                    - condition: state
                      entity_id: binary_sensor.someone_home
                      state: 'off'

                    - service: script.arm_alarm
                      data:
                        mode: away
                        code: !secret ALARMO_SHERI

                - conditions: "{{ trigger.to_state.state == 'Locked (Dawn)' }}"
                  sequence:
                    - service: script.arm_alarm
                      data:
                        mode: away
                        code: !secret ALARMO_DAWN

        - conditions:
            - "{{ trigger.id == 'night' }}"

            - condition: not
              alias: Alarm not already armed_night
              conditions:
                - condition: state
                  entity_id: alarm_control_panel.master
                  state:
                    - armed_night
                    - arming
          sequence:
            - service: script.arm_alarm
              data:
                mode: night
