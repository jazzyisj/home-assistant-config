###############################################################################
## Camera - Reload WebRTC
###############################################################################
- id: camera_reload_webrtc
  alias: "[Camera] Reload WebRTC"
  description: "Reload WebRTC integration."
  trigger:
    - platform: template
      value_template: >
        {{ states.camera|selectattr('attributes.frontend_stream_type','defined')
          |selectattr('attributes.frontend_stream_type','ne','web_rtc')|list|count > 0
          and is_state('input_boolean.startup_pending','off') }}
  action:
    - repeat:
        while: >
          {{ states.camera|selectattr('attributes.frontend_stream_type','defined')
            |selectattr('attributes.frontend_stream_type','ne','web_rtc')|list|count > 0 }}
        sequence:
          - service: system_log.write
            data:
              logger: "{{ this.entity_id }}"
              level: critical
              message: >
                WEB RTC RELOADED
                Cameras: {{ states.camera|selectattr('attributes.frontend_stream_type','defined')
                  |selectattr('attributes.frontend_stream_type','ne','web_rtc')|map(attribute='entity_id')|list }}

          - service: homeassistant.reload_config_entry
            data:
              entry_id: b93eebb7412c5208c93fbb7ea8208027

          - delay: 60 # throttle
