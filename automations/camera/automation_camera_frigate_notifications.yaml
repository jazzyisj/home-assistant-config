###############################################################################
## Camera - Person Detected Alert
###############################################################################
- id: camera_person_detected_alert
  alias: '[Camera] Person Detected Alert'
  description: 'Person detected notification.'
  max_exceeded: silent
  variables:
    camera: "{{ trigger.payload_json['after']['camera'] }}"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: state
      alias: 'Camera alerts are on'
      entity_id: input_boolean.camera_notifications
      state: 'on'

    - condition: template
      alias: 'Camera person alarm on'
      value_template: "{{ is_state('binary_sensor.' ~ camera ~ '_person_alarm','on') }}"

    - condition: template
      alias: 'Camera notification on for active alarm mode'
      value_template: >
        {% set mode = states('alarm_control_panel.master') %}
        {% if camera == 'front_door' %} {{ states not in ['disarmed'] }}
        {% elif camera == 'side_door' %} {{ states not in ['disarmed'] }}
        {% else %} false
        {% endif %}
  action:
    - service: notify.jason
      data:
        title: "{{ camera|replace('_',' ')|title }}"
        message: "A {{ trigger.payload_json['after']['label'] }} was detected."
        data:
          tag: "{{ trigger.payload_json['after']['id'] }}"
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          when: "{{ trigger.payload_json['after']['start_time']|int }}"
          notification_icon: mdi:cctv
          icon_url: !secret ALARM_ICON
          image: "{{ states('input_text.base_url') }}/api/frigate/notifications/{{ trigger.payload_json['after']['id'] }}/thumbnail.jpg?format=android"
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ccab4aaf_frigate/dashboard
          actions:
            - title: 'Alarm'
              action: URI
              uri: app://com.thanksmister.iot.mqtt.alarmpanel

            - title: 'Cameras'
              action: URI
              uri: app://com.flir.consumer.flir.lorexcloud

    - delay: 30
# {
#    "before":{
#       "id":"1646596399.857074-ajm0fh",
#       "camera":"side_door",
#       "frame_time":1646596399.857074,
#       "snapshot_time":0.0,
#       "label":"person",
#       "top_score":0.0,
#       "false_positive":true,
#       "start_time":1646596399.857074,
#       "end_time":"None",
#       "score":0.51171875,
#       "box":[
#          546,
#          143,
#          561,
#          197
#       ],
#       "area":810,
#       "region":[
#          0,
#          0,
#          784,
#          784
#       ],
#       "stationary":false,
#       "motionless_count":0,
#       "position_changes":0,
#       "current_zones":[

#       ],
#       "entered_zones":[

#       ],
#       "has_clip":false,
#       "has_snapshot":false
#    },
#    "after":{
#       "id":"1646596399.857074-ajm0fh",
#       "camera":"side_door",
#       "frame_time":1646596407.46747,
#       "snapshot_time":1646596407.46747,
#       "label":"person",
#       "top_score":0.705078125,
#       "false_positive":false,
#       "start_time":1646596399.857074,
#       "end_time":"None",
#       "score":0.76953125,
#       "box":[
#          182,
#          117,
#          261,
#          336
#       ],
#       "area":17301,
#       "region":[
#          21,
#          25,
#          441,
#          445
#       ],
#       "stationary":false,
#       "motionless_count":6,
#       "position_changes":1,
#       "current_zones":[

#       ],
#       "entered_zones":[

#       ],
#       "has_clip":false,
#       "has_snapshot":true
#    },
#    "type":"new"
# }
