###############################################################################
## Camera - Person Detected Alert
###############################################################################
- id: camera_person_detected_alert
  alias: '[Camera] Person Detected Alert'
  description: 'Person detected notification.'
  max_exceeded: silent
  variables:
    camera: "{{ trigger.payload_json['after']['camera']|replace('_',' ')|replace('frigate',' ') }}"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: state
      entity_id: input_boolean.camera_notifications
      state: 'on'
  action:
    - service: notify.jason
      data:
        title: '{{ camera|title }}'
        message: "A {{ trigger.payload_json['after']['label'] }} was detected."
        data:
          tag: "{{ trigger.payload_json['after']['id'] }}"
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          when: "{{ trigger.payload_json['after']['start_time']|int }}"
          notification_icon: mdi:cctv
          icon_url: !secret ALARM_ICON
          image: "{{ states('input_text.base_url') }}/api/frigate/notifications/{{ trigger.payload_json['after']['id'] }}/thumbnail.jpg?format=android"
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ccab4aaf_frigate/dashboard
          actions:
            - title: 'Alarm'
              action: URI
              uri: app://com.thanksmister.iot.mqtt.alarmpanel

            - title: 'Cameras'
              action: URI
              uri: app://com.flir.consumer.flir.lorexcloud

    - condition: template
      value_template: > #TEMP until rest of cams
        {% if is_state('binary_sensor.someone_home','on') %}
          {% if camera in ['front door','side door'] %}
            {{ states('alarm_control_panel.master') in ['arming','pending','armed_home','armed_night','armed_away'] }}
          {% else %} {{ states('alarm_control_panel.master') in ['arming','pending','armed_home','armed_night','armed_away'] }}
          {% endif %}
        {% else %} false
        {% endif %}

    - service: script.tts_play
      data:
        media_player: media_player.kiosk_media_player
        min_volume: 50
        quiet_play: true
        night_play: true
        tts_service: tts.cloud_say
        gender: male
        language: en-GB
        message: >
          {% if camera in ['front yard','back yard','garage inside'] %} {% set lvar = 'in' %}
          {% elif camera in ['side drive','front drive'] %} {% set lvar = 'on' %}
          {% else %} {% set lvar = 'at' %}
          {% endif %}
          There is a person {{ lvar }} the {{ camera }}!

    - delay: 30 # throttle

