###############################################################################
## Camera - Person Detected Alert
###############################################################################
- id: camera_person_detected_alert
  alias: '[Camera] Person Detected Alert'
  description: 'Person detected notification.'
  max_exceeded: silent
  variables:
    camera: "{{ trigger.payload_json['after']['camera']|replace('_',' ')|replace('frigate',' ') }}"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: state
      entity_id: input_boolean.camera_notifications
      state: 'on'
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.camera_person_tts_alerts
          state: 'on'
      then:
        - service: script.tts_play
          continue_on_error: true
          data:
            media_player: media_player.kiosk_media_player
            min_volume: 60
            quiet_play: true
            night_play: true
            tts_service: tts.cloud_say
            gender: male
            language: en-GB
            message: >
              {% if camera in ['front yard','back yard','garage inside'] %} {% set lvar = 'in' %}
              {% elif camera in ['side drive','front drive'] %} {% set lvar = 'on' %}
              {% else %} {% set lvar = 'at' %}
              {% endif %}
              There is a person {{ lvar }} the {{ camera }}!

        - service: script.turn_on
          continue_on_error: true
          target:
            entity_id: script.cast_front_door_camera

    - service: notify.jason
      data:
        title: '{{ camera|title }}'
        message: "A {{ trigger.payload_json['after']['label'] }} was detected."
        data:
          tag: "{{ trigger.payload_json['after']['id'] }}"
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          when: "{{ trigger.payload_json['after']['start_time']|int }}"
          notification_icon: mdi:cctv
          icon_url: !secret ALARM_ICON
          image: "{{ states('input_text.base_url') }}/api/frigate/notifications/{{ trigger.payload_json['after']['id'] }}/thumbnail.jpg?format=android"
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ccab4aaf_frigate/dashboard
          actions:
            - title: 'Alarm'
              action: URI
              uri: !secret ALARM_URI

            - title: 'Cameras'
              action: URI
              uri: !secret LOREX_URI

            - title: 'Alerts Off'
              action: turn_off_camera_alerts

    - delay: 60 # throttle

###############################################################################
## Camerea - Pause Camera Notifications
###############################################################################
- id: camera_pause_camera_notifications
  alias: '[Camerea] Pause Camera Notifications'
  description: 'Pause camera notifications.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_camera_alerts
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.camera_notifications

    - delay:
        hours: 4

    - service: input_boolean.turn_on
      entity_id: input_boolean.camera_notifications
