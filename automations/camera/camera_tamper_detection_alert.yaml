###############################################################################
## Camera - Tamper Detection Alert
###############################################################################
- id: camera_tamper_detection_alert
  alias: "[Camera] Tamper Detection Alert"
  description: "Camera tamper detection notification."
  mode: parallel
  variables:
    camera: "{{ trigger.entity_id[14:-24] }}"
  trigger:
    - platform: state
      entity_id:
        #ISSUE lorex tamper sensors turn on when cams switch to night mode/lights out
        - binary_sensor.side_drive_camera_tamper_detection
        - binary_sensor.side_door_camera_tamper_detection
        - binary_sensor.front_drive_camera_tamper_detection
        - binary_sensor.front_door_camera_tamper_detection
        - binary_sensor.front_yard_camera_tamper_detection
        - binary_sensor.side_gate_front_camera_tamper_detection
        - binary_sensor.side_gate_back_camera_tamper_detection
        - binary_sensor.back_yard_camera_tamper_detection
        - binary_sensor.back_door_camera_tamper_detection
        - binary_sensor.patio_door_camera_tamper_detection
        - binary_sensor.back_house_camera_tamper_detection
      to: "on"
      for: 15 # tamper sensors can cycle on/off when switching day/night mode
  condition:
    - condition: state
      entity_id:
        - input_boolean.camera_alerts
        - input_boolean.camera_tamper_detection
      state: "on"
  action:
    - variables:
        file: "alarm_snapshots/{% from 'file.jinja' import snapshot_filename %}{{ snapshot_filename(camera) }}"

    - service: camera.snapshot
      target:
        entity_id: "camera.{{ camera ~ '_frigate' }}"
      data:
        filename: "/config/www/{{ file }}"

    - service: notify.jason
      data:
        title: "Camera Tamper"
        message: "{{ state_attr(trigger.entity_id, 'friendly_name') | replace(' Tamper Detection', '') }}"
        data:
          tag: "camera_tamper{{ trigger.entity_id.split('.')[1] }}"
          group: Alarm
          channel: Alert
          visibility: private
          notification_icon: mdi:cctv
          icon_url: !secret ALERT_ICON
          image: "/local/{{ file }}"
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ui-mobile/alarm
          actions:
            - title: "Alarm"
              action: URI
              uri: !secret ALARM_URI

            - title: "Cameras"
              action: URI
              uri: !secret LOREX_URI

            - title: "Turn Off"
              action: turn_off_tamper_detection
