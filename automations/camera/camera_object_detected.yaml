###################################################################################################
## Camera Object Detected
###################################################################################################
- id: camera_object_detected
  alias: "Camera Object Detected"
  description: "Camera object detected notification."
  mode: queued
  trace:
    stored_traces: 30
  variables:
    id: "{{ trigger.payload_json['after']['id'] }}"
    camera: "{{ trigger.payload_json['after']['camera'] }}"
    object: "{{ trigger.payload_json['after']['label'] }}"
    stationary: "{{ trigger.payload_json['after']['stationary'] }}"
    start_time: "{{ trigger.payload_json['after']['start_time'] }}"
    new: "{{ trigger.payload_json['type'] == 'new' }}"
    entered_zones: "{{ trigger.payload_json['after']['entered_zones'] }}"
  triggers:
    - trigger: mqtt
      topic: frigate/events
  conditions:
    - condition: state
      entity_id: input_boolean.camera_object_detection
      state: "on"

    - alias: "Throttle notification unless front or side door"
      condition: template
      value_template: >
        {{ true if this.attributes.last_triggered == none or camera in ['front_door', 'side_door']
            else now() - this.attributes.last_triggered > timedelta(seconds=120) }}

    - alias: "Detected object is new"
      condition: template
      value_template: "{{ new }}"

    - alias: "Camera not excluded for notifications"
      condition: template
      value_template: "{{ camera not in ['front_yard', 'back_yard'] }}"

    - alias: "Detected object is a person or a car"
      condition: template
      value_template: "{{ object in ['person', 'car'] }}"

    - alias: "Detected object is moving"
      condition: template
      value_template: >
        {{ trigger.payload_json['after']['stationary'] == false
            and 0 <= trigger.payload_json['after']['motionless_count'] | int(-1) < 50
            and trigger.payload_json['after']['position_changes'] | int(-1) >=1 }}

    - alias: "If camera is front drive, object is a car and driveway is in entered zones or object is a person and near house is in entered zones"
      condition: template
      value_template: >
        {{ (object == 'car' and 'driveway' in entered_zones)
              or (object == 'person' and 'near_house' in entered_zones)
            if camera == 'front_driveway' else true }}

    - alias: "If camera is front door, object is a person and porch is in entered zones"
      condition: template
      value_template: >
        {{ object == 'person' and 'porch' in entered_zones
            if camera == 'front_door' else true }}

    - alias: "If camera is front yard, object is a person and near house is in entered zones"
      condition: template
      value_template: >
        {{ object == 'person' and 'near_house' in entered_zones
            if camera == 'front_yard' else true }}

    - alias: "Someone hasn't just arrived home"
      condition: state
      entity_id:
        - binary_sensor.someone_home
        - binary_sensor.guest_home
      attribute: just_arrived
      state: false

    - alias: "Someone isn't almost home"
      condition: template
      value_template: >
        {{ is_state('input_boolean.jason_almost_home', 'off')
            and now() - states.input_boolean.jason_almost_home.last_changed > timedelta(seconds=120) }}

    - alias: "Front/Side door was not just locked or unlocked"
      condition: template
      value_template: >
        {{ now() - states.sensor.side_door_lock_status.last_changed > timedelta(seconds=120)
            and now() - states.sensor.front_door_lock_status.last_changed > timedelta(seconds=120)
            and now() - states.sensor.back_door_lock_status.last_changed > timedelta(seconds=120) }}
  actions:
    - parallel:
        - sequence:
            - if:
                - condition: template
                  value_template: >
                    {{ is_state('input_boolean.camera_object_announcements', 'on')
                        and is_state('binary_sensor.someone_home', 'on')
                        and (is_state('binary_sensor.camera_event_announce_tod', 'on')
                          or camera in ['front_door', 'side_door']) }}
              then:
                # don't play tts message if we just played one, unless front door
                - if:

                  then:
                    - action: script.turn_on
                      target:
                        entity_id: script.tts_play
                      data:
                        variables:
                          provider: "Piper" #BUG tts.piper faster but gets cut off on cast speakers
                          min_volume: 60
                          quiet_play: true
                          save_message: false
                          #BUGFIX add Attention!, text so actual message isn't cut off
                          message: |
                            Attention!,
                            {%- if camera in ['front_door', 'side_door', 'back_door', 'patio_door', 'back_house',
                                'side_gate_front', 'side_gate_back'] %} {% set prep = 'at' %}
                            {% elif camera in ['side_driveway', 'front_driveway'] %} {% set prep = 'on' %}
                            {%- else %} {% set prep = 'in' %}
                            {%- endif %}
                            There is a {{ object }} {{ prep }} the {{ camera | replace('_', ' ') }}!
                      continue_on_error: true

                # - action: script.turn_on #DISABLED until kiosk navigation is resolved
                #   target:
                #     entity_id: script.kiosk_display_camera
                #   data:
                #     variables:
                #       camera: "{{ camera }}"
                #   continue_on_error: true

        - sequence:
            - if:
                - condition: state
                  entity_id: input_boolean.camera_object_notifications
                  state: "on"
              then:
                - action: notify.jason
                  data:
                    title: "{{ camera | replace('_', ' ') | title }} Camera"
                    message: "A {{ object }} was detected @ {{ start_time | timestamp_custom('%-I:%M %p') }}."
                    data:
                      tag: "{{ id }}"
                      group: Camera
                      channel: Camera
                      visibility: public
                      when: "{{ start_time }}"
                      notification_icon: mdi:cctv
                      icon_url: !secret CAMERA_ICON
                      image: "{{ states('input_text.base_url') }}/api/frigate/notifications/{{ id }}/thumbnail.jpg?format=android"
                      ledColor: !secret WARNING_COLOR
                      color: !secret WARNING_COLOR
                      vibrationPattern: !secret ALERT_VIBRATION
                      clickAction: "/ui-mobile/{{ camera | replace('_', '-') ~ '-camera' }}"
                      actions:
                        - title: "Pause"
                          action: pause_camera_object_notifications

                        - title: "Disable Cam"
                          action: disable_{{ camera }}_camera_events

                        - title: "Cameras"
                          action: URI
                          uri: !secret LOREX_URI
