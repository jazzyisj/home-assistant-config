###############################################################################
## Camera - Object Detected
###############################################################################
- id: camera_object_detected
  alias: "[Camera] Object Detected"
  description: "Object detected notification."
  mode: parallel
  trace:
    stored_traces: 50
  variables:
    id: "{{ trigger.payload_json['after']['id'] }}"
    object: "{{ trigger.payload_json['after']['label'] }}"
    camera: "{{ trigger.payload_json['after']['camera'][:-8] }}"
    start_time: "{{ trigger.payload_json['after']['start_time'] }}"
    new: "{{ trigger.payload_json['type'] == 'new' }}"
  trigger:
    - platform: mqtt
      topic: frigate/events
  condition:
    - condition: template
      value_template: "{{ new }}"

    - condition: state
      entity_id: input_boolean.camera_notifications
      state: "on"
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.camera_object_tts_notifications
          state: "on"
      then:
        - service: script.turn_on
          continue_on_error: true
          target:
            entity_id: script.tts_play
          data:
            variables:
              media_player: media_player.kiosk_internal
              min_volume: 60
              quiet_play: true
              night_play: true
              tts_service: tts.cloud_say
              gender: male
              language: en-GB
              message: >
                {% if camera in ['front_door','side_door'] %}
                  There is a {{ object }} at the {{ camera|replace('_',' ') }}!
                {% elif camera in ['front_drive'] %}
                  There is a {{ object }} on the {{ camera|replace('_',' ') }}!
                {% elif camera == 'garage_inside' %}
                  There is a {{ object }} inside the garage!
                {% else %}
                  An object was detected!
                {% endif %}

    - service: notify.jason
      data:
        title: "{{ camera|replace('_',' ')|title }} Camera"
        message: "A {{ object }} was detected @ {{ start_time|timestamp_custom('%-I:%M %p') }}."
        data:
          tag: "{{ id }}"
          group: Alarm
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          visibility: public
          when: "{{ start_time }}"
          notification_icon: mdi:cctv
          icon_url: !secret ALARM_ICON
          image: "{{ states('input_text.base_url') }}/api/frigate/notifications/{{ id }}/thumbnail.jpg?format=android"
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ccab4aaf_frigate-fa/dashboard
          actions:
            - title: "Alarm"
              action: URI
              uri: !secret ALARM_URI

            - title: "Cameras"
              action: URI
              uri: !secret LOREX_URI

            - title: "Alerts Off"
              action: turn_off_camera_alerts

    - service: script.cast_camera
      continue_on_error: true
      data:
        camera: "{{ camera }}"
