###############################################################################
## Presence - Charlie Home Alone On
###############################################################################
- id: presence_charlie_home_alone_on
  alias: "[Presence] Charlie Home Alone On"
  description: "Charlie home alone, music, lights."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: Away
      for:
        minutes: 5

    - platform: state
      entity_id: input_boolean.charlie_home_alone
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.charlie_home_alone
      state: "on"
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.nighttime_illuminance_lights
          state: "on"

        - condition: state
          entity_id: input_select.occupancy_mode
          state: Away
      then:
        - service: script.turn_light_on
          data:
            lights: light.dining_room_light_rgb

    - if:
        - condition: state
          entity_id: input_boolean.media_preset_enabled_charlie
          state: "on"

        - condition: state
          entity_id: binary_sensor.night_time
          state: "off"
      then:
        #DISABLED play video instead
        # - service: script.media_play
        #   data:
        #     preset: charlie

        - service: media_player.play_media #IDEA add video to presets
          target:
            entity_id: media_player.living_room_chromecast
          data:
            media_content_type: cast
            media_content_id: '
              {
              "app_name": "youtube",
              "media_id": "CVdkGFNCXAA"
              }'
            enqueue: replace
            extra:
              autoplay: true

###############################################################################
## Presence - Charlie Home Alone Off
###############################################################################
- id: presence_charlie_home_alone_off
  alias: "[Presence] Charlie Home Alone Off"
  description: "Turn off Charlie scene."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.charlie_home_alone
      to: "off"
  action:
    - if:
        - condition: template
          value_template: >
            {{ is_state('input_boolean.media_preset_enabled_charlie','on')
                and is_state_attr('media_player.living_room_chromecast','media_content_id','CVdkGFNCXAA')
                and is_state_attr('media_player.living_room_tv','source','HDMI 2') }}
      then:
        - service: media_player.turn_off
          target:
            entity_id: media_player.living_room_chromecast

    # - if:
    #     - condition: state
    #       entity_id: input_boolean.media_preset_enabled_charlie
    #       state: "on"
    #   then:
    #     - service: media_player.turn_off
    #       target: >
    #         {{ expand('group.media_players')
    #             | selectattr('name','eq',states('select.media_preset_speaker_charlie'))
    #             | map(attribute='entity_id') | list }}

###############################################################################
## Presence - Turn Off Charlie Home Alone
###############################################################################
- id: presence_turn_off_charlie_home_alone
  alias: "[Presence] Turn Off Charlie Home Alone"
  description: "Turn off Charlie home alone boolean."
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Night
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.charlie_home_alone
