#######################################################################################################################
## Presence - Someone Heading Home
#######################################################################################################################
- id: presence_someone_heading_home
  alias: "[Presence] Someone Heading Home"
  description: "Preheat/cool house, location updates when someone heading home."
  mode: parallel
  max: 5
  trigger:
    - platform: numeric_state
      entity_id:
        - proximity.jphone_home
        - proximity.sphone_home
      below: 4 # km
  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: "on"

    - condition: template
      value_template: "{{ state_attr(trigger.entity_id,'dir_of_travel') == 'towards' }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id:
                - input_boolean.presence_automation
                - input_boolean.climate_automation
              state: "on"

            - condition: state
              entity_id: binary_sensor.someone_home
              state: "off"
          sequence:
            - service: input_boolean.turn_on
              entity_id: input_boolean.hvac_presence_override

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.presence_alerts
              state: "on"
          sequence:
            - service: >
                {% if trigger.entity_id == 'proximity.jphone_home' %} notify.sheri
                {% elif trigger.entity_id == 'proximity.sphone_home' %} notify.jason
                {% endif %}
              data:
                title: >
                  {% if trigger.entity_id == 'proximity.jphone_home' %} Jason Heading Home
                  {% elif trigger.entity_id == 'proximity.sphone_home' %} Sheri Heading Home
                  {% endif %}
                message: >
                  {% if trigger.entity_id == 'proximity.jphone_home' %} Get a beer ready for him!
                  {% elif trigger.entity_id == 'proximity.sphone_home' %} Hide the hookers and cocaine!
                  {% endif %}
                data:
                  tag: >
                    {% if trigger.entity_id == 'proximity.jphone_home' %} jason_heading_home
                    {% elif trigger.entity_id == 'proximity.sphone_home' %} sheri_heading_home
                    {% endif %}
                  group: General
                  channel: General
                  importance: max
                  ttl: 0
                  priority: high
                  timeout: 600
                  clickAction: /lovelace/presence
                  color: !secret NOTIFY_COLOR
                  icon_url: !secret HASSIO_ICON
