###############################################################################
## Presence - Someone Heading Home
###############################################################################
- id: presence_someone_heading_home
  alias: "[Presence] Someone Heading Home"
  description: "Preheat/cool house, location updates when someone heading home."
  mode: parallel
  max: 5
  trigger:
    #TODO WARNING (MainThread) [homeassistant.components.homeassistant.triggers.numeric_state] Error initializing '[Presence] Someone Heading Home' trigger: In 'numeric_state' condition: entity proximity.jphone_home state 'not set' cannot be processed as a number
    - platform: numeric_state
      entity_id:
        - proximity.jphone_home
        - proximity.sphone_home
      below: 4 # km
  condition: "{{ state_attr(trigger.entity_id,'dir_of_travel') == 'towards' }}"
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.someone_home
          state: "off"
      then:
        - service: input_boolean.turn_on
          entity_id: input_boolean.hvac_presence_override

    - if:
        - condition: state
          entity_id: input_boolean.presence_alerts
          state: "on"
      then:
        - service: >
            {% if trigger.entity_id == 'proximity.jphone_home' %} notify.jason
            {% elif trigger.entity_id == 'proximity.sphone_home' %} notify.jason
            {% endif %}
          data:
            title: >
              {% if trigger.entity_id == 'proximity.jphone_home' %} Jason Heading Home
              {% elif trigger.entity_id == 'proximity.sphone_home' %} Sheri Heading Home
              {% endif %}
            message: >
              {% if trigger.entity_id == 'proximity.jphone_home' %} Get a beer ready for him!
              {% elif trigger.entity_id == 'proximity.sphone_home' %} Hide the hookers and cocaine!
              {% endif %}
            data:
              tag: >
                {% if trigger.entity_id == 'proximity.jphone_home' %} jason_heading_home
                {% elif trigger.entity_id == 'proximity.sphone_home' %} sheri_heading_home
                {% endif %}
              group: General
              channel: General
              importance: max
              ttl: 0
              priority: high
              visibility: public
              timeout: 600
              notification_icon: "{{ states.script.arriving_home_notification.attributes.icon }}"
              icon_url: !secret ARRIVE_HOME_ICON
              ledColor: !secret NOTIFY_COLOR
              color: !secret NOTIFY_COLOR
              vibrationPattern: !secret GENERAL_VIBRATION
              clickAction: /lovelace/presence
