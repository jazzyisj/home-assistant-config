#######################################################################################################################
## Presence - Someone Heading Home
#######################################################################################################################
- id: presence_someone_heading_home
  alias: "[Presence] Someone Heading Home"
  description: Preheat/cool house, location updates when someone heading home.
  initial_state: true
  mode: parallel
  max: 5
  trigger:
    - platform: numeric_state
      entity_id:
        - proximity.jhome
        - proximity.shome
      below: 4 # km

  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

    - condition: template
      value_template: "{{ state_attr(trigger.entity_id,'dir_of_travel') == 'towards' }}"

  action:
    - choose:
        - conditions:
            - condition: state
              entity_id:
                - input_boolean.presence_automation
                - input_boolean.climate_automation
              state: 'on'

            - condition: state
              entity_id: binary_sensor.someone_home
              state: 'off'

          sequence:
            # occupancy mode to override so HVAC turns off eco mode
            - service: input_select.select_option
              data:
                entity_id: input_select.occupancy_mode
                option: Override

    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.alerts_enabled
              state: 'on' 

          sequence:
            - service: notify.mobile_app_jphone
              data:
                title: >
                  {% if trigger.entity_id == 'proximity.jhome' %} Jason Heading Home
                  {% elif trigger.entity_id == 'proximity.shome' %} Sheri Heading Home
                  {% endif %}
                message: >
                  {% if trigger.entity_id == 'proximity.jhome' %} Get a beer ready for him!
                  {% elif trigger.entity_id == 'proximity.shome' %} Hide the hookers and cocaine!
                  {% endif %}
                data:
                  tag: someone_heading_home
                  group: General
                  channel: General
                  importance: max
                  timeout: 600
                  clickAction: /lovelace/presence
                  color: !secret NOTIFY_COLOR
                  icon_url: !secret HASSIO_ICON

    # request location updates every 60 seconds until home, max 10 times (5 min)
    # this is to help trigger almost_home notifications
    - repeat:
        while:
          - condition: template
            value_template: >
                {% if repeat.index > 10 %} false
                {% elif trigger.entity_id == 'proximity.jhome' %} {{ is_state('binary_sensor.jason_home','off') }}
                {% elif trigger.entity_id == 'proximity.shome' %} {{ is_state('binary_sensor.sheri_home','off') }}
                {% endif %}

        sequence:
          - service: >
                {% if trigger.entity_id == 'proximity.jhome' %} notify.mobile_app_jphone
                {% elif trigger.entity_id == 'proximity.shome' %} notify.mobile_app_sphone
                {% endif %}
            data:
              message: request_location_update

          - delay:
              seconds: 60

#######################################################################################################################
## Presence - Close Someone Heading Home Notifications
#######################################################################################################################
- id: presence_close_someone_heading_home_notifications
  alias: "[Presence] Close Someone Heading Home Notifications"
  description: Dismiss notification on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: someone_heading_home

  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

  action:
    - service: script.close_notifications
      data:
        target: mobile
        tag: someone_heading_home

    - delay:
        seconds: 180 # prevent recursive triggers