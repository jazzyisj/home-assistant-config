###############################################################################
## Presence - Jason Heading Home
###############################################################################
- id: presence_jason_heading_home
  alias: "[Presence] Jason Heading Home"
  description: "Turn on HVAC override, send notification."
  mode: parallel
  trigger:
    # doesn't work if zone is passive
    - platform: template
      id: jason
      value_template: >
        {{ ('person.jason' in state_attr('zone.near_home', 'persons')
                or 'person.jason' in state_attr('zone.almost_home', 'persons'))
              and is_state('sensor.home_jason_direction_of_travel', 'towards') }}
      for: 60

    - platform: state
      id: home
      entity_id: binary_sensor.jason_home
      to: "on"
      not_from:
        - unknown
        - unavailable
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.someone_home
          state: "off"
      then:
        - service: input_boolean.turn_on
          entity_id: input_boolean.hvac_presence_override

    - condition: state
      entity_id: input_boolean.presence_alerts
      state: "on"

    - if:
        - condition: trigger
          id: home
      then:
        - service: notify.jason
          data:
            message: clear_notification
            data:
              tag: jason_heading_home"
      else:
        - service: notify.jason
          data:
            message: "Jason is heading home. Get a beer ready for him!"
            data:
              tag: jason_heading_home
              group: Presence
              timeout: 600
              notification_icon: mdi:home-account
              icon_url: !secret ARRIVE_HOME_ICON
              clickAction: /ui-mobile/presence
