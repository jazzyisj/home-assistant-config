###################################################################################################
## Presense Override
###################################################################################################
- id: presense_override
  alias: "Presense Override"
  description: "Override person presence."
  mode: parallel
  variables:
    person: >
      {% from 'presence.jinja' import trigger_person %}
      {{ trigger_person(trigger) }}
  triggers:
    - trigger: state
      id: phone
      entity_id: binary_sensor.jason_phone_connected
      to: "off"
      from: "on"

    - trigger: state
      id: unlocked
      entity_id:
        - sensor.side_door_lock_status
        - sensor.front_door_lock_status
        - sensor.back_door_lock_status
        - sensor.garage_side_door_lock_status
      to:
        - Unlocked (Jason)
        - Unlocked (Guest)
      not_from:
        - unknown
        - unavailable

    - trigger: state
      id: locked
      entity_id:
        - sensor.side_door_lock_status
        - sensor.front_door_lock_status
        - sensor.back_door_lock_status
      to:
        - Locked (Jason)
        - Locked (Guest)
      not_from:
        - unknown
        - unavailable

    - trigger: event
      id: guest_alert
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off
  conditions:
    - condition: state
      entity_id: input_boolean.occupancy_automation
      state: "on"

    - "{{ is_state('person.' ~ person, 'home') if trigger.id == 'phone' else true }}"
  actions:
    - if: "{{ trigger.id in ['phone', 'unlocked'] }}"
      then:
        - action: script.presence_override
          data:
            people: "{{ person }}"
            home: turn_on
      else:
        - action: script.presence_override
          data:
            people: "{{ person }}"
            home: turn_off

        - if: "{{ trigger.id == 'guest_alert' }}"
          then:
            - action: notify.jason
              data:
                message: clear_notification
                data:
                  tag: guest_alert

###################################################################################################
## Reset Presence Override
###################################################################################################
- id: reset_presence_override
  alias: "Reset Presence Override"
  description: "Reset override boolean when tracker state to/from home."
  mode: parallel
  variables:
    person: >
      {% from 'presence.jinja' import trigger_person %}
      {{ trigger_person(trigger) }}
  triggers:
    - trigger: state
      id: home
      entity_id: person.jason
      to: home
      for: 300 # in case lock code triggered override

    - trigger: state
      id: away
      entity_id: person.jason
      from: home
      not_to:
        - unknown
        - unavailable
      for: 60

    - trigger: event
      id: action
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_presence_override_jason

    - trigger: state
      id: sensor
      entity_id: binary_sensor.jason_phone_connected
      to: "on"
      from: "off"
  conditions:
    - condition: state
      entity_id: input_boolean.occupancy_automation
      state: "on"

    - "{{ is_state('input_boolean.home_override_' ~ person, 'on') }}"
    - "{{ is_state('binary_sensor.' ~ person ~ '_phone_connected', 'on') }}"
  actions:
    - action: input_boolean.turn_off
      target:
        entity_id: "input_boolean.home_override_{{ person }}"

###################################################################################################
## Jason Override Alert
###################################################################################################
- id: jason_override_alert
  alias: "Jason Override Alert"
  description: "Play notification when presence override boolean turns on."
  max_exceeded: silent
  triggers:
    - trigger: state
      entity_id:
        - input_boolean.home_override_jason
        - binary_sensor.jason_home
      to: "on"
      not_from:
        - unknown
        - unavailable
      for:
        minutes: 15 # allow override to turn off before notifications

    - trigger: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Guest
      for:
        minutes: 15 # allow override to turn off before notifications
  conditions:
    - condition: state
      entity_id: input_boolean.home_override_jason
      state: "on"
  actions:
    - action: script.tts_play
      data:
        message: "Attention! Jason's presence override is on."
        ignore_away: true
        quiet_play: true
