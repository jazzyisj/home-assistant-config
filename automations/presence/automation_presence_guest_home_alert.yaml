#######################################################################################################################
## Presence - Guest Home Alert
#######################################################################################################################
- id: presence_guest_home_alert
  alias: "[Presence] Guest Home Alert"
  description: Sent notification when guest still home and Jason/Sheri are gone.
  initial_state: true
  mode: restart
  max: 5
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: 'off'

  condition:
    - condition: state
      entity_id: binary_sensor.owner_home
      state: 'off'

    - condition: state
      entity_id: input_boolean.guest_home
      state: 'on'

  action:
    - service: notify.mobile
      data:
        title: Guest At Home
        message: Guest at home and Jason and Sheri have left the building!
        data:
          tag: guest_alert
          group: General
          channel: General
          importance: max
          clickAction: /lovelace/presence
          color: !secret NOTIFY_COLOR
          icon_url: !secret GUEST_ICON
          actions:
            - title: Turn Guest Off
              action: guest_off

#######################################################################################################################
## Presence - Presence Override Alert
#######################################################################################################################
- id: presence_guest_mode_off
  alias: "[Presence] Guest Mode Off"
  description: Turn guest mode boolean off when notification action button clicked.
  initial_state: true
  mode: single
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off

  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.guest_home

#######################################################################################################################
## Presence - Close Guest Alert Notifications
#######################################################################################################################
- id: presence_close_guest_alert_notifications
  alias: "[Presence] Close Guest Alert Notifications"
  description: Dismiss notifications on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: guest_alert

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: guest_alert

    - delay:
        seconds: 180 # prevent recursive triggers