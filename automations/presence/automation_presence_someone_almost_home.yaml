#######################################################################################################################
## Presence - Someone Almost Home
#######################################################################################################################
- id: presence_someone_almost_home
  alias: '[Presence] Someone Almost Home'
  description: 'Send notification to disarm alarm when someone almost home.'
  initial_state: true
  mode: parallel
  max: 5
  variables:
    person: >
      {% if trigger.entity_id in ['person.jason','input_boolean.jason_almost_home'] %} jason
      {% elif trigger.entity_id in ['person.sheri','input_boolean.sheri_almost_home'] %} sheri
      {% endif %}
  trigger:
    - platform: zone
      entity_id:
        - person.jason
        - person.sheri
      zone: zone.almost_home
      event: enter

    - platform: state
      entity_id:
        - input_boolean.jason_almost_home
        - input_boolean.sheri_almost_home
      to: 'on'
  action:
    - choose:
        - conditions: "{{ is_state('binary_sensor.' ~ person ~ '_home','on') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: 'input_boolean.{{ person }}_almost_home'
      default:
        - service: automation.turn_off
          target:
            entity_id: '{{ this.entity_id }}'
          data:
            stop_actions: false

        - service: input_boolean.turn_on
          target:
            entity_id: 'input_boolean.{{ person }}_almost_home'

        - service: automation.turn_on
          target:
            entity_id: '{{ this.entity_id }}'

        - service: script.arriving_home_notification
          data:
            person: '{{ person }}'
