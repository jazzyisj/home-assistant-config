###############################################################################
## Presence - Turn Guest Home Off
###############################################################################
- id: presence_turn_guest_home_off
  alias: '[Presence] Turn Guest Home Off'
  description: 'Turn guest home boolean off, clear notification.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.guest_home
      to: 'off'
      from: 'on'

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.guest_home

    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: guest_alert

###############################################################################
## Presence - Guest Home Alert
###############################################################################
- id: presence_guest_home_alert
  alias: '[Presence] Guest Home Alert'
  description: 'Sent notification if guest home when owners leave.'
  mode: restart
  max: 5
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: 'off'
      from: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.owner_home
      state: 'off'

    - condition: state
      entity_id: input_boolean.guest_home
      state: 'on'
  action:
    - service: notify.mobile
      data:
        title: 'Guest Home'
        message: |
          Mode: {{ states('input_select.occupancy_mode') }}
          Alarm: {{ states('sensor.alarm_status') }}
        data:
          tag: guest_alert
          group: General
          channel: General
          importance: max
          ttl: 0
          priority: high
          notification_icon: '{{ states.input_boolean.guest_home.attributes.icon }}'
          icon_url: !secret GUEST_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: /lovelace-mobile/presence
          actions:
            - title: 'Home'
              action: set_home_mode

            - title: 'Away'
              action: set_away_mode

            - title: 'Alarm'
              action: URI
              uri: app://com.thanksmister.iot.mqtt.alarmpanel
