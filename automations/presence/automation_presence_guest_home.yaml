#######################################################################################################################
## Presence - Turn Guest Home Off
#######################################################################################################################
- id: presence_turn_guest_home_off
  alias: "[Presence] Turn Guest Home Off"
  description: "Turn guest home boolean off, clear notification."
  initial_state: true
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.guest_home
      to: 'off'

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: guest_off
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.guest_home

    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: guest_alert

#######################################################################################################################
## Presence - Guest Home Alert
#######################################################################################################################
- id: presence_guest_home_alert
  alias: "[Presence] Guest Home Alert"
  description: "Sent notification if guest home when owners leave."
  initial_state: true
  mode: restart
  max: 5
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: 'off'
  condition:
    - condition: state
      entity_id: binary_sensor.owner_home
      state: 'off'

    - condition: state
      entity_id: input_boolean.guest_home
      state: 'on'
  action:
    - service: notify.mobile
      data:
        title: "Guest At Home"
        message: "A guest is at home and Jason and Sheri have left the building!"
        data:
          tag: guest_alert
          group: General
          channel: General
          importance: max
          ttl: 0
          priority: high
          clickAction: /lovelace/presence
          color: !secret NOTIFY_COLOR
          icon_url: !secret GUEST_ICON
          actions:
            - title: "Turn Guest Off"
              action: guest_off
