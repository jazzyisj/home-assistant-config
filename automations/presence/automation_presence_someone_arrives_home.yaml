###############################################################################
## Presence - Someone Arrives Home - use script so we can turn off if person leaves again
###############################################################################
- id: presence_someone_arrives_home
  alias: "[Presence] Someone Arrives Home"
  description: "Determine who arrived home and run arrive home script."
  mode: parallel
  variables:
    people: "{{ ['jason','sheri'] }}"
    person: "{{ trigger.entity_id.split('.')[1]|replace('_home','') }}"
    first_home: >
      {% set home = namespace(val=false) %}
      {% for item in people %}
        {% if item != person %}
          {% if is_state('binary_sensor.' ~ item ~ '_home','on') %}
            {% set home.val = true %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {{ (person == 'guest' and is_state('binary_sensor.owner_home','off'))
          or (not home.val and is_state('input_boolean.guest_home','off')) }}
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: "on"
      not_from:
        - unknown
        - unavailable

    - platform: state
      entity_id: input_boolean.guest_home
      to: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.someone_arrives_home
      data:
        variables:
          person: "{{ person }}"
          first_home: "{{ first_home }}"

    - service: script.turn_on
      target:
        entity_id: script.arrive_home_lights
      data:
        variables:
          first_home: "{{ first_home }}"
