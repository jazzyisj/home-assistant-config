###############################################################################
## Presence - Auto Override Home
###############################################################################
- id: presence_auto_override_home
  alias: '[Presence] Auto Override Home'
  description: 'Toggle override boolean when required if door unlocked by code.'
  mode: parallel
  variables:
    person: '{{ trigger.to_state.state[10:-1]|lower }}'
  trigger:
    - platform: state
      entity_id:
        - sensor.side_door_lock_status
        - sensor.front_door_lock_status
        - sensor.back_door_lock_status
        - sensor.garage_door_lock_status # use garage for override on
      to: #LOCK_USER
        - Unlocked (Jason)
        - Unlocked (Sheri)
      from:
        - Locked (Jason)
        - Locked (Sheri)
  condition:
    - condition: state
      entity_id:
        - input_boolean.lock_automation
        - input_boolean.presence_automation
      state: 'on'
  action:
    - choose:
        - conditions: >
            {{ is_state('person.' ~ person ,'home')
                and is_state('binary_sensor.' ~ person ~ '_phone_connected','on') }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: 'input_boolean.home_override_{{ person }}'
      default:
        - service: input_boolean.turn_on
          target:
            entity_id: 'input_boolean.home_override_{{ person }}'

        - service: input_boolean.turn_on
          target:
            entity_id: 'input_boolean.{{ person }}_home'

###############################################################################
## Presence - Override Auto On Away
###############################################################################
- id: presence_auto_override_away
  alias: '[Presence] Auto Override Away'
  description: 'Turn override on, presence bool off when door locked by code.'
  mode: parallel
  variables:
    person: '{{ trigger.to_state.state[8:-1]|lower }}'
  trigger:
    - platform: state
      entity_id:
        - sensor.side_door_lock_status
        - sensor.front_door_lock_status
        - sensor.back_door_lock_status
      to: #LOCK_USER
        - Locked (Jason)
        - Locked (Sheri)
      for:
        minutes: 2
  condition:
    - condition: state
      entity_id:
        - input_boolean.lock_automation
        - input_boolean.presence_automation
      state: 'on'
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: 'input_boolean.home_override_{{ person }}'

    - service: input_boolean.turn_off
      target:
        entity_id: 'input_boolean.{{ person }}_home'

###############################################################################
## Presence - Reset Override
###############################################################################
- id: presence_reset_override
  alias: '[Presence] Reset Override'
  description: 'Reset override boolean when tracker state to/from home.'
  mode: parallel
  variables:
    person: >
      {% if trigger.id == 'action' %}
        {{ trigger.event.data['action'][27:] }}
      {% else %}
        {{ trigger.entity_id.split('.')[1] }}
      {% endif %}
  trigger:
    - platform: state
      entity_id:
        - person.jason
        - person.sheri
      to: home
      for: 30

    - platform: state
      entity_id:
        - person.jason
        - person.sheri
      from: home
      for: 30

    - platform: event
      id: action
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_presence_override_jason

    - platform: event
      id: action
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_presence_override_sheri
  condition:
    - condition: state
      entity_id: input_boolean.presence_automation
      state: 'on'

    - "{{ is_state('input_boolean.home_override_' ~ person,'on') }}"

    - "{{ is_state('binary_sensor.' ~ person ~ '_phone_connected','on') }}"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: 'input_boolean.home_override_{{ person }}'

###############################################################################
## Presence - Override Alert
###############################################################################
- id: presence_override_alert
  alias: '[Presence] Override Alert'
  description: 'Play notification when presence override boolean turns on.'
  mode: parallel
  trigger:
    - platform: state
      entity_id:
        - input_boolean.home_override_jason
        - input_boolean.home_override_sheri
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
      to: 'on'
      for:
        minutes: 5 # allow override to turn off before notifications

    - platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Guest
      for:
        minutes: 10 # allow override to turn off before notifications
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.home_override_jason
          state: 'on'

        - condition: state
          entity_id: input_boolean.home_override_sheri
          state: 'on'

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
              and is_state('input_boolean.occupancy_override','off')
            if trigger.id == 'occupancy' else true }}
  action:
    - service: script.tts_play
      data:
        message: |
          Attention!
          {% if is_state('input_boolean.home_override_jason','on') %}
              Jason's presence override is {{ states('input_boolean.home_override_jason') }}.
          {% endif %}
          {% if is_state('input_boolean.home_override_sheri','on') %}
              Sheri's presence override is {{ states('input_boolean.home_override_sheri') }}.
          {% endif %}
        ignore_away: true
        night_play: true
        save_message: true

###############################################################################
## Presence - Pause Presence Override Jason Alert
###############################################################################
- id: presence_pause_presence_override_jason_alert
  alias: '[Presence] Pause Presence Override Jason Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_presence_override_jason
  action:
    - service: alert.turn_off
      entity_id: alert.presence_override_jason

###############################################################################
## Presence - Pause Presence Override Sheri Alert
###############################################################################
- id: presence_pause_presence_override_sheri_alert
  alias: '[Presence] Pause Presence Override Sheri Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_presence_override_sheri
  action:
    - service: alert.turn_off
      entity_id: alert.presence_override_sheri
