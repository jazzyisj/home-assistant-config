#######################################################################################################################
## Presence - Sync Home Away - sync presence booleans to current state
#######################################################################################################################
- id: presence_sync_home_away
  alias: "[Presence] Sync Home Away"
  description: "Keep occupancy booleans in sync with person state."
  initial_state: true
  variables:
      people: "{{ ['jason','sheri'] }}"
      person: >
        {% if 'jason' in trigger.entity_id %} jason
        {% elif 'sheri' in trigger.entity_id %} sheri
        {% else %} all
        {% endif %}
  trigger:
    - platform: state
      entity_id:
        - person.jason
        - person.sheri
      to: home

    - platform: state
      entity_id:
        - person.jason
        - person.sheri
      from: home

    - platform: state
      entity_id:
        - input_boolean.jason_home
        - input_boolean.sheri_home

    - platform: state
      entity_id:
        - input_boolean.home_override_jason
        - input_boolean.home_override_sheri
      to: 'off'

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
  condition: "{{ person == 'all' or is_state('input_boolean.home_override_' ~ person,'off') }}"
  action:
    - service: automation.turn_off # turn off automation to prevent recursive trigger
      target:
        entity_id: "{{ this.entity_id }}"
      data:
        stop_actions: false

    - choose:
        - conditions: "{{ person == 'all' }}"
          sequence:
            - repeat:
                count: "{{ people|count }}"
                sequence:
                  - variables:
                      person: "{{ people[repeat.index - 1] }}"

                  - service: "{{ 'input_boolean.turn_on' if is_state('person.' ~ person,'home') else 'input_boolean.turn_off' }}"
                    target: # switch boolean to current state
                      entity_id: "input_boolean.{{ person }}_home"
      default:
        - service: "{{ 'input_boolean.turn_on' if is_state('person.' ~ person,'home') else 'input_boolean.turn_off' }}"
          target: # switch boolean to current state
            entity_id: "input_boolean.{{ person }}_home"

    - service: automation.turn_on
      target:
        entity_id: "{{ this.entity_id }}"



