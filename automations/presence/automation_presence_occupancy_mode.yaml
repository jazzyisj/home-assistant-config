###############################################################################
## Presence - Occupancy Mode
###############################################################################
- id: presence_occupancy_mode
  alias: '[Presence] Occupancy Mode'
  description: 'Set occupancy mode options, validate occupancy mode change.'
  mode: restart
  variables:
    prev_mode: '{{ trigger.from_state.state }}'
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: ~
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Home
          sequence:
            - service: script.turn_off
              target:
                entity_id: script.bedtime

            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.owner_home
                      state: 'off'
                  sequence:
                    - service: input_boolean.turn_on
                      target:
                        entity_id: input_boolean.occupancy_override

                    # select guest if guest home or previous occupancy mode if not
                    - service: input_select.select_option
                      target:
                        entity_id: input_select.occupancy_mode
                      data:
                        option: "{{ 'Guest' if is_state('input_boolean.guest_home','on') else prev_mode }}" # should be away/vacation

                    - service: input_boolean.turn_off
                      target:
                        entity_id: input_boolean.occupancy_override

        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Night
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.someone_home
                      state: 'off'
                  sequence:
                    - service: input_boolean.turn_on
                      target:
                        entity_id: input_boolean.occupancy_override

                    - service: input_select.select_option # back to previous mode
                      target:
                        entity_id: input_select.occupancy_mode
                      data:
                        option: '{{ prev_mode }}' # should be away/vacation

                    - service: input_boolean.turn_off
                      target:
                        entity_id: input_boolean.occupancy_override
              default:
                - service: timer.cancel # light timers cancelled here so lights can turn off
                  target:
                    entity_id: >
                      {{ states.timer|selectattr('attributes.type','eq','light')
                          |map(attribute='entity_id')|list }}

                - service: homeassistant.turn_off
                  target:
                    entity_id:
                      - input_boolean.bedtime_delayed
                      - script.someone_arrives_home
                      - script.arrive_home_lights
                      - script.arriving_home_notification
                      - script.waketime
                      - script.morning_lights

        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Away
                - Vacation
          sequence:
            - service: homeassistant.turn_off
              target:
                entity_id:
                  - input_boolean.bedtime_delayed
                  - script.someone_arrives_home
                  - script.arrive_home_lights
                  - script.arriving_home_notification
                  - script.waketime
                  - script.morning_lights
                  - script.bedtime

            - service: timer.cancel # light timers cancelled here so lights / fans can turn off
              target:
                entity_id: >
                  {{ states.timer|selectattr('attributes.type','in',['light','ceiling_fan','vent_fan'])
                      |map(attribute='entity_id')|list }}

            - service: timer.cancel # cancel arrive home light timer (away->home->away)
              target:
                entity_id: timer.arrive_home_lights

        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Guest
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.owner_home
                      state: 'on'
                  sequence:
                    - service: input_boolean.turn_on
                      target:
                        entity_id: input_boolean.occupancy_override

                    - service: input_select.select_option # back to previous mode if night/override else home mode
                      target:
                        entity_id: input_select.occupancy_mode
                      data:
                        option: "{{ 'Night' if prev_mode == 'Night' else 'Home' }}"

                    - service: input_boolean.turn_off
                      target:
                        entity_id: input_boolean.occupancy_override

###############################################################################
## Presence - Set Occupancy Mode
###############################################################################
- id: presence_set_occupancy_mode
  alias: '[Presence] Set Occupancy Mode'
  description: 'Set occupancy mode.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_home_mode

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_away_mode
  action:
    - choose:
        - conditions: "{{ trigger.event.data['action'] == 'set_home_mode' }}"
          sequence:
            - service: input_select.select_option
              target:
                entity_id: input_select.occupancy_mode
              data:
                option: Home

        - conditions: "{{ trigger.event.data['action'] == 'set_away_mode' }}"
          sequence:
            - service: input_select.select_option
              target:
                entity_id: input_select.occupancy_mode
              data:
                option: Away

###############################################################################
## Presence - Occupancy Mode Reset
###############################################################################
- id: presence_occupancy_mode_reset
  alias: '[Presence] Occupancy Mode Reset'
  description: 'Auto select occupancy mode.'
  trigger:
    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
      for: 60 # allow states to register
  action:
    # defaults to Home/Guest if bedtime_today/waketime_today is none
    - service: input_select.select_option
      target:
        entity_id: input_select.occupancy_mode
      data:
        # set waketime +1 day if bedtime > waketime (still "yesterday" before day_reset)
        option: >
          {% set waketime = states('sensor.waketime_today')|as_datetime
            if states('sensor.waketime_today')|lower not in ['unknown','unavailable','none'] else none %}
          {% set bedtime = states('sensor.delayed_bedtime')|as_datetime
            if states('sensor.delayed_bedtime')|lower not in ['unknown','unavailable','none'] else none %}
          {% if bedtime != none and waketime != none %}
            {% set waketime = waketime + timedelta(days=1) if bedtime > waketime else waketime %}
          {% endif %}
          {% if is_state('binary_sensor.someone_home','off') %}
            {{ 'Vacation' if is_state('input_select.occupancy_mode','Vacation') else 'Away' }}
          {% elif bedtime == none or waketime == none %}
            {{ 'Home' if is_state('binary_sensor.owner_home','on') else 'Guest' }}
          {% elif bedtime < now() < waketime %}
            {{ 'Night' if is_state('input_boolean.bedtime_delayed','off')
                else ('Home' if is_state('binary_sensor.owner_home','on') else 'Guest') }}
          {% else %}
            {{ 'Home' if is_state('binary_sensor.owner_home','on') else 'Guest' }}
          {% endif %}
