###############################################################################
## Energy - Utility Periods
# https://www.home-assistant.io/integrations/utility_meter/
# https://enwin.com/electric-rates-residential/

## Peak Utility Period 0.1842
## Midpeak Utility Period 0.1272
## Offpeak Utility Period 0.0962
## peak and midpeak swap May 1 - Oct 31
###############################################################################

###############################################################################
## Energy - Set Utility Period
###############################################################################
- id: energy_set_utility_period
  alias: '[Energy] Set Utility Period'
  description: 'Reset utility meters period.'
  trigger:
    - platform: state
      entity_id:
        - input_boolean.startup_pending
        - input_boolean.dev_mode
      to: 'off'

    - platform: time
      at:
        - '07:00:00'
        - '11:00:00'
        - '17:00:00'
        - '19:00:00'

  action:
    - service: utility_meter.select_tariff
      target:
        entity_id:
          - utility_meter.daily_energy_use
          - utility_meter.monthly_energy_use
      data:
        tariff: >
          {% set time = states('sensor.time') %}
          {% set summer = 5 >= now().month < 11 %}
          {% if is_state('binary_sensor.utilities_workday','on') %}
            {% if '00:00' < time < '07:00' %} offpeak
            {% elif '07:00' <= time < '11:00' %} {{ 'midpeak' if summer else 'peak' }}
            {% elif '11:00' <= time < '17:00'  %} {{ 'peak' if summer else 'midpeak' }}
            {% elif '17:00' <= time < '19:00'  %} {{ 'midpeak' if summer else 'peak' }}
            {% else %} offpeak
            {% endif %}
          {% else %} offpeak
          {% endif %}
