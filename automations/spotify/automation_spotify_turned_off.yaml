#######################################################################################################################
## Spotify - Turned Off
#######################################################################################################################
- id: spotify_turned_off
  alias: "[Spotify] Turned Off"
  description: Turn off Spotify.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.spotify_on
      to: 'off'

    #NOTE no binary_sensor.spotify_active here - triggers during tts, player change
    # automation.spotify_media_player_turned_off triggers with spotify player off

    # media player paused/off too long - turn off
    - platform: template
      value_template: "{{ states(states('input_text.active_media_player_spotify'))|lower in ['paused','idle','off','unknown','unavailable','none'] }}"
      for:
        minutes: 5

  action:
    - choose:
        - conditions:
            # spotify already off - turn off boolean
            - condition: state
              entity_id: binary_sensor.spotify_active
              state: 'off'

          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.spotify_on

      default:
        - service: script.turn_on
          entity_id: script.spotify_stop