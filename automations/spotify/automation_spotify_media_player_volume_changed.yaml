#######################################################################################################################
## Spotify - Media Player Volume Changed
#######################################################################################################################
- id: spotify_media_player_volume_changed
  alias: "[Spotify] Media Player Volume Changed"
  description: Change spotify volume control when spotify media player volume changes.
  initial_state: true
  mode: queued
  max: 5
  trigger:
    - platform: state
      entity_id: !include /config/include/entities/media_player_entities.yaml
      attribute: volume_level

  condition:
    - condition: state
      entity_id: input_boolean.spotify_on
      state: 'on'
      
    - "{{ is_state('input_text.active_media_player_spotify',trigger.entity_id) }}"

    # only run if trigger to_state is not off or volume will be set to 0
    - condition: template
      value_template: "{{ states(trigger.entity_id)|lower not in ['off','idle','unknown','unavailable','none'] }}"

    # only run if the new media player volume is not already equal to the spotify set volume
    - condition: template
      value_template: "{{ '%0.2f'|format(state_attr(trigger.entity_id,'volume_level')|float) != '%0.2f'|format(states('input_number.spotify_volume')|float/100) }}"

    - !include /config/include/template/spotify_not_tts_player_condition.yaml
    - !include /config/include/template/spotify_not_alarm_clock_player_condition.yaml

  action:
    # media player volume float*100 and format float to zero decimal for percent value
    - service: input_number.set_value
      data:
        entity_id: input_number.spotify_volume
        value: "{{ '%0.0f'|format(state_attr(trigger.entity_id,'volume_level')|float*100 ) }}"



