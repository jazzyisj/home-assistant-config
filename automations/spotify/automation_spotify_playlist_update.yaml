#######################################################################################################################
## Spotify - Playlist Update
#######################################################################################################################
- id: spotify_playlist_update
  alias: "[Spotify] Playlist Update"
  description: "Update spotify playlist input options."
  mode: restart
  trigger:
    - platform: state
      id: startup
      entity_id: input_boolean.startup_pending
      to: 'off'

    - platform: state
      entity_id:
        - sensor.playlists_sensor
        - sensor.playlists_sensor_jazzyisj
        - sensor.playlists_sensor_sherigagnon
      attribute: playlists
  action:
    - wait_template: > # error if not popuplated (eg startup)
        {{ is_state('sensor.playlists_sensor','ok')
            and is_state('sensor.playlists_sensor_jazzyisj','ok')
            and is_state('sensor.playlists_sensor_sherigagnon','ok') }}
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: automation.turn_off
      target:
        entity_id: &spotify_automations
          - automation.spotify_store_playlist_selection # don't overwrite stored values
          - automation.media_player_media_auto_resume # triggered by input_select.spotify_playlist_hassio
      data:
        stop_actions: false

    - choose:
        - conditions:
            - "{{ trigger.entity_id == 'sensor.playlists_sensor_jazzyisj' or trigger.id == 'startup' }}"
            - "{{ states('sensor.playlists_sensor_jazzyisj')|lower not in ['','unknown','unavailable','none'] }}"
          sequence:
            - service: input_select.set_options
              target:
                entity_id: input_select.spotify_playlist_jazzyisj
              data:
                options: >
                  [{% for item in state_attr('sensor.playlists_sensor_jazzyisj','playlists') -%}
                    "{{- item.name }}"{{ ',' if not loop.last -}}{% endfor %}]

            - service: input_select.select_option
              target:
                entity_id: input_select.spotify_playlist_jazzyisj
              data:
                option: "{{ states('input_text.spotify_playlist_jazzyisj') }}"

    - choose:
        - conditions:
            - "{{ trigger.entity_id == 'sensor.playlists_sensor_sherigagnon'  or trigger.id == 'startup' }}"
            - "{{ states('sensor.playlists_sensor_sherigagnon')|lower not in ['','unknown','unavailable','none'] }}"
          sequence:
            - service: input_select.set_options
              target:
                entity_id: input_select.spotify_playlist_sherigagnon
              data:
                options: >
                  [{% for item in state_attr('sensor.playlists_sensor_sherigagnon','playlists') -%}
                    "{{- item.name }}"{{ ',' if not loop.last -}}{% endfor %}]

            - service: input_select.select_option
              target:
                entity_id: input_select.spotify_playlist_sherigagnon
              data:
                option: "{{ states('input_text.spotify_playlist_sherigagnon') }}"

    - choose:
        - conditions:
            - "{{ trigger.entity_id == 'sensor.playlists_sensor'  or trigger.id == 'startup' }}"
            - "{{ states('sensor.playlists_sensor')|lower not in ['','unknown','unavailable','none'] }}"
          sequence:
            - variables:
                selected_playlists: "{{ expand('group.spotify_selected_playlists')|map(attribute='entity_id')|list }}"
                stored_playlists: "{{ expand('group.spotify_stored_playlists')|map(attribute='entity_id')|list }}"

            - service: input_select.set_options
              target:
                entity_id: &spotify_selects
                  - input_select.spotify_playlist_hassio
                  - input_select.media_preset_spotify_wake
                  - input_select.media_preset_spotify_morning
                  - input_select.media_preset_spotify_sleep
                  - input_select.media_preset_spotify_jason
                  - input_select.media_preset_spotify_sheri
                  - input_select.media_preset_spotify_guest
                  - input_select.media_preset_spotify_shower
                  - input_select.media_preset_spotify_company
                  - input_select.alarm_clock_spotify_auto_alarm
                  - input_select.alarm_clock_spotify_manual_alarm
                  - input_select.alarm_clock_spotify_nap_alarm
              data:
                options: >
                  [{% for item in state_attr('sensor.playlists_sensor','playlists') -%}
                    "{{- item.name }}"{{ ',' if not loop.last -}}{% endfor %}]

            - repeat: # restore previous selection (values reset when options reloaded)
                count: "{{ selected_playlists|count }}"
                sequence:
                  - choose:
                      - conditions: "{{ states(stored_playlists[repeat.index-1])|lower not in ['','unknown','unavailable','none'] }}"
                        sequence:
                          - service: input_select.select_option
                            target:
                              entity_id: "{{ selected_playlists[repeat.index-1] }}"
                            data:
                              option: "{{ states(stored_playlists[repeat.index-1]) }}"

    - service: automation.turn_on
      target:
        entity_id: *spotify_automations

#######################################################################################################################
## Spotify - Store Playlist Selection
#######################################################################################################################
- id: spotify_store_playlist_selection
  alias: "[Spotify] Store Playlist Selection"
  description: "Update stored spotify playlist selection."
  mode: restart
  trigger:
    - platform: state
      entity_id: *spotify_selects

    - platform: state
      entity_id:
        - input_select.spotify_playlist_jazzyisj
        - input_select.spotify_playlist_sherigagnon
  action:
    - service: input_text.set_value
      target:
        entity_id: "{{ trigger.entity_id|replace('input_select','input_text') }}"
      data:
        value: "{{ states(trigger.entity_id) }}"

#######################################################################################################################
## Spotify - Playlist Selection Update
#######################################################################################################################
- id: spotify_playlist_selection_update
  alias: "[Spotify] Playlist Selection Update"
  description: "Update spotify playlist input selection."
  mode: restart
  trigger:
    - platform: state
      entity_id:
        - media_player.spotify_hassio
        - media_player.spotify_jazzyisj
        - media_player.spotify_sherigagnon
      attribute: media_playlist
  condition: "{{ state_attr(trigger.entity_id,'media_playlist')|lower not in ['unknown','unavailable','none'] }}"
  action:
    - service: automation.turn_off
      target:
        entity_id: automation.media_player_media_auto_resume # triggered by input_select.spotify_playlist_hassio
      data:
        stop_actions: false

    - service: input_select.select_option
      target:
        entity_id: >
          {% set name = trigger.entity_id|replace('media_player.spotify_','') %}
          input_select.spotify_playlist_{{ name }}
      data:
        option: "{{ state_attr(trigger.entity_id,'media_playlist') }}"

    - service: automation.turn_on
      target:
        entity_id: automation.media_player_media_auto_resume
