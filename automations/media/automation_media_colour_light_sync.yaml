#######################################################################################################################
## Media - Colour Light Sync
#######################################################################################################################
- id: media_colour_light_sync
  alias: "[Media] Colour Light Sync"
  description: "Sync RGB Light to media player picture entity color."
  mode: restart
  trigger:
    - platform: state
      id: switch
      entity_id: input_boolean.media_color_light_sync
      to: 'on'

    - platform: state
      id: player
      entity_id: media_player.dining_room_display
      attribute: entity_picture

    - platform: state
      id: light
      entity_id: light.dining_room_rgb_light
      to: 'off'
  condition:
    - condition: state
      entity_id: input_boolean.media_color_light_sync
      state: 'on'
  action:
    - choose:
        - conditions: "{{ trigger.id == 'light' }}"
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.media_color_light_sync
      default:
        - choose:
            - conditions:
                - condition: state
                  entity_id: switch.light_flux_dining_room
                  state: 'on'
              sequence:
                - service: switch.turn_off
                  target:
                    entity_id: switch.light_flux_dining_room

        - choose:
            - conditions: "{{ trigger.id == 'switch' and is_state('light.dining_room_rgb_light','off') }}"
              sequence:
                - service: light.turn_on
                  target:
                    entity_id: light.dining_room_rgb_light

        - condition: template
          value_template: >
            {{ state_attr('media_player.dining_room_display','entity_picture')|lower
                not in ['','unknown','unavailable','none'] }}

        - service: color_extractor.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            color_extract_url: "{{ state_attr('media_player.dining_room_display','entity_picture') }}"
            brightness_pct: 80
            transition: 5
