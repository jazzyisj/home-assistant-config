###############################################################################
## Media Preset - Sleep Finished
###############################################################################
- id: media_preset_sleep_finished
  alias: "[Media Preset] Sleep Timer Finished"
  description: "Turn off preset booleans."
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.media_preset_sleep
  condition:
    - condition: state
      entity_id: script.media_play
      state: "off"
  action:
    - service: script.media_players_off
      data:
        entity_id: > # turns of both reg and mass players
          {{ states.media_player
            |selectattr('name','eq',states('select.media_preset_speaker_sleep'))
            |map(attribute='entity_id')|list }}

###############################################################################
## Media Preset - Sleep Player Turned Off
###############################################################################
- id: media_preset_sleep_player_turned_off
  alias: "[Media Preset] Sleep Player Turned Off"
  description: "Turn off sleep player timer."
  trigger:
    - platform: template
      value_template: >
        {% set sleep_player = expand('group.media_players')
          |selectattr('name','eq',states('select.media_preset_speaker_sleep'))
          |map(attribute='entity_id')|join('') %}
        {{ states(sleep_player) not in ['playing','paused']
            and is_state('timer.media_preset_sleep','active') }}
  action:
    - service: timer.cancel
      data:
        entity_id: timer.media_preset_sleep

###############################################################################
## Media Preset - Sleep Time Changed
###############################################################################
- id: media_preset_sleep_time_changed
  alias: "[Media Preset] Sleep Time Changed"
  description: "Restart sleep timer when sleep time control changed."
  mode: restart
  trigger:
    - platform: state
      entity_id: input_number.media_preset_sleep_time
      to: ~
  condition:
    - condition: state
      entity_id: timer.media_preset_sleep
      state: active

    - condition: state
      entity_id: script.media_play
      state: "off"
  action:
    - service: timer.start
      target:
        entity_id: timer.media_preset_sleep
      data:
        duration:
          minutes: "{{ states('input_number.media_preset_sleep_time')|int(0) }}"
