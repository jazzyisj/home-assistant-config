###############################################################################
## Play Sleep Media Preset
###############################################################################
- id: play_sleep_media_preset
  alias: "Play Sleep Media Preset"
  description: "Play Sleep media preset."
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: Night
      from:
        - Home
        - Guest
      for: 60 # allow media player auto off to run
  condition:
    - condition: state
      entity_id: input_boolean.media_preset_enabled_sleep
      state: "on"

    - condition: template
      alias: "Within an hour of bedtime"
      value_template: >
        {% if has_value('sensor.bedtime_today') %}
          {% set bedtime = states('sensor.bedtime_today') | as_datetime %}
          {{ now() > bedtime - timedelta(hours=1) and now() - bedtime < timedelta(hours=1) }}
        {% endif %}
  action:
    - action: script.media_play
      data:
        preset: sleep

###############################################################################
## Stop Sleep Media Preset
###############################################################################
- id: stop_sleep_media_preset
  alias: "Stop Sleep Media Preset"
  description: "Stop Sleep media preset."
  trigger:
    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.media_preset_sleep
  action:
    - action: script.turn_media_player_off
      data:
        entity_id: >
          {{ expand('group.media_players')
              | selectattr('name', 'eq', states('select.media_preset_speaker_sleep'))
              | map(attribute='entity_id') | join }}

###############################################################################
## Sleep Media Preset Restart Timer
###############################################################################
- id: sleep_media_preset_restart_timer
  alias: "Sleep Media Preset Restart Timer"
  description: "Restart sleep media preset timer when time adjusted."
  mode: restart
  trigger:
    - platform: state
      entity_id: input_number.media_preset_sleep_time
      to:
  condition:
    - condition: state
      entity_id: timer.media_preset_sleep
      state:
        - active
        - paused
  action:
    - action: timer.start
      target:
        entity_id: timer.media_preset_sleep
      data:
        duration:
          minutes: "{{ states('input_number.media_preset_sleep_time') | int(0) }}"

###############################################################################
## Sleep Media Preset Cancel Timer
###############################################################################
- id: sleep_media_preset_cancel_timer
  alias: "Sleep Media Preset Cancel Timer"
  description: "Cancel sleep preset timer if preset player turned off."
  trigger:
    - platform: template
      id: sleep
      value_template: >
        {% set sleep_player = expand('group.media_players')
            | selectattr('name', 'eq', states('select.media_preset_speaker_sleep'))
            | map(attribute='entity_id') | join %}
        {{ states(sleep_player) not in ['playing', 'paused', 'buffering', 'on']
            and states('timer.media_preset_sleep') in ['active','paused'] }}
      for: 5 # allow queue to change, resume from tts
  condition:
    - condition: state
      entity_id: timer.media_preset_sleep
      state:
        - active
        - paused
  action:
    - action: timer.cancel
      data:
        entity_id: timer.media_preset_sleep
