###############################################################################
## Media Launcher
###############################################################################
- id: media_launcher_control
  alias: '[Media] Launcher Control'
  description: 'Control media launcher display.'
  mode: restart
  trigger:
    - platform: state
      id: media
      entity_id:
        - input_boolean.media_launcher_radio
        - input_boolean.media_launcher_spotify
        - input_boolean.media_launcher_youtube

    - platform: state
      id: preset
      entity_id:
        - input_boolean.media_launcher_preset_jason
        - input_boolean.media_launcher_preset_sheri
        - input_boolean.media_launcher_preset_guest
        - input_boolean.media_launcher_preset_wake
        - input_boolean.media_launcher_preset_morning
        - input_boolean.media_launcher_preset_sleep
        - input_boolean.media_launcher_preset_chill
        - input_boolean.media_launcher_preset_company
        - input_boolean.media_launcher_preset_shower

    - platform: state
      id: other
      entity_id:
        - input_boolean.media_launcher_tv
        - input_boolean.media_launcher_alarm_clock
        - input_boolean.media_launcher_tts
        - input_boolean.media_launcher_quiet_time
        - input_boolean.media_launcher_settings
  action:
    - service: automation.turn_off
      target:
        entity_id: '{{ this.entity_id }}'
      data:
        stop_actions: false

    - service: input_boolean.turn_off
      target:
        entity_id: >
          {{ expand('group.media_launchers')|rejectattr('entity_id','eq',trigger.entity_id)
              |map(attribute='entity_id')|list }}

    - service: automation.turn_on
      target:
        entity_id: '{{ this.entity_id }}'

    - choose:
        - conditions: "{{ trigger.id == 'other' }}"
          sequence:
            - delay: 60

            - wait_template: "{{ is_state('input_boolean.media_launcher_lock','off') }}"
              timeout: 300
      default:
        # turn off launcher when media turns on
        - wait_for_trigger:
            - platform: state
              entity_id:
                - binary_sensor.radio
                - binary_sensor.spotify
                - binary_sensor.youtube
              to: 'on'
          timeout: 300

        - wait_template: "{{ is_state('input_boolean.media_launcher_lock','off') }}"
          timeout: 900

        - service: automation.turn_off
          target:
            entity_id: '{{ this.entity_id }}'
          data:
            stop_actions: false

        # turn off all launcher booleans
        - service: input_boolean.turn_off
          target:
            entity_id: group.media_launchers

        - service: input_select.select_option
          target:
            entity_id: input_select.spotify_account
          data:
            option: Hassio # set back to deafult

        - service: automation.turn_on
          target:
            entity_id: '{{ this.entity_id }}'
