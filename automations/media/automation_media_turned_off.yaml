###############################################################################
## Media Turned Off
###############################################################################
- id: media_turned_off
  alias: '[Media] Turned Off'
  description: 'Run media stop when master media player turns off.'
  mode: queued
  max: 20
  variables:
    media_type: "{{ trigger.entity_id.split('.')[1] }}"
  trigger:
    - platform: state
      id: error
      entity_id:
        - media_player.radio
        - media_player.spotify_hassio
        - media_player.youtube
      to:
        - unavailable
        - unknown
      for:
        seconds: 5 # allow temporary disconnections without stopping media

    - platform: state
      entity_id:
        - media_player.radio
        - media_player.spotify_hassio
        - media_player.youtube
      to:
        - idle
        - 'off'
      for:
        seconds: 5 # allow temporary disconnections without stopping media

    - platform: state
      entity_id:
        - media_player.radio
        - media_player.spotify_hassio
        - media_player.youtube
      to: paused
      for:
        minutes: 5 # google pauses spotify/youtube instead of turning off
  condition:
    - condition: state
      entity_id:
        - input_boolean.startup_pending # turned on at shutdown to prevent alert
        - script.media_play # prevent trigger if players turned off in script.media_play
      state: 'off'
  action:
    - service: script.media_stop
      data:
        media_type: '{{ media_type }}'

    - if: "{{ trigger.id == 'error' }}"
      then:
        - service: input_boolean.turn_on
          target:
            entity_id: 'input_boolean.{{ media_type }}_failed'
