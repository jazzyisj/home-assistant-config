#######################################################################################################################
## Media Player - Volume Override
#######################################################################################################################
- id: media_player_volume_override #OCC
  alias: '[Media Player] Volume Override'
  description: 'Turn override off after delay.'
  mode: restart
  trigger:
    - platform: state
      entity_id: input_boolean.volume_override
      to: 'on'

    #IDEA should this be all media players?
    - platform: template # override on and all media turned off
      value_template: >
        {{ is_state('input_boolean.volume_override','on')
            and is_state('binary_sensor.radio','off')
            and is_state('binary_sensor.spotify','off')
            and is_state('binary_sensor.youtube','off') }}
      for:
        minutes: 5

    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation
  condition:
    - condition: state # don't turn off if scene on
      entity_id: binary_sensor.scene_active
      state: 'off'
  action:
    - choose: # if manually turned on wait for delay before turning back off
        - conditions: >
            {{ trigger.entity_id == 'input_boolean.volume_override'
                and is_state('binary_sensor.volume_override','on') }}
          sequence:
            - delay:
                minutes: 240

    # turn override off
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.volume_override
