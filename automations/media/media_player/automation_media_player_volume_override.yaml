###############################################################################
## Media Player - Volume Override Off
###############################################################################
- id: media_player_volume_override_off
  alias: '[Media Player] Volume Override Off'
  description: 'Turn volume override off.'
  mode: restart
  trigger:
    - platform: state
      entity_id: input_boolean.volume_override
      to: 'on'
      from: 'off'
      for:
        minutes: 120

    - platform: state
      entity_id: binary_sensor.quiet_time
      to: 'off'
      from: 'on'

    # override on and all speakers media turned off
    - platform: template
      value_template: >
        {{ is_state('input_boolean.volume_override','on')
            and expand('group.single_media_players')
              |selectattr('attributes.device_class','eq','speaker')
              |selectattr('state','in',['playing','paused'])|list|count == 0
            and is_state('binary_sensor.radio','off')
            and is_state('binary_sensor.spotify_hassio','off')
            and is_state('binary_sensor.youtube','off') }}
      for:
        minutes: 5

    - platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation
  condition:
    - condition: state
      entity_id: binary_sensor.scene_active
      state: 'off'

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
              and is_state('input_boolean.occupancy_override','off')
            if trigger.id in ['away','night'] else true }}
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.volume_override
