###############################################################################
## Media Player - Media Players Update
###############################################################################
- id: media_player_media_players_update
  alias: '[Media Player] Media Players Update'
  description: 'Update play media media player options.'
  mode: restart
  variables:
    selected_players: "{{ state_attr('group.media_selected_players','entity_id') }}"
    stored_players: "{{ state_attr('group.media_stored_players','entity_id') }}"
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: group.play_media_players
      attribute: entity_id
  condition:
    - condition: template
      value_template: >
        {{ state_attr('group.play_media_players','entity_id')|lower
            not in ['','[]','unknown','unavailable','none'] if trigger.id != 'startup' else true }}
  action:
    - wait_template: "{{ state_attr('group.play_media_players','entity_id') != none }}"
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: automation.turn_off
      target:
        entity_id: automation.media_player_store_player_selection # don't overwrite stored values
      data:
        stop_actions: false

    - service: input_select.set_options
      target:
        entity_id: &media_player_selects
          - input_select.media_preset_speaker_chill
          - input_select.media_preset_speaker_company
          - input_select.media_preset_speaker_guest
          - input_select.media_preset_speaker_jason
          - input_select.media_preset_speaker_morning
          - input_select.media_preset_speaker_sheri
          - input_select.media_preset_speaker_sleep
          - input_select.media_preset_speaker_wake
          - input_select.radio_media_player
          - input_select.spotify_hassio_media_player
          - input_select.spotify_jason_media_player
          - input_select.spotify_sheri_media_player
          - input_select.youtube_media_player
      data:
        options: >
          {% set options = namespace(value=[]) %}
          {% set media_play_players = expand(state_attr('group.play_media_players','entity_id'))
              |map(attribute='name')|list %}
          {% for item in media_play_players -%}
            {% set options.value = options.value + [item] %}
          {% endfor %}
          {{ options.value }}

    - choose:
        - conditions: '{{ selected_players|count > 0 }}' #NOTE only req on startup, now automatic
          sequence:
            - repeat: # restore previous selection (values reset when options reloaded)
                count: '{{ selected_players|count }}'
                sequence:
                  - variables:
                      select_entity: '{{ selected_players[repeat.index-1] }}'
                      stored_value: '{{ states(stored_players[repeat.index-1]) }}'

                  - choose:
                      - conditions: "{{ stored_value in state_attr(select_entity,'options') }}"
                        sequence:
                          - service: input_select.select_option
                            target:
                              entity_id: '{{ select_entity }}'
                            data:
                              option: '{{ stored_value }}'

    - service: automation.turn_on
      entity_id: automation.media_player_store_player_selection

###############################################################################
## Media Player - Store Player Selection
###############################################################################
- id: media_player_store_player_selection
  alias: '[Media Player] Store Player Selection'
  description: 'Update stored media player selection.'
  mode: queued
  trigger:
    - platform: state
      entity_id: *media_player_selects
  condition: "{{ states(trigger.entity_id)|lower not in ['','unknown','unavailable','none'] }}"
  action:
    - service: input_text.set_value
      target:
        entity_id: "{{ trigger.entity_id|replace('input_select','input_text') }}"
      data:
        value: '{{ states(trigger.entity_id) }}'
