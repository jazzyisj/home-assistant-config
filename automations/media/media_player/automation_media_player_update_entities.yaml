###############################################################################
## Media Player - Update Entities
###############################################################################
- id: media_player_update_entities
  alias: '[Media Player] Update Entities'
  description: 'Update media player entities.'
  mode: restart
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'

    # trigger when temporary media players to/from unavailable
    - platform: state
      entity_id: &media_players
        - media_player.hass_media_player
        - media_player.kiosk_media_player
        - media_player.browser_jlaptop_chrome_internal
        - media_player.browser_jphone_app_internal
        - media_player.browser_jphone_app_external
      to:
        - unknown
        - unavailable

    - platform: state
      entity_id: *media_players
      from:
        - unknown
        - unavailable
  action:
    - service: group.set
      data:
        object_id: media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','in',['single','group','tv'])
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: group_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','eq','group')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: single_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','eq','single')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: master_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.type','eq','master')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: media_play_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_media','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: cast_audio_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.cast_audio','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: tts_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_tts','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: alarm_clock_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.play_alarm_clock','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: media_preset_media_players
        entities: >
          {{ states.media_player|selectattr('attributes.media_preset','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: tv_players
        entities: >
          {{ states.media_player|selectattr('attributes.device_class','eq','tv')
              |map(attribute='entity_id')|list }}
