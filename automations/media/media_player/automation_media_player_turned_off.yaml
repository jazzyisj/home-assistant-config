###############################################################################
## Media Player Turned Off
###############################################################################
- id: media_player_turned_off
  alias: '[Media Player] Turned Off'
  description: 'Run Media Stop when media player turns off.'
  mode: queued
  max: 20
  variables:
    media_type: >
      {% if state_attr('sensor.media_types','media_types') != none %}
        {% set media_types = state_attr('sensor.media_types','media_types')|default([]) %}
        {% set type = namespace(value='') %}
        {% for media_type in media_types %}
          {% if is_state('binary_sensor.' ~ media_type,'on') and is_state('input_boolean.resume_' ~ media_type,'off')
              and trigger.entity_id in state_attr('sensor.' ~ media_type ~ '_media_player','entity_id') %}
            {% set type.value = media_type %}
          {% endif %}
        {% endfor %}
        {{ type.value }}
      {% endif %}
  trigger:
    - platform: state
      id: error
      entity_id: !include /config/include/media_player_entities_single.yaml
      to:
        - unavailable
        - unknown
      for:
        seconds: 10 # allow temporary disconnections without stoping media

    - platform: state
      id: turned_off
      entity_id: !include /config/include/media_player_entities_single.yaml
      to:
        - idle
        - 'off'
      for:
        seconds: 10 # allow temporary disconnections without stoping media

    - platform: state
      id: turned_off
      entity_id: !include /config/include/media_player_entities_single.yaml
      to: paused
      for:
        minutes: 5 # google pauses spotify/youtube instead of turning off
  condition:
    - condition: template
      value_template: "{{ media_type != '' }}"

    - condition: state
      entity_id:
        - input_boolean.startup_pending # turned on at shutdown to prevent alert
        - script.media_play
      state: 'off'
  action:
    - service: script.media_stop
      data:
        media_type: '{{ media_type }}'

    - choose:
        - conditions: "{{ trigger.id == 'error' }}"
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: 'input_boolean.{{ media_type }}_failed'
