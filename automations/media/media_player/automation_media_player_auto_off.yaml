###############################################################################
## Media Player - Auto Off
###############################################################################
- id: media_player_auto_off
  alias: '[Media Player] Auto Off'
  description: 'Automatically stop and turn off media players.'
  mode: restart
  trigger:
    - platform: state
      id: away
      entity_id: input_select.occupancy_mode
      to:
        - Away
        - Vacation

    - platform: state
      id: night
      entity_id: input_select.occupancy_mode
      to: Night

    - platform: state
      id: alarm
      entity_id: alarm_control_panel.alarm
      to: triggered

    - platform: state
      id: mute
      entity_id: switch.system_mute
      to: 'on'
      from: 'off'
      for:
        minutes: 15
  condition:
    - condition: state
      entity_id: input_boolean.media_player_automation
      state: 'on'

    - condition: template
      alias: 'Occupancy override is off if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.occupancy_override','off')
            if trigger.id in ['away','night'] else true }}
  action:
    - choose:
        - conditions: "{{ trigger.id in ['alarm','mute'] }}"
          sequence:
            - service: script.media_players_off
              data:
                media_players: "{{ state_attr('group.single_media_players','entity_id') }}"
      default:
        - choose:
            - conditions:
                - condition: state
                  entity_id: input_select.occupancy_mode
                  state: Night
              sequence:
                - service: script.media_players_off
                  data: #TV exclude TV's until after delay
                    media_players: "{{ state_attr('group.single_media_players','entity_id') }}"

                - delay:
                    minutes: 60

        - service: script.media_players_off
          data:
            media_players: "{{ state_attr('group.media_players','entity_id') }}"
