###############################################################################
## Media Player - Auto Off
###############################################################################
- id: media_player_auto_off #OCC
  alias: '[Media Player] Auto Off'
  description: 'Automatically stop and turn off media players.'
  mode: restart
  variables:
    media_sensors: "{{ state_attr('group.media_sensors','entity_id') }}"
    media_types: >
      {% set media_types = namespace(value=[]) %}
      {% for sensor in media_sensors %}
        {% set media_types.value = media_types.value + [sensor[14:]] %}
      {% endfor %}
      {{ media_types.value }}
    players:
      > # don't turn off tv's when alarm triggered, they switch to security cams
      {% set players = expand(state_attr('sensor.media_players','single'))
          |rejectattr('attributes.device_class','eq','tv') if trigger.id == 'alarm'
          else expand(state_attr('sensor.media_players','single')) %}
      {{ players|map(attribute='entity_id')|list }}
  trigger:
    - platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation

    - platform: state
      id: alarm
      entity_id: alarm_control_panel.alarm
      to: triggered
  condition:
    - condition: state
      entity_id: input_boolean.media_player_automation
      state: 'on'

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
            if trigger.id == 'occupancy' else true }}

    - condition: template
      value_template: >
        {{ is_state('input_boolean.alarm_automation','on')
            if trigger.id == 'alarm' else true }}
  action:
    # loop through media sensors, stop media type if on
    - repeat:
        count: '{{ media_sensors|count }}'
        sequence:
          - choose:
              - conditions: "{{ is_state(media_sensors[repeat.index -1],'on') }}"
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: script.media_stop
                    data:
                      variables:
                        media_type: '{{ media_types[repeat.index -1] }}'

    # wait for all media sensors to turn off
    - wait_template: "{{ expand(media_sensors)|selectattr('state','ne','off')|list|count == 0 }}"
      timeout: 30

    # stop any remaining media players (req for browser players)
    - choose:
        - conditions: >
            {{ expand(players)|selectattr('state','in',['on','playing','paused'])
                |list|count > 0 }}
          sequence:
            - service: media_player.media_stop
              target:
                entity_id: >
                  {{ expand(players)|selectattr('state','in',['playing','paused'])
                    |map(attribute='entity_id')|list }}

    # turn off any remaining media players
    - choose:
        - conditions: >
            {{ expand(players)|selectattr('state','in',['on','home','playing','paused','idle'])
                |list|count > 0 }}
          sequence:
            - service: media_player.turn_off
              target:
                entity_id: >
                  {{ expand(players)|selectattr('state','in',['on','home','playing','paused','idle'])
                      |map(attribute='entity_id')|list }}
