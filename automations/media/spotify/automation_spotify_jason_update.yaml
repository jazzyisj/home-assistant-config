###############################################################################
## Spotify Jason - Playlist Update
###############################################################################
- id: spotify_jason_playlist_update
  alias: "[Spotify] Jason Playlist Update"
  description: "Update spotify playlist input options, restore previous selection."
  initial_state: true
  mode: restart
  variables:
    selected_playlists: "{{ expand('group.spotify_jason_selected_playlists')|map(attribute='entity_id')|list }}"
    stored_playlists: "{{ expand('group.spotify_jason_stored_playlists')|map(attribute='entity_id')|list }}"
  trigger:
    - platform: state
      id: startup
      entity_id: input_boolean.startup_pending
      to: 'off'

    - platform: state
      entity_id: sensor.playlists_sensor_jason
      attribute: playlists
  condition:
    - condition: state
      entity_id:
        - binary_sensor.spotify_connected
        - binary_sensor.wan_connected
      state: 'on'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - wait_template: "{{ state_attr('sensor.playlists_sensor_jason','playlists')|lower not in ['','[]','unknown','unavailable','none'] }}"
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: automation.turn_off
      target:
        entity_id: &spotify_automations
          - automation.spotify_store_playlist_selection # don't overwrite stored values
          - automation.media_auto_resume # triggered by input_select.spotify_jason_playlist
      data:
        stop_actions: false

    - service: input_select.set_options
      target:
        entity_id: input_select.spotify_jason_playlist
      data:
        options: >
          [{% for item in state_attr('sensor.playlists_sensor_jason','playlists') -%}
            "{{- item.name }}"{{ ',' if not loop.last -}}{% endfor %}]

    - service: input_select.select_option
      target:
        entity_id: input_select.spotify_jason_playlist
      data:
        option: "{{ states('input_text.spotify_jason_playlist') }}"

    - service: automation.turn_on
      target:
        entity_id: *spotify_automations

###############################################################################
## Spotify Jason - Playlist Selection Update
###############################################################################
- id: spotify_jason_playlist_selection_update
  alias: "[Spotify] Jason Playlist Selection Update"
  description: "Update spotify playlist input selection."
  initial_state: true
  mode: restart
  trigger:
    - platform: state
      entity_id: media_player.spotify_jazzyisj
      attribute: media_playlist
  condition: "{{ state_attr(trigger.entity_id,'media_playlist') in state_attr('input_select.spotify_jason_playlist','options') }}"
  action:
    - service: automation.turn_off
      target:
        entity_id: automation.media_auto_resume # triggered by input_select.spotify_jason_playlist
      data:
        stop_actions: false

    - service: input_select.select_option
      target:
        entity_id: input_select.spotify_jason_playlist
      data:
        option: "{{ state_attr('media_player.spotify_jazzyisj','media_playlist') }}"

    - service: automation.turn_on
      target:
        entity_id: automation.media_auto_resume
