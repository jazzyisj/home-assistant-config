###############################################################################
## Spotify - Playlist Selection Update
###############################################################################
- id: spotify_playlist_selection_update
  alias: '[Spotify] Playlist Selection Update'
  description: 'Update playlist selection when changed in media player.'
  mode: restart
  variables:
    playlist: "{{ state_attr(trigger.entity_id,'media_playlist') }}"
  trigger:
    - platform: state
      entity_id: media_player.spotify_hassio
      attribute: media_playlist
  condition:
    - condition: template
      alias: 'Valid playlist, not a category'
      value_template: >
        {{ playlist in state_attr('select.spotify_hassio_playlist','options')
            and playlist not in state_attr('sensor.spotify_categories','categories') }}

    - condition: template
      alias: 'Alarm clock media player is not spotify media player'
      value_template: >
        {% if is_state('binary_sensor.alarm_clock','on') %}
          {{ states('select.alarm_clock_sound_manual') != 'Spotify Hassio' }}
        {% else %} true
        {% endif %}
  action:
    - service: automation.turn_off
      target:
        entity_id: automation.media_auto_resume
      data:
        stop_actions: false

    - service: select.select_option
      target:
        entity_id: select.spotify_hassio_playlist
      data:
        option: '{{ playlist }}'

    - service: automation.turn_on
      target:
        entity_id: automation.media_auto_resume
