#######################################################################################################################
## Alarm Clock - Sound List Update
#######################################################################################################################
- id: alarm_clock_sound_list_update
  alias: "[Alarm Clock] Sound List Update"
  description: "Update alarm clock sound list options, restore previous selection."
  mode: restart
  variables:
    selected_sounds: "{{ expand('group.alarm_clock_selected_sounds')|map(attribute='entity_id')|list }}"
    stored_sounds: "{{ expand('group.alarm_clock_stored_sounds')|map(attribute='entity_id')|list }}"
  trigger:
    - platform: state
      id: startup
      entity_id: input_boolean.startup_pending
      to: 'off'

    - platform: state
      entity_id: sensor.alarm_clock_sounds
      attribute: file_list
  condition:
    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - wait_template: "{{ states('sensor.alarm_clock_sounds')|lower not in ['','[]','unknown','unavailable','none'] }}"
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: automation.turn_off
      target:
        entity_id: automation.alarm_clock_store_sound_selection # don't overwrite stored values
      data:
        stop_actions: false

    - service: input_select.set_options
      target:
        entity_id:
          - input_select.alarm_clock_sound_auto
          - input_select.alarm_clock_sound_manual
          - input_select.alarm_clock_sound_nap
      data:
        options: >
            {% set files = namespace(value=[]) %}
            {% set media_types = ['Radio','Spotify','Youtube'] %}
            {% for item in state_attr('sensor.alarm_clock_sounds','file_list') %}
            {% set files.value = files.value
                + [item
                    |replace('/config/www/alarm_clock_sounds/','')
                    |replace('.mp3','')
                    |replace('_',' ')
                    |title
                  ] %}
            {% endfor %}
            {{ media_types + files.value }}

    - repeat: # restore previous selection (values reset when options reloaded)
        count: "{{ selected_sounds|count }}"
        sequence:
          - choose:
              - conditions: "{{ states(stored_sounds[repeat.index-1])|lower not in ['','unknown','unavailable','none'] }}"
                sequence:
                  - service: input_select.select_option
                    target:
                      entity_id: "{{ selected_sounds[repeat.index-1] }}"
                    data:
                      option: "{{ states(stored_sounds[repeat.index-1]) }}"

    - service: automation.turn_on
      target:
        entity_id: automation.alarm_clock_store_sound_selection

#######################################################################################################################
## Alarm Clock - Store Sound Selection
#######################################################################################################################
- id: alarm_clock_store_sound_selection
  alias: "[Alarm Clock] Store Sound Selection"
  description: "Update stored alarm clock sound selection."
  mode: parallel
  variables:
    entity: "{{ 'input_select.alarm_clock_sound_' ~ trigger.entity_id|replace('media_player.spotify_','') }}"
    playlist: "{{ state_attr(trigger.entity_id,'media_playlist') }}"
  trigger:
    - platform: state
      entity_id:
        - input_select.alarm_clock_sound_auto
        - input_select.alarm_clock_sound_manual
        - input_select.alarm_clock_sound_nap
  action:
    - service: input_text.set_value
      target:
        entity_id: "{{ trigger.entity_id|replace('input_select','input_text') }}"
      data:
        value: "{{ states(trigger.entity_id) }}"