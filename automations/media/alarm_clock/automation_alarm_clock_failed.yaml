#######################################################################################################################
## Alarm Clock - Failed
#######################################################################################################################
- id: alarm_clock_failed
  alias: "[Alarm Clock] Failed"
  description: "Play announcement, reset alarm clock when failed."
  max_exceeded: silent # recursive call
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_clock_failed
      to: 'on'

    - platform: template
      value_template: >
        {{ is_state('switch.alarm_clock_snooze','on')
            and not is_state('timer.alarm_clock_snooze','active') }}
      for: 5 # don't trigger between state changes

    - platform: template
      value_template: >
        {{ is_state(states('sensor.alarm_clock_media_player'),'paused')
             and is_state('switch.alarm_clock_snooze','off') }}
      for: 5 # don't trigger between state changes

    - platform: template
      value_template: >
        {{ is_state('binary_sensor.alarm_clock','on')
            and not is_state(states('sensor.alarm_clock_media_player'),'playing') }}
      for: 15 #SPOTIFY slow - don't trigger between state changes

  condition:
    - condition: state
      entity_id: binary_sensor.alarm_clock
      state: 'on'

    - condition: state
      entity_id:
        - input_boolean.startup_pending
        - input_boolean.resume_alarm_clock
        - input_boolean.alarm_clock_test_play
      state: 'off'
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.alarm_clock_failed

    - service: >
        {% if is_state('input_boolean.jphone_alarm_clock_notifications','on')
            and is_state('input_boolean.sphone_alarm_clock_notifications','on') %} notify.mobile
        {% elif is_state('input_boolean.jphone_alarm_clock_notifications','on') %} notify.jason
        {% elif is_state('input_boolean.sphone_alarm_clock_notifications','on') %} notify.sheri
        {% endif %}
      data:
        title: "Alarm Clock Failed"
        message: "Alarm clock failed at {{ now().strftime('%-I:%M %p') }}."
        data:
          tag: alarm_clock_failed
          group: Alert
          channel: alarm_stream
          importance: max
          ttl: 0
          priority: high
          clickAction: /lovelace/schedule
          color: !secret CRITICAL_COLOR
          icon_url: !secret ALERT_ICON
          actions:
            - action: alarm_clock_failed_reset
              title: Reset Alarm Clock

    - repeat:
        sequence:
          - service: script.turn_on
            target:
              entity_id: script.tts_play
            data:
              variables:
                message: |
                  Attention!
                  A scheduled alarm clock has failed to play.
                  Again, a scheduled alarm clock has failed to play.
                quiet_play: true
                min_volume: "{{ 50 if is_state_attr(states('sensor.tts_media_player'),'type','group') else 70 }}"

          - delay: 120 # delay between message
        until:
          - condition: state
            entity_id: input_boolean.alarm_clock_failed
            state: 'off'

#######################################################################################################################
## Alarm Clock - Failed Reset
#######################################################################################################################
- id: alarm_clock_failed_reset
  alias: "[Alarm Clock] Failed Reset"
  description: "Reset alarm_clock failed."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: alarm_clock_failed_reset

    - platform: state
      entity_id: input_boolean.alarm_clock_failed
      to: 'on'
      for:
        minutes: 15
  condition:
    condition: state
    entity_id: input_boolean.alarm_clock_failed
    state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.alarm_clock_failed