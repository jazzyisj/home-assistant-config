###############################################################################
## Alarm Clock - Media Player Turned Off
###############################################################################
- id: alarm_clock_media_player_turned_off
  alias: '[Alarm Clock] Media Player Turned Off'
  description: 'Turn off active alarm when alarm clock media player is turned off.'
  max_exceeded: silent
  trigger:
    - platform: state
      to:
        - 'off'
        - idle
        - unavailable
        - unknown
      entity_id: !include /config/include/media_player_entities_single.yaml
      for:
        seconds: 3 # delay so state changes betomeen snooze/loops don't shut alarm off
  condition:
    - condition: template
      alias: 'Alarm clock is on and trigger is alarm_clock media player or in the alarm clock speaker group'
      # sensor.alarm_clock_media_player only populated if and alarm clock switch is on
      # no binary_sensor.alarm_clock - prevents trigger with test play
      value_template: >
        {% set alarm = states('sensor.alarm_clock_media_player') %}
        {% if is_state_attr(alarm,'type','group') %}
          {% if alarm == trigger.entity_id %}{% set found.value = 1 %}
          {% else %}
            {% set found = namespace(value=0) %}
            {% set alarm_group = state_attr('sensor.alarm_clock_media_player','entity_id') %}
            {% for item in alarm_group %}{% if item == trigger.entity_id %}{% set found.value = 1 %}{% endif %}{% endfor %}
          {% endif %}
          {{ found.value|int(0) == 1 }}
        {% else %}
          {{ alarm == trigger.entity_id }}
        {% endif %}

    - condition: state
      entity_id:
        - input_boolean.resume_alarm_clock # prevent alarm turning off with tts
        - binary_sensor.tts
        - script.alarm_clock_play
        - script.alarm_clock_stop
      state: 'off'
  action:
    - choose:
        - conditions: "{{ trigger.to_state.state|lower in ['unknown','unavailable','none'] }}"
          sequence:
            - service: input_boolean.turn_on
              target:
                entity_id: input_boolean.alarm_clock_failed
      default:
        - service: script.alarm_clock_stop # stays here until script done, alarm clock will be off
          data:
            alarm_type: "{{ state_attr('binary_sensor.alarm_clock','alarm_type') }}"
