###############################################################################
## Alarm Clock - Resume
###############################################################################
- id: alarm_clock_resume
  alias: '[Alarm Clock] Resume'
  description: 'Resume alarm clock play.'
  mode: restart
  trigger:
    - platform: event
      id: snooze
      event_type: timer.finished
      event_data:
        entity_id: timer.alarm_clock_snooze

    - platform: state
      id: tts
      entity_id: binary_sensor.tts
      to: 'off'
      from: 'on'

    - platform: state
      id: hass
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
  condition:
    - condition: state
      entity_id: binary_sensor.alarm_clock
      state: 'on'

    - "{{ is_state('input_boolean.resume_alarm_clock','on') if trigger.id == 'tts' else true }}"
  action:
    - if: "{{ trigger.id == 'hass' }}"
      then:
        - delay: 10 # allow timers to restart

    - service: script.turn_on
      target:
        entity_id: script.alarm_clock_play
      data:
        variables:
          alarm_type: "{{ state_attr('binary_sensor.alarm_clock','alarm_type') }}"
          first_run: "{{ trigger.id == 'hass' }}" # first_run at startup to set volumes
          resume: "{{ trigger.id == 'tts' }}"
