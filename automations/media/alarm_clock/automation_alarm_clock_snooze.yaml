#######################################################################################################################
## Alarm Clock - Snoozed
## #NOTE alarm clock will snooze/fail if active and external source plays (eg launching spotify using google assistant)
#######################################################################################################################
- id: alarm_clock_snoozed
  alias: '[Alarm Clock] Snoozed'
  description: 'Turn on alarm clock snooze.'
  initial_state: true
  trigger:
    # use of media player pause as a snooze button
    - platform: state
      entity_id: !include /config/include/entities/media_player_entities_single.yaml
      to: paused

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: snooze_alarm_clock
  condition:
    - condition: state
      entity_id:
        - input_boolean.resume_alarm_clock # prevent alarm snoozing with tts
        - script.alarm_clock_play
        - script.alarm_clock_stop
      state: 'off'

    - condition: template
      alias: Alarm clock is on and trigger is alarm_clock media player or in the alarm clock speaker group
      value_template: >
        {% if trigger.id == 'player' %}
          {% set alarm = states('sensor.alarm_clock_media_player') %}
          {% if is_state_attr(alarm,'type','group') %}
            {% if alarm == trigger.entity_id %}{% set found.value = 1 %}
            {% else %}
              {% set found = namespace(value=0) %}
              {% set alarm_group = state_attr('sensor.alarm_clock_media_player','players') %}
              {% for item in alarm_group %}{% if item == trigger.entity_id %}{% set found.value = 1 %}{% endif %}{% endfor %}
            {% endif %}
            {{ found.value|int(0) == 1 }}
          {% else %}
            {{ alarm == trigger.entity_id }}
          {% endif %}
        {% else %} true
        {% endif %}
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.alarm_clock_snooze

#######################################################################################################################
## Alarm Clock - Turn Snooze Off
#######################################################################################################################
- id: alarm_clock_turn_snooze_off
  alias: '[Alarm Clock] Turn Snooze Off'
  description: 'Turn off alarm clock snooze.'
  initial_state: true
  trigger:
    - platform: state
      entity_id: !include /config/include/entities/media_player_entities_single.yaml
      to: playing
      from: paused
  condition:
    - condition: state
      entity_id:
        - binary_sensor.alarm_clock
        - switch.alarm_clock_snooze
      state: 'on'
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.alarm_clock_snooze
