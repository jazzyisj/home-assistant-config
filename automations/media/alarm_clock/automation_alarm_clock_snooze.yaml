###############################################################################
## Alarm Clock - Snoozed
## alarm clock will snooze/fail if active and external source plays
## eg. launching another media source using google assistant
###############################################################################
- id: alarm_clock_snooze_on
  alias: "[Alarm Clock] Snooze On"
  description: "Turn on alarm clock snooze."
  max_exceeded: silent
  trigger:
    # use media player pause as a snooze button
    - platform: state
      id: player
      entity_id: !include /config/include/media_player_entities_single.yaml
      to: paused

    - platform: event
      event_type: shelly.click
      event_data:
        device: shellybutton1-E8DB84AA2E96
        click_type: single

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: snooze_alarm_clock
  condition:
    - condition: state
      entity_id: binary_sensor.alarm_clock
      state: "on"

    - condition: state
      entity_id:
        - script.alarm_clock_play
        - script.alarm_clock_stop
      state: "off"

    - condition: template
      alias: "Trigger is an active alarm_clock media player"
      value_template: > #MASS change trigger to mass player
        {% set player = trigger.entity_id.split('.')[0] ~ '.mass_' ~ trigger.entity_id.split('.')[1] %}
        {{ iif(is_state('binary_sensor.alarm_clock','on'),
            player in state_attr('sensor.alarm_clock_media_player','entity_id'),false) }}
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.alarm_clock_snooze

###############################################################################
## Alarm Clock - Snooze Off
###############################################################################
- id: alarm_clock_snooze_off
  alias: "[Alarm Clock] Snooze Off"
  description: "Turn off alarm clock snooze."
  trigger:
    - platform: state
      entity_id: !include /config/include/media_player_entities_single.yaml
      to: playing
      from: paused
  condition:
    - condition: state
      entity_id:
        - binary_sensor.alarm_clock
        - switch.alarm_clock_snooze
      state: "on"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.alarm_clock_snooze
