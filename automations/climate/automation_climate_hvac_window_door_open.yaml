###############################################################################
## Climate - HVAC Window Door Open - keeps repeating until thermostat turned back on or window/door closed
###############################################################################
- id: climate_hvac_window_door_open
  alias: '[Climate] HVAC Window Door Open'
  description: 'Turn off HVAC if window or door is open for extended time.'
  mode: restart
  trigger:
    - platform: state
      entity_id: alert.hvac_window_door_open
      to: 'on'

    - platform: state
      entity_id: input_boolean.startup_pending # hvac may have been turned off before restart
      to: 'off'
  condition:
    - condition: state
      entity_id:
        - input_boolean.climate_automation
        - alert.hvac_window_door_open
      state: 'on'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.thermostat
      data:
        hvac_mode: 'off'

    - repeat:
        sequence:
          - service: script.tts_play
            data:
              message: >
                {% set msg = namespace(value='') %}
                {% set entities =  expand(state_attr('binary_sensor.hvac_window_door_open_alert','entities')) %}
                {% set qty = entities|count %}
                {%- for item in entities -%}
                    {% if not loop.first %}{% set msg.value = msg.value ~ ', ' %}{% endif %}
                    {% set msg.value = msg.value ~ item.name %}
                {% endfor %}
                {%- set clist = ', and ' if msg.value.split(',')|count > 2 else ' and ' -%}
                {%- set plural = 'are' if qty|int(0) > 1 else 'is' -%}
                Attention! The thermostat has been turned off.
                The {{ clist.join(msg.value.rsplit(', ', 1)) }} {{ plural }} open!
              night_play: true
              ignore_away: true
              save_message: true
              min_volume: "{{ 50 if is_state_attr(states('sensor.tts_media_player'),'type','group') else 60 }}"

          - wait_template: "{{ not is_state('alert.hvac_window_door_open','on') or not is_state('climate.thermostat','off') }}"
            timeout: # wait to check if alert turns off/is paused or hvac has been turned back on
              minutes: 15

          - choose:
              - conditions:
                  - condition: not
                    conditions:
                      - condition: state # someone turned the thermostat back on
                        entity_id: climate.thermostat
                        state: 'off'

                      - condition: state # alert hasn't turned off/been paused
                        entity_id: alert.hvac_window_door_open
                        state: 'on'
                sequence:
                  # climate was turned back on so turn off the alert
                  - service: alert.turn_off
                    entity_id: alert.hvac_window_door_open

                  - wait_template: "{{ is_state('alert.hvac_window_door_open','idle') }}"
                    timeout: # wait before turning alert back on
                      hours: 2

                  - choose:
                      - conditions: '{{ not wait.completed }}' # alert was still active
                        sequence:
                          - service: alert.turn_on # restarts automation
                            entity_id: alert.hvac_window_door_open
            default:
              - wait_template: "{{ is_state('alert.hvac_window_door_open','idle') }}"
                timeout: # wait before replay tts
                  minutes: 30
        until:
          - condition: state
            entity_id: alert.hvac_window_door_open
            state: 'idle'

    # reset back to original
    - service: climate.set_hvac_mode
      target:
        entity_id: climate.thermostat
      data:
        hvac_mode: "{{ states('input_select.hvac_mode') }}"

###############################################################################
## Climate - Pause HVAC Window Door Open Alert
###############################################################################
- id: climate_pause_hvac_window_door_open_alert
  alias: '[Climate] Pause HVAC Window Door Open Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_hvac_window_door_open
  action:
    - service: alert.turn_off
      entity_id: alert.hvac_window_door_open
