###############################################################################
## Climate - HVAC Filter Alert
###############################################################################
- id: climate_hvac_filter_alert
  alias: '[Climate] HVAC Filter Alert'
  description: 'Send filter change notification.'
  trigger:
    - platform: numeric_state
      entity_id: sensor.hvac_filter_hours
      above: 250

    - platform: numeric_state
      entity_id: sensor.hvac_filter_hours
      below: 1
  condition:
    - condition: state
      entity_id: input_boolean.climate_alerts
      state: 'on'

    - condition: template
      alias: 'Only if from state valid (> 0)'
      value_template: '{{ trigger.from_state.state|int(0) > 1 }}'

    - condition: template
      alias: 'Reset button not just pressed'
      value_template: "{{ now() - states('button.hvac_filter_hours_reset')|as_datetime > timedelta(minutes=1) }}"
  action:
    - service: notify.jason
      data:
        message: 'Change HVAC filter.'
        data:
          tag: hvac_filter_hours
          group: General
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          notification_icon: mdi:thermostat
          icon_url: !secret AIR_FILTER_ICON
          image: !secret AIR_FILTER_IMAGE
          ledColor: !secret MINOR_COLOR
          color: !secret MINOR_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-mobile/climate
          actions:
            - title: 'Reset Hours'
              action: call-service
              service: button.press
              service_data:
                entity_id: button.hvac_filter_hours_reset
