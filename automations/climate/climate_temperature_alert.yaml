###############################################################################
## Climate - Indoor Temperature Alert
## Thermostat stays in selected mode after alert
###############################################################################
- id: climate_indoor_temperature_alert
  alias: "[Climate] Indoor Temperature Alert"
  description: "Turn thermostat to heat/cool when indoor temp alert is active."
  initial_state: true # safety
  triggers:
    - platform: state
      entity_id:
        - alert.indoor_low_temperature
        - alert.indoor_high_temperature
      to: "on"
  actions:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.hvac_manual_mode

    - action: climate.set_hvac_mode
      target:
        entity_id: climate.thermostat
      data:
        hvac_mode: "{{ iif(is_state('alert.indoor_low_temperature', 'on'), 'heat', 'cool') }}"
      continue_on_error: true

    - delay: 5 # let thermostat change modes

    - action: climate.set_temperature
      target:
        entity_id: climate.thermostat
      data:
        temperature: >
          {{ iif(is_state('alert.indoor_low_temperature', 'on'),
            states('input_number.low_temperature_threshold') | int,
            states('input_number.high_temperature_threshold') | int) }}
      continue_on_error: true

    - action: notify.jason
      data:
        title: "Emergency HVAC"
        message: |
          The HVAC system has been turned on because an indoor temperature alert is active.
          HVAC Mode: {{ states('climate.thermostat') }}
          HVAC State: {{ state_attr('climate.thermostat', 'hvac_action') }}
          Temperature: {{ states('sensor.indoor_temperature', with_unit=true) }}
          Target: {{ states('input_number.thermostat_target_temperature', with_unit=true) }}
        data:
          tag: emergency_heat
          group: Alert
          channel: Alert
          notification_icon: mdi:thermostat
          icon_url: !secret LOW_TEMP_ICON
          ledColor: !secret WARNING_COLOR
          color: !secret WARNING_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ui-mobile/climate
          actions:
            - title: "Climate Off"
              action: turn_thermostat_off
      continue_on_error: true
