###############################################################################
## Climate - Occupancy Mode Control
###############################################################################
- id: climate_occupancy_mode_control
  alias: '[Climate] Occupancy Mode Control'
  description: 'Set climate modes according to occupancy mode.'
  max_exceeded: silent
  trigger:
    - platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Night
        - Guest
        - Away
        - Vacation
      for:
        seconds: 5 # prevent trigger on quick changes in state (eg guest-> home-> guest)

    - platform: state
      entity_id: input_boolean.hvac_presence_override
      to: 'on'
      from: 'off'
  condition:
    - condition: state
      entity_id:
        - input_boolean.climate_automation
        - input_boolean.climate_occupancy_control
      state: 'on'

    - condition: not
      conditions:
        - condition: state
          entity_id: alert.hvac_window_door_open
          state: 'on'

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
              and is_state('input_boolean.occupancy_override','off')
            if trigger.id == 'occupancy' else true }}
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Home
                - Guest

            - condition: state
              entity_id: input_boolean.hvac_presence_override
              state: 'on'
          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.hvac_presence_override

    - service: script.set_thermostat
