#######################################################################################################################
## Scene Reset
#######################################################################################################################
- id: scene_reset #OCC
  alias: "[Scene] Reset"
  description: Reset to scene to default scene when scene turned off.
  initial_state: true
  mode: restart
  trigger:
    - platform: state
      id: away
      entity_id: input_select.occupancy_mode
      to:
        - Away
        - Vacation

    - platform: state
      id: home
      entity_id: input_select.occupancy_mode
      to:
        - Home
        - Override
      from:
        - Night
        - Away
        - Vacation

    - platform: state
      id: night
      entity_id: input_select.occupancy_mode
      to: Night
      from: Night
        - Home
        - Guest

    - platform: state
      id: scene_off
      entity_id:
        - script.scene_company
        - script.scene_movie
      to: 'off'
      from: 'on' # req it triggers on script reload

    - platform: state
      id: scene_on
      entity_id:
        - script.scene_wake_up
        - script.scene_bedtime
        - script.scene_movie
        - script.scene_company
      to: 'on'
  condition:
    - condition: template
      alias: Precence automation is on if triggered by occupancy mode
      value_template: "{{ is_state('input_boolean.presence_automation','on') if trigger.id in ['home','away'] else true }}"
  action:
    - choose:
        - conditions: "{{ trigger.entity_id == 'script.scene_movie' }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.media_player_automation
                      state: 'on'
                  sequence:
                    - service: input_boolean.turn_off
                      entity_id:
                        - input_boolean.mute_all
                        - input_boolean.bedtime_delayed
                        - input_boolean.volume_override
                        #IDEA turn off tv if movie
                        #IDEA play saved messages if movie
      default:
        - service: script.turn_off
          entity_id: script.scene_movie

    - choose:
        - conditions: "{{ trigger.entity_id == 'script.scene_company' }}"
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.media_player_automation
                      state: 'on'
                  sequence:
                    - service: input_boolean.turn_off
                      entity_id:
                        - input_boolean.mute_all
                        - input_boolean.bedtime_delayed
                        - input_boolean.volume_override
                        - input_boolean.radio
                        - input_boolean.spotify
      default:
        - service: script.turn_off
          entity_id: script.scene_company

    - choose:
        - conditions: "{{ trigger.id == 'away' }}"
          sequence:
            - service: script.turn_off
              entity_id:
                - script.someone_arrives_home
                - script.shower_on

    - choose:
        - conditions: "{{ trigger.entity_id != 'script.scene_wake_up' }}"
          sequence:
            - service: script.turn_off
              entity_id:
                - script.scene_wake_up
                - script.scene_morning_lights

    - choose:
        - conditions: "{{ trigger.entity_id != 'script.scene_bedtime' }}"
          sequence:
            - service: script.turn_off
              entity_id:
                - script.scene_bedtime
                - script.scene_bedtime_lights

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.light_automation
              state: 'on'

            - condition: template
              alias: Wakup/Bedtime script is not running
              value_template: "{{ is_state('script.scene_wake_up','off') and is_state('script.scene_bedtime','off') }}"

            - condition: template
              alias: Trigger is not scene_wake_up/scene_bedtime # duplicates home/night
              value_template: "{{ trigger.entity_id not in ['script.scene_wake_up','script.scene_bedtime'] }}"
          sequence:
            - service: scene.turn_on
              entity_id: scene.rgb_reset # reset rgb lights to warm

            - delay: 1 # allow light states to chnage

            - service: scene.turn_on
              entity_id: scene.rgb_reset_off # turn rgb lights off

            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Home
                - Guest

            - service: script.activate_scene
              data:
                scene: >
                  {% if is_state('binary_sensor.auto_light_on','on') %} scene.evening
                  {% elif is_state('binary_sensor.illuminance_light_on','on') %} scene.day_lights
                  {% else %} scene.reset_daytime
                  {% endif %}
