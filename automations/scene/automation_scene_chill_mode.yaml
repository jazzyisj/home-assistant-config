#######################################################################################################################
## Scene - Chill Mode On
#######################################################################################################################
- id: scene_chill_mode_on
  alias: "[Scene] Chill Mode On"
  description: "Turn on chill mode scene."
  trigger:
    - platform: state
      entity_id: input_boolean.chill_mode
      to: 'on'
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Night
                - Away
                - Vacation
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.chill_mode

            - service: browser_mod.toast
              data:
                message: "Company mode cannot be turned on in Night or Away mode."
                duration: 30000
      default:
        - variables:
            scene_modes: "{{ ['movie_mode','company_mode'] }}"
            media_types: "{{ ['radio','spotify','spotify_jason','spotify_sheri','youtube'] }}"

        - repeat: # turn off other scenes
            count: "{{ scene_modes|count }}"
            sequence:
              - variables:
                  scene_mode: "{{ scene_modes[repeat.index-1] }}"

              - choose:
                  - conditions: "{{ is_state('input_boolean.' ~ scene_mode,'on') }}"
                    sequence:
                      - service: input_boolean.turn_off
                        target:
                          entity_id: "input_boolean.{{ scene_mode }}"

        - service: script.turn_off
          target:
            entity_id:
              - script.wake_up
              - script.morning_lights
              - script.bedtime
              - script.bedtime_lights

        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.bedtime_delayed

        - service: switch.turn_off
          target:
            entity_id: switch.light_flux_dining_room

        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.light_automation
                  state: 'on'
              sequence:
                - service: script.activate_scene
                  data:
                    scene: >
                      {{ 'chill_lights' if is_state('binary_sensor.nighttime_auto_light','on')
                            or is_state('binary_sensor.daytime_illuminance_light','on')
                          else 'chill_daytime_lights' }}

        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.media_player_automation
                  state: 'on'
              sequence:
                - repeat: # turn off all media type
                    count: "{{ media_types|count }}"
                    sequence:
                      - variables:
                          media_type: "{{ media_types[repeat.index-1] }}"

                      - choose:
                          - conditions: "{{ is_state('binary_sensor.' ~ media_type,'on') }}"
                            sequence:
                              - service: script.media_stop
                                data:
                                  media_type: "{{ media_type }}"

                - service: media_player.turn_off
                  target:
                    entity_id: media_player.living_room_tv

                - service: input_boolean.turn_on
                  target:
                    entity_id: input_boolean.volume_override

                - choose:
                    - conditions:
                        - condition: state
                          entity_id: input_boolean.media_preset_enabled_chill
                          state: 'on'
                      sequence:
                        - service: switch.turn_on
                          target:
                            entity_id: switch.media_preset_chill

        - service: timer.start
          target:
            entity_id: timer.chill_mode
          data:
            duration:
              minutes: "{{ states('input_number.chill_mode_duration')|int }}"

#######################################################################################################################
## Scene - Chill Mode Off
#######################################################################################################################
- id: scene_chill_mode_off
  alias: "[Scene] Chill Mode Off"
  description: "Turn off chill mode scene."
  max_exceeded: silent # recursive call
  trigger:
    - platform: state
      entity_id: input_boolean.chill_mode
      to: 'off'

    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation

    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.chill_mode
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.chill_mode

    - service: timer.cancel
      entity_id: timer.chill_mode

    - condition: state
      entity_id: input_select.occupancy_mode
      state:
        - Home
        - Guest

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.bedtime_delayed

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.media_player_automation
              state: 'on'
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.volume_override

            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ not is_state('media_player.' ~ states('input_select.media_preset_type_chill')|lower,'off') }}"
                  sequence:
                    - service: media_player.turn_off
                      target:
                        entity_id: "media_player.{{ states('input_select.media_preset_type_chill')|lower }}"

    - service: script.tts_play_saved_messages # tts was muted
      data:
        skip_none: true
