###############################################################################
## Scene - Company Mode On
###############################################################################
- id: scene_company_mode_on
  alias: '[Scene] Company Mode On'
  description: 'Turn on company mode scene.'
  trigger:
    - platform: state
      entity_id: input_boolean.company_mode
      to: 'on'
  variables:
    media_sensors: "{{ state_attr('group.media_sensors','entity_id') }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Night
                - Away
                - Vacation
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: input_boolean.company_mode

            - service: browser_mod.toast
              data:
                message: 'Company mode cannot be turned on in Night or Away mode.'
                duration: 30000
      default:
        - variables:
            scene_modes: "{{ ['movie_mode','chill_mode'] }}"

        - repeat: # turn off other scenes
            count: '{{ scene_modes|count }}'
            sequence:
              - variables:
                  scene_mode: '{{ scene_modes[repeat.index-1] }}'

              - choose:
                  - conditions: "{{ is_state('input_boolean.' ~ scene_mode,'on') }}"
                    sequence:
                      - service: input_boolean.turn_off
                        target:
                          entity_id: 'input_boolean.{{ scene_mode }}'

        - service: script.turn_off
          target:
            entity_id:
              - script.waketime
              - script.morning_lights
              - script.bedtime
              - script.bedtime_lights

        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.bedtime_delayed

        - service: switch.turn_off
          target:
            entity_id: switch.light_flux_dining_room

        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.light_automation
                  state: 'on'
              sequence:
                - service: script.activate_scene
                  data:
                    scene: >
                      {{ 'company_lights' if is_state('binary_sensor.nighttime_auto_light','on')
                            or is_state('binary_sensor.daytime_illuminance_light','on')
                          else 'company_daytime_lights' }}

        - choose:
            - conditions:
                - condition: state
                  entity_id: input_boolean.media_player_automation
                  state: 'on'
              sequence:
                - repeat: # turn off all media type
                    count: '{{ media_sensors|count }}'
                    sequence:
                      - choose:
                          - conditions: "{{ is_state(media_sensors[repeat.index-1],'on') }}"
                            sequence:
                              - service: script.media_stop
                                data:
                                  media_type: '{{ media_sensors[repeat.index-1][14:] }}'

                - service: media_player.turn_off
                  target:
                    entity_id: media_player.living_room_tv

                - choose:
                    - conditions:
                        - condition: state
                          entity_id: input_boolean.media_preset_enabled_company
                          state: 'on'
                      sequence:
                        - service: switch.turn_on
                          target:
                            entity_id: switch.media_preset_company

        - service: timer.start
          target:
            entity_id: timer.company_mode
          data:
            duration:
              minutes: "{{ states('input_number.company_mode_duration')|int(0) }}"

###############################################################################
## Scene - Company Mode Off
###############################################################################
- id: scene_company_mode_off
  alias: '[Scene] Company Mode Off'
  description: 'Turn off company mode scene.'
  max_exceeded: silent # recursive call
  trigger:
    - platform: state
      entity_id: input_boolean.company_mode
      to: 'off'

    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation

    - platform: event
      event_type: timer.finished
      event_data:
        entity_id: timer.company_mode
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.company_mode

    - service: timer.cancel
      entity_id: timer.company_mode

    - condition: state
      entity_id: input_select.occupancy_mode
      state:
        - Home
        - Guest

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.bedtime_delayed

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.media_player_automation
              state: 'on'
          sequence:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ is_state('media_player.' ~ states('input_select.media_preset_type_company')|lower,'off') }}"
                  sequence:
                    - service: media_player.turn_off
                      target:
                        entity_id: "media_player.{{ states('input_select.media_preset_type_company')|lower }}"
