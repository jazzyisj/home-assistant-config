#######################################################################################################################
## Media Player Turned Off
#######################################################################################################################
- id: media_player_turned_off
  alias: "[Media Player] Turned Off"
  description: Turn media type boolean off when media player turns off.
  mode: queued
  max: 15 # must be at least number of media players to catch all possible media types
  max_exceeded: error
  variables:
    media_type: >
      {% if is_state('switch.radio','on')
          and (trigger.entity_id == states('sensor.radio_media_player')
            or trigger.entity_id in state_attr('sensor.radio_media_player','players')) %} radio
      {% elif is_state('switch.spotify','on')
          and (trigger.entity_id == states('sensor.spotify_media_player')
            or trigger.entity_id in state_attr('sensor.spotify_media_player','players')) %} spotify
      {% endif %}
  trigger:
    - platform: state
      id: 'error'
      entity_id: !include /config/include/entities/media_player_entities_single.yaml
      to:
        - unavailable
        - unknown
      for:
        seconds: 5 #ISSUE how to reduce time without false triggers

    - platform: state
      id: 'off'
      entity_id: !include /config/include/entities/media_player_entities_single.yaml
      to:
        - idle
        - 'off'
      for:
        seconds: 5 #ISSUE how to reduce time without false triggers
  condition:
    - condition: template
      alias: Media type is valid.
      value_template: "{{ media_type in ['radio','spotify'] }}"

    - condition: template
      alias: Media boolean is on.
      value_template: "{{ is_state('switch.' ~ media_type,'on') }}"

    - condition: template
      alias: Media type resume is not on.
      value_template: "{{ is_state('input_boolean.resume_' ~ media_type,'off') if trigger.id == 'off' else true }}"
  action:
    - choose:
        - conditions: "{{ trigger.id == 'error' }}"
          sequence:
            - service: input_boolean.turn_on
              data:
                entity_id: "input_boolean.{{ media_type }}_failed"

    - service: switch.turn_off
      data:
        entity_id: "switch.{{ media_type }}"
