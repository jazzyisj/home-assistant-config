#######################################################################################################################
## Media Player - Media Off
#######################################################################################################################
- id: media_player_media_turned_off
  alias: "[Media Player] Media Turned Off"
  description: "Turn off media."
  initial_state: true
  mode: queued
  variables:
    media_type: >
      {% if trigger.entity_id == 'input_boolean.radio' %} radio
      {% elif trigger.entity_id in ['input_boolean.spotify','sensor.spotify_media_player'] %} spotify
      {% endif %}
  trigger:
    - platform: state
      id: 'boolean'
      entity_id:
        - input_boolean.radio
        - input_boolean.spotify
      to: 'off'

    - platform: state
      id: 'sensor'
      entity_id: sensor.spotify_media_player # picks up spotify stopped by spotcast/app
      to: 'off'
  condition: >
    {{ is_state('input_boolean.resume_spotify','off') and is_state('input_boolean.spotify','on')
        if trigger.id == 'sensor' else true }}
  action:
    - choose:
        - conditions: "{{ trigger.id == 'sensor' }}"
          alias: Spotify already stopped by spotcast or app
          sequence: # already stopped, just turn boolean off
            - service: automation.turn_off
              target:
                entity_id: automation.media_player_media_turned_off
              data:
                stop_actions: false

            - service: input_boolean.turn_off
              entity_id: input_boolean.spotify

            - service: automation.turn_on
              entity_id: automation.media_player_media_turned_off
      default:
        - wait_template: "{{ is_state('script.media_stop','off') }}" # player might already be off when script done

        - condition: template
          alias: Media type media players are still on
          value_template: > # use input text, spotify sensor might be off, this is false once text is cleared
            {{ expand(states('input_text.active_' ~ media_type ~ '_media_player'))
                |selectattr('state','in',['playing','paused'])|list|count > 0 }}

        - service: script.turn_on
          target:
            entity_id: script.media_stop
          data:
            variables:
              media_type: "{{ media_type }}"
              reset_volume: true
