#######################################################################################################################
## Schedule - Leaving Work
## - turn eco mode off to preheat/cool house at end of scheduled work day
## - default to days shift if shift state unknown
#######################################################################################################################
- id: schedule_leaving_work
  alias: "[Schedule] Leaving Work"
  description: "Override occupancy mode to preheat/cool house at end of work day."
  trigger:
    - platform: template # run at shift dependent leave work commute times
      value_template: >
        {% set leave_time = states('input_datetime.afternoons_leave_work_time')
            if is_state('sensor.current_shift','Afternoons') else states('input_datetime.days_leave_work_time') %}
        {{ is_state('sensor.time',(today_at(leave_time).timestamp() - 1800)|timestamp_custom('%H:%M','unknown')) }}
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - input_boolean.climate_automation
      state: 'on'

    - condition: state
      entity_id: binary_sensor.someone_home
      state: 'off'

    - condition: not
      conditions:
        - condition: state
          entity_id: input_boolean.hvac_presence_override
          state: 'on'

    - condition: or
      conditions:
        - condition: state
          entity_id: person.jason
          state: Work

        - condition: state
          entity_id: person.sheri
          state: Work
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.hvac_presence_override

