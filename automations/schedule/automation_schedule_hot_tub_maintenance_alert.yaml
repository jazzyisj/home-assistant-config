#######################################################################################################################
## Schedule - Hot Tub Maintenance Notification
#######################################################################################################################
- id: schedule_hot_tub_maintenance_notification
  alias: "[Schedule] Hot Tub Maintenance Notification"
  description: "Weekly reminder notification for hot tub maintenance."
  initial_state: true
  mode: single
  trigger:
    - platform: template
      value_template: >
        {{ is_state('sensor.time','18:00') if is_state('sensor.current_shift','Days')
            and is_state('binary_sensor.work_today','on') else is_state('sensor.time','12:00') }}

  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - binary_sensor.alerts_enabled
      state: 'on'

    - condition: time
      weekday:
        - sat
        - mon
        - wed
        - fri

  action:
    - service: notify.mobile_app_jphone
      data:
        title: &hottub_title "Hot Tub Maintenance"
        message: &hottub_message "Hot tub needs weekly maintenance."
        data:
          tag: &hottub_tag hottub_maintenance
          group: General
          channel: General
          importance: normal
          vibrationPattern: '100, 100, 100'
          ledColor: !secret NOTIFY_COLOR
          priority: &hottub_priority high
          ttl: &hottub_ttl 0
          timeout: 86400
          persistent: false
          sticky: false
          clickAction: &hottub_url /lovelace/schedule
          color: !secret NOTIFY_COLOR
          icon_url: &hottub_icon !secret HOTTUB_ICON

    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.jason_home
              state: 'on'

            - condition: state
              entity_id: input_select.occupancy_mode
              state: Home

          sequence:
            - service: notify.push
              data:
                title: *hottub_title
                message: *hottub_message
                target: jlaptop
                data:
                  tag: *hottub_tag
                  timestamp: "{{ as_timestamp(now()) }}"
                  priority: *hottub_priority
                  ttl: *hottub_ttl
                  renotify: true
                  silent: true
                  requireInteraction: false
                  url: *hottub_url
                  image: !secret HOTTUB_IMAGE
                  icon: *hottub_icon
                  badge: !secret HOTTUB_BADGE
                  actions:
                    - title: Close
                      action: close_hottub_maintenance

#######################################################################################################################
## Schedule - Close Hot Tub Maintenance Notifications
#######################################################################################################################
- id: schedule_close_hot_tub_maintenance_notifications
  alias: "[Schedule] Close Hot Tub Maintenance Notifications"
  description: "Dismiss notifications on all devices."
  initial_state: true
  mode: single
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: html5_notification.closed
      event_data:
        tag: hottub_maintenance

    #BUG html5 closed event doesn't work if notification is in tray
    - platform: event
      event_type: html5_notification.clicked
      event_data:
        action: close_hottub_maintenance

    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: hottub_maintenance

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: hottub_maintenance

    - delay:
        seconds: 180 # prevent recursive triggers