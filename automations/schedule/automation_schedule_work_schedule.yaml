###############################################################################
## Schedule - Work Schedule Changed
###############################################################################
- id: schedule_work_schedule_changed
  alias: '[Schedule] Work Schedule Changed'
  description: 'Reset work schedule settings, send notification.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id:
        - input_boolean.work_schedule
        - binary_sensor.work_layoff
        - binary_sensor.work_vacation
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: state
      entity_id: input_select.current_work_shift
      to: ~
  condition:
    - condition: state
      entity_id: input_boolean.schedule_automation
      state: 'on'
  action:
    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: input_boolean.work_schedule
                  state: 'off'

                - condition: state
                  entity_id: binary_sensor.work_layoff
                  state: 'on'

                - condition: state
                  entity_id: binary_sensor.work_vacation
                  state: 'on'
          sequence:
            - service: input_boolean.turn_off
              target:
                entity_id: &work_settings
                  - input_boolean.saturday_workday
                  - input_boolean.sunday_workday
                  - input_boolean.holiday_workday
                  - input_boolean.work_today_off
                  - input_boolean.work_tomorrow_off

    - delay: 15 # allow shift to change, prevent double trigger

    - service: notify.jason
      data:
        title: 'Work Schedule'
        message: >
          Work Schedule: {{ states('input_boolean.work_schedule')|title }}
          <br/>Work Layoff: {{ states('binary_sensor.work_layoff')|title }}
          <br/>Work Vacation: {{ states('binary_sensor.work_vacation')|title }}
          <br/>Work Today: {{ states('binary_sensor.work_today')|title }}
          <br/>Work Tomorrow: {{ states('binary_sensor.work_tomorrow')|title }}
          <br/>Today Shift: {{ states('sensor.work_shift_today')|title }}
          <br/>Tomorrow Shift: {{ states('sensor.work_shift_tomorrow')|title }}
        data:
          tag: work_schedule
          group: General
          channel: General
          importance: max
          ttl: 0
          priority: high
          timeout: 86400
          notification_icon: mdi:factory
          icon_url: !secret WORK_ICON
          ledColor: !secret NOTIFY_COLOR
          color: !secret NOTIFY_COLOR
          vibrationPattern: !secret GENERAL_VIBRATION
          clickAction: /lovelace-mobile/presence
          actions:
            - title: "Work {{ iif(is_state('input_boolean.work_schedule','on'),'Off','On') }}"
              action: work_schedule_toggle

            - title: 'Days'
              action: set_day_shift

            - title: 'Afts'
              action: set_aft_shift

###############################################################################
## Schedule - Work Setting Reset
###############################################################################
- id: schedule_work_setting_reset
  alias: '[Schedule] Work Setting Reset'
  description: 'Turn work setting off if work schedule off.'
  mode: parallel
  trigger:
    - platform: state
      entity_id: *work_settings
      to: 'on'
      from: 'off'
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.work_schedule
          state: 'off'

        - condition: state
          entity_id: binary_sensor.work_layoff
          state: 'on'

        - condition: state
          entity_id: binary_sensor.work_vacation
          state: 'on'
  action:
    - service: automation.turn_off
      target:
        entity_id: &toggle "automation.schedule_toggle_{{ trigger.entity_id.split('.')[1] }}"

    - service: input_boolean.turn_off
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: browser_mod.toast
      data:
        message: 'Work setting cannot be enabled.  Work schedule is not enabled or work layoff/vacation is on.'

    - service: automation.turn_on
      target:
        entity_id: *toggle

###############################################################################
## Schedule - Work Schedule Toggle
###############################################################################
- id: schedule_work_schedule_toggle
  alias: '[Schedule] Work Schedule Toggle'
  description: 'Toggle work schedule.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: work_schedule
  action:
    - service: input_boolean.toggle
      target:
        entity_id: input_boolean.work_schedule

###############################################################################
## Schedule - Work Shift Auto Select
###############################################################################
- id: schedule_work_shift_auto_select
  alias: '[Schedule] Work Shift Auto Select'
  description: 'Select today shift when calendar/selection changes.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.google_calendar_connected
        - binary_sensor.work_layoff
        - binary_sensor.work_vacation
        - input_boolean.work_schedule
        - input_select.current_work_shift
        - binary_sensor.work_today
        - binary_sensor.work_tomorrow
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: state
      id: calendar
      entity_id:
        - calendar.days
        - calendar.afternoons
      to: 'on'
      from: 'off'
      #MIDNIGHT delayed for day reset time, prevent bedtimes missed sunday night aft -> days
      for: "{{ today_at(states('input_datetime.day_reset')) - today_at('00:00') }}"

    - platform: state
      entity_id: input_select.current_work_shift
      to: ~

    - platform: state
      entity_id: input_boolean.work_shift_override
      to: 'off'
      from: 'on'

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - binary_sensor.google_calendar_connected
      state: 'on'

    - condition: state
      entity_id: input_boolean.work_shift_override
      state: 'off'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: >
          {% if is_state('input_boolean.work_schedule','on') %}
            {% if (is_state('input_boolean.work_today_override','on') or is_state('input_boolean.work_tomorrow_override','on'))
                or (is_state('binary_sensor.work_layoff','off') and is_state('binary_sensor.work_vacation','off')) %}
              {% if is_state('calendar.afternoons','on') %} Afternoons
              {% elif is_state('calendar.days','on') %} Days
              {% else %} {{ states('input_select.current_work_shift') }}
              {% endif %}
            {% else %} Off
            {% endif %}
          {% else %} Off
          {% endif %}

###############################################################################
## Schedule - Set Day Shift
###############################################################################
- id: schedule_set_day_shift
  alias: '[Schedule] Set Day Shift'
  description: 'Set day work shift.'
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_day_shift
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_shift_override

    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: Days

###############################################################################
## Schedule - Set Afternoon Shift
###############################################################################
- id: schedule_set_afternoon_shift
  alias: '[Schedule] Set Afternoon Shift'
  description: 'Set afternoon work shift.'
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_aft_shift
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_shift_override

    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: Afternoons

###############################################################################
## Schedule - Toggle Work Today Off
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_automation_toggle_work_today_off
  alias: '[Schedule] Toggle Work Today Off'
  description: 'Toggle work today 2X when boolean changed.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.work_today_off
      to: ~
  action:
    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

###############################################################################
## Schedule - Toggle Work Tomorrow Off
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_automation_toggle_work_tomorrow_off
  alias: '[Schedule] Toggle Work Tomorrow Off'
  description: 'Toggle work today 2X when boolean changed.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.work_tomorrow_off
      to: ~
  action:
    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

###############################################################################
## Schedule - Toggle Saturday Workday
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_automation_toggle_saturday_workday
  alias: '[Schedule] Toggle Saturday Workday'
  description: 'Toggle work today 2X when boolean changed.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.saturday_workday
      to: ~
  action:
    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

###############################################################################
## Schedule - Toggle Saturday Workday
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_automation_toggle_sunday_workday
  alias: '[Schedule] Toggle Sunday Workday'
  description: 'Toggle work today 2X when boolean changed.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.sunday_workday
      to: ~
  action:
    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

###############################################################################
## Schedule - Toggle Holiday Workday
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_automation_toggle_holiday_workday
  alias: '[Schedule] Toggle Holiday Workday'
  description: 'Toggle work today 2X when boolean changed.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_boolean.holiday_workday
      to: ~
  action:
    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

    - service: input_boolean.toggle
      target:
        entity_id: '{{ trigger.entity_id }}'

###############################################################################
## Schedule - Reset Work Off Today
###############################################################################
- id: schedule_automation_reset_work_off_today
  alias: '[Schedule] Reset Work Off Today'
  description: 'Turn boolean off at end of day.'
  trigger:
    # can't be at midnight - cancels delay on
    - platform: time
      at: input_datetime.day_reset
  condition:
    - condition: state
      entity_id: input_boolean.work_today_off
      state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_today_off

###############################################################################
## Schedule - Reset Work Off Tomorrow
###############################################################################
- id: schedule_automation_reset_work_off_tomorrow
  alias: '[Schedule] Reset Work Off Tomorrow'
  description: 'Turn boolean off at end of day turn on work today off boolean.'
  trigger:
    # can't be at midnight - cancels delay on
    - platform: time
      at: input_datetime.day_reset
  condition:
    - condition: state
      entity_id: input_boolean.work_tomorrow_off
      state: 'on'
  action:
    - delay: 5 # let automation.schedule_automation_reset_work_off_today run first

    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_today_off

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_tomorrow_off

###############################################################################
## Schedule - Reset Saturday Workday
###############################################################################
- id: schedule_automation_reset_saturday_workday #VERIFY
  alias: '[Schedule] Reset Saturday Workday'
  description: 'Turn boolean off after Saturday.'
  trigger:
    - platform: template
      value_template: '{{ now().weekday() == 6 }}'
      # can't be at midnight - cancels delay on
      for: "{{ today_at(states('input_datetime.day_reset')) - today_at('00:00') }}"
  condition:
    - condition: state
      entity_id: input_boolean.saturday_workday
      state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.saturday_workday

###############################################################################
## Schedule - Reset Sunday Workday
###############################################################################
- id: schedule_automation_reset_sunday_workday #VERIFY
  alias: '[Schedule] Reset Sunday Workday'
  description: 'Turn boolean off after Sunday.'
  trigger:
    - platform: template
      value_template: '{{ now().weekday() == 0 }}'
      # can't be at midnight - cancels delay on
      for: "{{ today_at(states('input_datetime.day_reset')) - today_at('00:00') }}"
  condition:
    - condition: state
      entity_id: input_boolean.sunday_workday
      state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.sunday_workday

###############################################################################
## Schedule - Reset Holiday Workday
## stays on for multi-day holiday until holidays done
###############################################################################
- id: schedule_automation_reset_holiday_workday
  alias: '[Schedule] Reset Holiday Workday'
  description: 'Turn boolean off after holiday.'
  trigger:
    - platform: state
      entity_id: calendar.work_holiday
      to: 'off'
  condition:
    - condition: state
      entity_id: input_boolean.holiday_workday
      state: 'on'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.holiday_workday
