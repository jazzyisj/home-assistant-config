###############################################################################
## Commute - Before Work
###############################################################################
- id: commute_before_work
  alias: "[Commute] Before Work"
  description: "Play announcement when before work active turns on."
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.work_commute_active
      to:
        - "on"
        - "off"
      not_from:
        - unknown
        - unavailable

    - platform: state
      entity_id: binary_sensor.owner_home
      to: "on"
      not_from:
        - unknown
        - unavailable
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: binary_sensor.work_commute_active
      state: "on"
  action:
    - service: script.turn_on
      target:
        entity_id: script.tts_play
      data:
        variables:
          media_player: media_player.broadcast_speakers
          min_volume: 60
          quiet_play: true
          night_play: true
          message: >
            Hey Jason! Time to get your ass in gear!
            {%- set minutes = state_attr('sensor.leave_home_time','leave_min')|int(none) %}
            {% if minutes != none %}
              {% if minutes == 0 %} You need to leave for work right now!
              {% elif minutes > 0 %} You need to leave for work in {{ minutes }} minute{{ 's' if minutes != 1 }}!
              {%- else %} You should have left for work {{ minutes|abs }} minute{{ 's' if minutes|abs != 1 }} ago!
              {%- endif %}
            {% else %} Your leave home time is not known.
            {% endif %}
            {%- if is_state('alert.jason_phone_battery_low','active') %}
              Your phone battery is down to {{ states('sensor.jphone_battery_level') }} percent.
            {%- endif %}
            {%- if is_state('binary_sensor.rain_today','on') %}
              You should bring an umbrella today, it looks like we might get some rain around {{ state_attr('binary_sensor.rain_today','start_time') }}!
            {%- endif %}
      continue_on_error: true

    - if:
        - condition: state
          entity_id: binary_sensor.rain_today
          state: "on"
      then:
        - service: script.turn_light_on
          data:
            lights: light.dining_room_light_rgb
            rgb_color: "{{ [0,0,255] }}"
            transition: 5
            activate_timer: false
            bypass_timer: true
            override: true
          continue_on_error: true
      else:
        - service: script.turn_light_on
          data:
            lights: light.dining_room_light_rgb
            rgb_color: "{{ [0,255,0] }}"
            transition: 5
            activate_timer: false
            bypass_timer: true
            override: true
          continue_on_error: true
