###############################################################################
## Commute - Before Work
###############################################################################
- id: commute_before_work
  alias: "[Commute] Before Work"
  description: "Play announcement when before work active turns on."
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.work_commute_active
      to: "on"
      not_from:
        - unknown
        - unavailable

    - platform: state
      entity_id: binary_sensor.owner_home
      to: "on"
      not_from:
        - unknown
        - unavailable
      for:
        minutes: 3
  condition:
    - condition: state
      entity_id: binary_sensor.work_commute_active
      state: "on"
  action:
    - service: script.turn_on
      continue_on_error: true
      target:
        entity_id: script.tts_play
      data:
        variables:
          media_player: media_player.broadcast_speakers
          min_volume: 40
          quiet_play: true
          night_play: true
          message: >
            Hey Jay! You better get yer ass in gear!
            {%- set minutes = state_attr('sensor.leave_home_time','leave_min')|int(-1) %}
            {% if minutes > 0 %} You need to leave for work in {{ minutes }} minute{{ 's' if minutes != 1 }}!
            {%- elif minutes == 0 %}  You need to leave for work right now!
            {%- else %} You should have left for work {{ minutes|abs }} minute{{ 's' if minutes|abs != 1 }} ago!
            {%- endif %}
            {%- if is_state('alert.jason_phone_battery_low','active') %}
              Jason, your phone battery is down to {{ states('sensor.jphone_battery_level') }} percent.
            {%- endif %}
            {%- if is_state('binary_sensor.rain_soon','on') %}
              You should also grab an umbrella today, it looks like we might get some rain in the next few hours!
            {%- endif %}

    - service: light.turn_on #TEMP until motion sensor
      entity_id: light.side_entrance_light

    - if:
        - condition: state
          entity_id: binary_sensor.workday_rain #VERIFY
          state: "on"
      then:
        - service: light.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            profile: rain_today
      else:
        - service: light.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            profile: work_commute_active

    - wait_template: >
        {{ is_state('input_select.occupancy_mode','Away')
            or is_state('binary_sensor.work_commute_active','off') }}
      timeout:
        minutes: 60

    - if:
        - condition: state
          entity_id: input_select.occupancy_mode
          state:
            - Home
            - Guest
      then:
        - if:
            - condition: state
              entity_id: light.dining_room_rgb_light
              state: "on"

            - condition: state
              entity_id:
                - binary_sensor.nighttime_illuminance_lights
                - binary_sensor.daytime_illuminance_lights
              match: any
              state: "on"
          then:
            - service: light.turn_on
              target:
                entity_id: light.dining_room_rgb_light
              data:
                profile: default
          else:
            - service: light.turn_off
              target:
                entity_id: light.dining_room_rgb_light
