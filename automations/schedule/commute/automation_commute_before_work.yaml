###############################################################################
## Commute - Before Work
###############################################################################
- id: commute_before_work
  alias: "[Commute] Before Work"
  description: "Play announcement when before work active turns on."
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.work_commute_active
      to: "on"
      from: "off"

    - platform: state
      entity_id: binary_sensor.owner_home
      to: "on"
      from: "off"
      for:
        minutes: 3

    - platform: state
      entity_id: input_boolean.startup_pending
      to: "off"
  condition:
    - condition: state
      entity_id: binary_sensor.work_commute_active
      state: "on"

    - condition: state
      entity_id: input_boolean.startup_pending
      state: "off"
  action:
    - service: script.tts_play
      data:
        media_player: media_player.mass_broadcast_speakers
        min_volume: 40
        quiet_play: true
        night_play: true
        message: >
          Hey! You guys better get yer asses in gear!
          {%- set minutes = state_attr('sensor.leave_home_time','leave_min')|int(-1) %}
          {% if minutes > 0 %} You need to leave for work in {{ minutes }} minute{{ 's' if minutes != 1 }}!
          {%- elif minutes == 0 %}  You need to leave for work right now!
          {%- else %} You should have left for work {{ minutes|abs }} minute{{ 's' if minutes|abs != 1 }} ago!
          {%- endif %}
          {%- if is_state('alert.jason_phone_battery_low','active') %}
            Jason, your phone battery is down to {{ states('sensor.jphone_battery_level') }} percent.
          {%- endif %}

          {%- if is_state('alert.sheri_phone_battery_low','active') %}
            Sheri, you're phone battery is down to {{ states('sensor.sphone_battery_level') }} percent.
          {%- endif %}
          {%- if is_state('binary_sensor.rain_soon','on') %}
            You should also grab an umbrella today, it looks like we might get some rain in the next few hours!
          {%- endif %}

    - service: light.turn_on #TEMP until motion sensor
      entity_id: light.side_entrance_light

    - if:
        - condition: state
          entity_id: binary_sensor.workday_rain
          state: "on"
      then:
        - service: light.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            profile: rain_today
      else:
        - service: light.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            profile: work_commute_active

    - wait_template: >
        {{ is_state('input_select.occupancy_mode','Away')
            or is_state('binary_sensor.work_commute_active','off') }}
      timeout:
        minutes: 60

    - if:
        - condition: state
          entity_id: input_select.occupancy_mode
          state:
            - Home
            - Guest
      then:
        - if:
            - condition: state
              entity_id: light.dining_room_rgb_light
              state: "on"

            - or:
                - condition: state
                  entity_id: binary_sensor.nighttime_illuminance_lights
                  state: "on"

                - condition: state
                  entity_id: binary_sensor.daytime_illuminance_lights
                  state: "on"
          then:
            - service: light.turn_on
              target:
                entity_id: light.dining_room_rgb_light
              data:
                profile: default
          else:
            - service: light.turn_off
              target:
                entity_id: light.dining_room_rgb_light
