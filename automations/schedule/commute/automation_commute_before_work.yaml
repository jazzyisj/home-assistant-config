###############################################################################
## Commute - Before Work
###############################################################################
- id: commute_before_work
  alias: '[Commute] Before Work'
  description: 'Play announcement when before work active turns on.'
  trigger:
    - platform: state
      entity_id: binary_sensor.work_commute_active
      to: 'on'
      from: 'off'
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - input_boolean.commute_alerts
        - binary_sensor.owner_home
      state: 'on'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - service: script.tts_play
      data:
        media_player: media_player.broadcast_speakers
        min_volume: 40
        quiet_play: true
        message: >
          Hey! You guys better get yer asses in gear!
          {%- set minutes = state_attr('sensor.leave_home_time','leave_min')|int(-1) %}
          {% if minutes > 0 %} You need to leave for work in {{ minutes }} minute{{ 's' if minutes != 1 }}!
          {%- elif minutes == 0 %}  You need to leave for work right now!
          {%- else %} You should have left for work {{ minutes|abs }} minute{{ 's' if minutes|abs != 1 }} ago!
          {%- endif %}
          {%- if is_state('alert.jason_phone_battery_low','active') %}
            Jason, your phone battery is down to {{ states('sensor.jphone_battery_level') }} percent.
          {%- endif %}

          {%- if is_state('alert.sheri_phone_battery_low','active') %}
            Sheri, you're phone battery is down to {{ states('sensor.sphone_battery_level') }} percent.
          {%- endif %}
          {%- if is_state('binary_sensor.rain_today','on') %}
            You should also grab an umbrella today, it looks like we might get some rain in the next few hours!
          {%- endif %}

    - condition: state
      entity_id: input_boolean.light_automation
      state: 'on'

    - choose: #TEMP until motion sensor
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.nighttime_illuminance_lights
                  state: 'on'

                - condition: state
                  entity_id: binary_sensor.daytime_illuminance_lights
                  state: 'on'
          sequence:
            - service: light.turn_on
              entity_id: light.side_entrance_light

    #TODO change these to switch LED notification? prework led notification?
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.rain_today
              state: 'on'
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.dining_room_rgb_light
              data:
                profile: rain_today
      default:
        - service: light.turn_on
          target:
            entity_id: light.dining_room_rgb_light
          data:
            profile: work_commute_active

    - wait_template: >
        {{ is_state('input_select.occupancy_mode','Away')
            or is_state('binary_sensor.work_commute_active','off') }}
      timeout:
        minutes: 60

    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Home
                - Guest
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: light.dining_room_rgb_light
                      state: 'on'

                    - condition: or
                      conditions:
                        - condition: state
                          entity_id: binary_sensor.nighttime_illuminance_lights
                          state: 'on'

                        - condition: state
                          entity_id: binary_sensor.daytime_illuminance_lights
                          state: 'on'
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.dining_room_rgb_light
                      data:
                        profile: default
              default:
                - service: light.turn_off
                  target:
                    entity_id: light.dining_room_rgb_light
