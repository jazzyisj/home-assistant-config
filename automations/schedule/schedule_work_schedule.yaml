###############################################################################
## Schedule - Work Schedule Changed
###############################################################################
- id: schedule_work_schedule_changed
  alias: "[Schedule] Work Schedule Changed"
  description: "Reset work schedule settings, send notification."
  mode: restart
  trigger:
    - platform: state
      id: schedule
      entity_id:
        - input_boolean.work_schedule
        - binary_sensor.work_layoff
        - binary_sensor.work_vacation
      to:
        - "on"
        - "off"
      not_from:
        - unknown
        - unavailable

    - platform: state
      id: shift
      entity_id: input_select.current_work_shift
      to:
  action:
    - if:
        - condition: trigger
          id: schedule

        - or:
            - condition: state
              entity_id: input_boolean.work_schedule
              state: "off"

            - condition: state
              entity_id:
                - binary_sensor.work_layoff
                - binary_sensor.work_vacation
              match: any
              state: "on"
      then:
        - service: input_boolean.turn_off
          target:
            entity_id:
              - input_boolean.saturday_workday
              - input_boolean.sunday_workday
              - input_boolean.holiday_workday
              - input_boolean.work_shift_override

        - condition: template
          value_template: "{{ is_state('input_boolean.work_schedule', 'off') }}"

        - service: input_boolean.turn_off
          target:
            entity_id:
              - input_boolean.work_today_on
              - input_boolean.work_today_off
              - input_boolean.work_tomorrow_on
              - input_boolean.work_tomorrow_off
              - input_boolean.work_override_lock

    - delay: 15 # allow reset/shift to change, prevent double trigger

    - service: notify.jason
      data:
        title: "Work Schedule"
        message: |
          Work Schedule: {{ states('input_boolean.work_schedule') | title }}
          Layoff: {{ states('binary_sensor.work_layoff') | title }}
          Vacation: {{ states('binary_sensor.work_vacation') | title }}
          Work Today: {{ states('binary_sensor.work_today') | title }}
          Today Shift: {{ states('sensor.work_shift_today') | title }}
          Work Tomorrow: {{ states('binary_sensor.work_tomorrow') | title }}
          Tomorrow Shift: {{ states('sensor.work_shift_tomorrow') | title }}
        data:
          tag: work_schedule
          timeout: 86400
          notification_icon: mdi:factory
          icon_url: !secret WORK_ICON
          clickAction: /ui-mobile/presence
          actions:
            - title: "Work {{ iif(is_state('input_boolean.work_schedule', 'on'), 'Off', 'On') }}"
              action: work_schedule_toggle

            - title: "Set {{ iif(is_state('sensor.work_shift_today', 'Afts'), 'Days', 'Afts') }}"
              action: "{{ iif(is_state('sensor.work_shift_today', 'Afts'), 'set_day_shift', 'set_aft_shift') }}"

            - title: "Today {{ iif(is_state('binary_sensor.work_today', 'on'), 'Off', 'On') }}"
              action: work_today_toggle

###############################################################################
## Schedule - Work Setting Reset
###############################################################################
- id: schedule_work_setting_reset
  alias: "[Schedule] Work Setting Reset"
  description: "Turn work setting off if work schedule off."
  mode: parallel
  trigger:
    - platform: state
      id: toggle
      entity_id:
        - input_boolean.saturday_workday
        - input_boolean.sunday_workday
        - input_boolean.holiday_workday
        - input_boolean.work_today_on
        - input_boolean.work_today_off
        - input_boolean.work_tomorrow_on
        - input_boolean.work_tomorrow_off
      to: "on"
      for: 2 # allow for toggles

    - platform: state
      entity_id:
        - input_boolean.work_shift_override
        - input_boolean.work_override_lock
      to: "on"
  condition:
    - or:
        - condition: state
          entity_id: input_boolean.work_schedule
          state: "off"

        - condition: state
          entity_id: binary_sensor.work_layoff
          state: "on"

        - condition: state
          entity_id: binary_sensor.work_vacation
          state: "on"
  action:
    - if:
        - condition: trigger
          id: toggle
      then:
        - service: automation.turn_off
          target:
            entity_id: automation.schedule_toggle_workday_booleans

    - service: input_boolean.turn_off
      target:
        entity_id: "{{ trigger.entity_id }}"
      continue_on_error: true

    - service: browser_mod.notification
      data:
        duration: 30000
        message: "Work setting cannot be enabled.  Work schedule is not enabled or work layoff/vacation is on."
      continue_on_error: true

    - if:
        - condition: trigger
          id: toggle
      then:
        - service: automation.turn_on
          target:
            entity_id: automation.schedule_toggle_workday_booleans

###############################################################################
## Schedule - Work Schedule Toggle
###############################################################################
- id: schedule_work_schedule_toggle
  alias: "[Schedule] Work Schedule Toggle"
  description: "Toggle work schedule."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: work_schedule_toggle
  action:
    - service: input_boolean.toggle
      target:
        entity_id: input_boolean.work_schedule

###############################################################################
## Schedule - Work Today Toggle
###############################################################################
- id: schedule_work_today_toggle
  alias: "[Schedule] Work Today Toggle"
  description: "Toggle work today."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: work_today_toggle
  action:
    - if:
        - condition: state
          entity_id: binary_sensor.work_today
          state: "on"
      then:
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.work_today_off

        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.work_today_on
      else:
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.work_today_on

        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.work_today_off

###############################################################################
## Schedule - Work Shift Auto Select
###############################################################################
- id: schedule_work_shift_auto_select
  alias: "[Schedule] Work Shift Auto Select"
  description: "Select today shift when calendar/selection changes."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.google_calendar_connected
        - binary_sensor.work_layoff
        - binary_sensor.work_vacation
        - input_boolean.work_schedule
        - input_select.current_work_shift
        - binary_sensor.work_today
        - binary_sensor.work_tomorrow
      to:
        - "on"
        - "off"
      not_from:
        - unknown
        - unavailable
      for: 2 # allow for toggles

    - platform: state
      entity_id:
        - calendar.days1
        - calendar.days2
        - calendar.afternoons1
        - calendar.afternoons2
      to: "on"
      not_from:
        - unknown
        - unavailable
      #MIDNIGHT delayed for day reset time, prevent bedtimes missed sunday night aft -> days
      for: "{{ states('input_datetime.day_reset') }}"

    - platform: time
      at: input_datetime.day_reset

    - platform: state
      entity_id: input_select.current_work_shift
      to:

    - platform: state
      entity_id: input_boolean.work_shift_override
      to: "off"
  condition:
    - condition: state
      entity_id: input_boolean.work_shift_override
      state: "off"
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: >
          {% if is_state('input_boolean.work_schedule', 'on') %}
            {% if (is_state('input_boolean.work_today_on', 'on') or is_state('input_boolean.work_tomorrow_on', 'on'))
                or (is_state('binary_sensor.work_layoff', 'off') and is_state('binary_sensor.work_vacation', 'off')) %}
              {% if is_state('calendar.afternoons1', 'on') or is_state('calendar.afternoons2', 'on') %} Afternoons
              {% elif is_state('calendar.days1', 'on') or is_state('calendar.days2', 'on') %} Days
              {% else %} {{ states('input_select.current_work_shift') }}
              {% endif %}
            {% else %} Off
            {% endif %}
          {% else %} Off
          {% endif %}

###############################################################################
## Schedule - Set Day Shift
###############################################################################
- id: schedule_set_day_shift
  alias: "[Schedule] Set Day Shift"
  description: "Set day work shift."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_day_shift
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_shift_override

    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: Days

###############################################################################
## Schedule - Set Afternoon Shift
###############################################################################
- id: schedule_set_afternoon_shift
  alias: "[Schedule] Set Afternoon Shift"
  description: "Set afternoon work shift."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: set_aft_shift
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_shift_override

    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: Afternoons

###############################################################################
## Schedule - Toggle Workday Booleans
#BUGFIX toggles work booleans 2X to reset binary_sensor.work_today delay
###############################################################################
- id: schedule_toggle_workday_booleans
  alias: "[Schedule] Toggle Workday Booleans"
  description: "Toggle work today 2X when boolean changed."
  trigger:
    - platform: state
      entity_id:
        - input_boolean.saturday_workday
        - input_boolean.sunday_workday
        - input_boolean.holiday_workday
        - input_boolean.work_tomorrow_on
        - input_boolean.work_today_on
        - input_boolean.work_tomorrow_off
        - input_boolean.work_today_off
      to:
        - "on"
        - "off"
  condition:
    - condition: state
      entity_id: input_boolean.work_schedule
      state: "on"
  action:
    - service: automation.turn_off
      target:
        entity_id: "{{ this.entity_id }}"
      data:
        stop_actions: false

    - service: input_boolean.toggle
      target:
        entity_id: "{{ trigger.entity_id }}"

    - service: input_boolean.toggle
      target:
        entity_id: "{{ trigger.entity_id }}"

    - service: automation.turn_on
      target:
        entity_id: "{{ this.entity_id }}"

###############################################################################
## Schedule - Reset Work Today Off
###############################################################################
- id: schedule_reset_work_today_off
  alias: "[Schedule] Reset Work Today Off"
  description: "Turn boolean off at end of day."
  trigger:
    - platform: time
      at: input_datetime.day_reset

    - platform: state
      entity_id: input_boolean.work_today_on
      to: "on"
      for: 2 # allow for toggles
  condition:
    - condition: state
      entity_id:
        - input_boolean.work_schedule
        - input_boolean.work_today_off
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_today_off

###############################################################################
## Schedule - Reset Work Tomorrow Off
###############################################################################
- id: schedule_reset_work_tomorrow_off
  alias: "[Schedule] Reset Tomorrow Work Off"
  description: "Turn boolean off at end of day, turn on work today off boolean."
  trigger:
    - platform: time
      at: input_datetime.day_reset

    - platform: state
      entity_id: input_boolean.work_tomorrow_on
      to: "on"
      for: 2 # allow for toggles
  condition:
    - condition: state
      entity_id: input_boolean.work_tomorrow_off
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"
  action:
    - delay: 5 # let automation.schedule_reset_work_off_today run first

    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_today_off

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_tomorrow_off

###############################################################################
## Schedule - Reset Work Today On
###############################################################################
- id: schedule_reset_work_today_on
  alias: "[Schedule] Reset Work Today On"
  description: "Turn boolean off at end of day."
  trigger:
    - platform: time
      at: input_datetime.day_reset

    - platform: state
      entity_id: input_boolean.work_today_off
      to: "on"
      for: 2 # allow for toggles
  condition:
    - condition: state
      entity_id: input_boolean.work_today_on
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_today_on

###############################################################################
## Schedule - Reset Work Tomorrow On
###############################################################################
- id: schedule_reset_work_tomorrow_on
  alias: "[Schedule] Reset Work Tomorrow On"
  description: "Turn boolean off at end of day, turn on work today on boolean."
  trigger:
    - platform: time
      at: input_datetime.day_reset

    - platform: state
      entity_id: input_boolean.work_tomorrow_off
      to: "on"
      for: 2 # allow for toggles
  condition:
    - condition: state
      entity_id: input_boolean.work_tomorrow_on
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"
  action:
    - delay: 5 # let automation.schedule_reset_work_on_today run first

    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.work_today_on

    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.work_tomorrow_on

###############################################################################
## Schedule - Reset Saturday Workday
###############################################################################
- id: schedule_reset_saturday_workday
  alias: "[Schedule] Reset Saturday Workday"
  description: "Turn boolean off after Saturday."
  trigger:
    - platform: time
      at: input_datetime.day_reset
  condition:
    - condition: state
      entity_id: input_boolean.saturday_workday
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"

    - condition: template
      alias: "Today is Sunday"
      value_template: "{{ now().weekday() == 6 }}"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.saturday_workday

###############################################################################
## Schedule - Reset Sunday Workday
###############################################################################
- id: schedule_reset_sunday_workday
  alias: "[Schedule] Reset Sunday Workday"
  description: "Turn boolean off after Sunday."
  trigger:
    - platform: time
      at: input_datetime.day_reset
  condition:
    - condition: state
      entity_id: input_boolean.sunday_workday
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"

    - condition: template
      alias: "Today is Monday"
      value_template: "{{ now().weekday() == 0 }}"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.sunday_workday

###############################################################################
## Schedule - Reset Holiday Workday
## stays on for multi-day holiday until holidays done
###############################################################################
- id: schedule_reset_holiday_workday
  alias: "[Schedule] Reset Holiday Workday"
  description: "Turn boolean off after holiday."
  trigger:
    - platform: time
      at: input_datetime.day_reset
  condition:
    - condition: state
      entity_id: input_boolean.holiday_workday
      state: "on"

    - condition: state
      entity_id: input_boolean.work_override_lock
      state: "off"

    - condition: state
      entity_id: calendar.work_holiday
      state: "off"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.holiday_workday
