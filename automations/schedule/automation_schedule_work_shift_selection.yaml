###############################################################################
## Schedule - Work Shift Change
###############################################################################
- id: schedule_work_shift_change
  alias: '[Schedule] Work Shift Change'
  description: 'Notification when work shift changes.'
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.work_shift_today
      from: # template reload - unavailable
        - days
        - afternoons
        - 'off'
      for: 60 # allow auto select to change value
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - input_boolean.schedule_alerts
      state: 'on'

    - condition: template
      alias: 'To state and from state are same value' # selection change back to original value
      value_template: '{{ trigger.to_state.state != trigger.from_state.state }}'
  action:
    - service: notify.jason
      data:
        title: 'Shift Change'
        message: "Current Shift: {{ states('sensor.work_shift_today') }}"
        data:
          tag: shift_change
          group: General
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          notification_icon: mdi:factory
          icon_url: !secret WORK_ICON
          ledColor: !secret MINOR_COLOR
          color: !secret MINOR_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /lovelace-mobile/presence
          actions:
            - title: "Work {{ 'Off' if is_state('input_boolean.work_schedule','on') else 'On' }}"
              action: work_schedule_toggle

            - title: 'Days'
              action: set_day_shift

            - title: 'Afts'
              action: set_aft_shift

###############################################################################
## Schedule - Work Shift Auto Select
###############################################################################
- id: schedule_work_shift_auto_select
  alias: '[Schedule] Work Shift Auto Select'
  description: 'Select today shift when calendar/selection changes.'
  mode: queued
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.google_calendar_connected
        - input_boolean.work_schedule
        - input_select.current_work_shift
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: state
      id: calendar
      entity_id:
        - calendar.days
        - calendar.afternoons
      to: 'on'
      from: 'off'
      for:
        hours: 4 #MIDNIGHT delay shift change 4 hours

    - platform: state
      entity_id: input_boolean.work_shift_override
      to: 'off'
      from: 'on'

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - binary_sensor.google_calendar_connected
      state: 'on'

    - condition: state
      entity_id: input_boolean.work_shift_override
      state: 'off'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - service: input_select.select_option
      target:
        entity_id: input_select.current_work_shift
      data:
        option: >
          {% if is_state('input_boolean.work_schedule','off') %} Off
          {% elif is_state('calendar.afternoons','on') %} Afternoons
          {% elif is_state('calendar.days','on') %} Days
          {% else %} {{ states('input_select.current_work_shift') }}
          {% endif %}
