###############################################################################
## Schedule - Before Work
###############################################################################
- id: schedule_before_work
  alias: '[Schedule] Before Work'
  description: 'Play announcement when before work active turns on.'
  trigger:
    - platform: state
      entity_id: binary_sensor.work_commute_active
      to: 'on'
  condition:
    - condition: state
      entity_id:
        - input_boolean.schedule_automation
        - binary_sensor.owner_home
      state: 'on'
  action:
    - service: script.tts_play
      data:
        message: |
          Hey! You guys better get yer asses in gear!
          You need to leave for work in {{ state_attr('sensor.leave_home_time','leave_min') }} minutes!
          {%- if is_state('alert.mobile_battery_jason','active') %}
            Jason, your phone battery is down to {{ states('sensor.jphone_battery_level') }} percent.
          {%- endif %}
          {%- if is_state('alert.mobile_battery_sheri','active') %}
            Sheri, you're phone battery is down to {{ states('sensor.sphone_battery_level') }} percent.
          {%- endif %}
          {%- if is_state('binary_sensor.rain_today','on') %}
            You should also grab an umbrella today, it looks like we might get some rain in the next few hours!
          {%- endif %}
        quiet_play: true
        min_volume: 50
        media_player: media_player.broadcast_speakers

    - service: scene.create
      data:
        scene_id: prework_active
        entities:
          light.dining_room_rgb_light:
            state: >
              {% set state = states('light.dining_room_rgb_light') %}
              {{ 'off' if state|lower in ['unknown','unavailable','none'] else state }}
            brightness: "{{ state_attr('light.dining_room_rgb_light','brightness')|int(0) }}"
            rgb_color: "{{ state_attr('light.dining_room_rgb_light','rgb_color') }}"

    - choose:
        - conditions:
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.nighttime_illuminance_lights
                  state: 'on'

                - condition: state
                  entity_id: binary_sensor.daytime_illuminance_lights
                  state: 'on'
          sequence:
            - service: light.turn_on
              entity_id: light.side_entrance_light

    #IDEA change these to switch LED notification? prework led notification?
    - choose:
        - conditions:
            - condition: state
              entity_id:
                - input_boolean.weather_automation
                - binary_sensor.rain_today
              state: 'on'
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.light_flux_dining_room

            - service: light.turn_on
              target:
                entity_id: light.dining_room_rgb_light
              data:
                brightness: 255
                rgb_color:
                  - 0
                  - 0
                  - 255

    - delay: 300 # leave rain light on for a bit

    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.commute_alerts
              state: 'on'
          sequence:
            - repeat: # commute alert, must be last, repeat here to keep checking commute alert
                sequence:
                  - choose:
                      - conditions:
                          - condition: template
                            alias: 'First repeat or dining room light timer is idle'
                            value_template: "{{ repeat.index == 1 or is_state('timer.dining_room_light','idle') }}"

                          - condition: or
                            conditions:
                              - condition: state
                                entity_id:
                                  - binary_sensor.jason_home
                                  - binary_sensor.work_commute_jason_alert
                                state: 'on'

                              - condition: state
                                entity_id:
                                  - binary_sensor.sheri_home
                                  - binary_sensor.work_commute_sheri_alert
                                state: 'on'
                        sequence:
                          - service: switch.turn_off
                            target:
                              entity_id: switch.light_flux_dining_room

                          - service: light.turn_on
                            target:
                              entity_id: light.dining_room_rgb_light
                            data:
                              brightness: 255
                              rgb_color:
                                - 186
                                - 0
                                - 175

                  - delay: 60
                until: "{{ is_state('input_select.occupancy_mode','Away') or repeat.index == 60 }}" # 1h total
      default:
        - wait_template: "{{ is_state('input_select.occupancy_mode','Away') }}"
          timeout:
            minutes: 60

    - choose:
        - conditions:
            - condition: state
              entity_id: light.dining_room_rgb_light
              state: 'on'

            - condition: state
              entity_id: input_select.occupancy_mode
              state:
                - Home
                - Guest
          sequence:
            - service: light.turn_on # reset rgb req if off in prework_active scene
              target:
                entity_id: light.dining_room_rgb_light
              data:
                profile: warm_min

            - delay: 1 # allow light states to change

            - service: script.activate_scene
              data:
                scene: prework_active
