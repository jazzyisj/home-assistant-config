#######################################################################################################################
## Weather - NOAA Alerts Weather Alert
#######################################################################################################################
- id: weather_noaa_alerts_weather_alert
  alias: "[Weather] NOAA Alerts Weather Alert"
  description: "Display weather alert on UI play alert/announcement for severe alerts."
  mode: restart
  trigger:
    - platform: state
      entity_id: sensor.noaa_alerts_miz076
  action:
    - choose: # clear alert severity if no active alerts
        - conditions:
            - condition: or
              conditions:
                - condition: numeric_state
                  entity_id: sensor.noaa_alerts_miz076
                  below: 1

                - "{{ states('sensor.noaa_alerts_miz076')|lower in ['unknown','unavailable','none'] }}"
          sequence:
            - service: input_select.select_option
              data:
                entity_id: input_select.previous_noaa_alert_severity
                option: cleared
      default:
        - choose:
            - conditions:
                - condition: template
                  alias: "Current alert is more severe than previous alert, or current alert is extreme"
                  value_template: >
                    {% set previous = states('input_select.previous_noaa_alert_severity') %}
                    {% set current = state_attr('binary_sensor.noaa_weather_alert','severity') %}
                    {{ is_state('binary_sensor.tornado_alert','off')
                        and ((previous == 'severe' and current in ['extreme'])
                          or (previous == 'moderate' and current in ['extreme','severe'])
                          or (previous == 'minor' and current in ['extreme','severe','moderate'])
                          or (previous in ['cleared','unknown','unavailable','none']
                            and current in ['extreme','severe','moderate','minor'])) }}
              sequence:
                - service: script.tts_play
                  data:
                    play_message: |
                      {% if states.sensor.noaa_alerts_miz076.attributes.alerts[0] is defined %}
                        {%- set type = states.sensor.noaa_alerts_miz076.attributes.alerts[0].messageType %}
                        {%- set event = states.sensor.noaa_alerts_miz076.attributes.alerts[0].event %}
                        {%- set headline = states.sensor.noaa_alerts_miz076.attributes.alerts[0].parameters.NWSheadline %}
                        {%- set severity = states.sensor.noaa_alerts_miz076.attributes.alerts[0].severity %}
                        {%- set inst = states.sensor.noaa_alerts_miz076.attributes.alerts[0].instruction %}
                        {%- set start = as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].onset)|timestamp_custom('%_I:%M %p, %A',true) %}
                        {%- set until = as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].expires)|timestamp_custom('%_I:%M %p, %A',true) %}
                        Attention!,
                        The National Weather Service has issued a {{ severity }} weather {{ type }}.
                        There is a {{ event }} in effect at {{ start }}{{ ' until' ~ until if until != None }}.
                        {{ headline[0] ~ '.' if headline != None }}
                        {{ inst ~ '.' if inst != None }}
                      {% endif %}
                    quiet_play: "{{ state_attr('sensor.noaa_alerts_miz076','event_severity')|lower in ['extreme','severe'] }}"
                    save_message: true

        # severity attribute will always be most severe current alert
        - service: input_select.select_option
          target:
            entity_id: input_select.previous_noaa_alert_severity
          data:
            option: "{{ state_attr('binary_sensor.noaa_weather_alert','severity')|lower }}"
