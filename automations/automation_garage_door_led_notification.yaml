#######################################################################################################################
## Garage Door - LED Notification
#######################################################################################################################
- id: garage_door_led_notification
  alias: "[Garage Door] LED Notification"
  description: "Display garage door LED notification."
  initial_state: true
  mode: restart
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_door_open

    - platform: time_pattern
      minutes: '/15'

    # run at startup to update led notifications
    - platform: state
      entity_id: variable.startup_complete
      to: 'true'

  condition:
    - condition: state
      entity_id: input_boolean.garage_door_automation
      state: 'on'

    # if not triggred by garage door, garage door must be open
    - condition: template
      value_template: "{{ trigger.entity_id == 'binary_sensor.garage_door_open' or is_state('binary_sensor.garage_door_open','on') }}"

  action:
    - repeat:
        while:
          - condition: template
            value_template: "{{ repeat.index <= state_attr('group.zwave_led_lights_3','entity_id')|count }}"

        sequence:
          - condition: template
            value_template: >
              {% set l = state_attr('group.zwave_led_lights_3','entity_id') %}
              {{ is_state('zwave.' ~ l[repeat.index-1].split('.')[1],'ready') }}
              
          - service: zwave.set_config_parameter
            data:
              node_id: >
                {% set l = state_attr('group.zwave_led_lights_3','entity_id') %}
                {{ state_attr(l[repeat.index-1],'node_id')|int }}
              parameter: >
                {% set sw = state_attr('group.zwave_switch_lights','entity_id') %}
                {% set l = state_attr('group.zwave_led_lights_3','entity_id') %}
                {{ 8 if l[repeat.index-1] in sw else 16 }} {# switch 8, dimmer 16 #}
              size: 4
              value: !include /config/include/template/led_garage_template.yaml
