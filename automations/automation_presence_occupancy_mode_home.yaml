#######################################################################################################################
## Presence - Occupancy Mode Home
#######################################################################################################################
- id: presence_occupancy_mode_home
  alias: "[Presence] Occupancy Mode Home"
  description: "Home state."
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: Home

  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_boolean.presence_automation
              state: 'on'

          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.owner_home
                      state: 'off'

                  sequence:
                    - service: automation.turn_off
                      data:
                        entity_id: group.occupancy_bypass_automations
                        stop_actions: false

                    # select guest if guest home or previous occupancy mode if not
                    - service: input_select.select_option
                      data:
                        entity_id: input_select.occupancy_mode
                        option: "{{ 'Guest' if states('input_boolean.guest_home') else trigger.from_state.state }}"

                    - service: automation.turn_on
                      entity_id: group.occupancy_bypass_automations

              default:
                - service: input_boolean.turn_off
                  entity_id: input_boolean.guest_home
