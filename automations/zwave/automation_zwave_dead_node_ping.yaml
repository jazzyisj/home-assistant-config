###############################################################################
## ZWave - Ping Dead ZWave Devices
###############################################################################
- id: zwave_ping_dead_devices
  alias: "[ZWave] Ping Dead Devices"
  description: "Auto press ping button for dead zwave nodes."
  mode: queued
  trigger:
    - platform: state
      entity_id: binary_sensor.offline_zwave_devices
      attribute: entity_id
      to: ~

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: ping_offline_zwave_devices
  condition:
    - condition: template
      value_template: >
        {{ true if this.attributes.last_triggered == none
          else now() - this.attributes.last_triggered > timedelta(seconds=60) }}

    - condition: state
      entity_id: binary_sensor.offline_zwave_devices
      state: "on"
  action:
    - repeat:
        sequence:
          - service: button.press
            target:
              entity_id: "{{ state_attr('binary_sensor.offline_zwave_devices','entity_id') }}"

          - wait_template: "{{ is_state('binary_sensor.offline_zwave_devices','off') }}"
            timeout: 300
        until: "{{ repeat.index == 5 or is_state('binary_sensor.offline_zwave_devices','off') }}"
