###############################################################################
## Lock - Jammed Lock
## #TODO this is not triggered if lock is locked by keypad or individually in UI
## https://github.com/jazzyisj/home-assistant-config/issues/19
###############################################################################
- id: lock_jammed_lock
  alias: "[Lock] Jammed Lock"
  description: "Jammed lock notification."
  mode: queued
  trigger:
    - platform: state
      entity_id: binary_sensor.door_lock_jammed
      to: "on"
      from: "off"
  action:
    - service: script.tts_play
      data:
        media_player: media_player.mass_quiet_speakers
        min_volume: 50
        quiet_play: true
        night_play: true
        ignore_away: true
        save_message: true
        message: >
          {%- set sensors = ['input_boolean.back_door_lock_jammed','input_boolean.front_door_lock_jammed',
                'input_boolean.garage_door_lock_jammed','input_boolean.side_door_lock_jammed'] -%}
          {% set msg = namespace(value='') %}
          {% set qty = namespace(value=0) %}
          {% for item in sensors if is_state(item,'on') %}
            {% set qty.value = qty.value|int(0) +1 %}
            {% if not loop.first %}{% set msg.value = msg.value ~ ', ' %}{% endif %}
            {% set msg.value = msg.value + item.split('.')[1]|replace('_door_lock_jammed','')|replace('_',' ')|title %}
          {% endfor %}
          {%- set clist = ', and ' if msg.value.split(', ')|count > 2 else ' and ' -%}
          {%- set plural = 's are' if qty.value|int(0) > 1 else ' is' -%}
          Attention! The {{ clist.join(msg.value.rsplit(', ', 1)) }} Door lock{{ plural }} jammed!

###############################################################################
## Lock - Jammed Reset
###############################################################################
- id: lock_jammed_reset
  alias: "[Lock] Jammed Reset"
  description: "Reset jammed lock notification."
  max_exceeded: silent
  mode: queued
  trigger:
    - platform: event
      id: action
      event_type: mobile_app_notification_action
      event_data:
        action: reset_door_lock_jammed

    - platform: state
      id: lock
      entity_id:
        - lock.back_door_lock
        - lock.front_door_lock
        - lock.garage_door_lock
        - lock.side_door_lock
      to: locked
  condition:
    - condition: state
      entity_id:
        - input_boolean.back_door_lock_jammed
        - input_boolean.front_door_lock_jammed
        - input_boolean.garage_door_lock_jammed
        - input_boolean.side_door_lock_jammed
      match: any
      state: "on"
  action:
    - if: "{{ trigger.id == 'lock' }}"
      then:
        - service: input_boolean.turn_off
          target:
            entity_id: "input_boolean.{{ trigger.entity_id.split('.')[1] }}_jammed"
      else:
        - service: input_boolean.turn_off
          target:
            entity_id:
              - input_boolean.back_door_lock_jammed
              - input_boolean.front_door_lock_jammed
              - input_boolean.garage_door_lock_jammed
              - input_boolean.side_door_lock_jammed

###############################################################################
## Lock - Pause Door Lock Jammed Alert
###############################################################################
- id: lock_pause_door_lock_jammed_alert
  alias: "[Lock] Pause Door Lock Jammed Alert"
  description: "Pause alert."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_door_lock_jammed_alert
  action:
    - service: alert.turn_off
      target:
        entity_id: alert.door_lock_jammed

###############################################################################
## Lock - Clear Door Lock Jammed Notifications
###############################################################################
- id: lock_clear_door_lock_jammed_notifications
  alias: "[Lock] Clear Door Lock Jammed Notifications"
  description: "Clear notifications."
  trigger:
    - platform: state
      entity_id: alert.door_lock_jammed
      to: "off"
  condition: "{{ now() - states.automation.lock_pause_door_lock_jammed_alert.attributes.last_triggered > timedelta(seconds=30) }}"
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: door_lock_jammed
