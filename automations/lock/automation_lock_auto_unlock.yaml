###############################################################################
## Lock - Auto Unlock
###############################################################################
- id: lock_auto_unlock
  alias: "[Lock] Auto Unlock"
  description: "Automatically unlock locks."
  mode: queued
  variables:
    person: >
      {% set action = trigger.event.data['action'] %}
      {% if action in ['disarm_alarm_jason','open_garage_jason'] %} jason
      {% elif action in ['disarm_alarm_sheri','open_garage_sheri'] %} sheri
      {% endif %}
    locks: "{{ ['lock.side_door_lock', 'lock.back_door_lock'] }}"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: disarm_alarm_jason

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: disarm_alarm_sheri

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: open_garage_jason

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: open_garage_sheri
  condition: >
    {{ expand(locks)|selectattr('state','eq','locked')
        |map(attribute='entity_id')|list|count > 0 }}
  action:
    - wait_template: "{{ is_state('alarm_control_panel.master','disarmed') }}"
      timeout: 90
      continue_on_timeout: false

    - choose:
        - conditions: "{{ person == 'jason' }}"
          sequence:
            - service: script.unlock_door_locks
              target:
                entity_id: "{{ locks }}"
              data:
                code: !secret LOCK_JASON #LOCK_USER

        - conditions: "{{ person == 'sheri' }}"
          sequence:
            - service: script.unlock_door_locks
              target:
                entity_id: "{{ locks }}"
              data:
                code: !secret LOCK_SHERI #LOCK_USER
