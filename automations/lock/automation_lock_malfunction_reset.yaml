##############################################################################
## Lock - Malfunction Reset
###############################################################################
- id: lock_malfunction_reset
  alias: "[Lock] Malfunction Reset"
  description: "Reset malfunction lock notification."
  mode: queued
  variables:
    lock: "{{ trigger.entity_id.split('.')[1] if trigger.id == 'lock' else 'all' }}"
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: reset_door_lock_malfunction

    - platform: state
      id: lock
      entity_id:
        - lock.back_door_lock
        - lock.front_door_lock
        - lock.garage_door_lock
        - lock.side_door_lock
      to: ~
      not_from:
        - unknown
        - unavailable
  condition:
    - condition: template
      value_template: "{{ lock == 'all' or is_state('input_boolean.' ~ lock ~ '_malfunction','on') }}"
  action:
    - if: "{{ lock != 'all' }}"
      then:
        - service: input_boolean.turn_off
          target:
            entity_id: "input_boolean.{{ lock }}_malfunction"
      else:
        - service: script.reset_locks
