###############################################################################
## Lock - Set Alarm Mode
###############################################################################
- id: lock_set_alarm_mode
  alias: "[Lock] Set Alarm Mode"
  description: "Set door locks alarm mode."
  mode: queued
  variables:
    locks: >
      {% if trigger.entity_id == 'alarm_control_panel.garage' %} lock.garage_door_lock
      {% else %}
        {{ expand('group.entry_locks')
            |rejectattr('entity_id','eq','lock.garage_door_lock')
            |map(attribute='entity_id')|select('has_value')|list }}
      {% endif %}
  trigger:
    - platform: state
      entity_id:
        - alarm_control_panel.house
        - alarm_control_panel.garage
      to:
        - armed_home
        - armed_night
        - armed_away
        - armed_vacation
        - disarmed
  condition:
    - condition: template
      value_template: "{{ locks|count > 0 }}"
  action:
    - choose:
        - conditions: "{{ is_state(trigger.entity_id,'disarmed') }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: &alarm_mode >
                  {% if trigger.entity_id == 'alarm_control_panel.garage' %}
                    select.garage_door_lock_alarm_mode
                  {% else %}
                    ['select.back_door_lock_alarm_mode','select.front_door_lock_alarm_mode','select.side_door_lock_alarm_mode']
                  {% endif %}
              data:
                option: Alarm Off

        - conditions: "{{ is_state(trigger.entity_id,'armed_home') }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: *alarm_mode
              data:
                option: Alert

            - service: select.select_option
              target:
                entity_id: >
                  {% if trigger.entity_id == 'alarm_control_panel.garage' %}
                    select.garage_door_lock_alarm_alert_sensitivity
                  {% else %}
                    ['select.back_door_lock_alarm_alert_sensitivity','select.front_door_lock_alarm_alert_sensitivity'
                      ,'select.side_door_lock_alarm_alert_sensitivity']
                  {% endif %}
              data:
                option: Less Sensitive

        - conditions: "{{ is_state(trigger.entity_id,'armed_night') }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: *alarm_mode
              data:
                option: Forced Entry

            - service: select.select_option
              target:
                entity_id: &kick >
                  {% if trigger.entity_id == 'alarm_control_panel.garage' %}
                    select.garage_door_lock_alarm_kick_sensitivity
                  {% else %}
                    ['select.back_door_lock_alarm_kick_sensitivity','select.front_door_lock_alarm_kick_sensitivity'
                      ,'select.side_door_lock_alarm_kick_sensitivity']
                  {% endif %}
              data:
                option: Most Sensitive

        - conditions: "{{ states(trigger.entity_id) in ['armed_away','armed_vacation'] }}"
          sequence:
            - service: select.select_option
              target:
                entity_id: *alarm_mode
              data:
                option: Forced Entry

            - service: select.select_option
              target:
                entity_id: *kick
              data:
                option: Most Sensitive
