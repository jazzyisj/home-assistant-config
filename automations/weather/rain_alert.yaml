###############################################################################
## Weather - Rain Alert Notification
###############################################################################
- id: weather_rain_alert_notification
  alias: "[Weather] Rain Alert Notification"
  description: "Rain alert notification."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.rain_alert
      to: "on"

    - platform: time
      at: sensor.rain_start

    - platform: template
      value_template: >
        {{ is_state('binary_sensor.rain_today', 'on')
            and is_state('binary_sensor.work_today', 'on')
            and is_state('sensor.work_shift_today', 'Days')
            and states('sensor.time') == '15:50' }}

    - platform: template
      value_template: >
        {{ is_state('binary_sensor.rain_today', 'on')
            and ((is_state('binary_sensor.work_today', 'on')
                and is_state('sensor.work_shift_today', 'Afternoons'))
              or is_state('binary_sensor.work_today', 'off'))
            and states('sensor.time') == '10:45' }}
  condition:
    - condition: template
      value_template: >
        {{ true if this.attributes.last_triggered == none
            else now() - this.attributes.last_triggered > timedelta(hours=1) }}

    - condition: state
      entity_id: alert.rain_alert
      state: "on"

    - condition: time
      after: "10:00:00"
      before: "22:00:00"
  action:
    - variables:
        url: >
          {%- from 'file.jinja' import snapshot_filename -%}
          {{- snapshot_filename('weather_snapshots', 'windsor_radar') -}}

    - service: camera.snapshot
      target:
        entity_id: camera.windsor_radar
      data:
        filename: "/config/www{{ url }}"
      continue_on_error: true

    - service: notify.jason
      data:
        message: |
          {%- from 'value.jinja' import rain_text -%}
          {{- rain_text() -}}
        data:
          tag: windsor_radar
          group: General
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          visibility: public
          notification_icon: mdi:weather-rainy
          icon_url: !secret STORM_ICON
          image: "/local{{ url }}"
          ledColor: !secret MINOR_COLOR
          color: !secret MINOR_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ui-mobile/storm-radar
          actions:
            - title: "Pause"
              action: pause_alert_rain_alert

###############################################################################
## Weather - Rain Soon Announcement
###############################################################################
- id: weather_rain_soon_announcement
  alias: "[Weather] Rain Soon"
  description: "Reminder if it's going to rain soon."
  trigger:
    - platform: time
      at: sensor.rain_start
  condition:
    - condition: template
      value_template: >
        {{ true if this.attributes.last_triggered == none
            else now() - this.attributes.last_triggered > timedelta(hours=1) }}

    - condition: state
      entity_id: binary_sensor.jason_home
      state: "on"
  action:
    - service: script.tts_play
      data:
        message: |
          Hey Jay! Just a reminder that it's probably going to rain soon.
          Have you left the Jeep windows open again you chucklefuck?
        quiet_play: true

###############################################################################
## Weather - Rain Start Announcement
###############################################################################
- id: weather_rain_start_announcement
  alias: "[Weather] Rain Start Announcement"
  description: "Reminder when it starts raining."
  trigger:
    - platform: state
      entity_id: binary_sensor.rain
      to: "on"
      from: "off"
  condition:
    - condition: template
      value_template: >
        {{ true if this.attributes.last_triggered == none
            else now() - this.attributes.last_triggered > timedelta(hours=1) }}

    - condition: state
      entity_id: binary_sensor.jason_home
      state: "on"
  action:
    - service: script.tts_play
      data:
        message: "Jay, it's starting to rain.  Have you checked the goddamn Jeep windows yet?"
        quiet_play: true
