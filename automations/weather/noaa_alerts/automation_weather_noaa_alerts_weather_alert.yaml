###############################################################################
## Weather - NOAA Weather Alert
###############################################################################
- id: weather_noaa_weather_alert
  alias: '[Weather] NOAA Weather Alert'
  description: 'Display weather alert on UI play alert/announcement for severe alerts.'
  mode: restart
  variables:
    severity: "{{ state_attr('binary_sensor.noaa_weather_alert','severity') }}"
  trigger:
    - platform: state
      entity_id: sensor.noaa_alerts_miz076
      to: ~

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
  condition:
    - condition: state
      entity_id:
        - binary_sensor.noaa_connected
        - binary_sensor.wan_connected
      state: 'on'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    - choose: # clear alert severity if no active alerts
        - conditions:
            - condition: state
              entity_id: binary_sensor.noaa_weather_alert
              state: 'off'
          sequence:
            - service: notify.mobile
              data:
                message: clear_notification
                data:
                  tag: noaa_weather_alert

            - service: input_select.select_option
              target:
                entity_id: input_select.previous_noaa_alert_severity
              data:
                option: cleared
      default:
        - service: notify.mobile
          data:
            title: "{{ state_attr('binary_sensor.noaa_weather_alert','title') }}"
            message: >
              {% set type = state_attr('binary_sensor.noaa_weather_alert','type') %}
              {% set title = state_attr('binary_sensor.noaa_weather_alert','title') %}
              {% set description = state_attr('binary_sensor.noaa_weather_alert','description') %}
              {% set starts = state_attr('binary_sensor.noaa_weather_alert','starts_text') %}
              {% set ends = state_attr('binary_sensor.noaa_weather_alert','ends_text') %}
              {% set active = state_attr('binary_sensor.noaa_weather_alert','active') %}
              There is a {{ severity }} {{ title|lower }}
              {{- ' in effect at ' ~ starts if active and starts|lower not in ['','unknown','unavailable','none'] }}
              {{- ' until ' ~ ends if ends|lower not in ['','unknown','unavailable','none'] }}.
              {{ description -}}
            data:
              tag: noaa_alert
              group: General
              channel: Alert
              importance: max
              ttl: 0
              priority: high
              notification_icon: '{{ states.binary_sensor.noaa_weather_alert.attributes.icon }}'
              icon_url: !secret STORM_ICON
              ledColor: !secret WEATHER_COLOR
              color: !secret WEATHER_COLOR
              vibrationPattern: !secret ALERT_VIBRATION
              clickAction: https://forecast.weather.gov/MapClick.php?x=217&y=186&site=dtx&zmx=&zmy=&map_x=217&map_y=186

        - choose:
            - conditions:
                - condition: or
                  conditions:
                    - condition: template
                      alias: 'Current alert is more severe than previous alert, or current alert is extreme'
                      value_template: >
                        {% set previous = states('input_select.previous_noaa_alert_severity') %}
                        {% set current = state_attr('binary_sensor.noaa_weather_alert','severity') %}
                        {{ is_state('binary_sensor.tornado_alert','off')
                            and ((previous == 'severe' and current == 'extreme')
                              or (previous == 'moderate' and current in ['extreme','severe'])
                              or (previous == 'minor' and current in ['extreme','severe','moderate'])
                              or (previous|lower in ['cleared','unknown','unavailable','none']
                                and current in ['extreme','severe','moderate','minor'])) }}

                    - condition: template
                      alias: 'Startup'
                      value_template: "{{ trigger.entity_id == 'input_boolean.startup_pending' }}"
              sequence:
                - service: script.tts_play
                  data:
                    message: |
                      {% set type = state_attr('binary_sensor.noaa_weather_alert','type') %}
                      {% set title = state_attr('binary_sensor.noaa_weather_alert','title') %}
                      {% set severity = state_attr('binary_sensor.noaa_weather_alert','severity') %}
                      {% set description = state_attr('binary_sensor.noaa_weather_alert','description') %}
                      {% set starts = state_attr('binary_sensor.noaa_weather_alert','starts_text') %}
                      {% set until = state_attr('binary_sensor.noaa_weather_alert','ends_text') %}
                      {% set active = state_attr('binary_sensor.noaa_weather_alert','active') %}
                      The National Weather Service has issued a {{ severity }} weather {{ type }}.
                      There is a {{ title }}
                      {{- ' in effect from ' ~ starts if not active and starts|lower not in ['','unknown','unavailable','none'] }}
                      {{- ' until ' ~ until if until|lower not in ['','unknown','unavailable','none'] }}.
                      {{ description }}
                    quiet_play: "{{ state_attr('sensor.noaa_alerts_miz076','event_severity')|lower in ['extreme','severe'] }}"
                    save_message: true

        # severity attribute will always be most severe current alert
        - service: input_select.select_option
          target:
            entity_id: input_select.previous_noaa_alert_severity
          data:
            option: "{{ state_attr('binary_sensor.noaa_weather_alert','severity')|lower }}"

###############################################################################
## Weather - NOAA Alert Clear Notifications
###############################################################################
- id: weather_noaa_alert_clear_notifications
  alias: '[Weather] NOAA Alert Clear Notifications'
  description: 'Clear weather alert notifications.'
  trigger:
    - platform: state
      entity_id: binary_sensor.noaa_weather_alert
      to: 'off'
      from: 'on'
  action:
    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: noaa_alert
