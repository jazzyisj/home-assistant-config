###############################################################################
## Weather - Rain Soon
###############################################################################
- id: weather_rain_soon
  alias: "[Weather] Rain Soon"
  description: "Notify if it's going to rain soon."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: binary_sensor.rain_soon_alert
      to: "on"
      not_from:
        - unknown
        - unavailable

    - platform: state
      entity_id: binary_sensor.rain_soon
      to: "on"
      not_from:
        - unknown
        - unavailable

    - platform: template
      value_template: >
        {{ is_state('binary_sensor.work_today','on')
            and is_state('sensor.work_shift_today','Days')
            and states('sensor.time') == '15:50' }}

    - platform: template
      value_template: >
        {{ ((is_state('binary_sensor.work_today','on')
                and is_state('sensor.work_shift_today','Afternoons'))
              or is_state('binary_sensor.work_today','off'))
            and states('sensor.time') == '10:45' }}
  condition:
    - condition: state
      entity_id:
        - input_boolean.weather_alerts
        - binary_sensor.jason_home
        - binary_sensor.rain_soon_alert
      state: "on"

    - condition: time
      after: "10:00:00"
      before: "20:00:00"
  action:
    - variables:
        url: "{% from 'file.jinja' import snapshot_filename %}{{ snapshot_filename('weather_snapshots','windsor_radar') }}"

    - service: camera.snapshot
      target:
        entity_id: camera.windsor_radar
      data:
        filename: "/config/www{{ url }}"
      continue_on_error: true

    - service: notify.jason
      data:
        message: >
          {% from 'value.jinja' import rain_soon_text %}
          {{ rain_soon_text() }}
        data:
          tag: windsor_radar
          group: General
          channel: Alert
          importance: max
          ttl: 0
          priority: high
          visibility: public
          notification_icon: mdi:weather-rainy
          icon_url: !secret STORM_ICON
          image: "/local{{ url }}"
          ledColor: !secret MINOR_COLOR
          color: !secret MINOR_COLOR
          vibrationPattern: !secret ALERT_VIBRATION
          clickAction: /ui-mobile/storm-radar
          actions:
            - title: "Pause"
              action: pause_alert_rain_soon
      continue_on_error: true
