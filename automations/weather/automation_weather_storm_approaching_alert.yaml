#######################################################################################################################
## Weather - Storm Approaching Alert
#######################################################################################################################
- id: weather_storm_approaching_alert
  alias: "[Weather] Storm Approaching Alert"
  description: "Play announcement when alert is active."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.storm_approaching
      to: 'on'
  condition: >
    {{ states('sensor.storm_full_direction')|lower not in ['unknown','unavailable','none']
        and states('sensor.nearest_storm_distance')|lower not in ['unknown','unavailable','none'] }}
  action:
    - service: script.tts_play
      data:
        play_message: > #DARKSKY
          {% set dist = states('sensor.nearest_storm_distance')|int %}
          {% set type = states('sensor.precipitation_type')|lower %}
          There is a {{ type if type not in ['unknown','unavailable','none'] }} storm {{ dist }}
          {{ 'kilometer' if dist == 1 else 'kilometers' }} away, approaching from the {{ states('sensor.storm_full_direction') }}.
          {% if states('sensor.dark_sky_minutely_summary')|lower not in ['unknown','unavailable','none'] %}
          The current forecast is {{ states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than') }}
          {% endif %}

    - delay: # prevent automation from firing again for a while - fires too often with scattered showers
        hours: 4

#######################################################################################################################
## Weather - Pause Storm Approaching Alert
#######################################################################################################################
- id: weather_pause_storm_approaching_alert
  alias: "[Weather] Pause Storm Approaching Alert"
  description: "Pause alert."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_storm_approaching
  action:
    - service: alert.turn_off
      entity_id: alert.storm_approaching