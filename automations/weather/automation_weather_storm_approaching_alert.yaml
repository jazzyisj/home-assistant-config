###############################################################################
## Weather - Storm Approaching Alert
###############################################################################
- id: weather_storm_approaching_alert #DARKSKY
  alias: "[Weather] Storm Approaching Alert"
  description: "Play announcement when alert is active."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.storm_approaching
      to: "on"
      for:
        minutes: 5
  action:
    - service: script.tts_play
      data:
        message: >
          {% set dist = states('sensor.nearest_storm_distance')|int(-1) %}
          {% set dir = states('sensor.storm_full_direction') %}
          {% set type = states('sensor.precipitation_type') %}
          There is a {{ type if type not in ['unknown','unavailable'] }} storm
          {{ dist if dist > 0 else ' in the immediate vicinity' }}
          {{ ' kilometer away,' if dist == 1 else ' kilometers away' if dist > 1 }}
          {{ ', approaching from the ' ~ dir if dir not in ['unknown','unavailable'] }}.
          {% if states('sensor.dark_sky_minutely_summary') not in ['unknown','unavailable'] %}
          The current forecast is {{ states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than') }}
          {% endif %}

    - delay: # fires too often with scattered showers
        hours: 4

###############################################################################
## Weather - Pause Storm Approaching Alert
###############################################################################
- id: weather_pause_storm_approaching_alert
  alias: "[Weather] Pause Storm Approaching Alert"
  description: "Pause alert."
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_storm_approaching
  action:
    - service: alert.turn_off
      target:
        entity_id: alert.storm_approaching

###############################################################################
## Weather - Clear Storm Approaching Notifications
###############################################################################
- id: weather_clear_storm_approaching_notifications
  alias: "[Weather] Clear Storm Approaching Notifications"
  description: "Clear notifications."
  trigger:
    - platform: state
      entity_id: alert.storm_approaching
      to: "off"
  condition: "{{ now() - states.automation.weather_pause_storm_approaching_alert.attributes.last_triggered > timedelta(seconds=30) }}"
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: storm_approaching
