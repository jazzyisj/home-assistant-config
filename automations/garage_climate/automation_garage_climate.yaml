#######################################################################################################################
## Garage Climate - Auto Off
#######################################################################################################################
- id: garage_climate_auto_off
  alias: "[Garage Climate] Auto Off"
  description: Turn garage furnace off when conditions are met.
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation

  condition:
    - condition: state
      entity_id: input_boolean.garage_climate_automation
      state: 'on'

    - condition: not
      conditions:
        - condition: state
          entity_id: climate.garage_thermostat
          state: 'off'

  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.garage_heat

#######################################################################################################################
## Garage Climate - Door Opened Heat On
## - delay to allow door open scripts to run and allow delay
## - don't run if door closed after delay
#######################################################################################################################
- id: garage_climate_door_opened_heat_on
  alias: "[Garage Climate] Door Opened Heat On"
  initial_state: true
  description: Turn heat back off until garage door closed.
  mode: single
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_door_open
      to: 'on'
      for:
        seconds: 90

  condition:
    - condition: state
      entity_id: input_boolean.garage_climate_automation
      state: 'on'

    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.garage_heat
          state: 'on'

        - condition: state
          entity_id: input_boolean.garage_freeze_protection
          state: 'on'

  action:
    # turn off garage heat, do not turn off boolean switch here or heat won't turn back on when door closes
    - service: script.garage_climate_off

    - service: script.tts_play
      data:
        play_message: "The garage heat has been turned off because the door has opened."

    # wait 15 min, if door doesn't close quit - heat stays off
    - wait_template: "{{ is_state('binary_sensor.garage_door_open','off') }}"
      timeout:
        minutes: 15
      continue_on_timeout: false

    - service: script.garage_climate_on

    # allow temperature change to register
    # heat may have been turned off/adjusted in hassio while door was open
    - wait_template: >
        {% if is_state('climate.garage_thermostat','heat') %}
          {% if is_state('input_boolean.garage_heat','on') %}
            {{ true if state_attr('climate.garage_thermostat','temperature')|float ==  states('input_number.garage_heat_temperature')|float }}
          {% else %}{
            {{ true if state_attr('climate.garage_thermostat','temperature')|float ==  states('input_number.garage_freeze_temperature')|float }}
          {% endif %}
        {% else %} true
        {% endif %}
      timeout:
        minutes: 5
      continue_on_timeout: false

    - service: script.tts_play
      data:
        play_message: |
            The garage heat has been turned back on.
            The thermostat is set to {{ state_attr('climate.garage_thermostat','temperature') }} degrees.
            The current garage temperature is {{ state_attr('climate.garage_thermostat','current_temperature') }} degrees.

#######################################################################################################################
## Garage Climate - Freeze Protection Changed
#######################################################################################################################
- id: garage_freeze_protection_chanaged
  alias: "[Garage Climate] Freeze Protection Changed"
  description: Update thermostat, play announcement.
  initial_state: true
  mode: single
  trigger:
    - entity_id: input_boolean.garage_freeze_protection
      platform: state

  condition:
    # only set if garage heat not already on
    - condition: state
      entity_id: input_boolean.garage_heat
      state: 'off'

  action:
    - service: >
        {{ 'script.garage_climate_on' if is_state('input_boolean.garage_freeze_protection','on') else 'script.garage_climate_off' }}

    # allow thermostat state change to register
    # if garage door open heat should still be off - test first or we get stuck waiting!
    - wait_template: >
        {% if is_state('binary_sensor.garage_door_open','on') %}{{ is_state('climate.garage_thermostat','off') }}
        {% elif is_state('input_boolean.garage_freeze_protection','on') %}{{ is_state('climate.garage_thermostat','heat') }}
        {% else %}{{ is_state('climate.garage_thermostat','off') }}
        {% endif %}
      timeout:
        minutes: 2
      continue_on_timeout: true

    # allow temperature change to register on thermostat before continuing or wrong temp reported
    - wait_template: >
        {% if is_state('climate.garage_thermostat','heat') %}
          {% if is_state('input_boolean.garage_freeze_protection','on') %}
            {% if state_attr('climate.garage_thermostat','temperature')|float ==  states('input_number.garage_freeze_temperature')|float %}  true
            {% else %} false
            {% endif %}
          {% else %} true
          {% endif %}
        {% else %} true
        {% endif %}
      timeout:
        minutes: 1
      continue_on_timeout: true

    # turn off freeze protection boolean if thermostat not in heat mode (thermostat didn't switch modes)
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.garage_thermostat
                  state: heat

          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.garage_freeze_protection

    - service: script.tts_play
      data:
        play_message: |
          {%- if is_state('input_boolean.garage_freeze_protection','on') %}
            {%- if is_state('climate.garage_thermostat','heat') %}
              The garage freeze protection has been turned on.
              The current garage temperature is {{ state_attr('climate.garage_thermostat','current_temperature') }} degrees.
            {%- else %} The garage freeze protection could not be turned on.
            {%- endif %}
          {%- else %} The garage freeze protection has been turned off.
          {%- endif %}

#######################################################################################################################
## Garage Climate - Freeze Temp Adjusted (Hassio)
#######################################################################################################################
- id: garage_climate_freeze_temp_adjusted
  alias: "[Garage Climate] Freeze Temp Adjusted"
  description: Freeze temperature adjusted, update thermostat and play announcement.
  initial_state: true
  mode: restart
  trigger:
    - entity_id: input_number.garage_freeze_temperature
      platform: state

  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.garage_freeze_protection
          state: 'on'

        # only run if heat is off (heat temp takes precedence)
        - condition: state
          entity_id: input_boolean.garage_heat
          state: 'off'

  action:
    # wait for zwave to be ready, cancel if not
    #BUGFIX - zwave dropping out
    - wait_template: "{{ is_state('zwave.garage_thermostat','ready') }}"
      timeout:
        minutes: 5
      continue_on_timeout: false

    - service: climate.set_temperature
      data:
        entity_id: climate.garage_thermostat
        temperature: "{{ states('input_number.garage_freeze_temperature')|int }}"

    # wait for thermostat temp = set temp
    - wait_template: "{{ states('input_number.garage_freeze_temperature')|float == state_attr('climate.garage_thermostat','temperature')|float }}"
      timeout:
        minutes: 2
      continue_on_timeout: true

    - service: script.tts_play
      data:
        play_message: |
            The garage thermostat has been set to {{ '%0.0f'|format(state_attr('climate.garage_thermostat','temperature')|float) }} degrees.
            The current garage temperature is {{ '%0.0f'|format(state_attr('climate.garage_thermostat','current_temperature')|float) }} degrees.

#######################################################################################################################
## Garage Climate - Heat Changed
#######################################################################################################################
- id: garage_climate_heat_changed
  alias: "[Garage Climate] Heat Changed"
  description: Garage heat turned on or off.  Update thermostat, play announcement.
  initial_state: true
  mode: single
  trigger:
    - entity_id: input_boolean.garage_heat
      platform: state

  action:
    - service: "{{ 'script.garage_climate_on' if is_state('input_boolean.garage_heat','on') else 'script.garage_climate_off' }}"

    # allow thermostat state change to register
    # if garage door is open heat should be off even if boolean is on - test first or we get stuck waiting!
    - wait_template: >
        {% if is_state('binary_sensor.garage_door_open','on') %}{{ is_state('climate.garage_thermostat','off') }}
        {% elif is_state('input_boolean.garage_heat','on') %}{{ is_state('climate.garage_thermostat','heat') }}
        {% else %}{{ is_state('climate.garage_thermostat','off') }}
        {% endif %}
      timeout:
        minutes: 1
      continue_on_timeout: true

    # if heat on allow temperature change to register before continuing or wrong set temp reported
    # if heat is off but freeze on, allow temp to change to freeze temp before continuing or wrong set temp reported
    # just continue if thermostat is off
    - wait_template: >
        {% if is_state('climate.garage_thermostat','heat') %}
          {% if is_state('input_boolean.garage_heat','on') %}
            {{ state_attr('climate.garage_thermostat','temperature')|float ==  states('input_number.garage_heat_temperature')|float }}
          {% else %}
            {{ state_attr('climate.garage_thermostat','temperature')|float ==  states('input_number.garage_freeze_temperature')|float }}
          {% endif %}
        {% else %} true
        {% endif %}
      timeout:
        minutes: 1
      continue_on_timeout: true

    # turn off garage heat boolean if thermostat not in heat mode (thermostat didn't switch modes)
    - choose:
        - conditions:
            - condition: not
              conditions:
                - condition: state
                  entity_id: climate.garage_thermostat
                  state: heat

          sequence:
            - service: input_boolean.turn_off
              entity_id: input_boolean.garage_heat

    - service: script.tts_play
      data:
        play_message: |
          {%- if is_state('input_boolean.garage_heat','on') %}
            {%- if is_state('climate.garage_thermostat','heat') %}
              The garage heat has been turned on.
              The thermostat is set to {{ state_attr('climate.garage_thermostat','temperature') }} degrees.
              The current garage temperature is {{ state_attr('climate.garage_thermostat','current_temperature') }} degrees.
            {%- else %} The garage heat could not be turned on.
            {%- endif %}
          {%- elif is_state('input_boolean.garage_freeze_protection','on') %}
            {%- if is_state('climate.garage_thermostat','heat') %}
              The garage freeze protection has been turned back on.
              The current garage temperature is {{ state_attr('climate.garage_thermostat','current_temperature') }} degrees.
            {%- else %} The garage freeze protection could not be turned back on.
            {%- endif %}
          {%- else %}  The garage heat has been turned off.
          {%- endif %}

#######################################################################################################################
## Garage Climate - Heat On Door Open
#######################################################################################################################
- id:  garage_climate_heat_on_door_open
  alias: "[Garage Climate] Heat On Door Open"
  description: Turn garage heat back off until garage door closed.
  initial_state: true
  mode: single
  trigger:
    - entity_id: climate.garage_thermostat
      platform: state
      to: heat

  condition:
    - condition: state
      entity_id:
        - input_boolean.garage_climate_automation
        - binary_sensor.garage_door_open
      state: 'on'

  action:
    # turn off garage heat, do not turn off boolean switch here or heat won't turn on when door closes
    - service: script.garage_climate_off

    - service: script.tts_play
      data:
        play_message: "The heat will turn on when the garage door closes."

    # wait 15 min for door to close to try again, if door still isn't closed cancel
    - wait_template: "{{ is_state('binary_sensor.garage_door_open','off') }}"
      timeout:
        minutes: 15
      continue_on_timeout: false

    - service: script.garage_climate_on

#######################################################################################################################
## Garage Climate - Heat Temp Adjusted
#######################################################################################################################
- id: garage_climate_heat_temp_adjusted
  alias: "[Garage Climate] Heat Temp Adjusted"
  description: Heat temperature adjusted, update thermostat and play announcement.
  initial_state: true
  mode: restart
  trigger:
    - entity_id: input_number.garage_heat_temperature
      platform: state

  condition:
    - condition: state
      entity_id: input_boolean.garage_heat
      state: 'on'

  action:
    # wait for zwave to be ready, cancel if not
    #BUGFIX - zwave dropping out
    - wait_template: "{{ is_state('zwave.garage_thermostat','ready') }}"
      timeout:
        minutes: 5
      continue_on_timeout: false

    - service: climate.set_temperature
      data:
        entity_id: climate.garage_thermostat
        temperature: "{{ states('input_number.garage_heat_temperature')|int}}"

    # wait for thermostat temp = set temp before announcement
    - wait_template: "{{ states('input_number.garage_heat_temperature')|float == state_attr('climate.garage_thermostat','temperature')|float }}"
      timeout:
        minutes: 2
      continue_on_timeout: true

    - service: script.tts_play
      data:
        play_message: |
            The garage thermostat has been set to {{ '%0.0f'|format(state_attr('climate.garage_thermostat','temperature')|float) }} degrees.
            The garage temperature is {{ '%0.0f'|format(state_attr('climate.garage_thermostat','current_temperature')|float) }} degrees.

#######################################################################################################################
## Garage Climate - Thermostat Adjusted
#######################################################################################################################
- id: garage_climate_thermostat_adjusted
  alias: "[Garage Climate] Thermostat Adjusted"
  description: Garage thermostat turned on or off, update hassio.
  initial_state: true
  mode: restart
  trigger:
    - platform: state
      entity_id: climate.garage_thermostat
      to:
       - heat
       - 'off'

  action:
    - service: automation.turn_off
      entity_id: automation.garage_climate_heat_changed

    # turn heat on if thermostat turned on or else turn it off
    - service: "{{ 'input_boolean.turn_on' if is_state('climate.garage_thermostat','heat') else 'input_boolean.turn_off' }}"
      entity_id: input_boolean.garage_heat

    - service: automation.turn_on
      entity_id: automation.garage_climate_heat_changed

#######################################################################################################################
## Garage Climate - High Temperature Alert
## - allow 5 minutes for temperature fluxuation
## - turn off the garage climate (freeze protection should stay on but temp should reset)
#######################################################################################################################
- id: garage_climate_high_temperature_alert
  alias: "[Garage Climate] High Temperature Alert"
  description: Play TTS announcement when alert turns on.
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: alert.garage_climate_high_temperature
      to: 'on'

  action:
    # turn the garage climate off - something is wrong!
    #DISABLED no thermostat - service: script.garage_climate_off

    - repeat:
        sequence:
          - service: script.tts_play
            data:
              play_message: |
                Attention!
                The garage high temperature alert is active.
                The garage temperature is {{ '%0.0f'|format(states('sensor.garage_temperature')|float) }} degrees,
                and the thermostat is set to {{ '%0.0f'|format(state_attr('climate.garage_thermostat','temperature')|float) }} degrees.
              quiet_play: true

          # wait for alert to turned off/dismissed
          - wait_template: "{{ not is_state('alert.garage_climate_high_temperature','on') }}"
            timeout:
              minutes: 15

        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: alert.garage_climate_high_temperature
                state: 'on'

#######################################################################################################################
## Garage Climate - Close High Temperature Notifications
#######################################################################################################################
- id: garage_climate_close_high_temperature_notifications
  alias: "[Garage Climate] Close High Temperature Notifications"
  description: Dismiss notifications on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.garage_high_temperature
      to:
        - idle
        - 'off'

    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: garage_high_temperature

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_garage_high_temperature

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: garage_high_temperature
        pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_garage_high_temperature' }}{% endif %}"

    - delay:
        seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Garage Climate - Low Temperature Alert
## - allow 5 minutes for temperature fluxuation
## - turn off the garage climate (freeze protection should stay on but temp should reset)
#######################################################################################################################
- id: garage_climate_low_temperature_alert
  alias: "[Garage Climate] Low Temperature Alert"
  description: Play TTS announcement when alert turns on.
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: alert.garage_low_temperature
      to: 'on'

  action:
    # turn the garage climate off - something is wrong!
    #DISABLED no thermostat - service: script.garage_climate_off

    - repeat:
        sequence:
          - service: script.tts_play
            data:
              play_message: |
                Attention!
                The garage low temperature alert is active.
                The garage temperature is {{ '%0.0f'|format(states('sensor.garage_temperature')|float) }} degrees,
                and the thermostat is set to {{ '%0.0f'|format(state_attr('climate.garage_thermostat','temperature')|float) }} degrees.
              quiet_play: true

          # wait for alert to turned off/dismissed
          - wait_template: "{{ not is_state('alert.garage_low_temperature','on') }}"
            timeout:
              minutes: 15

        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: alert.garage_low_temperature
                state: 'on'

#######################################################################################################################
## Garage Climate - Close Low Temperature Notifications
#######################################################################################################################
- id: garage_climate_close_low_temperature_notifications
  alias: "[Garage Climate] Close Low Temperature Notifications"
  description: Dismiss notifications on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.garage_low_temperature
      to:
        - idle
        - 'off'

    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: garage_low_temperature

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_garage_low_temperature

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: garage_low_temperature
        pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_garage_low_temperature' }}{% endif %}"

    - delay:
        seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Garage Climate - Extended Heat Alert
#######################################################################################################################
- id: garage_climate_garage_extended_heat_alert
  alias: "[Garage Climate] Extended Heat Alert"
  description: Play TTS announcement when alert turns on.
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: alert.garage_extended_heat
      to: 'on'

  condition:
    - condition: state
      entity_id: input_boolean.garage_climate_automation
      state: 'on'

  action:
    - repeat:
        sequence:
          - service: script.tts_play
            data:
              play_message: |
                Attention!
                The garage heat has been on for a while.
                The garage temperature is {{ '%0.0f'|format(states('sensor.garage_temperature')|float) }} degrees.
              quiet_play: true
              min_volume: 30
              save_message: true

          # wait for alert to turned off/dismissed
          - wait_template: "{{ not is_state('alert.garage_extended_heat','on') }}"
            timeout:
              minutes: 20

        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: alert.garage_extended_heat
                state: 'on'

#######################################################################################################################
## Garage Climate - Close Extended Heat Notifications
#######################################################################################################################
- id: garage_climate_close_extended_heat_notifications
  alias: "[Garage Climate] Close Extended Heat Notifications"
  description: Dismiss notifications on all devices.
  initial_state: true
  mode: single
  #max_exceeded: silent
  trigger:
    - platform: state
      entity_id: alert.garage_extended_heat
      to:
        - idle
        - 'off'

    - platform: event
      event_type: mobile_app_notification_cleared
      event_data:
        tag: garage_extended_heat

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_garage_extended_heat

  action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: garage_extended_heat
        pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_garage_extended_heat' }}{% endif %}"

    - delay:
        seconds: 180 # prevent recursive triggers