###############################################################################
## Garage Climate - High Temperature Alert
###############################################################################
- id: garage_climate_high_temperature_alert
  alias: '[Garage Climate] High Temperature Alert'
  description: 'Play announcement when alert turns on.'
  trigger:
    - platform: state
      entity_id: alert.garage_high_temperature
      to: 'on'
      for:
        minutes: 5
  action:
    # turn the garage climate off - something is wrong!
    - service: switch.turn_off
      target:
        entity_id: switch.garage_heat

    - service: script.tts_play
      data:
        message: >
          Attention!
          The garage heat has been turned off because the high temperature alert is active.
          The garage temperature is {{ '%0.1f'|format(states('sensor.garage_sensor_air_temperature')|float(-99)) }} degrees,
          and the thermostat is set to {{ '%0.1f'|format(state_attr('climate.garage_thermostat','temperature')|float(-99)) }} degrees.
        quiet_play: true
        night_play: true
        save_message: true

###############################################################################
## Garage Climate - Pause High Temperature Alert
###############################################################################
- id: garage_climate_pause_high_temperature_alert
  alias: '[Garage Climate] Pause High Temperature Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_garage_high_temperature
  action:
    - service: alert.turn_off
      entity_id: alert.garage_high_temperature

###############################################################################
## Garage Climate - Clear High Temperature Notifications
###############################################################################
- id: garage_climate_clear_high_temperature_notifications
  alias: '[Garage Climate] Clear High Temperature Notifications'
  description: 'Clear notifications.'
  trigger:
    - platform: state
      entity_id: alert.garage_high_temperature
      to: 'off'
  condition: '{{ now() - states.automation.garage_climate_pause_high_temperature_alert.attributes.last_triggered > timedelta(seconds=30) }}'
  action:
    - service: notify.jason
      data:
        message: clear_notification
        data:
          tag: garage_high_temperature
