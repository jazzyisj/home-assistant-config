###############################################################################
## Notify Update LED Notification Groups
###############################################################################
- id: notify_update_notify_led_notification_groups
  alias: '[Notify] Update LED Notification Groups'
  description: 'Update LED notification groups.'
  mode: restart
  trigger:
    - platform: homeassistant
      id: startup
      event: start

    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'

    # catch any entities slow to load
    - platform: state
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
      for: 900

    - platform: time_pattern
      hours: '*'
  action:
    - service: group.set
      data:
        object_id: notify_led
        entities: >
          {{ states|selectattr('domain','in',['light','switch'])
              |selectattr('attributes.notify_led','eq',true)|map(attribute='entity_id')|list }}

    - wait_template: "{{ state_attr('group.notify_led','entity_id') != none }}"
      timeout:
        minutes: 10
      continue_on_timeout: false

    - service: group.set
      data:
        object_id: dimmer_led
        entities: >
          {{ expand('group.notify_led')|selectattr('domain','eq','light')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: switch_led
        entities: >
          {{ expand('group.notify_led')|selectattr('domain','eq','switch')
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: alarm_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.alarm_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: presence_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.presence_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: scene_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.scene_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: reminder_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.reminder_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: garage_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.garage_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: alarm_clock_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.alarm_clock_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: led_hass
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.led_hass','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: shower_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.shower_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: media_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.media_led','eq',true)
              |map(attribute='entity_id')|list }}

    - service: group.set
      data:
        object_id: weather_led
        entities: >
          {{ expand('group.notify_led')|selectattr('attributes.weather_led','eq',true)
              |map(attribute='entity_id')|list }}
