###############################################################################
## Notify - LED Notification
###############################################################################
- id: notify_led_notification
  alias: '[Notify] LED Notification'
  description: 'Set LED notification.'
  mode: queued
  max: 50
  max_exceeded: error
  variables:
    entities: >
      {% if trigger.entity_id == 'input_boolean.alarm_triggered'
          or trigger.from_state.state == 'triggered' %} {% set alert_type = 'notify' %}
      {% else %} {% set alert_type = trigger.id %}
      {% endif %}
      {{ state_attr('group.led_' ~ alert_type,'entity_id') }}
  trigger:
    - platform: state
      id: media
      entity_id: switch.system_mute
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: numeric_state
      id: media
      entity_id: variable.tts_saved_messages
      above: 0

    - platform: numeric_state
      id: media
      entity_id: variable.tts_saved_messages
      below: 1

    - platform: state
      id: alarm_clock
      entity_id:
        - binary_sensor.alarm_clock
        - input_boolean.alarm_clock_failed # use boolean, no delay
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: state
      id: alarm
      entity_id:
        - input_boolean.alarm_triggered
        - alert.door_lock_jammed
        - alert.door_lock_failed
        - alert.alarm_connected
        - alert.alarm_zone_sync
        - binary_sensor.alarm_open_sensor_alert
        - binary_sensor.alarm_bypassed_sensor_alert
      to:
        - 'on'
        - 'off'
        - 'idle'
      from:
        - 'on'
        - 'off'
        - 'idle'

    - platform: state
      id: alarm
      entity_id: alarm_control_panel.master
      to: # triggered - input_boolean.alarm_triggered
        - armed_home
        - armed_night
        - armed_away
        - arming
        - pending
        - disarmed
      for: 2 # avoid triggering on temp state changes, allow open/bypass sensor to set

    - platform: state
      id: reminder
      entity_id:
        - input_boolean.maddie_mealtime_active
        - input_boolean.dexter_medication_active
        - input_boolean.jason_medication_active
        - input_boolean.hot_tub_maintenance_active
        - input_boolean.garbage_alert
        - input_boolean.recycle_alert
        - input_boolean.yardwaste_alert
      to: ~

    - platform: state
      id: weather
      entity_id:
        - binary_sensor.outdoor_high_temperature_alert
        - binary_sensor.outdoor_low_temperature_alert
        - binary_sensor.storm_approaching_alert
        - binary_sensor.envcan_weather_alert
        - binary_sensor.noaa_weather_alert
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'

    - platform: state
      id: scene
      entity_id:
        - binary_sensor.waketime_active
        - binary_sensor.bedtime_active
        - input_boolean.bedtime_delayed
        - input_boolean.company_scene
        - input_boolean.movie_scene
        - input_boolean.chill_scene
      to:
        - 'on'
        - 'off'
      from:
        - 'on'
        - 'off'
      for: 5 # prevent trigger on temporary state changes

    - platform: state
      id: shower
      entity_id: input_boolean.shower_scene
      to: ~

    - platform: state
      id: garage
      entity_id:
        - binary_sensor.garage_door_open
        - alert.myq_connected
        - alert.myq_bridge_connected
        - input_boolean.garage_door_close_alert
        - input_boolean.garage_door_open_alert
      to:
        - 'on'
        - 'off'
        - 'idle'
      from:
        - 'on'
        - 'off'
        - 'idle'

    - platform: state
      id: presence
      entity_id:
        - binary_sensor.jason_home
        - binary_sensor.sheri_home
        - input_boolean.jason_almost_home
        - input_boolean.sheri_almost_home
        - alert.jason_phone_offline
        - alert.sheri_phone_offline
      to:
        - 'on'
        - 'off'
        - 'idle'
      from:
        - 'on'
        - 'off'
        - 'idle'
      for: 15 # prevent trigger on temporary state changes

    - platform: numeric_state
      id: presence
      entity_id:
        - proximity.jphone_home
        - proximity.sphone_home
      below: 4 # km

    - platform: state
      id: startup
      entity_id: input_boolean.startup_pending
      to: 'off'
      from: 'on'
  condition:
    - condition: template
      alias: 'Alarm not triggered, or trigger is alarm'
      value_template: >
        {{ true if trigger.entity_id == 'input_boolean.alarm_triggered'
              or trigger.from_state.state == 'triggered'
            else is_state('input_boolean.alarm_triggered','off') }}
  action:
    - choose:
        - conditions: >
            {{ trigger.id == ['startup']
                or (trigger.entity_id == 'input_boolean.alarm_triggered'
                  and is_state('input_boolean.alarm_triggered','off')) }}
          sequence:
            - service: script.reset_leds
      default:
        - service: script.turn_on
          target:
            entity_id: script.led_notification
          data:
            variables:
              entities: '{{ entities }}'
              alert_type: '{{ trigger.id }}'
