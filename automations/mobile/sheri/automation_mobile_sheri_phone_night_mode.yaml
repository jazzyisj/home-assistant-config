###############################################################################
## Mobile - Sheri Phone Night Mode
###############################################################################
- id: mobile_sheri_phone_night_mode
  alias: '[Mobile] Sheri Phone Night Mode'
  description: 'Turn DND on at night, off during day.'
  max_exceeded: silent
  trigger:
    - enabled: false #DISABLED
      platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      to: Night

    - enabled: false
      platform: state
      id: occupancy
      entity_id: input_select.occupancy_mode
      from: Night

    - enabled: false
      platform: state
      id: occupancy
      entity_id: binary_sensor.sheri_home
      to: 'on'
      from: 'off'

    - enabled: false
      platform: state
      entity_id: binary_sensor.waketime_active
      to: 'on'
      from: 'off'

    # make sure runs if waketime is off
    - enabled: false
      platform: time
      id: house
      at: input_datetime.house_waketime
  condition:
    - condition: state
      entity_id: binary_sensor.sheri_home
      state: 'on'

    - condition: template
      alias: 'If trigger is house waketime, waketime today is unknown'
      value_template: "{{ iif(trigger.id == 'house',states('sensor.waketime_today') == 'unknown',true) }}"

    - condition: template
      alias: 'Occupancy override is off if occupancy trigger'
      value_template: "{{ iif(trigger.id == 'occupancy',is_state('input_boolean.occupancy_override','off'),true) }}"
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Night

            - condition: state
              entity_id: binary_sensor.waketime_active
              state: 'off'
          sequence:
            - service: select.select_option
              target:
                entity_id: select.sheri_phone_dnd
              data:
                option: priority_only

            - service: number.set_value
              target:
                entity_id: number.sheri_phone_alarm_volume
              data:
                value: "{{ states('input_number.mobile_waketime_volume_sheri') }}"
      default:
        - service: select.select_option
          target:
            entity_id: select.sheri_phone_dnd
          data:
            option: 'off'

        - service: select.select_option
          target:
            entity_id: select.sheri_phone_ringer_mode
          data:
            option: normal

        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.sphone_volume_level_alarm
                  below: input_number.mobile_waketime_volume_sheri
              sequence:
                - service: number.set_value
                  target:
                    entity_id: number.sheri_phone_alarm_volume
                  data:
                    value: "{{ states('input_number.mobile_waketime_volume_sheri') }}"
