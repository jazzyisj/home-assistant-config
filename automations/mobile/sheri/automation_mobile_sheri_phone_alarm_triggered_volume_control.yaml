###############################################################################
## Mobile - Sheri Phone Alarm Triggered Volume Control
###############################################################################
- id: mobile_sheri_phone_alarm_triggered_volume_control
  alias: '[Mobile] Sheri Phone Alarm Triggered Volume Control'
  description: 'Set DND and alarm volume when alarm triggered.'
  trigger:
    - enabled: false
      platform: state
      entity_id: input_boolean.alarm_triggered
      to: 'on'
  action:
    - service: select.select_option
      target:
        entity_id: select.sheri_phone_dnd
      data:
        option: 'off'

    - service: number.set_value
      target:
        entity_id: number.sheri_phone_alarm_volume
      data:
        value: 7

    # input_boolean.alarm_triggered stays on until timer done, use alarm state
    - wait_template: "{{ not is_state('alarm_control_panel.master','triggered') }}"
      timeout:
        minutes: 10

    # empty message to mute mobile alarm_stream volume
    - service: notify.sheri
      data:
        message: 'Silence Alarm'
        data:
          tag: silence_alarm

    - delay: 2 # wait for notification to send

    # clear empty message
    - service: notify.sheri
      data:
        message: clear_notification
        data:
          tag: silence_alarm

    - wait_template: "{{ is_state('input_boolean.alarm_triggered','off') }}"
      timeout:
        minutes: 10

    # restore mobile alarm_stream volume
    - service: number.set_value
      target:
        entity_id: number.sheri_phone_alarm_volume
      data:
        value: "{{ states('input_number.mobile_waketime_volume_sheri')|int(7) }}"

    - if:
        - condition: state
          entity_id: input_select.occupancy_mode
          state: Night
      then:
        - service: select.select_option
          target:
            entity_id: select.sheri_phone_dnd
          data:
            option: priority_only
