###############################################################################
## Mobile - Sheri Phone Alarm Triggered Volume Control
###############################################################################
- id: mobile_sheri_phone_alarm_triggered_volume_control
  alias: '[Mobile] Sheri Phone Alarm Triggered Volume Control'
  description: 'Set DND and alarm volume when alarm triggered.'
  trigger:
    - platform: state
      entity_id: input_boolean.alarm_triggered
      to: 'on'
  action:
    - service: notify.mobile_app_sphone
      data:
        message: command_dnd
        title: 'off'

    - service: notify.mobile_app_sphone
      data:
        message: command_volume_level
        title: 7
        data:
          channel: alarm_stream

    - wait_template: "{{ not is_state('alarm_control_panel.master','triggered') }}"
      timeout:
        minutes: 10

    # mute mobile alarm_stream volume
    - service: notify.mobile_app_sphone
      data:
        message: command_volume_level
        title: 0 #VERIFY
        data:
          channel: alarm_stream

    - wait_template: "{{ is_state('input_boolean.alarm_triggered','off') }}"
      timeout:
        minutes: 10

    # restore mobile alarm_stream volume
    - service: notify.mobile_app_sphone
      data:
        message: command_volume_level
        title: "{{ states('input_number.mobile_waketime_volume_sheri')|int(7) }}"
        data:
          channel: alarm_stream

    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Night
          sequence:
            - service: notify.mobile_app_sphone
              data:
                message: command_dnd
                title: priority_only
