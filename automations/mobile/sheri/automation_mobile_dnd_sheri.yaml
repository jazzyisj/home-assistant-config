###############################################################################
## Mobile - DND Sheri
###############################################################################
- id: mobile_dnd_sheri
  alias: '[Mobile] DND Sheri'
  description: 'Turn DND on at night, off during day.'
  max_exceeded: silent
  trigger:
    - platform: state
      id: to_night
      entity_id: input_select.occupancy_mode
      to: Night

    - platform: state
      id: from_night
      entity_id: input_select.occupancy_mode
      from: Night

    - platform: state
      entity_id: binary_sensor.waketime_active
      to: 'on'

    - platform: state
      entity_id: input_boolean.alarm_triggered
      to: ~

    - platform: state
      id: presence
      entity_id: binary_sensor.sheri_home
  condition:
    - condition: template
      alias: 'House in Night mode if trigger is presence'
      value_template: >
        {{ is_state('input_select.occupancy_mode','Night')
            if trigger.id == 'presence' else true }}

    - condition: template
      alias: 'Waketime active is off if trigger is from Night mode'
      value_template: >
        {{ is_state('binary_sensor.waketime_active','off')
            if trigger.id == 'from_night' else true }}

    - condition: template
      alias: 'Presence automation is enabled if occupancy trigger'
      value_template: >
        {{ is_state('input_boolean.presence_automation','on')
              and is_state('input_boolean.occupancy_override','off')
            if trigger.id in ['to_night','from_night'] else true }}
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: input_select.occupancy_mode
              state: Night

            - condition: state
              entity_id:
                - binary_sensor.waketime_active
                - input_boolean.alarm_triggered
              state: 'off'

            - condition: state
              entity_id: binary_sensor.sheri_home
              state: 'on'
          sequence:
            - service: notify.sheri
              data:
                message: command_dnd
                title: priority_only # alarms_only, off, priority_only, total_silence
      default:
        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: sensor.sphone_do_not_disturb_sensor
                      state: 'off'
              sequence:
                - service: notify.sheri
                  data:
                    message: command_dnd
                    title: 'off'

        - choose:
            - conditions:
                - condition: not
                  conditions:
                    - condition: state
                      entity_id: sensor.sphone_ringer_mode
                      state: normal
              sequence:
                - service: notify.sheri
                  data:
                    message: command_ringer_mode
                    title: normal # normal, silent, vibrate

        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.sphone_volume_level_alarm
                  below: 7
              sequence:
                - service: notify.sheri
                  data:
                    message: command_volume_level
                    title: 7
                    data:
                      channel: alarm_stream

        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.sphone_volume_level_music
                  below: 15
              sequence:
                - service: notify.sheri
                  data:
                    message: command_volume_level
                    title: 15
                    data:
                      channel: music_stream

        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.sphone_volume_level_ringer
                  below: 4
              sequence:
                - service: notify.sheri
                  data:
                    message: command_volume_level
                    title: 4
                    data:
                      channel: notification_stream

        - choose:
            - conditions:
                - condition: numeric_state
                  entity_id: sensor.sphone_volume_level_ringer
                  below: 4
              sequence:
                - service: notify.sheri
                  data:
                    message: command_volume_level
                    title: 4
                    data:
                      channel: ring_stream
