###############################################################################
## Mobile - High Accuracy On Sheri
###############################################################################
- id: mobile_high_accuracy_on_sheri
  alias: '[Mobile] High Accuracy On Sheri'
  description: 'Turn on mobile high accuracy location mode.'
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.work_commute_active
        - binary_sensor.home_commute_active
        - input_boolean.sheri_almost_home
      to: 'on'
      from: 'off'

    - platform: state
      entity_id: sensor.sphone_detected_activity
      to: in_vehicle
  condition:
    - condition: state
      entity_id: binary_sensor.sheri_phone_connected
      state: 'on'

    - "{{ not is_state('person.sheri','Work') if trigger.entity_id == 'binary_sensor.work_commute_active' else true }}"
    - "{{ not is_state('person.sheri','home') if trigger.entity_id
      in ['binary_sensor.home_commute_active','input_boolean.sheri_almost_home'] else true }}"
  action:
    - service: notify.sheri
      data:
        message: command_high_accuracy_mode
        title: turn_on

###############################################################################
## Mobile - High Accuracy Off Sheri
###############################################################################
- id: mobile_high_accuracy_off_sheri
  alias: '[Mobile] High Accuracy Off Sheri'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_accuracy_sheri

    - platform: state
      entity_id: binary_sensor.commute_active
      to: 'off'
      from: 'on'

    - platform: state
      entity_id: person.sheri
      to:
        - home
        - work

    - platform: state
      entity_id: sensor.sphone_detected_activity
      from: in_vehicle
  action:
    # always try to turn off, even if phone not connected
    - service: notify.sheri
      data:
        message: command_high_accuracy_mode
        title: turn_off

###############################################################################
## Mobile - Phone Accuracy Alert Sheri
###############################################################################
- id: mobile_phone_accuracy_alert_sheri
  alias: '[Mobile] Phone Accuracy Alert Sheri'
  description: 'Play announcement when alert turns on.'
  trigger:
    - platform: state
      entity_id: alert.mobile_high_accuracy_sheri
      to: 'on'
  condition:
    - condition: state
      entity_id:
        - alert.mobile_high_accuracy_sheri
        - binary_sensor.sheri_home
      state: 'on'
  action:
    - repeat:
        sequence:
          - service: script.tts_play
            data:
              message: 'Sheri, your phone high accuracy mode is on.'
              quiet_play: true
          - wait_template: "{{ not is_state('alert.mobile_high_accuracy_sheri','on') }}"
            timeout:
              minutes: 15
        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: alert.mobile_high_accuracy_sheri
                state: 'on'

###############################################################################
## Mobile - Pause High Accuracy Sheri Alert
###############################################################################
- id: mobile_pause_high_accuracy_sheri_alert
  alias: '[Mobile] Pause High Accuracy Sheri Alert'
  description: 'Pause alert.'
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: pause_mobile_accuracy_sheri
  action:
    - service: alert.turn_off
      target:
        entity_id: alert.mobile_high_accuracy_sheri
