#######################################################################################################################
## Mobile - Phone Speakerphone
#######################################################################################################################
- id: mobile_phone_speakerphone
  alias: "[Mobile] Phone Speakerphone"
  description: "Mute media players when a phone speakerphone is turned on."
  trigger:
    - platform: state
      entity_id: binary_sensor.mobile_phone_in_use
      attribute: speaker_on
      to: true
  condition:
    - condition: state
      entity_id: input_boolean.media_player_automation
      state: 'on'
  action:
    - service: media_player.volume_mute
      target:
        entity_id: > #TV_VOL
          {{ states.media_player|rejectattr('entity_id','in',['media_player.bedroom_tv'])
              |map(attribute='entity_id')|list }}
      data:
        is_volume_muted: true

    - wait_template: "{{ is_state_attr('binary_sensor.mobile_phone_in_use','speaker_on',false) }}"
      timeout:
        minutes: 60

    - condition: state # don't unmute media players if system mute is on
      entity_id: input_boolean.mute_all
      state: 'off'

    - service: media_player.volume_mute
      target:
        entity_id: > #TV_VOL
          {{ states.media_player|rejectattr('entity_id','in',['media_player.bedroom_tv'])
              |map(attribute='entity_id')|list }}
      data:
        is_volume_muted: false
