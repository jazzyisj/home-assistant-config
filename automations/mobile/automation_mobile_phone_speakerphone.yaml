###############################################################################
## Mobile - Phone Speakerphone
###############################################################################
- id: mobile_phone_speakerphone
  alias: '[Mobile] Phone Speakerphone'
  description: 'Mute media players when a speakerphone is turned on.'
  mode: queued
  variables:
    media_players: > #TV - not bedroom, office TV
      {{ expand(state_attr('group.single_media_players','entity_id'))|rejectattr('entity_id','in',
        ['media_player.bedroom_tv','media_player.office_tv'])|map(attribute='entity_id')|list }}
  trigger:
    - platform: state
      entity_id: binary_sensor.mobile_phone_in_use
      attribute: speaker_on
      to:
        - 'true'
        - 'false'
      from:
        - 'true'
        - 'false'
  condition:
    - condition: state
      entity_id: input_boolean.media_player_automation
      state: 'on'

    - condition: state
      entity_id: input_boolean.startup_pending
      state: 'off'
  action:
    # if tts on wait until tts is done
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.tts
              state: 'on'
          sequence:
            - wait_template: "{{ is_state('binary_sensor.tts','off') }}"
              timeout: 120

    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.mobile_phone_in_use
              attribute: speaker_on
              state: true
          sequence:
            - service: media_player.volume_mute
              target:
                entity_id: '{{ media_players }}'
              data:
                is_volume_muted: true
      default:
        # don't unmute media players if system mute is on
        - condition: state
          entity_id: switch.system_mute
          state: 'off'

        - service: media_player.volume_mute
          target:
            entity_id: '{{ media_players }}'
          data:
            is_volume_muted: false
