#######################################################################################################################
## Presence - Occupancy Mode Guest
#######################################################################################################################
- id: presence_occupancy_mode_guest
  alias: "[Presence] Occupancy Mode Guest"
  description: "Guest state."
  initial_state: true
  mode: single
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to: Guest

  action:
    - choose:
        - conditions:
            - condition: state
              entity_id:
                - input_boolean.presence_automation
                - binary_sensor.owner_home
              state: 'on'

          sequence:
            - service: automation.turn_off
              data:
                entity_id: group.occupancy_bypass_automations
                stop_actions: false

            # turn guest home boolean on
            - service: input_boolean.turn_on
              entity_id: input_boolean.guest_home

            # back to previous mode if night/override else home mode
            - service: input_select.select_option
              data:
                entity_id: input_select.occupancy_mode
                option: "{{ trigger.from_state.state if trigger.from_state.state in ['Night','Override'] else 'Home' }}"

            - service: automation.turn_on
              entity_id: group.occupancy_bypass_automations

      default:
        - service: input_boolean.turn_on
          entity_id: input_boolean.guest_home
