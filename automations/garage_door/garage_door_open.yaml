###############################################################################
## Garage Door - Open Door
###############################################################################
- id: garage_door_open_door
  alias: "[Garage Door] Open Door"
  description: "Open the garage door."
  mode: queued
  variables:
    person: >
      {% if trigger.event is defined %}
        {% set person = trigger.event.data['action'] %}
        {% if person | lower | contains('jason') %} jason
        {% endif %}
      {% endif %}
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: open_garage_jason
  condition: "{{ person != '' }}"
  action:
    - choose:
        - conditions: "{{ person == 'jason' }}"
          sequence:
            - wait_template: >
                {{ is_state('binary_sensor.jason_home', 'on')
                    or is_state('input_boolean.jason_almost_home', 'on')
                    or is_state('alarm_control_panel.master', 'disarmed') }}
              timeout:
                minutes: 5

    - if: "{{ wait.completed }}"
      then:
        - condition: template
          value_template: "{{ not is_state('cover.garage_bay_door', 'open') }}"

        - service: script.garage_door_open
          data:
            person: "{{ person }}"
      else:
        - service: notify.jason
          data:
            message: |
              {{- iif(person != '', person | title, 'Someone ') -}}
              attempted to open the garage door but the alarm did not disarm.
            data:
              group: Alarm
              channel: Alert
              importance: max
              ttl: 0
              priority: high
              visibility: private
              notification_icon: mdi:garage-alert
              icon_url: !secret GARAGE_OPEN_ICON
              ledColor: !secret WARNING_COLOR
              color: !secret WARNING_COLOR
              vibrationPattern: !secret ALERT_VIBRATION
              clickAction: /ui-mobile/garage
              actions:
                - title: "Open Garage"
                  action: open_garage_jason

                - title: "Cameras"
                  action: URI
                  uri: !secret LOREX_URI

###############################################################################
## Garage Door Opened
###############################################################################
- id: garage_door_opened
  alias: "[Garage Door] Opened"
  description: "Announcement when door is open."
  trigger:
    - platform: state
      entity_id: binary_sensor.garage_door_open
      to: "on"
      not_from:
        - unknown
        - unavailable
  condition:
    - condition: state
      entity_id: input_boolean.garage_door_announcements
      state: "on"
  action:
    - service: script.tts_play
      data:
        message: "The garage door is open."
        ignore_away: true
