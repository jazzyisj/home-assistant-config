###############################################################################
## Garage Door Open Alert
###############################################################################
- id: garage_door_extended_open_alert
  alias: '[Garage Door] Extended Open Alert'
  description: 'Send notification, play announcement.'
  trigger:
    - platform: state
      entity_id: cover.garage_door_opener
      to: open
      for:
        minutes: 20
  condition:
    - condition: state
      entity_id: input_boolean.garage_door_automation
      state: 'on'
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.garage_door_open_alert

    - repeat:
        sequence:
          - variables:
              open_time: "{{ states.cover.garage_door_opener.last_changed|as_timestamp(none)|timestamp_custom('%-I:%M %p',true,none) }}"
              open_duration: >
                {% set seconds = now().timestamp() - states.cover.garage_door_opener.last_changed.timestamp() %}
                {%- set TIME_MAP = {
                    'w': (seconds / 604800) % 604800,
                    'd': (seconds / 86400) % 7,
                    'h': (seconds / 3600) % 24,
                    'm': (seconds / 60) % 60,
                    's': (seconds % 60) } -%}
                {%- if TIME_MAP.w|int > 0 %}{{ TIME_MAP.w|int ~ ' weeks'}}, {% endif %}
                {%- if TIME_MAP.d|int > 0 %}{{ TIME_MAP.d|int ~ ' days'}}, {% endif %}
                {%- if TIME_MAP.h|int > 0 %}{{ TIME_MAP.h|int ~ ' hours'}}, {% endif %}
                {%- if TIME_MAP.m|int > 0 %}{{ TIME_MAP.m|int ~ ' minutes'}}{% endif %}
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_door_announcements
                    state: 'on'
                sequence:
                  - service: script.tts_play
                    data:
                      message: |
                        The garage door was opened at {{ open_time }}.
                        It has been open for {{ open_duration }}.
                      min_volume: 30
                      night_play: true
                      save_message: true

          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_door_alerts
                    state: 'on'
                sequence:
                  - service: notify.jason
                    data:
                      title: 'Garage Door Open'
                      message: |
                        Garage door has been open for {{ open_duration }}.
                        Opened at: {{ open_time }}
                      data:
                        tag: garage_door_open
                        group: Alert
                        channel: Alert
                        importance: max
                        ttl: 0
                        priority: high
                        notification_icon: mdi:garage-alert
                        icon_url: !secret GARAGE_OPEN_ICON
                        ledColor: !secret WARNING_COLOR
                        color: !secret WARNING_COLOR
                        vibrationPattern: !secret ALERT_VIBRATION
                        clickAction: /lovelace-mobile/garage
                        actions:
                          - title: 'Close'
                            action: close_garage_door

                          - title: 'Alert Off'
                            action: turn_off_garage_door_alert

          - wait_template: "{{ not is_state('cover.garage_door_opener','open') }}"
            timeout:
              minutes: 15 # delay before repeat
        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: cover.garage_door_opener
                state: open

###############################################################################
## Garage Door - Error
###############################################################################
- id: garage_door_error
  alias: '[Garage Door] Error'
  description: 'Notify on garage door error.'
  mode: restart
  variables:
    garage_error: >
      {% set msg = trigger.event.data.message %}
      {% if 'cover.open_cover' in msg[0] and 'cover.garage_door_opener' in msg[0] %}
        open
      {% elif 'cover.close_cover' in msg[0] and 'cover.garage_door_opener' in msg[0] %}
        close
      {% endif %}
  trigger:
    - platform: event
      event_type: system_log_event
      event_data:
        level: ERROR
  condition: "{{ garage_error in ['open','close'] }}"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: 'input_boolean.garage_door_{{ garage_error }}_alert'
    - repeat:
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_door_alerts
                    state: 'on'
                sequence:
                  - service: "{{ states('sensor.notify_service_home') }}"
                    data:
                      title: 'Garage Door Alert'
                      message: >
                        You must now {{ garage_error }} the door manually
                        with the garage door control panel or remote button to reset the controller.
                      data:
                        tag: garage_door_alert
                        subject: 'The garage door was not able to {{ garage_error }}!'
                        group: Alert
                        channel: Alert
                        importance: max
                        ttl: 0
                        priority: high
                        timeout: 600
                        notification_icon: mdi:garage-alert
                        icon_url: !secret HASSIO_ICON
                        ledColor: !secret SEVERE_COLOR
                        color: !secret SEVERE_COLOR
                        vibrationPattern: !secret ALERT_VIBRATION
                        actions:
                          - title: 'Alert Off'
                            action: turn_off_garage_door_alert

          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_door_announcements
                    state: 'on'
                sequence:
                  - service: script.tts_play
                    data:
                      message: >
                        Attention!
                        The garage door was not able to {{ garage_error }}!
                        You must now {{ garage_error }} the door manually
                        with the garage door control panel or remote button to reset the controller.
                      ignore_away: true
                      quiet_play: true

          - wait_template: >
              {{ is_state('input_boolean.garage_door_close_alert','off')
                  and is_state('input_boolean.garage_door_open_alert','off') }}
            timeout:
              minutes: 5 # delay before repeat

        until: >
          {{ is_state('input_boolean.garage_door_close_alert','off')
              and is_state('input_boolean.garage_door_open_alert','off') }}

###############################################################################
## Garage Door - Clear Alert Notification
###############################################################################
- id: garage_door_clear_alert_notification
  alias: '[Garage Door] Clear Alert Notification'
  description: 'Turn off alert, clear notification.'
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id:
        - input_boolean.garage_door_close_alert
        - input_boolean.garage_door_open_alert
      to: 'off'

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_garage_door_alert
  action:
    - service: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.garage_door_close_alert
          - input_boolean.garage_door_open_alert

    - condition: state
      entity_id: input_boolean.garage_door_alerts
      state: 'on'

    - service: notify.mobile
      data:
        message: clear_notification
        data:
          tag: garage_door_alert
