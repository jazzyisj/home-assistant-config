#######################################################################################################################
## Garage Door Open Alert
## - don't run if closing - tts in automation.garage_door_closing, booleans stay on
#######################################################################################################################
- id: garage_door_open_alert
  alias: "[Garage Door] Open Alert"
  description: "Send notification, play announcement when door is open for a while."
  trigger:
    - platform: state
      entity_id: cover.garage_door_opener
      to: open
      for:
        minutes: 20 # door auto closes after 10 minutes unless hold is on
  condition:
    - condition: state
      entity_id: input_boolean.garage_door_automation
      state: 'on'

    - condition: state
      entity_id:
        - input_boolean.alarm_pending
        - input_boolean.alarm_triggered
      state: 'off'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.garage_door_alert

    - repeat:
        sequence:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_announcements
                    state: 'on'
                sequence:
                  - service: script.tts_play
                    data:
                      message: "The garage door has been open for a while."
                      min_volume: 30
                      quiet_play: true
                      save_message: true

          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.garage_door_alerts
                    state: 'on'
                sequence:
                  - service: notify.jason
                    data:
                      title: "Garage Door Open"
                      message: |
                        Garage door has been open for {{ ((as_timestamp(now())-as_timestamp(states.cover.garage_door_opener.last_changed,'ERROR'))/60) }} minutes.
                        Opened at: {{ as_timestamp(states.cover.garage_door_opener.last_changed,'ERROR')|timestamp_custom('%-I:%M %p',true,'ERROR') }}
                      data:
                        tag: garage_door_open
                        group: Alert
                        channel: Alert
                        importance: max
                        ttl: 0
                        priority: high
                        clickAction: /lovelace/garage
                        color: !secret WARNING_COLOR
                        icon_url: !secret GARAGE_OPEN_ICON
                        actions:
                          - action: close_garage_door
                            title: "Close Door"
                          - action: turn_off_garage_door_alert
                            title: "Turn Alert Off"

          - wait_template: "{{ not is_state('input_boolean.garage_door_alert','on') }}"
            timeout: # cancel delay if alert turned off
              minutes: 15 # delay before repeat
        until:
          - condition: not
            conditions:
              - condition: state
                entity_id: input_boolean.garage_door_alert
                state: 'on'

#######################################################################################################################
## Garage Door - Turn Off Alert
#######################################################################################################################
- id: garage_door_turn_off_alert
  alias: "[Garage Door] Turn Off Alert"
  description: "Turn off garage door alert."
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: turn_off_garage_door_alert
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.garage_door_alert