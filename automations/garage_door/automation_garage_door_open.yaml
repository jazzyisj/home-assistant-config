###############################################################################
## Garage Door - Open Door
###############################################################################
- id: garage_door_open_door
  alias: '[Garage Door] Open Door'
  description: 'Open the garage door.'
  max_exceeded: silent
  variables:
    person: >
      {% set action = trigger.event.data['action'] %}
      {% if action == 'open_garage_jason' %} jason
      {% elif action == 'open_garage_sheri' %} sheri
      {% endif %}
  trigger:
    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: open_garage_jason

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: open_garage_sheri
  action:
    - wait_template: > #TEMP #ISSUE locked sensor not updating fast enough
        {% if person == 'jason' %}
          {{ states('binary_sensor.jphone_device_locked') in ['on','off'] and is_state('alarm_control_panel.master','disarmed')
              and (is_state('binary_sensor.jason_home','on') or is_state('input_boolean.jason_almost_home','on')) }}
        {% elif person == 'sheri' %}
          {{ states('binary_sensor.sphone_device_locked') in ['on','off'] and is_state('alarm_control_panel.master','disarmed')
              and (is_state('binary_sensor.sheri_home','on') or is_state('input_boolean.sheri_almost_home','on')) }}
        {% endif %}
      timeout: 600

    - choose:
        - conditions: '{{ wait.completed }}'
          sequence:
            - service: script.garage_door_open
              data:
                person: '{{ person }}'

###############################################################################
## Garage Door Opening
###############################################################################
- id: garage_door_opening
  alias: '[Garage Door] Opening'
  description: 'Display toast notification when garage door is opening.'
  trigger:
    - platform: state
      entity_id: cover.garage_bay_door
      to: opening
  action:
    - service: browser_mod.toast
      data:
        message: 'The garage door is opening.'
        duration: 30000

###############################################################################
## Garage Door Opened
###############################################################################
- id: garage_door_opened
  alias: '[Garage Door] Opened'
  description: 'Announcement when door is open, turn off garage alert.'
  trigger:
    - platform: state
      entity_id: cover.garage_bay_door
      to: open
      from: # sensor unavailable -> open when myq reconnects
        - opening
        - closed
        - closing
  condition:
    - condition: state
      entity_id: input_boolean.garage_door_close_alert
      state: 'off'
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.garage_door_open_alert

    - condition: state
      entity_id: input_boolean.garage_door_announcements
      state: 'on'

    - service: script.tts_play
      data:
        message: 'The garage door is open.'
        ignore_away: true
        night_play: true
