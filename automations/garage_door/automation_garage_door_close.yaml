#######################################################################################################################
## Garage Door - Auto Close
#NOTE - opener automatically closes after 10 min, no timed close here
#######################################################################################################################
- id: garage_door_auto_close #OCC
  alias: "[Garage Door] Auto Close"
  description: "Automatically close garage door when conditions met."
  max_exceeded: silent
  trigger:
    - platform: state
      entity_id: input_select.occupancy_mode
      to:
        - Night
        - Away
        - Vacation

    - platform: state
      entity_id:
        - sensor.side_door_lock_status
        - sensor.front_door_lock_status
        - sensor.back_door_lock_status
      to: Locked (Manual)

    - platform: event
      event_type: mobile_app_notification_action
      event_data:
        action: close_garage_door
  condition:
    - condition: state
      entity_id:
        - input_boolean.garage_door_automation
        - binary_sensor.garage_door_open
      state: 'on'

    - "{{ is_state('input_boolean.presence_automation','on') if trigger.entity_id == 'input_select.occupancy_mode' else true }}"

    - "{{ is_state('input_boolean.lock_automation','on')
            if trigger.entity_id in ['sensor.front_door_lock_status','sensor.back_door_lock_status','sensor.side_door_lock_status'] else true }}"
  action:
    - service: cover.close_cover
      entity_id: cover.garage_door_opener

#######################################################################################################################
## Garage Door Closing
#######################################################################################################################
- id: garage_door_closing
  alias: "[Garage Door] Closing"
  description: "Display notification, repeat if door doesn't close."
  trigger:
    - platform: state
      entity_id: cover.garage_door_opener
      to: closing
  action:
    - service: browser_mod.toast
      data:
        message: "The garage door is closing."
        duration: 30000

#######################################################################################################################
## Garage Door Closed
#######################################################################################################################
- id: garage_door_closed
  alias: "[Garage Door] Closed"
  description: "Announcement when door is closed, turn off garage alert."
  trigger:
    - platform: state
      entity_id: cover.garage_door_opener
      to: closed
      from: # sensor unavailable -> closed when myq reconnects
        - closing
        - opening
        - open
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.garage_door_alert

    - condition: state
      entity_id: input_boolean.garage_announcements
      state: 'on'

    - service: script.tts_play
      data:
        message: "The garage door is closed."
        ignore_away: true
