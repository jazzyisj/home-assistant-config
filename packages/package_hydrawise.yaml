#######################################################################################################################
## Hydrawise Sprinkler Package
#######################################################################################################################
homeassistant:
  customize:
    binary_sensor.sprinklers_status:
      friendly_name: Hydrawise Controller

    switch.front_boulevard_automatic_watering:
      friendly_name: Front Boulevard Automatic Watering
      zone_name: Front Boulevard
    switch.front_sidewalk_automatic_watering:
      friendly_name: Front Sidewalk Automatic Watering
      zone_name: Front Sidewalk
    switch.front_house_automatic_watering:
      friendly_name: Front House Automatic Watering
      zone_name: Front House
    switch.front_garden_automatic_watering:
      friendly_name: Front Garden Automatic Watering
      zone_name: Front Garden
    switch.side_garden_automatic_watering:
      friendly_name: Side Garden Automatic Watering
      zone_name: Side Garden
    switch.center_garden_automatic_watering:
      friendly_name: Center Garden Left Automatic Watering
      zone_name: Center Garden Left
    switch.center_garden_automatic_watering_2:
      friendly_name: Center Garden Right Automatic Watering
      zone_name: Center Garden Right
    switch.back_grass_lef_automatic_watering:
      friendly_name: Back Grass Left Automatic Watering
      zone_name: Back Grass Left
    switch.back_grass_rig_automatic_watering:
      friendly_name: Back Grass Right Automatic Watering
      zone_name: Back Grass Right
    switch.back_grass_cen_automatic_watering:
      friendly_name: Back Grass Center Automatic Watering
      zone_name: Back Grass Center
    switch.back_garden_ri_automatic_watering:
      friendly_name: Back Garden Right Automatic Watering
      zone_name: Back Garden Right
    switch.back_garden_le_automatic_watering:
      friendly_name: Back Garden Left Watering
      zone_name: Back Garden Left

    switch.front_boulevard_manual_watering:
      friendly_name: Front Boulevard Automatic Watering
      zone_name: Front Boulevard
    switch.front_sidewalk_manual_watering:
      friendly_name: Front Sidewalk Automatic Watering
      zone_name: Front Sidewalk
    switch.front_house_manual_watering:
      friendly_name: Front House Automatic Watering
      zone_name: Front House
    switch.front_garden_manual_watering:
      friendly_name: Front Garden Automatic Watering
      zone_name: Front Garden
    switch.side_garden_manual_watering:
      friendly_name: Side Garden Automatic Watering
      zone_name: Side Garden
    switch.center_garden_manual_watering:
      friendly_name: Center Garden Left Manual Watering
      zone_name: Center Garden Left
    switch.center_garden_manual_watering_2:
      friendly_name: Center Garden Right Manual Watering
      zone_name: Center Garden Right
    switch.back_grass_lef_manual_watering:
      friendly_name: Back Grass Left Automatic Watering
      zone_name: Back Grass Left
    switch.back_grass_rig_manual_watering:
      friendly_name: Back Grass Right Automatic Watering
      zone_name: Back Grass Right
    switch.back_grass_cen_manual_watering:
      friendly_name: Back Grass Center Automatic Watering
      zone_name: Back Grass Center
    switch.back_garden_ri_manual_watering:
      friendly_name: Back Garden Right Manual Watering
      zone_name: Back Garden Right
    switch.back_garden_le_manual_watering:
      friendly_name: Back Garden Left Watering
      zone_name: Back Garden Left

    sensor.front_boulevard_watering_time:
      friendly_name: Front Boulevard Watering Time
      zone_name: Front Boulevard
    sensor.front_sidewalk_watering_time:
      friendly_name: Front Sidewalk Watering Time
      zone_name: Front Sidewalk
    sensor.front_house_watering_time:
      friendly_name: Front House Watering Time
      zone_name: Front House
    sensor.front_garden_watering_time:
      friendly_name: Front Garden Watering Time
      zone_name: Front Garden
    sensor.side_garden_watering_time:
      friendly_name: Side Garden Watering Time
      zone_name: Side Garden
    sensor.center_garden_watering_time:
      friendly_name: Center Garden Left Watering Time
      zone_name: Center Garden Left
    sensor.center_garden_watering_time_2:
      friendly_name: Center Garden Right Watering Time
      zone_name: Center Garden Right
    sensor.back_grass_lef_watering_time:
      friendly_name: Side Garden Watering Time
      zone_name: Side Garden
    sensor.back_grass_rig_watering_time:
      friendly_name: Back Grass Right Watering Time
      zone_name: Back Grass Right
    sensor.back_grass_cen_watering_time:
      friendly_name: Back Grass Center Watering Time
      zone_name: Back Grass Center
    sensor.back_garden_ri_watering_time:
      friendly_name: Back Garden Right Watering Time
      zone_name: Back Garden Right
    sensor.back_garden_le_watering_time:
      friendly_name: Back Garden Left Watering
      zone_name: Back Garden Left

    binary_sensor.front_boulevard_watering:
      friendly_name: Front Boulevard Watering
      zone_name: Front Boulevard
    binary_sensor.front_sidewalk_watering:
      friendly_name: Front Sidewalk Watering
      zone_name: Front Sidewalk
    binary_sensor.front_house_watering:
      friendly_name: Front House Watering
      zone_name: Front House
    binary_sensor.front_garden_watering:
      friendly_name: Front Garden Watering
      zone_name: Front Garden
    binary_sensor.side_garden_watering:
      friendly_name: Side Garden Watering
      zone_name: Side Garden
    binary_sensor.center_garden_watering:
      friendly_name: Center Garden Left Watering
      zone_name: Center Garden Left
    binary_sensor.center_garden_watering_2:
      friendly_name: Center Garden Right Watering
      zone_name: Center Garden Right
    binary_sensor.back_grass_lef_watering:
      friendly_name: Back Grass Left Watering
      zone_name: Back Grass Left
    binary_sensor.back_grass_rig_watering:
      friendly_name: Back Grass Right Watering
      zone_name: Back Grass Right
    binary_sensor.back_grass_cen_watering:
      friendly_name: Back Grass Center Watering
      zone_name: Back Grass Center
    binary_sensor.back_garden_ri_watering:
      friendly_name: Back Garden Right Watering
      zone_name: Back Garden Right
    binary_sensor.back_garden_le_watering:
      friendly_name: Back Garden Left Watering
      zone_name: Back Garden Left

    sensor.front_boulevard_next_cycle:
      friendly_name: Front Boulevard Next Cycle
      zone_name: Front Boulevard
    sensor.front_sidewalk_next_cycle:
      friendly_name: Front Sidewalk Next Cycle
      zone_name: Front Sidewalk
    sensor.front_house_next_cycle:
      friendly_name: Front House Next Cycle
      zone_name: Front House
    sensor.front_garden_next_cycle:
      friendly_name: Front Garden Next Cycle
      zone_name: Front Garden
    sensor.side_garden_next_cycle:
      friendly_name: Side Garden Next Cycle
      zone_name: Side Garden
    sensor.center_garden_next_cycle:
      friendly_name: Center Garden Left Next Cycle
      zone_name: Center Garden Left
    sensor.center_garden_next_cycle_2:
      friendly_name: Center Garden Right Next Cycle
      zone_name: Center Garden Right
    sensor.back_grass_lef_next_cycle:
      friendly_name: Back Grass Left Next Cycle
      zone_name: Back Grass Left
    sensor.back_grass_rig_next_cycle:
      friendly_name: Back Grass Right Next Cycle
      zone_name: Back Grass Right
    sensor.back_grass_cen_next_cycle:
      friendly_name: Back Grass Center Next Cycle
      zone_name: Back Grass Center
    sensor.back_garden_ri_next_cycle:
      friendly_name: Back Garden Right Next Cycle
      zone_name: Back Garden Right
    sensor.back_garden_le_next_cycle:
      friendly_name: Back Garden Left Next Cycle
      zone_name: Back Garden Left

#######################################################################################################################
## Hydrawise Integration
#######################################################################################################################
hydrawise:
  access_token: !secret HYRDRAWISE_API

input_number:
#######################################################################################################################
## Sprinkler History Hours
#######################################################################################################################
  sprinkler_history_hours:
    name: Sprinkler History Hours
    icon: mdi:progress-clock
    min: 0
    max: 168
    step: 1
    unit_of_measurement: 'hours'

switch:
#######################################################################################################################
## Hydrawise Platform Switches
#######################################################################################################################
  - platform: hydrawise
    monitored_conditions:
      - auto_watering
      - manual_watering
    # watering_minutes: 20 #BUG does not work contrary to docs

binary_sensor:
#######################################################################################################################
## Hydrawise Platform Binary Sensors
#######################################################################################################################
  - platform: hydrawise

  - platform: template
    sensors:
#######################################################################################################################
## Hydrawise Controller Connected - sprinkler_status unknown when not conneted
#######################################################################################################################
      hyrdrawise_connected:
        friendly_name: Hyrdawise
        unique_id: hyrdrawise_connected
        device_class: connectivity
        icon_template: "{{ 'mdi:sprinkler-variant' if is_state('binary_sensor.hyrdrawise_connected','on') else 'mdi:alert-circle' }}"
        value_template: "{{ not states('binary_sensor.sprinklers_status')|lower in ['unknown','unavailable','none'] }}"

      hyrdrawise_connected_alert:
        friendly_name: Hyrdwawise
        unique_id: hyrdrawise_connected_alert
        icon_template: mdi:sprinkler-variant
        value_template: "{{ is_state('binary_sensor.hyrdrawise_connected','off') }}"

sensor:
#######################################################################################################################
## Hydrawise Platform Sensors
#######################################################################################################################
  - platform: hydrawise

  - platform: template
    sensors:
#######################################################################################################################
## Current Watering Cycle
## - only one enity in group can ever be on at once
## - state is zone name
#######################################################################################################################
      current_watering_cycle:
        friendly_name: Current Watering Zone
        unique_id: current_watering_cycle
        icon_template: mdi:sprinkler-variant
        value_template: >
          {% set sensors = expand('group.sprinkler_current_cycle') %}
          {% set count = sensors|selectattr('state','eq','on')|list|count %}
          {{ (sensors|selectattr('state','eq','on')|map(attribute='attributes.zone_name')|list)[0] if count == 1 else 'Not Watering' }}
        attribute_templates:
          start_time: >
            {% set sensors = expand('group.sprinkler_current_cycle') %}
            {{ as_timestamp(sensors|selectattr('state','eq','on')|map(attribute='last_changed')|join(''))|timestamp_custom('%_I:%M %p')
                if sensors|selectattr('state','eq','on')|list|count == 1 else 'not_set' }}
          minutes_left: >
            {% set sensors = expand('group.sprinkler_current_cycle') %}
            {% set current = sensors|selectattr('state','eq','on')|map(attribute='entity_id')|join('') %}
            {% if current == '' %} not_set
            {% else %}{{ states('sensor.' ~ current[14:-9] ~ '_watering_time') }}
            {% endif %}
        availability_template: "{{ is_state('binary_sensor.hyrdrawise_connected','on') }}"

#######################################################################################################################
## Next Watering Cycle
## - reject current watering zone to get next
## - if more than 1 entity is min value then all zones are suspended
## - state is zone name
#######################################################################################################################
  - platform: template
    sensors:
      next_watering_cycle:
        friendly_name: Next Watering
        unique_id: next_watering_cycle
        device_class: timestamp
        icon_template: mdi:sprinkler-variant
        value_template: >
          {% set zone_on = state_attr(expand('group.sprinkler_current_cycle')|selectattr('state','eq','on')|map(attribute='entity_id')|join(''),'identifier') %}
          {% set sensors = expand('group.sprinkler_next_cycle') %}
          {% set next = sensors|rejectattr('attributes.identifier','eq',zone_on)|map(attribute='state')|list|min %}
          {% set suspended = as_timestamp(next) - as_timestamp(now()) > 31536000 %}
          {% if suspended %} Watering Suspended
          {% else %}{{ sensors|selectattr('state','eq',next)|map(attribute='attributes.zone_name')|join('') }}
          {% endif %}
        attribute_templates:
          start_time: >
            {% set zone_on = state_attr(expand('group.sprinkler_current_cycle')|selectattr('state','eq','on')|map(attribute='entity_id')|join(''),'identifier') %}
            {% set sensors = expand('group.sprinkler_next_cycle') %}
            {% set next = sensors|rejectattr('attributes.identifier','eq',zone_on)|map(attribute='state')|list|min %}
            {% set suspended = as_timestamp(next) - as_timestamp(now()) > 31536000 %}
            {% if suspended %} not_set
            {% else %}{{ as_timestamp(next)|timestamp_custom('%a, %B %d %Y, %_I:%M %p') }}
            {% endif %}
        availability_template: "{{ is_state('binary_sensor.hyrdrawise_connected','on') }}"

group:
#######################################################################################################################
# Sprinkler Cycle Groups
#######################################################################################################################
  sprinkler_next_cycle:
      - sensor.front_boulevard_next_cycle
      - sensor.front_sidewalk_next_cycle
      - sensor.front_house_next_cycle
      - sensor.front_garden_next_cycle
      - sensor.side_garden_next_cycle
      - sensor.center_garden_next_cycle
      - sensor.center_garden_next_cycle_2
      - sensor.back_grass_lef_next_cycle
      - sensor.back_grass_rig_next_cycle
      - sensor.back_grass_cen_next_cycle
      - sensor.back_garden_ri_next_cycle
      - sensor.back_garden_le_next_cycle

  sprinkler_current_cycle:
      - binary_sensor.front_boulevard_watering
      - binary_sensor.front_sidewalk_watering
      - binary_sensor.front_house_watering
      - binary_sensor.front_garden_watering
      - binary_sensor.side_garden_watering
      - binary_sensor.center_garden_watering
      - binary_sensor.center_garden_watering_2
      - binary_sensor.back_grass_lef_watering
      - binary_sensor.back_grass_rig_watering
      - binary_sensor.back_grass_cen_watering
      - binary_sensor.back_garden_ri_watering
      - binary_sensor.back_garden_le_watering

#######################################################################################################################
# Sprinkler Zone Groups
#######################################################################################################################
  sprinker1:
    name: Front Boulevard
    icon: mdi:fountain
    entities:
      - switch.front_boulevard_manual_watering
      - switch.front_boulevard_automatic_watering
      - binary_sensor.front_boulevard_watering
      - sensor.front_boulevard_watering_time
      - sensor.front_boulevard_next_cycle

  sprinker2:
    name: Front Sidewalk
    icon: mdi:fountain
    entities:
      - switch.front_sidewalk_manual_watering
      - switch.front_sidewalk_automatic_watering
      - binary_sensor.front_sidewalk_watering
      - sensor.front_sidewalk_watering_time
      - sensor.front_sidewalk_next_cycle

  sprinker3:
    name: Front House
    icon: mdi:fountain
    entities:
      - switch.front_house_manual_watering
      - switch.front_house_automatic_watering
      - binary_sensor.front_house_watering
      - sensor.front_house_watering_time
      - sensor.front_house_next_cycle

  sprinker4:
    name: Front Garden
    icon: mdi:fountain
    entities:
      - switch.front_garden_manual_watering
      - switch.front_garden_automatic_watering
      - binary_sensor.front_garden_watering
      - sensor.front_garden_watering_time
      - sensor.front_garden_next_cycle

  sprinker5:
    name: Side Garden
    icon: mdi:fountain
    entities:
      - switch.side_garden_manual_watering
      - switch.side_garden_automatic_watering
      - binary_sensor.side_garden_watering
      - sensor.side_garden_watering_time
      - sensor.side_garden_next_cycle

  sprinker6:
    name: Center Garden Left
    icon: mdi:fountain
    entities:
      - switch.center_garden_manual_watering
      - switch.center_garden_automatic_watering
      - binary_sensor.center_garden_watering
      - sensor.center_garden_watering_time
      - sensor.center_garden_next_cycle

  sprinker7:
    name: Center Garden Right
    icon: mdi:fountain
    entities:
      - switch.center_garden_manual_watering_2
      - switch.center_garden_automatic_watering_2
      - binary_sensor.center_garden_watering_2
      - sensor.center_garden_watering_time_2
      - sensor.center_garden_next_cycle_2

  sprinker8:
    name: Back Grass Left
    icon: mdi:fountain
    entities:
      - switch.back_grass_lef_manual_watering
      - switch.back_grass_lef_automatic_watering
      - binary_sensor.back_grass_lef_watering
      - sensor.back_grass_lef_watering_time
      - sensor.back_grass_lef_next_cycle

  sprinker9:
    name: Back Grass Right
    icon: mdi:fountain
    entities:
      - switch.back_grass_rig_manual_watering
      - switch.back_grass_rig_automatic_watering
      - binary_sensor.back_grass_rig_watering
      - sensor.back_grass_rig_watering_time
      - sensor.back_grass_rig_next_cycle

  sprinker10:
    name: Back Grass Center
    icon: mdi:fountain
    entities:
      - switch.back_grass_cen_manual_watering
      - switch.back_grass_cen_automatic_watering
      - binary_sensor.back_grass_cen_watering
      - sensor.back_grass_cen_watering_time
      - sensor.back_grass_cen_next_cycle

  sprinker11:
    name: Back Garden Right
    icon: mdi:fountain
    entities:
      - switch.back_garden_ri_manual_watering
      - switch.back_garden_ri_automatic_watering
      - binary_sensor.back_garden_ri_watering
      - sensor.back_garden_ri_watering_time
      - sensor.back_garden_ri_next_cycle

  sprinker12:
    name: Back Garden Left
    icon: mdi:fountain
    entities:
      - switch.back_garden_le_manual_watering
      - switch.back_garden_le_automatic_watering
      - binary_sensor.back_garden_le_watering
      - sensor.back_garden_le_watering_time
      - sensor.back_garden_le_next_cycle