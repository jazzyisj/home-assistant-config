###############################################################################
## Package - Network
###############################################################################
homeassistant:
  customize:
    alert.pihole_disconnected:
      friendly_name: 'Pi-Hole'
      icon: mdi:pi-hole
      category: network
    sensor.pi_hole_status:
      icon: mdi:pi-hole

shell_command:
  pi_hole_enable: !secret PIHOLE_ENABLE_CMD
  pi_hole_disable: !secret PIHOLE_DISABLE_CMD
  pi_hole_disable_time: !secret PIHOLE_DISABLE_TIME_CMD

input_number:
  pi_hole_disable_time:
    name: 'Pi-Hole Disable Time'
    icon: mdi:timer-outline
    unit_of_measurement: min
    min: 0
    max: 3600
    step: 5
    mode: box

switch:
  - platform: template
    switches:
      pi_hole_enabled:
        friendly_name: 'Pi-Hole Enabled'
        icon_template: >-
          {% if is_state('sensor.pi_hole_status', 'Enabled') %}
            mdi:check-circle
          {% else %}
            mdi:minus-circle
          {% endif %}
        #TEMP https://github.com/pi-hole/AdminLTE/issues/2051
        # value_template: "{{ is_state('sensor.pi_hole_status', 'Enabled') }}"
        turn_on:
          - service: shell_command.pi_hole_enable

          - service: input_number.set_value
            target:
              entity_id: input_number.pi_hole_disable_time
            data:
              value: 0

          - service: homeassistant.update_entity
            target:
              entity_id: sensor.pi_hole_status
        turn_off:
          - service: >
              {% if states('input_number.pi_hole_disable_time')|float > 0 %}
                  shell_command.pi_hole_disable_time
              {% else %}
                  shell_command.pi_hole_disable
              {% endif %}

          - service: input_number.set_value
            target:
              entity_id: input_number.pi_hole_disable_time
            data:
              value: 0

          - service: homeassistant.update_entity
            target:
              entity_id: sensor.pi_hole_status

sensor:
  - platform: command_line
    name: 'Pi-Hole Status'
    command: !secret PIHOLE_STATUS_CMD
    value_template: >-
      {% if is_state('binary_sensor.pihole_disconnected_alert','on') %} Disconnected
      {% elif value_json.status == 'enabled' %} Enabled
      {% elif value_json.status == 'disabled' %} Disabled
      {% else %} {{ none }}
      {% endif %}

alert:
  pihole_disconnected:
    name: 'PiHole Disconnected'
    title: 'PiHole Disconnected'
    message: 'PiHole is disconnected.'
    done_message: clear_notification
    entity_id: binary_sensor.pihole_disconnected_alert
    state: 'on'
    repeat: 60
    notifiers: jason
    data:
      tag: pihole_disconnected
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:pi-hole
      icon_url: !secret PIHOLE_ICON
      image: !secret PIHOLE_IMAGE
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: http://raspberrypi/admin/index.php
      actions:
        - title: 'Pause Alert'
          action: pause_pihole_disconnected

  pihole_disabled:
    name: 'PiHole Disabled'
    title: 'PiHole Disabled'
    message: 'PiHole is disabled.'
    done_message: clear_notification
    entity_id: binary_sensor.pihole_disabled_alert
    state: 'on'
    repeat: 60
    notifiers: jason
    data:
      tag: pihole_disabled
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:pi-hole
      icon_url: !secret PIHOLE_ICON
      image: !secret PIHOLE_IMAGE
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: http://raspberrypi/admin/index.php
      actions:
        - title: 'Pause Alert'
          action: pause_pihole_disabled

  pi_hole_update:
    name: 'PiHole Update'
    title: 'PiHole Update'
    message: 'PiHole update available.'
    done_message: clear_notification
    entity_id: binary_sensor.pihole_update_alert
    state: 'on'
    repeat: 720
    notifiers: jason
    data:
      tag: pihole_update
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:pi-hole
      icon_url: !secret PIHOLE_ICON
      image: !secret PROCESSOR_IMAGE
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: http://raspberrypi/admin/index.php
      actions:
        - title: 'Pause Alert'
          action: pause_pihole_update
