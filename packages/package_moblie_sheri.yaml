#######################################################################################################################
## Mobile App Package - Sheri - common elements w/jason
#######################################################################################################################
homeassistant:
  customize:
    alert.mobile_phone_headphones_sheri:
      icon: mdi:headphones
      category: mobile
    alert.mobile_phone_ringer_sheri:
      icon: mdi:phone-ring
      category: mobile
    alert.mobile_phone_bluetooth_sheri:
      icon: mdi:phone-bluetooth
      category: mobile
    alert.mobile_phone_wifi_sheri:
      icon: mdi:cellphone-wireless
      category: mobile
    alert.mobile_phone_offline_sheri:
      icon: mdi:cellphone-off
      category: mobile
    alert.mobile_phone_battery_sheri:
      icon: mdi:battery-alert
      category: mobile

sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Sheri Mobile App Update
#######################################################################################################################
      sphone_app_update:
        friendly_name: Sheri Mobile App Update
        unique_id: sphone_app_update
        icon_template: "{{ 'mdi:check-circle' if is_state('sensor.sphone_app_update','off') else 'mdi:alert-circle' }}"
        value_template: "{{ 'on' if states('sensor.ha_companion_latest_version') != states('sensor.sphone_current_version') else 'off' }}"
        attribute_templates:
          current: "{{ states('sensor.sphone_current_version') }}"
          latest: "{{ states('sensor.ha_companion_latest_version') }}"

#######################################################################################################################
## Tracker Last Seen
#######################################################################################################################
      sheri_tracker_last_seen:
        friendly_name: Sheri Tracker Last Seen
        unique_id: sheri_tracker_last_seen
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp( state_attr('device_tracker.sheri_tracker','last_seen'))|timestamp_custom('%H:%M',true) }}"
        availability_template: "{{ states('device_tracker.sheri_tracker')|lower not in ['unknown','unavailable','none'] or state_attr('device_tracker.sheri_tracker','source_type')|lower == 'none' }}"

#######################################################################################################################
## Phone Last Update
#######################################################################################################################
      sphone_last_update:
        friendly_name: Sheri Phone Last Update
        unique_id: sphone_last_update
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp(states.sensor.sphone_last_update_trigger.last_updated)|timestamp_custom('%-I:%M %p',true) }}"
        availability_template: "{{ states('sensor.sphone_last_update_trigger')|lower not in ['unknown','unavailable','none'] }}"

######################################################################################################################
## Phone Address
#######################################################################################################################
      sphone_address:
        friendly_name: Sheri Location Address
        unique_id: sphone_address
        icon_template: mdi:google-maps
        value_template: "{{ state_attr('device_tracker.google_maps_115097751563829374630','address') }}"

      sphone_alarm_clock:
        friendly_name: Sheri Phone Alarm
        unique_id: sphone_alarm_clock
        icon_template: mdi:alarm
        value_template: >
          {{ 'Off' if states('sensor.sphone_next_alarm')|lower in ['unknown','unavailable','none']
                or (as_timestamp(states('sensor.sphone_next_alarm')) - as_timestamp(now())) > 86400
                or is_state('input_boolean.alarm_clock_phone','off')
                  else as_timestamp(states('sensor.sphone_next_alarm'))|timestamp_custom('%H:%M',true) }}
        availability_template: "{{ states('sensor.sphone_next_alarm') not in ['unknown','none'] }}"

      sphone_alarm_clock_display:
        friendly_name: Sheri Phone Alarm
        unique_id: sphone_connected
        icon_template: mdi:alarm
        value_template: >
          {{ 'Off' if is_state('sensor.sphone_alarm_clock','Off')
                else  as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.sphone_alarm_clock'))|timestamp_custom('%-I:%M %p',true) }}
        availability_template: "{{ states('sensor.sphone_alarm_clock')|lower not in ['unknown','unavailable','none'] }}"

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Phone Connected Sheri - ping, bluetooth are connected or last GPS update less than 15 minutes ago phone is connected
#######################################################################################################################
      sphone_connected:
        friendly_name: Sheri Phone Connected
        unique_id: sphone_connected
        icon_template: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.sphone_connected','on') else 'mdi:cellphone-off' }}"
        device_class: connectivity
        value_template: >
          {% if states('device_tracker.sheri_tracker')|lower in ['unknown','unavailable','none'] %} false
          {% else %}
            {% set p = as_timestamp(state_attr('device_tracker.sheri_tracker','last_seen')) %}
            {% set t = as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.time')) %}
            {% set minutes = (t-p)/60 %}
            {{ is_state('device_tracker.sphone_bt','home')
                or is_state('device_tracker.sphone_ping','home')
                or minutes < 15 }}
          {% endif %}

      sphone_connected_alert:
        unique_id: sphone_connected_alert
        value_template: "(( is_state('binary_sensor.sphone_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Phone Ringer Sheri
#NOTE phone volume is 0 when phone is offhook
#######################################################################################################################
      sphone_ringer_alert:
        unique_id: sphone_ringer_alert
        value_template: >
          {{ (is_state('sensor.sphone_do_not_disturb_sensor','priority_only')
              or is_state('sensor.sphone_ringer_mode','off')
              or (states('sensor.sphone_volume_level_ringer')|int < 1 and not is_state('sensor.sphone_phone_state','offhook')))
              and ( states('sensor.time') > states('sensor.waketime_today') or is_state('sensor.waketime_today','Off'))
              and not is_state('binary_sensor.quiet_hours','on')
              and not is_state('input_select.occupancy_mode','Night') }}

#######################################################################################################################
## Phone Bluetooth Sheri
#######################################################################################################################
      sphone_bluetooth_alert:
        unique_id: sphone_bluetooth_alert
        value_template: "{{ is_state('binary_sensor.sphone_bluetooth_state','off') and is_state('device_tracker.sphone_bt','not_home') }}"

#######################################################################################################################
## Phone Wifi Sheri
#######################################################################################################################
      sphone_wifi_alert:
        unique_id: sphone_wifi_alert
        value_template: "{{ is_state('binary_sensor.sphone_wifi_state','off') and is_state('device_tracker.sphone_wifi','not_home') }}"

#######################################################################################################################
## Phone Headphone Sheri
#######################################################################################################################
      sphone_headphones_alert:
        unique_id: sphone_headphones_alert
        value_template: >
          {{ is_state('input_boolean.presence_automation','on')
              and is_state('binary_sensor.alerts_enabled','on')
              and is_state('binary_sensor.sheri_home','on')
              and is_state('device_tracker.sheri_headphones_bt','home')
              and 'B8:AD:3E:A5:5B:00' in state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices') }}
        availability_template: >
          {{ states('sensor.sphone_bluetooth_connection')|lower not in ['unknown','unavailable','none']
              and states('device_tracker.sheri_headphones_bt')|lower not in ['unknown','unavailable','none'] }}

#######################################################################################################################
## Phone Battery Sheri
#######################################################################################################################
      sphone_battery_alert:
        unique_id: sphone_battery_alert
        value_template: >
          {% set level = 50 if is_state('binary_sensor.pre_work_active','on') else 20 %}
          {{ states('sensor.sphone_battery_level')|int < level and is_state('binary_sensor.sphone_is_charging','off')
              and is_state('binary_sensor.alerts_enabled','on') }}

alert:
#######################################################################################################################
## Alert - Phone Offline Sheri
#######################################################################################################################
  mobile_phone_offline_sheri:
    name: Phone Offline Sheri
    title: Sheri Phone Offline
    message: "Offline at {{ as_timestamp(now())|timestamp_custom('%-I:%M %p') }}"
    entity_id: binary_sensor.sphone_connected_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile
    data:
      tag: phone_offline_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON
      image: !secret OFFLINE_IMAGE
      actions:
        - action: pause_phone_offline_sheri
          title: Pause

#######################################################################################################################
## Alert - Phone Ringer Sheri
#######################################################################################################################
  mobile_phone_ringer_sheri:
    name: Phone Ringer Sheri
    title: Sheri Phone Ringer
    message: Your mobile phone ringer is off.
    entity_id: binary_sensor.sphone_ringer_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile #NOTIFY monitoring - mobile_app_sphone
    data:
      tag: phone_ringer_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_offline_sheri
          title: Pause

#######################################################################################################################
## Alert - Phone Bluetooth Sheri
#######################################################################################################################
  mobile_phone_bluetooth_sheri:
    name: Phone Bluetooth Sheri
    title: Sheri Phone Bluetooth
    message: Your mobile phone bluetooth is off.
    entity_id: binary_sensor.sphone_bluetooth_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile
    data:
      tag: phone_bluetooth_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_bluetooth_sheri
          title: Pause

#######################################################################################################################
## Alert - Phone Wifi Sheri
#######################################################################################################################
  mobile_phone_wifi_sheri:
    name: Phone Wifi Sheri
    title: Sheri Phone WIFI
    message: Your mobile phone WIFI is off.
    entity_id: binary_sensor.sphone_wifi_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile
    data:
      tag: phone_wifi_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_wifi_sheri
          title: Pause

#######################################################################################################################
## Alert - Phone Headphones Sheri
#######################################################################################################################
  mobile_phone_headphones_sheri:
    name: Phone Headphones Sheri
    title: Sheri Phone Headphones
    message: >
      {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.sphone_bluetooth_connection','connected_paired_devices') %}
      Your headphones are on{{ ', and are still connected to your phone!' if c else '.' }}
    entity_id: binary_sensor.sphone_headphones_alert
    state: 'on'
    repeat:
      - 30
      - 120
    notifiers: mobile
    data:
      tag: phone_headphones_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_headphones_sheri
          title: Pause

#######################################################################################################################
## Alert - Phone Battery Sheri
#######################################################################################################################
  mobile_phone_battery_sheri:
    name: Phone Battery Sheri
    title: Sheri Phone Low Battery
    message: >
      Phone Battery: {{ states('sensor.sphone_battery_level') }}%
      <br/>Battery Health: {{ states('sensor.sphone_battery_health')|title }}
    entity_id: binary_sensor.sphone_battery_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile
    data:
      tag: phone_battery_sheri
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret BATTERY_ICON
      actions:
        - action: pause_phone_battery_sheri
          title: Pause

