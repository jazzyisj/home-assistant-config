###################################################################################################
## Package - Unavailable Entities Sensor
## Count and list entities with a state of unavailable or unknown
## See README for customization options.
## https://github.com/jazzyisj/unavailable-entities-sensor/blob/main/README.md
###################################################################################################

# NOTE: Home Assistant v2021.12 required.  For older versions please see README
# REQUIRED - This is the template sensor
template:
  - sensor:
      - name: 'Unavailable Entities'
        unique_id: unavailable_entities
        icon: "{{ iif(states(this.entity_id)|int(0) > 0,'mdi:alert-circle','mdi:check-circle') }}"
        unit_of_measurement: entities
        state: >
          {% if state_attr(this.entity_id,'entity_id') != none %}
            {{ state_attr(this.entity_id,'entity_id')|count }}
          {% endif %}
        attributes:
          entity_id: >
            {% if state_attr('group.ignored_unavailable_entities','entity_id') != none %}
              {% set ignore_seconds = 60 %}
              {% set ignore_ts = (now().timestamp() - ignore_seconds)|as_datetime %}
              {% set entities = states|rejectattr('domain','in',['group'])
                  |rejectattr('entity_id','in',state_attr('group.ignored_unavailable_entities','entity_id'))
                  |rejectattr('last_changed','ge',ignore_ts)
                  |selectattr('state','in',['unavailable','unknown'])
                  |map(attribute='entity_id')|list %}
              {{ entities }}
            {% endif %}

# REQUIRED - Add any entities you do not wish to monitor in this group.
# IMPORTANT - This group MUST exist even if empty for sensor template to render.
# group:
#   ignored_unavailable_entities:
#     entities:
#       - sensor.unavailable_entities # prevent template loop warnings?

# OPTIONAL - filter template loop warnings from the Home Assistant log.
# logger:
#   filters:
#     homeassistant.components.template.template_entity:
#       - 'Template loop detected while processing event'

# OPTIONAL Example automation to demonstrate how you can utilize this sensor
automation:
  - id: unavailable_entities_notification
    alias: 'Unavailable Entities Notification'
    description: 'Create persistent notification if unavailable entities, dismiss if none.'
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.unavailable_entities
        attribute: entity_id
        to: ~
    condition:
      - condition: template
        value_template: >
          {{ is_number(trigger.from_state.state)
              and is_number(trigger.to_state.state) }}
    action:
      - if:
          - condition: numeric_state
            entity_id: sensor.unavailable_entities
            below: 1
        then:
          - service: persistent_notification.dismiss
            data:
              notification_id: unavailable_entities
        else:
          - service: persistent_notification.create
            data:
              title: 'Unavailable Entities'
              message: "- {{ state_attr('sensor.unavailable_entities','entity_id')|join('\n- ') }}"
              notification_id: unavailable_entities
