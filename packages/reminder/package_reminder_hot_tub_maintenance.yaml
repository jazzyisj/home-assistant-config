###############################################################################
## Package - Hot tub maintenance Reminder
###############################################################################
input_boolean:
  hot_tub_maintenance_enabled:
    name: 'Hot Tub Maintenance Enabled'
    icon: mdi:pill
  hot_tub_maintenance_active:
    name: 'Hot Tub Maintenance Active'
    icon: mdi:pill

input_datetime:
  hot_tub_maintenance_days:
    name: 'Hot Tub Maintenance: Days'
    icon: mdi:clock
    has_date: false
    has_time: true
  hot_tub_maintenance_afternoons:
    name: 'Hot Tub Maintenance: Afternoons'
    icon: mdi:clock
    has_date: false
    has_time: true
  hot_tub_maintenance_weekends:
    name: 'Hot Tub Maintenance: Weekends'
    icon: mdi:clock
    has_date: false
    has_time: true

input_number:
  hot_tub_maintenance_day_interval:
    name: 'Hot Tub Maintenance: Day Interval'
    icon: mdi:calendar-range
    unit_of_measurement: days
    min: 1
    max: 7
    step: 1

binary_sensor:
  - platform: template
    sensors:
      hot_tub:
        friendly_name: 'Hot Tub'
        unique_id: hot_tub
        entity_picture_template: /local/images/glance/hot_tub.png
        value_template: "{{ is_state('input_boolean.hot_tub_active','on') }}"

automation:
  ###############################################################################
  ## Reminders - Turn Off Hot tub maintenance
  ###############################################################################
  - id: reminders_turn_off_hot_tub_maintenance
    alias: '[Reminders] Turn Off Hot tub maintenance'
    description: 'Turn off reminder active boolean.'
    initial_state: true
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.hot_tub_maintenance_enabled
        to: 'off'

      - platform: state
        entity_id: input_boolean.hot_tub_maintenance_active
        to: 'on'

      - platform: event
        id: action
        event_type: mobile_app_notification_action
        event_data:
          action: hot_tub_maintenance_done
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.hot_tub_maintenance_enabled
            state: 'off'

          - "{{ trigger.id == 'action' }}"
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.hot_tub_maintenance_active

  ###############################################################################
  ## Reminders - Activate Hot tub maintenance
  ###############################################################################
  - id: reminders_activate_hot_tub_maintenance
    alias: '[Reminders] Activate Hot tub maintenance'
    description: 'Turn on reminder active boolean.'
    trigger:
      - platform: template
        value_template: >
          {% set time = states('sensor.time') %}
          {% set shift = states('sensor.time_trigger_shift') %}
          {{ (shift == 'days' and time == states('input_datetime.hot_tub_maintenance_days')[0:5])
            or (shift == 'afts' and time == states('input_datetime.hot_tub_maintenance_afternoons')[0:5])
            or (shift == 'wknd' and time == states('input_datetime.hot_tub_maintenance_weekends')[0:5]) }}
    condition:
      - condition: state
        entity_id: input_boolean.hot_tub_maintenance_enabled
        state: 'on'

      - condition: template
        alias: 'Never ran or day interval reached'
        value_template: >
          {% set last_run = state_attr('automation.hot_tub_maintenance_activate_reminder','last_triggered') %}
          {{ last_run is none or (now().date() - last_run.date()).days >= states('input_number.hot_tub_maintenance_day_interval')|int(0) }}
    action:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.hot_tub_maintenance_active

  ###############################################################################
  ## Reminders - Hot tub maintenance Alert
  ###############################################################################
  - id: reminders_hot_tub_maintenance_alert
    alias: '[Reminders] Hot tub maintenance Alert'
    description: 'Send notification until alert turns off.'
    trigger:
      - platform: state
        entity_id: input_boolean.hot_tub_maintenance_active
        to: 'on'
        for:
          seconds: 5 # allow boolean to turn back off without triggering if disabled
    condition:
      - condition: state
        entity_id:
          - input_boolean.hot_tub_maintenance_enabled
          - input_boolean.schedule_alerts
        state: 'on'
    action:
      - repeat:
          sequence:
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.schedule_alerts
                      state: 'on'
                  sequence:
                    - service: notify.jason
                      data:
                        title: 'Hot Tub Maintenance'
                        message: "It's time for some hot tub maintanance!"
                        data:
                          tag: hot_tub_maintenance
                          group: General
                          channel: General
                          importance: max
                          ttl: 0
                          priority: high
                          persistent: true
                          clickAction: /lovelace/schedule
                          color: !secret NOTIFY_COLOR
                          icon_url: !secret HOTTUB_ICON
                          image: !secret HOTTUB_IMAGE
                          actions:
                            - action: hot_tub_maintenance_done
                              title: 'Maintenance Done'
                              uri: /lovelace/schedule

            - wait_template: "{{ is_state('input_boolean.hot_tub_maintenance_active','off') }}"
              timeout: # wait for alert to turned off/dismissed
                minutes: 15

          until:
            - condition: state
              entity_id: input_boolean.hot_tub_maintenance_active
              state: 'off'

  ###############################################################################
  ## Reminders - Close Hot Tub Maintenance Notifications
  ###############################################################################
  - id: reminders_close_hot_tub_maintenance_notifications
    alias: '[Reminders] Close Hot Tub Maintenance Notifications'
    description: 'Clear notifications on all devices.'
    initial_state: true
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.hot_tub_maintenance_active
        to: 'off'

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: hot_tub_maintenance

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: hot_tub_maintenance_done
    action:
      - service: notify.jason
        data:
          message: clear_notification
          data:
            tag: hot_tub_maintenance
