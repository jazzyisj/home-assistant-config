#######################################################################################################################
## Garage Climate Package
#######################################################################################################################
homeassistant:
  customize:
    alert.garage_extended_heat:
      friendly_name: Garage Heat
      icon: mdi:fire
      category: garage_climate
    alert.garage_high_temperature:
      friendly_name: Garage High Temp
      icon: mdi:thermometer-alert
      category: garage_climate
    alert.garage_low_temperature:
      friendly_name: Garage Low Temp
      icon: mdi:snowflake-alert
      category: garage_climate

input_boolean:
#######################################################################################################################
## Garage Climate Automation
#######################################################################################################################
  garage_climate_automation:
    name: Garage Climate Automation
    icon: mdi:thermostat
    #OPTION initial: true

#######################################################################################################################
## Garage Freeze Protection
#######################################################################################################################
  garage_freeze_protection:
    name: Garage Freeze Protection
    icon: mdi:snowflake

#######################################################################################################################
## Garage Heat
#######################################################################################################################
  garage_heat:
    name: Garage Heat
    icon: mdi:fire
    initial: false # failsafe

input_number:
#######################################################################################################################
## Garage Heat Temperature
#######################################################################################################################
  garage_heat_temperature:
    name: Garage Heat Temperature
    icon: mdi:thermostat
    min: 40
    max: 75
    step: 1
    unit_of_measurement: '°'

#######################################################################################################################
## Garage Freeze Temperature
#######################################################################################################################
  garage_freeze_temperature:
    name: Garage Freeze Temperature
    icon: mdi:thermostat
    min: 40
    max: 75
    step: 1
    unit_of_measurement: '°'

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Garage Climate Extended Heat
#######################################################################################################################
      garage_extended_heat_alert:
        unique_id: garage_extended_heat_alert
        delay_on:
          minutes: 30
        value_template: >
          {{ is_state('input_boolean.garage_heat','on')
             or is_state('climate.garage_thermostat_mode','heating')
             and is_state('binary_sensor.alerts_enabled','on') }}

#######################################################################################################################
## Garage Climate Low Temp Alert
## - freeze protection on and less than freeze temp or heat on and less than set temp
## - + 5 buffer to reduce false alerts
## - sensor always on when heat first turned on (if outside temp < set temp)
#######################################################################################################################
      garage_low_temperature_alert: #OPTION use thermostat temp
        unique_id: garage_low_temperature_alert
        delay_on:
          minutes: 15 # let temp stabalize
        value_template: >
          {{ (is_state('input_boolean.garage_freeze_protection','on')
                and (states('sensor.garage_temperature')|int < states('input_number.garage_freeze_temperature')|int - 5 ))
              or (is_state('input_boolean.garage_heat','on')
                and (states('sensor.garage_temperature')|int < states('input_number.garage_heat_temperature')|int - 5 ))
              and is_state('binary_sensor.alerts_enabled','on') }}
        availability_template: "{{ states('sensor.garage_temperature')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Garage Climate High Temp Alert
## - heat on, furnace on, current temp > thermostat max_temp (+5)
## - heat off, freeze protection on, furnace on, current temp >  freeze temp (+ 5)
## - + 5 buffer to reduce false alerts
#######################################################################################################################
      garage_high_temperature_alert: #OPTION use thermostat temp
        unique_id: garage_high_temperature_alert
        delay_on:
          minutes: 5 # let temp stabalize
        value_template: >
          {{ (is_state('input_boolean.garage_heat','on')
                and is_state('climage.garage_thermostat','heating')
                and states('sensor.garage_temperature')|int > states('input_number.garage_heat_temperature')|int + 5 )
              or (is_state('input_boolean.garage_heat','off')
                and is_state('input_boolean.garage_freeze_protection','on')
                and is_state('climage.garage_thermostat','heating')
                and states('sensor.garage_temperature')|int > states('input_number.garage_freeze_temperature')|int + 5 )
              and is_state('binary_sensor.alerts_enabled','on') }}
        availability_template: "{{ states('sensor.garage_temperature')|lower not in ['unknown','unavailable','none'] }}"

sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Garage Climate Furnace
#######################################################################################################################
      garage_furnace:
        friendly_name: Garage Furnace
        unique_id: garage_furnace
        icon_template: mdi:fire
        value_template: "{{ state_attr('climate.garage_thermostat','operating_state') }}"
        availability_template: "{{ states('climate.garage_thermostat')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Garage Climate Furnace Fan
#######################################################################################################################
      garage_furnace_fan:
        friendly_name: Garage Furnace Fan
        unique_id: garage_furnace_fan
        icon_template: mdi:fan
        value_template: "{{ state_attr('climate.garage_thermostat','fan_state') }}"
        availability_template: "{{ states('climate.garage_thermostat')|lower not in ['unknown','unavailable','none'] }}"

alert:
#######################################################################################################################
## Garage Extended Heat
#######################################################################################################################
  garage_extended_heat:
    name: Garage Extended Heat
    title: Garage Extended Heat Alert
    message: "Garage Temperature: {{ states('sensor.garage_temperature') }}°"
    entity_id: binary_sensor.garage_extended_heat_alert
    state: 'on'
    repeat: 15
    notifiers: mobile_app_jphone
    data:
      tag: garage_extended_heat
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/garage
      color: !secret WARNING_COLOR
      icon_url: !secret HIGH_TEMP_ICON
      image: !secret HIGH_TEMP_IMAGE
      actions:
        - action: pause_garage_extended_heat
          title: Pause

#######################################################################################################################
## Garage High Temperature
#######################################################################################################################
  garage_high_temperature:
    name: Garage High Temperature
    title: Garage High Temperature Alert
    message: "Garage Temperature: {{ states('sensor.garage_temperature') }}°"
    entity_id: binary_sensor.garage_high_temperature_alert
    state: 'on'
    repeat: 60
    notifiers: mobile_app_jphone
    data:
      tag: garage_high_temperature
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/garage
      color: !secret WARNING_COLOR
      icon_url: !secret HIGH_TEMP_ICON
      image: !secret HIGH_TEMP_IMAGE
      actions:
        - action: pause_garage_high_temperature
          title: Pause

#######################################################################################################################
## Garage Low Temperature
#######################################################################################################################
  garage_climate_garage_low_temperature:
    name: Garage Low Temperature
    title: Garage Low Temperature Alert
    message: "Garage Temperature: {{ states('sensor.garage_temperature') }}°"
    entity_id: binary_sensor.garage_low_temperature_alert
    state: 'on'
    repeat: 60
    notifiers: mobile_app_jphone
    data:
      tag: garage_low_temperature
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/garage
      color: !secret WARNING_COLOR
      icon_url: !secret LOW_TEMP_ICON
      image: !secret LOW_TEMP_IMAGE
      actions:
        - action: pause_garage_low_temperature
          title: Pause
