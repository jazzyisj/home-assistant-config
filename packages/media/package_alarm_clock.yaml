###############################################################################
## Alarm Clock Package #NOTE alarm clock fails if WAN disconnected
###############################################################################
homeassistant:
  customize:
    alert.alarm_clock_presence:
      friendly_name: 'Alarm Clock Presence Alert'
      icon: mdi:alarm-check
      category: alarm_clock
    alert.alarm_clock_notification:
      friendly_name: 'Alarm Clock'
      icon: mdi:alarm-note
      category: alarm_clock

sensor:
  - platform: folder
    folder: '/config/www/alarm_clock_sounds'
    filter: '*'

input_boolean:
  alarm_clock_auto_workdays:
    name: 'Workdays'
    icon: mdi:alarm
  alarm_clock_auto_weekends:
    name: 'Weekends / Holidays'
    icon: mdi:alarm
  alarm_clock_guest:
    name: 'Guest'
    icon: mdi:alarm
  alarm_clock_manual:
    name: 'Manual Alarm Clock'
    icon: mdi:alarm-plus
  alarm_clock_nap:
    name: 'Nap Alarm Clock'
    icon: mdi:alarm-snooze
  resume_alarm_clock:
    name: 'Alarm Clock Resume'
    initial: false
  alarm_clock_increase_volume:
    name: 'Auto Increase Volume'
    icon: mdi:volume-low
  alarm_clock_alerts:
    name: 'Alarm Clock Alerts'
    icon: mdi:alarm-note
  alarm_clock_failed:
    name: 'Alarm Clock Failed'
    icon: mdi:bell-cancel
    initial: false

  alarm_clock_test_play:
    initial: false
  alarm_clock_stop_action:
    initial: false
  alarm_clock_snooze_stop_action:
    initial: false
  media_launcher_alarm_clock:
    initial: false
  alarm_clock_launcher_auto:
    initial: false
  alarm_clock_launcher_manual:
    initial: false
  alarm_clock_launcher_nap:
    initial: false
  alarm_clock_launcher_other:
    initial: false

  dining_room_display_alarm_clock_enabled:
    name: 'Dining Room Display Alarm Clock Enabled'
    icon: mdi:alarm
  bedroom_display_alarm_clock_enabled:
    name: 'Bedroom Room Display Alarm Clock Enabled'
    icon: mdi:alarm
  living_room_speaker_alarm_clock_enabled:
    name: 'Living Room Speaker Alarm Clock Enabled'
    icon: mdi:alarm
  bathroom_speaker_alarm_clock_enabled:
    name: 'Bathroom Room Speaker Alarm Clock Enabled'
    icon: mdi:alarm
  laundry_room_speaker_alarm_clock_enabled:
    name: 'Laundry Room Speaker Alarm Clock Enabled'
    icon: mdi:alarm
  garage_speaker_alarm_clock_enabled:
    name: 'Garage Speaker Alarm Clock Enabled'
    icon: mdi:alarm

input_select:
  alarm_clock_selection:
    name: 'Alarm Clock Selection'
    options:
      - Jason Phone
      - Sheri Phone
      - Dining Room Display
      - Bedroom Display
      - Bathroom Speaker
      - Living Room Speaker
      - Laundry Room Speaker
      - Garage Speaker
  alarm_clock_media_player_auto:
    name: 'Media Player'
    icon: mdi:speaker
    options: &media_player_names
      - All Speakers
      - Broadcast Speakers
      - Music Speakers
      - Quiet Speakers
      - Night Speakers
      - Inside Speakers
      - Living Room Speaker
      - Dining Room Display
      - Bedroom Display
      - Bathroom Speaker
      - Laundry Room Speaker
      - Garage Speaker
  alarm_clock_media_player_manual:
    name: 'Media Player'
    icon: mdi:speaker
    options: *media_player_names
  alarm_clock_media_player_nap:
    name: 'Media Player'
    icon: mdi:speaker
    options: *media_player_names
  alarm_clock_sound_auto: &alarm_sound
    name: 'Alarm Sound'
    icon: mdi:file-music
    options:
      - None
  alarm_clock_sound_manual: *alarm_sound
  alarm_clock_sound_nap: *alarm_sound

  alarm_clock_radio_auto: &alarm_clock_radio
    name: 'Alarm Clock Radio Playlist'
    icon: mdi:radio-tower
    options:
      - none
  alarm_clock_radio_manual: *alarm_clock_radio
  alarm_clock_radio_nap: *alarm_clock_radio
  alarm_clock_spotify_auto: &alarm_clock_spotify
    name: 'Alarm Clock Spotify Playlist'
    icon: mdi:spotify
    options:
      - none
  alarm_clock_spotify_manual: *alarm_clock_spotify
  alarm_clock_spotify_nap: *alarm_clock_spotify
  alarm_clock_youtube_auto: &alarm_clock_youtube
    name: 'Alarm Clock Youtube Playlist'
    icon: mdi:youtube
    options:
      - none
  alarm_clock_youtube_manual: *alarm_clock_youtube
  alarm_clock_youtube_nap: *alarm_clock_youtube

input_number:
  alarm_clock_volume_auto: &alarm_volume
    name: 'Volume'
    icon: mdi:volume-high
    min: 0
    max: 100
    step: 5
    unit_of_measurement: '%'
  alarm_clock_volume_manual: *alarm_volume
  alarm_clock_volume_nap: *alarm_volume

  alarm_clock_snooze_time:
    name: 'Snooze Time'
    icon: mdi:timer-outline
    min: 5
    max: 60
    step: 5
    unit_of_measurement: min
  alarm_clock_nap_time:
    name: 'Nap Timer'
    icon: mdi:timer-outline
    min: 5
    max: 240
    step: 5
    unit_of_measurement: min
  alarm_clock_play_delay:
    name: 'Play Delay'
    icon: mdi:timer-outline
    min: 0
    max: 300
    step: 10
    unit_of_measurement: seconds

input_datetime:
  alarm_clock_manual_time:
    name: 'Manual Alarm Wake Time'
    icon: mdi:clock
    has_date: false
    has_time: true

timer:
  alarm_clock_snooze:
    name: 'Snooze Time Remaining'
    icon: mdi:sleep
  alarm_clock_nap:
    name: Nap Time Remaining
    icon: mdi:alarm-plus

  guest_alarm_reset:
  auto_workday_alarm_reset:
  auto_weekend_alarm_reset:
  manual_alarm_reset:
  jphone_alarm_reset:
  sphone_alarm_reset:
  dining_room_display_alarm_reset:
  bedroom_display_alarm_reset:
  bathroom_speaker_alarm_reset:
  living_room_speaker_alarm_reset:
  laundry_room_speaker_alarm_reset:
  garage_speaker_alarm_reset:

input_text:
  active_alarm_clock_media_player:
  alarm_clock_sound_auto:
  alarm_clock_sound_manual:
  alarm_clock_sound_nap:

group:
  alarm_clock_selected_sounds: # must be in same order as stored sounds
    entities:
      - input_select.alarm_clock_sound_auto
      - input_select.alarm_clock_sound_manual
      - input_select.alarm_clock_sound_nap

  alarm_clock_stored_sounds: # must be in same order as sounds
    entities:
      - input_text.alarm_clock_sound_auto
      - input_text.alarm_clock_sound_manual
      - input_text.alarm_clock_sound_nap

switch:
  - platform: template
    switches:
      ###############################################################################
      ## Switch - Alarm Clock Auto
      ###############################################################################
      alarm_clock_auto:
        friendly_name: 'Alarm Clock: Auto'
        unique_id: alarm_clock_auto
        icon_template: mdi:alarm
        turn_on:
          - choose:
              - conditions:
                  - condition: template
                    alias: 'Alarm is not set for workday/weekend/guest and is not test play'
                    value_template: >
                      {{ (is_state('input_boolean.alarm_clock_guest','off') if is_state('binary_sensor.owner_home','off')
                          else (is_state('input_boolean.alarm_clock_auto_workdays','off') if is_state('binary_sensor.work_today','on')
                            else is_state('input_boolean.alarm_clock_auto_weekends','off')))
                          and is_state('input_boolean.alarm_clock_test_play','off') }}
                sequence:
                  - service: browser_mod.toast
                    data:
                      message: 'The auto alarm clock has not been set.'
                      duration: 30000

                  - service: script.turn_on
                    target:
                      entity_id: script.alarm_clock_stop
                    data:
                      variables:
                        alarm_type: auto
            default:
              # don't run if called from alarm_clock_play
              - condition: state
                entity_id: script.alarm_clock_play
                state: 'off'

              - service: script.turn_on
                target:
                  entity_id: script.alarm_clock_play
                data:
                  variables:
                    alarm_type: auto
                    first_run: true
        turn_off:
          # don't run if called from alarm_clock_stop
          - condition: state
            entity_id: script.alarm_clock_stop
            state: 'off'

          - service: script.turn_on
            target:
              entity_id: script.alarm_clock_stop
            data:
              variables:
                alarm_type: auto

      ###############################################################################
      ## Switch - Alarm Clock Manual
      ###############################################################################
      alarm_clock_manual:
        friendly_name: 'Alarm Clock: Manual'
        unique_id: alarm_clock_manual
        icon_template: mdi:alarm
        turn_on:
          - choose:
              - conditions:
                  - condition: state
                    entity_id:
                      - input_boolean.alarm_clock_manual
                      - input_boolean.alarm_clock_test_play
                    state: 'off'
                sequence:
                  - service: browser_mod.toast
                    data:
                      message: 'The manual alarm clock has not been set.'
                      duration: 30000

                  - service: script.turn_on
                    target:
                      entity_id: script.alarm_clock_stop
                    data:
                      variables:
                        alarm_type: manual
            default:
              - condition: state
                entity_id: script.alarm_clock_play
                state: 'off'

              - service: script.turn_on
                target:
                  entity_id: script.alarm_clock_play
                data:
                  variables:
                    alarm_type: manual
                    first_run: true
        turn_off:
          - condition: state
            entity_id: script.alarm_clock_stop
            state: 'off'

          - service: script.turn_on
            target:
              entity_id: script.alarm_clock_stop
            data:
              variables:
                alarm_type: manual

      ###############################################################################
      ## Switch - Alarm Clock Nap
      ###############################################################################
      alarm_clock_nap:
        friendly_name: 'Alarm Clock: Nap'
        unique_id: alarm_clock_nap
        icon_template: mdi:alarm
        turn_on:
          - choose:
              - conditions:
                  - condition: state
                    entity_id:
                      - input_boolean.alarm_clock_nap
                      - input_boolean.alarm_clock_test_play
                    state: 'off'
                sequence:
                  - service: browser_mod.toast
                    data:
                      message: 'The nap alarm clock has not been set.'
                      duration: 30000

                  - service: script.turn_on
                    target:
                      entity_id: script.alarm_clock_stop
                    data:
                      variables:
                        alarm_type: nap
            default:
              - condition: state
                entity_id: script.alarm_clock_play
                state: 'off'

              - service: script.turn_on
                target:
                  entity_id: script.alarm_clock_play
                data:
                  variables:
                    alarm_type: nap
                    first_run: true
        turn_off:
          - condition: state
            entity_id: script.alarm_clock_stop
            state: 'off'

          - service: script.turn_on
            target:
              entity_id: script.alarm_clock_stop
            data:
              variables:
                alarm_type: nap

      ###############################################################################
      ## Switch - Alarm Clock Snooze
      ###############################################################################
      alarm_clock_snooze:
        friendly_name: 'Alarm Clock: Snooze'
        unique_id: alarm_clock_snooze
        icon_template: mdi:sleep
        value_template: >
          {{ is_state('binary_sensor.alarm_clock','on')
              and is_state('timer.alarm_clock_snooze','active') }}
        turn_on:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: binary_sensor.alarm_clock
                    state: 'off'
                sequence:
                  - service: browser_mod.toast
                    data:
                      message: 'No active alarm clock. Snooze turned off.'
                      duration: 30000
            default:
              - service: timer.start
                target:
                  entity_id: timer.alarm_clock_snooze
                data:
                  duration:
                    minutes: "{{ states('input_number.alarm_clock_snooze_time')|int(0) }}"

              - choose:
                  - conditions: "{{ is_state(states('sensor.alarm_clock_media_player'),'playing') }}"
                    sequence:
                      - service: media_player.media_pause
                        target:
                          entity_id: "{{ states('sensor.alarm_clock_media_player') }}"

              - condition: state
                entity_id: input_boolean.alarm_clock_alerts
                state: 'on'

              - condition: state
                entity_id: input_boolean.alarm_clock_test_play
                state: 'off'

              - service: >
                  {% if (is_state('input_boolean.jason_phone_alarm_clock_notifications','on')
                      and is_state('binary_sensor.jason_home','on'))
                    and (is_state('input_boolean.sheri_phone_alarm_clock_notifications','on')
                      and is_state('binary_sensor.sheri_home','on')) %} notify.mobile
                  {% elif is_state('input_boolean.jason_phone_alarm_clock_notifications','on')
                    and is_state('binary_sensor.jason_home','on') %} notify.jason
                  {% elif is_state('input_boolean.sheri_phone_alarm_clock_notifications','on')
                    and is_state('binary_sensor.sheri_home','on') %} notify.sheri
                  {% endif %}
                data:
                  title: 'Alarm Clock Snoozed!'
                  message: >
                    {% set snooze = states('input_number.alarm_clock_snooze_time')|int(0) %}
                    Snooze: {{ snooze }} minutes.
                    Alarm: {{ (now() + timedelta(minutes=snooze)).strftime('%-I:%M %p') }}.
                  data:
                    tag: alarm_clock
                    group: General
                    channel: General
                    importance: max
                    ttl: 0
                    priority: high
                    persistent: true
                    sticky: true
                    color: !secret NOTIFY_COLOR
                    icon_url: !secret ALARM_CLOCK_ICON
                    chronometer: true
                    when: "{{ (now().timestamp() + states('input_number.alarm_clock_snooze_time')|int(0) * 60) }}"
                    actions:
                      - action: turn_off_alarm_clock
                        title: 'Turn Off Alarm'
        turn_off:
          - choose:
              - conditions:
                  - condition: state
                    entity_id: input_boolean.alarm_clock_snooze_stop_action
                    state: 'off'

                  - condition: state
                    entity_id: script.alarm_clock_stop
                    state: 'off'

                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: binary_sensor.alarm_clock
                        state: 'on'

                      - condition: state
                        entity_id: script.alarm_clock_sound_play
                        state: 'on'

                      - condition: state
                        entity_id: timer.alarm_clock_nap
                        state: 'active'

                      - condition: state
                        entity_id: timer.alarm_clock_snooze
                        state: 'active'

                      - condition: state
                        entity_id: input_boolean.alarm_clock_nap
                        state: 'on'
                sequence:
                  - service: script.turn_on
                    target:
                      entity_id: script.alarm_clock_stop
                    data:
                      variables:
                        alarm_type: "{{ state_attr('binary_sensor.alarm_clock','alarm_type') }}"

          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.alarm_clock_snooze_stop_action

alert:
  alarm_clock_presence:
    name: 'Alarm Clock Presence'
    title: 'Alarm Clock Presence Alert'
    message: 'Nobody is home and an alarm clock is active.'
    done_message: clear_notification
    entity_id: binary_sensor.alarm_clock_presence_alert
    state: 'on'
    repeat: 5
    notifiers: jason
    data:
      tag: alarm_clock_presence
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/schedule
      color: !secret WARNING_COLOR
      icon_url: !secret ALARM_CLOCK_ICON
      actions:
        - action: turn_off_alarm_clock
          title: 'Turn Off Alarm'
        - action: pause_alarm_clock_presence
          title: 'Pause Alert'
