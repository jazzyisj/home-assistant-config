###############################################################################
## Spotify Package
###############################################################################
homeassistant:
  customize:
    alert.spotify_connected:
      friendly_name: 'Spotify Connected'
      icon: mdi:spotify
      category: media
    light.spotify_volume:
      type: volume
    light.spotify_jason_volume:
      type: volume
    light.spotify_sheri_volume:
      type: volume

    media_player.spotify:
      friendly_name: 'Spotify: Hassio'
      type: master
    media_player.spotify_jason:
      friendly_name: 'Spotify: Jason'
      type: master
    media_player.spotify_sheri:
      friendly_name: 'Spotify: Sheri'
      type: master

spotify:
  client_id: !secret SPOTIFY_CLIENTID
  client_secret: !secret SPOTIFY_SECRET

spotcast: # https://github.com/fondberg/spotcast
  sp_dc: !secret HASSIO_SP_DC
  sp_key: !secret HASSIO_SP_KEY
  accounts:
    hassio:
      sp_dc: !secret HASSIO_SP_DC
      sp_key: !secret HASSIO_SP_KEY
    jazzyisj:
      sp_dc: !secret JAZZYISJ_SP_DC
      sp_key: !secret JAZZYISJ_SP_KEY
    sherigagnon:
      sp_dc: !secret SHERI_SP_DC
      sp_key: !secret SHERI_SP_KEY

media_player:
  - platform: universal
    name: 'Spotify'
    children:
      - media_player.spotify_hassio
    commands:
      turn_on:
        service: script.media_play
        data:
          media_type: spotify
      turn_off:
        service: script.media_stop
        data:
          media_type: spotify

  - platform: universal
    name: 'Spotify: Jason'
    children:
      - media_player.spotify_jazzyisj
    commands:
      turn_on:
        service: script.media_play
        data:
          media_type: spotify_jason
      turn_off:
        service: script.media_stop
        data:
          media_type: spotify_jason

  - platform: universal
    name: 'Spotify: Sheri'
    children:
      - media_player.spotify_sherigagnon
    commands:
      turn_on:
        service: script.media_play
        data:
          media_type: spotify_sheri
      turn_off:
        service: script.media_stop
        data:
          media_type: spotify_sheri

input_boolean:
  spotify_random:
    name: 'Spotify Random'
    icon: mdi:progress-question
  spotify_shuffle:
    name: 'Spotify Shuffle'
    icon: mdi:shuffle-variant
  spotify_repeat:
    name: 'Spotify Repeat'
    icon: mdi:replay

  spotify_failed:
    initial: false
  spotify_jason_failed:
    initial: false
  spotify_sheri_failed:
    initial: false

  resume_spotify:
    initial: false
  resume_spotify_jason:
    initial: false
  resume_spotify_sheri:
    initial: false

  media_launcher_spotify:
    initial: false

input_text:
  active_spotify_media_player:
  active_spotify_jason_media_player:
  active_spotify_sheri_media_player:
  spotify_playlist:
  spotify_jason_playlist:
  spotify_sheri_playlist:
  media_preset_spotify_jason:
  media_preset_spotify_sheri:
  media_preset_spotify_guest:
  media_preset_spotify_wake:
  media_preset_spotify_morning:
  media_preset_spotify_sleep:
  media_preset_spotify_shower:
  media_preset_spotify_chill:
  media_preset_spotify_company:
  alarm_clock_spotify_auto:
  alarm_clock_spotify_manual:
  alarm_clock_spotify_nap:

input_select:
  spotify_account:
    name: 'Spotify Account'
    icon: mdi:account-circle
    options:
      - Hassio
      - Jason
      - Sheri

  spotify_media_player:
    name: 'Spotify Player'
    icon: mdi:speaker-wireless
    options: !include /config/include/entities/media_player_names.yaml
  spotify_jason_media_player:
    name: 'Spotify Player Jason'
    icon: mdi:speaker-wireless
    options: !include /config/include/entities/media_player_names.yaml
  spotify_sheri_media_player:
    name: 'Spotify Player Sheri'
    icon: mdi:speaker-wireless
    options: !include /config/include/entities/media_player_names.yaml

  spotify_playlist:
    name: 'Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  spotify_jason_playlist:
    name: 'Spotify Jason Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  spotify_sheri_playlist:
    name: 'Spotify Sheri Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  #######################################################################################################################
  ## Spotify Media Presets
  #######################################################################################################################
  media_preset_spotify_wake:
    name: 'Wake Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_morning:
    name: 'Morning Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_sleep:
    name: 'Sleep Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_jason:
    name: 'Jason Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_sheri:
    name: 'Sheri Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_guest:
    name: 'Guest Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_shower:
    name: 'Shower Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_chill:
    name: 'Chill Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none
  media_preset_spotify_company:
    name: 'Company Spotify Playlist'
    icon: mdi:format-list-bulleted
    options:
      - none

input_number:
  spotify_volume:
    name: 'Spotify Volume'
    icon: mdi:volume-high
    unit_of_measurement: '%'
    min: 0
    max: 100
    step: 5

  spotify_jason_volume:
    name: 'Spotify Jason Volume'
    icon: mdi:volume-high
    unit_of_measurement: '%'
    min: 0
    max: 100
    step: 5

  spotify_sheri_volume:
    name: 'Spotify Sheri Volume'
    icon: mdi:volume-high
    unit_of_measurement: '%'
    min: 0
    max: 100
    step: 5

  spotify_volume_adjustment:
    name: 'Spotify Volume Adjustment'
    icon: mdi:volume-high
    min: -1
    max: 1
    step: 0.1

sensor:
  - platform: spotcast # https://github.com/fondberg/spotcast

light: # volume control for media launcher
  - platform: template
    lights:
      spotify_volume:
        friendly_name: 'Spotify Volume'
        value_template: 'on'
        icon_template: >
          {{ 'mdi:volume-off' if is_state('binary_sensor.spotify', 'off')
              or state_attr('media_player.spotify', 'is_volume_muted') else 'mdi:volume-high' }}
        turn_on:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify
          data:
            is_volume_muted: false
        turn_off:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify
          data:
            is_volume_muted: true
        set_level:
          service: input_number.set_value
          target:
            entity_id: input_number.spotify_volume
          data:
            value: '{{ (brightness/255 * 100)|int(0) }}'
        level_template: "{{ (states('input_number.spotify_volume')|float/100 * 255)|int(0) }}"

      spotify_jason_volume:
        friendly_name: 'Spotify Jason Volume'
        value_template: 'on'
        icon_template: >
          {{ 'mdi:volume-off' if is_state('binary_sensor.spotify_jason', 'off')
              or state_attr('media_player.spotify_jason', 'is_volume_muted') else 'mdi:volume-high' }}
        turn_on:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify_jason','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify_jason
          data:
            is_volume_muted: false
        turn_off:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify_jason','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify_jason
          data:
            is_volume_muted: true
        set_level:
          service: input_number.set_value
          target:
            entity_id: input_number.spotify_jason_volume
          data:
            value: '{{ (brightness/255 * 100)|int(0) }}'
        level_template: "{{ (states('input_number.spotify_jason_volume')|float/100 * 255)|int(0) }}"

      spotify_sheri_volume:
        friendly_name: 'Spotify Sheri Volume'
        value_template: 'on'
        icon_template: >
          {{ 'mdi:volume-off' if is_state('binary_sensor.spotify_sheri', 'off')
              or state_attr('media_player.spotify_sheri', 'is_volume_muted') else 'mdi:volume-high' }}
        turn_on:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify_sheri','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify_sheri
          data:
            is_volume_muted: false
        turn_off:
          service: "{{ 'media_player.volume_mute' if is_state('binary_sensor.spotify_sheri','on') else 'script.null_script' }}"
          target:
            entity_id: media_player.spotify_sheri
          data:
            is_volume_muted: true
        set_level:
          service: input_number.set_value
          target:
            entity_id: input_number.spotify_sheri_volume
          data:
            value: '{{ (brightness/255 * 100)|int(0) }}'
        level_template: "{{ (states('input_number.spotify_sheri_volume')|float/100 * 255)|int(0) }}"

group:
  spotify_selected_playlists: # must be in same order as stored playlists
    entities:
      - input_select.spotify_playlist
      - input_select.spotify_jason_playlist
      - input_select.spotify_sheri_playlist
      - input_select.media_preset_spotify_jason
      - input_select.media_preset_spotify_sheri
      - input_select.media_preset_spotify_guest
      - input_select.media_preset_spotify_wake
      - input_select.media_preset_spotify_morning
      - input_select.media_preset_spotify_sleep
      - input_select.media_preset_spotify_shower
      - input_select.media_preset_spotify_chill
      - input_select.media_preset_spotify_company
      - input_select.alarm_clock_spotify_auto
      - input_select.alarm_clock_spotify_manual
      - input_select.alarm_clock_spotify_nap

  spotify_stored_playlists: # must be in same order as selected playlists
    entities:
      - input_text.spotify_playlist
      - input_text.spotify_jason_playlist
      - input_text.spotify_sheri_playlist
      - input_text.media_preset_spotify_jason
      - input_text.media_preset_spotify_sheri
      - input_text.media_preset_spotify_guest
      - input_text.media_preset_spotify_wake
      - input_text.media_preset_spotify_morning
      - input_text.media_preset_spotify_sleep
      - input_text.media_preset_spotify_shower
      - input_text.media_preset_spotify_chill
      - input_text.media_preset_spotify_company
      - input_text.alarm_clock_spotify_auto
      - input_text.alarm_clock_spotify_manual
      - input_text.alarm_clock_spotify_nap

alert:
  spotify_failed: # no alert for jason/sheri
    name: 'Spotify Failed'
    title: 'Spotify Failed'
    message: 'Spotify play has failed.'
    done_message: clear_notification
    entity_id: input_boolean.spotify_failed
    state: 'on'
    repeat:
      - 5
      - 720
    skip_first: true
    notifiers: jason
    data:
      tag: spotify_failed
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/media
      color: !secret WARNING_COLOR
      icon_url: !secret ALERT_ICON
      actions:
        - action: spotify_failed_reset
          title: 'Reset Spotify'

  spotify_jason_failed: # no alert for jason/sheri
    name: 'Spotify Jason Failed'
    title: 'Spotify Jason Failed'
    message: 'Spotify Jason play has failed.'
    done_message: clear_notification
    entity_id: input_boolean.spotify_jason_failed
    state: 'on'
    repeat:
      - 5
      - 720
    skip_first: true
    notifiers: jason
    data:
      tag: spotify_jason_failed
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/media
      color: !secret WARNING_COLOR
      icon_url: !secret ALERT_ICON
      actions:
        - action: spotify_jason_failed_reset
          title: 'Reset Spotify'

  spotify_sheri_failed: # no alert for jason/sheri
    name: 'Spotify Sheri Failed'
    title: 'Spotify Sheri Failed'
    message: 'Spotify Sheri play has failed.'
    done_message: clear_notification
    entity_id: input_boolean.spotify_sheri_failed
    state: 'on'
    repeat:
      - 5
      - 720
    skip_first: true
    notifiers: jason
    data:
      tag: spotify_sheri_failed
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/media
      color: !secret WARNING_COLOR
      icon_url: !secret ALERT_ICON
      actions:
        - action: spotify_sheri_failed_reset
          title: 'Reset Spotify'
