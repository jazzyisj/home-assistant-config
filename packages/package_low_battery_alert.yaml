#######################################################################################################################
## Package - Low Battery Alert
## use system category
#######################################################################################################################
homeassistant:
  customize:
    alert.low_battery:
      friendly_name: Low Battery
      icon: mdi:battery-alert
      category: system

input_number:
  battery_alert_threshold:
    name: Battery Alert Threshold
    icon: mdi:battery-alert
    min: 0
    max: 100
    step: 1
    unit_of_measurement: '%'

group:
#######################################################################################################################
## Nest Batteries Group  -  battery states: Ok, Replace
#######################################################################################################################
  nest_batteries:
    entities:
      - sensor.downstairs_nest_protect_battery_health
      - sensor.upstairs_nest_protect_battery_health

#######################################################################################################################
## Low Battery Sensor
#######################################################################################################################
binary_sensor:
  - platform: template
    sensors:
      low_battery_alert:
        friendly_name: Low Battery
        unique_id: low_battery_alert
        icon_template: "{{ 'mdi:battery-alert' if is_state('binary_sensor.low_battery_alert','on') else 'mdi:battery-90' }}"
        device_class: problem
        value_template: >
          {{ 'false' if is_state('binary_sensor.alerts_enabled','off')
                else (expand('group.nest_batteries')|selectattr('state','eq','Replace')|list|count > 0
                        or states.zwave|selectattr('attributes.battery_level','defined')
                        |selectattr('attributes.battery_level','<=', states('input_number.battery_alert_threshold')|int)
                        |map(attribute='entity_id')|list|count > 0) }}

alert:
#######################################################################################################################
## System - Low Battery
#NOTE just playing with a different technique for message loop
#######################################################################################################################
  low_battery:
    name: Low Battery
    title: Low Battery Alert
    message: >
      {%- set ns = namespace(message='') -%}
      {%- set t = states('input_number.battery_alert_threshold')|int -%}
      {%- set b = states.zwave|selectattr('attributes.battery_level','defined')
          |rejectattr('state','!=','ready')|selectattr('attributes.battery_level','>=',t) -%}
      {%- for i in b -%}
        {%- set ns.m = ns.m ~ '- ' ~ i.name ~ ' (' ~ '%0.0f'|format(i.attributes.battery_level|float)|string ~ '%)<br/>' -%}
      {%- endfor -%}
      {%- set nb = expand('group.nest_batteries')|selectattr('state','eq','Replace') -%}
      {%- for i in nb -%}{%- set ns.m = ns.m ~ '- ' ~ i.name ~ '<br/>' -%}{%- endfor -%}
      {{ ns.m }}
    entity_id: binary_sensor.low_battery_alert
    state: 'on'
    repeat: 1440
    notifiers: mobile_app_jphone
    data:
      tag: low_battery
      group: System
      channel: Alert
      importance: max
      clickAction: /lovelace/system
      color: !secret WARNING_COLOR
      icon_url: !secret BATTERY_ICON
      image: !secret BATTERY_IMAGE
      actions:
        - action: pause_low_battery
          title: Pause