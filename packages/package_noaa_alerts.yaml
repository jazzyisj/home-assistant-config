#######################################################################################################################
## NOAA Weather Alerts Integration Package
## https://github.com/dcshoecomp/noaa_alerts
#######################################################################################################################
homeassistant:
  customize:
    alert.noaa_weather_alert:
      friendly_name: NOAA Alert
      icon: mdi:weather-hurricane
      category: weather

input_text:
  current_noaa_alert_severity:
  previous_noaa_alert_severity:

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## NOAA Connected
#######################################################################################################################
      noaa_connected:
        friendly_name: NOAA
        unique_id: noaa_connected
        icon_template: "{{ 'mdi:weather-hurricane' if is_state('binary_sensor.noaa_connected','on') else 'mdi:alert-circle' }}"
        device_class: connectivity
        value_template: "{{ not states('sensor.noaa_alerts_miz076')|lower in ['unknown','unavailable','none'] }}"

      noaa_connected_alert:
        friendly_name: NOAA
        unique_id: noaa_connected_alert
        icon_template: mdi:alert-circle
        value_template: "{{ is_state('binary_sensor.noaa_connected','off')  and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Active NOAA Weather Alert
#######################################################################################################################
      noaa_alert_active:
        friendly_name: NOAA Alert
        unique_id: noaa_alert_active
        icon_template: mdi:weather-hurricane
        device_class: safety
        value_template: "{{ states('sensor.noaa_alerts_miz076')|int > 0 }}"
        availability_template: "{{ is_state('binary_sensor.noaa_connected','on') }}"

sensor:
  - platform: noaa_alerts
    zoneid: MIZ076
    #OPTION zoneid: MIC163

  - platform: template
    sensors:
#######################################################################################################################
## NOAA Severe Weather Alert
#IDEA get list of noaa conditions for array
#######################################################################################################################
      noaa_severe_weather_alert: #VERIFY #TEST this is turning on for all these and/or warning severity for menu button
        unique_id: noaa_severe_weather_alert
        value_template: >
          {% set conditions = ['blowing snow','extreme cold','wind','rainfall','winter storm','snow squall','hail','freezing rain','snowfall','blizzard','tornado','storm surge','wreckhouse wind'] %}
          {% set found = namespace(value=0) %}
          {% for condition in conditions %}
            {% if condition in state_attr('sensor.dark_sky_alerts','title_0')|lower %}{% set found.value = 1 %}{% endif %}
          {% endfor %}
          {{ 'on' if state_attr('sensor.noaa_alerts_miz076','event_severity')|lower in ['extreme','severe'] or found.value == 1 else 'off' }}
        attribute_templates:
          condition: >
            {% set conditions = ['blowing snow','extreme cold','wind','rainfall','winter storm','snow squall','hail','freezing rain','snowfall','blizzard','tornado','storm surge','wreckhouse wind'] %}
            {% set found = namespace() %}
            {% for condition in conditions %}
              {% if condition in state_attr('sensor.dark_sky_alerts','title_0')|lower %}{% set found.value = conditions[loop.index0] %}{% endif %}
            {% endfor %}
            {{ found.value|title if found.value != '' else 'No' }} Warning
        availability_template: "{{ states('sensor.dark_sky_alerts')|lower not in ['unknown','unavailable','none'] }}"

alert:
  noaa_weather_alert:
    name: NOAA Weather Alert
    title: NOAA Weather Alert
    message: |
      {% set type = states.sensor.noaa_alerts_miz076.attributes.alerts[0].messageType %}
      {% set event = states.sensor.noaa_alerts_miz076.attributes.alerts[0].event %}
      {% set headline = states.sensor.noaa_alerts_miz076.attributes.alerts[0].parameters.NWSheadline %}
      {% set severity = states.sensor.noaa_alerts_miz076.attributes.alerts[0].severity %}
      {% set inst = states.sensor.noaa_alerts_miz076.attributes.alerts[0].instruction %}
      {% set start = as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].onset)|timestamp_custom('%_I:%M %p, %A',true) %}
      {% set until = as_timestamp(states.sensor.noaa_alerts_miz076.attributes.alerts[0].expires)|timestamp_custom('%_I:%M %p, %A',true) %}
      The National Weather Service has issued a {{ severity }} weather {{ type }}.
      There is a {{ event }} in effect at {{ start }}{{ ' until' ~ until if until != None }}.
      {{ headline[0] ~ '.' if headline != None }}
      {{ inst ~ '.' if inst != None }}
    entity_id: binary_sensor.noaa_alert_active
    state: 'on'
    repeat: 720
    can_acknowledge: false
    notifiers: mobile
    data:
      tag: noaa_weather_alert
      group: General
      channel: Alert
      importance: max
      timeout: 86400
      clickAction: /lovelace/weather
      color: !secret WEATHER_COLOR
      icon_url: !secret STORM_ICON

# status - Actual
# messageType - Alert, Update
# severity - Severe, Moderate, Extreme
# HazardType - Heavy Snow, Snow
# certainty - Possible, Likely, Observed
# urgency - Expected
# Event - Special Weather Statement, Winter Weather Advisory


# alerts:
#   - '@id': 'https://api.weather.gov/alerts/NWS-IDP-PROD-4468116-3715033'
#     '@type': 'wx:Alert'
#     id: NWS-IDP-PROD-4468116-3715033
#     areaDesc: >-
#       Oakland; Livingston; Midland; Lenawee; Huron; Bay; Tuscola; Monroe;
#       Genesee; Saginaw; Sanilac; Wayne; Shiawassee; St. Clair; Lapeer;
#       Washtenaw; Macomb
#     geocode:
#       UGC:
#         - MIZ069
#         - MIZ068
#         - MIZ047
#         - MIZ082
#         - MIZ049
#         - MIZ048
#         - MIZ054
#         - MIZ083
#         - MIZ061
#         - MIZ053
#         - MIZ055
#         - MIZ076
#         - MIZ060
#         - MIZ063
#         - MIZ062
#         - MIZ075
#         - MIZ070
#       SAME:
#         - '026125'
#         - 026093
#         - '026111'
#         - 026091
#         - '026063'
#         - '026017'
#         - '026157'
#         - '026115'
#         - 026049
#         - '026145'
#         - '026151'
#         - '026163'
#         - '026155'
#         - '026147'
#         - 026087
#         - '026161'
#         - 026099
#     affectedZones:
#       - 'https://api.weather.gov/zones/forecast/MIZ069'
#       - 'https://api.weather.gov/zones/forecast/MIZ068'
#       - 'https://api.weather.gov/zones/forecast/MIZ047'
#       - 'https://api.weather.gov/zones/forecast/MIZ082'
#       - 'https://api.weather.gov/zones/forecast/MIZ049'
#       - 'https://api.weather.gov/zones/forecast/MIZ048'
#       - 'https://api.weather.gov/zones/forecast/MIZ054'
#       - 'https://api.weather.gov/zones/forecast/MIZ083'
#       - 'https://api.weather.gov/zones/forecast/MIZ061'
#       - 'https://api.weather.gov/zones/forecast/MIZ053'
#       - 'https://api.weather.gov/zones/forecast/MIZ055'
#       - 'https://api.weather.gov/zones/forecast/MIZ076'
#       - 'https://api.weather.gov/zones/forecast/MIZ060'
#       - 'https://api.weather.gov/zones/forecast/MIZ063'
#       - 'https://api.weather.gov/zones/forecast/MIZ062'
#       - 'https://api.weather.gov/zones/forecast/MIZ075'
#       - 'https://api.weather.gov/zones/forecast/MIZ070'
#     references: []
#     sent: '2020-10-02T14:38:00-04:00'
#     effective: '2020-10-02T14:38:00-04:00'
#     onset: '2020-10-03T00:00:00-04:00'
#     expires: '2020-10-03T08:00:00-04:00'
#     ends: '2020-10-03T08:00:00-04:00'
#     status: Actual
#     messageType: Alert
#     category: Met
#     severity: Minor
#     certainty: Likely
#     urgency: Expected
#     event: Frost Advisory
#     sender: w-nws.webmaster@noaa.gov
#     senderName: NWS Detroit/Pontiac MI
#     headline: >-
#       Frost Advisory issued October 2 at 2:38PM EDT until October 3 at 8:00AM
#       EDT by NWS Detroit/Pontiac MI
#     description: |-
#       * WHAT...Clearing sky after midnight leads to low temperatures in
#       the mid 30s and frost formation most locations by sunrise
#       Saturday.

#       * WHERE...Southeast Michigan mainly outside of Detroit.

#       * WHEN...From midnight tonight to 8 AM EDT Saturday.

#       * IMPACTS...Frost could kill sensitive outdoor vegetation if left
#       uncovered.
#     instruction: Take steps now to protect vulnerable plants from the cold.
#     response: Prepare
#     parameters:
#       NWSheadline:
#         - FROST ADVISORY IN EFFECT FROM MIDNIGHT TONIGHT TO 8 AM EDT SATURDAY
#       VTEC:
#         - /O.NEW.KDTX.FR.Y.0003.201003T0400Z-201003T1200Z/
#       PIL:
#         - DTXNPWDTX
#       BLOCKCHANNEL:
#         - CMAS
#         - EAS
#         - NWEM
#       eventEndingTime:
#         - '2020-10-03T12:00:00+00:00'
# urgency: Expected
# event_type: Frost Advisory
# event_severity: Minor
# description: |-
#   * WHAT...Clearing sky after midnight leads to low temperatures in
#   the mid 30s and frost formation most locations by sunrise
#   Saturday.

#   * WHERE...Southeast Michigan mainly outside of Detroit.

#   * WHEN...From midnight tonight to 8 AM EDT Saturday.

#   * IMPACTS...Frost could kill sensitive outdoor vegetation if left
#   uncovered.
# headline: >-
#   Frost Advisory issued October 2 at 2:38PM EDT until October 3 at 8:00AM EDT by
#   NWS Detroit/Pontiac MI
# instruction: Take steps now to protect vulnerable plants from the cold.
# alerts_string: >-
#   [{"@id": "https://api.weather.gov/alerts/NWS-IDP-PROD-4468116-3715033",
#   "@type": "wx:Alert", "id": "NWS-IDP-PROD-4468116-3715033", "areaDesc":
#   "Oakland; Livingston; Midland; Lenawee; Huron; Bay; Tuscola; Monroe; Genesee;
#   Saginaw; Sanilac; Wayne; Shiawassee; St. Clair; Lapeer; Washtenaw; Macomb",
#   "geocode": {"UGC": ["MIZ069", "MIZ068", "MIZ047", "MIZ082", "MIZ049",
#   "MIZ048", "MIZ054", "MIZ083", "MIZ061", "MIZ053", "MIZ055", "MIZ076",
#   "MIZ060", "MIZ063", "MIZ062", "MIZ075", "MIZ070"], "SAME": ["026125",
#   "026093", "026111", "026091", "026063", "026017", "026157", "026115",
#   "026049", "026145", "026151", "026163", "026155", "026147", "026087",
#   "026161", "026099"]}, "affectedZones":
#   ["https://api.weather.gov/zones/forecast/MIZ069",
#   "https://api.weather.gov/zones/forecast/MIZ068",
#   "https://api.weather.gov/zones/forecast/MIZ047",
#   "https://api.weather.gov/zones/forecast/MIZ082",
#   "https://api.weather.gov/zones/forecast/MIZ049",
#   "https://api.weather.gov/zones/forecast/MIZ048",
#   "https://api.weather.gov/zones/forecast/MIZ054",
#   "https://api.weather.gov/zones/forecast/MIZ083",
#   "https://api.weather.gov/zones/forecast/MIZ061",
#   "https://api.weather.gov/zones/forecast/MIZ053",
#   "https://api.weather.gov/zones/forecast/MIZ055",
#   "https://api.weather.gov/zones/forecast/MIZ076",
#   "https://api.weather.gov/zones/forecast/MIZ060",
#   "https://api.weather.gov/zones/forecast/MIZ063",
#   "https://api.weather.gov/zones/forecast/MIZ062",
#   "https://api.weather.gov/zones/forecast/MIZ075",
#   "https://api.weather.gov/zones/forecast/MIZ070"], "references": [], "sent":
#   "2020-10-02T14:38:00-04:00", "effective": "2020-10-02T14:38:00-04:00",
#   "onset": "2020-10-03T00:00:00-04:00", "expires": "2020-10-03T08:00:00-04:00",
#   "ends": "2020-10-03T08:00:00-04:00", "status": "Actual", "messageType":
#   "Alert", "category": "Met", "severity": "Minor", "certainty": "Likely",
#   "urgency": "Expected", "event": "Frost Advisory", "sender":
#   "w-nws.webmaster@noaa.gov", "senderName": "NWS Detroit/Pontiac MI",
#   "headline": "Frost Advisory issued October 2 at 2:38PM EDT until October 3 at
#   8:00AM EDT by NWS Detroit/Pontiac MI", "description": "* WHAT...Clearing sky
#   after midnight leads to low temperatures in\nthe mid 30s and frost formation
#   most locations by sunrise\nSaturday.\n\n* WHERE...Southeast Michigan mainly
#   outside of Detroit.\n\n* WHEN...From midnight tonight to 8 AM EDT
#   Saturday.\n\n* IMPACTS...Frost could kill sensitive outdoor vegetation if
#   left\nuncovered.", "instruction": "Take steps now to protect vulnerable plants
#   from the cold.", "response": "Prepare", "parameters": {"NWSheadline": ["FROST
#   ADVISORY IN EFFECT FROM MIDNIGHT TONIGHT TO 8 AM EDT SATURDAY"], "VTEC":
#   ["/O.NEW.KDTX.FR.Y.0003.201003T0400Z-201003T1200Z/"], "PIL": ["DTXNPWDTX"],
#   "BLOCKCHANNEL": ["CMAS", "EAS", "NWEM"], "eventEndingTime":
#   ["2020-10-03T12:00:00+00:00"]}}]
# friendly_name: NOAA Alerts (MIZ076)
# icon: 'mdi:weather-hurricane'



# alerts:
#   - '@id': 'https://api.weather.gov/alerts/NWS-IDP-PROD-4653422'
#     '@type': 'wx:Alert'
#     id: NWS-IDP-PROD-4653422
#     areaDesc: Livingston; Wayne; Macomb; Oakland; Lenawee; Washtenaw; Monroe
#     geocode:
#       UGC:
#         - MIZ068
#         - MIZ076
#         - MIZ070
#         - MIZ069
#         - MIZ082
#         - MIZ075
#         - MIZ083
#       SAME:
#         - 026093
#         - '026163'
#         - 026099
#         - '026125'
#         - 026091
#         - '026161'
#         - '026115'
#     affectedZones:
#       - 'https://api.weather.gov/zones/forecast/MIZ068'
#       - 'https://api.weather.gov/zones/forecast/MIZ076'
#       - 'https://api.weather.gov/zones/forecast/MIZ070'
#       - 'https://api.weather.gov/zones/forecast/MIZ069'
#       - 'https://api.weather.gov/zones/forecast/MIZ082'
#       - 'https://api.weather.gov/zones/forecast/MIZ075'
#       - 'https://api.weather.gov/zones/forecast/MIZ083'
#     references: []
#     sent: '2020-12-29T01:50:00-05:00'
#     effective: '2020-12-29T01:50:00-05:00'
#     onset: '2020-12-29T01:50:00-05:00'
#     expires: '2020-12-29T03:15:00-05:00'
#     ends: null
#     status: Actual
#     messageType: Alert
#     category: Met
#     severity: Moderate
#     certainty: Observed
#     urgency: Expected
#     event: Special Weather Statement
#     sender: w-nws.webmaster@noaa.gov
#     senderName: NWS Detroit/Pontiac MI
#     headline: >-
#       Special Weather Statement issued December 29 at 1:50AM EST by NWS
#       Detroit/Pontiac MI
#     description: |-
#       At 145 AM, clusters of heavier snow showers were located along a
#       line extending from near Milford to near Pinckney to 8 miles
#       northwest of Jackson. Movement was southeast at 30 mph.

#       This area of heavy snow will be near...
#       South Lyon around 155 AM EST.
#       Dexter and Hamburg around 200 AM EST.
#       Ann Arbor, Novi, Northville and West Bloomfield around 210 AM EST.
#       Dixboro around 220 AM EST.
#       Livonia and Birmingham around 225 AM EST.
#       Southfield, Ypsilanti and Royal Oak around 230 AM EST.
#       Detroit Zoo and Willis around 235 AM EST.

#       Other locations impacted by this area of heavy snow include Franklin,
#       Melvindale, Gibraltar, Hudson Mills Metropark, Commerce, Ridgeway,
#       Stony Point, Azalia, Harper Woods and Pleasant Ridge.

#       Icy roads are possible as the snow showers produce up to a half inch
#       of accumulation on paved surfaces.
#     instruction: null
#     response: Execute
#     parameters:
#       eventMotionDescription:
#         - >-
#           2020-12-29T01:45:00.000-05:00...storm...291DEG...28KT...42.58,-83.66
#           42.41,-84.01 42.32,-84.54
#       NWSheadline:
#         - >-
#           CLUSTERS OF HEAVIER SNOW SHOWERS MOVING THROUGH THE REGION CAPABLE OF
#           PRODUCING SLICK ROAD CONDITIONS AND LOW VISIBILITY
#       EAS-ORG:
#         - WXR
#       PIL:
#         - DTXSPSDTX
#       BLOCKCHANNEL:
#         - CMAS
#         - EAS
#         - NWEM
# urgency: Expected
# event_type: Special Weather Statement
# event_severity: Moderate
# description: |-
#   At 145 AM, clusters of heavier snow showers were located along a
#   line extending from near Milford to near Pinckney to 8 miles
#   northwest of Jackson. Movement was southeast at 30 mph.

#   This area of heavy snow will be near...
#   South Lyon around 155 AM EST.
#   Dexter and Hamburg around 200 AM EST.
#   Ann Arbor, Novi, Northville and West Bloomfield around 210 AM EST.
#   Dixboro around 220 AM EST.
#   Livonia and Birmingham around 225 AM EST.
#   Southfield, Ypsilanti and Royal Oak around 230 AM EST.
#   Detroit Zoo and Willis around 235 AM EST.

#   Other locations impacted by this area of heavy snow include Franklin,
#   Melvindale, Gibraltar, Hudson Mills Metropark, Commerce, Ridgeway,
#   Stony Point, Azalia, Harper Woods and Pleasant Ridge.

#   Icy roads are possible as the snow showers produce up to a half inch
#   of accumulation on paved surfaces.
# headline: >-
#   Special Weather Statement issued December 29 at 1:50AM EST by NWS
#   Detroit/Pontiac MI
# instruction: null
# alerts_string: >-
#   [{"@id": "https://api.weather.gov/alerts/NWS-IDP-PROD-4653422", "@type":
#   "wx:Alert", "id": "NWS-IDP-PROD-4653422", "areaDesc": "Livingston; Wayne;
#   Macomb; Oakland; Lenawee; Washtenaw; Monroe", "geocode": {"UGC": ["MIZ068",
#   "MIZ076", "MIZ070", "MIZ069", "MIZ082", "MIZ075", "MIZ083"], "SAME":
#   ["026093", "026163", "026099", "026125", "026091", "026161", "026115"]},
#   "affectedZones": ["https://api.weather.gov/zones/forecast/MIZ068",
#   "https://api.weather.gov/zones/forecast/MIZ076",
#   "https://api.weather.gov/zones/forecast/MIZ070",
#   "https://api.weather.gov/zones/forecast/MIZ069",
#   "https://api.weather.gov/zones/forecast/MIZ082",
#   "https://api.weather.gov/zones/forecast/MIZ075",
#   "https://api.weather.gov/zones/forecast/MIZ083"], "references": [], "sent":
#   "2020-12-29T01:50:00-05:00", "effective": "2020-12-29T01:50:00-05:00",
#   "onset": "2020-12-29T01:50:00-05:00", "expires": "2020-12-29T03:15:00-05:00",
#   "ends": null, "status": "Actual", "messageType": "Alert", "category": "Met",
#   "severity": "Moderate", "certainty": "Observed", "urgency": "Expected",
#   "event": "Special Weather Statement", "sender": "w-nws.webmaster@noaa.gov",
#   "senderName": "NWS Detroit/Pontiac MI", "headline": "Special Weather Statement
#   issued December 29 at 1:50AM EST by NWS Detroit/Pontiac MI", "description":
#   "At 145 AM, clusters of heavier snow showers were located along a\nline
#   extending from near Milford to near Pinckney to 8 miles\nnorthwest of Jackson.
#   Movement was southeast at 30 mph.\n\nThis area of heavy snow will be
#   near...\nSouth Lyon around 155 AM EST.\nDexter and Hamburg around 200 AM
#   EST.\nAnn Arbor, Novi, Northville and West Bloomfield around 210 AM
#   EST.\nDixboro around 220 AM EST.\nLivonia and Birmingham around 225 AM
#   EST.\nSouthfield, Ypsilanti and Royal Oak around 230 AM EST.\nDetroit Zoo and
#   Willis around 235 AM EST.\n\nOther locations impacted by this area of heavy
#   snow include Franklin,\nMelvindale, Gibraltar, Hudson Mills Metropark,
#   Commerce, Ridgeway,\nStony Point, Azalia, Harper Woods and Pleasant
#   Ridge.\n\nIcy roads are possible as the snow showers produce up to a half
#   inch\nof accumulation on paved surfaces.", "instruction": null, "response":
#   "Execute", "parameters": {"eventMotionDescription":
#   ["2020-12-29T01:45:00.000-05:00...storm...291DEG...28KT...42.58,-83.66
#   42.41,-84.01 42.32,-84.54"], "NWSheadline": ["CLUSTERS OF HEAVIER SNOW SHOWERS
#   MOVING THROUGH THE REGION CAPABLE OF PRODUCING SLICK ROAD CONDITIONS AND LOW
#   VISIBILITY"], "EAS-ORG": ["WXR"], "PIL": ["DTXSPSDTX"], "BLOCKCHANNEL":
#   ["CMAS", "EAS", "NWEM"]}}]
# friendly_name: NOAA Alerts (MIZ076)
# icon: 'mdi:weather-hurricane'
