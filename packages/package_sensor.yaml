###############################################################################
## Package - Sensor
###############################################################################
homeassistant:
  customize:
    alert.nest_protect_connected:
      icon: mdi:smoke-detector-variant-alert
      category: sensor
    alert.lg_thinq_connected:
      icon: mdi:fridge-industrial-alert
      category: sensor
    alert.power_use:
      icon: mdi:flash-alert
      category: sensor
    alert.outdoor_sump_off:
      icon: mdi:pump
      category: sensor

input_boolean:
  sensor_alerts:
    name: 'Sensor Alerts'
    icon: mdi:alert

  sensor_automation:
    name: 'Sensor Automation'
    icon: mdi:sync-alert

sensor:
  - platform: history_stats # https://www.home-assistant.io/integrations/history_stats/
    name: 'Indoor Sump Count'
    entity_id: binary_sensor.indoor_sump
    state: 'on'
    type: count
    start: "{{ today_at(states('input_datetime.day_reset')) }}"
    duration:
      hours: 24

  - platform: history_stats
    name: 'Indoor Sump Hours'
    entity_id: binary_sensor.indoor_sump
    state: 'on'
    type: time
    #ISSUE error on template reload
    #ERROR (MainThread) [homeassistant.helpers.entity] Update for sensor.indoor_sump_hours fails
    #TypeError: float() argument must be a string or a number, not 'NoneType'
    start: "{{ states('button.indoor_sump_hours_reset')|as_datetime }}"
    end: '{{ now() }}'

  - platform: history_stats
    name: 'Outdoor Sump Count'
    entity_id: binary_sensor.outdoor_sump
    state: 'on'
    type: count
    start: "{{ today_at(states('input_datetime.day_reset')) }}"
    duration:
      hours: 24

  - platform: history_stats
    name: 'Outdoor Sump Hours'
    entity_id: binary_sensor.outdoor_sump
    state: 'on'
    type: time
    start: "{{ states('button.outdoor_sump_hours_reset')|as_datetime }}"
    end: '{{ now() }}'

alert:
  power_use:
    name: 'Power Use'
    title: 'Power Use Alert'
    message: "Current power usage is {{ states('sensor.current_power_use_kw') }} kW!"
    done_message: clear_notification
    entity_id: binary_sensor.power_use_alert
    state: 'on'
    repeat: 900
    notifiers: jason
    data:
      tag: power_use_alert
      group: Alert
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:flash-alert
      icon_url: !secret POWER_ICON
      ledColor: !secret SEVERE_COLOR
      color: !secret SEVERE_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_power_use_alert

  outdoor_sump_off:
    name: 'Outdoor Sump Off'
    title: 'Outdoor Sump Off'
    message: 'The outdoor sump is off.'
    done_message: clear_notification
    entity_id: switch.outdoor_sump
    state: 'off'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_sump_off
      group: Alert
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:flash-alert
      icon_url: !secret SUMP_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/sensor
      actions:
        - title: 'Pause Alert'
          action: pause_outdoor_sump_off_alert

        - title: 'Turn Sump On'
          action: turn_outdoor_sump_on

  nest_protect_connected:
    name: 'Nest Protect Connected'
    entity_id: binary_sensor.nest_protect_connected_alert
    state: 'on'
    notifiers: log
    skip_first: false
    repeat: 999999
    data:
      tag: nest_protect_connected

  lg_thinq_connected:
    name: 'LG ThinQ Connected'
    entity_id: binary_sensor.lg_thinq_connected_alert
    state: 'on'
    notifiers: log
    skip_first: false
    repeat: 999999
    data:
      tag: lg_thinq_connected
