#######################################################################################################################
## Maddie Mealtime Package
#######################################################################################################################
input_boolean:
#######################################################################################################################
## Maddie Mealtime Enabled
#######################################################################################################################
  maddie_mealtime_enabled:
    name: Maddie Mealtime Enabled
    icon: mdi:dog

#######################################################################################################################
## Maddie Mealtime Active
#######################################################################################################################
  maddie_mealtime_active:
    name: Maddie Mealtime Active
    icon: mdi:dog

input_datetime:
#######################################################################################################################
## Maddie Mealtimes
#######################################################################################################################
  maddie_mealtime_days_1:
    name: Days Maddie Meal 1
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_days_2:
    name: Days Maddie Meal 2
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_days_3:
    name: Days Maddie Meal 3
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_1:
    name: Afternoons Maddie Meal 1
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_2:
    name: Afternoons Maddie Meal 2
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_3:
    name: Afternoons Maddie Meal 3
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_1:
    name: Weekends Maddie Meal 1
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_2:
    name: Weekends Maddie Meal 2
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_3:
    name: Weekends Maddie Meal 3
    icon: mdi:clock
    has_date: false
    has_time: true

automation:
#######################################################################################################################
## Maddie Mealtime - Turn Off
#######################################################################################################################
  - id: maddie_mealtime_turn_off
    alias: "[Maddie Mealtime] Turn Off"
    description: Turn off active boolean.
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'on'

      - platform: state
        entity_id: input_boolean.maddie_mealtime_enabled
        to: 'off'

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: maddie_mealtime_done

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: maddie_mealtime_done

    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.maddie_mealtime_enabled
            state: 'off'

          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: template
            value_template: >
              {% if trigger.event is defined %}{{ trigger.event.data['action'] == 'maddie_mealtime_done' }}{% endif %}

    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.maddie_mealtime_active

#######################################################################################################################
## Maddie Mealtime - Activate Reminder
#NOTE defaults to weekend if current shift is off/unknown
#######################################################################################################################
  - id: maddie_mealtime_activate_reminder
    alias: "[Maddie Mealtime] Activate Reminder"
    description: Turn on maddie mealtime active boolean with shift dependent time trigger.
    initial_state: true
    mode: single
    trigger:
      - platform: template
        value_template: >
          {% set time = states('sensor.time') %}
          {% set days = is_state('sensor.current_shift','Days') and is_state('binary_sensor.work_today','on') %}
          {% set afts = is_state('sensor.current_shift','Afternoons') and is_state('binary_sensor.work_today','on') %}
          {% set wknd = is_state('binary_sensor.work_today','off') or states('sensor.current_shift') in ['Off','unknown','unavailable','none'] %}

          {{ (days and time == states('input_datetime.maddie_mealtime_days_1')[0:5])
            or (days and time == states('input_datetime.maddie_mealtime_days_2')[0:5])
            or (days and time == states('input_datetime.maddie_mealtime_days_3')[0:5])
            or (afts and time == states('input_datetime.maddie_mealtime_afternoons_1')[0:5])
            or (afts and time == states('input_datetime.maddie_mealtime_afternoons_2')[0:5])
            or (afts and time == states('input_datetime.maddie_mealtime_afternoons_3')[0:5])
            or (wknd and time == states('input_datetime.maddie_mealtime_weekends_1')[0:5])
            or (wknd and time == states('input_datetime.maddie_mealtime_weekends_2')[0:5])
            or (wknd and time == states('input_datetime.maddie_mealtime_weekends_3')[0:5]) }}

#TODO sunday night afternoons maddie mealtime 12:30am (Monday morning), work today is on
    condition:
      - condition: state
        entity_id: input_boolean.maddie_mealtime_enabled
        state: 'on'

    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.maddie_mealtime_active

#######################################################################################################################
## Maddie Mealtime - Alert
#######################################################################################################################
  - id: maddie_mealtime_alert
    alias: "[Maddie Mealtime] Alert"
    description: Sent alert every 15 minutes until maddie active turns off.
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'on'

    condition:
      - condition: state
        entity_id: input_boolean.maddie_mealtime_enabled
        state: 'on'

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: "Hey asshole,.! Feed yer fuckin animals!.....  Maddie!  Hey Maddie!  And Pooie Rooie too!  It's time to get some food!"
                quiet_play: true
                save_message: true

            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.alerts_enabled
                      state: 'on'

                  sequence:
                    - service: notify.mobile_app_jphone
                      data:
                        title: &maddie_title Maddie Mealtime
                        message: &maddie_message "It's time to feed the animals!"
                        data:
                          tag: &maddie_tag maddie_mealtime
                          group: General
                          channel: General
                          importance: normal
                          timeout: 3600
                          persistent: true
                          sticky: true
                          clickAction: &maddie_url /lovelace/schedule
                          color: !secret NOTIFY_COLOR
                          icon_url: &maddie_icon !secret MADDIE_ICON
                          image: &maddie_image !secret MADDIE_IMAGE
                          actions:
                            - action: maddie_mealtime_done
                              title: Mealtime Done
                              uri: /lovelace/schedule

                    - choose:
                        - conditions:
                            - condition: state
                              entity_id: binary_sensor.jason_home
                              state: 'on'

                            - condition: state
                              entity_id: input_select.occupancy_mode
                              state: Home

                          sequence:
                            - service: notify.push
                              data:
                                title: *maddie_title
                                message: *maddie_message
                                target: jlaptop
                                data:
                                  tag: *maddie_tag
                                  timestamp: "{{ as_timestamp(now()) }}"
                                  priority: high
                                  ttl: 0
                                  renotify: true
                                  silent: true
                                  requireInteraction: true
                                  url: *maddie_url
                                  image: !secret MADDIE_IMAGE
                                  icon: *maddie_icon
                                  badge: !secret MADDIE_BADGE
                                  actions:
                                    - action: maddie_mealtime_done
                                      title: Mealtime Done
                                    - action: close_maddie_mealtime
                                      title: Close

            # wait for alert to turned off/dismissed
            - wait_template: "{{ is_state('input_boolean.maddie_mealtime_active','off') }}"
              timeout:
                minutes: 15

          until:
            - condition: state
              entity_id: input_boolean.maddie_mealtime_active
              state: 'off'

#######################################################################################################################
## Maddie Mealtime - Close Notifications
#######################################################################################################################
  - id: maddie_mealtime_close_notifications
    alias: "[Maddie Mealtime] Close Notifications"
    description: Dismiss notifications on all devices.
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: maddie_mealtime

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_maddie_mealtime

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: maddie_mealtime_done

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: maddie_mealtime

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: maddie_mealtime_done

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          tag: maddie_mealtime

      - delay:
          seconds: 180 # prevent recursive triggers