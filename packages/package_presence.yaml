###############################################################################
## Package - Presence
###############################################################################
homeassistant:
  customize:
    alert.presence_override_jason:
      icon: mdi:account-star
      category: presence
    alert.presence_override_sheri:
      icon: mdi:account-star
      category: presence
    alert.occupancy_mode:
      icon: mdi:home-alert
      category: presence

    binary_sensor.jason_home:
      icon: mdi:home-account
      device_class: occupancy
    binary_sensor.sheri_home:
      icon: mdi:home-account
      device_class: occupancy

    camera.jason_location:
      control: hidden
    camera.sheri_location:
      control: hidden

    zone.home:
      radius: 50

camera:
  - platform: generic
    name: 'Jason Location'
    still_image_url: !secret JCAM_URL
    limit_refetch_to_url_change: true
  - platform: generic
    name: 'Sheri Location'
    still_image_url: !secret SCAM_URL
    limit_refetch_to_url_change: true

proximity:
  jphone_home:
    zone: home
    devices: person.jason
    tolerance: 100 # meters
    unit_of_measurement: km
  sphone_home:
    zone: home
    devices: person.sheri
    tolerance: 100 # meters
    unit_of_measurement: km

input_boolean:
  guest_home:
    name: 'Guest Home'
    icon: mdi:account #IMAGE

  guest_just_arrived_home:
    name: 'Guest Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false

  home_override_jason:
    name: 'Jason Home Override'
    icon: mdi:account-lock
    initial: false

  home_override_sheri:
    name: 'Sheri Home Override'
    icon: mdi:account-lock
    initial: false

  jason_almost_home:
    name: 'Jason Almost Home'
    icon: mdi:account-supervisor-circle
    initial: false

  jason_home:
    name: 'Jason Home'
    icon: mdi:account

  jason_just_arrived_home:
    name: 'Jason Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false

  sheri_almost_home:
    name: 'Sheri Almost Home'
    icon: mdi:account-supervisor-circle
    initial: false

  sheri_home:
    name: 'Sheri Home'
    icon: mdi:account

  sheri_just_arrived_home:
    name: 'Sheri Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false

  occupancy_announcements:
    name: 'Occupancy Announcements'
    icon: mdi:account-voice

  occupancy_notifications:
    name: 'Occupancy Notifications'
    icon: mdi:account-multiple

  occupancy_override:
    name: 'Occupancy Override'
    initial: false

  presence_automation:
    name: 'Presence Automation'
    icon: mdi:sync-alert

  presence_alerts:
    name: 'Presence Alerts'
    icon: mdi:alert

  vacation_mode:
    name: 'Vacation Mode'
    icon: mdi:beach

input_select:
  last_person_to_arrive:
    name: 'Last Person To Arrive'
    icon: mdi:account-arrow-left
    options: &person_options
      - Jason
      - Sheri
      - Guest
      - cleared

  last_person_to_leave:
    name: 'Last Person To Leave'
    icon: mdi:account-arrow-right
    options: *person_options

  occupancy_mode:
    name: 'Occupancy Mode'
    icon: mdi:home-account
    options:
      - Home
      - Night
      - Away
      - Guest
      - Vacation

sensor:
  - platform: history_stats
    name: 'Jason Home Week'
    entity_id: binary_sensor.jason_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

  - platform: history_stats
    name: 'Sheri Home Week'
    entity_id: binary_sensor.sheri_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

  - platform: history_stats
    name: 'Someone Home Week'
    entity_id: binary_sensor.someone_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

alert:
  occupancy_mode:
    name: 'Occupancy Mode'
    title: 'Occupancy Mode'
    message: >-
      {% set occ_mode = states('input_select.occupancy_mode') %}
      {% set someone_home = is_state('binary_sensor.someone_home','on') %}
      {% set alarm_state = states('alarm_control_panel.master') %}
      {%- if (someone_home and alarm_state == 'armed_away' ) or (not someone_home and alarm_state in ['disarmed','armed_home']) %}
        {{ 'Someone' if someone_home  else  'Nobody' }} is home but the house alarm is {{ states('sensor.alarm_status') }}.
      {%- elif (occ_mode != 'Night' and alarm_state == 'armed_night') %}
        The house is in {{ occ_mode }} mode but the alarm is {{ states('sensor.alarm_status') }}.
      {%- elif (someone_home and occ_mode in ['Away','Vacation']) or (not someone_home and occ_mode in ['Home','Guest','Night']) %}
        {{ 'Someone' if someone_home else 'Nobody' }} is home but the house is in {{ occ_mode }} mode.
      {% endif %}
      Did you forget to
      {{- ' disarm ' if alarm_state in ['armed_night','armed_away'] or someone_home else ' arm ' -}} the alarm,
      {{- ' or has your phone not connected to the network' if not someone_home }}?
    done_message: clear_notification
    entity_id: binary_sensor.occupancy_mode_alert
    state: 'on'
    repeat: 30
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: occupancy_mode
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:home-alert
      icon_url: !secret HOME_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/presence
      actions:
        - title: 'Home'
          action: set_home_mode

        - title: 'Away'
          action: set_away_mode

        - title: 'Alarm'
          action: URI
          uri: app://com.thanksmister.iot.mqtt.alarmpanel

  presence_override_jason:
    name: 'Jason Presence Override '
    title: 'Jason: Presence Override'
    message: >
      Jason's presence override was turned on at
      {{ as_local(states.input_boolean.home_override_jason.last_changed).strftime('%-I:%M %p') }}
    done_message: clear_notification
    entity_id: binary_sensor.presence_override_jason_alert
    state: 'on'
    repeat: 60
    notifiers: jason
    data:
      tag: presence_override
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      persistant: true
      notification_icon: mdi:account-alert
      icon_url: !secret JASON_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/presence
      actions:
        - title: 'Override Off'
          action: turn_off_presence_override_jason

        - title: 'Pause Alert'
          action: pause_presence_override_jason

  presence_override_sheri:
    name: 'Sheri Presence Override '
    title: 'Sheri: Presence Override'
    message: >
      Jason's presence override was turned on at
      {{ as_local(states.input_boolean.home_override_sheri.last_changed).strftime('%-I:%M %p') }}
    done_message: clear_notification
    entity_id: binary_sensor.presence_override_sheri_alert
    state: 'on'
    repeat: 60
    notifiers: mobile
    data:
      tag: presence_override
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      persistant: true
      notification_icon: mdi:account-alert
      icon_url: !secret PRESENCE_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/presence
      actions:
        - title: 'Override Off'
          action: turn_off_presence_override_sheri

        - title: 'Pause Alert'
          action: pause_presence_override_sheri

  google_traffic_connected:
    name: 'Google Traffic Connected'
    entity_id: binary_sensor.google_traffic_connected_alert
    state: 'on'
    notifiers: log
    skip_first: false
    repeat: 999999
    data:
      tag: google_traffic_connected
