###############################################################################
## Package - Presence
###############################################################################
homeassistant:
  customize:
    alert.presence_override_jason:
      friendly_name: 'Jason Presence Override'
      icon: mdi:account-star
      category: presence
    alert.presence_override_sheri:
      friendly_name: 'Sheri Presence Override'
      icon: mdi:account-star
      category: presence
    alert.occupancy_mode:
      friendly_name: 'Occupancy Mode'
      icon: mdi:home-alert
      category: presence

    binary_sensor.jason_home:
      friendly_name: 'Jason Home'
      icon: mdi:home-account
      device_class: occupancy
    binary_sensor.sheri_home:
      friendly_name: 'Sheri Home'
      icon: mdi:home-account
      device_class: occupancy

    camera.jason_location:
      control: hidden
    camera.sheri_location:
      control: hidden

    proximity.jphone_home:
      friendly_name: 'Jason Distance From Home'
    proximity.sphone_home:
      friendly_name: 'Sheri Distance From Home'

    zone.home:
      radius: 50

camera:
  - platform: generic
    name: 'Jason Location'
    still_image_url: !secret JCAM_URL
    limit_refetch_to_url_change: true
  - platform: generic
    name: 'Sheri Location'
    still_image_url: !secret SCAM_URL
    limit_refetch_to_url_change: true

proximity:
  jphone_home:
    zone: home
    devices: person.jason
    tolerance: 100 # meters
    unit_of_measurement: km
  sphone_home:
    zone: home
    devices: person.sheri
    tolerance: 100 # meters
    unit_of_measurement: km

input_boolean:
  presence_automation:
    name: 'Presence Automation'
    icon: mdi:sync-alert
  presence_alerts:
    name: 'Presence Alerts'
    icon: mdi:alert
  occupancy_notifications:
    name: 'Occupancy Notifications'
    icon: mdi:account-multiple
  occupancy_announcements:
    name: 'Occupancy Announcements'
    icon: mdi:account-voice
  jason_home:
    name: 'Jason Home'
    icon: mdi:account
  jason_almost_home:
    name: 'Jason Almost Home'
    icon: mdi:account-supervisor-circle
    initial: false
  jason_just_arrived_home:
    name: 'Jason Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false
  home_override_jason:
    name: 'Jason Home Override'
    icon: mdi:account-lock
    initial: false
  sheri_home:
    name: 'Sheri Home'
    icon: mdi:account
  sheri_almost_home:
    name: 'Sheri Almost Home'
    icon: mdi:account-supervisor-circle
    initial: false
  home_override_sheri:
    name: 'Sheri Home Override'
    icon: mdi:account-lock
    initial: false
  sheri_just_arrived_home:
    name: 'Sheri Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false
  guest_home:
    name: 'Guest Home'
    icon: mdi:account
  guest_just_arrived_home:
    name: 'Guest Just Arrived Home'
    icon: mdi:account-supervisor-circle
    initial: false
  vacation_mode:
    name: 'Vacation Mode'
    icon: mdi:beach

input_select:
  occupancy_mode:
    name: 'Occupancy Mode'
    icon: mdi:home-account
    options:
      - Home
      - Night
      - Away
      - Guest
      - Vacation
  last_person_to_leave:
    name: 'Last Person To Leave'
    icon: mdi:account-arrow-right
    options: &person_options
      - Jason
      - Sheri
      - Guest
      - cleared
  last_person_to_arrive:
    name: 'Last Person To Arrive'
    icon: mdi:account-arrow-left
    options: *person_options

group:
  occupancy_bypass_automations: # automations tagged with #OCC
    entities:
      - automation.alarm_auto_arm
      - automation.ceiling_fan_office_fan_auto_off
      - automation.ceiling_fan_upstairs_bedroom_fan_auto_off
      - automation.climate_occupancy_mode_control
      - automation.garage_climate_auto_off
      - automation.garage_door_close_door
      - automation.hass_close_popups
      - automation.light_back_house_potlights_nobody_home
      - automation.light_back_house_potlights_auto_on
      - automation.light_back_house_potlights_auto_off
      - automation.light_back_yard_garden_light_auto_on
      - automation.light_back_yard_garden_light_auto_off
      - automation.light_back_yard_tree_lights_auto_on
      - automation.light_back_yard_tree_lights_auto_off
      - automation.light_dining_room_light_flux_control
      - automation.light_dining_room_night_light
      - automation.light_dining_room_light_nobody_home
      - automation.light_dining_room_light_auto_off
      - automation.light_dining_room_potlights_auto_off
      - automation.light_front_house_potlights_nobody_home
      - automation.light_front_house_potlights_auto_on
      - automation.light_front_house_potlights_auto_on
      - automation.light_front_house_potlights_auto_off
      - automation.light_front_porch_light_nobody_home
      - automation.light_front_porch_light_auto_on
      - automation.light_kitchen_sink_light_auto_off
      - automation.light_kitchen_potlights_auto_off
      - automation.light_living_room_potlights_auto_off
      - automation.light_living_room_cove_light_auto_off
      - automation.light_master_bedroom_light_auto_off
      - automation.light_office_light_auto_off
      - automation.light_office_potlights_auto_off
      - automation.light_outside_garage_lights_nobody_home
      - automation.light_outside_garage_lights_auto_on
      - automation.light_outside_garage_lights_auto_off
      - automation.light_side_entrance_light_auto_off
      - automation.light_upstairs_bathroom_vanity_light_flux_control
      - automation.light_upstairs_bathroom_vanity_light_auto_off
      - automation.light_upstairs_bathroom_shower_light_auto_off
      - automation.light_upstairs_bedroom_light_flux_control
      - automation.light_upstairs_bedroom_light_auto_off
      - automation.light_upstairs_bedroom_potlights_auto_off
      - automation.light_upstairs_hallway_potlights_auto_off
      - automation.media_player_auto_off
      - automation.media_player_volume_override
      - automation.mobile_phone_bluetooth_jason
      - automation.mobile_dnd_jason
      - automation.mobile_phone_headphones_jason
      - automation.mobile_phone_battery_low_jason
      - automation.mobile_phone_offline_jason
      - automation.mobile_phone_ringer_jason
      - automation.mobile_phone_wifi_jason
      - automation.mobile_phone_bluetooth_sheri
      - automation.mobile_dnd_sheri
      - automation.mobile_phone_headphones_sheri
      - automation.mobile_phone_battery_low_sheri
      - automation.mobile_phone_offline_sheri
      - automation.mobile_phone_ringer_sheri
      - automation.mobile_phone_wifi_sheri
      - automation.presence_occupancy_mode
      - automation.presence_occupancy_notification
      - automation.schedule_shift_selection_alert
      - automation.schedule_manual_wake_up
      - automation.spa_select_high_temperature
      - automation.spa_select_low_temperature

sensor:
  - platform: history_stats
    name: 'Jason Home Week'
    entity_id: binary_sensor.jason_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

  - platform: history_stats
    name: 'Sheri Home Week'
    entity_id: binary_sensor.sheri_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

  - platform: history_stats
    name: 'Someone Home Week'
    entity_id: binary_sensor.someone_home
    state: 'on'
    type: time
    end: '{{ now().replace(hour=0).replace(minute=0).replace(second=0) }}'
    duration:
      days: 7

alert:
  occupancy_mode:
    name: 'Occupancy Mode'
    title: 'Occupancy Mode Alert'
    message: >-
      {% set occ_mode = states('input_select.occupancy_mode') %}
      {% set someone_home = is_state('binary_sensor.someone_home','on') %}
      {% set alarm_state = states('alarm_control_panel.master') %}
      {%- if (someone_home and alarm_state == 'armed_away' ) or (not someone_home and alarm_state in ['disarmed','armed_home']) %}
        {{ 'Someone' if someone_home  else  'Nobody' }} is home but the house alarm is {{ states('sensor.alarm_status') }}.
      {%- elif (occ_mode != 'Night' and alarm_state == 'armed_night') %}
        The house is in {{ occ_mode }} mode but the alarm is {{ states('sensor.alarm_status') }}.
      {%- elif (someone_home and occ_mode in ['Away','Vacation']) or (not someone_home and occ_mode in ['Home','Guest','Night']) %}
        {{ 'Someone' if someone_home else 'Nobody' }} is home but the house is in {{ occ_mode }} mode.
      {% endif %}
      Did you forget to
      {{- ' disarm ' if alarm_state in ['armed_night','armed_away'] or someone_home else ' arm ' -}} the alarm,
      {{- ' or has your phone not connected to the network' if not someone_home }}?
    done_message: clear_notification
    entity_id: binary_sensor.occupancy_mode_alert
    state: 'on'
    repeat: 30
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: occupancy_mode
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret HOME_ICON
      actions:
        - action: set_home_mode
          title: 'Home'
        - action: set_away_mode
          title: 'Away'
        - action: pause_occupancy_mode
          title: 'Pause Alert'

  presence_override_jason:
    name: 'Jason Presence Override '
    title: 'Jason Presence Override Alert'
    message: > #TODO
      Jason's presence override was turned on at
      {{ states.input_boolean.home_override_jason.last_changed|as_timestamp('unknown')|timestamp_custom('%-I:%H %p',true,'unknown') }}.
    done_message: clear_notification
    entity_id: binary_sensor.presence_override_jason_alert
    state: 'on'
    repeat: 60
    notifiers: jason
    data:
      tag: presence_override
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      persistant: true
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON
      actions:
        - action: turn_off_presence_override_jason
          title: 'Override Off'
        - action: pause_presence_override_jason
          title: 'Pause Alert'

  presence_override_sheri:
    name: 'Sheri Presence Override '
    title: 'Sheri Presence Override Alert'
    message: >
      Sheri's presence override was turned on at
      {{ states.input_boolean.home_override_sheri.last_changed|as_timestamp('unknown')|timestamp_custom('%-I:%H %p',true,'unknown') }}.
    done_message: clear_notification
    entity_id: binary_sensor.presence_override_sheri_alert
    state: 'on'
    repeat: 60
    notifiers: mobile #TEMP
    data:
      tag: presence_override
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      persistant: true
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON
      actions:
        - action: turn_off_presence_override_sheri
          title: 'Override Off'
        - action: pause_presence_override_sheri
          title: 'Pause Alert'
