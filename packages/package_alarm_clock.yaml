#######################################################################################################################
## Alarm Clock Package
#######################################################################################################################
homeassistant:
  customize:
    alert.alarm_clock_presence:
      friendly_name: Presence
      icon: mdi:alarm-check
      category: alarm_clock
    alert.alarm_clock_notification:
      friendly_name: Alarm Clock
      icon: mdi:alarm-note
      category: alarm_clock

input_boolean:
#######################################################################################################################
## Input Boolean - Alarm Clock
#######################################################################################################################
  alarm_clock_auto_workdays:
    name: Workdays
    icon: mdi:alarm

  alarm_clock_auto_weekends:
    name: Weekends / Holidays
    icon: mdi:alarm

  alarm_clock_guest:
    name: Guest
    icon: mdi:alarm

  alarm_clock_manual:
    name: Manual Alarm Clock
    icon: mdi:alarm-plus

  alarm_clock_nap:
    name: Nap Alarm Clock
    icon: mdi:alarm-snooze

  alarm_clock_phone:
    name: Phone Alarm Clock
    icon: mdi:alarm-plus

  alarm_clock_active_auto:
    name: Auto Alarm On
    icon: mdi:power

  alarm_clock_active_manual:
    name: Manual Alarm On
    icon: mdi:power

  alarm_clock_active_nap:
    name: Nap Alarm On
    icon: mdi:power

  alarm_clock_snooze:
    name: Alarm Clock Snooze
    icon: mdi:sleep

  alarm_clock_increase_volume:
    name: Auto Increase Volume
    icon: mdi:volume-low

  alarm_clock_alerts:
    name: Alarm Clock Alerts
    icon: mdi:alarm-note

  alarm_clock_failed:
    initial: false

  alarm_clock_test_play:
    initial: false

input_select:
#######################################################################################################################
## Input Select - Alarm Clock
#######################################################################################################################
  alarm_clock_media_player:
    name: Media Player
    icon: mdi:speaker
    options: &media_player_names
      !include /config/include/entities/media_player_names.yaml

  alarm_clock_media_player_auto:
    name: Media Player
    icon: mdi:speaker
    options: *media_player_names

  alarm_clock_media_player_manual:
    name: Media Player
    icon: mdi:speaker
    options: *media_player_names

  alarm_clock_media_player_nap:
    name: Media Player
    icon: mdi:speaker
    options: *media_player_names

  alarm_clock_sound: &alarm_sound
    name: Alarm Sound
    icon: mdi:file-music
    options:
      - Radio
      - Digital
      - Gentle
      - Loud
      - Pager
      - Rooster

  alarm_clock_sound_auto: *alarm_sound
  alarm_clock_sound_manual: *alarm_sound
  alarm_clock_sound_nap: *alarm_sound

  alarm_clock_radio_station:
    name: Alarm Clock Radio Station
    icon: mdi:radio-tower
    options: &alarm_clock_stations !include /config/include/entities/radio_station_names.yaml

  alarm_clock_radio_station_auto:
    name: Radio Station
    icon: mdi:radio-tower
    options: *alarm_clock_stations

  alarm_clock_radio_station_manual:
    name: Radio Station
    icon: mdi:radio-tower
    options: *alarm_clock_stations

  alarm_clock_radio_station_nap:
    name: Radio Station
    icon: mdi:radio-tower
    options: *alarm_clock_stations

input_number:
#######################################################################################################################
## Input Number - Alarm Clock
#######################################################################################################################
  alarm_clock_volume: &alarm_volume
    name: Volume
    icon: mdi:volume-high
    min: 0
    max: 100
    step: 1
    unit_of_measurement: '%'

  alarm_clock_volume_auto: *alarm_volume
  alarm_clock_volume_manual: *alarm_volume
  alarm_clock_volume_nap: *alarm_volume

  alarm_clock_snooze_time:
    name: Snooze Time
    icon: mdi:timer-outline
    min: 0
    max: 60
    step: 1
    unit_of_measurement: min

  alarm_clock_nap_time:
    name: Nap Timer
    icon: mdi:timer-outline
    min: 1
    max: 240
    step: 1
    unit_of_measurement: min

  alarm_clock_play_delay:
    name: Play Delay
    icon: mdi:timer-outline
    min: 0
    max: 300
    step: 10
    unit_of_measurement: seconds

#######################################################################################################################
## Alarm Clock Speaker Volumes (float) - media player reset volume #NEW_MEDIA_PLAYER
#######################################################################################################################
  alarm_clock_living_room_speaker:
    min: 0
    max: 100
  alarm_clock_dining_room_display:
    min: 0
    max: 100
  alarm_clock_bedroom_display:
    min: 0
    max: 100
  alarm_clock_bathroom_speaker:
    min: 0
    max: 100
  alarm_clock_laundry_room_speaker:
    min: 0
    max: 100
  alarm_clock_garage_speaker:
    min: 0
    max: 100
  alarm_clock_living_room_tv:
    min: 0
    max: 100
  alarm_clock_bedroom_tv:
    min: 0
    max: 100
  alarm_clock_deck_tv:
    min: 0
    max: 100

input_datetime:
  alarm_clock_manual_time:
    name: Manual Alarm Wake Time
    icon: mdi:clock
    has_date: false
    has_time: true

timer:
#######################################################################################################################
## Timer - Alarm Clock
#######################################################################################################################
  alarm_clock_snooze:
    name: Snooze Time Remaining
    icon: mdi:sleep

  alarm_clock_nap:
    name: Nap Time Remaining
    icon: mdi:alarm-plus

input_text:
  active_media_player_alarm_clock:

  base_url: # used for alarm sound templates
    initial: !secret BASE_URL

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Alarm Clock Active - any alarm clock is on
#######################################################################################################################
      alarm_clock_active:
        friendly_name: Alarm Clock Active
        unique_id: alarm_clock_active
        icon_template: mdi:alarm-note
        value_template: >
          {{ is_state('input_boolean.alarm_clock_active_auto','on')
              or is_state('input_boolean.alarm_clock_active_manual','on')
              or is_state('input_boolean.alarm_clock_active_nap','on')
              or is_state('script.alarm_clock_play','on')
              or is_state('script.alarm_clock_stop','on') }}

#######################################################################################################################
## Alarm Clock Alert
## - no alerts when user is testing alarm play
## - delay allow booleans to turn back off in check conditions w/o triggering alert
#######################################################################################################################
      alarm_clock_alert:
        friendly_name: Alarm Clock Alert
        unique_id: alarm_clock_alert
        icon_template: mdi:clock
        delay_on:
          seconds: 5
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
               and is_state('input_boolean.alarm_clock_alerts','on')
               and is_state('input_boolean.alarm_clock_test_play','off')
               and is_state('binary_sensor.alarm_clock_active','on') }}

#######################################################################################################################
## Alarm Clock Presence Alert
#######################################################################################################################
      alarm_clock_presence_alert:
        friendly_name: Alarm Clock Presence
        unique_id: alarm_clock_presence_alert
        icon_template: mdi:clock-alert
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.alarm_clock_alerts','on')
              and is_state('binary_sensor.alarm_clock_active','on')
              and (is_state('binary_sensor.someone_home','off')
                or is_state('input_select.occupancy_mode','Aftsay')) }}

sensor:
  - platform: template
    sensors:
#######################################################################################################################
# Alarm Clock Media Player
#######################################################################################################################
      alarm_clock_media_player:
        friendly_name: Alarm Clock Media Player
        unique_id: alarm_clock_media_player
        icon_template: mdi:animation-play
        value_template: >
          {{ expand('group.media_players')|selectattr('name','eq',states('input_select.alarm_clock_media_player'))
              |map(attribute='entity_id')|join(',') }}

#######################################################################################################################
## Alarm Clock Status - picture glance state
#######################################################################################################################
      alarm_clock_status:
        unique_id: alarm_clock_status
        value_template: >
          {% if is_state('input_boolean.alarm_clock_failed','on') %} failed
          {% elif states('sensor.alarm_clock_next_alarm') == 'Off'
            and (is_state('binary_sensor.alarm_clock_active','off')
            or is_state('script.alarm_clock_stop','on')
            or is_state('binary_sensor.startup_complete','off')) %} off
          {% elif is_state('binary_sensor.alarm_clock_active','on') %}
            {% if is_state('input_boolean.alarm_clock_snooze','on')
                and is_state('timer.alarm_clock_snooze','active') %} snoozed
            {% elif is_state(states('sensor.alarm_clock_media_player'),'playing')
                 or is_state('binary_sensor.tts_playing','on')
                 or is_state('script.tts_play','on')
                 or is_state('script.alarm_clock_play','on')
                 or is_state('script.alarm_clock_stop','on') %} playing
            {% else %} failed
            {% endif %}
          {% elif states('sensor.alarm_clock_next_alarm') != 'Off' %} pending
          {% else %} off
          {% endif %}

#######################################################################################################################
## Auto Alarm Clock - alarm status in glance alerts, alarm settings popup
#######################################################################################################################
      alarm_clock_auto:
        friendly_name: Auto Alarm
        unique_id: alarm_clock_auto
        icon_template: >
          {% if is_state('sensor.alarm_clock_auto','Snooze')  %} mdi:alarm-snooze
          {% elif is_state('sensor.alarm_clock_auto','Active') %} mdi:alarm-note
          {% elif is_state('sensor.alarm_clock_auto','Off') %} mdi:alarm-off
          {% else %} mdi:alarm-check
          {% endif %}
        value_template: >
          {% set time = states('sensor.time') %}
          {% set days = states('input_datetime.days_waketime')[0:5] %}
          {% set afts = states('input_datetime.afternoons_waketime')[0:5] %}
          {% set wkd = states('input_datetime.weekend_waketime')[0:5] %}
          {% set guest = states('input_datetime.guest_waketime')[0:5] %}
          {% set wake_tom = states('sensor.waketime_tomorrow') %}

          {% if is_state('input_select.occupancy_mode','Guest') %}
            {# set tomorrows alarm time #}
            {% if is_state('binary_sensor.workday_tomorrow','off') %}
              {% set alarm_tom = 'Off' if is_state('input_boolean.alarm_clock_guest','off') else wake_tom %}
            {% else %}
              {% set alarm_tom = 'Off' if is_state('input_boolean.alarm_clock_guest','off') else wake_tom %}
            {% endif %}
            {# set next alarm to tomorrows alarm time if past today alarm time #}
            {% if is_state('binary_sensor.workday','off') %}
              {% set next = alarm_tom if time > guest else 'Off' if is_state('input_boolean.alarm_clock_guest','off') else guest %}
            {% else %}
              {% set next = alarm_tom if time > guest else 'Off' if is_state('input_boolean.alarm_clock_guest','off') else guest %}
            {% endif %}
          {% else %}
            {# set tomorrows alarm time #}
            {% if is_state('binary_sensor.work_tomorrow','off') %}
              {% set alarm_tom = 'Off' if is_state('input_boolean.alarm_clock_auto_weekends','off') else wake_tom %}
            {% else %}
              {% set alarm_tom = 'Off' if is_state('input_boolean.alarm_clock_auto_workdays','off') else days if is_state('sensor.tomorrow_shift','Days') else wake_tom %}
            {% endif %}
            {# set next alarm to tomorrows alarm time if past today alarm time #}
            {% if is_state('binary_sensor.work_today','off') %}
              {% set next = alarm_tom if time > wkd else 'Off' if is_state('input_boolean.alarm_clock_auto_weekends','off') else wkd %}
            {% else %}
              {% if is_state('sensor.current_shift','Afternoons') %}
                {% set next = alarm_tom if time > afts else 'Off' if is_state('input_boolean.alarm_clock_auto_workdays','off') else afts %}
              {% else %}
                {% set next = alarm_tom if time > days else 'Off' if is_state('input_boolean.alarm_clock_auto_workdays','off') else days %}
              {% endif %}
            {% endif %}
          {% endif %}
          {{ next }}

#######################################################################################################################
## Auto Alarm Clock Display - covnerts display time to 12h
#######################################################################################################################
      alarm_clock_auto_display:
        friendly_name: Auto Alarm
        unique_id: alarm_clock_auto_display
        icon_template: "{{ states.sensor.alarm_clock_auto.attributes.icon }}"
        value_template: >
          {{ states('sensor.alarm_clock_auto') if states('sensor.alarm_clock_auto') in ['Off','unknown','unavailable','none']
              else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.alarm_clock_auto'))|timestamp_custom('%-I:%M %p') }}

#######################################################################################################################
## Manual Alarm Clock - alarm status in glance alerts, alarm settings popup
#######################################################################################################################
      alarm_clock_manual:
        friendly_name: Manual Alarm
        unique_id: alarm_clock_manual
        icon_template: >
          {% if is_state('sensor.alarm_clock_manual','Snooze') %} mdi:alarm-snooze
          {% elif is_state('sensor.alarm_clock_manual','Active') %} mdi:alarm-note
          {% elif is_state('sensor.alarm_clock_manual','Off') %} mdi:alarm-off
          {% else %} mdi:alarm-check
          {% endif %}
        value_template: >
          {% if is_state('input_boolean.alarm_clock_active_manual','on') and is_state('input_boolean.alarm_clock_snooze','on') %} Snooze
          {% elif is_state('input_boolean.alarm_clock_active_manual','on') %} Active
          {% elif is_state('input_boolean.alarm_clock_manual','on') %}
            {{ as_timestamp(states('sensor.date') ~ ' ' ~ states('input_datetime.alarm_clock_manual_time')[0:5])|timestamp_custom('%H:%M',true) }}
          {% else %} Off
          {% endif %}

#######################################################################################################################
## Manual Alarm Clock Display - covnerts display time to 12h
#######################################################################################################################
      alarm_clock_manual_display:
        friendly_name: Manual Alarm
        unique_id: alarm_clock_manual_display
        icon_template : "{{ states.sensor.alarm_clock_manual.attributes.icon }}"
        value_template: >
          {{ states('sensor.alarm_clock_manual') if states('sensor.alarm_clock_manual') in ['Off','unknown','unavailable','none']
              else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.alarm_clock_manual'))|timestamp_custom('%-I:%M %p') }}

#######################################################################################################################
## Nap Alarm Clock - alarm status in glance alerts, alarm settings popup
#######################################################################################################################
      alarm_clock_nap:
        friendly_name: Nap Alarm
        unique_id: alarm_clock_nap
        icon_template: >
          {% if is_state('sensor.alarm_clock_nap','Snooze') %} mdi:alarm-snooze
          {% elif is_state('sensor.alarm_clock_nap','Active') %} mdi:alarm-note
          {% elif is_state('sensor.alarm_clock_nap','Off') %} mdi:alarm-off
          {% else %} mdi:alarm-check
          {% endif %}
        value_template: >
          {% if is_state('input_boolean.alarm_clock_active_nap','on')
              and is_state('input_boolean.alarm_clock_snooze','on') %} Snooze
          {% elif is_state('input_boolean.alarm_clock_active_nap','on') %} Active
          {% elif is_state('input_boolean.alarm_clock_nap','on') %}
            {{ as_timestamp(state_attr('timer.alarm_clock_nap','finishes_at'))|timestamp_custom('%H:%M',true) }}
          {% else %} Off
          {% endif %}

#######################################################################################################################
## Manual Alarm Clock Display - covnerts display time to 12h
#######################################################################################################################
      alarm_clock_nap_display:
        friendly_name: Nap Alarm
        unique_id: alarm_clock_nap_display
        icon_template: "{{ states.sensor.alarm_clock_nap.attributes.icon }}"
        value_template: >
          {{ states('sensor.alarm_clock_nap') if states('sensor.alarm_clock_nap') in ['Off','unknown','unavailable','none']
              else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.alarm_clock_nap'))|timestamp_custom('%-I:%M %p') }}

#######################################################################################################################
## Next Alarm - earliest of auto, manual, phone
#######################################################################################################################
      alarm_clock_next_alarm:
        friendly_name: Next Alarm
        unique_id: alarm_clock_next_alarm
        icon_template: mdi:alarm
        value_template: >
          {% set time = states('sensor.time') %}
          {% set auto = '99:99' if states('sensor.alarm_clock_auto') in ['Off','Snooze','Active']
              else states('sensor.alarm_clock_auto') %}
          {% set manual = '99:99' if states('sensor.alarm_clock_manual') in ['Off','Snooze','Active']
              else states('sensor.alarm_clock_manual') %}
          {% set nap = '99:99' if states('sensor.alarm_clock_nap') in ['Off','Snooze','Active']
              else states('sensor.alarm_clock_nap') %}
          {% set jalarm = '99:99' if is_state('input_boolean.alarm_clock_phone','off') or is_state('binary_sensor.jason_home','off')
              or states('sensor.jphone_alarm_clock') in ['Off','unknown','unavailable','none']
              else states('sensor.jphone_alarm_clock') %}
          {% set salarm = '99:99' if is_state('input_boolean.alarm_clock_phone','off') or is_state('binary_sensor.sheri_home','off')
              or states('sensor.sphone_alarm_clock') in ['Off','unknown','unavailable','none']
              else states('sensor.sphone_alarm_clock') %}
          {% set next = [auto,manual,nap,jalarm,salarm]|min %}
          {{ 'Active' if is_state('binary_sensor.alarm_clock_active','on') else ('Off' if next == '99:99' else next) }}
        attribute_templates:
          alarm_source: >
            {% set next = states('sensor.alarm_clock_next_alarm') %}
            {% if next in ['Active','Off','unknown','unavailable','none'] %} none
            {% elif next == states('sensor.alarm_clock_auto') %} auto
            {% elif next == states('sensor.alarm_clock_manual') %} manual
            {% elif next == states('sensor.alarm_clock_nap') %} nap
            {% elif next == as_timestamp(states('sensor.jphone_next_alarm'))|timestamp_custom('%H:%M',true) %} jphone
            {% elif next == as_timestamp(states('sensor.sphone_next_alarm'))|timestamp_custom('%H:%M',true) %} sphone
            {% endif %}

#######################################################################################################################
## Next Alarm Display - covnerts display time to 12h
#######################################################################################################################
      alarm_clock_next_alarm_display:
        friendly_name: Next Alarm
        unique_id: alarm_clock_next_alarm_display
        icon_template: "{{ states.sensor.alarm_clock_next_alarm.attributes.icon }}"
        value_template: >
          {{ states('sensor.alarm_clock_next_alarm') if states('sensor.alarm_clock_next_alarm') in ['Off','unknown','unavailable','none']
              else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.alarm_clock_next_alarm'))|timestamp_custom('%-I:%M %p') }}

alert:
#######################################################################################################################
## Alarm Clock Active Alert
#######################################################################################################################
  alarm_clock_active:
    name: Alarm Clock Active
    title: Wake Up Alarm!
    message: "Good morning!\n {{ now().strftime('%H:%M  %Y-%m-%d') }}."
    entity_id: binary_sensor.alarm_clock_alert
    state: 'on'
    repeat: 5
    can_acknowledge: true
    skip_first: false
    notifiers: mobile_app_jason
    data:
      tag: alarm_clock_active
      group: General
      channel: Alert
      importance: max
      vibrationPattern: '200, 100, 200, 100, 200, 100, 400'
      ledColor: !secret NOTIFY_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret ALARM_CLOCK_ICON
      image: !secret ALARM_CLOCK_IMAGE
      actions:
        - action: turn_off_alarm_clock
          title: Turn Off Alarm
        - action: snooze_alarm_clock
          title: Snooze

#######################################################################################################################
## Alarm Clock Presence Alert
#######################################################################################################################
  alarm_clock_presence:
    name: Alarm Clock Presence
    title: Alarm Clock Presence Alert
    message: Nobody is home and an alarm clock is active.
    entity_id: binary_sensor.alarm_clock_presence_alert
    state: 'on'
    repeat: 5
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: alarm_clock_presence
      group: General
      channel: Alert
      importance: max
      vibrationPattern: '200, 100, 200, 100, 200, 100, 400'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret WARNING_COLOR
      icon_url: !secret ALARM_CLOCK_ICON
      image: !secret ALARM_CLOCK_IMAGE
      actions:
        - action: turn_off_alarm_clock
          title: Turn Off Alarm
        - action: pause_alarm_clock_presence
          title: Pause