#######################################################################################################################
## Mobile App Package - Jason and common items
#######################################################################################################################
homeassistant:
  customize:
    alert.mobile_phone_headphones_jason:
      icon: mdi:headphones
      category: mobile
    alert.mobile_phone_ringer_jason:
      icon: mdi:phone-ring
      category: mobile
    alert.mobile_phone_bluetooth_jason:
      icon: mdi:phone-bluetooth
      category: mobile
    alert.mobile_phone_wifi_jason:
      icon: mdi:cellphone-wireless
      category: mobile
    alert.mobile_phone_offline_jason:
      icon: mdi:cellphone-off
      category: mobile
    alert.mobile_phone_battery_jason:
      icon: mdi:battery-alert
      category: mobile
    sensor.ha_companion_latest_version:
      icon: mdi:google-play
      category: mobile

input_boolean:
  mobile_tts_alerts:
    name: Mobile TTS Alerts

input_number:
#######################################################################################################################
## Phone Speaker Volumes (float) - store/restore media player reset volume
#######################################################################################################################
  phone_living_room_speaker:
    min: 0
    max: 1
  phone_dining_room_display:
    min: 0
    max: 1
  phone_bedroom_display:
    min: 0
    max: 1
  phone_bathroom_speaker:
    min: 0
    max: 1
  phone_laundry_room_speaker:
    min: 0
    max: 1
  phone_garage_speaker:
    min: 0
    max: 1
  phone_living_room_tv:
    min: 0
    max: 1
  phone_bedroom_tv:
    min: 0
    max: 1
  phone_deck_tv:
    min: 0
    max: 1

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Mobile App Update
#######################################################################################################################
      mobile_app_update:
        friendly_name: Mobile App Update
        unique_id: mobile_app_update
        icon_template: "{{ 'mdi:alert-circle' if is_state('binary_sensor.mobile_app_update','on') else 'mdi:check-circle' }}"
        value_template: "{{ is_state('sensor.jphone_app_update','on') or is_state('sensor.sphone_app_update','on') }}"

#######################################################################################################################
## Phone Connected Jason - ping, bluetooth are connected or last GPS update less than 15 minutes ago phone is connected
#######################################################################################################################
      jphone_connected:
        friendly_name: Jason Phone Connected
        unique_id: jphone_connected
        icon_template: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.jphone_connected','on') else 'mdi:cellphone-off' }}"
        device_class: connectivity
        value_template: >
          {% if states('device_tracker.jason_tracker')|lower in ['unknown','unavailable','none'] %} false
          {% else %}
            {% set p = as_timestamp(state_attr('device_tracker.jason_tracker','last_seen')) %}
            {% set t = as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.time')) %}
            {% set minutes = (t-p)/60 %}
            {{ is_state('device_tracker.jphone_bt','home')
                or is_state('device_tracker.jphone_ping','home')
                or minutes < 15 }}
          {% endif %}

      jphone_connected_alert:
        unique_id: jphone_connected_alert
        value_template: "(( is_state('binary_sensor.jphone_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Phone Ringer Jason
#######################################################################################################################
      jphone_ringer_alert:
        unique_id: jphone_ringer_alert
        value_template: >
          {{ (is_state('sensor.jphone_do_not_disturb_sensor','priority_only')
              or is_state('sensor.jphone_ringer_mode','off')
              or (states('sensor.jphone_volume_level_ringer')|int < 1 and not is_state('sensor.jphone_phone_state','offhook')))
              and (states('sensor.time') > states('sensor.waketime_today') or is_state('sensor.waketime_today','Off'))
              and not is_state('binary_sensor.quiet_hours','on')
              and not is_state('input_select.occupancy_mode','Night') }}

#######################################################################################################################
## Phone Bluetooth Jason
#######################################################################################################################
      jphone_bluetooth_alert:
        unique_id: jphone_bluetooth_alert
        value_template: "{{ is_state('binary_sensor.jphone_bluetooth_state','off') and is_state('device_tracker.jphone_bt','not_home') }}"

#######################################################################################################################
## Phone Wifi Jason
#######################################################################################################################
      jphone_wifi_alert:
        unique_id: jphone_wifi_alert
        value_template: >
          {{ is_state('binary_sensor.jphone_wifi_state','off')
              and is_state('device_tracker.jphone_wifi2','not_home')
              and is_state('device_tracker.jphone_wifi5','not_home') }}

#######################################################################################################################
## Phone Headphone Jason
#######################################################################################################################
      jphone_headphones_alert:
        unique_id: jphone_headphones_alert
        value_template: >
          {% set p = is_state('device_tracker.jason_headphones_bt','home') %}
          {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
          {{ is_state('input_boolean.presence_automation','on')
              and is_state('binary_sensor.alerts_enabled','on')
              and is_state('binary_sensor.jason_home','on')
              and ( p or c )
              and not is_state('alert.phone_mobile_headphone_jason','off') }}
        availability_template: >
          {{ states('sensor.jphone_bluetooth_connection')|lower not in ['unknown','unavailable','none']
              and states('device_tracker.jason_headphones_bt')|lower not in ['unknown','unavailable','none'] }}

#######################################################################################################################
## Phone Battery Jason
#######################################################################################################################
      jphone_battery_alert:
        unique_id: jphone_battery_alert
        value_template: >
          {% set level = 50 if is_state('binary_sensor.pre_work_active','on') else 20 %}
          {{ states('sensor.jphone_battery_level')|int < level and is_state('binary_sensor.jphone_is_charging','off')
              and is_state('binary_sensor.alerts_enabled','on') }}

sensor:
  - platform: github
    access_token: !secret GIT_SENSOR_TOKEN
    repositories:
      - path: home-assistant/android
        name: HA Companion Latest Version GIT

#######################################################################################################################
## Companion App Latest Version
#######################################################################################################################
  - platform: scrape
    resource: https://play.google.com/store/apps/details?id=io.homeassistant.companion.android&hl=en_CA&gl=US
    name: HA Companion Latest Version
    select: ".htlgb span"
    index: 3

  - platform: template
    sensors:
#######################################################################################################################
## Jason Mobile App Update
#######################################################################################################################
      jphone_app_update:
        friendly_name: Jason Mobile App Update
        unique_id: jphone_app_update
        icon_template: "{{ 'mdi:check-circle' if is_state('sensor.jphone_app_update','off') else 'mdi:alert-circle' }}"
        value_template: "{{ 'on' if states('sensor.ha_companion_latest_version') != states('sensor.jphone_current_version') else 'off' }}"
        attribute_templates:
          current: "{{ states('sensor.jphone_current_version') }}"
          latest: "{{ states('sensor.ha_companion_latest_version') }}"

#######################################################################################################################
## Tracker Last Seen
#######################################################################################################################
      jason_tracker_last_seen:
        friendly_name: Jason Tracker Last Seen
        unique_id: jason_tracker_last_seen
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp( state_attr('device_tracker.jason_tracker','last_seen'))|timestamp_custom('%H:%M',true) }}"
        availability_template: "{{ states('device_tracker.jason_tracker')|lower not in ['unknown','unavailable','none'] or state_attr('device_tracker.jason_tracker','source_type')|lower == 'none' }}"

#######################################################################################################################
## Phone Last Update
#######################################################################################################################
      jphone_last_update:
        friendly_name: Jason Phone Last Update
        unique_id: jphone_last_update
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp(states.sensor.jphone_last_update_trigger.last_updated)|timestamp_custom('%-I:%M %p',true) }}"
        availability_template: "{{ states('sensor.jphone_last_update_trigger')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone Address
#######################################################################################################################
      jphone_address:
        friendly_name: Jason Location Address
        unique_id: jphone_address
        icon_template: mdi:google-maps
        value_template: "{{ state_attr('device_tracker.google_maps_101131226839468750203','address') }}"
        availability_template: "{{ states('device_tracker.google_maps_101131226839468750203')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone Alarm Clock
#######################################################################################################################
      jphone_alarm_clock:
        friendly_name: Jason Phone Alarm
        unique_id: jphone_alarm_clock
        icon_template: mdi:alarm
        value_template:  >
          {{ 'Off' if states('sensor.jphone_next_alarm') in ['unavailable']
                  or (as_timestamp(states('sensor.jphone_next_alarm')) - as_timestamp(now())) > 86400
                  or is_state('input_boolean.alarm_clock_phone','off')
                else as_timestamp(states('sensor.jphone_next_alarm'))|timestamp_custom('%H:%M',true) }}
        availability_template: "{{ states('sensor.jphone_next_alarm') not in ['unknown','none'] }}"

      jphone_alarm_clock_display:
        friendly_name: Jason Phone Alarm
        unique_id: jphone_alarm_clock_display
        icon_template: mdi:alarm
        value_template: >
          {{ 'Off' if is_state('sensor.jphone_alarm_clock','Off')
                else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.jphone_alarm_clock'))|timestamp_custom('%-I:%M %p',true) }}
        availability_template: "{{ states('sensor.jphone_alarm_clock')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone In Use
#######################################################################################################################
      phone_in_use:
        friendly_name: Jason Phone In Use
        unique_id: phone_in_use
        icon_template: "{{ 'mdi:cellphone-wireless' if is_state('sensor.phone_in_use','on') else 'mdi:cellphone-off' }}"
        value_template: >
          {{ 'on' if (is_state('binary_sensor.jason_home','on') and states('sensor.jphone_phone_state') in ['ringing','offhook'])
              or (is_state('binary_sensor.sheri_home','on') and states('sensor.sphone_phone_state') in ['ringing','offhook']) else 'off' }}
        attribute_templates:
          speaker_on: >
            {{ (is_state('binary_sensor.jason_home','on') and is_state('binary_sensor.jphone_speakerphone','on'))
                 or (is_state('binary_sensor.sheri_home','on') and is_state('binary_sensor.sphone_speakerphone','on')) }}

alert:
#######################################################################################################################
## Alert - Phone Offline Jason
#######################################################################################################################
  mobile_phone_offline_jason:
    name: Phone Offline Jason
    title: Jason Phone Offline
    message: "Phone offline at {{ as_timestamp(now())|timestamp_custom('%-I:%M %p') }}"
    entity_id: binary_sensor.jphone_connected_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile_app_jphone
    data:
      tag: phone_offline_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON
      image: !secret OFFLINE_IMAGE
      actions:
        - action: pause_phone_offline_jason
          title: Pause

#######################################################################################################################
## Alert - Phone Ringer Jason
#######################################################################################################################
  mobile_phone_ringer_jason:
    name: Phone Ringer Jason
    title: Jason Phone Ringer
    message: Jason, your mobile phone ringer is off.
    entity_id: binary_sensor.jphone_ringer_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile_app_jphone
    data:
      tag: phone_ringer_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_offline_jason
          title: Pause

#######################################################################################################################
## Alert - Phone Bluetooth Jason
#######################################################################################################################
  mobile_phone_bluetooth_jason:
    name: Phone Bluetooth Jason
    title: Jason Phone Bluetooth
    message: Jason, your mobile phone bluetooth is off.
    entity_id: binary_sensor.jphone_bluetooth_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile_app_jphone
    data:
      tag: phone_bluetooth_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_bluetooth_jason
          title: Pause

#######################################################################################################################
## Alert - Phone Wifi Jason
#######################################################################################################################
  mobile_phone_wifi_jason:
    name: Phone Wifi Jason
    title: Jason Phone WIFI
    message: Jason, your mobile phone wifi is off.
    entity_id: binary_sensor.jphone_wifi_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile_app_jphone
    data:
      tag: phone_wifi_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_wifi_jason
          title: Pause


#######################################################################################################################
## Alert - Phone Headphones Jason
#######################################################################################################################
  mobile_phone_headphones_jason:
    name: Phone Headphones Jason
    title: Jason Phone Headphones
    message: >
      {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
      Your headphones are on{{ ', and are still connected to your phone!' if c else '.' }}
    entity_id: binary_sensor.jphone_headphones_alert
    state: 'on'
    repeat:
      - 30
      - 120
    notifiers: mobile_app_jphone
    data:
      tag: phone_headphones_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_headphones_jason
          title: Pause

#######################################################################################################################
## Alert - Phone Battery Jason
#######################################################################################################################
  mobile_phone_battery_jason:
    name: Phone Battery Jason
    title: Phone Battery
    message: >
      Phone Battery: {{ states('sensor.jphone_battery_level') }}%
      <br/>Battery Health: {{ states('sensor.jphone_battery_health')|title }}
    entity_id: binary_sensor.jphone_battery_alert
    state: 'on'
    repeat:
      - 30
      - 60
    notifiers: mobile_app_jphone
    data:
      tag: phone_battery_jason
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret BATTERY_ICON
      actions:
        - action: pause_phone_battery_jason
          title: Pause