#######################################################################################################################
## Mobile App Package - Jason and common items
#######################################################################################################################
homeassistant:
  customize:
    alert.mobile_phone_headphones_jason:
      icon: mdi:headphones
      category: mobile
    alert.mobile_phone_ringer_jason:
      icon: mdi:phone-ring
      category: mobile
    alert.mobile_phone_bluetooth_jason:
      icon: mdi:phone-bluetooth
      category: mobile
    alert.mobile_phone_wifi_jason:
      icon: mdi:cellphone-wireless
      category: mobile
    alert.mobile_phone_offline_jason:
      icon: mdi:cellphone-off
      category: mobile
    alert.mobile_phone_battery_jason:
      icon: mdi:battery-alert
      category: mobile
    sensor.ha_companion_latest_version:
      icon: mdi:google-play
      category: mobile

input_boolean:
  mobile_tts_alerts:
    name: Mobile TTS Alerts

input_number:
#######################################################################################################################
## Phone Speaker Volumes (float) - store/restore media player reset volume
#######################################################################################################################
  phone_all_speakers:
    min: 0
    max: 100
  phone_broadcast_speakers:
    min: 0
    max: 100
  phone_music_speakers:
    min: 0
    max: 100
  phone_quiet_speakers:
    min: 0
    max: 100
  phone_night_speakers:
    min: 0
    max: 100
  phone_living_room_speaker:
    min: 0
    max: 100
  phone_dining_room_display:
    min: 0
    max: 100
  phone_bedroom_display:
    min: 0
    max: 100
  phone_bathroom_speaker:
    min: 0
    max: 100
  phone_laundry_room_speaker:
    min: 0
    max: 100
  phone_garage_speaker:
    min: 0
    max: 100
  phone_living_room_tv:
    min: 0
    max: 100
  phone_bedroom_tv:
    min: 0
    max: 100
  phone_deck_tv:
    min: 0
    max: 100

sensor:
  - platform: github
    access_token: !secret GIT_SENSOR_TOKEN
    repositories:
      - path: home-assistant/android
        name: HA Companion Latest Version GIT

#######################################################################################################################
## Companion App Latest Version
#######################################################################################################################
  - platform: scrape
    resource: https://play.google.com/store/apps/details?id=io.homeassistant.companion.android&hl=en_CA&gl=US
    name: HA Companion Latest Version
    select: ".htlgb span"
    index: 3

  - platform: template
    sensors:
#######################################################################################################################
## Tracker Last Seen
#######################################################################################################################
      jason_tracker_last_seen:
        friendly_name: Jason Tracker Last Seen
        unique_id: jason_tracker_last_seen
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp( state_attr('device_tracker.jason_tracker','last_seen'))|timestamp_custom('%H:%M',true) }}"
        availability_template: "{{ states('device_tracker.jason_tracker')|lower not in ['unknown','unavailable','none'] or state_attr('device_tracker.jason_tracker','source_type')|lower == 'none' }}"

#######################################################################################################################
## Phone Last Update
#######################################################################################################################
      jphone_last_update:
        friendly_name: Jason Phone Last Update
        unique_id: jphone_last_update
        icon_template: mdi:cellphone-arrow-down
        value_template: "{{ as_timestamp(states.sensor.jphone_last_update_trigger.last_updated)|timestamp_custom('%-I:%M %p',true) }}"
        availability_template: "{{ states('sensor.jphone_last_update_trigger')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone Address
#######################################################################################################################
      jphone_address:
        friendly_name: Jason Location Address
        unique_id: jphone_address
        icon_template: mdi:google-maps
        value_template: "{{ state_attr('device_tracker.google_maps_101131226839468750203','address') }}"
        availability_template: "{{ states('device_tracker.google_maps_101131226839468750203')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone Alarm Clock
#######################################################################################################################
      jphone_alarm_clock:
        friendly_name: Jason Phone Alarm
        unique_id: jphone_alarm_clock
        icon_template: mdi:alarm
        value_template:  >
          {{ 'Off' if states('sensor.jphone_next_alarm') in ['unavailable']
                  or (as_timestamp(states('sensor.jphone_next_alarm')) - as_timestamp(now())) > 86400
                  or is_state('input_boolean.alarm_clock_phone','off')
                else as_timestamp(states('sensor.jphone_next_alarm'))|timestamp_custom('%H:%M',true) }}
        availability_template: "{{ states('sensor.jphone_next_alarm') not in ['unknown','none'] }}"

      jphone_alarm_clock_display:
        friendly_name: Jason Phone Alarm
        unique_id: jphone_alarm_clock_display
        icon_template: mdi:alarm
        value_template: >
          {{ 'Off' if is_state('sensor.jphone_alarm_clock','Off')
                else as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.jphone_alarm_clock'))|timestamp_custom('%-I:%M %p',true) }}
        availability_template: "{{ states('sensor.jphone_alarm_clock')|lower not in ['unknown','unavailable','none'] }}"

#######################################################################################################################
## Phone In Use
#######################################################################################################################
      phone_in_use:
        friendly_name: Jason Phone In Use
        unique_id: phone_in_use
        icon_template: "{{ 'mdi:cellphone-wireless' if is_state('sensor.phone_in_use','on') else 'mdi:cellphone-off' }}"
        value_template: >
          {{ 'on' if (is_state('binary_sensor.jason_home','on') and states('sensor.jphone_phone_state') in ['ringing','offhook'])
              or (is_state('binary_sensor.sheri_home','on') and states('sensor.sphone_phone_state') in ['ringing','offhook']) else 'off' }}
        attribute_templates:
          speaker_on: >
            {{ (is_state('binary_sensor.jason_home','on') and is_state('binary_sensor.jphone_speakerphone','on'))
                 or (is_state('binary_sensor.sheri_home','on') and is_state('binary_sensor.sphone_speakerphone','on')) }}

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Jason Phone App Version
#######################################################################################################################
      jphone_latest_version:
        friendly_name: Jason Phone App Version
        unique_id: jphone_latest_version
        icon_template: "{{ 'mdi:check-circle' if is_state('binary_sensor.jphone_latest_version','off') else 'mdi:alert-circle' }}"
        device_class: problem
        value_template: "{{ states('sensor.ha_companion_latest_version') != states('sensor.jphone_current_version') }}"
        attribute_templates:
          current: "{{ states('sensor.jphone_current_version') }}"
          latest: "{{ states('sensor.ha_companion_latest_version') }}"

#######################################################################################################################
## Phone Connected Jason - ping, bluetooth are connected or last GPS update less than 15 minutes ago phone is connected
#######################################################################################################################
      jphone_connected:
        friendly_name: Jason Phone Connected
        unique_id: jphone_connected
        icon_template: "{{ 'mdi:cellphone-wireless' if is_state('binary_sensor.jphone_connected','on') else 'mdi:cellphone-off' }}"
        device_class: connectivity
        value_template: >
          {% if states('device_tracker.jason_tracker')|lower in ['unknown','unavailable','none'] %} false
          {% else %}
            {% set p = as_timestamp(state_attr('device_tracker.jason_tracker','last_seen')) %}
            {% set t = as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.time')) %}
            {% set minutes = (t-p)/60 %}
            {{ is_state('device_tracker.jphone_bt','home')
                or is_state('device_tracker.jphone_ping','home')
                or minutes < 15 }}
          {% endif %}

      jphone_connected_alert:
        unique_id: jphone_connected_alert
        value_template: "(( is_state('binary_sensor.jphone_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Phone Ringer Jason
#######################################################################################################################
      jphone_ringer_alert:
        unique_id: jphone_ringer_alert
        value_template: >
          {{ (is_state('sensor.jphone_do_not_disturb_sensor','priority_only')
              or is_state('sensor.jphone_ringer_mode','off')
              or (states('sensor.jphone_volume_level_ringer')|int < 1 and not is_state('sensor.jphone_phone_state','offhook')))
              and (states('sensor.time') > states('sensor.waketime_today') or is_state('sensor.waketime_today','Off'))
              and not is_state('binary_sensor.quiet_hours','on')
              and not is_state('input_select.occupancy_mode','Night') }}

#######################################################################################################################
## Phone Bluetooth Jason
#######################################################################################################################
      jphone_bluetooth_alert:
        unique_id: jphone_bluetooth_alert
        value_template: "{{ is_state('binary_sensor.jphone_bluetooth_state','off') and is_state('device_tracker.jphone_bt','not_home') }}"

#######################################################################################################################
## Phone Wifi Jason
#######################################################################################################################
      jphone_wifi_alert:
        unique_id: jphone_wifi_alert
        value_template: >
          {{ is_state('binary_sensor.jphone_wifi_state','off')
              and is_state('device_tracker.jphone_wifi2','not_home')
              and is_state('device_tracker.jphone_wifi5','not_home') }}

#######################################################################################################################
## Phone Headphone Jason
#######################################################################################################################
      jphone_headphones_alert:
        unique_id: jphone_headphones_alert
        value_template: >
          {% set p = is_state('device_tracker.jason_headphones_bt','home') %}
          {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
          {{ is_state('input_boolean.presence_automation','on')
              and is_state('binary_sensor.alerts_enabled','on')
              and is_state('binary_sensor.jason_home','on')
              and ( p or c )
              and not is_state('alert.phone_mobile_headphone_jason','off') }}
        availability_template: >
          {{ states('sensor.jphone_bluetooth_connection')|lower not in ['unknown','unavailable','none']
              and states('device_tracker.jason_headphones_bt')|lower not in ['unknown','unavailable','none'] }}

#######################################################################################################################
## Phone Battery Jason
#######################################################################################################################
      jphone_battery_alert:
        unique_id: jphone_battery_alert
        value_template: >
          {{ states('sensor.jphone_battery_level')|int < 20 and is_state('binary_sensor.jphone_is_charging','off')
              and is_state('binary_sensor.alerts_enabled','on') }}

alert:
#######################################################################################################################
## Alert - Phone Offline Jason
#######################################################################################################################
  mobile_phone_offline_jason:
    name: "Phone Offline Jason"
    title: "Phone Offline Jason Alert "
    message: "Phone offline at {{ as_timestamp(now())|timestamp_custom('%-I:%M %p') }}"
    entity_id: binary_sensor.jphone_connected_alert
    state: 'on'
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_offline_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON
      image: !secret OFFLINE_IMAGE
      actions:
        - action: pause_phone_offline_jason
          title: Pause
        - action: close_phone_offline_jason
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/presence
      icon: !secret OFFLINE_ICON
      badge: !secret OFFLINE_BADGE

#######################################################################################################################
## Alert - Phone Ringer Jason
#######################################################################################################################
  mobile_phone_ringer_jason:
    name: "Phone Ringer Jason"
    title: "Phone Ringer Jason Alert"
    message: "Jason, your mobile phone ringer is off."
    entity_id: binary_sensor.jphone_ringer_alert
    state: 'on'
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_ringer_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_offline_jason
          title: Pause
        - action: close_phone_offline_jason
          title: Close

#######################################################################################################################
## Alert - Phone Bluetooth Jason
#######################################################################################################################
  mobile_phone_bluetooth_jason:
    name: "Phone Bluetooth Jason"
    title: "Phone Bluetooth Jason Alert"
    message: "Jason, your mobile phone bluetooth is off."
    entity_id: binary_sensor.jphone_bluetooth_alert
    state: 'on'
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_bluetooth_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_bluetooth_jason
          title: Pause
        - action: close_phone_bluetooth_jason
          title: Close

#######################################################################################################################
## Alert - Phone Wifi Jason
#######################################################################################################################
  mobile_phone_wifi_jason:
    name: "Phone Wifi Jason"
    title: "Phone Wifi Jason Alert"
    message: "Jason, your mobile phone wifi is off."
    entity_id: binary_sensor.jphone_wifi_alert
    state: 'on'
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_wifi_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_wifi_jason
          title: Pause
        - action: close_phone_wifi_jason
          title: Close

#######################################################################################################################
## Alert - Phone Headphones Jason
#######################################################################################################################
  mobile_phone_headphones_jason:
    name: "Phone Headphones Jason"
    title: "Phone Headphones Jason Alert"
    message: >
      {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
      Your headphones are on{{ ', and are still connected to your phone!' if c else '.' }}
    entity_id: binary_sensor.jphone_headphones_alert
    state: 'on'
    repeat:
      - 30
      - 120
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_headphones_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret OFFLINE_ICON #IMAGE
      actions:
        - action: pause_phone_headphones_jason
          title: Pause
        - action: close_phone_headphones_jason
          title: Close

#######################################################################################################################
## Alert - Phone Battery Jason
#######################################################################################################################
  mobile_phone_battery_jason:
    name: Phone Battery Jason
    title: Phone Battery
    message: >
      Phone Battery: {{ states('sensor.jphone_battery_level') }}%
      <br/>Battery Health: {{ states('sensor.jphone_battery_health')|title }}
    entity_id: binary_sensor.jphone_battery_alert
    state: 'on'
    repeat:
      - 30
      - 60
    can_acknowledge: true
    skip_first: true
    notifiers: jason
    data:
      tag: phone_battery_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 3600
      persistent: false
      sticky: false
      clickAction: /lovelace/presence
      color: !secret WARNING_COLOR
      icon_url: !secret BATTERY_ICON
      actions:
        - action: pause_phone_battery_jason
          title: Pause
        - action: close_phone_battery_jason
          title: Close

script:
#######################################################################################################################
## Update Device Location
#######################################################################################################################
  update_device_location:
    alias: Update Device Location
    description: Arm alarm in away mode.
    icon: mdi:map-marker-up
    fields:
      device:
        description: Device to update.
        example: jphone
    mode: queued
    max: 5
    sequence:
      - service: "notify.mobile_app_{{ device }}"
        data:
          message: request_location_update

      - service: browser_mod.toast
        data:
          message: >
            A location update request was sent to {{ "Jason's" if device =='jphone' else "Sheri's" }} mobile device.

automation:
#######################################################################################################################
## Mobile - Phone In Use
#######################################################################################################################
  - id: mobile_phone_in_use
    alias: "[Mobile] Phone In Use"
    description: "Turn down media players when a phone is in use."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: sensor.phone_in_use
        to: 'on'

    action:
      - service: script.save_media_player_volumes
        data:
          source: phone_on

      - service: script.set_media_player_volumes
        data:
          media_player: all
          source: phone_on

      # wait up to 60 minutes for phone to be idle or person to leave to restore volumes
      - wait_template: "{{ is_state('sensor.phone_in_use','off') }}"
        timeout:
          minutes: 60
        continue_on_timeout: false

      - service: script.set_media_player_volumes
        data:
          media_player: all
          source: phone_off

#######################################################################################################################
## Mobile - Phone Speakerphone
## doesn't run if other person's phone triggered it first
## checks when someone comes home if they are on the phone
#######################################################################################################################
  - id: mobile_phone_speakerphone
    alias: "[Mobile] Phone Speakerphone"
    description: "Mute media players when a phone speakerphone is turned on."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: sensor.phone_in_use
        attribute: speaker_on
        to: true

    action:
      - service: media_player.volume_mute
        data:
          entity_id: all
          is_volume_muted: true

      # wait until person not home or speakerphone is off
      - wait_template: "{{ is_state_attr('sensor.phone_in_use','speaker_on',false) }}"
        timeout:
          minutes: 60
        continue_on_timeout: true # don't leave media players muted

      - service: media_player.volume_mute
        data:
          entity_id: all
          is_volume_muted: false

#######################################################################################################################
## Mobile - Phone Offline Alert Jason
#######################################################################################################################
  - id: mobile_phone_offline_jason
    alias: "[Mobile] Phone Offline Jason"
    description: "Play announcement when alert turns on."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_offline_jason
        to: 'on'
        for:
          minutes: 15

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_offline_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: "Jason, your mobile phone is offline at {{ as_timestamp(now())|timestamp_custom('%-I:%M %p') }}"
                quiet_play: true

            - wait_template: "{{ not is_state('alert.mobile_phone_offline_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_offline_jason
                  state: 'on'

#######################################################################################################################
## Mobile - DND Jason
#######################################################################################################################
  - id: mobile_dnd_jason
    alias: "[Mobile] DND Jason"
    description: "Turn DND on at night, off during day."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_select.occupancy_mode
        to: Night

      - platform: state
        entity_id: input_select.occupancy_mode
        from: Night

    condition:
      - condition: state
        entity_id: binary_sensor.jason_home
        state: 'on'

    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_select.occupancy_mode
                state: Night

            sequence:
              - service: notify.mobile_app_jphone
                data:
                  message: command_dnd
                  title: priority_only # alarms_only, off, priority_only, total_silence

        default:
          # turn dnd off
          - service: notify.mobile_app_jphone
            data:
              message: command_dnd
              title: 'off'

          # turn ringer on
          - service: notify.mobile_app_jphone
            data:
              message: command_ringer_mode
              title: normal # normal, silent, vibrate

          # turn all volumes up
          - service: notify.mobile_app_jphone
            data:
              message: command_volume_level
              title: 7 # alarm 0-25, music 0-12, notification 0-7, ring 0-7
              data:
                channel: alarm_stream # alarm_stream, music_stream, notification_stream, ring_stream

          - service: notify.mobile_app_jphone
            data:
              message: command_volume_level
              title: 25
              data:
                channel: music_stream

          - service: notify.mobile_app_jphone
            data:
              message: command_volume_level
              title: 7
              data:
                channel: notification_stream

          - service: notify.mobile_app_jphone
            data:
              message: command_volume_level
              title: 7
              data:
                channel: ring_stream

#######################################################################################################################
## Mobile - Phone Battery Low Jason
#######################################################################################################################
  - id: mobile_phone_battery_low_jason
    alias: "[Mobile] Phone Battery Low Jason"
    description: "Play announcement when alert turns on."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_battery_jason
        to: 'on'
        for:
          minutes: 15

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_battery_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: >
                  Pay attention Jason!  You've let your phone battery get down to {{ states('sensor.jphone_battery_level') }}%. Plug the friggin thing in!
                quiet_play: true

            # prevent automation from triggering again for a while
            - delay:
                minutes: 60

            - wait_template: "{{ not is_state('alert.mobile_phone_battery_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_battery_jason
                  state: 'on'

#######################################################################################################################
## Mobile - Phone Ringer Jason
#######################################################################################################################
  - id: mobile_phone_ringer_jason
    alias: "[Mobile] Phone Ringer Jason"
    description: "Play announcement when alert turns on."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_ringer_jason
        to: 'on'
        for:
          minutes: 15

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_ringer_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            # always false during quiet hours, no quiet play
            - service: script.tts_play
              data:
                play_message: "Jason, your phone ringer is off."

            - wait_template: "{{ not is_state('alert.mobile_phone_ringer_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_ringer_jason
                  state: 'on'

#######################################################################################################################
## Mobile - Phone Bluetooth Jason
#######################################################################################################################
  - id: mobile_phone_bluetooth_jason
    alias: "[Mobile] Phone Bluetooth Jason"
    description: "Play announcement when alert turns on."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_bluetooth_jason
        to: 'on'
        for:
          minutes: 15

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_bluetooth_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: "Jason, your phone bluetooth is off."
                quiet_play: true

            - wait_template: "{{ not is_state('alert.mobile_phone_bluetooth_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_bluetooth_jason
                  state: 'on'

#######################################################################################################################
## Mobile - Phone Wifi Jason
#######################################################################################################################
  - id: mobile_phone_wifi_jason
    alias: "[Mobile] Phone Wifi Jason"
    description: "Play announcement when alert turns on."
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_wifi_jason
        to: 'on'
        for:
          minutes: 15

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_wifi_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: "Jason, your phone wifi is off."
                quiet_play: true

            - wait_template: "{{ not is_state('alert.mobile_phone_wifi_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_wifi_jason
                  state: 'on'

#######################################################################################################################
## Mobile - Phone Headphones Jason
#######################################################################################################################
  - id: mobile_phone_headphones_jason
    alias: "[Mobile] Phone Headphones Jason"
    description: "Play announcement when alert turns on."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_headphones_jason
        to: 'on'
        for:
          minutes: 120

      - platform: state
        entity_id: input_select.occupancy_mode
        to: Home
        from: Night
        for:
          minutes: 30

      - platform: state
        entity_id: binary_sensor.jason_home
        to: 'on'
        for:
          minutes: 15

    condition:
      - condition: state
        entity_id:
          - alert.mobile_phone_headphones_jason
          - binary_sensor.jason_home
        state: 'on'

      - condition: state
        entity_id: input_select.occupancy_mode
        state: Home

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: >
                  {% set c = '00:18:6B:97:9B:B9' in state_attr('sensor.jphone_bluetooth_connection','connected_paired_devices') %}
                  Jason, get your shit together. You've left your headphones on{{ ', and they are still connected to your phone!' if c else ' or plugged into the charger again.' }}
                quiet_play: true

            - wait_template: "{{ not is_state('alert.mobile_phone_headphones_jason','on') }}"
              timeout:
                hours: 1
              continue_on_timeout: true

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.mobile_phone_headphones_jason
                  state: 'on'

#######################################################################################################################
## Mobile - Close Phone Offline Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_offline_jason_notifications
    alias: "[Mobile] Close Phone Offline Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_offline_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_offline_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_offline_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_offline_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_offline_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_offline_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_offline_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_offline_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_offline_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Mobile - Close Phone Ringer Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_ringer_jason_notifications
    alias: "[Mobile] Close Phone Ringer Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_ringer_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_ringer_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_ringer_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_ringer_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_ringer_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_ringer_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_ringer_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_ringer_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_ringer_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Mobile - Close Phone Bluetooth Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_bluetooth_jason_notifications
    alias: "[Mobile] Close Phone Bluetooth Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_bluetooth_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_bluetooth_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_bluetooth_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_bluetooth_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_bluetooth_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_bluetooth_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_bluetooth_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_bluetooth_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_bluetooth_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Mobile - Close Phone Wifi Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_wifi_jason_notifications
    alias: "[Mobile] Close Phone Wifi Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_wifi_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_wifi_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_wifi_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_wifi_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_wifi_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_wifi_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_wifi_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_wifi_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_wifi_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Mobile - Close Phone Headphones Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_headphones_jason_notifications
    alias: "[Mobile] Close Phone Headphones Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_headphones_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_headphones_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_headphones_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_headphones_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_headphones_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_headphones_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_headphones_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_headphones_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_headphones_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Mobile - Close Phone Battery Jason Notifications
#######################################################################################################################
  - id: mobile_close_phone_battery_jason_notifications
    alias: "[Mobile] Close Phone Battery Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.mobile_phone_battery_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: phone_battery_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_phone_battery_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_phone_battery_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: phone_battery_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_phone_battery_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_phone_battery_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: mobile
          tag: phone_battery_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_phone_battery_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers
