#######################################################################################################################
## Package - Spa
#######################################################################################################################
homeassistant:
  customize:
    alert.spa_low_temperature:
      friendly_name: Spa Low Temp
      icon: mdi:snowflake-alert
      category: climate

input_number:
#######################################################################################################################
## Spa Low Temperature Threshold
#######################################################################################################################
  spa_low_temperature_threshold:
    name: Spa Low Temperature Threshold
    icon: mdi:thermometer-lines
    unit_of_measurement: '째F'
    min: 80
    max: 105
    step: 1

binary_sensor:
  - platform: template
    sensors:
      balboa_connected:
        friendly_name: Balboa Spa
        unique_id: balboa_connected
        icon_template: "{{ 'mdi:spa' if is_state('binary_sensor.balboa_connected','on') else 'mdi:spa-outline' }}"
        device_class: connectivity
        delay_off:
          minutes: 30
        value_template: "{{ not states('climate.spa')|lower in ['unknown','unavailable','none'] }}"

      balboa_connected_alert:
        friendly_name: Balboa Spa
        unique_id: balboa_connected_alert
        icon_template: mdi:spa
        value_template: "{{ is_state('binary_sensor.balboa_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Spa Low Temperature
#######################################################################################################################
      spa_low_temperature_alert:
        unique_id: spa_low_temperature_alert
        delay_on:
          minutes: 15 # let temp stabalize, avoid false alerts
        value_template: >
            {{ states('sensor.spa_temperature')|int < states('input_number.spa_low_temperature_threshold')|int
                and is_state('binary_sensor.alerts_enabled','on') }}
        availability_template: >
            {{ is_state('binary_sensor.balboa_connected','on')
                and states('sensor.spa_temperature')|lower not in ['unknown','unavailable','none'] }}

sensor:
  - platform: template
    sensors:
      spa_temperature:
        friendly_name: Spa Temperature
        unique_id: spa_temperature
        icon_template: mdi:thermometer
        unit_of_measurement: '째'
        value_template: "{{ state_attr('climate.spa','current_temperature') }}"
        availability_template: >
            {{ is_state('binary_sensor.balboa_connected','on')
                and state_attr('climate.spa','current_temperature')|lower not in ['unknown','unavailable','none'] }}

  - platform: template
    sensors:
      spa_target_temperature:
        friendly_name: Spa Target Temperature
        unique_id: spa_target_temperature
        icon_template: mdi:thermometer
        unit_of_measurement: '째'
        value_template: "{{ state_attr('climate.spa','temperature') }}"
        availability_template: >
            {{ is_state('binary_sensor.balboa_connected','on')
                and state_attr('climate.spa','temperature')|lower not in ['unknown','unavailable','none'] }}

alert:
#######################################################################################################################
## Alert - Spa Low Temperature
#######################################################################################################################
  spa_low_temperature:
    name: Spa Low Temperature
    title: Spa Low Temperature Alert
    message: "Spa temperature: {{ states('sensor.spa_temperature') }}째"
    entity_id: binary_sensor.spa_low_temperature_alert
    state: 'on'
    repeat: 720
    notifiers: mobile_app_jphone
    data:
      tag: spa_low_temperature
      group: General
      channel: Alert
      importance: max
      clickAction: /lovelace/climate
      color: !secret WARNING_COLOR
      icon_url: !secret LOW_TEMP_ICON
      image: !secret LOW_TEMP_IMAGE
      actions:
        - action: pause_spa_low_temperature
          title: Pause