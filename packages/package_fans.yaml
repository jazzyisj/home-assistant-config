#######################################################################################################################
## Package - Fans
#######################################################################################################################
homeassistant:
  customize:
    automation.ceiling_fan_upstairs_bedroom_fan_in_use:
      icon: mdi:fan-remove
    automation.ceiling_fan_office_fan_in_use:
      icon: mdi:fan-remove
    automation.ceiling_fan_office_fan_auto_on:
        icon: mdi:fan-plus
    automation.ceiling_fan_office_fan_auto_off:
        icon: mdi:fan-minus
    automation.ceiling_fan_upstairs_bedroom_fan_auto_on:
        icon: mdi:fan-plus
    automation.ceiling_fan_upstairs_bedroom_fan_auto_off:
        icon: mdi:fan-minus  

fan:
#######################################################################################################################
## HVAC Fan (Furnace Fan)
## - template fan to enable control of HVAC fan from UI
#######################################################################################################################
- platform: template
  fans:
    hvac_fan:
      friendly_name: "Furnace Fan"
      value_template: "{{ 'on' if is_state_attr('climate.upstairs_thermostat','fan_mode','on') else 'off' }}"
      turn_on: # set climate fan mode to on
        service: climate.set_fan_mode
        data:
          entity_id: climate.upstairs_thermostat
          fan_mode: 'on'
      turn_off:  # set climate fan mode to auto
        service: climate.set_fan_mode
        data:
          entity_id: climate.upstairs_thermostat
          fan_mode: 'auto'

timer:
#######################################################################################################################
## Upstairs Bedroom Fan In Use
#######################################################################################################################
  upstairs_bedroom_fan:
    name: Upstairs Bedroom Fan
    icon: mdi:progress-clock
    duration: '4:00:00'

#######################################################################################################################
## Office Fan In Use
#######################################################################################################################
  office_fan:
    name: Office Fan
    icon: mdi:progress-clock
    duration: '4:00:00'

  #NEW_CEILING_FAN

#######################################################################################################################
## Climate Fan Schedule timer
## https://www.home-assistant.io/components/timer/
#######################################################################################################################
  climate_fan:
    name: Climate Fan Timer
    icon: mdi:timer-outline

#######################################################################################################################
## Upstairs Bathroom Fan In Use
#######################################################################################################################
  upstairs_bathroom_fan:
    name: Upstairs Bathroom Fan
    icon: mdi:progress-clock
    duration: '00:15:00'

  #NEW_VENT_FAN

input_boolean:
#######################################################################################################################
## Ceiling Fan Automation
#######################################################################################################################
  ceiling_fan_automation:
    name: Ceiling Fan Automation
    icon: mdi:fan
    #OPTION initial: true

#######################################################################################################################
## HVAC Fan Control
#######################################################################################################################
  hvac_fan_control:
    name: HVAC Fan Control
    icon: mdi:fan
    
#######################################################################################################################
## Vent Fan Automation
#######################################################################################################################
  vent_fan_automation:
    name: Vent Fan Automation
    icon: mdi:fan
    #OPTION initial: true

#######################################################################################################################
## Climate Fan Schedule
#######################################################################################################################
  climate_fan_schedule:
    name: Climate Fan Schedule
    icon: mdi:clock-check
    
input_number:
#######################################################################################################################
## Climate Fan Schedule Interval
#######################################################################################################################
  climate_fan_schedule_interval:
    name: Interval
    icon: mdi:clock-in
    min: 15
    max: 60
    step: 5
    unit_of_measurement: min

#######################################################################################################################
## Climate Fan Schedule Duration
#######################################################################################################################
  climate_fan_schedule_duration:
    name: Duration
    icon: mdi:clock-out
    min: 5
    max: 60
    step: 5
    unit_of_measurement: min

#######################################################################################################################
## Bathroom Temperature Differential
#######################################################################################################################
  bathroom_temperature_differential:
    name: Bathroom Temperature Differential
    icon: mdi:thermostat
    min: 1
    max: 20
    step: 1
    unit_of_measurement: 'Â°F'

#######################################################################################################################
## Bathroom Humidity Fan Threshold
#######################################################################################################################
  bathroom_humidity_fan_threshold:
    name: Bathroom Humidity Threshold
    icon: mdi:water-percent
    min: 1
    max: 100
    step: 1
    unit_of_measurement: '%'

group:
#######################################################################################################################
## Ceiling Fans
#######################################################################################################################
  ceiling_fans:
    icon: mdi:fan
    all: true
    entities: !include /config/include/entities/ceiling_fan_entities.yaml

#######################################################################################################################
## Ceiling Fan - In Use Timers
#######################################################################################################################
  ceiling_fan_in_use_timers:
    icon: mdi:timer-outline
    all: true
    entities: !include /config/include/entities/ceiling_fan_timer_entities.yaml

#######################################################################################################################
## Ceiling Fan - In Use Automations
#######################################################################################################################
  ceiling_fan_in_use_automations:
    icon: mdi:fan
    entities:
      - automation.ceiling_fan_upstairs_bedroom_fan_in_use
      - automation.ceiling_fan_office_fan_in_use

#######################################################################################################################
## Vent Fans
#######################################################################################################################
  vent_fans:
    icon: mdi:fan
    all: true
    entities:
      !include /config/include/entities/vent_fan_entities.yaml

#######################################################################################################################
## Vent Fan - In Use Timers
#######################################################################################################################
  vent_fan_in_use_timers:
    icon: mdi:timer-outline
    all: true
    entities:
      !include /config/include/entities/vent_fan_timer_entities.yaml

#######################################################################################################################
## Vent Fan - In Use Automations
#######################################################################################################################
  vent_fan_in_use_automations:
    icon: mdi:fan
    entities:
      - automation.vent_fan_upstairs_bathroom_fan_in_use

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Ceiling Fans On
#######################################################################################################################
      ceiling_fans_on:
        friendly_name: Ceiling Fans On
        unique_id: ceiling_fans_on
        icon_template: mdi:fan
        value_template: "{{ expand('group.ceiling_fans')|selectattr('state','eq','on')|list|count > 0 }}"

#######################################################################################################################
## Ceiling Fan In Use
#######################################################################################################################
      ceiling_fan_in_use:
        friendly_name: Ceiling Fan In Use
        unique_id: ceiling_fan_in_use
        icon_template: mdi:fan
        value_template: "{{ expand('group.ceiling_fan_in_use_timers')|selectattr('state','eq','active')|list|count > 0 }}"

#######################################################################################################################
## Vent Fans On
## used for lovelace fold entity
#######################################################################################################################
      vent_fans_on:
        friendly_name: Vent Fan On
        unique_id: vent_fans_on
        icon_template: mdi:fan
        value_template: "{{ expand('group.vent_fans')|selectattr('state','eq','on')|list|count > 0 }}"

#######################################################################################################################
## Vent Fan In Use State
## used for lovelace fold entity
#######################################################################################################################
      vent_fan_in_use:
        friendly_name: Vent Fan In Use Timers
        unique_id: vent_fan_in_use
        icon_template: mdi:light-switch
        value_template: "{{ expand('group.vent_fan_in_use_timers')|selectattr('state','eq','active')|list|count > 0 }}"

#######################################################################################################################
## Upstairs Bathroom Humidity Fan
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
      upstairs_bathroom_humidity_fan:
        friendly_name: Upstairs Bath Humidity Fan
        unique_id: upstairs_bathroom_humidity_fan
        icon_template: mdi:water
        device_class: moisture
        delay_off:
          minutes: 5
        value_template: "{{ states('sensor.upstairs_bathroom_humidity')|int > states('input_number.bathroom_humidity_fan_threshold')|int }}"

#######################################################################################################################
## Upstairs Bathroom Fan
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
      upstairs_bathroom_mold_fan:
        friendly_name: Upstairs Bath Mold Fan
        unique_id: upstairs_bathroom_mold_fan
        icon_template: mdi:mushroom
        device_class: moisture
        delay_off:
          minutes: 5
        value_template: "{{ states('sensor.upstairs_bathroom_mold_indicator')|int > states('input_number.mold_risk_threshold')|int }}"

#######################################################################################################################
## Upstairs Bathroom Temperature Fan
## - uses absolute value so we can use temp above or below (negative value)
## - adjusts for seasons - doesn't run if outside is colder than inside, vice versa for warmer outside
## - bathroom colder than thermostat temp diff, colder outside than thermostat - on
## - bathroom warmer than thermostat temp diff, warmer outside than thermostat - on
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
      upstairs_bathroom_temperature_fan:
        friendly_name: Upstairs Bath Temp Fan
        unique_id: upstairs_bathroom_temperature_fan
        icon_template: mdi:thermometer-lines
        device_class: heat
        delay_off:
          minutes: 5
        value_template: >
          {% set tempdiff = (states('sensor.upstairs_bathroom_temperature')|int - states('sensor.upstairs_thermostat_temperature')|int|abs) %}
          {{ is_state('binary_sensor.alerts_enabled','on')
               and ((states('sensor.upstairs_bathroom_temperature')|int > states('input_number.high_temperature_threshold')|int)
                 or (states('sensor.upstairs_bathroom_temperature')|int < states('input_number.low_temperature_threshold')|int)
                 or (states('sensor.upstairs_bathroom_temperature')|int < states('sensor.upstairs_thermostat_temperature')|int
                      and states('sensor.dark_sky_temperature')|int < states('sensor.upstairs_thermostat_temperature')|int
                      and tempdiff >= states('input_number.bathroom_temperature_differential')|int)
                 or (states('sensor.upstairs_bathroom_temperature')|int > states('sensor.upstairs_thermostat_temperature')|int
                      and states('sensor.dark_sky_temperature')|int > states('sensor.upstairs_thermostat_temperature')|int
                      and tempdiff >= states('input_number.bathroom_temperature_differential')|int)) }}


