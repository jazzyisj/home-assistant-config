###############################################################################
## Package - Weather
###############################################################################
homeassistant:
  customize:
    alert.outdoor_high_temperature:
      friendly_name: 'Outdoor High Temp'
      icon: mdi:thermometer-alert
      category: weather
    alert.outdoor_low_temperature:
      friendly_name: 'Outdoor Low Temp'
      icon: mdi:snowflake-alert
      category: weather
    alert.storm_approaching:
      friendl_name: 'Storm Near'
      icon: mdi:weather-partly-lightning
      category: weather
    alert.strong_wind:
      friendly_name: 'Strong Wind'
      icon: mdi:weather-windy
      category: weather
    alert.uv_risk:
      friendly_name: 'UV Risk'
      icon: mdi:weather-sunny-alert
      category: weather
    sensor.climacell_fire_index:
      icon: mdi:fire

weather:
  - platform: template
    name: 'Windsor'
    unique_id: windsor_current
    condition_template: "{{ states('sensor.current_condition') }}"
    temperature_template: "{{ states('sensor.outdoor_temperature')|float(0) }}"
    humidity_template: "{{ states('sensor.outdoor_humidity')|float(0) }}"
    pressure_template: "{{ states('sensor.barometric_pressure')|float(0) }}"
    wind_speed_template: "{{ states('sensor.wind_speed')|float(0) }}"
    wind_bearing_template: "{{ states('sensor.wind_bearing')|float(0) }}"
    visibility_template: "{{ states('sensor.visibility')|float(0) }}"
    forecast_template: >
      {% if state_attr('weather.windsor','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.windsor','forecast') }}
      {% elif state_attr('weather.home','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.home','forecast') }}
      {% elif state_attr('weather.kdtw_daynight','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.kdtw_daynight','forecast') }}
      {% elif state_attr('weather.climacell_daily','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.climacell_daily','forecast') }}
      {% endif %}
    attribution_template: 'Windsor'

input_boolean:
  weather_automation:
    name: 'Weather Automation'
    icon: mdi:sync-alert
  weather_alerts:
    name: 'Weather Alerts'
    icon: mdi:alert
  morning_weather_enabled:
    name: 'Morning Weather Report'
    icon: mdi:weather-partly-rainy
  display_gdacs_alerts:
    name: 'Display GDACS Alerts'
    icon: mdi:pulse

input_number:
  outdoor_high_temperature_threshold:
    name: 'High Temperature Threshold'
    icon: mdi:thermometer-lines
    min: 10
    max: 40
    step: 1
    unit_of_measurement: °C
  outdoor_low_temperature_threshold:
    name: 'Low Temperature Threshold'
    icon: mdi:snowflake-alert
    min: -20
    max: 20
    step: 1
    unit_of_measurement: °C

binary_sensor: # https://www.home-assistant.io/integrations/trend/
  - platform: trend
    sensors:
      pressure_rising:
        friendly_name: 'Pressure Rising'
        entity_id: sensor.barometric_pressure

      pressure_falling:
        friendly_name: 'Pressure Falling'
        entity_id: sensor.barometric_pressure
        invert: true

      temperature_rising:
        friendly_name: 'Temperature Rising'
        entity_id: sensor.outdoor_temperature

      temperature_falling:
        friendly_name: 'Temperature Falling'
        entity_id: sensor.outdoor_temperature
        invert: true

sensor:
  - platform: season
    type: meteorological # astronomical

  - platform: moon

  - platform: statistics # min/max template sensors
    name: 'Outdoor Temperature: Daily'
    entity_id: sensor.outdoor_temperature
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Temperature: Annual'
    entity_id: sensor.outdoor_temperature
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000 #QUESTION is this right?  (15 min update = 100/day = 36,500)

  - platform: statistics
    name: 'Outdoor Humidity: Daily'
    entity_id: sensor.outdoor_humidity
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Humidity: Annual'
    entity_id: sensor.outdoor_humidity
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Barometric Pressure: Annual'
    entity_id: sensor.barometric_pressure
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Speed: Annual'
    entity_id: sensor.wind_speed
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Gust: Annual'
    entity_id: sensor.wind_gust
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Bearing: Annual'
    entity_id: sensor.wind_bearing
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Cloud Cover: Annual'
    entity_id: sensor.cloud_cover
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Rain Accumulation: Annual'
    entity_id: sensor.precipitation_yesterday_rain
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Rain Intensity: Annual'
    entity_id: sensor.precipitation_intensity
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

alert:
  outdoor_high_temperature:
    name: 'Outdoor High Temperature'
    title: 'Outdoor High Temperature Alert'
    message: "Outdoor Humidex: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_high_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_high_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret HIGH_TEMP_ICON
      actions:
        - action: pause_outdoor_high_temperature
          title: 'Pause Alert'

  outdoor_low_temperature:
    name: 'Outdoor Low Temperature'
    title: 'Outdoor Low Temperature Alert'
    message: "Outdoor Windchill Temperature: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_low_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_low_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret LOW_TEMP_ICON
      actions:
        - action: pause_outdoor_low_temperature
          title: 'Pause Alert'

  strong_wind:
    name: 'Strong Wind'
    title: 'Strong Wind Alert'
    message: |
      Wind Speed: {{ states('sensor.wind_speed') }}
      Wind Gust: {{ states('sensor.wind_gust') }}
    done_message: clear_notification
    entity_id: binary_sensor.strong_wind_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: strong_wind
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret LOW_TEMP_ICON #IMAGE
      actions:
        - action: pause_strong_wind
          title: 'Pause Alert'

  storm_approaching:
    name: 'Storm Approaching'
    title: 'Storm Approaching'
    message: > #DARKSKY
      {%- set dir = states('sensor.storm_full_direction') %}
      {%- set dist = states('sensor.nearest_storm_distance')|float('unknown') %}
      {% if is_number(dist) %}
        There is a {{ states('sensor.precipitation_type') }} storm
        {%- if dist >= 1 %} {{ dist|int(0) }} {{ 'kilometer' if dist|int(0) == 1 else 'kilometers' }} away
        {%- if not dir|lower in ['unknown','unavailable','none'] %}, approaching from the {{ dir }} {% endif -%}.
        {%- else %} in the immediate vicinity.
        {%- endif %}
      {% endif %}
      The current forecast is {{ states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than')|lower }}
    done_message: clear_notification
    entity_id: binary_sensor.storm_approaching_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: storm_approaching
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret STORM_ICON
      actions:
        - action: pause_storm_approaching
          title: 'Pause Alert'
