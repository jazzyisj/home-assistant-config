###############################################################################
## Package - Weather
###############################################################################
homeassistant:
  customize:
    alert.outdoor_high_temperature:
      icon: mdi:thermometer-alert
      category: weather

    alert.outdoor_low_temperature:
      icon: mdi:snowflake-alert
      category: weather

    alert.storm_approaching:
      icon: mdi:weather-partly-lightning
      category: weather

    alert.strong_wind:
      icon: mdi:weather-windy
      category: weather

    alert.uv_risk:
      icon: mdi:weather-sunny-alert
      category: weather

    alert.tomorrow_io_connected:
      icon: mdi:weather-partly-rainy
      category: weather

    sensor.tomorrow_io_home_fire_index:
      icon: mdi:fire

weather:
  - platform: template
    name: 'Home Daily'
    unique_id: home_daily
    condition_template: "{{ states('sensor.current_condition') }}"
    temperature_template: "{{ states('sensor.outdoor_temperature')|float(0) }}"
    humidity_template: "{{ states('sensor.outdoor_humidity')|float(0) }}"
    pressure_template: "{{ states('sensor.barometric_pressure')|float(0) }}"
    wind_speed_template: "{{ states('sensor.wind_speed')|float(0) }}"
    wind_bearing_template: "{{ states('sensor.wind_bearing')|float(0) }}"
    visibility_template: "{{ states('sensor.visibility')|float(0) }}"
    forecast_template: >
      {% if state_attr('weather.weatherflow_day_based_forecast','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.weatherflow_day_based_forecast','forecast') }}
      {% elif state_attr('weather.windsor','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.windsor','forecast') }}
      {% endif %}
    attribution_template: >
      {% if state_attr('weather.weatherflow_day_based_forecast','forecast')|lower not in ['unknown','unavailable','none'] %}
        WeatherFlow
      {% elif state_attr('weather.windsor','forecast')|lower not in ['unknown','unavailable','none'] %}
        Environment Canada
      {% endif %}

  - platform: template
    name: 'Home Hourly'
    unique_id: home_hourly
    condition_template: "{{ states('sensor.current_condition') }}"
    temperature_template: "{{ states('sensor.outdoor_temperature')|float(0) }}"
    humidity_template: "{{ states('sensor.outdoor_humidity')|float(0) }}"
    pressure_template: "{{ states('sensor.barometric_pressure')|float(0) }}"
    wind_speed_template: "{{ states('sensor.wind_speed')|float(0) }}"
    wind_bearing_template: "{{ states('sensor.wind_bearing')|float(0) }}"
    visibility_template: "{{ states('sensor.visibility')|float(0) }}"
    forecast_template: >
      {% if state_attr('weather.weatherflow_hourly_based_forecast','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.weatherflow_hourly_based_forecast','forecast') }}
      {% elif state_attr('weather.windsor_hourly','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.windsor_hourly','forecast') }}
      {% endif %}
    attribution_template: >
      {% if state_attr('weather.weatherflow_hourly_based_forecast','forecast')|lower not in ['unknown','unavailable','none'] %}
        WeatherFlow
      {% elif state_attr('weather.windsor_hourly','forecast')|lower not in ['unknown','unavailable','none'] %}
        Environment Canada
      {% endif %}

input_boolean:
  weather_automation:
    name: 'Weather Automation'
    icon: mdi:sync-alert
  weather_alerts:
    name: 'Weather Alerts'
    icon: mdi:alert
  morning_weather_enabled:
    name: 'Morning Weather Report'
    icon: mdi:weather-partly-rainy
  display_gdacs:
    name: 'Display GDACS'
    icon: mdi:pulse

input_number:
  outdoor_high_temperature_threshold:
    name: 'High Temperature Threshold'
    icon: mdi:thermometer-lines
    min: 10
    max: 40
    step: 1
    unit_of_measurement: °C
  outdoor_low_temperature_threshold:
    name: 'Low Temperature Threshold'
    icon: mdi:snowflake-alert
    min: -20
    max: 20
    step: 1
    unit_of_measurement: °C

binary_sensor: # https://www.home-assistant.io/integrations/trend/
  - platform: trend
    sensors:
      pressure_rising:
        friendly_name: 'Pressure Rising'
        entity_id: sensor.barometric_pressure #WF
        min_gradient: 0.0027 # 10 hPa per hour - 10/3600
        sample_duration: 900
        max_samples: 60

      pressure_falling:
        friendly_name: 'Pressure Falling'
        entity_id: sensor.barometric_pressure
        invert: true
        min_gradient: 0.0027 # 10 hPa per hour - 10/3600
        sample_duration: 900
        max_samples: 60

      temperature_rising:
        friendly_name: 'Temperature Rising'
        entity_id: sensor.outdoor_temperature #WF
        min_gradient: 0.0005 # 2 degree per hour - 2/3600
        sample_duration: 900
        max_samples: 60

      temperature_falling:
        friendly_name: 'Temperature Falling'
        entity_id: sensor.outdoor_temperature
        invert: true
        min_gradient: 0.0005 # 2 degree per hour - 2/3600
        sample_duration: 900
        max_samples: 60

sensor:
  - platform: statistics
    name: 'Outdoor Temperature: Avg Daily'
    entity_id: sensor.outdoor_temperature
    state_characteristic: mean
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Temperature: Max Daily'
    entity_id: sensor.outdoor_temperature
    state_characteristic: value_max
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Temperature: Min Daily'
    entity_id: sensor.outdoor_temperature
    state_characteristic: value_min
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Temperature: Annual'
    entity_id: sensor.outdoor_temperature
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000 #QUESTION is this right?  (15 min update = 100/day = 36,500)

  - platform: statistics
    name: 'Outdoor Normal High Temperature Differential: Annual'
    entity_id: sensor.outdoor_high_temperature_differential
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000 #QUESTION is this right?  (15 min update = 100/day = 36,500)

  - platform: statistics
    name: 'Outdoor Normal Low Temperature Differential: Annual'
    entity_id: sensor.outdoor_low_temperature_differential
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000 #QUESTION is this right?  (15 min update = 100/day = 36,500)

  - platform: statistics
    name: 'Outdoor Humidity: Avg Daily'
    entity_id: sensor.outdoor_humidity
    state_characteristic: mean
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Humidity: Max Daily'
    entity_id: sensor.outdoor_humidity
    state_characteristic: value_max
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Humidity: Min Daily'
    entity_id: sensor.outdoor_humidity
    state_characteristic: value_min
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics
    name: 'Outdoor Humidity: Annual'
    entity_id: sensor.outdoor_humidity
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Barometric Pressure: Annual'
    entity_id: sensor.barometric_pressure
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Speed: Annual'
    entity_id: sensor.wind_speed
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Gust: Annual'
    entity_id: sensor.wind_gust
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Wind Bearing: Annual'
    entity_id: sensor.wind_bearing
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

  - platform: statistics
    name: 'Cloud Cover: Annual'
    entity_id: sensor.cloud_cover
    state_characteristic: mean
    max_age:
      days: 365
    precision: 1
    sampling_size: 50000

alert:
  outdoor_high_temperature:
    name: 'Outdoor High Temperature'
    title: 'High Temperature'
    message: "Humidex: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_high_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_high_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:thermometer-lines
      icon_url: !secret HIGH_TEMP_ICON
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: https://www.windy.com/-Temperature-temp?temp,42.169,-82.782,10
      actions:
        - action: pause_outdoor_high_temperature
          title: 'Pause Alert'

  outdoor_low_temperature:
    name: 'Outdoor Low Temperature'
    title: 'Low Temperature'
    message: "Windchill: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_low_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_low_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:snowflake-alert
      icon_url: !secret LOW_TEMP_ICON
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: https://www.windy.com/-Temperature-temp?temp,42.169,-82.782,10
      actions:
        - action: pause_outdoor_low_temperature
          title: 'Pause Alert'

  strong_wind:
    name: 'Strong Wind'
    title: 'Strong Wind'
    message: |
      Wind Speed: {{ states('sensor.wind_speed') }}
      Wind Gust: {{ states('sensor.wind_gust') }}
    done_message: clear_notification
    entity_id: binary_sensor.strong_wind_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: strong_wind
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:weather-windy
      icon_url: !secret WIND_ICON
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: https://www.windy.com/?42.169,-82.782,10
      actions:
        - action: pause_strong_wind
          title: 'Pause Alert'

  storm_approaching: #DARKSKY
    name: 'Storm Approaching'
    title: 'Storm Approaching'
    message: >
      {%- set dir = states('sensor.storm_full_direction') %}
      {%- set dist = states('sensor.nearest_storm_distance')|float('unknown') %}
      {% if is_number(dist) %}
        There is a {{ states('sensor.precipitation_type') }} storm
        {%- if dist >= 1 %} {{ dist|int(0) }} {{ 'kilometer' if dist|int(0) == 1 else 'kilometers' }} away
        {%- if not dir|lower in ['unknown','unavailable','none'] %}, approaching from the {{ dir }} {% endif -%}.
        {%- else %} in the immediate vicinity.
        {%- endif %}
      {% endif %}
      The current forecast is {{ states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than')|lower }}
    done_message: clear_notification
    entity_id: binary_sensor.storm_approaching_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: storm_approaching
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:weather-lightning-rainy
      icon_url: !secret STORM_ICON
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: https://www.windy.com/-Weather-radar-radar?radar,42.169,-82.782,10
      actions:
        - action: pause_storm_approaching
          title: 'Pause Alert'

  tomorrow_io_connected:
    name: 'Tomorrow.io Connected'
    entity_id: binary_sensor.tomorrow_io_connected_alert
    state: 'on'
    notifiers: log
    skip_first: false
    repeat: 999999
    data:
      tag: tomorrow_io_connected
