#######################################################################################################################
## Package - Weather
#######################################################################################################################
homeassistant:
  customize:
    alert.air_quality:
      friendly_name: Air Quality
      icon: mdi:smog
      category: weather
    alert.allergy_risk:
      friendly_name: Allergy Risk
      icon: mdi:flower
      category: weather
    alert.asthma_risk:
      friendly_name: Asthma Risk
      icon: mdi:lungs
      category: weather
    alert.flu_risk:
      friendly_name: Flu Risk
      icon: mdi:virus
      category: weather
    alert.outdoor_high_temperature:
      friendly_name: Outdoor High Temp
      icon: mdi:thermometer-alert
      category: weather
    alert.outdoor_low_temperature:
      friendly_name: Outdoor Low Temp
      icon: mdi:snowflake-alert
      category: weather
    alert.storm_approaching:
      friendl_name: Storm Near
      icon: mdi:weather-partly-lightning
      category: weather
    alert.uv_risk:
      friendly_name: UV Risk
      icon: mdi:weather-sunny-alert
      category: weather

    binary_sensor.asthma_risk_alert:
      icon: mdi:lungs
    sensor.asthma_index_today:
      icon: mdi:lungs
    sensor.asthma_index_tomorrow:
      icon: mdi:lungs
    sensor.asthma_index_forecasted_avg:
      icon: mdi:lungs
    binary_sensor.allergy_risk_alert:
      icon: mdi:lungs
    sensor.allergy_index_today:
      icon: mdi:lungs
    sensor.allergy_index_tomorrow:
      icon: mdi:lungs
    sensor.allergy_index_forecasted_avg:
      icon: mdi:lungs
    sensor.cold_flu_index_today:
      icon: mdi:virus

    sensor.climacell_fire_index:
      icon: mdi:fire

    sensor.waqi_windsor:
      icon: mdi:smog

camera:
  - platform: generic
    name: Windsor Radar
    still_image_url: https://radar.weather.gov/Conus/Loop/centgrtlakes_loop.gif
    content_type: image/jpeg

  - platform: generic
    name: Windsor Metrogram
    still_image_url: https://www.yr.no/place/Canada/Ontario/Windsor/meteogram.png
    content_type: image/png

weather:
  - platform: template
    name: "Windsor"
    unique_id: windsor_current
    condition_template: "{{ states('sensor.current_condition') }}"
    temperature_template: "{{ states('sensor.outdoor_temperature')|int }}"
    humidity_template: "{{ states('sensor.outdoor_humidity')|int }}"
    pressure_template: "{{ states('sensor.barometric_pressure')|int }}"
    wind_speed_template: "{{ states('sensor.wind_speed')|int }}"
    wind_bearing_template: "{{ states('sensor.wind_bearing')|int }}"
    visibility_template: "{{ states('sensor.visibility')|int }}"
    forecast_template: >
      {% if state_attr('weather.envcan_daily','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.envcan_daily','forecast') }}
      {% elif state_attr('weather.home','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.home','forecast') }}
      {% elif state_attr('weather.kdtw_daynight','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.kdtw_daynight','forecast') }}
      {% elif state_attr('weather.climacell_daily','forecast')|lower not in ['unknown','unavailable','none'] %}
        {{ state_attr('weather.climacell_daily','forecast') }}
      {% endif %}
    attribution_template: "jazzyisj"

input_boolean:
  weather_automation:
    name: Weather Automation
    icon: mdi:sync-alert

  weather_alerts:
    name: Weather Alerts
    icon: mdi:alert

  morning_weather_enabled:
    name: Morning Weather Report
    icon: mdi:weather-partly-rainy

input_number:
  outdoor_high_temperature_threshold:
    name: High Temperature Threshold
    icon: mdi:thermometer-lines
    min: 10
    max: 40
    step: 1
    unit_of_measurement: °C

  outdoor_low_temperature_threshold:
    name: Low Temperature Threshold
    icon: mdi:snowflake-alert
    min: -20
    max: 20
    step: 1
    unit_of_measurement: °C

binary_sensor: # https://www.home-assistant.io/integrations/trend/
  - platform: trend
    sensors:
      pressure_rising:
        friendly_name: Pressure Rising
        entity_id: sensor.barometric_pressure

      pressure_falling:
        friendly_name: Pressure Falling
        entity_id: sensor.barometric_pressure
        invert: true

      temperature_rising:
        friendly_name: Temperature Rising
        entity_id: sensor.outdoor_temperature

      temperature_falling:
        friendly_name: Temperature Falling
        entity_id: sensor.outdoor_temperature
        invert: true

sensor:
  - platform: season # https://www.home-assistant.io/integrations/season/

  - platform: moon # https://www.home-assistant.io/integrations/moon/

  - platform: waqi # https://www.home-assistant.io/components/sensor.waqi/  http://aqicn.org/
    token: !secret AQICN_APIKEY
    locations:
      - Windsor

  - platform: statistics
    entity_id: sensor.outdoor_temperature # for min/max template sensors
    name: "Outdoor Temperature: Daily"
    max_age:
      days: 1
    precision: 1
    sampling_size: 150

  - platform: statistics # https://www.home-assistant.io/components/sensor.statistics/
    entity_id: sensor.outdoor_temperature
    name: "Outdoor Temperature: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 150000 #TEST

  - platform: statistics
    entity_id: sensor.outdoor_humidity
    name: "Outdoor Humidity: Daily"
    max_age:
      days: 1
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.outdoor_humidity
    name: "Outdoor Humidity: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.barometric_pressure
    name: "Barometric Pressure: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.wind_speed
    name: "Wind Speed: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.wind_gust
    name: "Wind Gust: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.cloud_cover
    name: "Cloud Cover: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.precipitation_yesterday_rain # for daily max template sensor - graph
    name: "Rain Accumulation: Daily"
    max_age:
      days: 1
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.precipitation_yesterday_rain # for weekly total sensor
    name: "Rain Accumulation: Weekly"
    max_age:
      days: 7
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.precipitation_yesterday_rain # for max template sensor
    name: "Rain Accumulation: Annual"
    max_age:
      days: 365
    precision: 1
    sampling_size: 500

  - platform: statistics
    entity_id: sensor.precipitation_intensity # for daily max template sensor
    name: "Rain Intensity: Daily"
    max_age:
      days: 1
    precision: 1
    sampling_size: 500

alert:
  air_quality:
    name: Air Quality
    title: Air Quality Alert
    message: "Air Quality Risk Level: {{ states('sensor.aqi_risk_level') }}"
    done_message: clear_notification
    entity_id: binary_sensor.air_quality_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: air_quality
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret AQI_ICON
      actions:
        - action: pause_air_quality
          title: Pause Alert

  allergy_risk:
    name: Allergy Risk
    title: Allergy Risk Alert
    message: "Allergy Risk Risk Level: {{ states('sensor.allergy_risk_today') }}"
    done_message: clear_notification
    entity_id: binary_sensor.allergy_risk_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: allergy_risk
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret ALLERGY_ICON
      actions:
        - action: pause_allergy_risk
          title: Pause Alert

  asthma_risk:
    name: Asthma Risk
    title: Asthma Risk Alert
    message: "Asthma Risk Risk Level: {{ states('sensor.asthma_risk_today') }}"
    done_message: clear_notification
    entity_id: binary_sensor.asthma_risk_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: asthma_risk
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret ASTHMA_ICON
      actions:
        - action: pause_asthma_risk
          title: Pause Alert

  flu_risk:
    name: Flu Risk
    title: Flu Risk Alert
    message: "Flu Risk Risk Level: {{ states('sensor.cdc_level')|title }}"
    done_message: clear_notification
    entity_id: binary_sensor.flu_risk_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: flu_risk
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret ALLERGY_ICON
      actions:
        - action: pause_flu_risk
          title: Pause Alert

  outdoor_high_temperature:
    name: Outdoor High Temperature
    title: Outdoor High Temperature Alert
    message: "Outdoor Humidex: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_high_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_high_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret HIGH_TEMP_ICON
      actions:
        - action: pause_outdoor_high_temperature
          title: Pause Alert

  outdoor_low_temperature:
    name: Outdoor Low Temperature
    title: Outdoor Low Temperature Alert
    message: "Outdoor Windchill Temperature: {{ states('sensor.outdoor_apparent_temperature') }}"
    done_message: clear_notification
    entity_id: binary_sensor.outdoor_low_temperature_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: outdoor_low_temperature
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret LOW_TEMP_ICON
      actions:
        - action: pause_outdoor_low_temperature
          title: Pause Alert

  storm_approaching:
    name: Storm Approaching
    title: Storm Approaching
    message: > #DARKSKY
      {%- set dir = states('sensor.storm_full_cardinal_direction') %}
      {%- set dist = states('sensor.dark_sky_nearest_storm_distance') %}
      There is a {{ states('sensor.precipitation_type') }} storm
      {%- if dist|float >= 1 %} {{ dist|int }} {{ 'kilometer' if dist|int == 1 else 'kilometers' }} away
      {%- if not dir|lower in ['unknown','unavailable','none'] %}, approaching from the {{ dir }} {% endif -%}.
      {%- else %} in the immediate vicinity.
      {%- endif %}
      The current forecast is {{ states('sensor.dark_sky_minutely_summary')|replace('<',' less than ')|replace('>','greater than')|lower }}

    done_message: clear_notification
    entity_id: binary_sensor.storm_approaching_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: storm_approaching
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret STORM_ICON
      actions:
        - action: pause_storm_approaching
          title: Pause Alert

  uv_risk:
    name: UV Risk
    title: UV Risk Alert
    message: "UV Risk: {{ states('sensor.uv_risk_today') }}"
    done_message: clear_notification
    entity_id: binary_sensor.uv_risk_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: uv_risk
      group: General
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/weather
      color: !secret WARNING_COLOR
      icon_url: !secret UV_ICON
      actions:
        - action: pause_uv_risk
          title: Pause Alert
