#######################################################################################################################
## Google Traffic Sensor Package
#######################################################################################################################
homeassistant:
  customize:
    alert.traffic_leave_home_jason:
      icon: mdi:car-arrow-right
      category: commute
    alert.traffic_leave_home_sheri:
      icon: mdi:car-arrow-right
      category: commute
    alert.traffic_work_commute_sheri:
      icon: mdi:car-multiple
      category: commute
    alert.traffic_work_commute_jason:
      icon: mdi:car-multiple
      category: commute
    alert.traffic_home_commute_jason:
      icon: mdi:car-multiple
      category: commute
    alert.traffic_home_commute_sheri:
      icon: mdi:car-multiple
      category: commute

    sensor.jason_time_to_home:
      friendly_name: Time To Home
      icon: mdi:timer-outline
    sensor.sheri_time_to_home:
      friendly_name: Time To Home
      icon: mdi:timer-outline
    sensor.jason_time_to_work:
      friendly_name: Time To Work
      icon: mdi:timer-outline
    sensor.sheri_time_to_work:
      friendly_name: Time To Work
      icon: mdi:timer-outline

#######################################################################################################################
## Traffic Cameras
## http://www.mto.gov.on.ca/english/traveller/compass/camera/windsor-camhome1.shtml
#######################################################################################################################
camera:
  - platform: generic
    name: 'EC ROW BANWELL'
    still_image_url: !secret TRAFFIC_CAM1_URL

  - platform: generic
    name: 'EC ROW LAUZON PARKWAY'
    still_image_url: !secret TRAFFIC_CAM2_URL

  - platform: generic
    name: 'EC ROW JEFFERSON'
    still_image_url: !secret TRAFFIC_CAM3_URL

  - platform: generic
    name: 'EC ROW CENTRAL'
    still_image_url: !secret TRAFFIC_CAM4_URL

  - platform: generic
    name: 'EC ROW WALKER'
    still_image_url: !secret TRAFFIC_CAM5_URL

  - platform: generic
    name: 'EC ROW HOWARD'
    still_image_url: !secret TRAFFIC_CAM6_URL

  - platform: generic
    name: 'TECUMSEH CENTRAL'
    still_image_url: !secret TRAFFIC_CAM7_URL

  - platform: generic
    name: 'TECUMSEH DROUILLARD'
    still_image_url: !secret TRAFFIC_CAM8_URL

  - platform: generic
    name: 'TECUMSEH WALKER'
    still_image_url: !secret TRAFFIC_CAM9_URL

  - platform: generic
    name: 'TECUMSEH HALL'
    still_image_url: !secret TRAFFIC_CAM10_URL

  - platform: generic
    name: 'TECUMSEH HOWARD'
    still_image_url: !secret TRAFFIC_CAM11_URL

  - platform: generic
    name: 'TECUMSEH OUELLETTE'
    still_image_url: !secret TRAFFIC_CAM12_URL

input_boolean:
#######################################################################################################################
## Commute Alerts - used to enabled work commute alerts
#######################################################################################################################
  commute_alerts:
    name: Commute Alerts
    icon: mdi:car-multiple

input_number:
#######################################################################################################################
## Commute Warning Threshold
#######################################################################################################################
  commute_warning_threshold:
    name: Commute Warning
    icon: mdi:car
    min: 0
    max: 60
    step: 1
    unit_of_measurement: min

#######################################################################################################################
## Commute Predeparture Time
#######################################################################################################################
  commute_predeparture:
    name: Commute Predeparture Time
    icon: mdi:clock-start
    min: 0
    max: 60
    step: 5
    unit_of_measurement: min

input_datetime:
#######################################################################################################################
## Days Leave Work Time
#######################################################################################################################
  days_leave_work_time:
    name: Days Leave Work
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Days Arrive Home Time
#######################################################################################################################
  days_arrive_home_time:
    name: Days Arrive Home
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Days Leave Home Time
#######################################################################################################################
  days_leave_home_time:
    name: Days Leave Home
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Days Arrive Work Time
#######################################################################################################################
  days_arrive_work_time:
    name: Days Arrive Work
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Afternoons Leave Work Time
#######################################################################################################################
  afternoons_leave_work_time:
    name: Afternoons Leave Work
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Afternoons Arrive Home Time
#######################################################################################################################
  afternoons_arrive_home_time:
    name: Afternoons Arrive Home
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Afternoons Leave Home Time
#######################################################################################################################
  afternoons_leave_home_time:
    name: Afternoons Leave Home
    icon: mdi:clock
    has_date: false
    has_time: true

#######################################################################################################################
## Afternoons Arrive Work Time
#######################################################################################################################
  afternoons_arrive_work_time:
    name: Afternoons Arrive Work
    icon: mdi:clock
    has_date: false
    has_time: true

sensor:
#######################################################################################################################
## Jason Time To Work Sensor
## https://www.home-assistant.io/components/sensor.google_travel_time/
## - tracking entity to entity
## - normally update once an hour, automation to increase update schedule during commutes
#######################################################################################################################
  - platform: google_travel_time
    name: Jason Time To Work
    api_key: !secret GMAP_API
    origin: person.jason
    destination: zone.work
    scan_interval: 3600
    options:
      mode: driving

#######################################################################################################################
## Sheri Time To Work Sensor
## https://www.home-assistant.io/components/sensor.google_travel_time/
## - tracking entity to entity
## - normally update once an hour, automation to increase update schedule during commutes
#######################################################################################################################
  - platform: google_travel_time
    name: Sheri Time To Work
    api_key: !secret GMAP_API
    origin: person.sheri
    destination: zone.work
    scan_interval: 3600
    options:
      mode: driving

#######################################################################################################################
## Jason Time To Home Sensor
## - tracking entity to entity
## - normally update every 5 minutes, automation to increase update schedule during commutes
#######################################################################################################################
  - platform: google_travel_time
    name: Jason Time To Home
    api_key: !secret GMAP_API
    origin: person.jason
    destination: zone.home
    scan_interval: 3600
    options:
      mode: driving

#######################################################################################################################
## Sheri Time To Home Sensor
## - tracking entity to entity
## - normally update every 5 minutes, automation to increase update schedule during commutes
#######################################################################################################################
  - platform: google_travel_time
    name: Sheri Time To Home
    api_key: !secret GMAP_API
    origin: person.sheri
    destination: zone.home
    scan_interval: 3600
    options:
      mode: driving

  - platform: template
    sensors:
#######################################################################################################################
## Leave Home Time
## - defaults to days if shift unknown or none
## - abs(time to work - commute threshold) if work commute alert on
#######################################################################################################################
      leave_home_time_jason:
        unique_id: leave_home_time_jason
        value_template: >
          {% set leave_ts = as_timestamp(states('sensor.date') ~ ' ' ~ (states('input_datetime.afternoons_leave_home_time')[0:5]
              if is_state('sensor.current_shift','Afternoons') else states('input_datetime.days_leave_home_time')[0:5])) %}
          {% set add_sec = (states('sensor.jason_time_to_work')|int - states('input_number.commute_warning_threshold')|int)|abs * 60
              if is_state('binary_sensor.work_commute_jason_alert','on') else 0 %}
          {{ (leave_ts - add_sec)|timestamp_custom('%H:%M',true) }}

      leave_home_time_sheri:
        unique_id: leave_home_time_sheri
        value_template: >
          {% set leave_ts = as_timestamp(states('sensor.date') ~ ' ' ~ (states('input_datetime.afternoons_leave_home_time')[0:5]
              if is_state('sensor.current_shift','Afternoons') else states('input_datetime.days_leave_home_time')[0:5])) %}
          {% set add_sec = (states('sensor.sheri_time_to_work')|int - states('input_number.commute_warning_threshold')|int)|abs * 60
              if is_state('binary_sensor.work_commute_sheri_alert','on') else 0 %}
          {{ (leave_ts - add_sec)|timestamp_custom('%H:%M',true) }}

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Traffic Sensor Connection
#######################################################################################################################
      google_traffic_connected:
        friendly_name: Traffic Sensor
        unique_id: google_traffic_connected
        icon_template: "{{ 'mdi:car-connected' if is_state('binary_sensor.google_traffic_connected','on') else 'mdi:alert-circle' }}"
        device_class: connectivity
        value_template: >
          {{ not(states('sensor.jason_time_to_home')|lower in ['unknown','unavailable','none']
            and states('sensor.sheri_time_to_home')|lower in ['unknown','unavailable','none']
            and states('sensor.jason_time_to_work')|lower in ['unknown','unavailable','none']
            and states('sensor.sheri_time_to_work')|lower in ['unknown','unavailable','none']) }}

      google_traffic_connected_alert:
        friendly_name: Google Traffic
        unique_id: google_traffic_connected_alert
        icon_template: mdi:car-off
        value_template: "{{ is_state('binary_sensor.google_traffic_connected','off') }}"

#######################################################################################################################
## Leave Home Alert
## - stops 15 min after leave home time
## - defaults to days if shift unknown or none
#######################################################################################################################
      leave_home_jason_alert:
        unique_id: leave_home_jason_alert
        value_template: >
          {% set leave_ts = as_timestamp(states('sensor.date') ~ ' ' ~ (states('input_datetime.afternoons_leave_home_time')[0:5]
              if is_state('sensor.current_shift','Afternoons') else states('input_datetime.days_leave_home_time')[0:5])) %}
          {% set end_time = (leave_ts + 900)|timestamp_custom('%H:%M',true) %}

          {{ is_state('binary_sensor.google_traffic_connected','on')
              and is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.commute_alerts','on')
              and is_state('binary_sensor.work_commute_active','on')
              and is_state('binary_sensor.jason_home','on')
              and states('sensor.time') > states('sensor.leave_home_time_jason')
              and states('sensor.time') < end_time }}

      leave_home_sheri_alert:
        unique_id: leave_home_sheri_alert
        value_template: >
          {% set leave_ts = as_timestamp(states('sensor.date') ~ ' ' ~ (states('input_datetime.afternoons_leave_home_time')[0:5]
              if is_state('sensor.current_shift','Afternoons') else states('input_datetime.days_leave_home_time')[0:5])) %}
          {% set end_time = (leave_ts + 900)|timestamp_custom('%H:%M',true) %}

          {{ is_state('binary_sensor.google_traffic_connected','on')
              and is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.commute_alerts','on')
              and is_state('binary_sensor.work_commute_active','on')
              and is_state('binary_sensor.jason_home','on')
              and states('sensor.time') > states('sensor.leave_home_time_sheri')
              and states('sensor.time') < end_time }}

#######################################################################################################################
## Work Commute
## - defaults to days if shift unknown or none
#######################################################################################################################
      work_commute_jason_alert:
        unique_id: work_commute_jason_alert
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.commute_alerts','on')
              and is_state('binary_sensor.work_commute_active','on')
              and is_state('binary_sensor.jason_home','on')
              and not is_state('person.jason','Work')
              and (states('sensor.jason_time_to_work')|int >= states('input_number.commute_warning_threshold')|int) }}

      work_commute_sheri_alert:
        unique_id: work_commute_sheri_alert
        delay_on:
          seconds: 30
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.commute_alerts','on')
              and is_state('binary_sensor.work_commute_active','on')
              and is_state('binary_sensor.sheri_home','on')
              and not is_state('person.sheri','Work')
              and (states('sensor.sheri_time_to_work')|int >= states('input_number.commute_warning_threshold')|int) }}

#######################################################################################################################
## Home Commute
## - defaults to days if shift unknown or none
#######################################################################################################################
      home_commute_jason_alert:
        unique_id: home_commute_jason_alert
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
              and is_state('input_boolean.commute_alerts','on')
              and is_state('binary_sensor.home_commute_active','on')
              and is_state('binary_sensor.jason_home','off')
              and (states('sensor.jason_time_to_home')|int >= states('input_number.commute_warning_threshold')|int) }}

      home_commute_sheri_alert:
        unique_id: home_commute_sheri_alert
        value_template: >
          {{ is_state('binary_sensor.alerts_enabled','on')
            and is_state('input_boolean.commute_alerts','on')
            and is_state('binary_sensor.home_commute_active','on')
            and is_state('binary_sensor.sheri_home','off')
            and (states('sensor.sheri_time_to_home')|int >= states('input_number.commute_warning_threshold')|int) }}

#######################################################################################################################
## Commute Active
## - used to display conditional commute card
#######################################################################################################################
      commute_active:
        friendly_name: Commute Active
        unique_id: commute_active
        icon_template: mdi:car
        value_template: "{{ is_state('binary_sensor.work_commute_active','on') or is_state('binary_sensor.home_commute_active','on') }}"

#######################################################################################################################
## Work Commute Active
## - used to display conditional commute card, update traffic sensors
## - defaults to days if shift unknown or none
#######################################################################################################################
      work_commute_active:
        friendly_name: Work Commute
        unique_id: work_commute_active
        icon_template: mdi:car
        value_template: "{{ is_state('binary_sensor.days_work_commute','on') or is_state('binary_sensor.afternoons_work_commute','on') }}"

#######################################################################################################################
## Home Commute Active
## - used to display conditional commute card, update traffic sensors
## - defaults to days if shift unknown or none
#######################################################################################################################
      home_commute_active:
        friendly_name: Home Commute
        unique_id: home_commute_active
        icon_template: mdi:car
        value_template: "{{ is_state('binary_sensor.days_home_commute','on') or is_state('binary_sensor.afternoons_home_commute','on') }}"

#######################################################################################################################
## Days Work Commute Time
## - checks for arrive home/work time after midnight,
## - defaults to days if shift unknown or none
#######################################################################################################################
      days_work_commute:
        friendly_name: Days Work
        unique_id: days_work_commute
        icon_template: mdi:car
        value_template: >
          {% set time = states('sensor.time') %}
          {% set leave = states('input_datetime.days_leave_home_time')[0:5] %}
          {% set arrive = states('input_datetime.days_arrive_work_time')[0:5] %}
          {% set predep = states('input_number.commute_predeparture')|int * 60 %}
          {% set start = (as_timestamp(states('sensor.date') ~ ' ' ~ leave)|float - predep)|timestamp_custom('%H:%M',true) %}
          {% if is_state('binary_sensor.work_today','on') and states('sensor.current_shift') in ['Off','Days','unknown','unavailable','none'] %}
            {{ true if time > start or time < arrive if arrive < start else arrive > time > start }}
          {% else %} false
          {% endif %}

#######################################################################################################################
## Afternoons Work Commute Time
## - checks for arrive home/work time after midnight,
## - defaults to days if shift unknown or none
#######################################################################################################################
      afternoons_work_commute:
        friendly_name: Afternoons Work
        unique_id: afternoons_work_commute
        icon_template: mdi:car
        value_template: >
          {% set time = states('sensor.time') %}
          {% set leave = states('input_datetime.afternoons_leave_home_time')[0:5] %}
          {% set arrive = states('input_datetime.afternoons_arrive_work_time')[0:5] %}
          {% set predep = states('input_number.commute_predeparture')|int * 60 %}
          {% set start = (as_timestamp(states('sensor.date') ~ ' ' ~ leave)|float - predep)|timestamp_custom('%H:%M',true) %}
          {% if is_state('binary_sensor.work_today','on') and is_state('sensor.current_shift','Afternoons') %}
            {{ true if time > start or time < arrive if arrive < start else arrive > time > start }}
          {% else %} false
          {% endif %}

#######################################################################################################################
## Days Home Commute Time
## - checks for arrive home/work time after midnight,
## - defaults to days if shift unknown or none
#######################################################################################################################
      days_home_commute:
        friendly_name: Days Home
        unique_id: days_home_commute
        icon_template: mdi:car
        value_template: >
          {% set time = states('sensor.time') %}
          {% set leave = states('input_datetime.days_leave_work_time')[0:5] %}
          {% set arrive = states('input_datetime.days_arrive_home_time')[0:5] %}
          {% set predep = states('input_number.commute_predeparture')|int * 60 %}
          {% set start = (as_timestamp(states('sensor.date') ~ ' ' ~ leave)|float - predep)|timestamp_custom('%H:%M',true) %}
          {% if is_state('binary_sensor.work_today','on') and states('sensor.current_shift') in ['Off','Days','unknown','unavailable','none'] %}
            {{ true if time > start or time < arrive if arrive < start else arrive > time > start }}
          {% else %} false
          {% endif %}

#######################################################################################################################
## Afternoons Home Commute Time
## - checks for arrive home/work time after midnight,
## - defaults to days if shift unknown or none
## - disabled mondays before leave home time to avoid false on state (workday on = true after sunday midnight)
#ISSUE turns off at midnight last workday of week when work_today turns off
#######################################################################################################################
      afternoons_home_commute:
        friendly_name: Afternoons Home
        unique_id: afternoons_home_commute
        icon_template: mdi:car
        value_template: >
          {% set time = states('sensor.time') %}
          {% set leave = states('input_datetime.afternoons_leave_work_time')[0:5] %}
          {% set arrive = states('input_datetime.afternoons_arrive_home_time')[0:5] %}
          {% set predep = states('input_number.commute_predeparture')|int * 60 %}
          {% set start = (as_timestamp(states('sensor.date') ~ ' ' ~ leave)|float - predep)|timestamp_custom('%H:%M',true) %}
          {% if is_state('binary_sensor.work_today','on')
              and is_state('sensor.current_shift','Afternoons')
              and (time > leave if now().weekday() == 0 else true) %}
            {{ true if time > start  or time < arrive if arrive < start else arrive > time > start }}
          {% else %} false
          {% endif %}

alert:
#######################################################################################################################
## Alert - Leave Home Jason
#######################################################################################################################
  traffic_leave_home_jason:
    name: "Leave Home Jason"
    title: "Leave Home Jason Alert"
    message: "You might be late for work, you should have left the house by now!"
    entity_id: binary_sensor.leave_home_jason_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: leave_home_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_leave_home_jason
          title: Pause
        - action: close_leave_home_jason
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

#######################################################################################################################
## Alert - Leave Home Sheri
#######################################################################################################################
  traffic_leave_home_sheri:
    name: "Leave Home Sheri"
    title: "Leave Home Sheri Alert"
    message: "You might be late for work, you should have left the house by now!"
    entity_id: binary_sensor.leave_home_sheri_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: sheri
    data:
      tag: leave_home_sheri
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_leave_home_sheri
          title: Pause
        - action: close_leave_home_sheri
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

#######################################################################################################################
## Alert - Work Commute Jason
#######################################################################################################################
  traffic_work_commute_jason:
    name: "Work Commute Jason"
    title: "Work Commute Jason Alert"
    message: >
      Leave for work before {{ states('sensor.leave_home_time_jason') }} today.
      Your current commute time to work is {{ state_attr('sensor.jason_time_to_work','duration_in_traffic')
        if not states('sensor.jason_time_to_work') == 'unknown' else 'expected to be longer than usual'}}.
    entity_id: binary_sensor.work_commute_jason_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: work_commute_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_work_commute_jason
          title: Pause
        - action: close_work_commute_jason
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

#######################################################################################################################
## Alert - Home Commute Jason
#######################################################################################################################
  traffic_home_commute_jason:
    name: "Home Commute Jason"
    title: "Home Commute Jason Alert"
    message: "Commute time is {{ state_attr('sensor.jason_time_to_home','duration_in_traffic') if not states('sensor.sheri_time_to_work') == 'unknown' else 'expected to be longer than usual' }}."
    entity_id: binary_sensor.home_commute_jason_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: jason
    data:
      tag: home_commute_jason
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_home_commute_jason
          title: Pause
        - action: close_home_commute_jason
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

#######################################################################################################################
## Alert - Work Commute Sheri
#######################################################################################################################
  traffic_work_commute_sheri:
    name: "Work Commute Sheri"
    title: "Work Commute Sheri Alert"
    message: "Commute time is {{ state_attr('sensor.sheri_time_to_work','duration_in_traffic') if not states('sensor.sheri_time_to_work')|lower in ['unknown','unavailable','none'] else 'expected to be longer than usual' }}"
    entity_id: binary_sensor.work_commute_sheri_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: sheri
    data:
      tag: work_commute_sheri
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_work_commute_sheri
          title: Pause
        - action: close_work_commute_sheri
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

#######################################################################################################################
## Alert - Home Commute Sheri
#######################################################################################################################
  traffic_home_commute_sheri:
    name: "Home Commute Sheri"
    title: "Home Commute Sheri Alert"
    message: "Commute time is {{ state_attr('sensor.sheri_time_to_home','duration_in_traffic') if not states('sensor.sheri_time_to_home')|lower in ['unknown','unavailable','none'] else 'expected to be longer than usual' }}."
    entity_id: binary_sensor.home_commute_sheri_alert
    state: 'on'
    repeat:
      - 5
      - 15
    can_acknowledge: true
    skip_first: false
    notifiers: sheri
    data:
      tag: home_commute_sheri
      group: General
      channel: Alert
      importance: high
      vibrationPattern: '200, 200, 200, 200, 200, 200, 200'
      ledColor: !secret WARNING_COLOR
      priority: high
      ttl: 0
      timeout: 600
      persistent: false
      sticky: false
      clickAction: /lovelace/schedule
      color: !secret NOTIFY_COLOR
      icon_url: !secret TRAFFIC_ICON
      image: !secret TRAFFIC_IMAGE
      actions:
        - action: pause_home_commute_sheri
          title: Pause
        - action: close_home_commute_sheri
          title: Close

      # additional parameters for html5 push
      timestamp: "{{ as_timestamp(now()) }}"
      renotify: true
      silent: true
      requireInteraction: false
      url: /lovelace/schedule
      icon: !secret TRAFFIC_ICON
      badge: !secret TRAFFIC_BADGE

script:
#######################################################################################################################
## Update All Traffic Sensors
#######################################################################################################################
  update_traffic_sensors:
    alias: "Update All Traffic Sensors"
    description: "Manually update all traffic sensors."
    mode: single
    max_exceeded: silent
    sequence:
      - service: homeassistant.update_entity
        data:
          entity_id:
            - sensor.jason_time_to_work
            - sensor.jason_time_to_home
            - sensor.sheri_time_to_work
            - sensor.sheri_time_to_home

      - service: browser_mod.toast
        data:
          duration: 30000
          message: "Traffic sensors have been updated."

automation:
#######################################################################################################################
## Traffic - Update Jason Time To Work
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_jason_time_to_work
    alias: "[Traffic] Update Jason Time To Work"
    description: "Increase update interval of sensor during commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/2'

    condition:
      - condition: state
        entity_id:
          - input_boolean.schedule_automation
          - binary_sensor.jphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.work_commute_active
        state: 'on'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: person.jason
            state: Work

          - condition: state
            entity_id: sensor.jason_time_to_work
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        entity_id: sensor.jason_time_to_work

#######################################################################################################################
## Traffic - Update Jason Time To Home
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_jason_time_to_home
    alias: "[Traffic] Update Jason Time To Home"
    description: "Increase update interval of sensor during commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/2'

    condition:
      - condition: state
        entity_id:
          - input_boolean.schedule_automation
          - binary_sensor.jphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.home_commute_active
        state: 'on'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: binary_sensor.jason_home
            state: 'on'

          - condition: state
            entity_id: sensor.jason_time_to_home
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        entity_id: sensor.jason_time_to_home

#######################################################################################################################
## Traffic - Update Jason Time To Home Not Home
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_jason_time_to_home_not_home
    alias: "[Traffic] Update Jason Time To Home Not Home"
    description: "Increase update interval of sensor when not home during non commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/5'

    condition:
      - condition: state
        entity_id:
          - input_boolean.schedule_automation
          - binary_sensor.jphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.home_commute_active
        state: 'off'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: binary_sensor.jason_home
            state: 'on'

          - condition: state
            entity_id: person.jason
            state: Work

          - condition: state
            entity_id: sensor.jason_time_to_home
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        entity_id: sensor.jason_time_to_home

#######################################################################################################################
## Traffic - Update Sheri Time To Work
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_sheri_time_to_work
    alias: "[Traffic] Update Sheri Time To Work"
    description: "Increase update interval of sensor during commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/2'

    condition:
      - condition: state
        entity_id:
         - input_boolean.schedule_automation
         - binary_sensor.sphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.work_commute_active
        state: 'on'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: person.sheri
            state: Work

          - condition: state
            entity_id: sensor.sheri_time_to_work
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.sheri_time_to_work

#######################################################################################################################
## Traffic - Update Sheri Time To Home
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_sheri_time_to_home
    alias: "[Traffic] Update Sheri Time To Home"
    description: "Increase update interval of sensor during commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/2'

    condition:
      - condition: state
        entity_id:
          - input_boolean.schedule_automation
          - binary_sensor.sphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.home_commute_active
        state: 'on'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: binary_sensor.sheri_home
            state: 'on'

          - condition: state
            entity_id: sensor.sheri_time_to_home
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.sheri_time_to_home

#######################################################################################################################
## Traffic - Update Sheri Time To Home Not Home
## - limit updates when not needed to avoid API charges
#######################################################################################################################
  - id: traffic_update_sheri_time_to_home_not_home
    alias: "[Traffic] Update Sheri Time To Home Not Home"
    description: "Increase update interval of sensor when not home during non commute times."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: time_pattern
        minutes: '/5'

    condition:
      - condition: state
        entity_id:
          - input_boolean.schedule_automation
          - binary_sensor.sphone_connected
        state: 'on'

      - condition: state
        entity_id: binary_sensor.home_commute_active
        state: 'off'

      - condition: not
        conditions:
          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: state
            entity_id: binary_sensor.sheri_home
            state: 'on'

          - condition: state
            entity_id: person.sheri
            state: Work

          - condition: state
            entity_id: sensor.sheri_time_to_home
            state:
              - unknown
              - unavailable
              - none

    action:
      - service: homeassistant.update_entity
        data:
          entity_id: sensor.sheri_time_to_home

#######################################################################################################################
## Traffic - Leave Home Jason Alert
#######################################################################################################################
  - id: traffic_leave_home_jason_alert
    alias: "[Traffic] Leave Home Jason Alert"
    description: "Play announcement when leave home alert turns on."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: alert.traffic_leave_home_jason
        to: 'on'

    condition:
      - condition: state
        entity_id: input_boolean.schedule_automation
        state: 'on'

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: |
                  Attention! Jason!
                  It is {{ as_timestamp(now())|timestamp_custom('%-I:%M %p',true) }}!
                  You should have already left for work!  Your current commute time to work is {{ state_attr('sensor.jason_time_to_work','duration_in_traffic')
                    if not states('sensor.jason_time_to_work') == 'unknown' else ' not currently available.'}}.
                quiet_play: true
                min_volume: "{{ 40 if states('sensor.tts_media_player') in state_attr('group.google_speaker_groups','entity_id') else 50 }}"

            # wait for alert to turned off/dismissed
            - wait_template: "{{ not is_state('alert.traffic_leave_home_jason','on') }}"
              timeout:
                minutes: 5

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.traffic_leave_home_jason
                  state: 'on'

#######################################################################################################################
## Traffic - Leave Home Sheri Alert
#######################################################################################################################
  - id: traffic_leave_home_sheri_alert
    alias: "[Traffic] Leave Home Sheri Alert"
    description: "Play announcement when alert turns on."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: alert.traffic_leave_home_sheri
        to: 'on'

    condition:
      - condition: state
        entity_id: input_boolean.schedule_automation
        state: 'on'

      # don't duplicate jason commute alert
      - condition: state
        entity_id: binary_sensor.leave_home_jason_alert
        state: 'off'

    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: |
                    Attention! Sheri!
                    It's {{ as_timestamp(now())|timestamp_custom('%-I:%M %p',true) }}!
                    You should have already left for work!  Your current commute time to work is {{ state_attr('sensor.jason_time_to_work','duration_in_traffic')
                      if not states('sensor.jason_time_to_work') == 'unknown' else ' unknown at this time.'}}.
                quiet_play: true
                min_volume: "{{ 40 if states('sensor.tts_media_player') in state_attr('group.google_speaker_groups','entity_id') else 50 }}"

            # wait for alert to turned off/dismissed
            - wait_template: "{{ not is_state('alert.traffic_leave_home_sheri','on') }}"
              timeout:
                minutes: 5

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.traffic_leave_home_sheri
                  state: 'on'

#######################################################################################################################
## Traffic - Work Commute Jason Alert
#######################################################################################################################
  - id: traffic_work_commute_jason_alert
    alias: "[Traffic] Work Commute Jason Alert"
    description: "Play announcement when alert turns on."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: alert.traffic_work_commute_jason
        to: 'on'

    condition:
      - condition: state
        entity_id: input_boolean.schedule_automation
        state: 'on'

    action:
      - repeat:
          sequence:
            - service: browser_mod.popup
              data:
                deviceID:
                  - browser_jlaptop_chrome_local
                  - browser_jlaptop_chrome_direct
                  - browser_jlaptop_chrome_nabucasa
                  - browser_jlaptop_chrome_duckdns
                  - browser_jwork_chrome_direct
                title: Commute Traffic
                large: true
                card: !include /config/lovelace/include/card/traffic_map.yaml

            - service: script.tts_play
              data:
                play_message: |
                  Attention!
                  Jason, you should leave for work before {{ states('sensor.leave_home_time_jason') }} today!
                  Your current commute time to work is {{ state_attr('sensor.jason_time_to_work','duration_in_traffic')
                    if not states('sensor.jason_time_to_work') == 'unknown' else 'expected to be longer than usual'}}.
                quiet_play: true
                min_volume: "{{ 50 if states('sensor.tts_media_player') in state_attr('group.google_speaker_groups','entity_id') else 70 }}"
            # wait for alert to turned off/dismissed
            - wait_template: "{{ not is_state('alert.traffic_work_commute_jason','on') }}"
              timeout:
                minutes: 5

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.traffic_work_commute_jason
                  state: 'on'

#######################################################################################################################
## Traffic - Work Commute Sheri Alert
#######################################################################################################################
  - id: traffic_work_commute_sheri_alert
    alias: "[Traffic] Work Commute Sheri Alert"
    description: "Play announcement when alert turns on."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: alert.traffic_work_commute_sheri
        to: 'on'

    condition:
      - condition: state
        entity_id: input_boolean.schedule_automation
        state: 'on'

      # don't duplicate jason commute alert
      - condition: state
        entity_id: binary_sensor.jason_home
        state: 'off'

    action:
      - repeat:
          sequence:
            - service: browser_mod.popup
              data:
                deviceID:
                  - browser_jlaptop_chrome_local
                  - browser_jlaptop_chrome_direct
                  - browser_jlaptop_chrome_nabucasa
                  - browser_jlaptop_chrome_duckdns
                  - browser_jwork_chrome_direct
                title: Commute Traffic
                large: true
                card: !include /config/lovelace/include/card/traffic_map.yaml

            - service: script.tts_play
              data:
                play_message: |
                  Attention!
                  Sheri, you should leave for work before {{ states('sensor.leave_home_time_sheri') }} today!
                  Your current commute time to work is {{ state_attr('sensor.sheri_time_to_work','duration_in_traffic')
                    if not states('sensor.sheri_time_to_work') == 'unknown' else 'expected to be longer than usual'}}.
                quiet_play: true
                min_volume: "{{ 50 if states('sensor.tts_media_player') in state_attr('group.google_speaker_groups','entity_id') else 70 }}"

            # wait for alert to turned off/dismissed
            - wait_template: "{{ not is_state('alert.traffic_work_commute_sheri','on') }}"
              timeout:
                minutes: 5

          until:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alert.traffic_work_commute_sheri
                  state: 'on'

#######################################################################################################################
## Traffic - Close Leave Home Jason Notifications
#######################################################################################################################
  - id: traffic_close_leave_home_jason_notifications
    alias: "[Traffic] Close Leave Home Jason Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_leave_home_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: leave_home_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_leave_home_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_leave_home_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: leave_home_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_leave_home_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_leave_home_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: traffic
          tag: leave_home_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_leave_home_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Traffic - Close Leave Home Sheri Notifications
#######################################################################################################################
  - id: traffic_close_leave_home_sheri_notifications
    alias: "[Traffic] Close Leave Home Sheri Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_leave_home_sheri
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: leave_home_sheri

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_leave_home_sheri

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_leave_home_sheri

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: leave_home_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_leave_home_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_leave_home_sheri

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_sphone
          category: traffic
          tag: leave_home_sheri
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_leave_home_sheri' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Traffic - Close Jason Work Commute Notifications
#######################################################################################################################
  - id: traffic_close_jason_work_commute_notifications
    alias: "[Traffic] Close Jason Work Commute Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_work_commute_jason
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: work_commute_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_work_commute_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_work_commute_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: work_commute_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_work_commute_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_work_commute_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: traffic
          tag: work_commute_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_work_commute_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Traffic - Close Sheri Work Commute Notifications
#######################################################################################################################
  - id: traffic_close_work_commute_sheri_notifications
    alias: "[Traffic] Close Sheri Work Commute Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_work_commute_sheri
        to:
          - idle
          - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: work_commute_sheri

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_work_commute_sheri

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_work_commute_sheri

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: work_commute_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_work_commute_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_work_commute_sheri

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_sphone
          category: traffic
          tag: work_commute_sheri
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_work_commute_sheri' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Traffic - Close Jason Home Commute Notifications
#######################################################################################################################
  - id: traffic_close_home_commute_jason_notifications
    alias: "[Traffic] Close Jason Home Commute Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_home_commute_jason
        to:
         - idle
         - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: home_commute_jason

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_home_commute_jason

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_home_commute_jason

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: home_commute_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_home_commute_jason

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_home_commute_jason

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_jphone
          category: traffic
          tag: home_commute_jason
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_home_commute_jason' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

#######################################################################################################################
## Traffic - Close Sheri Home Commute Notifications
#######################################################################################################################
  - id: traffic_close_home_commute_sheri_notifications
    alias: "[Traffic] Close Sheri Home Commute Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: alert.traffic_home_commute_sheri
        to:
         - idle
         - 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: home_commute_sheri

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_home_commute_sheri

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: pause_home_commute_sheri

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: home_commute_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_home_commute_sheri

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: pause_home_commute_sheri

    action:
      - service: script.close_notifications
        data:
          target: mobile_app_sphone
          category: traffic
          tag: home_commute_sheri
          pause: "{% if trigger.event is defined %}{{ trigger.event.data['action'] == 'pause_home_commute_sheri' }}{% endif %}"

      - delay:
          seconds: 180 # prevent recursive triggers

