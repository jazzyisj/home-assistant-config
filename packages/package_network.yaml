homeassistant:
  customize:
    alert.pi_hole_disconnected:
      friendly_name: Pi-Hole
      icon: mdi:pi-hole
      category: system
    binary_sensor.wan_connected:
      device_class: connectivity
      icon: mdi:wan
    sensor.myip:
      friendly_name: WAN IPV4
      icon: mdi:wan
    sensor.pi_hole_status:
      icon: mdi:pi-hole

shell_command:
  pi_hole_enable: !secret PIHOLE_ENABLE_CMD
  pi_hole_disable: !secret PIHOLE_DISABLE_CMD
  pi_hole_disable_time: !secret PIHOLE_DISABLE_TIME_CMD

input_number:
  pi_hole_disable_time:
    name: Pi-Hole Disable Time
    icon: mdi:timer-outline
    unit_of_measurement: min
    min: 0
    max: 3600
    step: 5
    mode: box

switch:
   - platform: template
     switches:
        pi_hole_enabled:
            friendly_name: "Pi-Hole Enabled"
            icon_template: >-
               {% if is_state('sensor.pi_hole_status', 'Enabled') %}
                  mdi:check-circle
               {% else %}
                  mdi:minus-circle
               {% endif %}
            value_template: "{{ is_state('sensor.pi_hole_status', 'Enabled') }}"
            turn_on:
                - service: shell_command.pi_hole_enable

                - service: input_number.set_value
                  target:
                      entity_id: input_number.pi_hole_disable_time
                  data:
                      value: 0

                - service: homeassistant.update_entity
                  target:
                      entity_id: sensor.pi_hole_status
            turn_off:
                - service_template: >-
                   {% if states('input_number.pi_hole_disable_time')|float > 0 %}
                       shell_command.pi_hole_disable_time
                   {% else %}
                       shell_command.pi_hole_disable
                   {% endif %}

                - service: input_number.set_value
                  target:
                      entity_id: input_number.pi_hole_disable_time
                  data:
                      value: 0

                - service: homeassistant.update_entity
                  target:
                      entity_id: sensor.pi_hole_status

binary_sensor:
  - platform: ping # https://www.home-assistant.io/components/binary_sensor.ping/
    name: WAN Connected
    host: 8.8.8.8
    count: 5
    scan_interval: 300

sensor:
  - platform: dnsip

  - platform: command_line
    name: Pi-Hole Status
    command: !secret PIHOLE_STATUS_CMD
    value_template: >-
      {% if is_state('binary_sensor.pihole_disconnected_alert','on') %} Disconnected
      {% elif value_json.status == 'enabled' %} Enabled
      {% elif value_json.status == 'disabled' %} Disabled
      {% else %} unknown
      {% endif %}

alert:
  pi_hole_disconnected:
    name: Pi-Hole Disconnected
    title: Pi-Hole Disconnected
    message: "Pi-Hole is disabled or disconnected."
    entity_id: binary_sensor.pihole_disconnected_alert
    state: 'on'
    repeat: 60
    notifiers: jason
    data:
      tag: pihole_disconnected
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      clickAction: /lovelace/system
      color: !secret WARNING_COLOR
      icon_url: !secret PROCESSOR_ICON
      image: !secret PROCESSOR_IMAGE
      actions:
        - action: URI
          title: PiHole Admin
          uri: http://http://pi.hole/admin/index.php
        - action: URI
          title: Entity Test
          entityId: sensor.pi_hole_ads_percentage_blocked_today
        - action: pause_pihole_disconnected
          title: Pause Alert
