#######################################################################################################################
## Spotify Package
#######################################################################################################################
spotify:
  client_id: !secret SPOTIFY_CLIENTID
  client_secret: !secret SPOTIFY_SECRET

spotcast:
  sp_dc: !secret HASSIO_SP_DC
  sp_key: !secret HASSIO_SP_KEY
  accounts:
    jason:
      sp_dc: !secret JAZZYISJ_SP_DC
      sp_key: !secret JAZZYISJ_SP_KEY
    sheri:
      sp_dc: !secret SHERI_SP_DC
      sp_key: !secret SHERI_SP_KEY

input_boolean:
  spotify_on:
    name: Spotify On
    icon: mdi:spotify

  spotify_random:
    name: Spotify Random
    icon: mdi:progress-question

  spotify_shuffle:
    name: Spotify Shuffle
    icon: mdi:shuffle-variant

  spotify_repeat:
    name: Spotify Repeat
    icon: mdi:progress-question

input_text:
  active_spotify_player:

input_select:
  spotify_media_player:
    name: Spotify Player
    icon: mdi:speaker-wireless
    options: !include /config/include/entities/media_player_names.yaml

  spotify_playlist:
    name: Spotify Playlist
    icon: mdi:speaker-wireless
    options: !include /config/include/entities/spotify_playlist_names.yaml

input_number:
  spotify_volume:
    name: Spotify Volume
    icon: mdi:volume-high
    unit_of_measurement: '%'
    min: 0
    max: 100
    step: 5

sensor:
#######################################################################################################################
## Spotcast Sensor
#######################################################################################################################
  - platform: spotcast

  - platform: template
    sensors:
#######################################################################################################################
## Spotify Media Player
#NOTE - this is only populated if Spotify is playing
#######################################################################################################################
      spotify_media_player:
        friendly_name: Spotify Media Player
        unique_id: spotify_media_player
        icon_template: mdi:spotify
        value_template: >
          {% if expand('group.google_speaker_groups')|selectattr('attributes.app_name','eq','Spotify')
              |map(attribute='entity_id')|list|count > 0 %}
             {{ expand('group.google_speaker_groups')|selectattr('attributes.app_name','eq','Spotify')
                |map(attribute='entity_id')|join(',') }}
          {% else %}
            {{ expand('group.media_players_single')|selectattr('attributes.app_name','eq','Spotify')
                |map(attribute='entity_id')|join(',') }}
          {% endif %}

#######################################################################################################################
## Spotcast Device
#NOTE - this is only populated if Spotify is playing
#######################################################################################################################
      spotify_spotcast_device:
        friendly_name: Spotcast Device
        unique_id: spotify_spotcast_device
        icon_template: mdi:spotify
        value_template: "{{ expand('group.media_players')|selectattr('entity_id','eq',states('sensor.spotify_media_player'))|map(attribute='name')|join(',') }}"

# entity_id: "{{ expand('group.media_players_single')|selectattr('attributes.app_name','eq','Spotify')|map(attribute='entity_id')|list }}

binary_sensor:
  - platform: template
    sensors:
#######################################################################################################################
## Spotify Connected
#######################################################################################################################
      spotify_connected:
        friendly_name: Spotify
        unique_id: spotify_connected
        icon_template: >
          {{ 'mdi:spotify' if not states('media_player.spotify_hassio')|lower in ['unknown','unavailable','none']
             else 'mdi:alert-circle' }}
        device_class: connectivity
        value_template: "{{ states('media_player.spotify_hassio')|lower not in ['unknown','unavailable','none'] }}"

      spotify_connected_alert:
        friendly_name: Spotify
        unique_id: spotify_connected_alert
        icon_template: mdi:spotify
        value_template: "{{ is_state('binary_sensor.spotify_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Spotify Active
#######################################################################################################################
      spotify_active:
        friendly_name: Spotify Active
        unique_id: spotify_active
        icon_template: mdi:spotify
        delay_off:
          seconds: 5 # avoid triggering UI state switching between songs
        value_template: "{{ states(states('sensor.spotify_media_player')) in ['playing','paused'] }}"
        availability_template: "{{ is_state('binary_sensor.spotify_connected','on') }}"


