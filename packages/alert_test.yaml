###############################################################################
## Package - Alert Test #TEST
###############################################################################
template:
  - binary_sensor:
      - name: "Alert Test"
        unique_id: alert_test
        state: "on"

  - binary_sensor:
      - name: "Smoke Detected"
        unique_id: smoke_detected
        icon: mdi:smoke-detector-variant-alert
        device_class: smoke
        state: >
          {% set entities = state_attr(this.entity_id,'entity_id')|select('has_value')|list %}
          {{ entities|count > 0 if entities != none else false }}
        attributes:
          entity_id: >
            {{ states.binary_sensor
                |selectattr('attributes.device_class','defined')
                |selectattr('attributes.device_class','eq','smoke')
                |selectattr('state','eq','on')
                |map(attribute='entity_id')|list }}

  - trigger:
      - platform: homeassistant
        event: start

      - platform: event
        event_type: event_template_reloaded

      - platform: state
        entity_id: binary_sensor.alert_test
        to: ~
    binary_sensor:
      - name: "Alert Test 2"
        unique_id: alert_test_2
        state: "{{ is_state('binary_sensor.alert_test','on') }}"

alert:
  alert_test:
    name: "Alert Test"
    entity_id: binary_sensor.alert_test_2
    state: "on"
    notifiers: log
    repeat: 99999
