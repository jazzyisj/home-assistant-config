###############################################################################
## Package - Company Scene
###############################################################################
input_boolean:
  company_scene:
    name: "Company Scene"
    icon: mdi:account-group

timer:
  company_scene:
    name: "Company Scene Timer"
    icon: mdi:progress-clock
    restore: true

input_number:
  company_scene_duration:
    name: "company Scene Duration"
    unit_of_measurement: min
    min: 30
    max: 480
    step: 10

  rgb_blue_company:
    name: "RGB Blue"
    min: 0
    max: 255
    step: 1

  rgb_green_company:
    name: "RGB Green"
    min: 0
    max: 255
    step: 1

  rgb_red_company:
    name: "RGB Red"
    min: 0
    max: 255
    step: 1

template:
  - sensor:
      - name: "RGB Company Scene"
        unique_id: rgb_company_scene
        icon: mdi:lightbulb
        state: >
          rgb({{ states('input_number.rgb_red_company')|int }},
          {{- states('input_number.rgb_green_company')|int }},
          {{- states('input_number.rgb_blue_company')|int }})
        attributes:
          rgb_color: >
            [{{ states('input_number.rgb_red_company')|int }},
              {{- states('input_number.rgb_green_company')|int }},
              {{- states('input_number.rgb_blue_company')|int }}]

automation:
  ###############################################################################
  ## Scene - Set Light Color Company
  ###############################################################################
  - id: scene_set_light_color_company
    alias: "[Scene] Set Light Color Company"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.rgb_company_scene

      - platform: state
        entity_id: input_boolean.company_scene
        to: "on"
        for: 5 # allow reset toggle, light scene on
    condition:
      - condition: state
        entity_id: input_boolean.company_scene
        state: "on"
    action:
      - condition: template
        value_template: "{{ states('sensor.rgb_company_scene') not in ['unknown','unavailable'] }}"

      - service: light.turn_on
        target:
          entity_id: light.dining_room_rgb_light
        data:
          rgb_color: "{{ state_attr('sensor.rgb_company_scene','rgb_color') }}"

  ###############################################################################
  ## Scene - Company Scene On
  ###############################################################################
  - id: scene_company_scene_on
    alias: "[Scene] Company Scene On"
    description: "Turn on company scene."
    trigger:
      - platform: state
        entity_id: input_boolean.company_scene
        to: "on"
    action:
      - if:
          - condition: state
            entity_id: input_select.occupancy_mode
            state:
              - Night
              - Away
              - Vacation
        then:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.company_scene

          - service: browser_mod.notification
            data:
              duration: 30000
              message: "company scene cannot be turned on in Night or Away mode."
        else:
          - variables:
              scene_modes: "{{ ['movie_scene','chill_scene'] }}"

          - repeat: # turn off other scenes
              count: "{{ scene_modes|count }}"
              sequence:
                - variables:
                    scene_mode: "{{ scene_modes[repeat.index-1] }}"

                - if: "{{ is_state('input_boolean.' ~ scene_mode,'on') }}"
                  then:
                    - service: input_boolean.turn_off
                      target:
                        entity_id: "input_boolean.{{ scene_mode }}"

          - service: script.turn_off
            target:
              entity_id:
                - script.waketime
                - script.morning_lights
                - script.bedtime

          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.bedtime_delayed

          - service: script.activate_light_scene
            data:
              scene: >
                {{ 'company_lights' if is_state('binary_sensor.nighttime_illuminance_lights','on')
                    else 'company_daytime_lights' }}

          - service: script.media_players_off

          - if:
              - condition: state
                entity_id: input_boolean.media_preset_enabled_company
                state: "on"
            then:
              - service: script.media_play
                data:
                  preset: company

          - service: switch.turn_on
            target:
              entity_id: switch.refrigerator_ice_plus

          - service: timer.start
            target:
              entity_id: timer.company_scene
            data:
              duration:
                minutes: "{{ states('input_number.company_scene_duration')|int(0) }}"

  ###############################################################################
  ## Scene - Company Scene Off
  ###############################################################################
  - id: scene_company_scene_off
    alias: "[Scene] Company Scene Off"
    description: "Turn off company scene."
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.company_scene
        to: "off"

      - platform: state
        entity_id: input_select.occupancy_mode
        to:
          - Night
          - Away
          - Vacation

      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.company_scene
    action:
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.company_scene

      - service: timer.cancel
        entity_id: timer.company_scene

      - condition: state
        entity_id: input_select.occupancy_mode
        state:
          - Home
          - Guest

      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.bedtime_delayed

      - service: script.media_players_off
        data:
          entity_id: > # turns of both reg and mass players
            {{ states.media_player
              |selectattr('name','eq',states('select.media_preset_speaker_company'))
              |map(attribute='entity_id')|list }}
