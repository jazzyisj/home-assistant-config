###############################################################################
## Package - Chill Scene
###############################################################################
input_boolean:
  chill_scene:
    name: "Chill Scene"
    icon: mdi:creation

timer:
  chill_scene:
    name: "Chill Scene Timer"
    icon: mdi:progress-clock
    restore: true

input_number:
  chill_scene_duration:
    name: "Chill Scene Duration"
    unit_of_measurement: min
    min: 30
    max: 480
    step: 10

  rgb_blue_chill:
    name: "RGB Blue"
    min: 0
    max: 255
    step: 1

  rgb_green_chill:
    name: "RGB Green"
    min: 0
    max: 255
    step: 1

  rgb_red_chill:
    name: "RGB Red"
    min: 0
    max: 255
    step: 1

template:
  - sensor:
      - name: "RGB Chill Scene"
        unique_id: rgb_chill_scene
        icon: mdi:lightbulb
        state: >
          rgb({{ states('input_number.rgb_red_chill')|int }},
          {{- states('input_number.rgb_green_chill')|int }},
          {{- states('input_number.rgb_blue_chill')|int }})
        attributes:
          rgb_color: >
            [{{ states('input_number.rgb_red_chill')|int }},
              {{- states('input_number.rgb_green_chill')|int }},
              {{- states('input_number.rgb_blue_chill')|int }}]

automation:
  ###############################################################################
  ## Scene - Chill Scene On
  ###############################################################################
  - id: scene_chill_scene_on
    alias: "[Scene] Chill Scene On"
    description: "Turn on chill scene."
    trigger:
      - platform: state
        entity_id: input_boolean.chill_scene
        to: "on"
    action:
      - service: script.scene_on
        data:
          scene: chill

  ###############################################################################
  ## Scene - Chill Scene Off
  ###############################################################################
  - id: scene_chill_scene_off
    alias: "[Scene] Chill Scene Off"
    description: "Turn off chill scene."
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.chill_scene
        to: "off"

      - platform: state
        entity_id: input_select.occupancy_mode
        to:
          - Night
          - Away
          - Vacation

      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.chill_scene
    action:
      - service: script.scene_off
        data:
          scene: chill

  ###############################################################################
  ## Scene - Set Light Color Chill
  ###############################################################################
  - id: scene_set_light_color_chill
    alias: "[Scene] Set Light Color Chill"
    mode: restart
    trigger:
      - platform: state
        entity_id: sensor.rgb_chill_scene
        not_to:
          - unknown
          - unavailable
    condition:
      - condition: state
        entity_id: input_boolean.chill_scene
        state: "on"
    action:
      - service: light.turn_on
        target:
          entity_id: light.dining_room_rgb_light
        data:
          rgb_color: "{{ state_attr('sensor.rgb_chill_scene','rgb_color') }}"
