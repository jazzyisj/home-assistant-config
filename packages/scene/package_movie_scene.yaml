###############################################################################
## Package - Movie Scene
###############################################################################
input_boolean:
  movie_scene:
    name: "Movie Scene"
    icon: mdi:movie-filter

timer:
  movie_scene:
    name: "Movie Scene Timer"
    icon: mdi:progress-clock
    restore: true

input_number:
  movie_scene_duration:
    name: "Movie Scene Duration"
    unit_of_measurement: min
    min: 30
    max: 480
    step: 10

automation:
  ###############################################################################
  ## Scene - Movie Scene On
  ###############################################################################
  - id: scene_movie_scene_on
    alias: "[Scene] Movie Scene On"
    description: "Turn on movie scene."
    trigger:
      - platform: state
        entity_id: input_boolean.movie_scene
        to: "on"
    action:
      - service: script.scene_on
        data:
          scene: movie

      - condition: state
        entity_id: input_boolean.movie_scene
        state: "on"

      - service: media_player.turn_on
        continue_on_error: true
        target:
          entity_id: media_player.living_room_tv

      - wait_template: "{{ 'Netflix' in state_attr('media_player.living_room_tv','source_list') }}"

      - if: "{{ states('media_player.living_room_tv') != 'off' }}"
        then:
          - service: media_player.select_source
            continue_on_error: true
            target:
              entity_id: media_player.living_room_tv
            data:
              source: Netflix

          - service: media_player.volume_set
            continue_on_error: true
            target:
              entity_id: media_player.living_room_tv
            data:
              volume_level: 0.25

          - service: media_player.volume_mute
            continue_on_error: true
            target:
              entity_id: media_player.living_room_tv
            data:
              is_volume_muted: false

      #IDEA - condition: template
      #   value_template: "{{ state_attr('media_player.mass_dining_room_hub','entity_picture') != none }}"

      # - service: color_extractor.turn_on
      #   target:
      #     entity_id: light.dining_room_rgb_light
      #   data:
      #     color_extract_url: "{{ state_attr('media_player.mass_dining_room_hub','entity_picture') }}"
      #     brightness_pct: 80
      #     transition: 5

  ###############################################################################
  ## Scene - Movie Scene Off
  ###############################################################################
  - id: scene_movie_scene_off
    alias: "[Scene] Movie Scene Off"
    description: "Turn off movie scene."
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.movie_scene
        to: "off"

      - platform: state
        entity_id: input_select.occupancy_mode
        to:
          - Night
          - Away
          - Vacation

      - platform: event
        event_type: timer.finished
        event_data:
          entity_id: timer.movie_scene
    action:
      - service: script.scene_off
        data:
          scene: movie

      - if: "{{ states('media_player.living_room_tv') != 'off' }}"
        then:
          - service: media_player.select_source
            target:
              entity_id: media_player.living_room_tv
            data:
              source: Live TV

          - service: media_player.turn_off
            target:
              entity_id: media_player.living_room_tv
