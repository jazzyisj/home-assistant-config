###############################################################################
## Package - Hass
###############################################################################
homeassistant:
  customize:
    alert.update_available:
      icon: mdi:cloud-upload
      category: hass
    alert.unavailable_sensor:
      icon: mdi:smoke-detector-variant
      category: hass
    alert.unknown_browser:
      icon: mdi:monitor-dashboard
      category: hass
    alert.integration_offline:
      icon: mdi:api-off
      category: hass
    alert.remote_ui:
      icon: mdi:remote-desktop
      category: hass
    alert.low_battery:
      icon: mdi:battery-alert
      category: hass

    sensor.browser_kiosk_internal:
      authorized: true
    sensor.browser_jlaptop_chrome_internal:
      authorized: true
    sensor.browser_jlaptop_chrome_direct:
      authorized: true
    sensor.browser_jlaptop_chrome_external:
      authorized: true
    sensor.browser_jlaptop_firefox_internal:
      authorized: true
    sensor.browser_jlaptop_edge_internal:
      authorized: true
    sensor.browser_jwork_chrome_direct:
      authorized: true
    sensor.browser_jphone_app_internal:
      authorized: true
    sensor.browser_jphone_app_external:
      authorized: true
    sensor.browser_jphone_kiosk:
      authorized: true
    sensor.browser_sphone_app_internal:
      authorized: true
    sensor.browser_sphone_app_external:
      authorized: true

    sensor.hassio_db:
      icon: mdi:database
    sensor.uptime:
      icon: mdi:clock-start
    sensor.home_assistant_alerts:
      icon: mdi:alert-rhombus

breaking_changes: # https://github.com/custom-components/breaking_changes
  name: 'Breaking Change Warnings'
  scan_interval: 3600

#DISABLED influxdb: # https://www.home-assistant.io/integrations/influxdb/
#   host: a0d7b954-influxdb
#   port: 8086
#   database: homeassistant
#   username: homeassistant
#   password: !secret JPASS
#   max_retries: 3
#   default_measurement: state

shell_command: # https://www.home-assistant.io/components/shell_command/
  tts_purge_all: 'sh shell/tts_purge_all.sh'
  tts_purge_old: 'sh shell/tts_purge_old.sh'
  alarm_snapshots_purge_all: 'sh shell/alarm_snapshots_purge_all.sh'
  alarm_snapshots_purge_old: 'sh shell/alarm_snapshots_purge_old.sh'
  git_update: 'sh shell/gitupdate.sh'

input_boolean:
  hass_alerts:
    name: 'Hass Alerts'
    icon: mdi:alert
  startup_pending:
    name: 'Startup Pending'
    icon: mdi:restart-alert
    initial: true

input_text:
  base_url:
    initial: !secret BASE_URL_CLOUD

input_select:
  log_level:
    name: 'Log Level'
    icon: mdi:format-indent-decrease
    options:
      - info
      - warn
      - error
      - critical
      - fatal
      - debug
      - notset

input_number:
  battery_alert_threshold:
    name: 'Battery Alert Threshold'
    icon: mdi:battery-alert
    min: 0
    max: 100
    step: 1
    unit_of_measurement: '%'

group:
  ignored_unavailable_entities:
    entities: !include /config/include/ignored_entities.yaml

  dev_mode_disabled_automations:
    entities:
      - automation.light_dining_room_light_auto_on
      - automation.light_dining_room_potlights_auto_on
      - automation.light_hallway_potlights_auto_on
      - automation.light_living_room_fan_light_auto_on
      - automation.light_kitchen_potlights_auto_on

      - automation.light_dining_room_light_manual_control_on
      - automation.light_office_potlights_manual_control_on

      - automation.mobile_jason_phone_quiet_time
      # - automation.mobile_sheri_phone_quiet_time #TEMP
      - automation.mobile_jason_phone_night_mode
      # - automation.mobile_sheri_phone_night_mode #TEMP

      - automation.climate_set_thermostat
      - automation.schedule_morning_before_alarm

      - automation.hass_kiosk_restart
      - automation.hass_kiosk_screen_on

      - automation.media_player_turned_off
      - automation.media_player_volume_reset
      - automation.tts_manual_media_player_selection_reset

      - automation.notify_alarm_clock_led_notification
      - automation.notify_alarm_led_notification
      - automation.notify_garage_led_notification
      - automation.notify_media_led_notification
      - automation.notify_presence_led_notification
      - automation.notify_reminder_led_notification
      - automation.notify_scene_led_notification
      - automation.notify_shower_led_notification
      - automation.notify_startup_led_notification
      - automation.notify_weather_led_notification

  alert_controls:
    all: true
    entities:
      - input_boolean.alarm_alerts
      - input_boolean.alarm_clock_alerts
      - input_boolean.climate_alerts
      - input_boolean.commute_alerts
      - input_boolean.garage_climate_alerts
      - input_boolean.garage_door_alerts
      - input_boolean.hass_alerts
      - input_boolean.light_alerts
      - input_boolean.media_alerts
      - input_boolean.mobile_alerts
      - input_boolean.network_alerts
      - input_boolean.presence_alerts
      - input_boolean.schedule_alerts
      - input_boolean.sensor_alerts
      - input_boolean.spa_alerts
      - input_boolean.sprinkler_alerts
      - input_boolean.system_alerts
      - input_boolean.tts_alerts
      - input_boolean.weather_alerts

  integration_connected_sensors:
    all: true
    entities:
      - binary_sensor.balboa_connected
      - binary_sensor.tomorrow_io_connected
      - binary_sensor.dark_sky_connected
      - binary_sensor.envcan_connected
      - binary_sensor.google_calendar_connected
      - binary_sensor.google_traffic_connected
      - binary_sensor.hydrawise_connected
      - binary_sensor.lg_thinq_connected
      - binary_sensor.myq_connected
      - binary_sensor.nest_connected
      - binary_sensor.nest_protect_connected
      - binary_sensor.noaa_connected
      - binary_sensor.openuv_connected
      - binary_sensor.iqvia_connected
      - binary_sensor.speedtest_connected
      - binary_sensor.spotify_connected
      - binary_sensor.uptime_robot_connected
      - binary_sensor.waqi_connected
      - binary_sensor.weatherflow_cloud_connected
      - binary_sensor.weatherflow_local_connected
      - binary_sensor.youtube_connected

  add_on_memory_sensors:
    entities:
      - sensor.check_home_assistant_configuration_memory_percent
      - sensor.chrony_memory_percent
      - sensor.file_editor_memory_percent
      - sensor.frigate_nvr_memory_percent
      - sensor.glances_memory_percent
      - sensor.grafana_memory_percent
      - sensor.home_assistant_google_drive_backup_memory_percent
      - sensor.influxdb_memory_percent
      - sensor.log_viewer_memory_percent
      - sensor.mariadb_memory_percent
      - sensor.mosquitto_broker_memory_percent
      - sensor.motioneye_memory_percent
      - sensor.phpmyadmin_memory_percent
      - sensor.rtsptoweb_webrtc_memory_percent
      - sensor.samba_share_memory_percent
      - sensor.ssh_web_terminal_memory_percent
      - sensor.unifi_controller_memory_percent
      - sensor.visual_studio_code_memory_percent
      - sensor.vlc_memory_percent
      - sensor.weatherflow_to_mqtt_memory_percent
      - sensor.z_wave_js_to_mqtt_memory_percent
      - sensor.z_wave_js_memory_percent
      - sensor.zerotier_one_memory_percent

  add_on_cpu_sensors:
    entities:
      - sensor.check_home_assistant_configuration_cpu_percent
      - sensor.chrony_cpu_percent
      - sensor.file_editor_cpu_percent
      - sensor.frigate_nvr_cpu_percent
      - sensor.glances_cpu_percent
      - sensor.grafana_cpu_percent
      - sensor.home_assistant_google_drive_backup_cpu_percent
      - sensor.influxdb_cpu_percent
      - sensor.log_viewer_cpu_percent
      - sensor.mariadb_cpu_percent
      - sensor.mosquitto_broker_cpu_percent
      - sensor.motioneye_cpu_percent
      - sensor.phpmyadmin_cpu_percent
      - sensor.rtsptoweb_webrtc_cpu_percent
      - sensor.samba_share_cpu_percent
      - sensor.ssh_web_terminal_cpu_percent
      - sensor.unifi_controller_cpu_percent
      - sensor.visual_studio_code_cpu_percent
      - sensor.vlc_cpu_percent
      - sensor.weatherflow_to_mqtt_cpu_percent
      - sensor.z_wave_js_cpu_percent
      - sensor.z_wave_js_to_mqtt_cpu_percent
      - sensor.zerotier_one_cpu_percent

  other_update_entities:
    entities:
      - binary_sensor.garage_furnace_firmware_update
      - binary_sensor.house_energy_monitor_firmware_update
      - binary_sensor.indoor_sump_firmware_update
      - binary_sensor.outdoor_sump_firmware_update
      - binary_sensor.sheri_phone_app_update_alert
      - binary_sensor.jason_phone_app_update_alert

binary_sensor:
  - platform: mqtt
    name: 'Kiosk Screen'
    state_topic: 'fully/event/+/6c1f5c36-170d28b1'
    value_template: '{{ value_json.event }}'
    payload_on: 'screenOn'
    payload_off: 'screenOff'

  - platform: mqtt
    name: 'Kiosk Motion'
    device_class: motion
    state_topic: 'fully/event/onMotion/6c1f5c36-170d28b1'
    value_template: '{{ value_json.type }}'
    payload_on: visual
    off_delay: 10

sensor:
  # https://www.home-assistant.io/integrations/websocket_api/#track-current-connections
  - platform: websocket_api # https://www.home-assistant.io/integrations/sensor.websocket_api/

  - platform: folder # https://www.home-assistant.io/integrations/folder/
    folder: /config/www/alarm_snapshots # path must be in allowlist_external_dirs
    filter: '*'

  - platform: folder
    folder: /config/tts # path must be in allowlist_external_dirs
    filter: '*'

  - platform: feedparser
    name: 'Home Assistant Alerts'
    feed_url: https://alerts.home-assistant.io/feed.xml
    date_format: '%Y-%m-%d'
    inclusions:
      - title
      - updated
      - content
      - link
    exclusions:
      - language

  - platform: authenticated # https://github.com/custom-components/authenticated
    enable_notification: true
    exclude:
      - 127.0.0.1
      - 170.17.0.2
      - 172.30.32.2
      - !secret HASS_IP
      - !secret JLAPTOP_IP
      - !secret JLAPTOP_WIFI_IP
      - !secret SHERI_TABLET_IP
      - !secret JPHONE_IP
      - !secret SPHONE_IP
      - !secret KIOSK_IP
    provider: ipapi # ipapi, extreme, ipvigilante
    log_location: /config/home-assistant.log

  # https://developers.home-assistant.io/docs/api/supervisor/endpoints
  - platform: command_line
    name: 'HASS Core Stats'
    command: 'curl http://supervisor/core/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS Supervisor Stats'
    command: 'curl http://supervisor/supervisor/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS Multicast Stats'
    command: 'curl http://supervisor/multicast/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS Audio Stats'
    command: 'curl http://supervisor/audio/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS Cli Stats'
    command: 'curl http://supervisor/cli/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS DNS Stats'
    command: 'curl http://supervisor/dns/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

  - platform: command_line
    name: 'HASS Observer Stats'
    command: 'curl http://supervisor/observer/stats -H "Authorization: Bearer $(printenv SUPERVISOR_TOKEN)" | jq ''{"cpu_percent":.data.cpu_percent,"memory_percent":.data.memory_percent,"memory_usage":.data.memory_usage}'''
    value_template: '{{ value_json.memory_percent }}'
    json_attributes:
      - cpu_percent
      - memory_percent
      - memory_usage
    scan_interval: 30
    command_timeout: 10

alert:
  integration_offline:
    name: 'Integration Offline'
    title: 'Integration Offline'
    message: >
      - {{ expand('group.integration_connected_sensors')
            |selectattr('state','eq','off')|map(attribute='name')|join('<br>- ') }}
    done_message: clear_notification
    entity_id: binary_sensor.integration_connected_alert
    state: 'on'
    repeat: 3600
    notifiers: jason
    data:
      tag: integration_offline
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:api-off
      icon_url: !secret HASSIO_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_integration_offline

  low_battery:
    name: 'Low Battery'
    title: 'Low Battery'
    message: |
      {%- set entities = expand(state_attr('binary_sensor.low_battery_alert','entity_id')) -%}
      {%- for item in entities -%}
      {{- item.name|lower|replace(': battery level','')|title }} - {{ item.state }}%
      {%- if not loop.last %}<br/>{% endif -%}
      {%- endfor -%}
    done_message: clear_notification
    entity_id: binary_sensor.low_battery_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: low_battery
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:battery-alert
      icon_url: !secret BATTERY_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_low_battery

  remote_ui:
    name: 'Remote UI'
    title: 'Remote UI Offline'
    message: 'Remote UI is disconnected.'
    done_message: clear_notification
    entity_id: binary_sensor.remote_ui_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: remote_ui
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:network-off-outline
      icon_url: !secret HASSIO_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_remote_ui

  unavailable_sensor:
    name: 'Unavailable Sensor'
    title: 'Unavailable Sensors'
    message: "- {{ expand(state_attr('sensor.unavailable_sensors','entity_id'))|map(attribute='name')|join('<br>- ') }}"
    done_message: clear_notification
    entity_id: binary_sensor.unavailable_sensor_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: unavailable_sensor
      subject: 'There are unavailable sensors.'
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:alert-circle
      icon_url: !secret HASSIO_ICON
      ledColor: !secret WARNING_COLOR
      color: !secret WARNING_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_unavailable_sensor

  unknown_browser:
    name: 'Unknown Browser'
    title: 'Unknown Browser'
    message: "- {{ expand(state_attr('sensor.unknown_browsers','entity_id'))|map(attribute='name')|join('<br>- ') }}"
    done_message: clear_notification
    entity_id: binary_sensor.unknown_browser_alert
    state: 'on'
    repeat: 1440
    notifiers: jason
    data:
      tag: unknown_browser
      subject: 'Unknown browser accesing Hassio.'
      group: System
      channel: Alert
      importance: max
      ttl: 0
      priority: high
      notification_url: mdi:monitor-cellphone
      icon_url: !secret HASSIO_ICON
      ledColor: !secret SEVERE_COLOR
      color: !secret SEVERE_COLOR
      vibrationPattern: !secret ALERT_VIBRATION
      clickAction: /lovelace-mobile/system
      actions:
        - title: 'Pause Alert'
          action: pause_unknown_browser

  update_available:
    name: 'Update Available'
    title: 'HASS Update'
    message: >
      {% set updates = state_attr('sensor.updates_available','entity_id') %}

      {% for item in updates %}
        <p><b>{{ state_attr(item,'title') }}</b>
        <br/>Installed: {{ state_attr(item,'installed_version') }}
        <br/>Available: {{ state_attr(item,'latest_version') }}</p>
      {% endfor %}
      {% set updates = expand('group.other_update_entities') %}
      {% for item in updates if item.state == 'on' %}
        <p><b>{{ state_attr(item.entity_id,'friendly_name') }}</b></p>
      {% endfor %}
    done_message: clear_notification
    entity_id: binary_sensor.update_available_alert
    state: 'on'
    repeat: 3600
    notifiers: jason
    data:
      subject: 'HASS updates are available.'
      tag: update_available
      group: System
      channel: General
      importance: max
      ttl: 0
      priority: high
      notification_icon: mdi:home-assistant
      icon_url: !secret HASSIO_ICON
      ledColor: !secret MINOR_COLOR
      color: !secret MINOR_COLOR
      vibrationPattern: !secret GENERAL_VIBRATION
      clickAction: /config/dashboard
      actions:
        - title: 'Pause Alert'
          action: pause_update_available
