#######################################################################################################################
## Buster Medication Package
#######################################################################################################################

input_boolean:
#######################################################################################################################
## Buster Medication Enabled
#######################################################################################################################
  buster_medication_enabled:
    name: "Buster Medication Enabled"
    icon: mdi:cat

  buster_medication_active:
#######################################################################################################################
## Buster Medication Enabled
#######################################################################################################################
    name: "Buster Medication Activate"
    icon: mdi:cat

input_datetime:
#######################################################################################################################
## Buster Medication Pill Times
#######################################################################################################################
  buster_medication_days_pill_1:
    name: "Days Buster Pill 1"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_days_pill_2:
    name: "Days Buster Pill 2"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_days_pill_3:
    name: "Days Buster Pill 3"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_afternoons_pill_1:
    name: "Afternoons Buster Pill 1"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_afternoons_pill_2:
    name: "Afternoons Buster Pill 2"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_afternoons_pill_3:
    name: "Afternoons Buster Pill 3"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_weekends_pill_1:
    name: "Weekends Buster Pill 1"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_weekends_pill_2:
    name: "Weekends Buster Pill 2"
    icon: mdi:clock
    has_date: false
    has_time: true

  buster_medication_weekends_pill_3:
    name: "Weekends Buster Pill 3"
    icon: mdi:clock
    has_date: false
    has_time: true

automation:
#######################################################################################################################
## Buster Medication - Turn Off
#######################################################################################################################
  - id: buster_medication_turn_off
    alias: "[Buster Medication] Turn Off"
    description: "Turn off active boolean."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.buster_medication_active
        to: 'on'

      - platform: state
        entity_id: input_boolean.buster_medication_enabled
        to: 'off'

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: buster_medication_done

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: buster_medication_done

    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.buster_medication_enabled
            state: 'off'

          - condition: state
            entity_id: input_select.occupancy_mode
            state: Vacation

          - condition: template
            value_template: >
              {% if trigger.event is defined %}{{ trigger.event.data['action'] == 'buster_medication_done' }}{% endif %}

    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.buster_medication_active

#######################################################################################################################
## Buster Medication - Activate Reminder
#######################################################################################################################
  - id: buster_medication_activate_reminder
    alias: "[Buster Medication] Activate Reminder"
    description: "Turn on buster medication active boolean with shift dependent time trigger."
    initial_state: true
    mode: single
    trigger:
      # shift dependant time trigger, defaults to weekend times
      - platform: template
        value_template: >
          {% set time = states('sensor.time') %}
          {% set days = is_state('sensor.current_shift','Days') and is_state('binary_sensor.work_today','on') %}
          {% set afts = is_state('sensor.current_shift','Afternoons') and is_state('binary_sensor.work_today','on') %}
          {% set wknd = is_state('binary_sensor.work_today','off') or states('sensor.current_shift') in ['Not Set','unknown','unavailable','none'] %}
          
          {{ (days and time == states('input_datetime.buster_medication_days_pill_1')[0:5])
            or (days and time == states('input_datetime.buster_medication_days_pill_2')[0:5])
            or (days and time == states('input_datetime.buster_medication_days_pill_3')[0:5])
            or (afts and time == states('input_datetime.buster_medication_afternoons_pill_1')[0:5])
            or (afts and time == states('input_datetime.buster_medication_afternoons_pill_2')[0:5])
            or (afts and time == states('input_datetime.buster_medication_afternoons_pill_3')[0:5])
            or (wknd and time == states('input_datetime.buster_medication_weekends_pill_1')[0:5])
            or (wknd and time == states('input_datetime.buster_medication_weekends_pill_2')[0:5])
            or (wknd and time == states('input_datetime.buster_medication_weekends_pill_3')[0:5]) }}

    condition:
      - condition: state
        entity_id: input_boolean.buster_medication_enabled
        state: 'on'

    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.buster_medication_active

#######################################################################################################################
## Buster Medication - Alert
#######################################################################################################################
  - id: buster_medication_alert
    alias: "[Buster Medication] Alert"
    description: "Sent alert every 15 minutes boolean is turned off."
    initial_state: true
    mode: single
    trigger:
      - platform: state
        entity_id: input_boolean.buster_medication_active
        to: 'on'
        for:
          seconds: 5  # allow boolean to turn back off if disabled

    condition:
      - condition: state
        entity_id: input_boolean.buster_medication_enabled
        state: 'on'

    action:
      - repeat:
          sequence:
            - service: script.tts_announcement
              data:
                play_message: "It's time for Buster's medication."
                quiet_play: true
                save_message: true

            - choose:
                - conditions:
                    - condition: state
                      entity_id: binary_sensor.alerts_enabled
                      state: 'on'

                  sequence:
                    - service: notify.jason
                      data:
                        title: "Buster's Medication"
                        message: "It's time for Buster's medication."
                        data:
                          actions:
                            - action: buster_medication_done
                              title: Medication Done
                              uri: /lovelace/schedule #app
                            - action: close_buster_medication
                              title: Close
                          tag: buster_medication
                          timestamp: "{{ as_timestamp(now()) }}" #push
                          priority: high
                          renotify: true #push
                          ttl: 3600
                          silent: false #push
                          requireInteraction: false #push
                          sticky: false #app
                          url: /lovelace/schedule #push
                          clickAction: /lovelace/schedule #app
                          color: !secret NOTIFY_COLOR #app
                          image: !secret BUSTER_IMAGE
                          icon: !secret BUSTER_ICON #push
                          badge: !secret BUSTER_BADGE #push

            # wait for alert to turned off/dismissed
            - wait_template: "{{ is_state('input_boolean.buster_medication_active','off') }}"
              timeout:
                minutes: 15

          until:
            - condition: state
              entity_id: input_boolean.buster_medication_active
              state: 'off'

#######################################################################################################################
## Buster Medication - Close Notifications
#######################################################################################################################
  - id: buster_medication_close_notifications
    alias: "[Buster Medication] Close Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    mode: single
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.buster_medication_active
        to: 'off'

      - platform: event
        event_type: html5_notification.closed
        event_data:
          tag: buster_medication

      #BUG html5 closed event doesn't work if notification is in tray
      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: close_buster_medication

      - platform: event
        event_type: html5_notification.clicked
        event_data:
          action: buster_medication_done

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: close_buster_medication

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: buster_medication_done

    action:
    - service: script.close_notifications
      data:
        target: mobile_app_jphone
        tag: buster_medication







