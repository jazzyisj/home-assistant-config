#######################################################################################################################
## Package - Maddie Mealtime Reminder
#######################################################################################################################
input_boolean:
  maddie_mealtime_enabled:
    icon: mdi:dog

  maddie_mealtime_active:
    icon: mdi:dog

input_datetime:
  maddie_mealtime_days_1:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_days_2:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_days_3:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_1:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_2:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_afternoons_3:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_1:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_2:
    icon: mdi:clock
    has_date: false
    has_time: true

  maddie_mealtime_weekends_3:
    icon: mdi:clock
    has_date: false
    has_time: true

automation:
#######################################################################################################################
## Reminders - Turn Off Maddie Mealtime
#######################################################################################################################
  - id: reminders_turn_off_maddie_mealtime
    alias: "[Reminders] Turn Off Maddie Mealtime"
    description: "Turn off reminder active boolean."
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_enabled
        to: 'off'

      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'on'

      - platform: event
        id: action
        event_type: mobile_app_notification_action
        event_data:
          action: maddie_mealtime_done
    condition:
      - condition: or
        conditions:
          - condition: state
            entity_id: input_boolean.maddie_mealtime_enabled
            state: 'off'

          - "{{ trigger.id == 'action' }}"
    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.maddie_mealtime_active

#######################################################################################################################
## Reminders - Activate Maddie Mealtime
#######################################################################################################################
  - id: reminders_activate_maddie_mealtime
    alias: "[Reminders] Activate Maddie Mealtime"
    description: "Turn on reminder active boolean."
    trigger:
      - platform: template
        value_template: >
          {% set time = states('sensor.time') %}
          {% set shift = states('sensor.time_trigger_shift') %}
          {{ (shift == 'days' and time == states('input_datetime.maddie_mealtime_days_1')[0:5])
            or (shift == 'days' and time == states('input_datetime.maddie_mealtime_days_2')[0:5])
            or (shift == 'days' and time == states('input_datetime.maddie_mealtime_days_3')[0:5])
            or (shift == 'afts' and time == states('input_datetime.maddie_mealtime_afternoons_1')[0:5])
            or (shift == 'afts' and time == states('input_datetime.maddie_mealtime_afternoons_2')[0:5])
            or (shift == 'afts' and time == states('input_datetime.maddie_mealtime_afternoons_3')[0:5])
            or (shift == 'wknd' and time == states('input_datetime.maddie_mealtime_weekends_1')[0:5])
            or (shift == 'wknd' and time == states('input_datetime.maddie_mealtime_weekends_2')[0:5])
            or (shift == 'wknd' and time == states('input_datetime.maddie_mealtime_weekends_3')[0:5]) }}
    condition:
      - condition: state
        entity_id: input_boolean.maddie_mealtime_enabled
        state: 'on'

      - condition: template
        alias: "Never ran or day interval reached"
        value_template: >
          {% set last_run = state_attr('automation.maddie_mealtime_activate_reminder','last_triggered') %}
          {{ last_run is none or (now().date() - last_run.date()).days >= states('input_number.maddie_mealtime_day_interval')|int }}

      #MIDNIGHT disabled mondays on afternoons when time < waketime and sunday workday is off to prevent afternoons workday night trigger
      - "{{ not (now().strftime('%w')|int == 1
              and states('sensor.time') < states('sensor.waketime_today')
              and is_state('sensor.current_shift','Afternoons')
              and is_state('input_boolean.sunday_workday','off')) }}"
    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.maddie_mealtime_active

#######################################################################################################################
## Reminders - Maddie Mealtime Alert
#######################################################################################################################
  - id: reminders_maddie_mealtime_alert
    alias: "[Reminders] Maddie Mealtime Alert"
    description: "Send notification until alert turns off."
    initial_state: true
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'on'
        for:
          seconds: 5 # allow boolean to turn back off without triggering if disabled
    condition:
      - condition: state
        entity_id: input_boolean.maddie_mealtime_enabled
        state: 'on'
    action:
      - repeat:
          sequence:
            - service: script.tts_play
              data:
                play_message: "Maddie!  Hey Maddie!  And Pooie Rooie too!  It's time to get some food!"
                quiet_play: true
                save_message: true

            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.schedule_alerts
                      state: "on"
                  sequence:
                    - service: notify.jason
                      data:
                        title: "Maddie Mealtime"
                        message: "It's time to feed the animals!"
                        data:
                          tag: maddie_mealtime
                          group: General
                          channel: General
                          importance: max
                          ttl: 0
                          priority: high
                          persistent: true
                          clickAction: /lovelace/schedule
                          color: !secret NOTIFY_COLOR
                          icon_url: !secret MADDIE_ICON
                          image: !secret MADDIE_IMAGE
                          actions:
                            - action: maddie_mealtime_done
                              title: "Mealtime Done"
                              uri: /lovelace/schedule

            - wait_template: "{{ is_state('input_boolean.maddie_mealtime_active','off') }}"
              timeout: # wait for alert to turned off/dismissed
                minutes: 15

          until:
            - condition: state
              entity_id: input_boolean.maddie_mealtime_active
              state: 'off'

#######################################################################################################################
## Reminders - Close Maddie Mealtime Notifications
#######################################################################################################################
  - id: reminders_close_maddie_mealtime_notifications
    alias: "[Reminders] Close Maddie Mealtime Notifications"
    description: "Dismiss notifications on all devices."
    initial_state: true
    max_exceeded: silent
    trigger:
      - platform: state
        entity_id: input_boolean.maddie_mealtime_active
        to: 'off'

      - platform: event
        event_type: mobile_app_notification_cleared
        event_data:
          tag: maddie_mealtime

      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: maddie_mealtime_done
    action:
      - service: notify.jason
        data:
          message: clear_notification
          data:
            tag: maddie_mealtime
