###############################################################################
## Work Schedule Settings
###############################################################################
type: entities
title: "Work Schedule Settings"
icon: mdi:factory
state_color: true
show_header_toggle: false
entities:
  - entity: input_boolean.work_schedule

  - type: custom:fold-entity-row
    head:
      entity: binary_sensor.work_vacation
    entities:
      - entity: calendar.work_vacation_jason

  - entity: binary_sensor.work_layoff

  - type: custom:fold-entity-row
    head:
      entity: binary_sensor.commute_active
      card_mod:
        style: |
          :host {
            --paper-item-icon-active-color:
              {% if is_state('alert.work_commute_jason','on') %} var(--entity-warning-color)
              {% elif is_state('binary_sensor.commute_active','on') %} var(--entity-minor-color)
              {% else %} var(--state-active-color)
              {% endif %}
              ;
          }
    entities:
      - entity: binary_sensor.google_traffic_connected
        card_mod:
          style: |
            :host {
              --paper-item-icon-color: var(--entity-critical-color)
            }

      - type: custom:fold-entity-row
        head:
          entity: input_boolean.commute_times_enabled
          card_mod:
            style: |
              :host {
                --paper-item-icon-color: var(--entity-warning-color);
              }
        entities:
          - type: custom:numberbox-card
            entity: input_number.commute_time

          - type: custom:numberbox-card
            entity: input_number.commute_predeparture
            name: "Predeparture Time"

          - type: custom:numberbox-card
            entity: input_number.commute_warning_threshold
            name: "Warning Threshold"

      - type: custom:fold-entity-row
        head:
          type: custom:template-entity-row
          name: "Days Commute Times"
          icon: mdi:clock
        entities:
          - type: custom:hui-element
            card_type: custom:time-picker-card
            entity: input_datetime.days_arrive_work_time
            name: "Arrive Work"
            hour_mode: 12
            link_values: true
            hour_step: 1
            minute_step: 1
            layout:
              name: inside
              align_controls: right
              hour_mode: single
              embedded: true
            hide:
              name: false
              seconds: true
            card_mod:
              class: sub_card

          - type: custom:hui-element
            card_type: custom:time-picker-card
            entity: input_datetime.days_leave_work_time
            name: "Leave Work"
            hour_mode: 12
            link_values: true
            hour_step: 1
            minute_step: 1
            layout:
              name: inside
              align_controls: right
              hour_mode: single
              embedded: true
            hide:
              name: false
              seconds: true
            card_mod:
              class: sub_card

      - type: custom:fold-entity-row
        head:
          type: custom:template-entity-row
          name: "Afternoons Commute Times"
          icon: mdi:clock
        entities:
          - type: custom:hui-element
            card_type: custom:time-picker-card
            entity: input_datetime.afternoons_arrive_work_time
            name: "Arrive Work"
            hour_mode: 12
            link_values: true
            hour_step: 1
            minute_step: 1
            layout:
              name: inside
              align_controls: right
              hour_mode: single
              embedded: true
            hide:
              name: false
              seconds: true
            card_mod:
              class: sub_card

          - type: custom:hui-element
            card_type: custom:time-picker-card
            entity: input_datetime.afternoons_leave_work_time
            name: "Leave Work"
            hour_mode: 12
            link_values: true
            hour_step: 1
            minute_step: 1
            layout:
              name: inside
              align_controls: right
              hour_mode: single
              embedded: true
            hide:
              name: false
              seconds: true
            card_mod:
              class: sub_card

      - entity: sensor.leave_home_time_jason
        name: "Leave Home: Jason"
        format: time

      - entity: sensor.leave_work_time
        name: "Leave Work Today"
        format: time

      - type: custom:auto-entities
        filter:
          template: "{{ states.alert|selectattr('attributes.category','eq','commute')|map(attribute='entity_id')|list }}"
        sort:
          method: name
          ignore_case: true
        card:
          type: custom:fold-entity-row
          padding: 5
          head:
            entity: input_boolean.commute_alerts
            card_mod:
              style: |
                :host {
                  --paper-item-icon-color: var(--entity-warning-color);
                  --paper-item-icon-active-color:
                    {% if states.alert|selectattr('attributes.category','eq','commute')
                        |selectattr('state','ne','idle')|list|count > 0 %} var(--entity-severe-color)
                    {% else %} var(--state-active-color)
                    {% endif %}
                  ;
                }

      - type: custom:auto-entities
        filter:
          include:
            - entity_id: "automation.commute_*"
        sort:
          method: name
          ignore_case: true
        card:
          type: custom:fold-entity-row
          padding: 5
          head:
            entity: sensor.dummy
            name: "Commute Automations"
            icon: mdi:sync-alert
            state: ""
            tap_action:
              action: none

      - type: call-service
        name: "Update Traffic Sensors"
        service: script.update_traffic_sensors
        action_name: "UPDATE"

  - type: custom:fold-entity-row
    head:
      entity: sensor.work_shift_today
      name: "Work Shift Selection"
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if is_state('input_boolean.work_shift_override','on') %} var(--entity-warning-color)
              {% elif is_state('sensor.work_shift_today','Days') %} var(--entity-dayshift-color)
              {% elif is_state('sensor.work_shift_today','Afternoons') %} var(--entity-afternoonshift-color)
              {% else %} var(--state-icon-color)
              {% endif %}
            ;
          }
    entities:
      - entity: input_boolean.work_shift_override
        tap_action:
          action: none
        card_mod:
          style: |
            :host {
              --paper-item-icon-color:
                {% if is_state('input_boolean.work_shift_override','on') %} var(--entity-warning-color)
                {% else %} var(--state-icon-color)
                {% endif %}
              ;
            }

      - entity: input_select.current_work_shift
        tap_action:
          action: none
        card_mod:
          style: |
            :host {
              --paper-item-icon-color:
                {% if is_state('input_select.current_work_shift','Days') %} var(--entity-dayshift-color)
                {% elif is_state('input_select.current_work_shift','Afternoons') %} var(--entity-afternoonshift-color)
                {% else %} var(--state-icon-color)
                {% endif %}
              ;
            }

  - type: custom:fold-entity-row
    head:
      type: custom:template-entity-row
      entity: binary_sensor.work_today
      state: "{{ states('binary_sensor.work_today')|title }}"
      state_color: true
      tap_action:
        action: none
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if is_state('binary_sensor.work_today','on') %}
                {% if is_state('input_boolean.work_shift_override','on')
                    or is_state('input_boolean.work_today_on','on') %} var(--entity-warning-color)
                {% elif is_state('sensor.work_shift_today','Days') %} var(--entity-dayshift-color)
                {% elif is_state('sensor.work_shift_today','Afternoons') %} var(--entity-afternoonshift-color)
                {% else %} var(--state-icon-color)
                {% endif %}
              {% else %} var(--state-icon-color)
              {% endif %}
            ;
          }
    entities:
      - entity: input_boolean.work_today_on
      - entity: input_boolean.work_today_off
      - entity: input_boolean.work_override_lock

  - type: custom:fold-entity-row
    head:
      type: custom:template-entity-row
      entity: binary_sensor.work_tomorrow
      tap_action:
        action: none
      state: "{{ states('binary_sensor.work_tomorrow')|title }}"
      card_mod:
        style: |
          :host {
            --paper-item-icon-color:
              {% if is_state('binary_sensor.work_tomorrow','on') %}
                {% if is_state('input_boolean.work_shift_override','on')
                    or is_state('input_boolean.work_tomorrow_on','on') %} var(--entity-warning-color)
                {% elif is_state('sensor.work_shift_tomorrow','Days') %} var(--entity-dayshift-color)
                {% elif is_state('sensor.work_shift_tomorrow','Afternoons') %} var(--entity-afternoonshift-color)
                {% else %} var(--state-icon-color)s
                {% endif %}
              {% else %} var(--state-icon-color)
              {% endif %}
            ;
          }
    entities:
      - entity: input_boolean.work_tomorrow_on
      - entity: input_boolean.work_tomorrow_off
      - entity: input_boolean.work_override_lock

  - type: attribute
    entity: sensor.next_work_holiday
    attribute: display

  - entity: input_boolean.saturday_workday
  - entity: input_boolean.sunday_workday
  - entity: input_boolean.holiday_workday
card_mod:
  class: popup
