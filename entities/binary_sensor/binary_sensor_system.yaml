#######################################################################################################################
## System Binary Sensors
#######################################################################################################################

#######################################################################################################################
## WAN Connected  https://www.home-assistant.io/components/binary_sensor.ping/
#######################################################################################################################
- platform: ping
  name: WAN Connected
  host: 8.8.8.8
  count: 2
  scan_interval: 300

#######################################################################################################################
## Uptime Robot  https://uptimerobot.com/
## binary_sensor.hassio
#######################################################################################################################
#DISABLED not connecting - platform: uptimerobot
#   api_key: !secret UPTIME_API

- platform: template
  sensors:
#######################################################################################################################
## WAN Connected Alert
#######################################################################################################################
    wan_connected_alert:
      friendly_name: Internet
      unique_id: wan_connected_alert
      icon_template: mdi:wan
      value_template: "{{ is_state('binary_sensor.wan_connected','off') }}"

#######################################################################################################################
## Hassio Connected - Uptimerobot
## - if uptime robot component not connected binary_sensor.hassio is not available to hassio
########################################################################################################################
    hassio_connected:
      friendly_name: Uptime Robot
      unique_id: hassio_connected
      icon_template: "{{ 'mdi:sort-clock-descending' if is_state('binary_sensor.hassio_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      value_template: true #DISABLED >
        # {{ is_state('binary_sensor.hassio','on') if is_state('binary_sensor.alerts_enabled','on') else true }}

    hassio_connected_alert:
      friendly_name: Uptime Robot
      unique_id: hassio_connected_alert
      icon_template: mdi:alert-circle
      value_template: "{{ is_state('binary_sensor.hassio_connected','off') }}"

#######################################################################################################################
## Integration Connected
#######################################################################################################################
    integration_connected:
      friendly_name: Integrations
      unique_id: integration_connected
      icon_template: "{{ 'mdi:api' if is_state('binary_sensor.integration_connected','on') else 'mdi:api-off' }}"
      device_class: connectivity
      value_template: "{{ is_state('group.integration_connected_sensors','on') }}"

    integration_connected_alert:
      unique_id: integration_connected_alert
      delay_on:
        minutes: 15 # delay before triggering alert
      value_template: "{{ is_state('binary_sensor.integration_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## ZWave Network
#######################################################################################################################
    zwave_network_alert:
      unique_id: zwave_network_alert
      delay_on:
        minutes: 5 # delay before triggering alert
      value_template: "{{ is_state('sensor.zwave_unavailable_devices',0) and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Remote UI
#######################################################################################################################
    remote_ui_alert:
      unique_id: remote_ui_alert
      delay_on:
        minutes: 5 # delay before triggering alert
      value_template: "{{ states('binary_sensor.remote_ui') in ['off','unavailable','unknown','none'] and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Unknown Browser #IDEA
#######################################################################################################################
    unknown_browser_alert: #TODO how do we get a list of entities matching sensor.browser_
      unique_id: unknown_browser_alert
      value_template: "{{ false }}"

#######################################################################################################################
## New Device Detected
#######################################################################################################################
    network_device:
      friendly_name: Network Devices
      unique_id: network_device
      icon_template: "{{ 'mdi:timeline-alert' if is_state('binary_sensor.network_device','on') else 'mdi:timeline-outline' }}"
      value_template: "{{ (states('sensor.total_network_devices')|int != states('variable.known_network_devices')|int) }}"

    network_device_alert:
      unique_id: network_device_alert
      value_template: "{{ is_state('binary_sensor.network_device','on') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Device Offline
#######################################################################################################################
    device_offline_alert:
      unique_id: device_offline_alert
      delay_on:
        minutes: 15 # delay before triggering alert
      value_template: "{{ states('sensor.offline_devices')|int > 0 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Unavailable Sensor
#######################################################################################################################
    unavailable_sensor_alert:
      unique_id: unavailable_sensor_alert
      delay_on:
        minutes: 15 # delay before triggering alert
      value_template: "{{ states('sensor.unavailable_sensors')|int > 0 and is_state('binary_sensor.alerts_enabled','on') }}"

######################################################################################################################
## RPI Power
######################################################################################################################
    rpi_power_alert:
      unique_id: rpi_power_alert
      value_template: "(( is_state('binary_sensor.rpi_power_status','on') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## CPU Temperature
#######################################################################################################################
    cpu_temperature_alert:
      unique_id: cpu_temperature_alert
      delay_on:
        minutes: 10
      value_template: "{{ states('sensor.cpu_temperature')|int > 65 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Processor Use
#######################################################################################################################
    processor_use_alert:
      unique_id: processor_use_alert
      delay_on:
        minutes: 10 # delay before triggering alert to reduce alerts from temporary spikes
      value_template: "{{ states('sensor.processor_use')|int > 60 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Memory Use
#######################################################################################################################
    memory_use_alert:
      unique_id: memory_use_alert
      delay_on:
        minutes: 10 # delay before triggering alert to reduce alerts from temporary spikes
      value_template: "{{ states('sensor.memory_use_percent')|int > 75 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Swap File Use
#######################################################################################################################
    swap_use_alert:
      unique_id: swap_use_alert
      delay_on:
        minutes: 10 # delay before triggering alert to reduce alerts from temporary spikes
      value_template: "{{ states('sensor.swap_use_percent')|int > 80 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Disk Use
#######################################################################################################################
    disk_use_alert:
      unique_id: disk_use_alert
      value_template: "{{ states('sensor.disk_use_percent_home')|int > 60 and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Bluetooth - test source_type for main bluetooth devices, if all null (None) bluetooth is disconnected
#ISSUE this doesn't really detect if bluetooth working
#TODO how do we get a list of entities matching device_tracker.*_bt
#######################################################################################################################
    bluetooth_alert:
      friendly_name: Bluetooth
      unique_id: bluetooth_alert
      icon_template: mdi:bluetooth-off
      value_template: >
        {{ state_attr('device_tracker.jlaptop_bt','source_type')|lower == 'none'
            and state_attr('device_tracker.jphone_bt','source_type')|lower == 'none'
            and state_attr('device_tracker.sphone_bt','source_type')|lower == 'none'
            and state_attr('device_tracker.stablet_bt','source_type')|lower == 'none' }}