#######################################################################################################################
## Vent Fan Binary Sensors
#######################################################################################################################

- platform: template
  sensors:
#######################################################################################################################
## Vent Fans On
## used for lovelace fold entity
#######################################################################################################################
    vent_fans_on:
      friendly_name: Vent Fan On
      unique_id: vent_fans_on
      icon_template: mdi:fan
      value_template: "{{ expand('group.vent_fans')|selectattr('state','eq','on')|list|count > 0 }}"

#######################################################################################################################
## Vent Fan In Use State
## used for lovelace fold entity
#######################################################################################################################
    vent_fan_in_use:
      friendly_name: Vent Fan In Use Timers
      unique_id: vent_fan_in_use
      icon_template: mdi:light-switch
      value_template: "{{ expand('group.vent_fan_in_use_timers')|selectattr('state','eq','active')|list|count > 0 }}"

#######################################################################################################################
## Upstairs Bathroom Humidity Fan
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
    upstairs_bathroom_humidity_fan:
      friendly_name: Upstairs Bath Humidity Fan
      unique_id: upstairs_bathroom_humidity_fan
      icon_template: mdi:water
      device_class: moisture
      delay_off:
        minutes: 5
      value_template: "{{ states('sensor.upstairs_bathroom_humidity')|int > states('input_number.bathroom_humidity_fan_threshold')|int }}"

#######################################################################################################################
## Upstairs Bathroom Fan
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
    upstairs_bathroom_mold_fan:
      friendly_name: Upstairs Bath Mold Fan
      unique_id: upstairs_bathroom_mold_fan
      icon_template: mdi:mushroom
      device_class: moisture
      delay_off:
        minutes: 5
      value_template: "{{ states('sensor.upstairs_bathroom_mold_indicator')|int > states('input_number.mold_risk_threshold')|int }}"

#######################################################################################################################
## Upstairs Bathroom Temperature Fan
## - uses absolute value so we can use temp above or below (negative value)
## - adjusts for seasons - doesn't run if outside is colder than inside, vice versa for warmer outside
## - bathroom colder than thermostat temp diff, colder outside than thermostat - on
## - bathroom warmer than thermostat temp diff, warmer outside than thermostat - on
## - delay off ensures fan will run for at least 5 minutes
#######################################################################################################################
    upstairs_bathroom_temperature_fan:
      friendly_name: Upstairs Bath Temp Fan
      unique_id: upstairs_bathroom_temperature_fan
      icon_template: mdi:thermometer-lines
      device_class: heat
      delay_off:
        minutes: 5
      value_template: >
        {% set tempdiff = (states('sensor.upstairs_bathroom_temperature')|int - states('sensor.upstairs_thermostat_temperature')|int|abs) %}
        {{ is_state('binary_sensor.alerts_enabled','on')
             and ((states('sensor.upstairs_bathroom_temperature')|int > states('input_number.high_temperature_threshold')|int)
               or (states('sensor.upstairs_bathroom_temperature')|int < states('input_number.low_temperature_threshold')|int)
               or (states('sensor.upstairs_bathroom_temperature')|int < states('sensor.upstairs_thermostat_temperature')|int
                    and states('sensor.dark_sky_temperature')|int < states('sensor.upstairs_thermostat_temperature')|int
                    and tempdiff >= states('input_number.bathroom_temperature_differential')|int)
               or (states('sensor.upstairs_bathroom_temperature')|int > states('sensor.upstairs_thermostat_temperature')|int
                    and states('sensor.dark_sky_temperature')|int > states('sensor.upstairs_thermostat_temperature')|int
                    and tempdiff >= states('input_number.bathroom_temperature_differential')|int)) }}