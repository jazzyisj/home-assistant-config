#######################################################################################################################
## Weather Binary Sensors
#######################################################################################################################

- platform: template
  sensors:
#######################################################################################################################
## IQVIA (Pollen) Sensor Connected
#######################################################################################################################
    pollen_connected:
      friendly_name: Pollen
      unique_id: pollen_connected
      icon_template: "{{ 'mdi:flower' if is_state('binary_sensor.pollen_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      value_template: >
        {{ not states('sensor.allergy_index_today') in ['unknown','unavailable','none']
             and not states('sensor.asthma_index_today') in ['unknown','unavailable','none'] }}

    pollen_connected_alert:
      friendly_name: Pollen
      unique_id: pollen_connected_alert
      icon_template: mdi:flower
      value_template: "{{ is_state('binary_sensor.pollen_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## OpenUV Connected
#######################################################################################################################
    openuv_connected:
      friendly_name: OpenUV
      unique_id: openuv_connected
      icon_template: "{{ 'mdi:weather-sunny-alert' if is_state('binary_sensor.openuv_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      value_template: "{{ not states('sensor.current_uv_index') in ['unknown','unavailable','none'] }}"

    openuv_connected_alert:
      friendly_name: OpenUV
      unique_id: openuv_connected_alert
      icon_template: mdi:weather-sunny-alert
      value_template: "{{ is_state('binary_sensor.openuv_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## WAQI Connected
#######################################################################################################################
    waqi_connected:
      friendly_name: WAQI
      unique_id: waqi_connected
      icon_template: "{{ 'mdi:smog' if is_state('binary_sensor.waqi_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      value_template: "{{ not states('sensor.waqi_windsor') in ['unknown','unavailable','none'] }}"

    waqi_connected_alert:
      friendly_name: WAQI
      unique_id: waqi_connected_alert
      icon_template: mdi:smog
      value_template: "{{ is_state('binary_sensor.waqi_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Flu Near You Connected
#######################################################################################################################
    flu_connected:
      friendly_name: Flu
      unique_id: flu_connected
      icon_template: "{{ 'mdi:biohazard' if is_state('binary_sensor.flu_connected','on') else 'mdi:alert-circle' }}"
      device_class: connectivity
      value_template: "{{ not states('sensor.cdc_level') in ['unknown','unavailable','none'] }}"

    flu_connected_alert:
      friendly_name: Flu
      unique_id: flu_connected_alert
      icon_template: mdi:biohazard
      value_template: "{{ is_state('binary_sensor.flu_connected','off') and is_state('binary_sensor.alerts_enabled','on') }}"

#######################################################################################################################
## Weather Alert Active LED - used to control weather led automation
#######################################################################################################################
    weather_alert_active_led:
      unique_id: weather_alert_active_led
      value_template: >
        {{ is_state('binary_sensor.noaa_alert_active','on')
            or is_state('binary_sensor.dark_sky_alert_active','on')
            or is_state('binary_sensor.outdoor_high_temperature_alert','on')
            or is_state('binary_sensor.outdoor_low_temperature_alert','on')
            or is_state('binary_sensor.storm_approaching_alert','on') }}

#######################################################################################################################
## Weather Alert Active
#######################################################################################################################
    weather_alert_active:
      unique_id: weather_alert_active
      value_template: "{{ is_state('binary_sensor.noaa_alert_active','on') or is_state('binary_sensor.dark_sky_alert_active','on') }}"

#######################################################################################################################
## Air Quality
#######################################################################################################################
    air_quality_alert:
      unique_id: air_quality_alert
      value_template: "{{ states('sensor.waqi_windsor')|int > 100  and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.waqi_connected','on') }}"

#######################################################################################################################
## UV Risk
#######################################################################################################################
    uv_risk_alert:
      unique_id: uv_risk_alert
      value_template: "{{ states('sensor.sensor.max_uv_index')|int > 6 and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.openuv_connected','on') }}"

#######################################################################################################################
## Outdoor High Temperature (Humidex) - uses apparent temperature
#######################################################################################################################
    outdoor_high_temperature_alert:
      unique_id: outdoor_high_temperature_alert
      value_template: >
        {{ states('sensor.dark_sky_apparent_temperature')|int > states('input_number.outdoor_high_temperature_threshold')|int
            and is_state('binary_sensor.alerts_enabled','on') }}
      availability_template: >
        {{ is_state('binary_sensor.dark_sky_connected','on')
            and not states('sensor.dark_sky_apparent_temperature') in ['unknown','unavailable','none'] }}

#######################################################################################################################
## Outdoor Low Temperature (Wind Chill) - uses apparent temperature
#######################################################################################################################
    outdoor_low_temperature_alert:
      unique_id: outdoor_low_temperature_alert
      value_template: >
        {{ states('sensor.dark_sky_apparent_temperature')|int < states('input_number.outdoor_low_temperature_threshold')|int
            and is_state('binary_sensor.alerts_enabled','on') }}
      availability_template: >
        {{ is_state('binary_sensor.dark_sky_connected','on')
            and not states('sensor.dark_sky_apparent_temperature') in ['unknown','unavailable','none'] }}

#######################################################################################################################
## Asthma Risk
#######################################################################################################################
    asthma_risk_alert:
      unique_id: asthma_risk_alert
      value_template: "{{ is_state('sensor.asthma_risk_today','High') and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.pollen_connected','on') }}"

#######################################################################################################################
## Allergy Risk
#######################################################################################################################
    allergy_risk_alert:
      unique_id: allergy_risk_alert
      value_template: "{{ is_state('sensor.allergy_risk_today','High') and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.pollen_connected','on') }}"

#######################################################################################################################
## Flu Risk
## states - No Data, Minimal, Low, Moderate, High, None
#######################################################################################################################
    flu_risk_alert:
      unique_id: flu_risk_alert
      value_template: "{{ states('sensor.cdc_level')|lower in ['moderate','high'] and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.flu_connected','on') }}"

# sensor.cold_flu_forecasted_average

#######################################################################################################################
## Storm Approaching
#######################################################################################################################
    storm_approaching_alert:
      unique_id: storm_approaching_alert
      value_template: "{{ states('sensor.dark_sky_nearest_storm_distance')|int < 3 and is_state('binary_sensor.alerts_enabled','on') }}"
      availability_template: "{{ is_state('binary_sensor.dark_sky_connected','on') }}"

#######################################################################################################################
## GDACS Alert
#######################################################################################################################
    gdacs_alert_active:
      friendly_name: GDACS Alert Active
      unique_id: gdacs_alert_active
      icon_template: mdi:pulse
      value_template: "{{ states('sensor.gdacs_42_304220273354154_82_92540550034799')|int > 0 }}"
