#######################################################################################################################
## Schedule Binary Sensors
#######################################################################################################################

#######################################################################################################################
## Workday (hidden)
## - python workday sensor
## - do not exclude holiday - work scheduled on some holidays, use google cal holidays instead
## https://www.home-assistant.io/integrations/workday/
#######################################################################################################################
- platform: workday
  name: Workday
  country: CA
  province: 'ON'
  workdays: [mon, tue, wed, thu, fri]
  excludes: [sat, sun]
  days_offset: 0

#######################################################################################################################
## Workday Tomorrow (hidden)
## - internal workday sensor w/offset (work tomorrow)
## - do not exlude holiday - work scheduled on some holidays, use google cal holidays instead
#######################################################################################################################
- platform: workday
  name: Workday Tomorrow
  country: CA
  province: 'ON'
  workdays: [mon, tue, wed, thu, fri]
  excludes: [sat, sun]
  days_offset: 1

#######################################################################################################################
## Utilities Workday
## - use offpeak billing on holidays and weekends
#######################################################################################################################
- platform: workday
  name: Utilities Workday
  country: CA
  province: 'ON'
  workdays: [mon, tue, wed, thu, fri]
  excludes: [sat, sun, holiday]
  days_offset: 0

- platform: template
  sensors:
#######################################################################################################################
## Shift Selection
## - delay on so user can select new shift before notification is sent
#######################################################################################################################
    shift_selection_alert:
      unique_id: shift_selection_alert
      delay_on:
        minutes: 5
      value_template: >
        {{ false if is_state('binary_sensor.alerts_enabled','off') or is_state('input_boolean.work_schedule','off')
            else is_state('input_boolean.shift_override','on') or (is_state('input_boolean.shift_override','off')
              and is_state('sensor.current_shift','Off')) }}

#######################################################################################################################
## Work Schedule Disabled
#######################################################################################################################
    work_schedule_disabled:
      friendly_name: Work Schedule Disabled
      unique_id: work_schedule_disabled
      icon_template: mdi:beach
      value_template: "{{ is_state('input_boolean.work_schedule','off') }}"

#######################################################################################################################
## Work Today - is today is a workday
## now().weekday() == 5is Saturday
#######################################################################################################################
    work_today:
      friendly_name: Work Today
      unique_id: work_today
      icon_template: >
        {% if is_state('input_boolean.work_schedule','off') %} mdi:beach
        {% elif is_state('sensor.current_shift','Days') %} mdi:alpha-d-circle
        {% elif is_state('sensor.current_shift','Afternoons') %} mdi:alpha-a-circle
        {% else %} mdi:calendar-alert
        {% endif %}
      value_template: >
        {% if is_state('calendar.work_holiday','on') %} false
        {% elif is_state('input_boolean.work_schedule','off') %} false
        {% elif is_state('input_boolean.saturday_workday','on') and now().weekday() == 5 %} true
        {% elif is_state('input_boolean.sunday_workday','on') and now().weekday() == 6 %} true
        {% elif is_state('binary_sensor.workday','on') %} true
        {% endif %}

#######################################################################################################################
## Work Tomorrow
## now().weekday() == 4 is Friday
#######################################################################################################################
    work_tomorrow:
      friendly_name: Work Tomorrow
      unique_id: work_tomorrow
      icon_template: >
        {% if is_state('input_boolean.work_schedule','off') %} mdi:beach
        {% elif is_state('sensor.tomorrow_shift','Days') %} mdi:alpha-d-circle
        {% elif is_state('sensor.tomorrow_shift','Afternoons') %} mdi:alpha-a-circle
        {% else %} mdi:calendar-alert
        {% endif %}
      value_template: >
        {% if is_state('input_boolean.work_schedule','off') %} false
        {% elif is_state('binary_sensor.holiday_tomorrow','on') %} false
        {% elif is_state('input_boolean.saturday_workday','on') and now().weekday() == 4 %} true
        {% elif is_state('input_boolean.sunday_workday','on') and now().weekday() == 5 %} true
        {% elif is_state('binary_sensor.workday_tomorrow','on') %} true
        {% endif %}

#######################################################################################################################
## Quiet Hours - limit media player volumes during set hours
## if QHS < QHE time does not span midnight
##  - time >= QHS and time <= QHE
## else if QHE < QHS quiet hours spans midnight
## - before midnight time >= QHS
## -  after midnight time <= QHE
#NOTE if waketime or bedtime state is Off default to set times
#######################################################################################################################
    quiet_hours:
      friendly_name: Quiet Hours
      unique_id: quiet_hours
      icon_template: mdi:volume-low
      value_template: >
        {% set time = states('sensor.time') %}
        {% if is_state('input_boolean.quiet_hours_bedtime_sync','on') and not (is_state('sensor.bedtime_today','Off') or is_state('sensor.waketime_today','Off'))%}
          {% set start = (as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.bedtime_today'))|int - states('input_number.quiet_hours_before_bedtime')|int * 60 )|timestamp_custom('%H:%M',true) %}
          {% set end = (as_timestamp(states('sensor.date') ~ ' ' ~ states('sensor.waketime_today'))|int + states('input_number.quiet_hours_after_waketime')|int * 60 )|timestamp_custom('%H:%M',true) %}
        {% else %}
          {% set start = states('input_datetime.quiet_hours_start')[0:5] %}
          {% set end = states('input_datetime.quiet_hours_end')[0:5] %}
        {% endif %}
        {% if is_state('input_boolean.quiet_hours_override','on') %} true
        {% elif is_state('input_boolean.quiet_hours','on') %}{{ start <= time < end if start < end else start <= time or time < end }}
        {% else %} false
        {% endif %}

#######################################################################################################################
## Bedtime Active - after bedtime, not in night mode, before 4am
#NOTE never active if waketime or bedtime state is Off
#######################################################################################################################
    bedtime_active:
      friendly_name: Bedtime Active
      unique_id: bedtime_active
      icon_template: mdi:bed-emmpty
      delay_on:
        seconds: 10  # allow automation.schedule_bedtime to detect bedtime trigger
      value_template: >
        {% set time = states('sensor.time') %}
        {% set wake = states('sensor.waketime_today') %}
        {% set bed = states('sensor.bedtime_today') %}
        {{ states('input_select.occupancy_mode') in ['Home','Guest']
            and (bed != 'Off' and wake != 'Off')
            and (bed < time or bed > time < wake if bed > wake else  bed < time < wake) }}

